(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2P = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2P=(()=>{var Up=Object.create;var zo=Object.defineProperty;var Kp=Object.getOwnPropertyDescriptor;var qp=Object.getOwnPropertyNames;var zp=Object.getPrototypeOf,Vp=Object.prototype.hasOwnProperty;var Dr=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),Ot=(r,t)=>{for(var e in t)zo(r,e,{get:t[e],enumerable:!0})},Nu=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of qp(t))!Vp.call(r,o)&&o!==e&&zo(r,o,{get:()=>t[o],enumerable:!(n=Kp(t,o))||n.enumerable});return r};var Vo=(r,t,e)=>(e=r!=null?Up(zp(r)):{},Nu(t||!r||!r.__esModule?zo(e,"default",{value:r,enumerable:!0}):e,r)),Hp=r=>Nu(zo({},"__esModule",{value:!0}),r);var Zd=Dr((z2,sl)=>{"use strict";var R0=Object.prototype.hasOwnProperty,Rt="~";function co(){}Object.create&&(co.prototype=Object.create(null),new co().__proto__||(Rt=!1));function O0(r,t,e){this.fn=r,this.context=t,this.once=e||!1}function jd(r,t,e,n,o){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new O0(e,n||r,o),i=Rt?Rt+t:t;return r._events[i]?r._events[i].fn?r._events[i]=[r._events[i],s]:r._events[i].push(s):(r._events[i]=s,r._eventsCount++),r}function Ts(r,t){--r._eventsCount===0?r._events=new co:delete r._events[t]}function vt(){this._events=new co,this._eventsCount=0}vt.prototype.eventNames=function(){var t=[],e,n;if(this._eventsCount===0)return t;for(n in e=this._events)R0.call(e,n)&&t.push(Rt?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};vt.prototype.listeners=function(t){var e=Rt?Rt+t:t,n=this._events[e];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,s=n.length,i=new Array(s);o<s;o++)i[o]=n[o].fn;return i};vt.prototype.listenerCount=function(t){var e=Rt?Rt+t:t,n=this._events[e];return n?n.fn?1:n.length:0};vt.prototype.emit=function(t,e,n,o,s,i){var a=Rt?Rt+t:t;if(!this._events[a])return!1;var c=this._events[a],u=arguments.length,l,f;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,o),!0;case 5:return c.fn.call(c.context,e,n,o,s),!0;case 6:return c.fn.call(c.context,e,n,o,s,i),!0}for(f=1,l=new Array(u-1);f<u;f++)l[f-1]=arguments[f];c.fn.apply(c.context,l)}else{var d=c.length,h;for(f=0;f<d;f++)switch(c[f].once&&this.removeListener(t,c[f].fn,void 0,!0),u){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,e);break;case 3:c[f].fn.call(c[f].context,e,n);break;case 4:c[f].fn.call(c[f].context,e,n,o);break;default:if(!l)for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];c[f].fn.apply(c[f].context,l)}}return!0};vt.prototype.on=function(t,e,n){return jd(this,t,e,n,!1)};vt.prototype.once=function(t,e,n){return jd(this,t,e,n,!0)};vt.prototype.removeListener=function(t,e,n,o){var s=Rt?Rt+t:t;if(!this._events[s])return this;if(!e)return Ts(this,s),this;var i=this._events[s];if(i.fn)i.fn===e&&(!o||i.once)&&(!n||i.context===n)&&Ts(this,s);else{for(var a=0,c=[],u=i.length;a<u;a++)(i[a].fn!==e||o&&!i[a].once||n&&i[a].context!==n)&&c.push(i[a]);c.length?this._events[s]=c.length===1?c[0]:c:Ts(this,s)}return this};vt.prototype.removeAllListeners=function(t){var e;return t?(e=Rt?Rt+t:t,this._events[e]&&Ts(this,e)):(this._events=new co,this._eventsCount=0),this};vt.prototype.off=vt.prototype.removeListener;vt.prototype.addListener=vt.prototype.on;vt.prefixed=Rt;vt.EventEmitter=vt;typeof sl<"u"&&(sl.exports=vt)});var th=Dr((f_,Jd)=>{Jd.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),n=Object.create(null);function o(s,i){e[s]=i,t++,t>=r&&(t=0,n=e,e=Object.create(null))}return{has:function(s){return e[s]!==void 0||n[s]!==void 0},remove:function(s){e[s]!==void 0&&(e[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var i=e[s];if(i!==void 0)return i;if((i=n[s])!==void 0)return o(s,i),i},set:function(s,i){e[s]!==void 0?e[s]=i:o(s,i)},clear:function(){e=Object.create(null),n=Object.create(null)}}}});var Qh=Dr(Io=>{(function(){var r,t,e,n,o,s,i,a;a=function(c){var u,l,f,d;return u=(c&255<<24)>>>24,l=(c&255<<16)>>>16,f=(c&65280)>>>8,d=c&255,[u,l,f,d].join(".")},i=function(c){var u,l,f,d,h,p;for(u=[],f=d=0;d<=3&&c.length!==0;f=++d){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=t(c),h=p[0],l=p[1],c=c.substring(l),u.push(h)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},e=function(c){return c.charCodeAt(0)},n=e("0"),s=e("a"),o=e("A"),t=function(c){var u,l,f,d,h;for(d=0,u=10,l="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,u=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,u=8,l="7")),h=f;f<c.length;){if("0"<=c[f]&&c[f]<=l)d=d*u+(e(c[f])-n)>>>0;else if(u===16)if("a"<=c[f]&&c[f]<="f")d=d*u+(10+e(c[f])-s)>>>0;else if("A"<=c[f]&&c[f]<="F")d=d*u+(10+e(c[f])-o)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");f++}if(f===h)throw new Error("empty octet");return[d,f]},r=function(){function c(u,l){var f,d,h,p;if(typeof u!="string")throw new Error("Missing `net' parameter");if(l||(p=u.split("/",2),u=p[0],l=p[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=i(l)}catch(g){throw f=g,new Error("Invalid mask: "+l)}for(d=h=32;h>=0;d=--h)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(i(u)&this.maskLong)>>>0}catch(g){throw f=g,new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(i(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var l,f,d;for(d=i(this.first),f=i(this.last),l=0;d<=f;)u(a(d),d,l),l++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),Io.ip2long=i,Io.long2ip=a,Io.Netmask=r}).call(Io)});var Sp=Dr((tP,_p)=>{function Wt(r,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}_p.exports=Wt;Wt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Wt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Wt.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var t=new Date().getTime();if(r&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var e=this._timeouts.shift();if(e===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),e=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},e),this._options.unref&&this._timer.unref(),!0};Wt.prototype.attempt=function(r,t){this._fn=r,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var e=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){e._operationTimeoutCb()},e._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Wt.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Wt.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Wt.prototype.start=Wt.prototype.try;Wt.prototype.errors=function(){return this._errors};Wt.prototype.attempts=function(){return this._attempts};Wt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},t=null,e=0,n=0;n<this._errors.length;n++){var o=this._errors[n],s=o.message,i=(r[s]||0)+1;r[s]=i,i>=e&&(t=o,e=i)}return t}});var Ap=Dr(Ar=>{var Wb=Sp();Ar.operation=function(r){var t=Ar.timeouts(r);return new Wb(t,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};Ar.timeouts=function(r){if(r instanceof Array)return[].concat(r);var t={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var e in r)t[e]=r[e];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],o=0;o<t.retries;o++)n.push(this.createTimeout(o,t));return r&&r.forever&&!n.length&&n.push(this.createTimeout(o,t)),n.sort(function(s,i){return s-i}),n};Ar.createTimeout=function(r,t){var e=t.randomize?Math.random()+1:1,n=Math.round(e*Math.max(t.minTimeout,1)*Math.pow(t.factor,r));return n=Math.min(n,t.maxTimeout),n};Ar.wrap=function(r,t,e){if(t instanceof Array&&(e=t,t=null),!e){e=[];for(var n in r)typeof r[n]=="function"&&e.push(n)}for(var o=0;o<e.length;o++){var s=e[o],i=r[s];r[s]=function(c){var u=Ar.operation(t),l=Array.prototype.slice.call(arguments,1),f=l.pop();l.push(function(d){u.retry(d)||(d&&(arguments[0]=u.mainError()),f.apply(this,arguments))}),u.attempt(function(){c.apply(r,l)})}.bind(r,i),r[s].options=t}}});var Ip=Dr((rP,Cp)=>{Cp.exports=Ap()});var Cw={};Ot(Cw,{createLibp2p:()=>_w,dnsaddrResolver:()=>Se,isLibp2p:()=>Aw});var Bu=Symbol.for("@libp2p/connection");var Pa=Symbol.for("@libp2p/content-routing");var Da=Symbol.for("@libp2p/peer-discovery");var Ho=Symbol.for("@libp2p/peer-id");function Te(r){return!!r?.[Ho]}var La=Symbol.for("@libp2p/peer-routing");var Ra="keep-alive";var kw=Symbol.for("@libp2p/transport");var He;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(He||(He={}));var Gt=class extends Error{static name="AbortError";constructor(t="The operation was aborted"){super(t),this.name="AbortError"}};var k=class extends Error{static name="InvalidParametersError";constructor(t="Invalid parameters"){super(t),this.name="InvalidParametersError"}},Lr=class extends Error{static name="InvalidPublicKeyError";constructor(t="Invalid public key"){super(t),this.name="InvalidPublicKeyError"}},An=class extends Error{static name="InvalidPrivateKeyError";constructor(t="Invalid private key"){super(t),this.name="InvalidPrivateKeyError"}};var $o=class extends Error{static name="ConnectionClosingError";constructor(t="The connection is closing"){super(t),this.name="ConnectionClosingError"}},Rr=class extends Error{static name="ConnectionClosedError";constructor(t="The connection is closed"){super(t),this.name="ConnectionClosedError"}};var $e=class extends Error{static name="NotFoundError";constructor(t="Not found"){super(t),this.name="NotFoundError"}},Or=class extends Error{static name="InvalidPeerIdError";constructor(t="Invalid PeerID"){super(t),this.name="InvalidPeerIdError"}},Pe=class extends Error{static name="InvalidMultiaddrError";constructor(t="Invalid multiaddr"){super(t),this.name="InvalidMultiaddrError"}},Wo=class extends Error{static name="InvalidCIDError";constructor(t="Invalid CID"){super(t),this.name="InvalidCIDError"}},Go=class extends Error{static name="InvalidMultihashError";constructor(t="Invalid Multihash"){super(t),this.name="InvalidMultihashError"}},Cn=class extends Error{static name="UnsupportedProtocolError";constructor(t="Unsupported protocol error"){super(t),this.name="UnsupportedProtocolError"}},jo=class extends Error{static name="InvalidMessageError";constructor(t="Invalid message"){super(t),this.name="InvalidMessageError"}};var Zo=class extends Error{static name="TimeoutError";constructor(t="Timed out"){super(t),this.name="TimeoutError"}},pe=class extends Error{static name="NotStartedError";constructor(t="Not started"){super(t),this.name="NotStartedError"}};var kr=class extends Error{static name="DialError";constructor(t="Dial error"){super(t),this.name="DialError"}};var Mr=class extends Error{static name="LimitedConnectionError";constructor(t="Limited connection"){super(t),this.name="LimitedConnectionError"}},Xo=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(t="Too many inbound protocol streams"){super(t),this.name="TooManyInboundProtocolStreamsError"}},Qo=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(t="Too many outbound protocol streams"){super(t),this.name="TooManyOutboundProtocolStreamsError"}},De=class extends Error{static name="UnsupportedKeyTypeError";constructor(t="Unsupported key type"){super(t),this.name="UnsupportedKeyTypeError"}};var Bt=class extends EventTarget{#t=new Map;constructor(){super()}listenerCount(t){let e=this.#t.get(t);return e==null?0:e.length}addEventListener(t,e,n){super.addEventListener(t,e,n);let o=this.#t.get(t);o==null&&(o=[],this.#t.set(t,o)),o.push({callback:e,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(t,e,n){super.removeEventListener(t.toString(),e??null,n);let o=this.#t.get(t);o!=null&&(o=o.filter(({callback:s})=>s!==e),this.#t.set(t,o))}dispatchEvent(t){let e=super.dispatchEvent(t),n=this.#t.get(t.type);return n==null||(n=n.filter(({once:o})=>!o),this.#t.set(t.type,n)),e}safeDispatchEvent(t,e={}){return this.dispatchEvent(new CustomEvent(t,e))}};function Yo(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Fu(...r){let t=[];for(let e of r)Yo(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function Uu(...r){let t=[];for(let e of r)Yo(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}var In=Symbol.for("@libp2p/service-capabilities"),Oa=Symbol.for("@libp2p/service-dependencies");var Fa={};Ot(Fa,{base58btc:()=>j,base58flickr:()=>Qp});var ix=new Uint8Array(0);function Ku(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}function me(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function qu(r){return new TextEncoder().encode(r)}function zu(r){return new TextDecoder().decode(r)}function $p(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),n=0;n<e.length;n++)e[n]=255;for(var o=0;o<r.length;o++){var s=r.charAt(o),i=s.charCodeAt(0);if(e[i]!==255)throw new TypeError(s+" is ambiguous");e[i]=o}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var g=0,m=0,w=0,E=p.length;w!==E&&p[w]===0;)w++,g++;for(var _=(E-w)*l+1>>>0,C=new Uint8Array(_);w!==E;){for(var b=p[w],L=0,R=_-1;(b!==0||L<m)&&R!==-1;R--,L++)b+=256*C[R]>>>0,C[R]=b%a>>>0,b=b/a>>>0;if(b!==0)throw new Error("Non-zero carry");m=L,w++}for(var I=_-m;I!==_&&C[I]===0;)I++;for(var y=c.repeat(g);I<_;++I)y+=r.charAt(C[I]);return y}function d(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var g=0;if(p[g]!==" "){for(var m=0,w=0;p[g]===c;)m++,g++;for(var E=(p.length-g)*u+1>>>0,_=new Uint8Array(E);p[g];){var C=e[p.charCodeAt(g)];if(C===255)return;for(var b=0,L=E-1;(C!==0||b<w)&&L!==-1;L--,b++)C+=a*_[L]>>>0,_[L]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");w=b,g++}if(p[g]!==" "){for(var R=E-w;R!==E&&_[R]===0;)R++;for(var I=new Uint8Array(m+(E-R)),y=m;R!==E;)I[y++]=_[R++];return I}}}function h(p){var g=d(p);if(g)return g;throw new Error(`Non-${t} character`)}return{encode:f,decodeUnsafe:d,decode:h}}var Wp=$p,Gp=Wp,Hu=Gp;var ka=class{name;prefix;baseEncode;constructor(t,e,n){this.name=t,this.prefix=e,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},Ma=class{name;prefix;baseDecode;prefixCodePoint;constructor(t,e,n){this.name=t,this.prefix=e;let o=e.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return $u(this,t)}},Na=class{decoders;constructor(t){this.decoders=t}or(t){return $u(this,t)}decode(t){let e=t[0],n=this.decoders[e];if(n!=null)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function $u(r,t){return new Na({...r.decoders??{[r.prefix]:r},...t.decoders??{[t.prefix]:t}})}var Ba=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(t,e,n,o){this.name=t,this.prefix=e,this.baseEncode=n,this.baseDecode=o,this.encoder=new ka(t,e,n),this.decoder=new Ma(t,e,o)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}};function Nr({name:r,prefix:t,encode:e,decode:n}){return new Ba(r,t,e,n)}function Le({name:r,prefix:t,alphabet:e}){let{encode:n,decode:o}=Hu(e,r);return Nr({prefix:t,name:r,encode:n,decode:s=>me(o(s))})}function jp(r,t,e,n){let o=r.length;for(;r[o-1]==="=";)--o;let s=new Uint8Array(o*e/8|0),i=0,a=0,c=0;for(let u=0;u<o;++u){let l=t[r[u]];if(l===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<e|l,i+=e,i>=8&&(i-=8,s[c++]=255&a>>i)}if(i>=e||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return s}function Zp(r,t,e){let n=t[t.length-1]==="=",o=(1<<e)-1,s="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>e;)i-=e,s+=t[o&a>>i];if(i!==0&&(s+=t[o&a<<e-i]),n)for(;(s.length*e&7)!==0;)s+="=";return s}function Xp(r){let t={};for(let e=0;e<r.length;++e)t[r[e]]=e;return t}function rt({name:r,prefix:t,bitsPerChar:e,alphabet:n}){let o=Xp(n);return Nr({prefix:t,name:r,encode(s){return Zp(s,n,e)},decode(s){return jp(s,o,e,r)}})}var j=Le({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Qp=Le({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ua={};Ot(Ua,{base32:()=>zt,base32hex:()=>em,base32hexpad:()=>nm,base32hexpadupper:()=>om,base32hexupper:()=>rm,base32pad:()=>Jp,base32padupper:()=>tm,base32upper:()=>Yp,base32z:()=>sm});var zt=rt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Yp=rt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Jp=rt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),tm=rt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),em=rt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),rm=rt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),nm=rt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),om=rt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),sm=rt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Ka={};Ot(Ka,{base36:()=>Tn,base36upper:()=>im});var Tn=Le({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),im=Le({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var am=ju,Wu=128,cm=127,lm=~cm,um=Math.pow(2,31);function ju(r,t,e){t=t||[],e=e||0;for(var n=e;r>=um;)t[e++]=r&255|Wu,r/=128;for(;r&lm;)t[e++]=r&255|Wu,r>>>=7;return t[e]=r|0,ju.bytes=e-n+1,t}var fm=qa,dm=128,Gu=127;function qa(r,n){var e=0,n=n||0,o=0,s=n,i,a=r.length;do{if(s>=a)throw qa.bytes=0,new RangeError("Could not decode varint");i=r[s++],e+=o<28?(i&Gu)<<o:(i&Gu)*Math.pow(2,o),o+=7}while(i>=dm);return qa.bytes=s-n,e}var hm=Math.pow(2,7),pm=Math.pow(2,14),mm=Math.pow(2,21),gm=Math.pow(2,28),ym=Math.pow(2,35),bm=Math.pow(2,42),wm=Math.pow(2,49),xm=Math.pow(2,56),Em=Math.pow(2,63),vm=function(r){return r<hm?1:r<pm?2:r<mm?3:r<gm?4:r<ym?5:r<bm?6:r<wm?7:r<xm?8:r<Em?9:10},_m={encode:am,decode:fm,encodingLength:vm},Sm=_m,Pn=Sm;function Dn(r,t=0){return[Pn.decode(r,t),Pn.decode.bytes]}function Br(r,t,e=0){return Pn.encode(r,t,e),t}function Fr(r){return Pn.encodingLength(r)}function jt(r,t){let e=t.byteLength,n=Fr(r),o=n+Fr(e),s=new Uint8Array(o+e);return Br(r,s,0),Br(e,s,n),s.set(t,o),new Ur(r,e,t,s)}function ge(r){let t=me(r),[e,n]=Dn(t),[o,s]=Dn(t.subarray(n)),i=t.subarray(n+s);if(i.byteLength!==o)throw new Error("Incorrect length");return new Ur(e,o,i,t)}function Zu(r,t){if(r===t)return!0;{let e=t;return r.code===e.code&&r.size===e.size&&e.bytes instanceof Uint8Array&&Ku(r.bytes,e.bytes)}}var Ur=class{code;size;digest;bytes;constructor(t,e,n,o){this.code=t,this.size=e,this.digest=n,this.bytes=o}};function Xu(r,t){let{bytes:e,version:n}=r;switch(n){case 0:return Cm(e,za(r),t??j.encoder);default:return Im(e,za(r),t??zt.encoder)}}var Qu=new WeakMap;function za(r){let t=Qu.get(r);if(t==null){let e=new Map;return Qu.set(r,e),e}return t}var tt=class r{code;version;multihash;bytes;"/";constructor(t,e,n,o){this.code=e,this.version=t,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:e}=this;if(t!==Ln)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==Tm)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:e}=this.multihash,n=jt(t,e);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return r.equals(this,t)}static equals(t,e){let n=e;return n!=null&&t.code===n.code&&t.version===n.version&&Zu(t.multihash,n.multihash)}toString(t){return Xu(this,t)}toJSON(){return{"/":Xu(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let e=t;if(e instanceof r)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){let{version:n,code:o,multihash:s,bytes:i}=e;return new r(n,o,s,i??Yu(n,o,s.bytes))}else if(e[Pm]===!0){let{version:n,multihash:o,code:s}=e,i=ge(o);return r.create(n,s,i)}else return null}static create(t,e,n){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==Ln)throw new Error(`Version 0 CID must use dag-pb (code: ${Ln}) block encoding`);return new r(t,e,n,n.bytes)}case 1:{let o=Yu(t,e,n.bytes);return new r(t,e,n,o)}default:throw new Error("Invalid version")}}static createV0(t){return r.create(0,Ln,t)}static createV1(t,e){return r.create(1,t,e)}static decode(t){let[e,n]=r.decodeFirst(t);if(n.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){let e=r.inspectBytes(t),n=e.size-e.multihashSize,o=me(t.subarray(n,n+e.multihashSize));if(o.byteLength!==e.multihashSize)throw new Error("Incorrect length");let s=o.subarray(e.multihashSize-e.digestSize),i=new Ur(e.multihashCode,e.digestSize,s,o);return[e.version===0?r.createV0(i):r.createV1(e.codec,i),t.subarray(e.size)]}static inspectBytes(t){let e=0,n=()=>{let[f,d]=Dn(t.subarray(e));return e+=d,f},o=n(),s=Ln;if(o===18?(o=0,e=0):s=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let i=e,a=n(),c=n(),u=e+c,l=u-i;return{version:o,codec:s,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(t,e){let[n,o]=Am(t,e),s=r.decode(o);if(s.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return za(s).set(n,t),s}};function Am(r,t){switch(r[0]){case"Q":{let e=t??j;return[j.prefix,e.decode(`${j.prefix}${r}`)]}case j.prefix:{let e=t??j;return[j.prefix,e.decode(r)]}case zt.prefix:{let e=t??zt;return[zt.prefix,e.decode(r)]}case Tn.prefix:{let e=t??Tn;return[Tn.prefix,e.decode(r)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],t.decode(r)]}}}function Cm(r,t,e){let{prefix:n}=e;if(n!==j.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);let o=t.get(n);if(o==null){let s=e.encode(r).slice(1);return t.set(n,s),s}else return o}function Im(r,t,e){let{prefix:n}=e,o=t.get(n);if(o==null){let s=e.encode(r);return t.set(n,s),s}else return o}var Ln=112,Tm=18;function Yu(r,t,e){let n=Fr(r),o=n+Fr(t),s=new Uint8Array(o+e.byteLength);return Br(r,s,0),Br(t,s,n),s.set(e,o),s}var Pm=Symbol.for("@ipld/js-cid/CID");var Va={};Ot(Va,{identity:()=>Zt});var Ju=0,Dm="identity",tf=me;function Lm(r){return jt(Ju,tf(r))}var Zt={code:Ju,name:Dm,encode:tf,digest:Lm};function G(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}function nt(r=0){return new Uint8Array(r)}function bt(r=0){return new Uint8Array(r)}function Xt(r,t){t==null&&(t=r.reduce((o,s)=>o+s.length,0));let e=bt(t),n=0;for(let o of r)e.set(o,n),n+=o.length;return e}var rf=Symbol.for("@achingbrain/uint8arraylist");function ef(r,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(let n of r){let o=e+n.byteLength;if(t<o)return{buf:n,index:t-e};e=o}throw new RangeError("index is out of bounds")}function ts(r){return!!r?.[rf]}var z=class r{bufs;length;[rf]=!0;constructor(...t){this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(let n of t)if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.push(n);else if(ts(n))e+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(let n of t.reverse())if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.unshift(n);else if(ts(n))e+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){let e=ef(this.bufs,t);return e.buf[e.index]}set(t,e){let n=ef(this.bufs,t);n.buf[n.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let n=0;n<t.length;n++)this.set(e+n,t[n]);else if(ts(t))for(let n=0;n<t.length;n++)this.set(e+n,t.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){let{bufs:n,length:o}=this._subList(t,e);return Xt(n,o)}subarray(t,e){let{bufs:n,length:o}=this._subList(t,e);return n.length===1?n[0]:Xt(n,o)}sublist(t,e){let{bufs:n,length:o}=this._subList(t,e),s=new r;return s.length=o,s.bufs=[...n],s}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let s=0;s<this.bufs.length;s++){let i=this.bufs[s],a=o,c=a+i.byteLength;if(o=c,t>=c)continue;let u=t>=a&&t<c,l=e>a&&e<=c;if(u&&l){if(t===a&&e===c){n.push(i);break}let f=t-a;n.push(i.subarray(f,f+(e-t)));break}if(u){if(t===0){n.push(i);continue}n.push(i.subarray(t-a));continue}if(l){if(e===c){n.push(i);break}n.push(i.subarray(0,e-a));break}n.push(i)}return{bufs:n,length:e-t}}indexOf(t,e=0){if(!ts(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let s=256,i=new Int32Array(s);for(let f=0;f<s;f++)i[f]=-1;for(let f=0;f<o;f++)i[n[f]]=f;let a=i,c=this.byteLength-n.byteLength,u=n.byteLength-1,l;for(let f=e;f<=c;f+=l){l=0;for(let d=u;d>=0;d--){let h=this.get(f+d);if(n[d]!==h){l=Math.max(1,d-a[h]);break}}if(l===0)return f}return-1}getInt8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){let n=bt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,e),this.write(n,t)}getInt16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,e)}setInt16(t,e,n){let o=nt(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,e,n),this.write(o,t)}getInt32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,e)}setInt32(t,e,n){let o=nt(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,e,n),this.write(o,t)}getBigInt64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,e)}setBigInt64(t,e,n){let o=nt(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,e,n),this.write(o,t)}getUint8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){let n=bt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,e),this.write(n,t)}getUint16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,e)}setUint16(t,e,n){let o=nt(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,e,n),this.write(o,t)}getUint32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,e)}setUint32(t,e,n){let o=nt(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,e,n),this.write(o,t)}getBigUint64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,e)}setBigUint64(t,e,n){let o=nt(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,e,n),this.write(o,t)}getFloat32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,e)}setFloat32(t,e,n){let o=nt(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,e,n),this.write(o,t)}getFloat64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,e)}setFloat64(t,e,n){let o=nt(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,e,n),this.write(o,t)}equals(t){if(t==null||!(t instanceof r)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!G(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){let n=new r;return n.bufs=t,e==null&&(e=t.reduce((o,s)=>o+s.byteLength,0)),n.length=e,n}};var Ha={};Ot(Ha,{base10:()=>Rm});var Rm=Le({prefix:"9",name:"base10",alphabet:"0123456789"});var $a={};Ot($a,{base16:()=>Om,base16upper:()=>km});var Om=rt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),km=rt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Wa={};Ot(Wa,{base2:()=>Mm});var Mm=rt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ga={};Ot(Ga,{base256emoji:()=>Km});var nf=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Nm=nf.reduce((r,t,e)=>(r[e]=t,r),[]),Bm=nf.reduce((r,t,e)=>{let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);return r[n]=e,r},[]);function Fm(r){return r.reduce((t,e)=>(t+=Nm[e],t),"")}function Um(r){let t=[];for(let e of r){let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);let o=Bm[n];if(o==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(o)}return new Uint8Array(t)}var Km=Nr({prefix:"\u{1F680}",name:"base256emoji",encode:Fm,decode:Um});var Xa={};Ot(Xa,{base64:()=>ja,base64pad:()=>qm,base64url:()=>Za,base64urlpad:()=>zm});var ja=rt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),qm=rt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Za=rt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),zm=rt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Qa={};Ot(Qa,{base8:()=>Vm});var Vm=rt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Ya={};Ot(Ya,{identity:()=>Hm});var Hm=Nr({prefix:"\0",name:"identity",encode:r=>zu(r),decode:r=>qu(r)});var Vx=new TextEncoder,Hx=new TextDecoder;var ec={};Ot(ec,{sha256:()=>Kr,sha512:()=>Gm});function tc({name:r,code:t,encode:e}){return new Ja(r,t,e)}var Ja=class{name;code;encode;constructor(t,e,n){this.name=t,this.code=e,this.encode=n}digest(t){if(t instanceof Uint8Array){let e=this.encode(t);return e instanceof Uint8Array?jt(this.code,e):e.then(n=>jt(this.code,n))}else throw Error("Unknown type, must be binary type")}};function sf(r){return async t=>new Uint8Array(await crypto.subtle.digest(r,t))}var Kr=tc({name:"sha2-256",code:18,encode:sf("SHA-256")}),Gm=tc({name:"sha2-512",code:19,encode:sf("SHA-512")});var Rn={...Ya,...Wa,...Qa,...Ha,...$a,...Ua,...Ka,...Fa,...Xa,...Ga},rE={...ec,...Va};function cf(r,t,e,n){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:n}}}var af=cf("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),rc=cf("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);let t=bt(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),jm={utf8:af,"utf-8":af,hex:Rn.base16,latin1:rc,ascii:rc,binary:rc,...Rn},es=jm;function D(r,t="utf8"){let e=es[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${r}`)}function N(r,t="utf8"){let e=es[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(r).substring(1)}var Zm=parseInt("11111",2),nc=parseInt("10000000",2),Xm=parseInt("01111111",2),lf={0:On,1:On,2:Qm,3:tg,4:eg,5:Jm,6:Ym,16:On,22:On,48:On};function ye(r,t={offset:0}){let e=r[t.offset]&Zm;if(t.offset++,lf[e]!=null)return lf[e](r,t);throw new Error("No decoder for tag "+e)}function kn(r,t){let e=0;if((r[t.offset]&nc)===nc){let n=r[t.offset]&Xm,o="0x";t.offset++;for(let s=0;s<n;s++,t.offset++)o+=r[t.offset].toString(16).padStart(2,"0");e=parseInt(o,16)}else e=r[t.offset],t.offset++;return e}function On(r,t){kn(r,t);let e=[];for(;!(t.offset>=r.byteLength);){let n=ye(r,t);if(n===null)break;e.push(n)}return e}function Qm(r,t){let e=kn(r,t),n=t.offset,o=t.offset+e,s=[];for(let i=n;i<o;i++)i===n&&r[i]===0||s.push(r[i]);return t.offset+=e,Uint8Array.from(s)}function Ym(r,t){let e=kn(r,t),n=t.offset+e,o=r[t.offset];t.offset++;let s=0,i=0;o<40?(s=0,i=o):o<80?(s=1,i=o-40):(s=2,i=o-80);let a=`${s}.${i}`,c=[];for(;t.offset<n;){let u=r[t.offset];if(t.offset++,c.push(u&127),u<128){c.reverse();let l=0;for(let f=0;f<c.length;f++)l+=c[f]<<f*7;a+=`.${l}`,c=[]}}return a}function Jm(r,t){return t.offset++,null}function tg(r,t){let e=kn(r,t),n=r[t.offset];t.offset++;let o=r.subarray(t.offset,t.offset+e-1);if(t.offset+=e,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function eg(r,t){let e=kn(r,t),n=r.subarray(t.offset,t.offset+e);return t.offset+=e,n}function rg(r){let t=r.toString(16);t.length%2===1&&(t="0"+t);let e=new z;for(let n=0;n<t.length;n+=2)e.append(Uint8Array.from([parseInt(`${t[n]}${t[n+1]}`,16)]));return e}function rs(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let t=rg(r.byteLength);return new z(Uint8Array.from([t.byteLength|nc]),t)}function Ct(r){let t=new z,e=128;return(r.subarray()[0]&e)===e&&t.append(Uint8Array.from([0])),t.append(r),new z(Uint8Array.from([2]),rs(t),t)}function Mn(r){let t=Uint8Array.from([0]),e=new z(t,r);return new z(Uint8Array.from([3]),rs(e),e)}function uf(r){return new z(Uint8Array.from([4]),rs(r),r)}function Qt(r,t=48){let e=new z;for(let n of r)e.append(n);return new z(Uint8Array.from([t]),rs(e),e)}async function ff(r="P-256"){let t=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",t.publicKey),privateKey:await crypto.subtle.exportKey("jwk",t.privateKey)}}async function df(r,t,e){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);e?.signal?.throwIfAborted();let o=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,t.subarray());return e?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function hf(r,t,e,n){let o=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let s=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,t,e.subarray());return n?.signal?.throwIfAborted(),s}var ng=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),og=Uint8Array.from([6,5,43,129,4,0,34]),sg=Uint8Array.from([6,5,43,129,4,0,35]),ig={ext:!0,kty:"EC",crv:"P-256"},ag={ext:!0,kty:"EC",crv:"P-384"},cg={ext:!0,kty:"EC",crv:"P-521"},oc=32,sc=48,ic=66;function ac(r){let t=ye(r);return pf(t)}function pf(r){let t=r[1][1][0],e=1,n,o;if(t.byteLength===oc*2+1)return n=N(t.subarray(e,e+oc),"base64url"),o=N(t.subarray(e+oc),"base64url"),new We({...ig,key_ops:["verify"],x:n,y:o});if(t.byteLength===sc*2+1)return n=N(t.subarray(e,e+sc),"base64url"),o=N(t.subarray(e+sc),"base64url"),new We({...ag,key_ops:["verify"],x:n,y:o});if(t.byteLength===ic*2+1)return n=N(t.subarray(e,e+ic),"base64url"),o=N(t.subarray(e+ic),"base64url"),new We({...cg,key_ops:["verify"],x:n,y:o});throw new k(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}function mf(r){return Qt([Ct(Uint8Array.from([1])),uf(D(r.d??"","base64url")),Qt([yf(r.crv)],160),Qt([Mn(new z(Uint8Array.from([4]),D(r.x??"","base64url"),D(r.y??"","base64url")))],161)]).subarray()}function gf(r){return Qt([Ct(Uint8Array.from([1])),Qt([yf(r.crv)],160),Qt([Mn(new z(Uint8Array.from([4]),D(r.x??"","base64url"),D(r.y??"","base64url")))],161)]).subarray()}function yf(r){if(r==="P-256")return ng;if(r==="P-384")return og;if(r==="P-521")return sg;throw new k(`Invalid curve ${r}`)}async function bf(r="P-256"){let t=await ff(r);return new ns(t.privateKey)}var We=class{type="ECDSA";jwk;_raw;constructor(t){this.jwk=t}get raw(){return this._raw==null&&(this._raw=gf(this.jwk)),this._raw}toMultihash(){return Zt.digest(Vt(this))}toCID(){return tt.createV1(114,this.toMultihash())}toString(){return j.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}async verify(t,e,n){return hf(this.jwk,e,t,n)}},ns=class{type="ECDSA";jwk;publicKey;_raw;constructor(t){this.jwk=t,this.publicKey=new We({crv:t.crv,ext:t.ext,key_ops:["verify"],kty:"EC",x:t.x,y:t.y})}get raw(){return this._raw==null&&(this._raw=mf(this.jwk)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}async sign(t,e){return df(this.jwk,t,e)}};var Ge=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function zr(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Nn(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function wt(r,...t){if(!zr(r))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(r.length))throw new Error("Uint8Array expected of length "+t+", got length="+r.length)}function xf(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Nn(r.outputLen),Nn(r.blockLen)}function Vr(r,t=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(t&&r.finished)throw new Error("Hash#digest() has already been called")}function Ef(r,t){wt(r);let e=t.outputLen;if(r.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}function we(...r){for(let t=0;t<r.length;t++)r[t].fill(0)}function os(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Yt(r,t){return r<<32-t|r>>>t}var vf=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",lg=Array.from({length:256},(r,t)=>t.toString(16).padStart(2,"0"));function ie(r){if(wt(r),vf)return r.toHex();let t="";for(let e=0;e<r.length;e++)t+=lg[r[e]];return t}var be={_0:48,_9:57,A:65,F:70,a:97,f:102};function wf(r){if(r>=be._0&&r<=be._9)return r-be._0;if(r>=be.A&&r<=be.F)return r-(be.A-10);if(r>=be.a&&r<=be.f)return r-(be.a-10)}function Hr(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(vf)return Uint8Array.fromHex(r);let t=r.length,e=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let n=new Uint8Array(e);for(let o=0,s=0;o<e;o++,s+=2){let i=wf(r.charCodeAt(s)),a=wf(r.charCodeAt(s+1));if(i===void 0||a===void 0){let c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[o]=i*16+a}return n}function _f(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Bn(r){return typeof r=="string"&&(r=_f(r)),wt(r),r}function Ft(...r){let t=0;for(let n=0;n<r.length;n++){let o=r[n];wt(o),t+=o.length}let e=new Uint8Array(t);for(let n=0,o=0;n<r.length;n++){let s=r[n];e.set(s,o),o+=s.length}return e}var qr=class{};function cc(r){let t=n=>r().update(Bn(n)).digest(),e=r();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>r(),t}function je(r=32){if(Ge&&typeof Ge.getRandomValues=="function")return Ge.getRandomValues(new Uint8Array(r));if(Ge&&typeof Ge.randomBytes=="function")return Uint8Array.from(Ge.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function ug(r,t,e,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(t,e,n);let o=BigInt(32),s=BigInt(4294967295),i=Number(e>>o&s),a=Number(e&s),c=n?4:0,u=n?0:4;r.setUint32(t+c,i,n),r.setUint32(t+u,a,n)}function Sf(r,t,e){return r&t^~r&e}function Af(r,t,e){return r&t^r&e^t&e}var Fn=class extends qr{constructor(t,e,n,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(t),this.view=os(this.buffer)}update(t){Vr(this),t=Bn(t),wt(t);let{view:e,buffer:n,blockLen:o}=this,s=t.length;for(let i=0;i<s;){let a=Math.min(o-this.pos,s-i);if(a===o){let c=os(t);for(;o<=s-i;i+=o)this.process(c,i);continue}n.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===o&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Vr(this),Ef(t,this),this.finished=!0;let{buffer:e,view:n,blockLen:o,isLE:s}=this,{pos:i}=this;e[i++]=128,we(this.buffer.subarray(i)),this.padOffset>o-i&&(this.process(n,0),i=0);for(let f=i;f<o;f++)e[f]=0;ug(n,o-8,BigInt(this.length*8),s),this.process(n,0);let a=os(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)a.setUint32(4*f,l[f],s)}digest(){let{buffer:t,outputLen:e}=this;this.digestInto(t);let n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());let{blockLen:e,buffer:n,length:o,finished:s,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=s,t.length=o,t.pos=a,o%e&&t.buffer.set(n),t}clone(){return this._cloneInto()}},xe=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var ht=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var ss=BigInt(4294967295),Cf=BigInt(32);function fg(r,t=!1){return t?{h:Number(r&ss),l:Number(r>>Cf&ss)}:{h:Number(r>>Cf&ss)|0,l:Number(r&ss)|0}}function If(r,t=!1){let e=r.length,n=new Uint32Array(e),o=new Uint32Array(e);for(let s=0;s<e;s++){let{h:i,l:a}=fg(r[s],t);[n[s],o[s]]=[i,a]}return[n,o]}var lc=(r,t,e)=>r>>>e,uc=(r,t,e)=>r<<32-e|t>>>e,Ze=(r,t,e)=>r>>>e|t<<32-e,Xe=(r,t,e)=>r<<32-e|t>>>e,Un=(r,t,e)=>r<<64-e|t>>>e-32,Kn=(r,t,e)=>r>>>e-32|t<<64-e;function ae(r,t,e,n){let o=(t>>>0)+(n>>>0);return{h:r+e+(o/2**32|0)|0,l:o|0}}var Tf=(r,t,e)=>(r>>>0)+(t>>>0)+(e>>>0),Pf=(r,t,e,n)=>t+e+n+(r/2**32|0)|0,Df=(r,t,e,n)=>(r>>>0)+(t>>>0)+(e>>>0)+(n>>>0),Lf=(r,t,e,n,o)=>t+e+n+o+(r/2**32|0)|0,Rf=(r,t,e,n,o)=>(r>>>0)+(t>>>0)+(e>>>0)+(n>>>0)+(o>>>0),Of=(r,t,e,n,o,s)=>t+e+n+o+s+(r/2**32|0)|0;var hg=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Oe=new Uint32Array(64),is=class extends Fn{constructor(t=32){super(64,t,8,!1),this.A=xe[0]|0,this.B=xe[1]|0,this.C=xe[2]|0,this.D=xe[3]|0,this.E=xe[4]|0,this.F=xe[5]|0,this.G=xe[6]|0,this.H=xe[7]|0}get(){let{A:t,B:e,C:n,D:o,E:s,F:i,G:a,H:c}=this;return[t,e,n,o,s,i,a,c]}set(t,e,n,o,s,i,a,c){this.A=t|0,this.B=e|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,e){for(let f=0;f<16;f++,e+=4)Oe[f]=t.getUint32(e,!1);for(let f=16;f<64;f++){let d=Oe[f-15],h=Oe[f-2],p=Yt(d,7)^Yt(d,18)^d>>>3,g=Yt(h,17)^Yt(h,19)^h>>>10;Oe[f]=g+Oe[f-7]+p+Oe[f-16]|0}let{A:n,B:o,C:s,D:i,E:a,F:c,G:u,H:l}=this;for(let f=0;f<64;f++){let d=Yt(a,6)^Yt(a,11)^Yt(a,25),h=l+d+Sf(a,c,u)+hg[f]+Oe[f]|0,g=(Yt(n,2)^Yt(n,13)^Yt(n,22))+Af(n,o,s)|0;l=u,u=c,c=a,a=i+h|0,i=s,s=o,o=n,n=h+g|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,s,i,a,c,u,l)}roundClean(){we(Oe)}destroy(){this.set(0,0,0,0,0,0,0,0),we(this.buffer)}};var kf=If(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),pg=kf[0],mg=kf[1],ke=new Uint32Array(80),Me=new Uint32Array(80),fc=class extends Fn{constructor(t=64){super(128,t,16,!1),this.Ah=ht[0]|0,this.Al=ht[1]|0,this.Bh=ht[2]|0,this.Bl=ht[3]|0,this.Ch=ht[4]|0,this.Cl=ht[5]|0,this.Dh=ht[6]|0,this.Dl=ht[7]|0,this.Eh=ht[8]|0,this.El=ht[9]|0,this.Fh=ht[10]|0,this.Fl=ht[11]|0,this.Gh=ht[12]|0,this.Gl=ht[13]|0,this.Hh=ht[14]|0,this.Hl=ht[15]|0}get(){let{Ah:t,Al:e,Bh:n,Bl:o,Ch:s,Cl:i,Dh:a,Dl:c,Eh:u,El:l,Fh:f,Fl:d,Gh:h,Gl:p,Hh:g,Hl:m}=this;return[t,e,n,o,s,i,a,c,u,l,f,d,h,p,g,m]}set(t,e,n,o,s,i,a,c,u,l,f,d,h,p,g,m){this.Ah=t|0,this.Al=e|0,this.Bh=n|0,this.Bl=o|0,this.Ch=s|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=l|0,this.Fh=f|0,this.Fl=d|0,this.Gh=h|0,this.Gl=p|0,this.Hh=g|0,this.Hl=m|0}process(t,e){for(let _=0;_<16;_++,e+=4)ke[_]=t.getUint32(e),Me[_]=t.getUint32(e+=4);for(let _=16;_<80;_++){let C=ke[_-15]|0,b=Me[_-15]|0,L=Ze(C,b,1)^Ze(C,b,8)^lc(C,b,7),R=Xe(C,b,1)^Xe(C,b,8)^uc(C,b,7),I=ke[_-2]|0,y=Me[_-2]|0,S=Ze(I,y,19)^Un(I,y,61)^lc(I,y,6),x=Xe(I,y,19)^Kn(I,y,61)^uc(I,y,6),v=Df(R,x,Me[_-7],Me[_-16]),A=Lf(v,L,S,ke[_-7],ke[_-16]);ke[_]=A|0,Me[_]=v|0}let{Ah:n,Al:o,Bh:s,Bl:i,Ch:a,Cl:c,Dh:u,Dl:l,Eh:f,El:d,Fh:h,Fl:p,Gh:g,Gl:m,Hh:w,Hl:E}=this;for(let _=0;_<80;_++){let C=Ze(f,d,14)^Ze(f,d,18)^Un(f,d,41),b=Xe(f,d,14)^Xe(f,d,18)^Kn(f,d,41),L=f&h^~f&g,R=d&p^~d&m,I=Rf(E,b,R,mg[_],Me[_]),y=Of(I,w,C,L,pg[_],ke[_]),S=I|0,x=Ze(n,o,28)^Un(n,o,34)^Un(n,o,39),v=Xe(n,o,28)^Kn(n,o,34)^Kn(n,o,39),A=n&s^n&a^s&a,P=o&i^o&c^i&c;w=g|0,E=m|0,g=h|0,m=p|0,h=f|0,p=d|0,{h:f,l:d}=ae(u|0,l|0,y|0,S|0),u=a|0,l=c|0,a=s|0,c=i|0,s=n|0,i=o|0;let T=Tf(S,v,P);n=Pf(T,y,x,A),o=T|0}({h:n,l:o}=ae(this.Ah|0,this.Al|0,n|0,o|0)),{h:s,l:i}=ae(this.Bh|0,this.Bl|0,s|0,i|0),{h:a,l:c}=ae(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l}=ae(this.Dh|0,this.Dl|0,u|0,l|0),{h:f,l:d}=ae(this.Eh|0,this.El|0,f|0,d|0),{h,l:p}=ae(this.Fh|0,this.Fl|0,h|0,p|0),{h:g,l:m}=ae(this.Gh|0,this.Gl|0,g|0,m|0),{h:w,l:E}=ae(this.Hh|0,this.Hl|0,w|0,E|0),this.set(n,o,s,i,a,c,u,l,f,d,h,p,g,m,w,E)}roundClean(){we(ke,Me)}destroy(){we(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var as=cc(()=>new is);var Mf=cc(()=>new fc);var pc=BigInt(0),hc=BigInt(1);function Ee(r,t){if(typeof t!="boolean")throw new Error(r+" boolean expected, got "+t)}function qn(r){let t=r.toString(16);return t.length&1?"0"+t:t}function Nf(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?pc:BigInt("0x"+r)}function $r(r){return Nf(ie(r))}function Qe(r){return wt(r),Nf(ie(Uint8Array.from(r).reverse()))}function cs(r,t){return Hr(r.toString(16).padStart(t*2,"0"))}function Wr(r,t){return cs(r,t).reverse()}function Q(r,t,e){let n;if(typeof t=="string")try{n=Hr(t)}catch(s){throw new Error(r+" must be hex string or Uint8Array, cause: "+s)}else if(zr(t))n=Uint8Array.from(t);else throw new Error(r+" must be hex string or Uint8Array");let o=n.length;if(typeof e=="number"&&o!==e)throw new Error(r+" of length "+e+" expected, got "+o);return n}var dc=r=>typeof r=="bigint"&&pc<=r;function Bf(r,t,e){return dc(r)&&dc(t)&&dc(e)&&t<=r&&r<e}function Ne(r,t,e,n){if(!Bf(t,e,n))throw new Error("expected valid "+r+": "+e+" <= n < "+n+", got "+t)}function Ff(r){let t;for(t=0;r>pc;r>>=hc,t+=1);return t}var Ye=r=>(hc<<BigInt(r))-hc;function Uf(r,t,e){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let n=h=>new Uint8Array(h),o=h=>Uint8Array.of(h),s=n(r),i=n(r),a=0,c=()=>{s.fill(1),i.fill(0),a=0},u=(...h)=>e(i,s,...h),l=(h=n(0))=>{i=u(o(0),h),s=u(),h.length!==0&&(i=u(o(1),h),s=u())},f=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let h=0,p=[];for(;h<t;){s=u();let g=s.slice();p.push(g),h+=s.length}return Ft(...p)};return(h,p)=>{c(),l(h);let g;for(;!(g=p(f()));)l();return c(),g}}function Be(r,t,e={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,s,i){let a=r[o];if(i&&a===void 0)return;let c=typeof a;if(c!==s||a===null)throw new Error(`param "${o}" is invalid: expected ${s}, got ${c}`)}Object.entries(t).forEach(([o,s])=>n(o,s,!1)),Object.entries(e).forEach(([o,s])=>n(o,s,!0))}function Gr(r){let t=new WeakMap;return(e,...n)=>{let o=t.get(e);if(o!==void 0)return o;let s=r(e,...n);return t.set(e,s),s}}var It=BigInt(0),ut=BigInt(1),Je=BigInt(2),gg=BigInt(3),zf=BigInt(4),Vf=BigInt(5),Hf=BigInt(8);function et(r,t){let e=r%t;return e>=It?e:t+e}function Y(r,t,e){let n=r;for(;t-- >It;)n*=n,n%=e;return n}function Kf(r,t){if(r===It)throw new Error("invert: expected non-zero number");if(t<=It)throw new Error("invert: expected positive modulus, got "+t);let e=et(r,t),n=t,o=It,s=ut,i=ut,a=It;for(;e!==It;){let u=n/e,l=n%e,f=o-i*u,d=s-a*u;n=e,e=l,o=i,s=a,i=f,a=d}if(n!==ut)throw new Error("invert: does not exist");return et(o,t)}function $f(r,t){let e=(r.ORDER+ut)/zf,n=r.pow(t,e);if(!r.eql(r.sqr(n),t))throw new Error("Cannot find square root");return n}function yg(r,t){let e=(r.ORDER-Vf)/Hf,n=r.mul(t,Je),o=r.pow(n,e),s=r.mul(t,o),i=r.mul(r.mul(s,Je),o),a=r.mul(s,r.sub(i,r.ONE));if(!r.eql(r.sqr(a),t))throw new Error("Cannot find square root");return a}function bg(r){if(r<BigInt(3))throw new Error("sqrt is not defined for small field");let t=r-ut,e=0;for(;t%Je===It;)t/=Je,e++;let n=Je,o=Jt(r);for(;qf(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(e===1)return $f;let s=o.pow(n,t),i=(t+ut)/Je;return function(c,u){if(c.is0(u))return u;if(qf(c,u)!==1)throw new Error("Cannot find square root");let l=e,f=c.mul(c.ONE,s),d=c.pow(u,t),h=c.pow(u,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let p=1,g=c.sqr(d);for(;!c.eql(g,c.ONE);)if(p++,g=c.sqr(g),p===l)throw new Error("Cannot find square root");let m=ut<<BigInt(l-p-1),w=c.pow(f,m);l=p,f=c.sqr(w),d=c.mul(d,f),h=c.mul(h,w)}return h}}function wg(r){return r%zf===gg?$f:r%Hf===Vf?yg:bg(r)}var Wf=(r,t)=>(et(r,t)&ut)===ut,xg=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function mc(r){let t={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},e=xg.reduce((n,o)=>(n[o]="function",n),t);return Be(r,e),r}function Eg(r,t,e){if(e<It)throw new Error("invalid exponent, negatives unsupported");if(e===It)return r.ONE;if(e===ut)return t;let n=r.ONE,o=t;for(;e>It;)e&ut&&(n=r.mul(n,o)),o=r.sqr(o),e>>=ut;return n}function zn(r,t,e=!1){let n=new Array(t.length).fill(e?r.ZERO:void 0),o=t.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),s=r.inv(o);return t.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),s),n}function qf(r,t){let e=(r.ORDER-ut)/Je,n=r.pow(t,e),o=r.eql(n,r.ONE),s=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!o&&!s&&!i)throw new Error("invalid Legendre symbol result");return o?1:s?0:-1}function Gf(r,t){t!==void 0&&Nn(t);let e=t!==void 0?t:r.toString(2).length,n=Math.ceil(e/8);return{nBitLength:e,nByteLength:n}}function Jt(r,t,e=!1,n={}){if(r<=It)throw new Error("invalid field: expected ORDER > 0, got "+r);let o,s;if(typeof t=="object"&&t!=null){if(n.sqrt||e)throw new Error("cannot specify opts in two arguments");let l=t;l.BITS&&(o=l.BITS),l.sqrt&&(s=l.sqrt),typeof l.isLE=="boolean"&&(e=l.isLE)}else typeof t=="number"&&(o=t),n.sqrt&&(s=n.sqrt);let{nBitLength:i,nByteLength:a}=Gf(r,o);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let c,u=Object.freeze({ORDER:r,isLE:e,BITS:i,BYTES:a,MASK:Ye(i),ZERO:It,ONE:ut,create:l=>et(l,r),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return It<=l&&l<r},is0:l=>l===It,isValidNot0:l=>!u.is0(l)&&u.isValid(l),isOdd:l=>(l&ut)===ut,neg:l=>et(-l,r),eql:(l,f)=>l===f,sqr:l=>et(l*l,r),add:(l,f)=>et(l+f,r),sub:(l,f)=>et(l-f,r),mul:(l,f)=>et(l*f,r),pow:(l,f)=>Eg(u,l,f),div:(l,f)=>et(l*Kf(f,r),r),sqrN:l=>l*l,addN:(l,f)=>l+f,subN:(l,f)=>l-f,mulN:(l,f)=>l*f,inv:l=>Kf(l,r),sqrt:s||(l=>(c||(c=wg(r)),c(u,l))),toBytes:l=>e?Wr(l,a):cs(l,a),fromBytes:l=>{if(l.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+l.length);return e?Qe(l):$r(l)},invertBatch:l=>zn(u,l),cmov:(l,f,d)=>d?f:l});return Object.freeze(u)}function jf(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let t=r.toString(2).length;return Math.ceil(t/8)}function gc(r){let t=jf(r);return t+Math.ceil(t/2)}function Zf(r,t,e=!1){let n=r.length,o=jf(t),s=gc(t);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);let i=e?Qe(r):$r(r),a=et(i,t-ut)+ut;return e?Wr(a,o):cs(a,o)}var Zr=BigInt(0),tr=BigInt(1);function jr(r,t){let e=t.negate();return r?e:t}function ls(r,t,e){let n=t==="pz"?i=>i.pz:i=>i.ez,o=zn(r.Fp,e.map(n));return e.map((i,a)=>i.toAffine(o[a])).map(r.fromAffine)}function Jf(r,t){if(!Number.isSafeInteger(r)||r<=0||r>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+r)}function yc(r,t){Jf(r,t);let e=Math.ceil(t/r)+1,n=2**(r-1),o=2**r,s=Ye(r),i=BigInt(r);return{windows:e,windowSize:n,mask:s,maxNumber:o,shiftBy:i}}function Xf(r,t,e){let{windowSize:n,mask:o,maxNumber:s,shiftBy:i}=e,a=Number(r&o),c=r>>i;a>n&&(a-=s,c+=tr);let u=t*n,l=u+Math.abs(a)-1,f=a===0,d=a<0,h=t%2!==0;return{nextN:c,offset:l,isZero:f,isNeg:d,isNegF:h,offsetF:u}}function vg(r,t){if(!Array.isArray(r))throw new Error("array expected");r.forEach((e,n)=>{if(!(e instanceof t))throw new Error("invalid point at index "+n)})}function _g(r,t){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((e,n)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+n)})}var bc=new WeakMap,td=new WeakMap;function wc(r){return td.get(r)||1}function Qf(r){if(r!==Zr)throw new Error("invalid wNAF")}function us(r,t){return{constTimeNegate:jr,hasPrecomputes(e){return wc(e)!==1},unsafeLadder(e,n,o=r.ZERO){let s=e;for(;n>Zr;)n&tr&&(o=o.add(s)),s=s.double(),n>>=tr;return o},precomputeWindow(e,n){let{windows:o,windowSize:s}=yc(n,t),i=[],a=e,c=a;for(let u=0;u<o;u++){c=a,i.push(c);for(let l=1;l<s;l++)c=c.add(a),i.push(c);a=c.double()}return i},wNAF(e,n,o){let s=r.ZERO,i=r.BASE,a=yc(e,t);for(let c=0;c<a.windows;c++){let{nextN:u,offset:l,isZero:f,isNeg:d,isNegF:h,offsetF:p}=Xf(o,c,a);o=u,f?i=i.add(jr(h,n[p])):s=s.add(jr(d,n[l]))}return Qf(o),{p:s,f:i}},wNAFUnsafe(e,n,o,s=r.ZERO){let i=yc(e,t);for(let a=0;a<i.windows&&o!==Zr;a++){let{nextN:c,offset:u,isZero:l,isNeg:f}=Xf(o,a,i);if(o=c,!l){let d=n[u];s=s.add(f?d.negate():d)}}return Qf(o),s},getPrecomputes(e,n,o){let s=bc.get(n);return s||(s=this.precomputeWindow(n,e),e!==1&&(typeof o=="function"&&(s=o(s)),bc.set(n,s))),s},wNAFCached(e,n,o){let s=wc(e);return this.wNAF(s,this.getPrecomputes(s,e,o),n)},wNAFCachedUnsafe(e,n,o,s){let i=wc(e);return i===1?this.unsafeLadder(e,n,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,o),n,s)},setWindowSize(e,n){Jf(n,t),td.set(e,n),bc.delete(e)}}}function ed(r,t,e,n){let o=t,s=r.ZERO,i=r.ZERO;for(;e>Zr||n>Zr;)e&tr&&(s=s.add(o)),n&tr&&(i=i.add(o)),o=o.double(),e>>=tr,n>>=tr;return{p1:s,p2:i}}function fs(r,t,e,n){vg(e,r),_g(n,t);let o=e.length,s=n.length;if(o!==s)throw new Error("arrays of points and scalars must have equal length");let i=r.ZERO,a=Ff(BigInt(o)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let u=Ye(c),l=new Array(Number(u)+1).fill(i),f=Math.floor((t.BITS-1)/c)*c,d=i;for(let h=f;h>=0;h-=c){l.fill(i);for(let g=0;g<s;g++){let m=n[g],w=Number(m>>BigInt(h)&u);l[w]=l[w].add(e[g])}let p=i;for(let g=l.length-1,m=i;g>0;g--)m=m.add(l[g]),p=p.add(m);if(d=d.add(p),h!==0)for(let g=0;g<c;g++)d=d.double()}return d}function Yf(r,t){if(t){if(t.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return mc(t),t}else return Jt(r)}function ds(r,t,e={}){if(!t||typeof t!="object")throw new Error(`expected valid ${r} CURVE object`);for(let a of["p","n","h"]){let c=t[a];if(!(typeof c=="bigint"&&c>Zr))throw new Error(`CURVE.${a} must be positive bigint`)}let n=Yf(t.p,e.Fp),o=Yf(t.n,e.Fn),i=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let a of i)if(!n.isValid(t[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:o}}var ce=BigInt(0),Tt=BigInt(1),xc=BigInt(2),Sg=BigInt(8),Ag={zip215:!0};function Cg(r,t,e,n){let o=r.sqr(e),s=r.sqr(n),i=r.add(r.mul(t.a,o),s),a=r.add(r.ONE,r.mul(t.d,r.mul(o,s)));return r.eql(i,a)}function Ig(r,t={}){let{Fp:e,Fn:n}=ds("edwards",r,t),{h:o,n:s}=r;Be(t,{},{uvRatio:"function"});let i=xc<<BigInt(n.BYTES*8)-Tt,a=g=>e.create(g),c=t.uvRatio||((g,m)=>{try{return{isValid:!0,value:e.sqrt(e.div(g,m))}}catch{return{isValid:!1,value:ce}}});if(!Cg(e,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function u(g,m,w=!1){let E=w?Tt:ce;return Ne("coordinate "+g,m,E,i),m}function l(g){if(!(g instanceof h))throw new Error("ExtendedPoint expected")}let f=Gr((g,m)=>{let{ex:w,ey:E,ez:_}=g,C=g.is0();m==null&&(m=C?Sg:e.inv(_));let b=a(w*m),L=a(E*m),R=a(_*m);if(C)return{x:ce,y:Tt};if(R!==Tt)throw new Error("invZ was invalid");return{x:b,y:L}}),d=Gr(g=>{let{a:m,d:w}=r;if(g.is0())throw new Error("bad point: ZERO");let{ex:E,ey:_,ez:C,et:b}=g,L=a(E*E),R=a(_*_),I=a(C*C),y=a(I*I),S=a(L*m),x=a(I*a(S+R)),v=a(y+a(w*a(L*R)));if(x!==v)throw new Error("bad point: equation left != right (1)");let A=a(E*_),P=a(C*b);if(A!==P)throw new Error("bad point: equation left != right (2)");return!0});class h{constructor(m,w,E,_){this.ex=u("x",m),this.ey=u("y",w),this.ez=u("z",E,!0),this.et=u("t",_),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(m){if(m instanceof h)throw new Error("extended point not allowed");let{x:w,y:E}=m||{};return u("x",w),u("y",E),new h(w,E,Tt,a(w*E))}static normalizeZ(m){return ls(h,"ez",m)}static msm(m,w){return fs(h,n,m,w)}_setWindowSize(m){this.precompute(m)}precompute(m=8,w=!0){return p.setWindowSize(this,m),w||this.multiply(xc),this}assertValidity(){d(this)}equals(m){l(m);let{ex:w,ey:E,ez:_}=this,{ex:C,ey:b,ez:L}=m,R=a(w*L),I=a(C*_),y=a(E*L),S=a(b*_);return R===I&&y===S}is0(){return this.equals(h.ZERO)}negate(){return new h(a(-this.ex),this.ey,this.ez,a(-this.et))}double(){let{a:m}=r,{ex:w,ey:E,ez:_}=this,C=a(w*w),b=a(E*E),L=a(xc*a(_*_)),R=a(m*C),I=w+E,y=a(a(I*I)-C-b),S=R+b,x=S-L,v=R-b,A=a(y*x),P=a(S*v),T=a(y*v),O=a(x*S);return new h(A,P,O,T)}add(m){l(m);let{a:w,d:E}=r,{ex:_,ey:C,ez:b,et:L}=this,{ex:R,ey:I,ez:y,et:S}=m,x=a(_*R),v=a(C*I),A=a(L*E*S),P=a(b*y),T=a((_+C)*(R+I)-x-v),O=P-A,F=P+A,B=a(v-w*x),st=a(T*O),W=a(F*B),U=a(T*B),ct=a(O*F);return new h(st,W,ct,U)}subtract(m){return this.add(m.negate())}multiply(m){let w=m;Ne("scalar",w,Tt,s);let{p:E,f:_}=p.wNAFCached(this,w,h.normalizeZ);return h.normalizeZ([E,_])[0]}multiplyUnsafe(m,w=h.ZERO){let E=m;return Ne("scalar",E,ce,s),E===ce?h.ZERO:this.is0()||E===Tt?this:p.wNAFCachedUnsafe(this,E,h.normalizeZ,w)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return p.wNAFCachedUnsafe(this,s).is0()}toAffine(m){return f(this,m)}clearCofactor(){return o===Tt?this:this.multiplyUnsafe(o)}static fromBytes(m,w=!1){return wt(m),this.fromHex(m,w)}static fromHex(m,w=!1){let{d:E,a:_}=r,C=e.BYTES;m=Q("pointHex",m,C),Ee("zip215",w);let b=m.slice(),L=m[C-1];b[C-1]=L&-129;let R=Qe(b),I=w?i:e.ORDER;Ne("pointHex.y",R,ce,I);let y=a(R*R),S=a(y-Tt),x=a(E*y-_),{isValid:v,value:A}=c(S,x);if(!v)throw new Error("Point.fromHex: invalid y coordinate");let P=(A&Tt)===Tt,T=(L&128)!==0;if(!w&&A===ce&&T)throw new Error("Point.fromHex: x=0 and x_0=1");return T!==P&&(A=a(-A)),h.fromAffine({x:A,y:R})}static fromPrivateScalar(m){return h.BASE.multiply(m)}toBytes(){let{x:m,y:w}=this.toAffine(),E=Wr(w,e.BYTES);return E[E.length-1]|=m&Tt?128:0,E}toRawBytes(){return this.toBytes()}toHex(){return ie(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}h.BASE=new h(r.Gx,r.Gy,Tt,a(r.Gx*r.Gy)),h.ZERO=new h(ce,Tt,Tt,ce),h.Fp=e,h.Fn=n;let p=us(h,n.BYTES*8);return h}function Tg(r,t){Be(t,{hash:"function"},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:e,hash:n}=t,{BASE:o,Fp:s,Fn:i}=r,a=i.ORDER,c=t.randomBytes||je,u=t.adjustScalarBytes||(b=>b),l=t.domain||((b,L,R)=>{if(Ee("phflag",R),L.length||R)throw new Error("Contexts/pre-hash are not supported");return b});function f(b){return i.create(b)}function d(b){return f(Qe(b))}function h(b){let L=s.BYTES;b=Q("private key",b,L);let R=Q("hashed private key",n(b),2*L),I=u(R.slice(0,L)),y=R.slice(L,2*L),S=d(I);return{head:I,prefix:y,scalar:S}}function p(b){let{head:L,prefix:R,scalar:I}=h(b),y=o.multiply(I),S=y.toBytes();return{head:L,prefix:R,scalar:I,point:y,pointBytes:S}}function g(b){return p(b).pointBytes}function m(b=Uint8Array.of(),...L){let R=Ft(...L);return d(n(l(R,Q("context",b),!!e)))}function w(b,L,R={}){b=Q("message",b),e&&(b=e(b));let{prefix:I,scalar:y,pointBytes:S}=p(L),x=m(R.context,I,b),v=o.multiply(x).toBytes(),A=m(R.context,v,S,b),P=f(x+A*y);Ne("signature.s",P,ce,a);let T=s.BYTES,O=Ft(v,Wr(P,T));return Q("result",O,T*2)}let E=Ag;function _(b,L,R,I=E){let{context:y,zip215:S}=I,x=s.BYTES;b=Q("signature",b,2*x),L=Q("message",L),R=Q("publicKey",R,x),S!==void 0&&Ee("zip215",S),e&&(L=e(L));let v=Qe(b.slice(x,2*x)),A,P,T;try{A=r.fromHex(R,S),P=r.fromHex(b.slice(0,x),S),T=o.multiplyUnsafe(v)}catch{return!1}if(!S&&A.isSmallOrder())return!1;let O=m(y,P.toBytes(),A.toBytes(),L);return P.add(A.multiplyUnsafe(O)).subtract(T).clearCofactor().is0()}return o.precompute(8),{getPublicKey:g,sign:w,verify:_,utils:{getExtendedPublicKey:p,randomPrivateKey:()=>c(s.BYTES),precompute(b=8,L=r.BASE){return L.precompute(b,!1)}},Point:r}}function Pg(r){let t={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},e=r.Fp,n=Jt(t.n,r.nBitLength,!0),o={Fp:e,Fn:n,uvRatio:r.uvRatio},s={hash:r.hash,randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:t,curveOpts:o,eddsaOpts:s}}function Dg(r,t){return Object.assign({},t,{ExtendedPoint:t.Point,CURVE:r})}function rd(r){let{CURVE:t,curveOpts:e,eddsaOpts:n}=Pg(r),o=Ig(t,e),s=Tg(o,n);return Dg(r,s)}var o1=BigInt(0),Lg=BigInt(1),nd=BigInt(2),s1=BigInt(3),Rg=BigInt(5),Og=BigInt(8),hs={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Og,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function kg(r){let t=BigInt(10),e=BigInt(20),n=BigInt(40),o=BigInt(80),s=hs.p,a=r*r%s*r%s,c=Y(a,nd,s)*a%s,u=Y(c,Lg,s)*r%s,l=Y(u,Rg,s)*u%s,f=Y(l,t,s)*l%s,d=Y(f,e,s)*f%s,h=Y(d,n,s)*d%s,p=Y(h,o,s)*h%s,g=Y(p,o,s)*h%s,m=Y(g,t,s)*l%s;return{pow_p_5_8:Y(m,nd,s)*r%s,b2:a}}function Mg(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var od=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Ng(r,t){let e=hs.p,n=et(t*t*t,e),o=et(n*n*t,e),s=kg(r*o).pow_p_5_8,i=et(r*n*s,e),a=et(t*i*i,e),c=i,u=et(i*od,e),l=a===r,f=a===et(-r,e),d=a===et(-r*od,e);return l&&(i=c),(f||d)&&(i=u),Wf(i,e)&&(i=et(-i,e)),{isValid:l||f,value:i}}var Bg=Jt(hs.p,void 0,!0),Fg={...hs,Fp:Bg,hash:Mf,adjustScalarBytes:Mg,uvRatio:Ng},Vn=rd(Fg);var Hn=class extends Error{constructor(t="An error occurred while signing a message"){super(t),this.name="SigningError"}},$n=class extends Error{constructor(t="An error occurred while verifying a message"){super(t),this.name="VerificationError"}},ps=class extends Error{constructor(t="Missing Web Crypto API"){super(t),this.name="WebCryptoMissingError"}};var sd={get(r=globalThis){let t=r.crypto;if(t?.subtle==null)throw new ps("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};var kt=sd;var ms=32,Wn=64,Ec=32;var Xr,id=(async()=>{try{return await kt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function ad(){let r=Vn.utils.randomPrivateKey(),t=Vn.getPublicKey(r);return{privateKey:Vg(r,t),publicKey:t}}async function Ug(r,t){let e;r.length===Wn?e=r.subarray(0,32):e=r;let n={crv:"Ed25519",kty:"OKP",x:N(r.subarray(32),"base64url"),d:N(e,"base64url"),ext:!0,key_ops:["sign"]},o=await kt.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),s=await kt.get().subtle.sign({name:"Ed25519"},o,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(s,0,s.byteLength)}function Kg(r,t){let e=r.subarray(0,Ec);return Vn.sign(t instanceof Uint8Array?t:t.subarray(),e)}async function cd(r,t){return Xr==null&&(Xr=await id),Xr?Ug(r,t):Kg(r,t)}async function qg(r,t,e){if(r.buffer instanceof ArrayBuffer){let n=await kt.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await kt.get().subtle.verify({name:"Ed25519"},n,t,e instanceof Uint8Array?e:e.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function zg(r,t,e){return Vn.verify(t,e instanceof Uint8Array?e:e.subarray(),r)}async function ld(r,t,e){return Xr==null&&(Xr=await id),Xr?qg(r,t,e):zg(r,t,e)}function Vg(r,t){let e=new Uint8Array(Wn);for(let n=0;n<Ec;n++)e[n]=r[n],e[Ec+n]=t[n];return e}function Qr(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Gn=class{type="Ed25519";raw;constructor(t){this.raw=ys(t,ms)}toMultihash(){return Zt.digest(Vt(this))}toCID(){return tt.createV1(114,this.toMultihash())}toString(){return j.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}verify(t,e,n){n?.signal?.throwIfAborted();let o=ld(this.raw,e,t);return Qr(o)?o.then(s=>(n?.signal?.throwIfAborted(),s)):o}},gs=class{type="Ed25519";raw;publicKey;constructor(t,e){this.raw=ys(t,Wn),this.publicKey=new Gn(e)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}sign(t,e){e?.signal?.throwIfAborted();let n=cd(this.raw,t);return Qr(n)?n.then(o=>(e?.signal?.throwIfAborted(),o)):(e?.signal?.throwIfAborted(),n)}};function vc(r){return r=ys(r,ms),new Gn(r)}async function fd(){let{privateKey:r,publicKey:t}=ad();return new gs(r,t)}function ys(r,t){if(r=Uint8Array.from(r??[]),r.length!==t)throw new k(`Key must be a Uint8Array of length ${t}, got ${r.length}`);return r}var Hg=Math.pow(2,7),$g=Math.pow(2,14),Wg=Math.pow(2,21),_c=Math.pow(2,28),Sc=Math.pow(2,35),Ac=Math.pow(2,42),Cc=Math.pow(2,49),H=128,xt=127;function ft(r){if(r<Hg)return 1;if(r<$g)return 2;if(r<Wg)return 3;if(r<_c)return 4;if(r<Sc)return 5;if(r<Ac)return 6;if(r<Cc)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Yr(r,t,e=0){switch(ft(r)){case 8:t[e++]=r&255|H,r/=128;case 7:t[e++]=r&255|H,r/=128;case 6:t[e++]=r&255|H,r/=128;case 5:t[e++]=r&255|H,r/=128;case 4:t[e++]=r&255|H,r>>>=7;case 3:t[e++]=r&255|H,r>>>=7;case 2:t[e++]=r&255|H,r>>>=7;case 1:{t[e++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return t}function Gg(r,t,e=0){switch(ft(r)){case 8:t.set(e++,r&255|H),r/=128;case 7:t.set(e++,r&255|H),r/=128;case 6:t.set(e++,r&255|H),r/=128;case 5:t.set(e++,r&255|H),r/=128;case 4:t.set(e++,r&255|H),r>>>=7;case 3:t.set(e++,r&255|H),r>>>=7;case 2:t.set(e++,r&255|H),r>>>=7;case 1:{t.set(e++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return t}function Ic(r,t){let e=r[t],n=0;if(n+=e&xt,e<H||(e=r[t+1],n+=(e&xt)<<7,e<H)||(e=r[t+2],n+=(e&xt)<<14,e<H)||(e=r[t+3],n+=(e&xt)<<21,e<H)||(e=r[t+4],n+=(e&xt)*_c,e<H)||(e=r[t+5],n+=(e&xt)*Sc,e<H)||(e=r[t+6],n+=(e&xt)*Ac,e<H)||(e=r[t+7],n+=(e&xt)*Cc,e<H))return n;throw new RangeError("Could not decode varint")}function jg(r,t){let e=r.get(t),n=0;if(n+=e&xt,e<H||(e=r.get(t+1),n+=(e&xt)<<7,e<H)||(e=r.get(t+2),n+=(e&xt)<<14,e<H)||(e=r.get(t+3),n+=(e&xt)<<21,e<H)||(e=r.get(t+4),n+=(e&xt)*_c,e<H)||(e=r.get(t+5),n+=(e&xt)*Sc,e<H)||(e=r.get(t+6),n+=(e&xt)*Ac,e<H)||(e=r.get(t+7),n+=(e&xt)*Cc,e<H))return n;throw new RangeError("Could not decode varint")}function le(r,t,e=0){return t==null&&(t=bt(ft(r))),t instanceof Uint8Array?Yr(r,t,e):Gg(r,t,e)}function er(r,t=0){return r instanceof Uint8Array?Ic(r,t):jg(r,t)}var Tc=new Float32Array([-0]),Fe=new Uint8Array(Tc.buffer);function dd(r,t,e){Tc[0]=r,t[e]=Fe[0],t[e+1]=Fe[1],t[e+2]=Fe[2],t[e+3]=Fe[3]}function hd(r,t){return Fe[0]=r[t],Fe[1]=r[t+1],Fe[2]=r[t+2],Fe[3]=r[t+3],Tc[0]}var Pc=new Float64Array([-0]),Et=new Uint8Array(Pc.buffer);function pd(r,t,e){Pc[0]=r,t[e]=Et[0],t[e+1]=Et[1],t[e+2]=Et[2],t[e+3]=Et[3],t[e+4]=Et[4],t[e+5]=Et[5],t[e+6]=Et[6],t[e+7]=Et[7]}function md(r,t){return Et[0]=r[t],Et[1]=r[t+1],Et[2]=r[t+2],Et[3]=r[t+3],Et[4]=r[t+4],Et[5]=r[t+5],Et[6]=r[t+6],Et[7]=r[t+7],Pc[0]}var Zg=BigInt(Number.MAX_SAFE_INTEGER),Xg=BigInt(Number.MIN_SAFE_INTEGER),Ut=class r{lo;hi;constructor(t,e){this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){let e=~this.lo+1>>>0,n=~this.hi>>>0;return e===0&&(n=n+1>>>0),-(e+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let e=~this.lo+1>>>0,n=~this.hi>>>0;return e===0&&(n=n+1>>>0),-(BigInt(e)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){let t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){let t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){let t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}static fromBigInt(t){if(t===0n)return rr;if(t<Zg&&t>Xg)return this.fromNumber(Number(t));let e=t<0n;e&&(t=-t);let n=t>>32n,o=t-(n<<32n);return e&&(n=~n|0n,o=~o|0n,++o>gd&&(o=0n,++n>gd&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(t){if(t===0)return rr;let e=t<0;e&&(t=-t);let n=t>>>0,o=(t-n)/4294967296>>>0;return e&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(t){return typeof t=="number"?r.fromNumber(t):typeof t=="bigint"?r.fromBigInt(t):typeof t=="string"?r.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new r(t.low>>>0,t.high>>>0):rr}},rr=new Ut(0,0);rr.toBigInt=function(){return 0n};rr.zzEncode=rr.zzDecode=function(){return this};rr.length=function(){return 1};var gd=4294967296n;function yd(r){let t=0,e=0;for(let n=0;n<r.length;++n)e=r.charCodeAt(n),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,t+=4):t+=3;return t}function bd(r,t,e){if(e-t<1)return"";let o,s=[],i=0,a;for(;t<e;)a=r[t++],a<128?s[i++]=a:a>191&&a<224?s[i++]=(a&31)<<6|r[t++]&63:a>239&&a<365?(a=((a&7)<<18|(r[t++]&63)<<12|(r[t++]&63)<<6|r[t++]&63)-65536,s[i++]=55296+(a>>10),s[i++]=56320+(a&1023)):s[i++]=(a&15)<<12|(r[t++]&63)<<6|r[t++]&63,i>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,s)),i=0);return o!=null?(i>0&&o.push(String.fromCharCode.apply(String,s.slice(0,i))),o.join("")):String.fromCharCode.apply(String,s.slice(0,i))}function Dc(r,t,e){let n=e,o,s;for(let i=0;i<r.length;++i)o=r.charCodeAt(i),o<128?t[e++]=o:o<2048?(t[e++]=o>>6|192,t[e++]=o&63|128):(o&64512)===55296&&((s=r.charCodeAt(i+1))&64512)===56320?(o=65536+((o&1023)<<10)+(s&1023),++i,t[e++]=o>>18|240,t[e++]=o>>12&63|128,t[e++]=o>>6&63|128,t[e++]=o&63|128):(t[e++]=o>>12|224,t[e++]=o>>6&63|128,t[e++]=o&63|128);return e-n}function te(r,t){return RangeError(`index out of range: ${r.pos} + ${t??1} > ${r.len}`)}function bs(r,t){return(r[t-4]|r[t-3]<<8|r[t-2]<<16|r[t-1]<<24)>>>0}var Lc=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(t){this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,te(this,10);return t}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw te(this,4);return bs(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw te(this,4);return bs(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw te(this,4);let t=hd(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw te(this,4);let t=md(this.buf,this.pos);return this.pos+=8,t}bytes(){let t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw te(this,t);return this.pos+=t,e===n?new Uint8Array(0):this.buf.subarray(e,n)}string(){let t=this.bytes();return bd(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw te(this,t);this.pos+=t}else do if(this.pos>=this.len)throw te(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){let t=new Ut(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw te(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw te(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw te(this,8);let t=bs(this.buf,this.pos+=4),e=bs(this.buf,this.pos+=4);return new Ut(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let t=Ic(this.buf,this.pos);return this.pos+=ft(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function Rc(r){return new Lc(r instanceof Uint8Array?r:r.subarray())}function Pt(r,t,e){let n=Rc(r);return t.decode(n,void 0,e)}function Oc(r){let t=r??8192,e=t>>>1,n,o=t;return function(i){if(i<1||i>e)return bt(i);o+i>t&&(n=bt(t),o=0);let a=n.subarray(o,o+=i);return(o&7)!==0&&(o=(o|7)+1),a}}var nr=class{fn;len;next;val;constructor(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}};function kc(){}var Nc=class{head;tail;len;next;constructor(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}},Qg=Oc();function Yg(r){return globalThis.Buffer!=null?bt(r):Qg(r)}var Zn=class{len;head;tail;states;constructor(){this.len=0,this.head=new nr(kc,0,0),this.tail=this.head,this.states=null}_push(t,e,n){return this.tail=this.tail.next=new nr(t,e,n),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new Bc((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(ws,10,Ut.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){let e=Ut.fromBigInt(t);return this._push(ws,e.length(),e)}uint64Number(t){return this._push(Yr,ft(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){let e=Ut.fromBigInt(t).zzEncode();return this._push(ws,e.length(),e)}sint64Number(t){let e=Ut.fromNumber(t).zzEncode();return this._push(ws,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(Mc,1,t?1:0)}fixed32(t){return this._push(jn,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){let e=Ut.fromBigInt(t);return this._push(jn,4,e.lo)._push(jn,4,e.hi)}fixed64Number(t){let e=Ut.fromNumber(t);return this._push(jn,4,e.lo)._push(jn,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(dd,4,t)}double(t){return this._push(pd,8,t)}bytes(t){let e=t.length>>>0;return e===0?this._push(Mc,1,0):this.uint32(e)._push(t0,e,t)}string(t){let e=yd(t);return e!==0?this.uint32(e)._push(Dc,e,t):this._push(Mc,1,0)}fork(){return this.states=new Nc(this),this.head=this.tail=new nr(kc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new nr(kc,0,0),this.len=0),this}ldelim(){let t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=t.next,this.tail=e,this.len+=n),this}finish(){let t=this.head.next,e=Yg(this.len),n=0;for(;t!=null;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e}};function Mc(r,t,e){t[e]=r&255}function Jg(r,t,e){for(;r>127;)t[e++]=r&127|128,r>>>=7;t[e]=r}var Bc=class extends nr{next;constructor(t,e){super(Jg,t,e),this.next=void 0}};function ws(r,t,e){for(;r.hi!==0;)t[e++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)t[e++]=r.lo&127|128,r.lo=r.lo>>>7;t[e++]=r.lo}function jn(r,t,e){t[e]=r&255,t[e+1]=r>>>8&255,t[e+2]=r>>>16&255,t[e+3]=r>>>24}function t0(r,t,e){t.set(r,e)}globalThis.Buffer!=null&&(Zn.prototype.bytes=function(r){let t=r.length>>>0;return this.uint32(t),t>0&&this._push(e0,t,r),this},Zn.prototype.string=function(r){let t=globalThis.Buffer.byteLength(r);return this.uint32(t),t>0&&this._push(r0,t,r),this});function e0(r,t,e){t.set(r,e)}function r0(r,t,e){r.length<40?Dc(r,t,e):t.utf8Write!=null?t.utf8Write(r,e):t.set(D(r),e)}function Fc(){return new Zn}function Dt(r,t){let e=Fc();return t.encode(r,e,{lengthDelimited:!1}),e.finish()}var tn;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(tn||(tn={}));function xs(r,t,e,n){return{name:r,type:t,encode:e,decode:n}}function Uc(r){function t(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let e=function(s,i){let a=t(s);i.int32(a)},n=function(s){let i=s.int32();return t(i)};return xs("enum",tn.VARINT,e,n)}function Lt(r,t){return xs("message",tn.LENGTH_DELIMITED,r,t)}var or=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Xn=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var it;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(it||(it={}));var Kc;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Kc||(Kc={}));(function(r){r.codec=()=>Uc(Kc)})(it||(it={}));var ue;(function(r){let t;r.codec=()=>(t==null&&(t=Lt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.Type!=null&&(n.uint32(8),it.codec().encode(e.Type,n)),e.Data!=null&&(n.uint32(18),n.bytes(e.Data)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.Type=it.codec().decode(e);break}case 2:{s.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Dt(e,r.codec()),r.decode=(e,n)=>Pt(e,r.codec(),n)})(ue||(ue={}));var qc;(function(r){let t;r.codec=()=>(t==null&&(t=Lt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.Type!=null&&(n.uint32(8),it.codec().encode(e.Type,n)),e.Data!=null&&(n.uint32(18),n.bytes(e.Data)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.Type=it.codec().decode(e);break}case 2:{s.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Dt(e,r.codec()),r.decode=(e,n)=>Pt(e,r.codec(),n)})(qc||(qc={}));function en(r){if(isNaN(r)||r<=0)throw new k("random bytes length must be a Number bigger than 0");return je(r)}var Yn={};Ot(Yn,{MAX_RSA_KEY_SIZE:()=>zc,generateRSAKeyPair:()=>Qc,jwkToJWKKeyPair:()=>Sd,jwkToPkcs1:()=>i0,jwkToPkix:()=>Wc,jwkToRSAPrivateKey:()=>Xc,pkcs1MessageToJwk:()=>Hc,pkcs1MessageToRSAPrivateKey:()=>Gc,pkcs1ToJwk:()=>s0,pkcs1ToRSAPrivateKey:()=>_d,pkixMessageToJwk:()=>$c,pkixMessageToRSAPublicKey:()=>Zc,pkixToJwk:()=>a0,pkixToRSAPublicKey:()=>jc});var Es=as;var rn=class{type="RSA";jwk;_raw;_multihash;constructor(t,e){this.jwk=t,this._multihash=e}get raw(){return this._raw==null&&(this._raw=Yn.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return tt.createV1(114,this._multihash)}toString(){return j.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}verify(t,e,n){return vd(this.jwk,e,t,n)}},Qn=class{type="RSA";jwk;_raw;publicKey;constructor(t,e){this.jwk=t,this.publicKey=e}get raw(){return this._raw==null&&(this._raw=Yn.jwkToPkcs1(this.jwk)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}sign(t,e){return Ed(this.jwk,t,e)}};var zc=8192,Vc=18,n0=1062,o0=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function s0(r){let t=ye(r);return Hc(t)}function Hc(r){return{n:N(r[1],"base64url"),e:N(r[2],"base64url"),d:N(r[3],"base64url"),p:N(r[4],"base64url"),q:N(r[5],"base64url"),dp:N(r[6],"base64url"),dq:N(r[7],"base64url"),qi:N(r[8],"base64url"),kty:"RSA"}}function i0(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new k("JWK was missing components");return Qt([Ct(Uint8Array.from([0])),Ct(D(r.n,"base64url")),Ct(D(r.e,"base64url")),Ct(D(r.d,"base64url")),Ct(D(r.p,"base64url")),Ct(D(r.q,"base64url")),Ct(D(r.dp,"base64url")),Ct(D(r.dq,"base64url")),Ct(D(r.qi,"base64url"))]).subarray()}function a0(r){let t=ye(r,{offset:0});return $c(t)}function $c(r){let t=ye(r[1],{offset:0});return{kty:"RSA",n:N(t[0],"base64url"),e:N(t[1],"base64url")}}function Wc(r){if(r.n==null||r.e==null)throw new k("JWK was missing components");return Qt([o0,Mn(Qt([Ct(D(r.n,"base64url")),Ct(D(r.e,"base64url"))]))]).subarray()}function _d(r){let t=ye(r);return Gc(t)}function Gc(r){let t=Hc(r);return Xc(t)}function jc(r,t){if(r.byteLength>=n0)throw new Lr("Key size is too large");let e=ye(r,{offset:0});return Zc(e,r,t)}function Zc(r,t,e){let n=$c(r);if(e==null){let o=Es(ue.encode({Type:it.RSA,Data:t}));e=jt(Vc,o)}return new rn(n,e)}function Xc(r){if(Cd(r)>zc)throw new k("Key size is too large");let t=Sd(r),e=Es(ue.encode({Type:it.RSA,Data:Wc(t.publicKey)})),n=jt(Vc,e);return new Qn(t.privateKey,new rn(t.publicKey,n))}async function Qc(r){if(r>zc)throw new k("Key size is too large");let t=await Ad(r),e=Es(ue.encode({Type:it.RSA,Data:Wc(t.publicKey)})),n=jt(Vc,e);return new Qn(t.privateKey,new rn(t.publicKey,n))}function Sd(r){if(r==null)throw new k("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function Ad(r,t){let e=await kt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);t?.signal?.throwIfAborted();let n=await c0(e,t);return{privateKey:n[0],publicKey:n[1]}}async function Ed(r,t,e){let n=await kt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);e?.signal?.throwIfAborted();let o=await kt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return e?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function vd(r,t,e,n){let o=await kt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let s=await kt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,t,e instanceof Uint8Array?e:e.subarray());return n?.signal?.throwIfAborted(),s}async function c0(r,t){if(r.privateKey==null||r.publicKey==null)throw new k("Private and public key are required");let e=await Promise.all([kt.get().subtle.exportKey("jwk",r.privateKey),kt.get().subtle.exportKey("jwk",r.publicKey)]);return t?.signal?.throwIfAborted(),e}function Cd(r){if(r.kty!=="RSA")throw new k("invalid key type");if(r.n==null)throw new k("invalid key modulus");return D(r.n,"base64url").length*8}var vs=class extends qr{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,xf(t);let n=Bn(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let o=this.blockLen,s=new Uint8Array(o);s.set(n.length>o?t.create().update(n).digest():n);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=t.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),we(s)}update(t){return Vr(this),this.iHash.update(t),this}digestInto(t){Vr(this),wt(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:e,iHash:n,finished:o,destroyed:s,blockLen:i,outputLen:a}=this;return t=t,t.finished=o,t.destroyed=s,t.blockLen=i,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Yc=(r,t,e)=>new vs(r,t).update(e).digest();Yc.create=(r,t)=>new vs(r,t);function Id(r){r.lowS!==void 0&&Ee("lowS",r.lowS),r.prehash!==void 0&&Ee("prehash",r.prehash)}var Jc=class extends Error{constructor(t=""){super(t)}},ve={Err:Jc,_tlv:{encode:(r,t)=>{let{Err:e}=ve;if(r<0||r>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");let n=t.length/2,o=qn(n);if(o.length/2&128)throw new e("tlv.encode: long form length too big");let s=n>127?qn(o.length/2|128):"";return qn(r)+s+o+t},decode(r,t){let{Err:e}=ve,n=0;if(r<0||r>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[n++]!==r)throw new e("tlv.decode: wrong tlv");let o=t[n++],s=!!(o&128),i=0;if(!s)i=o;else{let c=o&127;if(!c)throw new e("tlv.decode(long): indefinite length not supported");if(c>4)throw new e("tlv.decode(long): byte length is too big");let u=t.subarray(n,n+c);if(u.length!==c)throw new e("tlv.decode: length bytes not complete");if(u[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(let l of u)i=i<<8|l;if(n+=c,i<128)throw new e("tlv.decode(long): not minimal encoding")}let a=t.subarray(n,n+i);if(a.length!==i)throw new e("tlv.decode: wrong value length");return{v:a,l:t.subarray(n+i)}}},_int:{encode(r){let{Err:t}=ve;if(r<Jn)throw new t("integer: negative integers are not allowed");let e=qn(r);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return e},decode(r){let{Err:t}=ve;if(r[0]&128)throw new t("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return $r(r)}},toSig(r){let{Err:t,_int:e,_tlv:n}=ve,o=Q("signature",r),{v:s,l:i}=n.decode(48,o);if(i.length)throw new t("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,s),{v:u,l}=n.decode(2,c);if(l.length)throw new t("invalid signature: left bytes after parsing");return{r:e.decode(a),s:e.decode(u)}},hexFromSig(r){let{_tlv:t,_int:e}=ve,n=t.encode(2,e.encode(r.r)),o=t.encode(2,e.encode(r.s)),s=n+o;return t.encode(48,s)}},Jn=BigInt(0),to=BigInt(1),l0=BigInt(2),_s=BigInt(3),u0=BigInt(4);function f0(r,t,e){function n(o){let s=r.sqr(o),i=r.mul(s,o);return r.add(r.add(i,r.mul(o,t)),e)}return n}function Td(r,t,e){let{BYTES:n}=r;function o(s){let i;if(typeof s=="bigint")i=s;else{let a=Q("private key",s);if(t){if(!t.includes(a.length*2))throw new Error("invalid private key");let c=new Uint8Array(n);c.set(a,c.length-a.length),a=c}try{i=r.fromBytes(a)}catch{throw new Error(`invalid private key: expected ui8a of size ${n}, got ${typeof s}`)}}if(e&&(i=r.create(i)),!r.isValidNot0(i))throw new Error("invalid private key: out of range [1..N-1]");return i}return o}function d0(r,t={}){let{Fp:e,Fn:n}=ds("weierstrass",r,t),{h:o,n:s}=r;Be(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:i}=t;if(i&&(!e.is0(r.a)||typeof i.beta!="bigint"||typeof i.splitScalar!="function"))throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function');function a(){if(!e.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(I,y,S){let{x,y:v}=y.toAffine(),A=e.toBytes(x);if(Ee("isCompressed",S),S){a();let P=!e.isOdd(v);return Ft(Pd(P),A)}else return Ft(Uint8Array.of(4),A,e.toBytes(v))}function u(I){wt(I);let y=e.BYTES,S=y+1,x=2*y+1,v=I.length,A=I[0],P=I.subarray(1);if(v===S&&(A===2||A===3)){let T=e.fromBytes(P);if(!e.isValid(T))throw new Error("bad point: is not on curve, wrong x");let O=d(T),F;try{F=e.sqrt(O)}catch(W){let U=W instanceof Error?": "+W.message:"";throw new Error("bad point: is not on curve, sqrt error"+U)}a();let B=e.isOdd(F);return(A&1)===1!==B&&(F=e.neg(F)),{x:T,y:F}}else if(v===x&&A===4){let T=e.fromBytes(P.subarray(y*0,y*1)),O=e.fromBytes(P.subarray(y*1,y*2));if(!h(T,O))throw new Error("bad point: is not on curve");return{x:T,y:O}}else throw new Error(`bad point: got length ${v}, expected compressed=${S} or uncompressed=${x}`)}let l=t.toBytes||c,f=t.fromBytes||u,d=f0(e,r.a,r.b);function h(I,y){let S=e.sqr(y),x=d(I);return e.eql(S,x)}if(!h(r.Gx,r.Gy))throw new Error("bad curve params: generator point");let p=e.mul(e.pow(r.a,_s),u0),g=e.mul(e.sqr(r.b),BigInt(27));if(e.is0(e.add(p,g)))throw new Error("bad curve params: a or b");function m(I,y,S=!1){if(!e.isValid(y)||S&&e.is0(y))throw new Error(`bad point coordinate ${I}`);return y}function w(I){if(!(I instanceof b))throw new Error("ProjectivePoint expected")}let E=Gr((I,y)=>{let{px:S,py:x,pz:v}=I;if(e.eql(v,e.ONE))return{x:S,y:x};let A=I.is0();y==null&&(y=A?e.ONE:e.inv(v));let P=e.mul(S,y),T=e.mul(x,y),O=e.mul(v,y);if(A)return{x:e.ZERO,y:e.ZERO};if(!e.eql(O,e.ONE))throw new Error("invZ was invalid");return{x:P,y:T}}),_=Gr(I=>{if(I.is0()){if(t.allowInfinityPoint&&!e.is0(I.py))return;throw new Error("bad point: ZERO")}let{x:y,y:S}=I.toAffine();if(!e.isValid(y)||!e.isValid(S))throw new Error("bad point: x or y not field elements");if(!h(y,S))throw new Error("bad point: equation left != right");if(!I.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function C(I,y,S,x,v){return S=new b(e.mul(S.px,I),S.py,S.pz),y=jr(x,y),S=jr(v,S),y.add(S)}class b{constructor(y,S,x){this.px=m("x",y),this.py=m("y",S,!0),this.pz=m("z",x),Object.freeze(this)}static fromAffine(y){let{x:S,y:x}=y||{};if(!y||!e.isValid(S)||!e.isValid(x))throw new Error("invalid affine point");if(y instanceof b)throw new Error("projective point not allowed");return e.is0(S)&&e.is0(x)?b.ZERO:new b(S,x,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){return ls(b,"pz",y)}static fromBytes(y){return wt(y),b.fromHex(y)}static fromHex(y){let S=b.fromAffine(f(Q("pointHex",y)));return S.assertValidity(),S}static fromPrivateKey(y){let S=Td(n,t.allowedPrivateKeyLengths,t.wrapPrivateKey);return b.BASE.multiply(S(y))}static msm(y,S){return fs(b,n,y,S)}precompute(y=8,S=!0){return R.setWindowSize(this,y),S||this.multiply(_s),this}_setWindowSize(y){this.precompute(y)}assertValidity(){_(this)}hasEvenY(){let{y}=this.toAffine();if(!e.isOdd)throw new Error("Field doesn't support isOdd");return!e.isOdd(y)}equals(y){w(y);let{px:S,py:x,pz:v}=this,{px:A,py:P,pz:T}=y,O=e.eql(e.mul(S,T),e.mul(A,v)),F=e.eql(e.mul(x,T),e.mul(P,v));return O&&F}negate(){return new b(this.px,e.neg(this.py),this.pz)}double(){let{a:y,b:S}=r,x=e.mul(S,_s),{px:v,py:A,pz:P}=this,T=e.ZERO,O=e.ZERO,F=e.ZERO,B=e.mul(v,v),st=e.mul(A,A),W=e.mul(P,P),U=e.mul(v,A);return U=e.add(U,U),F=e.mul(v,P),F=e.add(F,F),T=e.mul(y,F),O=e.mul(x,W),O=e.add(T,O),T=e.sub(st,O),O=e.add(st,O),O=e.mul(T,O),T=e.mul(U,T),F=e.mul(x,F),W=e.mul(y,W),U=e.sub(B,W),U=e.mul(y,U),U=e.add(U,F),F=e.add(B,B),B=e.add(F,B),B=e.add(B,W),B=e.mul(B,U),O=e.add(O,B),W=e.mul(A,P),W=e.add(W,W),B=e.mul(W,U),T=e.sub(T,B),F=e.mul(W,st),F=e.add(F,F),F=e.add(F,F),new b(T,O,F)}add(y){w(y);let{px:S,py:x,pz:v}=this,{px:A,py:P,pz:T}=y,O=e.ZERO,F=e.ZERO,B=e.ZERO,st=r.a,W=e.mul(r.b,_s),U=e.mul(S,A),ct=e.mul(x,P),lt=e.mul(v,T),yt=e.add(S,x),Z=e.add(A,P);yt=e.mul(yt,Z),Z=e.add(U,ct),yt=e.sub(yt,Z),Z=e.add(S,v);let At=e.add(A,T);return Z=e.mul(Z,At),At=e.add(U,lt),Z=e.sub(Z,At),At=e.add(x,v),O=e.add(P,T),At=e.mul(At,O),O=e.add(ct,lt),At=e.sub(At,O),B=e.mul(st,Z),O=e.mul(W,lt),B=e.add(O,B),O=e.sub(ct,B),B=e.add(ct,B),F=e.mul(O,B),ct=e.add(U,U),ct=e.add(ct,U),lt=e.mul(st,lt),Z=e.mul(W,Z),ct=e.add(ct,lt),lt=e.sub(U,lt),lt=e.mul(st,lt),Z=e.add(Z,lt),U=e.mul(ct,Z),F=e.add(F,U),U=e.mul(At,Z),O=e.mul(yt,O),O=e.sub(O,U),U=e.mul(yt,ct),B=e.mul(At,B),B=e.add(B,U),new b(O,F,B)}subtract(y){return this.add(y.negate())}is0(){return this.equals(b.ZERO)}multiply(y){let{endo:S}=t;if(!n.isValidNot0(y))throw new Error("invalid scalar: out of range");let x,v,A=P=>R.wNAFCached(this,P,b.normalizeZ);if(S){let{k1neg:P,k1:T,k2neg:O,k2:F}=S.splitScalar(y),{p:B,f:st}=A(T),{p:W,f:U}=A(F);v=st.add(U),x=C(S.beta,B,W,P,O)}else{let{p:P,f:T}=A(y);x=P,v=T}return b.normalizeZ([x,v])[0]}multiplyUnsafe(y){let{endo:S}=t,x=this;if(!n.isValid(y))throw new Error("invalid scalar: out of range");if(y===Jn||x.is0())return b.ZERO;if(y===to)return x;if(R.hasPrecomputes(this))return this.multiply(y);if(S){let{k1neg:v,k1:A,k2neg:P,k2:T}=S.splitScalar(y),{p1:O,p2:F}=ed(b,x,A,T);return C(S.beta,O,F,v,P)}else return R.wNAFCachedUnsafe(x,y)}multiplyAndAddUnsafe(y,S,x){let v=this.multiplyUnsafe(S).add(y.multiplyUnsafe(x));return v.is0()?void 0:v}toAffine(y){return E(this,y)}isTorsionFree(){let{isTorsionFree:y}=t;return o===to?!0:y?y(b,this):R.wNAFCachedUnsafe(this,s).is0()}clearCofactor(){let{clearCofactor:y}=t;return o===to?this:y?y(b,this):this.multiplyUnsafe(o)}toBytes(y=!0){return Ee("isCompressed",y),this.assertValidity(),l(b,this,y)}toRawBytes(y=!0){return this.toBytes(y)}toHex(y=!0){return ie(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}b.BASE=new b(r.Gx,r.Gy,e.ONE),b.ZERO=new b(e.ZERO,e.ONE,e.ZERO),b.Fp=e,b.Fn=n;let L=n.BITS,R=us(b,t.endo?Math.ceil(L/2):L);return b}function Pd(r){return Uint8Array.of(r?2:3)}function h0(r,t,e={}){Be(t,{hash:"function"},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let n=t.randomBytes||je,o=t.hmac||((x,...v)=>Yc(t.hash,x,Ft(...v))),{Fp:s,Fn:i}=r,{ORDER:a,BITS:c}=i;function u(x){let v=a>>to;return x>v}function l(x){return u(x)?i.neg(x):x}function f(x,v){if(!i.isValidNot0(v))throw new Error(`invalid signature ${x}: out of range 1..CURVE.n`)}class d{constructor(v,A,P){f("r",v),f("s",A),this.r=v,this.s=A,P!=null&&(this.recovery=P),Object.freeze(this)}static fromCompact(v){let A=i.BYTES,P=Q("compactSignature",v,A*2);return new d(i.fromBytes(P.subarray(0,A)),i.fromBytes(P.subarray(A,A*2)))}static fromDER(v){let{r:A,s:P}=ve.toSig(Q("DER",v));return new d(A,P)}assertValidity(){}addRecoveryBit(v){return new d(this.r,this.s,v)}recoverPublicKey(v){let A=s.ORDER,{r:P,s:T,recovery:O}=this;if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");if(a*l0<A&&O>1)throw new Error("recovery id is ambiguous for h>1 curve");let B=O===2||O===3?P+a:P;if(!s.isValid(B))throw new Error("recovery id 2 or 3 invalid");let st=s.toBytes(B),W=r.fromHex(Ft(Pd((O&1)===0),st)),U=i.inv(B),ct=_(Q("msgHash",v)),lt=i.create(-ct*U),yt=i.create(T*U),Z=r.BASE.multiplyUnsafe(lt).add(W.multiplyUnsafe(yt));if(Z.is0())throw new Error("point at infinify");return Z.assertValidity(),Z}hasHighS(){return u(this.s)}normalizeS(){return this.hasHighS()?new d(this.r,i.neg(this.s),this.recovery):this}toBytes(v){if(v==="compact")return Ft(i.toBytes(this.r),i.toBytes(this.s));if(v==="der")return Hr(ve.hexFromSig(this));throw new Error("invalid format")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return ie(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return ie(this.toBytes("compact"))}}let h=Td(i,e.allowedPrivateKeyLengths,e.wrapPrivateKey),p={isValidPrivateKey(x){try{return h(x),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{let x=a;return Zf(n(gc(x)),x)},precompute(x=8,v=r.BASE){return v.precompute(x,!1)}};function g(x,v=!0){return r.fromPrivateKey(x).toBytes(v)}function m(x){if(typeof x=="bigint")return!1;if(x instanceof r)return!0;let A=Q("key",x).length,P=s.BYTES,T=P+1,O=2*P+1;if(!(e.allowedPrivateKeyLengths||i.BYTES===T))return A===T||A===O}function w(x,v,A=!0){if(m(x)===!0)throw new Error("first arg must be private key");if(m(v)===!1)throw new Error("second arg must be public key");return r.fromHex(v).multiply(h(x)).toBytes(A)}let E=t.bits2int||function(x){if(x.length>8192)throw new Error("input is too large");let v=$r(x),A=x.length*8-c;return A>0?v>>BigInt(A):v},_=t.bits2int_modN||function(x){return i.create(E(x))},C=Ye(c);function b(x){return Ne("num < 2^"+c,x,Jn,C),i.toBytes(x)}function L(x,v,A=R){if(["recovered","canonical"].some(yt=>yt in A))throw new Error("sign() legacy options not supported");let{hash:P}=t,{lowS:T,prehash:O,extraEntropy:F}=A;T==null&&(T=!0),x=Q("msgHash",x),Id(A),O&&(x=Q("prehashed msgHash",P(x)));let B=_(x),st=h(v),W=[b(st),b(B)];if(F!=null&&F!==!1){let yt=F===!0?n(s.BYTES):F;W.push(Q("extraEntropy",yt))}let U=Ft(...W),ct=B;function lt(yt){let Z=E(yt);if(!i.isValidNot0(Z))return;let At=i.inv(Z),Sn=r.BASE.multiply(Z).toAffine(),Tr=i.create(Sn.x);if(Tr===Jn)return;let Ve=i.create(At*i.create(ct+Tr*st));if(Ve===Jn)return;let Ta=(Sn.x===Tr?0:2)|Number(Sn.y&to),Pr=Ve;return T&&u(Ve)&&(Pr=l(Ve),Ta^=1),new d(Tr,Pr,Ta)}return{seed:U,k2sig:lt}}let R={lowS:t.lowS,prehash:!1},I={lowS:t.lowS,prehash:!1};function y(x,v,A=R){let{seed:P,k2sig:T}=L(x,v,A);return Uf(t.hash.outputLen,i.BYTES,o)(P,T)}r.BASE.precompute(8);function S(x,v,A,P=I){let T=x;v=Q("msgHash",v),A=Q("publicKey",A),Id(P);let{lowS:O,prehash:F,format:B}=P;if("strict"in P)throw new Error("options.strict was renamed to lowS");if(B!==void 0&&!["compact","der","js"].includes(B))throw new Error('format must be "compact", "der" or "js"');let st=typeof T=="string"||zr(T),W=!st&&!B&&typeof T=="object"&&T!==null&&typeof T.r=="bigint"&&typeof T.s=="bigint";if(!st&&!W)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let U,ct;try{if(W)if(B===void 0||B==="js")U=new d(T.r,T.s);else throw new Error("invalid format");if(st){try{B!=="compact"&&(U=d.fromDER(T))}catch(Pr){if(!(Pr instanceof ve.Err))throw Pr}!U&&B!=="der"&&(U=d.fromCompact(T))}ct=r.fromHex(A)}catch{return!1}if(!U||O&&U.hasHighS())return!1;F&&(v=t.hash(v));let{r:lt,s:yt}=U,Z=_(v),At=i.inv(yt),Sn=i.create(Z*At),Tr=i.create(lt*At),Ve=r.BASE.multiplyUnsafe(Sn).add(ct.multiplyUnsafe(Tr));return Ve.is0()?!1:i.create(Ve.x)===lt}return Object.freeze({getPublicKey:g,getSharedSecret:w,sign:y,verify:S,utils:p,Point:r,Signature:d})}function p0(r){let t={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},e=r.Fp,n=Jt(t.n,r.nBitLength),o={Fp:e,Fn:n,allowedPrivateKeyLengths:r.allowedPrivateKeyLengths,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,wrapPrivateKey:r.wrapPrivateKey,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:t,curveOpts:o}}function m0(r){let{CURVE:t,curveOpts:e}=p0(r),n={hash:r.hash,hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:t,curveOpts:e,ecdsaOpts:n}}function g0(r,t){return Object.assign({},t,{ProjectivePoint:t.Point,CURVE:r})}function Dd(r){let{CURVE:t,curveOpts:e,ecdsaOpts:n}=m0(r),o=d0(t,e),s=h0(o,n,e);return g0(r,s)}function Ld(r,t){let e=n=>Dd({...r,hash:n});return{...e(t),create:e}}var Ss={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},$v=BigInt(0),y0=BigInt(1),tl=BigInt(2),Rd=(r,t)=>(r+t/tl)/t;function b0(r){let t=Ss.p,e=BigInt(3),n=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%t,l=u*u*r%t,f=Y(l,e,t)*l%t,d=Y(f,e,t)*l%t,h=Y(d,tl,t)*u%t,p=Y(h,o,t)*h%t,g=Y(p,s,t)*p%t,m=Y(g,a,t)*g%t,w=Y(m,c,t)*m%t,E=Y(w,a,t)*g%t,_=Y(E,e,t)*l%t,C=Y(_,i,t)*p%t,b=Y(C,n,t)*u%t,L=Y(b,tl,t);if(!el.eql(el.sqr(L),r))throw new Error("Cannot find square root");return L}var el=Jt(Ss.p,void 0,void 0,{sqrt:b0}),ee=Ld({...Ss,Fp:el,lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let t=Ss.n,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-y0*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),o=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=e,i=BigInt("0x100000000000000000000000000000000"),a=Rd(s*r,t),c=Rd(-n*r,t),u=et(r-a*e-c*o,t),l=et(-a*n-c*s,t),f=u>i,d=l>i;if(f&&(u=t-u),d&&(l=t-l),u>i||l>i)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:u,k2neg:d,k2:l}}}},as);function Od(r,t,e){let n=Kr.digest(t instanceof Uint8Array?t:t.subarray());if(Qr(n))return n.then(({digest:o})=>(e?.signal?.throwIfAborted(),ee.sign(o,r).toDERRawBytes())).catch(o=>{throw o.name==="AbortError"?o:new Hn(String(o))});try{return ee.sign(n.digest,r).toDERRawBytes()}catch(o){throw new Hn(String(o))}}function kd(r,t,e,n){let o=Kr.digest(e instanceof Uint8Array?e:e.subarray());if(Qr(o))return o.then(({digest:s})=>(n?.signal?.throwIfAborted(),ee.verify(t,s,r))).catch(s=>{throw s.name==="AbortError"?s:new $n(String(s))});try{return n?.signal?.throwIfAborted(),ee.verify(t,o.digest,r)}catch(s){throw new $n(String(s))}}var eo=class{type="secp256k1";raw;_key;constructor(t){this._key=Bd(t),this.raw=Md(this._key)}toMultihash(){return Zt.digest(Vt(this))}toCID(){return tt.createV1(114,this.toMultihash())}toString(){return j.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}verify(t,e,n){return kd(this._key,e,t,n)}},As=class{type="secp256k1";raw;publicKey;constructor(t,e){this.raw=Nd(t),this.publicKey=new eo(e??Fd(t))}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:G(this.raw,t.raw)}sign(t,e){return Od(this.raw,t,e)}};function rl(r){return new eo(r)}async function Ud(){let r=w0();return new As(r)}function Md(r){return ee.ProjectivePoint.fromHex(r).toRawBytes(!0)}function Nd(r){try{return ee.getPublicKey(r,!0),r}catch(t){throw new An(String(t))}}function Bd(r){try{return ee.ProjectivePoint.fromHex(r),r}catch(t){throw new Lr(String(t))}}function Fd(r){try{return ee.getPublicKey(r,!0)}catch(t){throw new An(String(t))}}function w0(){return ee.utils.randomPrivateKey()}async function Kd(r,t){if(r==="Ed25519")return fd();if(r==="secp256k1")return Ud();if(r==="RSA")return Qc(x0(t));if(r==="ECDSA")return bf(E0(t));throw new De}function nn(r,t){let{Type:e,Data:n}=ue.decode(r),o=n??new Uint8Array;switch(e){case it.RSA:return jc(o,t);case it.Ed25519:return vc(o);case it.secp256k1:return rl(o);case it.ECDSA:return ac(o);default:throw new De}}function qd(r){let{Type:t,Data:e}=ue.decode(r.digest),n=e??new Uint8Array;switch(t){case it.Ed25519:return vc(n);case it.secp256k1:return rl(n);case it.ECDSA:return ac(n);default:throw new De}}function Vt(r){return ue.encode({Type:it[r.type],Data:r.raw})}function x0(r){return r==null?2048:parseInt(r,10)}function E0(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new k("Unsupported curve, should be P-256, P-384 or P-521")}var zd=Symbol.for("nodejs.util.inspect.custom"),v0=114,ro=class{type;multihash;publicKey;string;constructor(t){this.type=t.type,this.multihash=t.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Ho]=!0;toString(){return this.string==null&&(this.string=j.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return tt.createV1(v0,this.multihash)}toJSON(){return this.toString()}equals(t){if(t==null)return!1;if(t instanceof Uint8Array)return G(this.multihash.bytes,t);if(typeof t=="string")return this.toString()===t;if(t?.toMultihash()?.bytes!=null)return G(this.multihash.bytes,t.toMultihash().bytes);throw new Error("not valid Id")}[zd](){return`PeerId(${this.toString()})`}},no=class extends ro{type="RSA";publicKey;constructor(t){super({...t,type:"RSA"}),this.publicKey=t.publicKey}},oo=class extends ro{type="Ed25519";publicKey;constructor(t){super({...t,type:"Ed25519"}),this.publicKey=t.publicKey}},so=class extends ro{type="secp256k1";publicKey;constructor(t){super({...t,type:"secp256k1"}),this.publicKey=t.publicKey}},_0=2336,io=class{type="url";multihash;publicKey;url;constructor(t){this.url=t.toString(),this.multihash=Zt.digest(D(this.url))}[zd](){return`PeerId(${this.url})`}[Ho]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return tt.createV1(_0,this.toMultihash())}toJSON(){return this.toString()}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=N(t)),t.toString()===this.toString())}};var S0=114,Vd=2336;function fe(r,t){let e;if(r.charAt(0)==="1"||r.charAt(0)==="Q")e=ge(j.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return ao(tt.parse(r));if(t==null)throw new k('Please pass a multibase decoder for strings that do not start with "1" or "Q"');e=ge(t.decode(r))}return on(e)}function nl(r){if(r.type==="Ed25519")return new oo({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new so({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new no({multihash:r.toCID().multihash,publicKey:r});throw new De}function Hd(r){return nl(r.publicKey)}function on(r){if(C0(r))return new no({multihash:r});if(A0(r))try{let t=qd(r);if(t.type==="Ed25519")return new oo({multihash:r,publicKey:t});if(t.type==="secp256k1")return new so({multihash:r,publicKey:t})}catch{let e=N(r.digest);return new io(new URL(e))}throw new Go("Supplied PeerID Multihash is invalid")}function ao(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==S0&&r.code!==Vd)throw new Wo("Supplied PeerID CID is invalid");if(r.code===Vd){let t=N(r.multihash.digest);return new io(new URL(t))}return on(r.multihash)}function A0(r){return r.code===Zt.code}function C0(r){return r.code===Kr.code}function sn(r){if(typeof r!="object"||r===null)return!1;let t=Object.getPrototypeOf(r);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}var{hasOwnProperty:Wd}=Object.prototype,{propertyIsEnumerable:I0}=Object,an=(r,t,e)=>{Object.defineProperty(r,t,{value:e,writable:!0,enumerable:!0,configurable:!0})},T0=void 0,$d={concatArrays:!1,ignoreUndefined:!1},Cs=r=>{let t=[];for(let e in r)Wd.call(r,e)&&t.push(e);if(Object.getOwnPropertySymbols){let e=Object.getOwnPropertySymbols(r);for(let n of e)I0.call(r,n)&&t.push(n)}return t};function cn(r){return Array.isArray(r)?P0(r):sn(r)?D0(r):r}function P0(r){let t=r.slice(0,0);return Cs(r).forEach(e=>{an(t,e,cn(r[e]))}),t}function D0(r){let t=Object.getPrototypeOf(r)===null?Object.create(null):{};return Cs(r).forEach(e=>{an(t,e,cn(r[e]))}),t}var Gd=(r,t,e,n)=>(e.forEach(o=>{typeof t[o]>"u"&&n.ignoreUndefined||(o in r&&r[o]!==Object.getPrototypeOf(r)?an(r,o,ol(r[o],t[o],n)):an(r,o,cn(t[o])))}),r),L0=(r,t,e)=>{let n=r.slice(0,0),o=0;return[r,t].forEach(s=>{let i=[];for(let a=0;a<s.length;a++)Wd.call(s,a)&&(i.push(String(a)),s===r?an(n,o++,s[a]):an(n,o++,cn(s[a])));n=Gd(n,s,Cs(s).filter(a=>!i.includes(a)),e)}),n};function ol(r,t,e){return e.concatArrays&&Array.isArray(r)&&Array.isArray(t)?L0(r,t,e):!sn(t)||!sn(r)?cn(t):Gd(r,t,Cs(t),e)}function Is(...r){let t=ol(cn($d),this!==T0&&this||{},$d),e={_:{}};for(let n of r)if(n!==void 0){if(!sn(n))throw new TypeError("`"+n+"` is not an Option Object");e=ol(e,{_:n},t)}return e._}var at=class extends Event{type;detail;constructor(t,e){super(t),this.type=t,this.detail=e}};var il=Vo(Zd(),1);var lo=class extends Error{constructor(t){super(t),this.name="TimeoutError"}},al=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}},Xd=r=>globalThis.DOMException===void 0?new al(r):new DOMException(r),Qd=r=>{let t=r.reason===void 0?Xd("This operation was aborted."):r.reason;return t instanceof Error?t:Xd(t)};function cl(r,t){let{milliseconds:e,fallback:n,message:o,customTimers:s={setTimeout,clearTimeout}}=t,i,a,u=new Promise((l,f)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){let{signal:h}=t;h.aborted&&f(Qd(h)),a=()=>{f(Qd(h))},h.addEventListener("abort",a,{once:!0})}if(e===Number.POSITIVE_INFINITY){r.then(l,f);return}let d=new lo;i=s.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(h){f(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?l():o instanceof Error?f(o):(d.message=o??`Promise timed out after ${e} milliseconds`,f(d))},e),(async()=>{try{l(await r)}catch(h){f(h)}})()}).finally(()=>{u.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return u.clear=()=>{s.clearTimeout.call(void 0,i),i=void 0},u}function ll(r,t,e){let n=0,o=r.length;for(;o>0;){let s=Math.trunc(o/2),i=n+s;e(r[i],t)<=0?(n=++i,o-=s+1):o=s}return n}var uo=class{#t=[];enqueue(t,e){e={priority:0,...e};let n={priority:e.priority,id:e.id,run:t};if(this.size===0||this.#t[this.size-1].priority>=e.priority){this.#t.push(n);return}let o=ll(this.#t,n,(s,i)=>i.priority-s.priority);this.#t.splice(o,0,n)}setPriority(t,e){let n=this.#t.findIndex(s=>s.id===t);if(n===-1)throw new ReferenceError(`No promise function with the id "${t}" exists in the queue.`);let[o]=this.#t.splice(n,1);this.enqueue(o.run,{priority:e,id:t})}dequeue(){return this.#t.shift()?.run}filter(t){return this.#t.filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return this.#t.length}};var fo=class extends il.default{#t;#n;#e=0;#h;#a;#p=0;#o;#c;#r;#m;#s=0;#l;#i;#g;#w=1n;timeout;constructor(t){if(super(),t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:uo,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${t.intervalCap?.toString()??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${t.interval?.toString()??""}\` (${typeof t.interval})`);this.#t=t.carryoverConcurrencyCount,this.#n=t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0,this.#h=t.intervalCap,this.#a=t.interval,this.#r=new t.queueClass,this.#m=t.queueClass,this.concurrency=t.concurrency,this.timeout=t.timeout,this.#g=t.throwOnTimeout===!0,this.#i=t.autoStart===!1}get#x(){return this.#n||this.#e<this.#h}get#E(){return this.#s<this.#l}#v(){this.#s--,this.#u(),this.emit("next")}#_(){this.#b(),this.#y(),this.#c=void 0}get#S(){let t=Date.now();if(this.#o===void 0){let e=this.#p-t;if(e<0)this.#e=this.#t?this.#s:0;else return this.#c===void 0&&(this.#c=setTimeout(()=>{this.#_()},e)),!0}return!1}#u(){if(this.#r.size===0)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),this.#s===0&&this.emit("idle"),!1;if(!this.#i){let t=!this.#S;if(this.#x&&this.#E){let e=this.#r.dequeue();return e?(this.emit("active"),e(),t&&this.#y(),!0):!1}}return!1}#y(){this.#n||this.#o!==void 0||(this.#o=setInterval(()=>{this.#b()},this.#a),this.#p=Date.now()+this.#a)}#b(){this.#e===0&&this.#s===0&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#e=this.#t?this.#s:0,this.#f()}#f(){for(;this.#u(););}get concurrency(){return this.#l}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);this.#l=t,this.#f()}async#A(t){return new Promise((e,n)=>{t.addEventListener("abort",()=>{n(t.reason)},{once:!0})})}setPriority(t,e){this.#r.setPriority(t,e)}async add(t,e={}){return e.id??=(this.#w++).toString(),e={timeout:this.timeout,throwOnTimeout:this.#g,...e},new Promise((n,o)=>{this.#r.enqueue(async()=>{this.#s++,this.#e++;try{e.signal?.throwIfAborted();let s=t({signal:e.signal});e.timeout&&(s=cl(Promise.resolve(s),{milliseconds:e.timeout})),e.signal&&(s=Promise.race([s,this.#A(e.signal)]));let i=await s;n(i),this.emit("completed",i)}catch(s){if(s instanceof lo&&!e.throwOnTimeout){n();return}o(s),this.emit("error",s)}finally{this.#v()}},e),this.emit("add"),this.#u()})}async addAll(t,e){return Promise.all(t.map(async n=>this.add(n,e)))}start(){return this.#i?(this.#i=!1,this.#f(),this):this}pause(){this.#i=!0}clear(){this.#r=new this.#m}async onEmpty(){this.#r.size!==0&&await this.#d("empty")}async onSizeLessThan(t){this.#r.size<t||await this.#d("next",()=>this.#r.size<t)}async onIdle(){this.#s===0&&this.#r.size===0||await this.#d("idle")}async#d(t,e){return new Promise(n=>{let o=()=>{e&&!e()||(this.off(t,o),n())};this.on(t,o)})}get size(){return this.#r.size}sizeBy(t){return this.#r.filter(t).length}get pending(){return this.#s}get isPaused(){return this.#i}};function Ps(r){let t=[Kt.A];return r==null?t:Array.isArray(r)?r.length===0?t:r:[r]}var ul=60;function Ds(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(t=>({name:t.name,type:Kt[t.type]})),Answer:(r.Answer??r.answers??[]).map(t=>({name:t.name,type:Kt[t.type],TTL:t.TTL??t.ttl??ul,data:t.data instanceof Uint8Array?N(t.data):t.data}))}}var k0=4;function fl(r,t={}){let e=new fo({concurrency:t.queryConcurrency??k0});return async(n,o={})=>{let s=new URLSearchParams;s.set("name",n),Ps(o.types).forEach(a=>{s.append("type",Kt[a])}),o.onProgress?.(new at("dns:query",{detail:n}));let i=await e.add(async()=>{let a=await fetch(`${r}?${s}`,{headers:{accept:"application/dns-json"},signal:o?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=Ds(await a.json());return o.onProgress?.(new at("dns:response",{detail:c})),c},{signal:o.signal});if(i==null)throw new Error("No DNS response received");return i}}function Yd(){return[fl("https://cloudflare-dns.com/dns-query"),fl("https://dns.google/resolve")]}var eh=Vo(th(),1);var dl=class{lru;constructor(t){this.lru=(0,eh.default)(t)}get(t,e){let n=!0,o=[];for(let s of e){let i=this.getAnswers(t,s);if(i.length===0){n=!1;break}o.push(...i)}if(n)return Ds({answers:o})}getAnswers(t,e){let n=`${t.toLowerCase()}-${e}`,o=this.lru.get(n);if(o!=null){let s=o.filter(i=>i.expires>Date.now()).map(({expires:i,value:a})=>({...a,TTL:Math.round((i-Date.now())/1e3),type:Kt[a.type]}));return s.length===0&&this.lru.remove(n),s}return[]}add(t,e){let n=`${t.toLowerCase()}-${e.type}`,o=this.lru.get(n)??[];o.push({expires:Date.now()+(e.TTL??ul)*1e3,value:e}),this.lru.set(n,o)}remove(t,e){let n=`${t.toLowerCase()}-${e}`;this.lru.remove(n)}clear(){this.lru.clear()}};function rh(r){return new dl(r)}var M0=1e3,Ls=class{resolvers;cache;constructor(t){this.resolvers={},this.cache=rh(t.cacheSize??M0),Object.entries(t.resolvers??{}).forEach(([e,n])=>{Array.isArray(n)||(n=[n]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=n}),this.resolvers["."]==null&&(this.resolvers["."]=Yd())}async query(t,e={}){let n=Ps(e.types),o=e.cached!==!1?this.cache.get(t,n):void 0;if(o!=null)return e.onProgress?.(new at("dns:cache",{detail:o})),o;let s=`${t.split(".").pop()}.`,i=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of i){if(e.signal?.aborted===!0)break;try{let u=await c(t,{...e,types:n});for(let l of u.Answer)this.cache.add(t,l);return u}catch(u){a.push(u),e.onProgress?.(new at("dns:error",{detail:u}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${n} failed`)}};var Kt;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Kt||(Kt={}));function nh(r={}){return new Ls(r)}var pt=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},_e=class extends Error{static name="ValidationError";name="ValidationError"},ho=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},Rs=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};var Os=class{index=0;input="";new(t){return this.index=0,this.input=t,this}readAtomically(t){let e=this.index,n=t();return n===void 0&&(this.index=e),n}parseWith(t){let e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{let e=this.readChar();if(e===t)return e})}readSeparator(t,e,n){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return n()})}readNumber(t,e,n,o){return this.readAtomically(()=>{let s=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",u=2**(8*o)-1;for(;;){let l=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let d=Number.parseInt(f,t);if(!Number.isNaN(d))return d});if(l===void 0)break;if(s*=t,s+=l,s>u||(i+=1,e!==void 0&&i>e))return}if(i!==0)return!n&&c&&i>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{let t=new Uint8Array(4);for(let e=0;e<t.length;e++){let n=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;t[e]=n}return t})}readIPv6Addr(){let t=e=>{for(let n=0;n<e.length/2;n++){let o=n*2;if(n<e.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return e[o]=i[0],e[o+1]=i[1],e[o+2]=i[2],e[o+3]=i[3],[o+4,!0]}let s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[o,!1];e[o]=s>>8,e[o+1]=s&255}return[e.length,!1]};return this.readAtomically(()=>{let e=new Uint8Array(16),[n,o]=t(e);if(n===16)return e;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let s=new Uint8Array(14),i=16-(n+2),[a]=t(s.subarray(0,i));return e.set(s.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var oh=45,N0=15,ln=new Os;function ks(r){if(!(r.length>N0))return ln.new(r).parseWith(()=>ln.readIPv4Addr())}function Ms(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>oh))return ln.new(r).parseWith(()=>ln.readIPv6Addr())}function un(r,t=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>oh)return;let e=ln.new(r).parseWith(()=>ln.readIPAddr());if(e)return t&&e.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,e[0],e[1],e[2],e[3]]):e}function re(r){return!!ks(r)}function Ns(r){return!!Ms(r)}function pl(r){return t=>N(t,r)}function ml(r){return t=>D(t,r)}function fn(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function sr(r){let t=new ArrayBuffer(2);return new DataView(t).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(t)}function sh(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);let e=D(t[0],"base32"),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=sr(n);return Xt([e,o],e.length+o.length)}function ih(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);let e=zt.decode(`b${t[0]}`),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=sr(n);return Xt([e,o],e.length+o.length)}function gl(r){let t=r.subarray(0,r.length-2),e=r.subarray(r.length-2),n=N(t,"base32"),o=fn(e);return`${n}:${o}`}var yl=function(r){r=r.toString().trim();let t=new Uint8Array(4);return r.split(/\./g).forEach((e,n)=>{let o=parseInt(e,10);if(isNaN(o)||o<0||o>255)throw new pt("Invalid byte value in IP address");t[n]=o}),t},ah=function(r){let t=0;r=r.toString().trim();let e=r.split(":",8),n;for(n=0;n<e.length;n++){let s=re(e[n]),i;s&&(i=yl(e[n]),e[n]=N(i.subarray(0,2),"base16")),i!=null&&++n<8&&e.splice(n,0,N(i.subarray(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(n=0;n<e.length&&e[n]!=="";n++);let s=[n,1];for(n=9-e.length;n>0;n--)s.push("0");e.splice.apply(e,s)}let o=new Uint8Array(t+16);for(n=0;n<e.length;n++){e[n]===""&&(e[n]="0");let s=parseInt(e[n],16);if(isNaN(s)||s<0||s>65535)throw new pt("Invalid byte value in IP address");o[t++]=s>>8&255,o[t++]=s&255}return o},ch=function(r){if(r.byteLength!==4)throw new pt("IPv4 address was incorrect length");let t=[];for(let e=0;e<r.byteLength;e++)t.push(r[e]);return t.join(".")},lh=function(r){if(r.byteLength!==16)throw new pt("IPv6 address was incorrect length");let t=[];for(let n=0;n<r.byteLength;n+=2){let o=r[n],s=r[n+1],i=`${o.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;t.push(i)}let e=t.join(":");try{let n=new URL(`http://[${e}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new pt(`Invalid IPv6 address "${e}"`)}};function uh(r){try{let t=new URL(`http://[${r}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new pt(`Invalid IPv6 address "${r}"`)}}var hl=Object.values(Rn).map(r=>r.decoder),B0=function(){let r=hl[0].or(hl[1]);return hl.slice(2).forEach(t=>r=r.or(t)),r}();function fh(r){return B0.decode(r)}function dh(r){return t=>r.encoder.encode(t)}function F0(r){if(parseInt(r).toString()!==r)throw new _e("Value must be an integer")}function U0(r){if(r<0)throw new _e("Value must be a positive integer, or zero")}function K0(r){return t=>{if(t>r)throw new _e(`Value must be smaller than or equal to ${r}`)}}function q0(...r){return t=>{for(let e of r)e(t)}}var po=q0(F0,U0,K0(65535));var dt=-1,bl=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(t){let e;if(typeof t=="string"?e=this.protocolsByName.get(t):e=this.protocolsByCode.get(t),e==null)throw new Rs(`Protocol ${t} was unknown`);return e}addProtocol(t){this.protocolsByCode.set(t.code,t),this.protocolsByName.set(t.name,t),t.aliases?.forEach(e=>{this.protocolsByName.set(e,t)})}removeProtocol(t){let e=this.protocolsByCode.get(t);e!=null&&(this.protocolsByCode.delete(e.code),this.protocolsByName.delete(e.name),e.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},Mt=new bl,ry=[{code:4,name:"ip4",size:32,valueToBytes:yl,bytesToValue:ch,validate:r=>{if(!re(r))throw new _e(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:sr,bytesToValue:fn,validate:po},{code:273,name:"udp",size:16,valueToBytes:sr,bytesToValue:fn,validate:po},{code:33,name:"dccp",size:16,valueToBytes:sr,bytesToValue:fn,validate:po},{code:41,name:"ip6",size:128,valueToBytes:ah,bytesToValue:lh,stringToValue:uh,validate:r=>{if(!Ns(r))throw new _e(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:dt},{code:43,name:"ipcidr",size:8,bytesToValue:pl("base10"),valueToBytes:ml("base10")},{code:53,name:"dns",size:dt,resolvable:!0},{code:54,name:"dns4",size:dt,resolvable:!0},{code:55,name:"dns6",size:dt,resolvable:!0},{code:56,name:"dnsaddr",size:dt,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:sr,bytesToValue:fn,validate:po},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:dt,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:dt,bytesToValue:pl("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?ml("base58btc")(r):tt.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:gl,valueToBytes:sh},{code:445,name:"onion3",size:296,bytesToValue:gl,valueToBytes:ih},{code:446,name:"garlic64",size:dt},{code:447,name:"garlic32",size:dt},{code:448,name:"tls"},{code:449,name:"sni",size:dt},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:dt,bytesToValue:dh(Za),valueToBytes:fh},{code:480,name:"http"},{code:481,name:"http-path",size:dt,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:dt}];ry.forEach(r=>{Mt.addProtocol(r)});function hh(r){let t=[],e=0;for(;e<r.length;){let n=er(r,e),o=Mt.getProtocol(n),s=ft(n),i=ny(o,r,e+s),a=0;i>0&&o.size===dt&&(a=ft(i));let c=s+a+i,u={code:n,name:o.name,bytes:r.subarray(e,e+c)};if(i>0){let l=e+s+a,f=r.subarray(l,l+i);u.value=o.bytesToValue?.(f)??N(f)}t.push(u),e+=c}return t}function ph(r){let t=0,e=[];for(let n of r){if(n.bytes==null){let o=Mt.getProtocol(n.code),s=ft(n.code),i,a=0,c=0;n.value!=null&&(i=o.valueToBytes?.(n.value)??D(n.value),a=i.byteLength,o.size===dt&&(c=ft(a)));let u=new Uint8Array(s+c+a),l=0;Yr(n.code,u,l),l+=s,i!=null&&(o.size===dt&&(Yr(a,u,l),l+=c),u.set(i,l)),n.bytes=u}e.push(n.bytes),t+=n.bytes.byteLength}return Xt(e,t)}function mh(r){if(r.charAt(0)!=="/")throw new pt('String multiaddr must start with "/"');let t=[],e="protocol",n="",o="";for(let s=1;s<r.length;s++){let i=r.charAt(s);i!=="/"&&(e==="protocol"?o+=r.charAt(s):n+=r.charAt(s));let a=s===r.length-1;if(i==="/"||a){let c=Mt.getProtocol(o);if(e==="protocol"){if(c.size==null||c.size===0){t.push({code:c.code,name:c.name}),n="",o="",e="protocol";continue}else if(a)throw new pt(`Component ${o} was missing value`);e="value"}else if(e==="value"){let u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new pt(`Component ${o} was missing value`);u.value=c.stringToValue?.(n)??n}t.push(u),n="",o="",e="protocol"}}}if(o!==""&&n!=="")throw new pt("Incomplete multiaddr");return t}function gh(r){return`/${r.flatMap(t=>{if(t.value==null)return t.name;let e=Mt.getProtocol(t.code);if(e==null)throw new pt(`Unknown protocol code ${t.code}`);return[t.name,e.valueToString?.(t.value)??t.value]}).join("/")}`}function ny(r,t,e){return r.size==null||r.size===0?0:r.size>0?r.size/8:er(t,e)}var oy=Symbol.for("nodejs.util.inspect.custom"),Tl=Symbol.for("@multiformats/multiaddr"),sy=[53,54,55,56],Il=class extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}};function iy(r){if(r==null&&(r="/"),Ke(r))return r.getComponents();if(r instanceof Uint8Array)return hh(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),mh(r);if(Array.isArray(r))return r;throw new pt("Must be a string, Uint8Array, Component[], or another Multiaddr")}var Ks=class r{[Tl]=!0;#t;#n;#e;constructor(t="/",e={}){this.#t=iy(t),e.validate!==!1&&ay(this)}get bytes(){return this.#e==null&&(this.#e=ph(this.#t)),this.#e}toString(){return this.#n==null&&(this.#n=gh(this.#t)),this.#n}toJSON(){return this.toString()}toOptions(){let t,e,n,o,s="";for(let{code:a,name:c,value:u}of this.#t)a===42&&(s=`%${u??""}`),sy.includes(a)&&(e="tcp",o=443,n=`${u??""}${s}`,t=a===55?6:4),(a===6||a===273)&&(e=c==="tcp"?"tcp":"udp",o=parseInt(u??"")),(a===4||a===41)&&(e="tcp",n=`${u??""}${s}`,t=a===41?6:4);if(t==null||e==null||n==null||o==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:o}}getComponents(){return[...this.#t]}protos(){return this.#t.map(({code:t,value:e})=>{let n=Mt.getProtocol(t);return{code:t,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#t.map(({code:t})=>t)}protoNames(){return this.#t.map(({name:t})=>t)}tuples(){return this.#t.map(({code:t,value:e})=>{if(e==null)return[t];let n=Mt.getProtocol(t),o=[t];return e!=null&&o.push(n.valueToBytes?.(e)??D(e)),o})}stringTuples(){return this.#t.map(({code:t,value:e})=>e==null?[t]:[t,e])}encapsulate(t){let e=new r(t);return new r([...this.#t,...e.getComponents()],{validate:!1})}decapsulate(t){let e=t.toString(),n=this.toString(),o=n.lastIndexOf(e);if(o<0)throw new ho(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new r(n.slice(0,o),{validate:!1})}decapsulateCode(t){let e;for(let n=this.#t.length-1;n>-1;n--)if(this.#t[n].code===t){e=n;break}return new r(this.#t.slice(0,e),{validate:!1})}getPeerId(){try{let t=[];this.#t.forEach(({code:n,value:o})=>{n===421&&t.push([n,o]),n===290&&(t=[])});let e=t.pop();if(e?.[1]!=null){let n=e[1];return n[0]==="Q"||n[0]==="1"?N(j.decode(`z${n}`),"base58btc"):N(tt.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(let t of this.#t)if(Mt.getProtocol(t.code).path)return t.value??null;return null}equals(t){return G(this.bytes,t.bytes)}async resolve(t){let e=this.protos().find(s=>s.resolvable);if(e==null)return[this];let n=yh.get(e.name);if(n==null)throw new Il(`no available resolver for ${e.name}`);return(await n(this,t)).map(s=>K(s))}nodeAddress(){let t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(){return!(this.#t.length!==2||this.#t[0].code!==4&&this.#t[0].code!==41||this.#t[1].code!==6&&this.#t[1].code!==273)}[oy](){return`Multiaddr(${this.toString()})`}};function ay(r){r.getComponents().forEach(t=>{let e=Mt.getProtocol(t.code);t.value!=null&&e.validate?.(t.value)})}function bh(r,t,e){let n=0;for(let o of r)if(!(n<t)){if(n>e)break;if(o!==255)return!1;n++}return!0}function wh(r,t,e,n){let o=0;for(let s of r)if(!(o<e)){if(o>n)break;if(s!==t[o])return!1;o++}return!0}function Pl(r){switch(r.length){case ur:return r.join(".");case fr:{let t=[];for(let e=0;e<r.length;e++)e%2===0&&t.push(r[e].toString(16).padStart(2,"0")+r[e+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw new Error("Invalid ip length")}}function xh(r){let t=0;for(let[e,n]of r.entries()){if(n===255){t+=8;continue}for(;(n&128)!=0;)t++,n=n<<1;if((n&128)!=0)return-1;for(let o=e+1;o<r.length;o++)if(r[o]!=0)return-1;break}return t}function Eh(r){let t="0x";for(let e of r)t+=(e>>4).toString(16)+(e&15).toString(16);return t}var ur=4,fr=16,pS=parseInt("0xFFFF",16),cy=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function go(r,t){t.length===fr&&r.length===ur&&bh(t,0,11)&&(t=t.slice(12)),t.length===ur&&r.length===fr&&wh(r,cy,0,11)&&(r=r.slice(12));let e=r.length;if(e!=t.length)throw new Error("Failed to mask ip");let n=new Uint8Array(e);for(let o=0;o<e;o++)n[o]=r[o]&t[o];return n}function vh(r,t){if(typeof t=="string"&&(t=un(t)),t==null)throw new Error("Invalid ip");if(t.length!==r.network.length)return!1;for(let e=0;e<t.length;e++)if((r.network[e]&r.mask[e])!==(t[e]&r.mask[e]))return!1;return!0}function Dl(r){let[t,e]=r.split("/");if(!t||!e)throw new Error("Failed to parse given CIDR: "+r);let n=ur,o=ks(t);if(o==null&&(n=fr,o=Ms(t),o==null))throw new Error("Failed to parse given CIDR: "+r);let s=parseInt(e,10);if(Number.isNaN(s)||String(s).length!==e.length||s<0||s>n*8)throw new Error("Failed to parse given CIDR: "+r);let i=Ll(s,8*n);return{network:go(o,i),mask:i}}function Ll(r,t){if(t!==8*ur&&t!==8*fr)throw new Error("Invalid CIDR mask");if(r<0||r>t)throw new Error("Invalid CIDR mask");let e=t/8,n=new Uint8Array(e);for(let o=0;o<e;o++){if(r>=8){n[o]=255,r-=8;continue}n[o]=255-(255>>r),r=0}return n}var gn=class{constructor(t,e){if(e==null)({network:this.network,mask:this.mask}=Dl(t));else{let n=un(t);if(n==null)throw new Error("Failed to parse network");e=String(e);let o=parseInt(e,10);if(Number.isNaN(o)||String(o).length!==e.length||o<0||o>n.length*8){let s=un(e);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=Ll(o,8*n.length);this.network=go(n,this.mask)}}contains(t){return vh({network:this.network,mask:this.mask},t)}toString(){let t=xh(this.mask),e=t!==-1?String(t):Eh(this.mask);return Pl(this.network)+"/"+e}};function Rl(r){let t,e;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(e=n.value),n.name==="ipcidr"&&(t=n.value)}),t==null||e==null)throw new Error("Invalid multiaddr");return new gn(e,t)}var yh=new Map;function Ke(r){return!!r?.[Tl]}function K(r){return new Ks(r)}function qs(r){let t=Mt.getProtocol(r);return{code:t.code,size:t.size??0,name:t.name,resolvable:!!t.resolvable,path:!!t.path}}var Ol=class{dns;canResolve(t){return t.getComponents().some(({name:e})=>e==="dnsaddr")}async resolve(t,e){let n=t.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[t];let s=await this.getDNS(e).query(`_dnsaddr.${n}`,{signal:e?.signal,types:[Kt.TXT]}),i=t.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(let c of s.Answer){let u=c.data.replace(/["']/g,"").trim().split("=")[1];u!=null&&(i!=null&&!u.includes(i)||a.push(K(u)))}return a}getDNS(t){return t.dns!=null?t.dns:(this.dns==null&&(this.dns=nh()),this.dns)}},Se=new Ol;var ly={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Se}},transportManager:{faultTolerance:He.FATAL_ALL}};async function _h(r){let t=Is(ly,r);if(t.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new k("Private network is enforced, but no protector was provided");return t}function uy(r,t){try{if(typeof r=="string"&&r.length>0)return fy(r);if(typeof r=="number"&&isFinite(r))return t?.long?hy(r):dy(r);throw new Error("Value is not a string or number.")}catch(e){let n=py(e)?`${e.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function fy(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");let t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!t)return NaN;let e=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return e*315576e5;case"weeks":case"week":case"w":return e*6048e5;case"days":case"day":case"d":return e*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return e*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return e*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return e*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}var Vs=uy;function dy(r){let t=Math.abs(r);return t>=864e5?`${Math.round(r/864e5)}d`:t>=36e5?`${Math.round(r/36e5)}h`:t>=6e4?`${Math.round(r/6e4)}m`:t>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function hy(r){let t=Math.abs(r);return t>=864e5?zs(r,t,864e5,"day"):t>=36e5?zs(r,t,36e5,"hour"):t>=6e4?zs(r,t,6e4,"minute"):t>=1e3?zs(r,t,1e3,"second"):`${r} ms`}function zs(r,t,e,n){let o=t>=e*1.5;return`${Math.round(r/e)} ${n}${o?"s":""}`}function py(r){return typeof r=="object"&&r!==null&&"message"in r}function kl(r){e.debug=e,e.default=e,e.coerce=c,e.disable=s,e.enable=o,e.enabled=i,e.humanize=Vs,e.destroy=u,Object.keys(r).forEach(l=>{e[l]=r[l]}),e.names=[],e.skips=[],e.formatters={};function t(l){let f=0;for(let d=0;d<l.length;d++)f=(f<<5)-f+l.charCodeAt(d),f|=0;return e.colors[Math.abs(f)%e.colors.length]}e.selectColor=t;function e(l){let f,d=null,h,p;function g(...m){if(!g.enabled)return;let w=g,E=Number(new Date),_=E-(f||E);w.diff=_,w.prev=f,w.curr=E,f=E,m[0]=e.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let C=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(L,R)=>{if(L==="%%")return"%";C++;let I=e.formatters[R];if(typeof I=="function"){let y=m[C];L=I.call(w,y),m.splice(C,1),C--}return L}),e.formatArgs.call(w,m),(w.log||e.log).apply(w,m)}return g.namespace=l,g.useColors=e.useColors(),g.color=e.selectColor(l),g.extend=n,g.destroy=e.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(h!==e.namespaces&&(h=e.namespaces,p=e.enabled(l)),p),set:m=>{d=m}}),typeof e.init=="function"&&e.init(g),g}function n(l,f){let d=e(this.namespace+(typeof f>"u"?":":f)+l);return d.log=this.log,d}function o(l){e.save(l),e.namespaces=l,e.names=[],e.skips=[];let f,d=(typeof l=="string"?l:"").split(/[\s,]+/),h=d.length;for(f=0;f<h;f++)d[f]&&(l=d[f].replace(/\*/g,".*?"),l[0]==="-"?e.skips.push(new RegExp("^"+l.substr(1)+"$")):e.names.push(new RegExp("^"+l+"$")))}function s(){let l=[...e.names.map(a),...e.skips.map(a).map(f=>"-"+f)].join(",");return e.enable(""),l}function i(l){if(l[l.length-1]==="*")return!0;let f,d;for(f=0,d=e.skips.length;f<d;f++)if(e.skips[f].test(l))return!1;for(f=0,d=e.names.length;f<d;f++)if(e.names[f].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack??l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.setupFormatters(e.formatters),e.enable(e.load()),e}var Hs=Ey(),my=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function gy(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function yy(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Vs(this.diff),!this.useColors)return;let t="color: "+this.color;r.splice(1,0,t,"color: inherit");let e=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(e++,o==="%c"&&(n=e))}),r.splice(n,0,t)}var by=console.debug??console.log??(()=>{});function wy(r){try{r?Hs?.setItem("debug",r):Hs?.removeItem("debug")}catch{}}function xy(){let r;try{r=Hs?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function Ey(){try{return localStorage}catch{}}function vy(r){r.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}var Sh=kl({formatArgs:yy,save:wy,load:xy,useColors:gy,setupFormatters:vy,colors:my,storage:Hs,log:by});var Nt=Sh;Nt.formatters.b=r=>r==null?"undefined":j.baseEncode(r);Nt.formatters.t=r=>r==null?"undefined":zt.baseEncode(r);Nt.formatters.m=r=>r==null?"undefined":ja.baseEncode(r);Nt.formatters.p=r=>r==null?"undefined":r.toString();Nt.formatters.c=r=>r==null?"undefined":r.toString();Nt.formatters.k=r=>r==null?"undefined":r.toString();Nt.formatters.a=r=>r==null?"undefined":r.toString();Nt.formatters.e=r=>r==null?"undefined":Ah(r.stack)??Ah(r.message)??r.toString();function _y(r){let t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=r,t.destroy=()=>!0,t.extend=()=>t,t}function $s(){return{forComponent(r){return Sy(r)}}}function Sy(r){let t=_y(`${r}:trace`);return Nt.enabled(`${r}:trace`)&&Nt.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=Nt(`${r}:trace`)),Object.assign(Nt(r),{error:Nt(`${r}:error`),trace:t})}function Ah(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function dr(r,t){let e={[Symbol.iterator]:()=>e,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:t(o)}}};return e}function Ws(r){let t=ge(j.decode(`z${r}`));return on(t)}var $t=class{map;constructor(t){if(this.map=new Map,t!=null)for(let[e,n]of t.entries())this.map.set(e.toString(),{key:e,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return dr(this.map.entries(),t=>[t[1].key,t[1].value])}forEach(t){this.map.forEach((e,n)=>{t(e.value,e.key,this)})}get(t){return this.map.get(t.toString())?.value}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),{key:t,value:e})}keys(){return dr(this.map.values(),t=>t.key)}values(){return dr(this.map.values(),t=>t.value)}get size(){return this.map.size}};var hr=class r{set;constructor(t){if(this.set=new Set,t!=null)for(let e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return dr(this.set.entries(),t=>{let e=Ws(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{let n=Ws(e);t(n,n,this)})}has(t){return this.set.has(t.toString())}values(){return dr(this.set.values(),t=>Ws(t))}intersection(t){let e=new r;for(let n of t)this.has(n)&&e.add(n);return e}difference(t){let e=new r;for(let n of this)t.has(n)||e.add(n);return e}union(t){let e=new r;for(let n of t)e.add(n);for(let n of this)e.add(n);return e}};var Ml={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Ch={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Ih=new globalThis.TextEncoder;function Ay(r,t){let e=Ml[t],n=Ch[t];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(t,n*e);return n}function Cy(r,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=Ml[t],o=Ch[t],s=r;for(;s.length>0;){let i=Ih.encodeInto(s,e);s=s.slice(i.read);for(let a=0;a<i.written;a++)o^=BigInt(e[a]),o=BigInt.asUintN(t,o*n)}return o}function Nl(r,{size:t=32,utf8Buffer:e}={}){if(!Ml[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(e)return Cy(r,t,e);r=Ih.encode(r)}return Ay(r,t)}var yo={hash:r=>Number(Nl(r,{size:32})),hashV:(r,t)=>Iy(yo.hash(r,t))};function Iy(r){let t=r.toString(16);return t.length%2===1&&(t=`0${t}`),D(t,"base16")}var Bl=64,oe=class{fp;h;seed;constructor(t,e,n,o=2){if(o>Bl)throw new TypeError("Invalid Fingerprint Size");let s=e.hashV(t,n),i=nt(o);for(let a=0;a<i.length;a++)i[a]=s[a];i.length===0&&(i[0]=7),this.fp=i,this.h=e,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return t?.fp instanceof Uint8Array?G(this.fp,t.fp):!1}};function pr(r,t){return Math.floor(Math.random()*(t-r))+r}var mr=class{contents;constructor(t){this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");let e=pr(0,this.contents.length-1),n=this.contents[e];return this.contents[e]=t,n}remove(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");let e=this.contents.findIndex(n=>t.equals(n));return e>-1?(this.contents[e]=null,!0):!1}};var Ty=500,bo=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(t){this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??yo,this.seed=t.seed??pr(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=D(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=(n^e.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new mr(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new mr(this.bucketSize)),this.buckets[n].add(e)||this.buckets[o].add(e))return this.count++,!0;let s=[n,o],i=s[pr(0,s.length-1)];this.buckets[i]==null&&(this.buckets[i]=new mr(this.bucketSize));for(let a=0;a<Ty;a++){let c=this.buckets[i].swap(e);if(c!=null&&(i=(i^c.hash())%this.filterSize,this.buckets[i]==null&&(this.buckets[i]=new mr(this.bucketSize)),this.buckets[i].add(c)))return this.count++,!0}return!1}has(t){typeof t=="string"&&(t=D(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=this.buckets[n]?.has(e)??!1;if(o)return o;let s=(n^e.hash())%this.filterSize;return this.buckets[s]?.has(e)??!1}remove(t){typeof t=="string"&&(t=D(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=this.buckets[n]?.remove(e)??!1;if(o)return this.count--,o;let s=(n^e.hash())%this.filterSize,i=this.buckets[s]?.remove(e)??!1;return i&&this.count--,i}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},Py={1:.5,2:.84,4:.95,8:.98};function Dy(r=.001){return r>.002?2:r>1e-5?4:8}function Th(r,t=.001){let e=Dy(t),n=Py[e],o=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*e)),Bl);return{filterSize:o,bucketSize:e,fingerprintSize:s}}var Gs=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(t){this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??yo,this.seed=t.seed??pr(0,Math.pow(2,10)),this.filterSeries=[new bo({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=D(t)),this.has(t))return!0;let e=this.filterSeries.find(n=>n.reliable);if(e==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new bo({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=D(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=D(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}};function wo(r,t=.001,e){return new Gs({...Th(r,t),...e??{}})}var Fl=class extends $t{metric;constructor(t){super();let{name:e,metrics:n}=t;this.metric=n.registerMetric(e),this.updateComponentMetric()}set(t,e){return super.set(t,e),this.updateComponentMetric(),this}delete(t){let e=super.delete(t);return this.updateComponentMetric(),e}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Ul(r){let{name:t,metrics:e}=r,n;return e!=null?n=new Fl({name:t,metrics:e}):n=new $t,n}var xo;(function(r){let t;r.codec=()=>(t==null&&(t=Lt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(n.uint32(10),n.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(n.uint32(18),n.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(n.uint32(26),n.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(n.uint32(42),n.bytes(e.signature)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={publicKey:nt(0),payloadType:nt(0),payload:nt(0),signature:nt(0)},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.publicKey=e.bytes();break}case 2:{s.payloadType=e.bytes();break}case 3:{s.payload=e.bytes();break}case 5:{s.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Dt(e,r.codec()),r.decode=(e,n)=>Pt(e,r.codec(),n)})(xo||(xo={}));var js=class extends Error{constructor(t="Invalid signature"){super(t),this.name="InvalidSignatureError"}};var yn=class r{static createFromProtobuf=t=>{let e=xo.decode(t),n=nn(e.publicKey);return new r({publicKey:n,payloadType:e.payloadType,payload:e.payload,signature:e.signature})};static seal=async(t,e,n)=>{if(e==null)throw new Error("Missing private key");let o=t.domain,s=t.codec,i=t.marshal(),a=Ph(o,s,i),c=await e.sign(a.subarray(),n);return new r({publicKey:e.publicKey,payloadType:s,payload:i,signature:c})};static openAndCertify=async(t,e,n)=>{let o=r.createFromProtobuf(t);if(!await o.validate(e,n))throw new js("Envelope signature is not valid for the given domain");return o};publicKey;payloadType;payload;signature;marshaled;constructor(t){let{publicKey:e,payloadType:n,payload:o,signature:s}=t;this.publicKey=e,this.payloadType=n,this.payload=o,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=xo.encode({publicKey:Vt(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return t==null?!1:G(this.marshal(),t.marshal())}async validate(t,e){let n=Ph(t,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,e)}},Ph=(r,t,e)=>{let n=D(r),o=le(n.byteLength),s=le(t.length),i=le(e.length);return new z(o,n,s,t,i,e)};function Dh(r,t){let e=(n,o)=>n.toString().localeCompare(o.toString());return r.length!==t.length?!1:(t.sort(e),r.sort(e).every((n,o)=>t[o].equals(n)))}var Lh="libp2p-peer-record",Rh=Uint8Array.from([3,1]);var Eo;(function(r){let t;(function(n){let o;n.codec=()=>(o==null&&(o=Lt((s,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(s,i,a={})=>{let c={multiaddr:nt(0)},u=i==null?s.len:s.pos+i;for(;s.pos<u;){let l=s.uint32();switch(l>>>3){case 1:{c.multiaddr=s.bytes();break}default:{s.skipType(l&7);break}}}return c})),o),n.encode=s=>Dt(s,n.codec()),n.decode=(s,i)=>Pt(s,n.codec(),i)})(t=r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Lt((n,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(o.uint32(10),o.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(o.uint32(16),o.uint64(n.seq)),n.addresses!=null)for(let i of n.addresses)o.uint32(26),r.AddressInfo.codec().encode(i,o);s.lengthDelimited!==!1&&o.ldelim()},(n,o,s={})=>{let i={peerId:nt(0),seq:0n,addresses:[]},a=o==null?n.len:n.pos+o;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{i.peerId=n.bytes();break}case 2:{i.seq=n.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new or('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:s.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return i})),e),r.encode=n=>Dt(n,r.codec()),r.decode=(n,o)=>Pt(n,r.codec(),o)})(Eo||(Eo={}));var gr=class r{static createFromProtobuf=t=>{let e=Eo.decode(t),n=on(ge(e.peerId)),o=(e.addresses??[]).map(i=>K(i.multiaddr)),s=e.seq;return new r({peerId:n,multiaddrs:o,seqNumber:s})};static DOMAIN=Lh;static CODEC=Rh;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(t){let{peerId:e,multiaddrs:n,seqNumber:o}=t;this.peerId=e,this.multiaddrs=n??[],this.seqNumber=o??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Eo.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof r)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!Dh(this.multiaddrs,t.multiaddrs))}};function Ly(r){return r[Symbol.asyncIterator]!=null}function Ry(r){if(Ly(r))return(async()=>{let e=[];for await(let n of r)e.push(n);return e})();let t=[];for(let e of r)t.push(e);return t}var vo=Ry;var se=class extends Error{static name="AbortError";name="AbortError";constructor(t="The operation was aborted",...e){super(t,...e)}};function ot(){let r={};return r.promise=new Promise((t,e)=>{r.resolve=t,r.reject=e}),r}var Zs=class{buffer;mask;top;btm;next;constructor(t){if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){let t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}},bn=class{size;hwm;head;tail;constructor(t={}){this.hwm=t.splitLimit??16,this.head=new Zs(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){let e=this.head;this.head=e.next=new Zs(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){let e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}};var Kl=class extends Error{type;code;constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}};function Xs(r={}){return Oy(e=>{let n=e.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Oy(r,t){t=t??{};let e=t.onEnd,n=new bn,o,s,i,a=ot(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((m,w)=>{s=E=>{s=null,n.push(E);try{m(r(n))}catch(_){w(_)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ot()})}},u=m=>s!=null?s(m):(n.push(m),o),l=m=>(n=new bn,s!=null?s({error:m}):(n.push({error:m}),o)),f=m=>{if(i)return o;if(t?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:m})},d=m=>i?o:(i=!0,m!=null?l(m):u({done:!0})),h=()=>(n=new bn,d(),{done:!0}),p=m=>(d(m),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:h,throw:p,push:f,end:d,get readableLength(){return n.size},onEmpty:async m=>{let w=m?.signal;if(w?.throwIfAborted(),n.isEmpty())return;let E,_;w!=null&&(E=new Promise((C,b)=>{_=()=>{b(new Kl)},w.addEventListener("abort",_)}));try{await Promise.race([a.promise,E])}finally{_!=null&&w!=null&&w?.removeEventListener("abort",_)}}},e==null)return o;let g=o;return o={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(m){return g.throw(m),e!=null&&(e(m),e=void 0),{done:!0}},return(){return g.return(),e!=null&&(e(),e=void 0),{done:!0}},push:f,end(m){return g.end(m),e!=null&&(e(m),e=void 0),o},get readableLength(){return g.readableLength},onEmpty:m=>g.onEmpty(m)},o}var ql=class extends Error{type;code;constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=e??"ABORT_ERR"}};async function he(r,t,e,n){let o=new ql(n?.errorMessage,n?.errorCode);return e?.aborted===!0?Promise.reject(o):new Promise((s,i)=>{function a(){e?.removeEventListener("abort",l),r.removeEventListener(t,c),n?.errorEvent!=null&&r.removeEventListener(n.errorEvent,u)}let c=f=>{try{if(n?.filter?.(f)===!1)return}catch(d){a(),i(d);return}a(),s(f)},u=f=>{a(),i(f.detail)},l=()=>{a(),i(o)};e?.addEventListener("abort",l),r.addEventListener(t,c),n?.errorEvent!=null&&r.addEventListener(n.errorEvent,u)})}var Qs=class extends Error{static name="QueueFullError";constructor(t="The queue was full"){super(t),this.name="QueueFullError"}};var Ys=class extends Error{type;code;constructor(t,e,n){super(t??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=e??"ABORT_ERR"}};async function mt(r,t,e){if(t==null)return r;if(t.aborted)return r.catch(()=>{}),Promise.reject(new Ys(e?.errorMessage,e?.errorCode,e?.errorName));let n,o=new Ys(e?.errorMessage,e?.errorCode,e?.errorName);try{return await Promise.race([r,new Promise((s,i)=>{n=()=>{i(o)},t.addEventListener("abort",n)})])}finally{n!=null&&t.removeEventListener("abort",n)}}var Js=class{deferred;signal;constructor(t){this.signal=t,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new se)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function ky(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var ti=class{id;fn;options;recipients;status;timeline;controller;constructor(t,e){this.id=ky(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,n)=>e&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new se),this.cleanup())}async join(t={}){let e=new Js(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let t=await mt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}};function zl(r,t){let e,n=function(){let o=function(){e=void 0,r()};clearTimeout(e),e=setTimeout(o,t)};return n.start=()=>{},n.stop=()=>{clearTimeout(e)},n}var _o=class extends Bt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(t={}){super(),this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=t.autoStart??!0,this.sort=t.sort,this.queue=[],this.emitEmpty=zl(this.emitEmpty.bind(this),1),this.emitIdle=zl(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let e of this.queue)if(e.status==="queued"){t=e;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let e=0;e<this.queue.length;e++)if(this.queue[e]===t){this.queue.splice(e,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(t,e){if(e?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Qs;let n=new ti(t,e);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(e).then(o=>(this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new se)}),this.clear()}async onEmpty(t){this.size!==0&&await he(this,"empty",t?.signal)}async onSizeLessThan(t,e){this.size<t||await he(this,"next",e?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await he(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let e=Xs({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),e.end(c)},o=c=>{c.detail!=null&&e.push(c.detail.result)},s=c=>{n(c.detail.error)},i=()=>{n()},a=()=>{n(new se("Queue aborted"))};this.addEventListener("success",o),this.addEventListener("failure",s),this.addEventListener("idle",i),t?.signal?.addEventListener("abort",a);try{yield*e}finally{this.removeEventListener("success",o),this.removeEventListener("failure",s),this.removeEventListener("idle",i),t?.signal?.removeEventListener("abort",a),n()}}};var ei="lock:worker:request-read",ri="lock:worker:abort-read-request",ni="lock:worker:release-read",oi="lock:master:grant-read",si="lock:master:error-read",ii="lock:worker:request-write",ai="lock:worker:abort-write-request",ci="lock:worker:release-write",li="lock:master:grant-write",ui="lock:master:error-write",fi="lock:worker:finalize",di="mortice",Oh={singleProcess:!1};var Vl=(r,t,e,n,o,s,i,a,c)=>u=>{if(u.data==null)return;let l={type:u.data.type,name:u.data.name,identifier:u.data.identifier};l.type===o&&r.safeDispatchEvent(e,{detail:{name:l.name,identifier:l.identifier,handler:async()=>{t.postMessage({type:c,name:l.name,identifier:l.identifier}),await new Promise(f=>{let d=h=>{if(h?.data==null)return;let p={type:h.data.type,name:h.data.name,identifier:h.data.identifier};p.type===a&&p.identifier===l.identifier&&(t.removeEventListener("message",d),f())};t.addEventListener("message",d)})},onError:f=>{t.postMessage({type:i,name:l.name,identifier:l.identifier,error:{message:f.message,name:f.name,stack:f.stack}})}}}),l.type===s&&r.safeDispatchEvent(n,{detail:{name:l.name,identifier:l.identifier}}),l.type===fi&&r.safeDispatchEvent("finalizeRequest",{detail:{name:l.name}})};var kh=(r=10)=>Math.random().toString().substring(2,r+2);var hi=class{name;channel;constructor(t){this.name=t,this.channel=new BroadcastChannel(di)}readLock(t){return this.sendRequest(ei,ri,oi,si,ni,t)}writeLock(t){return this.sendRequest(ii,ai,li,ui,ci,t)}finalize(){this.channel.postMessage({type:fi,name:this.name}),this.channel.close()}async sendRequest(t,e,n,o,s,i){i?.signal?.throwIfAborted();let a=kh();return this.channel.postMessage({type:t,identifier:a,name:this.name}),new Promise((c,u)=>{let l=()=>{this.channel.postMessage({type:e,identifier:a,name:this.name})};i?.signal?.addEventListener("abort",l,{once:!0});let f=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",f),i?.signal?.removeEventListener("abort",l),c(()=>{this.channel.postMessage({type:s,identifier:a,name:this.name})})),d.data.type===o)){this.channel.removeEventListener("message",f),i?.signal?.removeEventListener("abort",l);let h=new Error;d.data.error!=null&&(h.message=d.data.error.message,h.name=d.data.error.name,h.stack=d.data.error.stack),u(h)}};this.channel.addEventListener("message",f)})}};var Mh=r=>{if(r=Object.assign({},Oh,r),!!globalThis.document||r.singleProcess){let e=new BroadcastChannel(di),n=new Bt;return e.addEventListener("message",Vl(n,e,"requestReadLock","abortReadLockRequest",ei,ri,si,ni,oi)),e.addEventListener("message",Vl(n,e,"requestWriteLock","abortWriteLockRequest",ii,ai,ui,ci,li)),n}return new hi(r.name)};var yr=new Map,So;function Nh(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function My(r){if(So==null&&(So=Mh(r),!Nh(So))){let t=So;t.addEventListener("requestReadLock",e=>{let n=e.detail.name,o=e.detail.identifier,s=yr.get(n);if(s==null)return;let i=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||i.abort()};t.addEventListener("abortReadLockRequest",a),s.readLock({signal:i.signal}).then(async c=>{await e.detail.handler().finally(()=>{c()})}).catch(c=>{e.detail.onError(c)}).finally(()=>{t.removeEventListener("abortReadLockRequest",a)})}),t.addEventListener("requestWriteLock",e=>{let n=e.detail.name,o=e.detail.identifier,s=yr.get(n);if(s==null)return;let i=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||i.abort()};t.addEventListener("abortWriteLockRequest",a),s.writeLock({signal:i.signal}).then(async c=>{await e.detail.handler().finally(()=>{c()})}).catch(c=>{e.detail.onError(c)}).finally(()=>{t.removeEventListener("abortWriteLockRequest",a)})}),t.addEventListener("finalizeRequest",e=>{let n=e.detail.name,o=yr.get(n);o?.finalize()})}return So}async function Hl(r,t){let e,n,o=new Promise((i,a)=>{e=i,n=a}),s=()=>{n(new se)};return t?.signal?.addEventListener("abort",s,{once:!0}),r.add(async()=>{await new Promise(i=>{e(()=>{t?.signal?.removeEventListener("abort",s),i()})})},{signal:t?.signal}).catch(i=>{n(i)}),o}var Bh=(r,t)=>{let e=yr.get(r);if(e!=null)return e;let n=My(t);if(Nh(n))return e=n,yr.set(r,e),e;let o=new _o({concurrency:1}),s;return e={async readLock(i){if(s!=null)return Hl(s,i);s=new _o({concurrency:t.concurrency,autoStart:!1});let a=s,c=Hl(s,i);return o.add(async()=>{a.start(),await a.onIdle().then(()=>{s===a&&(s=null)})}),c},async writeLock(i){return s=null,Hl(o,i)},finalize:()=>{yr.delete(r)},queue:o},yr.set(r,e),t.autoFinalize===!0&&o.addEventListener("idle",()=>{e.finalize()},{once:!0}),e};var Ny={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function $l(r){let t=Object.assign({},Ny,r);return Bh(t.name,t)}var Ae;(function(r){let t;(function(o){let s;o.codec=()=>(s==null&&(s=Lt((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&i.value.byteLength>0&&(a.uint32(18),a.bytes(i.value)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let u={key:"",value:nt(0)},l=a==null?i.len:i.pos+a;for(;i.pos<l;){let f=i.uint32();switch(f>>>3){case 1:{u.key=i.string();break}case 2:{u.value=i.bytes();break}default:{i.skipType(f&7);break}}}return u})),s),o.encode=i=>Dt(i,o.codec()),o.decode=(i,a)=>Pt(i,o.codec(),a)})(t=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let e;(function(o){let s;o.codec=()=>(s==null&&(s=Lt((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&(a.uint32(18),mi.codec().encode(i.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let u={key:""},l=a==null?i.len:i.pos+a;for(;i.pos<l;){let f=i.uint32();switch(f>>>3){case 1:{u.key=i.string();break}case 2:{u.value=mi.codec().decode(i,i.uint32(),{limits:c.limits?.value});break}default:{i.skipType(f&7);break}}}return u})),s),o.encode=i=>Dt(i,o.codec()),o.decode=(i,a)=>Pt(i,o.codec(),a)})(e=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Lt((o,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),o.addresses!=null)for(let a of o.addresses)s.uint32(10),pi.codec().encode(a,s);if(o.protocols!=null)for(let a of o.protocols)s.uint32(18),s.string(a);if(o.publicKey!=null&&(s.uint32(34),s.bytes(o.publicKey)),o.peerRecordEnvelope!=null&&(s.uint32(42),s.bytes(o.peerRecordEnvelope)),o.metadata!=null&&o.metadata.size!==0)for(let[a,c]of o.metadata.entries())s.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},s);if(o.tags!=null&&o.tags.size!==0)for(let[a,c]of o.tags.entries())s.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},s);o.updated!=null&&(s.uint32(64),s.uint64Number(o.updated)),i.lengthDelimited!==!1&&s.ldelim()},(o,s,i={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=s==null?o.len:o.pos+s;for(;o.pos<c;){let u=o.uint32();switch(u>>>3){case 1:{if(i.limits?.addresses!=null&&a.addresses.length===i.limits.addresses)throw new or('Decode error - map field "addresses" had too many elements');a.addresses.push(pi.codec().decode(o,o.uint32(),{limits:i.limits?.addresses$}));break}case 2:{if(i.limits?.protocols!=null&&a.protocols.length===i.limits.protocols)throw new or('Decode error - map field "protocols" had too many elements');a.protocols.push(o.string());break}case 4:{a.publicKey=o.bytes();break}case 5:{a.peerRecordEnvelope=o.bytes();break}case 6:{if(i.limits?.metadata!=null&&a.metadata.size===i.limits.metadata)throw new Xn('Decode error - map field "metadata" had too many elements');let l=r.Peer$metadataEntry.codec().decode(o,o.uint32());a.metadata.set(l.key,l.value);break}case 7:{if(i.limits?.tags!=null&&a.tags.size===i.limits.tags)throw new Xn('Decode error - map field "tags" had too many elements');let l=r.Peer$tagsEntry.codec().decode(o,o.uint32(),{limits:{value:i.limits?.tags$value}});a.tags.set(l.key,l.value);break}case 8:{a.updated=o.uint64Number();break}default:{o.skipType(u&7);break}}}return a})),n),r.encode=o=>Dt(o,r.codec()),r.decode=(o,s)=>Pt(o,r.codec(),s)})(Ae||(Ae={}));var pi;(function(r){let t;r.codec=()=>(t==null&&(t=Lt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(e.multiaddr)),e.isCertified!=null&&(n.uint32(16),n.bool(e.isCertified)),e.observed!=null&&(n.uint32(24),n.uint64Number(e.observed)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={multiaddr:nt(0)},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.multiaddr=e.bytes();break}case 2:{s.isCertified=e.bool();break}case 3:{s.observed=e.uint64Number();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Dt(e,r.codec()),r.decode=(e,n)=>Pt(e,r.codec(),n)})(pi||(pi={}));var mi;(function(r){let t;r.codec=()=>(t==null&&(t=Lt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.value!=null&&e.value!==0&&(n.uint32(8),n.uint32(e.value)),e.expiry!=null&&(n.uint32(16),n.uint64(e.expiry)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={value:0},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.value=e.uint32();break}case 2:{s.expiry=e.uint64();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Dt(e,r.codec()),r.decode=(e,n)=>Pt(e,r.codec(),n)})(mi||(mi={}));function By(r,t){if(r.publicKey!=null||t.publicKey==null)return r;let e;r.type==="RSA"&&(e=r.toMultihash());let n=nn(t.publicKey,e);return nl(n)}function Fh(r,t,e){let n=Ae.decode(t);return wn(r,n,e)}function wn(r,t,e){let n=new Map,o=BigInt(Date.now());for(let[s,i]of t.tags.entries())i.expiry!=null&&i.expiry<o||n.set(s,i);return{...t,id:By(r,t),addresses:t.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-e).map(({multiaddr:s,isCertified:i})=>({multiaddr:K(s),isCertified:i??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}function Uh(r,t){return Fy(r.addresses,t.addresses)&&Uy(r.protocols,t.protocols)&&Ky(r.publicKey,t.publicKey)&&qy(r.peerRecordEnvelope,t.peerRecordEnvelope)&&zy(r.metadata,t.metadata)&&Vy(r.tags,t.tags)}function Fy(r,t){return qh(r,t,(e,n)=>!(e.isCertified!==n.isCertified||!G(e.multiaddr,n.multiaddr)))}function Uy(r,t){return qh(r,t,(e,n)=>e===n)}function Ky(r,t){return Kh(r,t)}function qy(r,t){return Kh(r,t)}function zy(r,t){return zh(r,t,(e,n)=>G(e,n))}function Vy(r,t){return zh(r,t,(e,n)=>e.value===n.value&&e.expiry===n.expiry)}function Kh(r,t){return r==null&&t==null?!0:r!=null&&t!=null?G(r,t):!1}function qh(r,t,e){if(r.length!==t.length)return!1;for(let n=0;n<r.length;n++)if(!e(r[n],t[n]))return!1;return!0}function zh(r,t,e){if(r.size!==t.size)return!1;for(let[n,o]of r.entries()){let s=t.get(n);if(s==null||!e(o,s))return!1}return!0}var Ce="/",Vh=new TextEncoder().encode(Ce),gi=Vh[0],br=class r{_buf;constructor(t,e){if(typeof t=="string")this._buf=D(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==gi)throw new Error("Invalid key")}toString(t="utf8"){return N(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new r(t.join(Ce))}static random(){return new r(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new r(t):typeof t.uint8Array=="function"?new r(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=Vh),this._buf[0]!==gi){let t=new Uint8Array(this._buf.byteLength+1);t.fill(gi,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===gi;)this._buf=this._buf.subarray(0,-1)}less(t){let e=this.list(),n=t.list();for(let o=0;o<e.length;o++){if(n.length<o+1)return!1;let s=e[o],i=n[o];if(s<i)return!0;if(s>i)return!1}return e.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(Ce).slice(1)}type(){return Hy(this.baseNamespace())}name(){return $y(this.baseNamespace())}instance(t){return new r(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(Ce)||(t+=Ce),t+=this.type(),new r(t)}parent(){let t=this.list();return t.length===1?new r(Ce):new r(t.slice(0,-1).join(Ce))}child(t){return this.toString()===Ce?t:t.toString()===Ce?this:new r(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return r.withNamespaces([...this.namespaces(),...Wy(t.map(e=>e.namespaces()))])}};function Hy(r){let t=r.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function $y(r){let t=r.split(":");return t[t.length-1]}function Wy(r){return[].concat(...r)}var Wl="/peers/";function Ao(r){if(!Te(r)||r.type==null)throw new k("Invalid PeerId");let t=r.toCID().toString();return new br(`${Wl}${t}`)}async function Hh(r,t,e,n,o){let s=new Map;for(let i of e){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=K(i.multiaddr)),!Ke(i.multiaddr))throw new k("Multiaddr was invalid");if(!await t(r,i.multiaddr,o))continue;let a=i.isCertified??!1,c=i.multiaddr.toString(),u=s.get(c);u!=null?i.isCertified=u.isCertified||a:s.set(c,{multiaddr:i.multiaddr,isCertified:a})}return[...s.values()].sort((i,a)=>i.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:i,multiaddr:a})=>{let c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(K(`/p2p/${r}`))),{isCertified:i,multiaddr:a.bytes}})}async function bi(r,t,e,n){if(t==null)throw new k("Invalid PeerData");if(t.publicKey!=null&&r.publicKey!=null&&!t.publicKey.equals(r.publicKey))throw new k("publicKey bytes do not match peer id publicKey bytes");let o=n.existingPeer?.peer;if(o!=null&&!r.equals(o.id))throw new k("peer id did not match existing peer id");let s=o?.addresses??[],i=new Set(o?.protocols??[]),a=o?.metadata??new Map,c=o?.tags??new Map,u=o?.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(s=[],t.multiaddrs!=null&&s.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&s.push(...t.addresses)),t.protocols!=null&&(i=new Set(t.protocols)),t.metadata!=null){let d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=yi(d,{validate:$h})}if(t.tags!=null){let d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);c=yi(d,{validate:Wh,map:Gh})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&s.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&s.push(...t.addresses),t.protocols!=null&&(i=new Set([...i,...t.protocols])),t.metadata!=null){let d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(let[h,p]of d)p==null?a.delete(h):a.set(h,p);a=yi([...a.entries()],{validate:$h})}if(t.tags!=null){let d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),h=new Map(c);for(let[p,g]of d)g==null?h.delete(p):h.set(p,g);c=yi([...h.entries()],{validate:Wh,map:Gh})}t.peerRecordEnvelope!=null&&(u=t.peerRecordEnvelope)}let l;o?.id.publicKey!=null?l=Vt(o.id.publicKey):t.publicKey!=null?l=Vt(t.publicKey):r.publicKey!=null&&(l=Vt(r.publicKey));let f={addresses:await Hh(r,n.addressFilter??(async()=>!0),s,n.existingPeer?.peerPB.addresses,n),protocols:[...i.values()].sort((d,h)=>d.localeCompare(h)),metadata:a,tags:c,publicKey:l,peerRecordEnvelope:u};return f.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(h=>G(h.multiaddr,h.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function yi(r,t){let e=new Map;for(let[n,o]of r)o!=null&&t.validate(n,o);for(let[n,o]of r.sort(([s],[i])=>s.localeCompare(i)))o!=null&&e.set(n,t.map?.(n,o)??o);return e}function $h(r,t){if(typeof r!="string")throw new k("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new k("Metadata value must be a Uint8Array")}function Wh(r,t){if(typeof r!="string")throw new k("Tag name must be a string");if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new k("Tag value must be an integer");if(t.value<0||t.value>100)throw new k("Tag value must be between 0-100")}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new k("Tag ttl must be an integer");if(t.ttl<0)throw new k("Tag ttl must be between greater than 0")}}function Gh(r,t){let e;t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl)));let n={value:t.value??0};return e!=null&&(n.expiry=e),n}function jh(r){let t=r.toString().split("/")[2],e=tt.parse(t,zt);return ao(e)}function Gl(r,t,e){let n=jh(r);return Fh(n,t,e)}function Gy(r,t){return{prefix:Wl,filters:(r.filters??[]).map(e=>({key:n,value:o})=>e(Gl(n,o,t))),orders:(r.orders??[]).map(e=>(n,o)=>e(Gl(n.key,n.value,t),Gl(o.key,o.value,t)))}}var wi=class{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-store"),this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.locks=Ul({name:"libp2p_peer_store_locks",metrics:t.metrics}),this.maxAddressAge=e.maxAddressAge??36e5,this.maxPeerAge=e.maxPeerAge??216e5}getLock(t){let e=this.locks.get(t);return e==null&&(e={refs:0,lock:$l({name:t.toString(),singleProcess:!0})},this.locks.set(t,e)),e.refs++,e}maybeRemoveLock(t,e){e.refs--,e.refs===0&&(e.lock.finalize(),this.locks.delete(t))}async getReadLock(t,e){let n=this.getLock(t);try{let o=await n.lock.readLock(e);return()=>{o(),this.maybeRemoveLock(t,n)}}catch(o){throw this.maybeRemoveLock(t,n),o}}async getWriteLock(t,e){let n=this.getLock(t);try{let o=await n.lock.writeLock(e);return()=>{o(),this.maybeRemoveLock(t,n)}}catch(o){throw this.maybeRemoveLock(t,n),o}}async has(t,e){try{return await this.load(t,e),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(t,e){this.peerId.equals(t)||await this.datastore.delete(Ao(t),e)}async load(t,e){let n=Ao(t),o=await this.datastore.get(n,e),s=Ae.decode(o);if(this.#e(t,s))throw await this.datastore.delete(n,e),new $e;return wn(t,s,this.peerId.equals(t)?1/0:this.maxAddressAge)}async save(t,e,n){let o=await this.#t(t,n),s=await bi(t,e,"patch",{...n,addressFilter:this.addressFilter});return this.#n(t,s,o)}async patch(t,e,n){let o=await this.#t(t,n),s=await bi(t,e,"patch",{...n,addressFilter:this.addressFilter,existingPeer:o});return this.#n(t,s,o)}async merge(t,e,n){let o=await this.#t(t,n),s=await bi(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:o});return this.#n(t,s,o)}async*all(t){for await(let{key:e,value:n}of this.datastore.query(Gy(t??{},this.maxAddressAge),t)){let o=jh(e);if(o.equals(this.peerId))continue;let s=Ae.decode(n);if(this.#e(o,s)){await this.datastore.delete(e,t);continue}yield wn(o,s,this.peerId.equals(o)?1/0:this.maxAddressAge)}}async#t(t,e){try{let n=Ao(t),o=await this.datastore.get(n,e),s=Ae.decode(o);if(this.#e(t,s))throw await this.datastore.delete(n,e),new $e;return{peerPB:s,peer:wn(t,s,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#n(t,e,n,o){e.updated=Date.now();let s=Ae.encode(e);return await this.datastore.put(Ao(t),s,o),{peer:wn(t,e,this.maxAddressAge),previous:n?.peer,updated:n==null||!Uh(e,n.peerPB)}}#e(t,e){if(e.updated==null)return!0;if(this.peerId.equals(t))return!1;let n=e.updated<Date.now()-this.maxPeerAge,o=Date.now()-this.maxAddressAge,s=e.addresses.filter(i=>i.observed!=null&&i.observed>o);return n&&s.length===0}};var jl=class{store;events;peerId;log;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new wi(t,e)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(t,e){for await(let n of this.store.all(e))t(n)}async all(t){return vo(this.store.all(t))}async delete(t,e){let n=await this.store.getReadLock(t,e);try{await this.store.delete(t,e)}finally{n()}}async has(t,e){let n=await this.store.getReadLock(t,e);try{return await this.store.has(t,e)}finally{this.log.trace("has release read lock"),n?.()}}async get(t,e){let n=await this.store.getReadLock(t,e);try{return await this.store.load(t,e)}finally{n?.()}}async getInfo(t,e){let n=await this.get(t,e);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:o})=>o)}}async save(t,e,n){let o=await this.store.getWriteLock(t,n);try{let s=await this.store.save(t,e,n);return this.#t(t,s),s.peer}finally{o?.()}}async patch(t,e,n){let o=await this.store.getWriteLock(t,n);try{let s=await this.store.patch(t,e,n);return this.#t(t,s),s.peer}finally{o?.()}}async merge(t,e,n){let o=await this.store.getWriteLock(t,n);try{let s=await this.store.merge(t,e,n);return this.#t(t,s),s.peer}finally{o?.()}}async consumePeerRecord(t,e,n){let o=Te(e)?e:Te(e?.expectedPeer)?e.expectedPeer:void 0,s=Te(e)||e===void 0?n:e,i=await yn.openAndCertify(t,gr.DOMAIN,s),a=ao(i.publicKey.toCID());if(o?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",o,a),!1;let c=gr.createFromProtobuf(i.payload),u;try{u=await this.get(a,s)}catch(l){if(l.name!=="NotFoundError")throw l}if(u?.peerRecordEnvelope!=null){let l=yn.createFromProtobuf(u.peerRecordEnvelope),f=gr.createFromProtobuf(l.payload);if(f.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:t,addresses:c.multiaddrs.map(l=>({isCertified:!0,multiaddr:l}))},s),!0}#t(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))}};function Zh(r,t={}){return new jl(r,t)}var xi=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(t="Not Found"){super(t)}};function jy(r){return r[Symbol.asyncIterator]!=null}function Zy(r){if(jy(r))return(async()=>{for await(let t of r);})();for(let t of r);}var Zl=Zy;function Xy(r){let[t,e]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[e](){return this}}}var Xh=Xy;function Qy(r){return r[Symbol.asyncIterator]!=null}function Yy(r,t){let e=0;if(Qy(r))return async function*(){for await(let c of r)await t(c,e++)&&(yield c)}();let n=Xh(r),{value:o,done:s}=n.next();if(s===!0)return function*(){}();let i=t(o,e++);if(typeof i.then=="function")return async function*(){await i&&(yield o);for(let c of n)await t(c,e++)&&(yield c)}();let a=t;return function*(){i===!0&&(yield o);for(let c of n)a(c,e++)&&(yield c)}()}var wr=Yy;function Jy(r){return r[Symbol.asyncIterator]!=null}function tb(r,t){return Jy(r)?async function*(){yield*(await vo(r)).sort(t)}():function*(){yield*vo(r).sort(t)}()}var Xl=tb;function eb(r){return r[Symbol.asyncIterator]!=null}function rb(r,t){return eb(r)?async function*(){let e=0;if(!(t<1)){for await(let n of r)if(yield n,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(let n of r)if(yield n,e++,e===t)return}}()}var Ql=rb;var Ei=class{put(t,e,n){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(let{key:n,value:o}of t)await this.put(n,o,e),yield n}async*getMany(t,e={}){for await(let n of t)yield{key:n,value:await this.get(n,e)}}async*deleteMany(t,e={}){for await(let n of t)await this.delete(n,e),yield n}batch(){let t=[],e=[];return{put(n,o){t.push({key:n,value:o})},delete(n){e.push(n)},commit:async n=>{await Zl(this.putMany(t,n)),t=[],await Zl(this.deleteMany(e,n)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let n=this._all(t,e);if(t.prefix!=null){let o=t.prefix;n=wr(n,s=>s.key.toString().startsWith(o))}if(Array.isArray(t.filters)&&(n=t.filters.reduce((o,s)=>wr(o,s),n)),Array.isArray(t.orders)&&(n=t.orders.reduce((o,s)=>Xl(o,s),n)),t.offset!=null){let o=0,s=t.offset;n=wr(n,()=>o++>=s)}return t.limit!=null&&(n=Ql(n,t.limit)),n}queryKeys(t,e){let n=this._allKeys(t,e);if(t.prefix!=null){let o=t.prefix;n=wr(n,s=>s.toString().startsWith(o))}if(Array.isArray(t.filters)&&(n=t.filters.reduce((o,s)=>wr(o,s),n)),Array.isArray(t.orders)&&(n=t.orders.reduce((o,s)=>Xl(o,s),n)),t.offset!=null){let o=t.offset,s=0;n=wr(n,()=>s++>=o)}return t.limit!=null&&(n=Ql(n,t.limit)),n}};var vi=class extends Ei{data;constructor(){super(),this.data=new Map}put(t,e,n){return n?.signal?.throwIfAborted(),this.data.set(t.toString(),e),t}get(t,e){e?.signal?.throwIfAborted();let n=this.data.get(t.toString());if(n==null)throw new xi;return n}has(t,e){return e?.signal?.throwIfAborted(),this.data.has(t.toString())}delete(t,e){e?.signal?.throwIfAborted(),this.data.delete(t.toString())}*_all(t,e){e?.signal?.throwIfAborted();for(let[n,o]of this.data.entries())yield{key:new br(n),value:o},e?.signal?.throwIfAborted()}*_allKeys(t,e){e?.signal?.throwIfAborted();for(let n of this.data.keys())yield new br(n),e?.signal?.throwIfAborted()}};function Co(r,t){let e,n=function(){let o=function(){e=void 0,r()};clearTimeout(e),e=setTimeout(o,t)};return n.start=()=>{},n.stop=()=>{clearTimeout(e)},n}var Yh=Vo(Qh(),1),nb=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],ob=nb.map(r=>new Yh.Netmask(r));function Yl(r){for(let t of ob)if(t.contains(r))return!0;return!1}function sb(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function ib(r){let t=r.split(":");if(t.length<2)return!1;let e=t[t.length-1].padStart(4,"0"),n=t[t.length-2].padStart(4,"0"),o=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(e.substring(0,2),16)}.${parseInt(e.substring(2),16)}`;return Yl(o)}function ab(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function cb(r){let t=r.split(":"),e=t[t.length-1];return Yl(e)}function lb(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function qe(r){if(re(r))return Yl(r);if(sb(r))return ib(r);if(ab(r))return cb(r);if(Ns(r))return lb(r)}var J=r=>({match:t=>{let e=t[0];return e==null||e.code!==r||e.value!=null?!1:t.slice(1)}}),M=(r,t)=>({match:e=>{let n=e[0];return n?.code!==r||n.value==null||t!=null&&n.value!==t?!1:e.slice(1)}}),q=r=>({match:t=>{let e=r.match(t);return e===!1?t:e}}),_t=(...r)=>({match:t=>{let e;for(let n of r){let o=n.match(t);o!==!1&&(e==null||o.length<e.length)&&(e=o)}return e??!1}}),$=(...r)=>({match:t=>{for(let e of r){let n=e.match(t);if(n===!1)return!1;t=n}return t}});function X(...r){function t(o){let s=o.getComponents();for(let i of r){let a=i.match(s);if(a===!1)return!1;s=a}return s}function e(o){return t(o)!==!1}function n(o){let s=t(o);return s===!1?!1:s.length===0}return{matchers:r,matches:e,exactMatch:n}}var ub=M(421),Jh=X(ub),Si=M(54),Ai=M(55),Ci=M(56),tu=M(53),k6=X(Si,q(M(421))),M6=X(Ai,q(M(421))),N6=X(Ci,q(M(421))),B6=X(_t(tu,Ci,Si,Ai),q(M(421))),tp=$(M(4),q(M(43))),ep=$(q(M(42)),M(41),q(M(43))),eu=_t(tp,ep),xr=_t(eu,tu,Si,Ai,Ci),F6=X(_t(eu,$(_t(tu,Ci,Si,Ai),q(M(421))))),ru=X(tp),nu=X(ep),U6=X(eu),ou=$(xr,M(6)),To=$(xr,M(273)),Po=X($(ou,q(M(421)))),K6=X(To),su=$(To,J(460),q(M(421))),Ii=$(To,J(461),q(M(421))),fb=_t(su,Ii),q6=X(su),rp=X(Ii),Jl=_t(xr,ou,To,su,Ii),np=_t($(Jl,J(477),q(M(421)))),Er=X(np),op=_t($(Jl,J(478),q(M(421))),$(Jl,J(448),q(M(449)),J(477),q(M(421)))),Do=X(op),sp=$(To,J(280),q(M(466)),q(M(466)),q(M(421))),iu=X(sp),ip=$(Ii,J(465),q(M(466)),q(M(466)),q(M(421))),au=X(ip),_i=_t(np,op,$(ou,q(M(421))),$(fb,q(M(421))),$(xr,q(M(421))),sp,ip,M(421)),z6=X(_i),db=$(_i,J(290),M(421)),Lo=X(db),hb=_t($(_i,J(290),J(281),q(M(421))),$(_i,J(281),q(M(421))),$(J(281),q(M(421)))),cu=X(hb),pb=_t($(xr,M(6),J(480),q(M(421))),$(xr,J(480),q(M(421)))),V6=X(pb),mb=$(xr,_t($(M(6,"443"),J(480)),$(M(6),J(443)),$(M(6),J(448),J(480)),$(J(448),J(480)),J(448),J(443)),q(M(421))),H6=X(mb),gb=_t($(M(777),q(M(421)))),$6=X(gb),yb=_t($(M(400),q(M(421)))),W6=X(yb);var lu=class extends Map{metric;constructor(t){super();let{name:e,metrics:n}=t;this.metric=n.registerMetric(e),this.updateComponentMetric()}set(t,e){return super.set(t,e),this.updateComponentMetric(),this}delete(t){let e=super.delete(t);return this.updateComponentMetric(),e}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function St(r){let{name:t,metrics:e}=r,n;return e!=null?n=new lu({name:t,metrics:e}):n=new Map,n}var ap=864e13;var bb=448,uu=449,wb=53,xb=54,Eb=55,vb=56,Ti=class{log;mappings;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=St({name:"libp2p_address_manager_dns_mappings",metrics:t.metrics})}has(t){let e=this.findHost(t);for(let n of this.mappings.values())if(n.domain===e)return!0;return!1}add(t,e){e.forEach(n=>{this.log("add DNS mapping %s to %s",n,t);let o=qe(n)===!0;this.mappings.set(n,{domain:t,verified:o,expires:o?ap-Date.now():0,lastVerified:o?ap-Date.now():void 0})})}remove(t){let e=this.findHost(t),n=!1;for(let[o,s]of this.mappings.entries())s.domain===e&&(this.log("removing %s to %s DNS mapping %e",o,s.domain,new Error("where")),this.mappings.delete(o),n=n||s.verified);return n}getAll(t){let e=[];for(let n=0;n<t.length;n++){let s=t[n].multiaddr.stringTuples(),i=s[0][1];if(i!=null)for(let[a,c]of this.mappings.entries()){if(i!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(t.splice(n,1),n--,e.push({multiaddr:K(`/${s.map(l=>[qs(l[0]).name,l[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return e}maybeAddSNITuple(t,e){for(let n=0;n<t.length;n++)if(t[n][0]===bb&&t[n+1]?.[0]!==uu)return t.splice(n+1,0,[uu,e]),!0;return!1}confirm(t,e){let n=this.findHost(t),o=!1;for(let[s,i]of this.mappings.entries())i.domain===n&&(this.log("marking %s to %s DNS mapping as verified",s,i.domain),o=i.verified,i.verified=!0,i.expires=Date.now()+e,i.lastVerified=Date.now());return o}unconfirm(t,e){let n=this.findHost(t),o=!1;for(let[s,i]of this.mappings.entries())i.domain===n&&(this.log("removing verification of %s to %s DNS mapping",s,i.domain),o=o||i.verified,i.verified=!1,i.expires=Date.now()+e);return o}findHost(t){for(let e of t.stringTuples())if(e[0]===uu||e[0]===wb||e[0]===xb||e[0]===Eb||e[0]===vb)return e[1]}};var fu=4,du=41,hu=6,_b=273,Pi=class{log;mappings;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=St({name:"libp2p_address_manager_ip_mappings",metrics:t.metrics})}has(t){let e=t.stringTuples();for(let n of this.mappings.values())for(let o of n)if(o.externalIp===e[0][1])return!0;return!1}add(t,e,n,o=e,s="tcp"){let i=`${t}-${e}-${s}`,a=this.mappings.get(i)??[],c={internalIp:t,internalPort:e,externalIp:n,externalPort:o,externalFamily:re(n)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(i,a)}remove(t){let e=t.stringTuples(),n=e[0][1]??"",o=e[1][0]===hu?"tcp":"udp",s=parseInt(e[1][1]??"0"),i=!1;for(let[a,c]of this.mappings.entries()){for(let u=0;u<c.length;u++){let l=c[u];l.externalIp===n&&l.externalPort===s&&l.protocol===o&&(this.log("removing %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,n,s,o),i=i||l.verified,c.splice(u,1),u--)}c.length===0&&this.mappings.delete(a)}return i}getAll(t){let e=[];for(let{multiaddr:n}of t){let o=n.stringTuples(),s;if((o[0][0]===fu||o[0][0]===du)&&o[1][0]===hu?s=`${o[0][1]}-${o[1][1]}-tcp`:(o[0][0]===fu||o[0][0]===du)&&o[1][0]===_b&&(s=`${o[0][1]}-${o[1][1]}-udp`),s==null)continue;let i=this.mappings.get(s);if(i!=null)for(let a of i)o[0][0]=a.externalFamily===4?fu:du,o[0][1]=a.externalIp,o[1][1]=`${a.externalPort}`,e.push({multiaddr:K(`/${o.map(c=>[qs(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return e}confirm(t,e){let o=t.stringTuples()[0][1],s=!1;for(let i of this.mappings.values())for(let a of i)a.externalIp===o&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+e,a.lastVerified=Date.now());return s}unconfirm(t,e){let n=t.stringTuples(),o=n[0][1]??"",s=n[1][0]===hu?"tcp":"udp",i=parseInt(n[1][1]??"0"),a=!1;for(let c of this.mappings.values())for(let u=0;u<c.length;u++){let l=c[u];l.externalIp===o&&l.externalPort===i&&l.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,o,i,s),a=a||l.verified,l.verified=!1,l.expires=Date.now()+e)}return a}};function cp(r){try{for(let{code:t,value:e}of r.getComponents())if(t!==42&&e!=null){if(t===4)return e.startsWith("169.254.");if(t===41)return e.toLowerCase().startsWith("fe80")}}catch{}return!1}function Di(r){try{for(let{code:t}of r.getComponents())if(t!==42)return t===4||t===41}catch{}return!1}function vr(r){try{if(!Di(r))return!1;let[[,t]]=r.stringTuples();return t==null?!1:qe(t)??!1}catch{}return!0}var Sb={maxObservedAddresses:10},Li=class{log;addresses;maxObservedAddresses;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=St({name:"libp2p_address_manager_observed_addresses",metrics:t.metrics}),this.maxObservedAddresses=e.maxObservedAddresses??Sb.maxObservedAddresses}has(t){return this.addresses.has(t.toString())}removePrefixed(t){for(let e of this.addresses.keys())e.toString().startsWith(t)&&this.addresses.delete(e)}add(t){this.addresses.size!==this.maxObservedAddresses&&(vr(t)||cp(t)||(this.log("adding observed address %a",t),this.addresses.set(t.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([t,e])=>({multiaddr:K(t),verified:e.verified,type:"observed",expires:e.expires,lastVerified:e.lastVerified}))}remove(t){let e=this.addresses.get(t.toString())?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(t.toString()),e}confirm(t,e){let n=t.toString(),o=this.addresses.get(n)??{verified:!1,expires:Date.now()+e,lastVerified:Date.now()},s=o.verified;return o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,o),s}};var Ab=[4,41,53,54,55,56];function pu(r){try{for(let{code:t}of r.getComponents())if(t!==42)return Ab.includes(t)}catch{}return!1}var Cb={maxObservedAddresses:10},Ri=class{log;addresses;maxObservedAddresses;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=St({name:"libp2p_address_manager_transport_addresses",metrics:t.metrics}),this.maxObservedAddresses=e.maxObservedAddresses??Cb.maxObservedAddresses}get(t,e){if(vr(t))return{multiaddr:t,verified:!0,type:"transport",expires:Date.now()+e,lastVerified:Date.now()};let n=this.toKey(t),o=this.addresses.get(n);return o==null&&(o={verified:!pu(t),expires:0},this.addresses.set(n,o)),{multiaddr:t,verified:o.verified,type:"transport",expires:o.expires,lastVerified:o.lastVerified}}has(t){let e=this.toKey(t);return this.addresses.has(e)}remove(t){let e=this.toKey(t),n=this.addresses.get(e)?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(e),n}confirm(t,e){let n=this.toKey(t),o=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},s=o.verified;return o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now(),this.addresses.set(n,o),s}unconfirm(t,e){let n=this.toKey(t),o=this.addresses.get(n)??{verified:!1,expires:0},s=o.verified;return o.verified=!1,o.expires=Date.now()+e,this.addresses.set(n,o),s}toKey(t){if(pu(t)){let e=t.toOptions();return`${e.host}-${e.port}-${e.transport}`}return t.toString()}};var lp=6e4,up={maxObservedAddresses:10,addressVerificationTTL:lp*10,addressVerificationRetry:lp*5},Ib=r=>r;function mu(r,t){let e=r.getPeerId();return e!=null&&fe(e).equals(t)&&(r=r.decapsulate(K(`/p2p/${t.toString()}`))),r}var Oi=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(t,e={}){let{listen:n=[],announce:o=[],appendAnnounce:s=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=n.map(i=>i.toString()),this.announce=new Set(o.map(i=>i.toString())),this.appendAnnounce=new Set(s.map(i=>i.toString())),this.observed=new Li(t,e),this.dnsMappings=new Ti(t,e),this.ipMappings=new Pi(t,e),this.transportAddresses=new Ri(t,e),this.announceFilter=e.announceFilter??Ib,this.observedAddressFilter=wo(1024),this.addressVerificationTTL=e.addressVerificationTTL??up.addressVerificationTTL,this.addressVerificationRetry=e.addressVerificationRetry??up.addressVerificationRetry,this._updatePeerStoreAddresses=Co(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let t=this.getAddresses().map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>K(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>K(t))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(t=>K(t))}getObservedAddrs(){return this.observed.getAll().map(t=>t.multiaddr)}addObservedAddr(t){let e=t.stringTuples(),n=`${e[0][1]}:${e[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),t=mu(t,this.components.peerId),!this.ipMappings.has(t)&&(this.dnsMappings.has(t)||this.observed.add(t)))}confirmObservedAddr(t,e){t=mu(t,this.components.peerId);let n=!0;(e?.type==="transport"||this.transportAddresses.has(t))&&!this.transportAddresses.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="dns-mapping"||this.dnsMappings.has(t))&&!this.dnsMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="ip-mapping"||this.ipMappings.has(t))&&!this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="observed"||this.observed.has(t))&&(this.maybeUpgradeToIPMapping(t)?(this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(t,e){t=mu(t,this.components.peerId);let n=!1;this.observed.has(t)&&!this.observed.remove(t)&&n&&(n=!1),this.transportAddresses.has(t)&&!this.transportAddresses.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(t)&&!this.dnsMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(t)&&!this.ipMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let t=new Set,e=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let o=n.multiaddr.toString();return t.has(o)?!1:(t.add(o),!0)}).map(n=>n.multiaddr);return this.announceFilter(e.map(n=>{let o=K(n);return o.getComponents().pop()?.value===this.components.peerId.toString()?o:o.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let t=this.getAnnounceAddrs();if(t.length>0)return this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(t)}),t.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let e=[];e=e.concat(this.components.transportManager.getAddrs().map(o=>this.transportAddresses.get(o,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(n)}),e=e.concat(n.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),e=e.concat(this.observed.getAll()),e=e.concat(this.ipMappings.getAll(e)),e=e.concat(this.dnsMappings.getAll(e)),e}addDNSMapping(t,e){this.dnsMappings.add(t,e)}removeDNSMapping(t){this.dnsMappings.remove(K(`/dns/${t}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(t,e,n,o=e,s="tcp"){this.ipMappings.add(t,e,n,o,s),this.observed.removePrefixed(`/ip${re(n)?4:6}/${n}/${s}/${o}`)}removePublicAddressMapping(t,e,n,o=e,s="tcp"){this.ipMappings.remove(K(`/ip${re(n)?4:6}/${n}/${s}/${o}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(t){if(this.ipMappings.has(t))return!1;let e=t.toOptions();if(e.family===6||e.host==="127.0.0.1"||qe(e.host)===!0)return!1;let n=this.components.transportManager.getListeners(),o=[s=>Er.exactMatch(s)||Do.exactMatch(s),s=>Po.exactMatch(s),s=>rp.exactMatch(s)];for(let s of o){if(!s(t))continue;let i=n.filter(u=>u.getAddrs().filter(l=>l.toOptions().family===4&&s(l)).length>0);if(i.length!==1)continue;let a=i[0].getAddrs().filter(u=>u.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;let c=a.toOptions();return this.observed.remove(t),this.ipMappings.add(c.host,c.port,e.host,e.port,e.transport),!0}return!1}};var fp;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(fp||(fp={}));var ki=class extends Error{constructor(t="Missing service"){super(t),this.name="MissingServiceError"}},Mi=class extends Error{constructor(t="Unmet service dependencies"){super(t),this.name="UnmetServiceDependenciesError"}},xn=class extends Error{constructor(t="No content routers available"){super(t),this.name="NoContentRoutersError"}},Ro=class extends Error{constructor(t="No peer routers available"){super(t),this.name="NoPeerRoutersError"}},Ni=class extends Error{constructor(t="Should not try to find self"){super(t),this.name="QueriedForSelfError"}},Bi=class extends Error{constructor(t="Unhandled protocol error"){super(t),this.name="UnhandledProtocolError"}},Fi=class extends Error{constructor(t="Duplicate protocol handler error"){super(t),this.name="DuplicateProtocolHandlerError"}},Oo=class extends Error{constructor(t="Dial denied error"){super(t),this.name="DialDeniedError"}},Ui=class extends Error{constructor(t="No transport was configured to listen on this address"){super(t),this.name="UnsupportedListenAddressError"}},Ki=class extends Error{constructor(t="Configured listen addresses could not be listened on"){super(t),this.name="UnsupportedListenAddressesError"}},qi=class extends Error{constructor(t="No valid addresses"){super(t),this.name="NoValidAddressesError"}},zi=class extends Error{constructor(t="Connection intercepted"){super(t),this.name="ConnectionInterceptedError"}},Vi=class extends Error{constructor(t="Connection denied"){super(t),this.name="ConnectionDeniedError"}},_r=class extends Error{constructor(t="Stream is not multiplexed"){super(t),this.name="MuxerUnavailableError"}},Sr=class extends Error{constructor(t="Encryption failed"){super(t),this.name="EncryptionFailedError"}},Hi=class extends Error{constructor(t="Transport unavailable"){super(t),this.name="TransportUnavailableError"}},$i=class extends Error{constructor(t="Max recursive depth reached"){super(t),this.name="RecursionLimitError"}};var gu=class{components={};_started=!1;constructor(t={}){this.components={};for(let[e,n]of Object.entries(t))this.components[e]=n;this.components.logger==null&&(this.components.logger=$s())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>Yo(e)).map(async e=>{await e[t]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},Pb=["metrics","connectionProtector","dns"],Db=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function dp(r={}){let t=new gu(r);return new Proxy(t,{get(n,o,s){if(typeof o=="string"&&!Db.includes(o)){let i=t.components[o];if(i==null&&!Pb.includes(o))throw new ki(`${o} not set`);return i}return Reflect.get(n,o,s)},set(n,o,s){return typeof o=="string"?t.components[o]=s:Reflect.set(n,o,s),!0}})}function hp(r){let t={};for(let e of Object.values(r.components))for(let n of Lb(e))t[n]=!0;for(let e of Object.values(r.components))for(let n of Rb(e))if(t[n]!==!0)throw new Mi(`Service "${Ob(e)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function Lb(r){return Array.isArray(r?.[In])?r[In]:[]}function Rb(r){return Array.isArray(r?.[Oa])?r[Oa]:[]}function Ob(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}var kb=4,Mb=41;function pp(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{if(Er.matches(t))return!1;let e=t.stringTuples();return e[0][0]===kb||e[0][0]===Mb?!!qe(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var mp=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},Nb=new WeakMap;function Bb({clearTimeout:r,setTimeout:t}={}){return(e,{value:n,signal:o}={})=>{if(o?.aborted)return Promise.reject(mp());let s,i,a,c=r??clearTimeout,u=()=>{c(s),a(mp())},l=()=>{o&&o.removeEventListener("abort",u)},f=new Promise((d,h)=>{i=()=>{l(),d(n)},a=h,s=(t??setTimeout)(i,e)});return o&&o.addEventListener("abort",u,{once:!0}),Nb.set(f,()=>{c(s),s=null,i()}),f}}var Fb=Bb(),gp=Fb;var Wi=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(t="Rate limit exceeded",e){super(t),this.name="RateLimitError",this.remainingPoints=e.remainingPoints,this.msBeforeNext=e.msBeforeNext,this.consumedPoints=e.consumedPoints,this.isFirstInDuration=e.isFirstInDuration}},Gi=class extends Error{static name="QueueFullError";constructor(t="The queue was full"){super(t),this.name="QueueFullError"}};var ji=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(t={}){this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new yu}async consume(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,e,s);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+e&&(i=this.memoryStorage.set(o,i.consumedPoints,this.blockDuration)),new Wi("Rate limit exceeded",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let a=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=i.consumedPoints*this.execEvenlyMinDelayMs),await gp(a)}return i}penalty(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,e,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,-e,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(t,e){let n=e*1e3,o=this.points+1;return this.memoryStorage.set(this.getKey(t),o,e),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:o,isFirstInDuration:!1}}set(t,e,n=0){let o=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,n),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:e,isFirstInDuration:!1}}get(t){let e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return t?.customDuration!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}},yu=class{storage;constructor(){this.storage=new Map}incrby(t,e,n){let o=this.storage.get(t);if(o!=null){let s=o.expiresAt!=null?o.expiresAt.getTime()-new Date().getTime():-1;return o.expiresAt==null||s>0?(o.value+=e,{remainingPoints:0,msBeforeNext:s,consumedPoints:o.value,isFirstInDuration:!1}):this.set(t,e,n)}return this.set(t,e,n)}set(t,e,n){let o=n*1e3,s=this.storage.get(t);s!=null&&clearTimeout(s.timeoutId);let i={value:e,expiresAt:o>0?new Date(Date.now()+o):void 0};return this.storage.set(t,i),o>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(t)},o),i.timeoutId.unref!=null&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:i.value,isFirstInDuration:!0}}get(t){let e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){let e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}};function Zi(r){if(Te(r))return{peerId:r,multiaddrs:[]};let t=Array.isArray(r)?r:[r],e;if(t.length>0){let n=t[0].getPeerId();e=n==null?void 0:fe(n),t.forEach(o=>{if(!Ke(o))throw new Pe("Invalid multiaddr");let s=o.getPeerId();if(s==null){if(e!=null)throw new k("Multiaddrs must all have the same peer id or have no peer id")}else{let i=fe(s);if(e?.equals(i)!==!0)throw new k("Multiaddrs must all have the same peer id or have no peer id")}})}return t=t.filter(n=>!Jh.exactMatch(n)),{peerId:e,multiaddrs:t}}var Ub=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function yp(r,t){let e=r?.streams?.map(o=>o.protocol)??[],n=t?.closableProtocols??Ub;if(!(e.filter(o=>o!=null&&!n.includes(o)).length>0))try{await r?.close(t)}catch(o){r?.abort(o)}}function ko(r){try{let t;typeof r=="string"?t=K(r):t=r;let e=new Set([...t.getComponents().map(n=>n.name)]);if(!e.has("ipcidr")){let o=e.has("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(o)}return Rl(t)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}var Xi=class{connectionManager;peerStore;allow;events;log;constructor(t,e={}){this.allow=(e.allow??[]).map(n=>ko(n)),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(t=>{this.log.error("error while pruning connections %e",t)})}async _maybePruneConnections(){let t=this.connectionManager.getConnections(),e=t.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",e,n),e<=n)return;let o=new $t;for(let c of t){let u=c.remotePeer;if(!o.has(u)){o.set(u,0);try{let l=await this.peerStore.get(u);o.set(u,[...l.tags.values()].reduce((f,d)=>f+d.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}let s=this.sortConnections(t,o),i=Math.max(e-n,0),a=[];for(let c of s)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(l=>l.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===i)break;await Promise.all(a.map(async c=>{await yp(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(t,e){return t.sort((n,o)=>{let s=n.timeline.open,i=o.timeline.open;return s<i?1:s>i?-1:0}).sort((n,o)=>n.direction==="outbound"&&o.direction==="inbound"?1:n.direction==="inbound"&&o.direction==="outbound"?-1:0).sort((n,o)=>n.streams.length>o.streams.length?1:n.streams.length<o.streams.length?-1:0).sort((n,o)=>{let s=e.get(n.remotePeer)??0,i=e.get(o.remotePeer)??0;return s>i?1:s<i?-1:0})}};var bp="last-dial-failure",wp="last-dial-success";var xp=100,Qi=50;var Yi=class{deferred;signal;constructor(t){this.signal=t,this.deferred=ot(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Gt)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Kb(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Ji=class{id;fn;options;recipients;status;timeline;controller;constructor(t,e){this.id=Kb(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,n)=>e&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Gt),this.cleanup())}async join(t={}){let e=new Yi(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let t=await mt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}};var En=class extends Bt{concurrency;maxSize;queue;pending;sort;constructor(t={}){super(),this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&t.metrics?.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=t.sort,this.queue=[],this.emitEmpty=Co(this.emitEmpty.bind(this),1),this.emitIdle=Co(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let e of this.queue)if(e.status==="queued"){t=e;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let e=0;e<this.queue.length;e++)if(this.queue[e]===t){this.queue.splice(e,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,e){if(e?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Gi;let n=new Ji(t,e);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(e).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Gt)}),this.clear()}async onEmpty(t){this.size!==0&&await he(this,"empty",t?.signal)}async onSizeLessThan(t,e){this.size<t||await he(this,"next",e?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await he(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let e=Xs({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),e.end(c)},o=c=>{c.detail!=null&&e.push(c.detail)},s=c=>{n(c.detail)},i=()=>{n()},a=()=>{n(new Gt("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("error",s),this.addEventListener("idle",i),t?.signal?.addEventListener("abort",a);try{yield*e}finally{this.removeEventListener("completed",o),this.removeEventListener("error",s),this.removeEventListener("idle",i),t?.signal?.removeEventListener("abort",a),n()}}};var ta=class extends En{constructor(t={}){super({...t,sort:(e,n)=>e.options.priority>n.options.priority?-1:e.options.priority<n.options.priority?1:0})}};function Ie(r){let t=new globalThis.AbortController;function e(){t.abort();for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",e)}for(let s of r){if(s?.aborted===!0){e();break}s?.addEventListener!=null&&s.addEventListener("abort",e)}function n(){for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",e)}let o=t.signal;return o.clear=n,o}function Ep(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function bu(r){if(!Di(r))return!1;let{address:t}=r.nodeAddress();return Ep(t)}function qb(r,t){let e=Po.exactMatch(r.multiaddr),n=Po.exactMatch(t.multiaddr);if(e&&!n)return-1;if(!e&&n)return 1;let o=Do.exactMatch(r.multiaddr),s=Do.exactMatch(t.multiaddr);if(o&&!s)return-1;if(!o&&s)return 1;let i=Er.exactMatch(r.multiaddr),a=Er.exactMatch(t.multiaddr);if(i&&!a)return-1;if(!i&&a)return 1;let c=cu.exactMatch(r.multiaddr),u=cu.exactMatch(t.multiaddr);if(c&&!u)return-1;if(!c&&u)return 1;let l=iu.exactMatch(r.multiaddr),f=iu.exactMatch(t.multiaddr);if(l&&!f)return-1;if(!l&&f)return 1;let d=au.exactMatch(r.multiaddr),h=au.exactMatch(t.multiaddr);return d&&!h?-1:!d&&h?1:0}function zb(r,t){let e=bu(r.multiaddr),n=bu(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function Vb(r,t){let e=vr(r.multiaddr),n=vr(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function Hb(r,t){return r.isCertified&&!t.isCertified?-1:!r.isCertified&&t.isCertified?1:0}function $b(r,t){let e=Lo.exactMatch(r.multiaddr),n=Lo.exactMatch(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function vp(r){return r.sort(qb).sort(Hb).sort($b).sort(Vb).sort(zb)}async function wu(r,t,e){let n=e.depth??0;if(n>(e.maxRecursiveDepth??32))throw new $i("Max recursive depth reached");let o=!1,s=[];for(let i of Object.values(t))if(i.canResolve(r)){o=!0;let a=await i.resolve(r,e);for(let c of a)s.push(...await wu(c,t,{...e,depth:n+1}))}return o===!1&&s.push(r),s}var Mo={maxParallelDials:Qi,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:Se}},ea=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(t,e={}){this.addressSorter=e.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??Mo.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??Mo.maxDialQueueLength,this.dialTimeout=e.dialTimeout??Mo.dialTimeout,this.connections=e.connections??new $t,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.resolvers=e.resolvers??Mo.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new ta({concurrency:e.maxParallelDials??Mo.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==Gt.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){let{peerId:n,multiaddrs:o}=Zi(t),s=Array.from(this.connections.values()).flat().find(a=>e.force===!0||a.limits!=null?!1:a.remotePeer.equals(n)?!0:o.find(c=>c.equals(a.remoteAddr)));if(s?.status==="open")return this.log("already connected to %a",s.remoteAddr),e.onProgress?.(new at("dial-queue:already-connected")),s;let i=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let u of o)if(c.has(u.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(let a of o)i.options.multiaddrs.add(a.toString());return e.onProgress?.(new at("dial-queue:already-in-dial-queue")),i.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new kr("Dial queue is full");return this.log("creating dial target for %p",n,o.map(a=>a.toString())),e.onProgress?.(new at("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new at("dial-queue:start-dial"));let c=Ie([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:e.priority??_u,multiaddrs:new Set(o.map(a=>a.toString())),signal:e.signal??AbortSignal.timeout(this.dialTimeout),onProgress:e.onProgress})}async dialPeer(t,e){let n=t.peerId,o=t.multiaddrs,s=new Set,i=t.multiaddrs.size===0,a=0,c=0,u=[];for(this.log("starting dial to %p",n);i||o.size>0;){c++,i=!1;let l=[],f=new Set(t.multiaddrs);o.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let d=await this.calculateMultiaddrs(n,f,{...t,signal:e});for(let h of d){if(s.has(h.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",h.multiaddr,n);continue}l.push(h)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,l.map(h=>h.multiaddr.toString())),t?.onProgress?.(new at("dial-queue:calculated-addresses",l));for(let h of l){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,t.peerId),new kr("Peer had more than maxPeerAddrsToDial");a++;try{let p=await this.components.transportManager.dial(h.multiaddr,{...t,signal:e});this.log("dial to %a succeeded",h.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[wp]:D(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}return p}catch(p){if(this.log.error("dial failed to %a",h.multiaddr,p),s.add(h.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[bp]:D(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}if(e.aborted)throw new Zo(p.message);u.push(p)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(t,e=new Set,n={}){let o=[...e].map(f=>({multiaddr:K(f),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new kr("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(t)===!0)throw new Oo("The dial request is blocked by gater.allowDialPeer");if(o.length===0){this.log("loading multiaddrs for %p",t);try{let f=await this.components.peerStore.get(t);o.push(...f.addresses),this.log("loaded multiaddrs for %p",t,o.map(({multiaddr:d})=>d.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(o.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{let f=await this.components.peerRouting.findPeer(t,n);this.log("found multiaddrs for %p in the peer routing",t,o.map(({multiaddr:d})=>d.toString())),o.push(...f.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",t):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",t,f)}}}let s=(await Promise.all(o.map(async f=>{let d=await wu(f.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(f.multiaddr)?f:d.map(h=>({multiaddr:h,isCertified:!1}))}))).flat();if(t!=null){let f=`/p2p/${t.toString()}`;s=s.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(f),isCertified:d.isCertified}:d)}let i=s.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let d=f.multiaddr.getPeerId();return t!=null&&d!=null?t.equals(d):!0}),a=new Map;for(let f of i){let d=f.multiaddr.toString(),h=a.get(d);if(h!=null){h.isCertified=h.isCertified||f.isCertified||!1;continue}a.set(d,f)}let c=[...a.values()];if(c.length===0)throw new qi("The dial request has no valid addresses");let u=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||u.push(f);let l=this.addressSorter==null?vp(u):u.sort(this.addressSorter);if(l.length===0)throw new Oo("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",t??"unknown peer",s.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",l.map(({multiaddr:f})=>f.toString())),l}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{let n=await this.calculateMultiaddrs(void 0,new Set(t.map(o=>o.toString())),e);return e.runOnLimitedConnection===!1?n.find(o=>!Lo.matches(o.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}};var ra=class extends En{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}};var Pp=Vo(Ip(),1);var Gb=Object.prototype.toString,jb=r=>Gb.call(r)==="[object Error]",Zb=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function Su(r){return r&&jb(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:Zb.has(r.message):!1}var Au=class extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}},Tp=(r,t,e)=>{let n=e.retries-(t-1);return r.attemptNumber=t,r.retriesLeft=n,r};async function Cu(r,t){return new Promise((e,n)=>{t={...t},t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.retries??=10;let o=Pp.default.operation(t),s=()=>{o.stop(),n(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",s,{once:!0});let i=()=>{t.signal?.removeEventListener("abort",s),o.stop()};o.attempt(async a=>{try{let c=await r(a);i(),e(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof Au)throw c.originalError;if(c instanceof TypeError&&!Su(c))throw c;if(Tp(c,a,t),await t.shouldRetry(c)||(o.stop(),n(c)),await t.onFailedAttempt(c),!o.retry(c))throw o.mainError()}catch(u){Tp(u,a,t),i(),n(u)}}})})}var na=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.queue=new ra({concurrency:e.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:t.metrics}),this.started=!1,this.retries=e.retries??5,this.backoffFactor=e.backoffFactor,this.retryInterval=e.retryInterval,this.events=t.events,t.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(o=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,o)})})}async maybeReconnect(t){if(!this.started)return;let e=await this.peerStore.get(t);Dp(e)&&(this.queue.has(t)||this.queue.add(async n=>{await Cu(async o=>{if(this.started)try{await this.connectionManager.openConnection(t,{signal:n?.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",t,o,this.retries,s),s}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:t}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",t,n);let o={};[...e.tags.keys()].forEach(s=>{s.startsWith(Ra)&&(o[s]=void 0)}),await this.peerStore.merge(t,{tags:o}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:t})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",t,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let t=await this.peerStore.all({filters:[e=>Dp(e)]});await Promise.all(t.map(async e=>{await this.connectionManager.openConnection(e.id).catch(n=>{this.log.error(n)})}))}).catch(t=>{this.log.error(t)})}stop(){this.started=!1,this.queue.abort()}};function Dp(r){for(let t of r.tags.keys())if(t.startsWith(Ra))return!0;return!1}var _u=50,Iu={maxConnections:xp,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},oa=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(t,e={}){if(this.maxConnections=e.maxConnections??Iu.maxConnections,this.maxConnections<1)throw new k("Connection Manager maxConnections must be greater than 0");this.connections=new $t,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(e.allow??[]).map(n=>ko(n)),this.deny=(e.deny??[]).map(n=>ko(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??Iu.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new ji({points:e.inboundConnectionThreshold??Iu.inboundConnectionThreshold,duration:1}),this.connectionPruner=new Xi({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{allow:e.allow?.map(n=>K(n))}),this.dialQueue=new ea(t,{addressSorter:e.addressSorter,maxParallelDials:e.maxParallelDials??Qi,maxDialQueueLength:e.maxDialQueueLength??500,maxPeerAddrsToDial:e.maxPeerAddrsToDial??25,dialTimeout:e.dialTimeout??1e4,resolvers:e.resolvers??{dnsaddr:Se},connections:this.connections}),this.reconnectQueue=new na({events:t.events,peerStore:t.peerStore,logger:t.logger,connectionManager:this},{retries:e.reconnectRetries,retryInterval:e.reconnectRetryInterval,backoffFactor:e.reconnectBackoffFactor,maxParallelReconnects:e.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let t={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let e of this.connections.values())for(let n of e)t[n.direction]++;return t}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let t={};for(let e of this.connections.values())for(let n of e)for(let o of n.streams){let s=`${o.direction} ${o.protocol??"unnegotiated"}`;t[s]=(t[s]??0)+1}return t}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let t={};for(let n of this.connections.values())for(let o of n){let s={};for(let i of o.streams){let a=`${i.direction} ${i.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(let[i,a]of Object.entries(s))t[i]=t[i]??[],t[i].push(a)}let e={};for(let[n,o]of Object.entries(t)){o=o.sort((i,a)=>i-a);let s=Math.floor(o.length*.9);e[n]=o[s]}return e}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Fu(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Uu(this.reconnectQueue,this.dialQueue,this.connectionPruner);let t=[];for(let e of this.connections.values())for(let n of e)t.push((async()=>{try{await n.close()}catch(o){this.log.error(o)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(t){if(this.maxConnections<1)throw new k("Connection Manager maxConnections must be greater than 0");let e=!1;t<this.maxConnections&&(e=!0),this.maxConnections=t,e&&this.connectionPruner.maybePruneConnections()}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){let{detail:e}=t;if(!this.started){await e.close();return}if(e.status!=="open")return;let n=e.remotePeer,o=!this.connections.has(n),s=this.connections.get(n)??[];s.push(e),this.connections.set(n,s),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){let{detail:e}=t,n=e.remotePeer,s=(this.connections.get(n)??[]).filter(i=>i.id!==e.id);this.connections.set(n,s),s.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(let n of this.connections.values())e=e.concat(n);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){if(!this.started)throw new pe("Not started");this.outboundPendingConnections++;try{e.signal?.throwIfAborted();let{peerId:n}=Zi(t);if(this.peerId.equals(n))throw new Or("Can not dial self");if(n!=null&&e.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),e.onProgress?.(new at("dial-queue:already-connected")),a}let o=await this.dialQueue.dial(t,{...e,priority:e.priority??_u});if(o.status!=="open")throw new Rr("Remote closed connection during opening");let s=this.connections.get(o.remotePeer);s==null&&(s=[],this.connections.set(o.remotePeer,s));let i=!1;for(let a of s)if(a.id===o.id&&(i=!0),e.force!==!0&&a.id!==o.id&&a.remoteAddr.equals(o.remoteAddr))return o.abort(new Pe("Duplicate multiaddr connection")),a;return i||s.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(t,e={}){let n=this.connections.get(t)??[];await Promise.all(n.map(async o=>{try{await o.close(e)}catch(s){o.abort(s)}}))}async acceptIncomingConnection(t){if(this.deny.some(o=>o.contains(t.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(o=>o.contains(t.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){let o=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(o,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,o),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(n=>K(n))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}};var vn=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(t){this.timeSpan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timeSpan)}push(t,e=Date.now()){if(this.previousTime!=null){let n=this.alpha(e,this.previousTime),o=t-this.movingAverage,s=n*o;this.movingAverage=n*t+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+o*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*o}else this.movingAverage=t;this.previousTime=e}};var Yb=1.2,Jb=2,tw=5e3,ew=6e4,rw=5e3,sa=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(t={}){let e=t.interval??rw;this.success=new vn(e),this.failure=new vn(e),this.next=new vn(e),this.failureMultiplier=t.failureMultiplier??Jb,this.timeoutMultiplier=t.timeoutMultiplier??Yb,this.minTimeout=t.minTimeout??tw,this.maxTimeout=t.maxTimeout??ew,t.metricName!=null&&(this.metric=t.metrics?.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){let e=Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier));e<this.minTimeout&&(e=this.minTimeout),e>this.maxTimeout&&(e=this.maxTimeout);let n=AbortSignal.timeout(e),o=Ie([t.signal,n]);return o.start=Date.now(),o.timeout=e,o}cleanUp(t){let e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}};var Tu=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=ot(),this.haveNext=ot()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ot(),t}async throw(t){return this.ended=!0,this.error=t,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){let t={done:!0,value:void 0};return this.ended=!0,this.nextResult=t,this.haveNext.resolve(),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ot(),await mt(this.readNext.promise,e?.signal,e)}};function ia(){return new Tu}var aa=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function ca(r,t){let e=ia();r.sink(e).catch(async i=>{await e.end(i)}),r.sink=async i=>{for await(let a of i)await e.push(a);await e.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let o=new z;return{read:async i=>{if(i?.signal?.throwIfAborted(),i?.bytes==null){let{done:c,value:u}=await mt(n.next(),i?.signal);return c===!0?null:u}for(;o.byteLength<i.bytes;){let{value:c,done:u}=await mt(n.next(),i?.signal);if(u===!0)throw new aa("unexpected end of input");o.append(c)}let a=o.sublist(0,i.bytes);return o.consume(i.bytes),a},write:async(i,a)=>{a?.signal?.throwIfAborted(),i instanceof Uint8Array?await e.push(i,a):await e.push(i.subarray(),a)},unwrap:()=>{if(o.byteLength>0){let i=r.source;r.source=async function*(){t?.yieldBytes===!1?yield o:yield*o,yield*i}()}return r}}}var nw=1e4,ow="1.0.0",sw="ping",iw="ipfs",Lp=32,aw=!0,la=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(t,e={}){this.components=t,this.protocol=`/${e.protocolPrefix??iw}/${sw}/${ow}`,this.log=t.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=e.pingInterval??nw,this.abortConnectionOnPingFailure=e.abortConnectionOnPingFailure??aw,this.timeout=new sa({...e.pingTimeout??{},metrics:t.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[In]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(t=>{Promise.resolve().then(async()=>{let e=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),o=await t.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),s=ca(o);e=Date.now(),await Promise.all([s.write(en(Lp),{signal:n}),s.read({bytes:Lp,signal:n})]),t.rtt=Date.now()-e,await s.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;t.rtt=(Date.now()-e)/2}}).catch(e=>{this.log.error("error during heartbeat",e),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),t.abort(e)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};function cw(r){return r[Symbol.asyncIterator]!=null}async function lw(r,t,e){try{await Promise.all(r.map(async n=>{for await(let o of n)await t.push(o,{signal:e}),e.throwIfAborted()})),await t.end(void 0,{signal:e})}catch(n){await t.end(n,{signal:e}).catch(()=>{})}}async function*uw(r){let t=new AbortController,e=ia();lw(r,e,t.signal).catch(()=>{});try{yield*e}finally{t.abort()}}function*fw(r){for(let t of r)yield*t}function dw(...r){let t=[];for(let e of r)cw(e)||t.push(e);return t.length===r.length?fw(t):uw(r)}var No=dw;var ua=class{routers;started;components;constructor(t,e){this.routers=e.routers??[],this.started=!1,this.components=t,this.findProviders=t.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()}),getAttributesFromYieldedValue:(n,o)=>({...o,providers:[...Array.isArray(o.providers)?o.providers:[],n.id.toString()]})})??this.findProviders,this.provide=t.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.provide,this.cancelReprovide=t.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.cancelReprovide,this.put=t.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:N(n,"base36")})})??this.put,this.get=t.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:N(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new xn("No content routers available");let n=this,o=new hr;for await(let s of No(...n.routers.filter(i=>i.findProviders instanceof Function).map(i=>i.findProviders(t,e))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},e),!o.has(s.id)&&(o.add(s.id),yield s))}async provide(t,e={}){if(this.routers.length===0)throw new xn("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(t,e)}))}async cancelReprovide(t,e={}){if(this.routers.length===0)throw new xn("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(t,e)}))}async put(t,e,n){if(!this.isStarted())throw new pe;await Promise.all(this.routers.filter(o=>o.put instanceof Function).map(async o=>{await o.put(t,e,n)}))}async get(t,e){if(!this.isStarted())throw new pe;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(t,e)))}};var fa=globalThis.CustomEvent??Event;async function*Pu(r,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);let n=t.ordered??!1,o=new EventTarget,s=[],i=ot(),a=ot(),c=!1,u,l=!1;o.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let p of r){if(s.length===e&&(i=ot(),await i.promise),l)break;let g={done:!1};s.push(g),p().then(m=>{g.done=!0,g.ok=!0,g.value=m,o.dispatchEvent(new fa("task-complete"))},m=>{g.done=!0,g.err=m,o.dispatchEvent(new fa("task-complete"))})}c=!0,o.dispatchEvent(new fa("task-complete"))}catch(p){u=p,o.dispatchEvent(new fa("task-complete"))}});function f(){return n?s[0]?.done:!!s.find(p=>p.done)}function*d(){for(;s.length>0&&s[0].done;){let p=s[0];if(s.shift(),p.ok)yield p.value;else throw l=!0,i.resolve(),p.err;i.resolve()}}function*h(){for(;f();)for(let p=0;p<s.length;p++)if(s[p].done){let g=s[p];if(s.splice(p,1),p--,g.ok)yield g.value;else throw l=!0,i.resolve(),g.err;i.resolve()}}for(;;){if(f()||(a=ot(),await a.promise),u!=null||(n?yield*d():yield*h(),u!=null))throw u;if(c&&s.length===0)break}}var da=class{log;peerId;peerStore;routers;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[],this.findPeer=t.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,peer:n.toString()})})??this.findPeer,this.getClosestPeers=t.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,key:N(n,"base36")}),getAttributesFromYieldedValue:(n,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(t,e){if(this.routers.length===0)throw new Ro("No peer routers available");if(t.toString()===this.peerId.toString())throw new Ni("Should not try to find self");let n=this,o=No(...this.routers.filter(s=>s.findPeer instanceof Function).map(s=>async function*(){try{yield await s.findPeer(t,e)}catch(i){n.log.error(i)}}()));for await(let s of o)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},e),s;throw new $e}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new Ro("No peer routers available");let n=this,o=wo(1024);for await(let s of Pu(async function*(){let i=No(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(t,e)));for await(let a of i)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...e,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},e),!o.has(s.id.toMultihash().bytes)&&(o.add(s.id.toMultihash().bytes),yield s))}};var ha=class extends Bt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(t){super(),this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){this.walking||this.startWalk(),this.walkers++;let e=Ie([this.shutdownController.signal,t?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=ot(),yield(await he(this,"walk:peer",e,{errorEvent:"walk:error"})).detail}finally{e.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let t=Ie([this.walkController.signal,this.shutdownController.signal]);let e=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=en(32),s=Date.now();for await(let i of this.peerRouting.getClosestPeers(o,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",i.id,Date.now()-s,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:i}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await mt(this.needNext.promise,t)),s=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,n)}catch(o){this.log.error("random walk errored",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-e),this.walking=!1})}};var Du=32,Lu=64,pa=class{log;topologies;handlers;components;constructor(t){this.components=t,this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,t.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let e={};for(let[n,o]of this.topologies)e[n]=o.size;return e}}),this.handlers=St({name:"libp2p_registrar_protocol_handlers",metrics:t.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){let e=this.handlers.get(t);if(e==null)throw new Bi(`No handler registered for protocol ${t}`);return e}getTopologies(t){let e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,n){if(this.handlers.has(t)&&n?.force!==!0)throw new Fi(`Handler already registered for protocol ${t}`);let o=Is.bind({ignoreUndefined:!0})({maxInboundStreams:Du,maxOutboundStreams:Lu},n);this.handlers.set(t,{handler:e,options:o}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]},n)}async unhandle(t,e){(Array.isArray(t)?t:[t]).forEach(o=>{this.handlers.delete(o)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},e)}async register(t,e){if(e==null)throw new k("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,o=this.topologies.get(t);return o==null&&(o=new Map,this.topologies.set(t,o)),o.set(n,e),n}unregister(t){for(let[e,n]of this.topologies.entries())n.has(t)&&(n.delete(t),n.size===0&&this.topologies.delete(e))}_onDisconnect(t){let e=t.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(e,n).then(o=>{for(let s of o.protocols){let i=this.topologies.get(s);if(i!=null)for(let a of i.values())a.filter?.has(e)!==!1&&(a.filter?.remove(e),a.onDisconnect?.(e))}}).catch(o=>{o.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",e,o)})}_onPeerUpdate(t){let{peer:e,previous:n}=t.detail,o=(n?.protocols??[]).filter(s=>!e.protocols.includes(s));for(let s of o){let i=this.topologies.get(s);if(i!=null)for(let a of i.values())a.filter?.has(e.id)!==!1&&(a.filter?.remove(e.id),a.onDisconnect?.(e.id))}}_onPeerIdentify(t){let e=t.detail.protocols,n=t.detail.connection,o=t.detail.peerId;for(let s of e){let i=this.topologies.get(s);if(i!=null)for(let a of i.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(o)!==!0&&(a.filter?.add(o),a.onConnect?.(o,n))}}};var ma=class{log;components;transports;listeners;faultTolerance;started;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=St({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=St({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??He.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(t){let e=t[Symbol.toStringTag];if(e==null)throw new k("Transport must have a valid tag");if(this.transports.has(e))throw new k(`There is already a transport with the tag ${e}`);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){let t=[];for(let[e,n]of this.listeners)for(this.log("closing listeners for %s",e);n.length>0;){let o=n.pop();o!=null&&t.push(o.close())}await Promise.all(t),this.log("all listeners closed");for(let e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){let n=this.dialTransportForMultiaddr(t);if(n==null)throw new Hi(`No transport available for address ${String(t)}`);return e?.onProgress?.(new at("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(t,{...e,upgrader:this.components.upgrader})}getAddrs(){let t=[];for(let e of this.listeners.values())for(let n of e)t=[...t,...n.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(let e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(let e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new pe("Not started");if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let e={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};t.forEach(s=>{e.errors.set(s.toString(),new Ui)});let n=[];for(let[s,i]of this.transports.entries()){let a=i.listenFilter(t);for(let c of a){this.log("creating listener for %s on %a",s,c);let u=i.createListener({upgrader:this.components.upgrader}),l=this.listeners.get(s)??[];l==null&&(l=[],this.listeners.set(s,l)),l.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{let f=l.findIndex(d=>d===u);l.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),ru.matches(c)?e.ipv4.attempts++:nu.matches(c)&&e.ipv6.attempts++,n.push(u.listen(c).then(()=>{e.errors.delete(c.toString()),ru.matches(c)&&e.ipv4.success++,nu.matches(c)&&e.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,f),e.errors.set(c.toString(),f),f}))}}let o=await Promise.allSettled(n);if(!(o.length>0&&o.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(e)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===He.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new Ki(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...e.errors.entries()].map(([s,i])=>`
  ${s}: ${`${i.stack??i}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(t){if(t.ipv4.attempts===0||t.ipv6.attempts===0)return!1;let e=t.ipv4.attempts===t.ipv4.success,n=t.ipv6.success===0;return e&&n}async remove(t){let e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);let n=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){let o=e.pop();o!=null&&n.push(o.close())}await Promise.all(n),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){let t=[];for(let e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}};var gt="/multistream/1.0.0";var ga=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ya=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},ba=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Bo(r,t={}){let e=ca(r,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=ft(t.maxDataLength));let n=t?.lengthDecoder??er,o=t?.lengthEncoder??le;return{read:async i=>{let a=-1,c=new z;for(;;){c.append(await e.read({...i,bytes:1}));try{a=n(c)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new ga("Invalid message length");if(t?.maxLengthLength!=null&&c.byteLength>t.maxLengthLength)throw new ba("message length length too long");if(a>-1)break}if(t?.maxDataLength!=null&&a>t.maxDataLength)throw new ya("message length too long");return e.read({...i,bytes:a})},write:async(i,a)=>{await e.write(new z(o(i.byteLength),i),a)},writeV:async(i,a)=>{let c=new z(...i.flatMap(u=>[o(u.byteLength),u]));await e.write(c,a)},unwrap:()=>e.unwrap()}}var pw=D(`
`);async function Cr(r,t,e){await r.write(t,e)}async function Rp(r,t,e){await r.writeV(t,e)}async function mw(r,t){let e=await r.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==pw[0])throw t.log.error("Invalid mss message - missing newline",e),new jo("Missing newline");return e.sublist(0,-1)}async function ze(r,t){let e=await mw(r,t);return N(e.subarray())}async function Fo(r,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return gw(r,t[0],e);let n=Bo(r,{...e,maxDataLength:1024}),o=t.shift();if(o==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',gt,o);let s=D(`${gt}
`),i=D(`${o}
`);await Rp(n,[s,i],e),e.log.trace("select: reading multistream-select header");let a=await ze(n,e);if(e.log.trace('select: read "%s"',a),a===gt&&(e.log.trace("select: reading protocol response"),a=await ze(n,e),e.log.trace('select: read "%s"',a)),a===o)return{stream:n.unwrap(),protocol:o};for(let c of t){e.log.trace('select: write "%s"',c),await Cr(n,D(`${c}
`),e),e.log.trace("select: reading protocol response");let u=await ze(n,e);if(e.log.trace('select: read "%s" for "%s"',u,c),u===c)return{stream:n.unwrap(),protocol:c}}throw new Cn("protocol selection failed")}function gw(r,t,e){let n=r.sink.bind(r),o=r.source,s=!1,i=!1,a=ot(),c=!1,u=!1,l=ot(),f=!1,d=!1,h=ot(),p=Bo({sink:n,source:o},{...e,maxDataLength:1024});r.sink=async E=>{let{sink:_}=p.unwrap();await _(async function*(){let C=!1;for await(let b of E){if(u&&await l.promise,c)yield b;else{u=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',gt,t,b.byteLength);let L=`${t}
`;yield new z(Uint8Array.from([19]),D(`${gt}
`),le(L.length),D(L),b).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',gt,t,b.byteLength),c=!0,u=!1,l.resolve(),g().catch(R=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,R)})}C=!0}C||await g()}())};async function g(){if(i){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}i=!0;try{c||(e.log.trace("optimistic: doing send protocol for %s stream",t),await m()),f||(e.log.trace("optimistic: doing read protocol for %s stream",t),await w())}finally{i=!1,s=!0,a.resolve()}}async function m(){if(u){await l.promise;return}u=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',gt,t),await p.writeV([D(`${gt}
`),D(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',gt,t)}finally{c=!0,u=!1,l.resolve()}}async function w(){if(d){await h.promise;return}d=!0;try{e.log.trace("optimistic: reading multistream select header");let E=await ze(p,e);if(e.log.trace('optimistic: read multistream select header "%s"',E),E===gt&&(E=await ze(p,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',E,t),E!==t)throw new Cn("protocol selection failed")}finally{f=!0,d=!1,h.resolve()}}if(r.source=async function*(){await g(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),r.closeRead!=null){let E=r.closeRead.bind(r);r.closeRead=async _=>{s||await g().catch(C=>{e.log.error("could not negotiate protocol before close read",C)}),await E(_)}}if(r.closeWrite!=null){let E=r.closeWrite.bind(r);r.closeWrite=async _=>{s||await g().catch(C=>{e.log.error("could not negotiate protocol before close write",C)}),await E(_)}}if(r.close!=null){let E=r.close.bind(r);r.close=async _=>{let C=[];u&&C.push(l.promise),d&&C.push(h.promise),C.length>0?await mt(Promise.all(C),_?.signal):(s=!0,i=!1,a.resolve()),await E(_)}}return{stream:r,protocol:t}}var wa=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},_n=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},xa=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Uo=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Ea(r){return r[Symbol.asyncIterator]!=null}function kp(r,t){if(r.byteLength>t)throw new _n("Message length too long")}var _a=r=>{let t=ft(r),e=bt(t);return le(r,e),_a.bytes=t,e};_a.bytes=0;function Sa(r,t){t=t??{};let e=t.lengthEncoder??_a,n=t?.maxDataLength??4194304;function*o(s){kp(s,n);let i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return Ea(r)?async function*(){for await(let s of r)yield*o(s)}():function*(){for(let s of r)yield*o(s)}()}Sa.single=(r,t)=>{t=t??{};let e=t.lengthEncoder??_a,n=t?.maxDataLength??4194304;return kp(r,n),new z(e(r.byteLength),r)};var Ir;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Ir||(Ir={}));var ku=r=>{let t=er(r);return ku.bytes=ft(t),t};ku.bytes=0;function Ou(r,t){let e=new z,n=Ir.LENGTH,o=-1,s=t?.lengthDecoder??ku,i=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*c(){for(;e.byteLength>0;){if(n===Ir.LENGTH)try{if(o=s(e),o<0)throw new wa("Invalid message length");if(o>a)throw new _n("Message length too long");let u=s.bytes;e.consume(u),t?.onLength!=null&&t.onLength(o),n=Ir.DATA}catch(u){if(u instanceof RangeError){if(e.byteLength>i)throw new xa("Message length length too long");break}throw u}if(n===Ir.DATA){if(e.byteLength<o)break;let u=e.sublist(0,o);e.consume(o),t?.onData!=null&&t.onData(u),yield u,n=Ir.LENGTH}}}return Ea(r)?async function*(){for await(let u of r)e.append(u),yield*c();if(e.byteLength>0)throw new Uo("Unexpected end of input")}():function*(){for(let u of r)e.append(u),yield*c();if(e.byteLength>0)throw new Uo("Unexpected end of input")}()}Ou.fromReader=(r,t)=>{let e=1,n=async function*(){for(;;)try{let{done:s,value:i}=await r.next(e);if(s===!0)return;i!=null&&(yield i)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{e=1}}();return Ou(n,{...t??{},onLength:s=>{e=s}})};async function Ko(r,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);let n=Bo(r,{...e,maxDataLength:1024,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");let o=await ze(n,e);if(e.log.trace('handle: read "%s"',o),o===gt){e.log.trace('handle: respond with "%s" for "%s"',gt,o),await Cr(n,D(`${gt}
`),e),e.log.trace('handle: responded with "%s" for "%s"',gt,o);continue}if(t.includes(o))return e.log.trace('handle: respond with "%s" for "%s"',o,o),await Cr(n,D(`${o}
`),e),e.log.trace('handle: responded with "%s" for "%s"',o,o),{stream:n.unwrap(),protocol:o};if(o==="ls"){let s=new z(...t.map(i=>Sa.single(D(`${i}
`))),D(`
`));e.log.trace('handle: respond with "%s" for %s',t,o),await Cr(n,s,e),e.log.trace('handle: responded with "%s" for %s',t,o);continue}e.log.trace('handle: respond with "na" for "%s"',o),await Cr(n,D(`na
`),e),e.log('handle: responded with "na" for "%s"',o)}}var ww=500,Mu=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(t){let{remoteAddr:e,remotePeer:n,newStream:o,close:s,abort:i,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=n,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.limits=t.limits,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=o,this._close=s,this._abort=i,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[Bu]=!0;get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new $o("the connection is being closed");if(this.status==="closed")throw new Rr("the connection is closed");if(Array.isArray(t)||(t=[t]),this.limits!=null&&e?.runOnLimitedConnection!==!0)throw new Mr("Cannot open protocol stream on limited connection");let n=await this._newStream(t,e);return n.direction="outbound",n}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){let e=AbortSignal.timeout(ww);t={...t,signal:e}}try{this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this._abort(t),this.status="closed",this.timeline.close=Date.now())}};function Mp(r){return new Mu(r)}function Ew(r,t){try{let{options:e}=t.getHandler(r);return e.maxInboundStreams}catch(e){if(e.name!=="UnhandledProtocolError")throw e}return Du}function vw(r,t,e={}){try{let{options:n}=t.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return e.maxOutboundStreams??Lu}function Np(r,t,e){let n=0;return e.streams.forEach(o=>{o.direction===t&&o.protocol===r&&n++}),n}var Aa=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(t,e){this.components=t,this.connectionEncrypters=St({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),e.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=St({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),e.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=e.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=e.outboundStreamProtocolNegotiationTimeout??1e4,this.events=t.events,this.metrics={dials:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(t,...e){let n=this.components.connectionGater[t];if(n==null)return;if(await n.apply(this.components.connectionGater,e)===!0)throw new zi(`The multiaddr connection is blocked by gater.${t}`)}createInboundAbortSignal(t){let e=Ie([AbortSignal.timeout(this.inboundUpgradeTimeout),t]);return e}async upgradeInbound(t,e){let n=!1,o=this.createInboundAbortSignal(e.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await mt(this.components.connectionManager.acceptIncomingConnection(t),o),!n)throw new Vi("Connection denied");await mt(this.shouldBlockConnection("denyInboundConnection",t),o),await this._performUpgrade(t,"inbound",{...e,signal:o})}catch(s){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[s.name??"Error"]:!0}),s}finally{o.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){try{this.metrics.dials?.increment({outbound:!0});let n=t.remoteAddr.getPeerId(),o;n!=null&&(o=fe(n),await mt(this.shouldBlockConnection("denyOutboundConnection",o,t),e.signal));let s="outbound";return e.initiator===!1&&(s="inbound"),await this._performUpgrade(t,s,e)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(t,e,n){let o,s,i,a,c;this.components.metrics?.trackMultiaddrConnection(t),t.log.trace("starting the %s connection upgrade",e);let u=t;if(n?.skipProtection!==!0){let l=this.components.connectionProtector;l!=null&&(t.log("protecting the %s connection",e),u=await l.protect(t,n))}try{if(o=u,n?.skipEncryption!==!0){n?.onProgress?.(new at(`upgrader:encrypt-${e}-connection`)),{conn:o,remotePeer:s,protocol:c,streamMuxer:a}=await(e==="inbound"?this._encryptInbound(u,n):this._encryptOutbound(u,n));let l={...u,...o};await this.shouldBlockConnection(e==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,l)}else{let l=t.remoteAddr.getPeerId();if(l==null)throw new Pe(`${e} connection that skipped encryption must have a peer id`);let f=fe(l);c="native",s=f}if(s.equals(this.components.peerId)){let l=new Or("Can not dial self");throw t.abort(l),l}if(i=o,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new at(`upgrader:multiplex-${e}-connection`));let l=await(e==="inbound"?this._multiplexInbound({...u,...o},this.streamMuxers,n):this._multiplexOutbound({...u,...o},this.streamMuxers,n));a=l.muxerFactory,i=l.stream}}catch(l){throw t.log.error("failed to upgrade inbound connection %s %a - %e",e==="inbound"?"from":"to",t.remoteAddr,l),l}return await this.shouldBlockConnection(e==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,t),t.log("successfully upgraded %s connection",e),this._createConnection({cryptoProtocol:c,direction:e,maConn:t,upgradedConn:i,muxerFactory:a,remotePeer:s,limits:n?.limits})}_createConnection(t){let{cryptoProtocol:e,direction:n,maConn:o,upgradedConn:s,remotePeer:i,muxerFactory:a,limits:c}=t,u,l,f;a!=null&&(u=a.createStreamMuxer({direction:n,onIncomingStream:p=>{if(f==null)return;let g=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{let m=this.components.registrar.getProtocols(),{stream:w,protocol:E}=await Ko(p,m,{signal:g,log:p.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",E);let _=Ew(E,this.components.registrar);if(Np(E,"inbound",f)===_){let b=new Xo(`Too many inbound protocol streams for protocol "${E}" - limit ${_}`);throw p.abort(b),b}p.source=w.source,p.sink=w.sink,p.protocol=E,w.closeWrite!=null&&(p.closeWrite=w.closeWrite),w.closeRead!=null&&(p.closeRead=w.closeRead),w.close!=null&&(p.close=w.close),await this.components.peerStore.merge(i,{protocols:[E]},{signal:g}),this.components.metrics?.trackProtocolStream(p,f),this._onStream({connection:f,stream:p,protocol:E})}).catch(async m=>{f.log.error("error handling incoming stream id %s - %e",p.id,m),p.timeline.close==null&&await p.close({signal:g}).catch(w=>p.abort(w))})}}),l=async(p,g={})=>{if(u==null)throw new _r("Connection is not multiplexed");f.log.trace("starting new stream for protocols %s",p);let m=await u.newStream();f.log.trace("started new stream %s for protocols %s",m.id,p);try{if(g.signal==null){m.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p);let b=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:b}}m.log.trace("selecting protocol from protocols %s",p);let{stream:w,protocol:E}=await Fo(m,p,{...g,log:m.log,yieldBytes:!0});m.log.trace("selected protocol %s",E);let _=vw(E,this.components.registrar,g),C=Np(E,"outbound",f);if(C>=_){let b=new Qo(`Too many outbound protocol streams for protocol "${E}" - ${C}/${_}`);throw m.abort(b),b}return await this.components.peerStore.merge(i,{protocols:[E]}),m.source=w.source,m.sink=w.sink,m.protocol=E,w.closeWrite!=null&&(m.closeWrite=w.closeWrite),w.closeRead!=null&&(m.closeRead=w.closeRead),w.close!=null&&(m.close=w.close),this.components.metrics?.trackProtocolStream(m,f),m}catch(w){throw f.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",t.maConn.remoteAddr,p,w),m.timeline.close==null&&m.abort(w),w}},Promise.all([u.sink(s.source),s.sink(u.source)]).catch(p=>{f.log.error("error piping data through muxer - %e",p)}));let d=o.timeline;o.timeline=new Proxy(d,{set:(...p)=>(p[1]==="close"&&p[2]!=null&&d.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(g){f.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(g=>{f.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...p))}),o.timeline.upgraded=Date.now();let h=()=>{throw new _r("Connection is not multiplexed")};return f=Mp({remoteAddr:o.remoteAddr,remotePeer:i,status:"open",direction:n,timeline:o.timeline,multiplexer:u?.protocol,encryption:e,limits:c,logger:this.components.logger,newStream:l??h,getStreams:()=>u?.streams??[],close:async p=>{await u?.close(p),await o.close(p)},abort:p=>{o.abort(p),u?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f.__maConnTimeline=d,f}_onStream(t){let{connection:e,stream:n,protocol:o}=t,{handler:s,options:i}=this.components.registrar.getHandler(o);if(e.limits!=null&&i.runOnLimitedConnection!==!0)throw new Mr("Cannot open protocol stream on limited connection");s({connection:e,stream:n})}async _encryptInbound(t,e){let n=Array.from(this.connectionEncrypters.keys());try{let{stream:o,protocol:s}=await Ko(t,n,{...e,log:t.log}),i=this.connectionEncrypters.get(s);if(i==null)throw new Sr(`no crypto module found for ${s}`);return t.log("encrypting inbound connection to %a using %s",t.remoteAddr,s),{...await i.secureInbound(o,e),protocol:s}}catch(o){throw t.log.error("encrypting inbound connection from %a failed",t.remoteAddr,o),new Sr(o.message)}}async _encryptOutbound(t,e){let n=Array.from(this.connectionEncrypters.keys());try{t.log.trace("selecting encrypter from %s",n);let{stream:o,protocol:s}=await Fo(t,n,{...e,log:t.log,yieldBytes:!0}),i=this.connectionEncrypters.get(s);if(i==null)throw new Sr(`no crypto module found for ${s}`);return t.log("encrypting outbound connection to %a using %s",t.remoteAddr,s),{...await i.secureOutbound(o,e),protocol:s}}catch(o){throw t.log.error("encrypting outbound connection to %a failed",t.remoteAddr,o),new Sr(o.message)}}async _multiplexOutbound(t,e,n){let o=Array.from(e.keys());t.log("outbound selecting muxer %s",o);try{t.log.trace("selecting stream muxer from %s",o);let{stream:s,protocol:i}=await Fo(t,o,{...n,log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",i);let a=e.get(i);return{stream:s,muxerFactory:a}}catch(s){throw t.log.error("error multiplexing outbound connection",s),new _r(String(s))}}async _multiplexInbound(t,e,n){let o=Array.from(e.keys());t.log("inbound handling muxers %s",o);try{let{stream:s,protocol:i}=await Ko(t,o,{...n,log:t.log}),a=e.get(i);return{stream:s,muxerFactory:a}}catch(s){throw t.log.error("error multiplexing inbound connection",s),new _r(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};var Ca="2.9.0",Ia="js-libp2p";function Fp(r,t){return`${r??Ia}/${t??Ca} browser/${globalThis.navigator.userAgent}`}var qo=class extends Bt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(t){super(),this.status="stopped";let e=new Bt,n=e.dispatchEvent.bind(e);e.dispatchEvent=u=>{let l=n(u),f=this.dispatchEvent(new CustomEvent(u.type,{detail:u.detail}));return l||f},this.peerId=t.peerId,this.logger=t.logger??$s(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=t.nodeInfo?.name??Ia,s=t.nodeInfo?.version??Ca,i=this.components=dp({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:o,version:s,userAgent:t.nodeInfo?.userAgent??Fp(o,s)},logger:this.logger,events:e,datastore:t.datastore??new vi,connectionGater:pp(t.connectionGater),dns:t.dns});t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",Zh(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),i.events.addEventListener("peer:update",u=>{if(u.detail.previous==null){let l={id:u.detail.peer.id,multiaddrs:u.detail.peer.addresses.map(f=>f.multiaddr)};i.events.safeDispatchEvent("peer:discovery",{detail:l})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(i)),this.components.upgrader=new Aa(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((u,l)=>this.configureComponent(`connection-encryption-${l}`,u(this.components))),streamMuxers:(t.streamMuxers??[]).map((u,l)=>this.configureComponent(`stream-muxers-${l}`,u(this.components))),inboundUpgradeTimeout:t.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:t.connectionManager?.inboundStreamProtocolNegotiationTimeout??t.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:t.connectionManager?.outboundStreamProtocolNegotiationTimeout??t.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new ma(this.components,t.transportManager)),this.configureComponent("connectionManager",new oa(this.components,t.connectionManager)),t.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new la(this.components,t.connectionMonitor)),this.configureComponent("registrar",new pa(this.components)),this.configureComponent("addressManager",new Oi(this.components,t.addresses));let a=(t.peerRouters??[]).map((u,l)=>this.configureComponent(`peer-router-${l}`,u(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new da(this.components,{routers:a}));let c=(t.contentRouters??[]).map((u,l)=>this.configureComponent(`content-router-${l}`,u(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new ua(this.components,{routers:c})),this.configureComponent("randomWalk",new ha(this.components)),(t.peerDiscovery??[]).forEach((u,l)=>{this.configureComponent(`peer-discovery-${l}`,u(this.components)).addEventListener("peer",d=>{this.#t(d)})}),t.transports?.forEach((u,l)=>{this.components.transportManager.add(this.configureComponent(`transport-${l}`,u(this.components)))}),t.services!=null)for(let u of Object.keys(t.services)){let l=t.services[u],f=l(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",u);continue}this.services[u]=f,this.configureComponent(u,f),f[Pa]!=null&&(this.log("registering service %s for content routing",u),c.push(f[Pa])),f[La]!=null&&(this.log("registering service %s for peer routing",u),a.push(f[La])),f[Da]!=null&&(this.log("registering service %s for peer discovery",u),f[Da].addEventListener?.("peer",d=>{this.#t(d)}))}hp(i)}configureComponent(t,e){return e==null&&this.log.error("component %s was null or undefined",t),this.components[t]=e,e}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(t){throw this.log.error("An error occurred starting libp2p",t),this.status="started",await this.stop(),t}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let t=new hr;for(let e of this.components.connectionManager.getConnections())t.add(e.remotePeer);return Array.from(t)}async dial(t,e={}){return this.components.connectionManager.openConnection(t,{priority:75,...e})}async dialProtocol(t,e,n={}){if(e==null)throw new k("no protocols were provided to open a stream");if(e=Array.isArray(e)?e:[e],e.length===0)throw new k("no protocols were provided to open a stream");return(await this.dial(t,n)).newStream(e,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,e={}){Ke(t)&&(t=fe(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,e)}async getPublicKey(t,e={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{let i=await this.peerStore.get(t,e);if(i.id.publicKey!=null)return i.id.publicKey}catch(i){if(i.name!=="NotFoundError")throw i}let n=Xt([D("/pk/"),t.toMultihash().bytes]),o=await this.contentRouting.get(n,e),s=nn(o);return await this.peerStore.patch(t,{publicKey:s},e),s}async handle(t,e,n){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async o=>{await this.components.registrar.handle(o,e,n)}))}async unhandle(t,e){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async n=>{await this.components.registrar.unhandle(n,e)}))}async register(t,e,n){return this.components.registrar.register(t,e,n)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,e={}){return this.components.connectionManager.isDialable(t,e)}#t(t){let{detail:e}=t;if(e.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(e.id,{multiaddrs:e.multiaddrs}).catch(n=>{this.log.error(n)})}};async function _w(r={}){r.privateKey??=await Kd("Ed25519");let t=new qo({...await _h(r),peerId:Hd(r.privateKey)});return r.start!==!1&&await t.start(),t}var Sw=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function Aw(r){return r==null?!1:r instanceof qo?!0:Sw.every(t=>typeof r[t]=="function")}return Hp(Cw);})();
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/utils.js:
@noble/curves/esm/abstract/modular.js:
@noble/curves/esm/abstract/curve.js:
@noble/curves/esm/abstract/edwards.js:
@noble/curves/esm/ed25519.js:
@noble/curves/esm/abstract/weierstrass.js:
@noble/curves/esm/_shortw_utils.js:
@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
return Libp2P}));
//# sourceMappingURL=index.min.js.map
