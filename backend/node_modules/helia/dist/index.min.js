(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Helia = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Helia=(()=>{var aD=Object.create;var x1=Object.defineProperty;var cD=Object.getOwnPropertyDescriptor;var lD=Object.getOwnPropertyNames;var uD=Object.getPrototypeOf,fD=Object.prototype.hasOwnProperty;var Dr=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),kt=(r,e)=>{for(var t in e)x1(r,t,{get:e[t],enumerable:!0})},Nb=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of lD(e))!fD.call(r,o)&&o!==t&&x1(r,o,{get:()=>e[o],enumerable:!(n=cD(e,o))||n.enumerable});return r};var tr=(r,e,t)=>(t=r!=null?aD(uD(r)):{},Nb(e||!r||!r.__esModule?x1(t,"default",{value:r,enumerable:!0}):t,r)),dD=r=>Nb(x1({},"__esModule",{value:!0}),r);var qb=Dr((pW,A4)=>{"use strict";var qD=Object.prototype.hasOwnProperty,Gr="~";function yd(){}Object.create&&(yd.prototype=Object.create(null),new yd().__proto__||(Gr=!1));function HD(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function Vb(r,e,t,n,o){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new HD(t,n||r,o),s=Gr?Gr+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],i]:r._events[s].push(i):(r._events[s]=i,r._eventsCount++),r}function N1(r,e){--r._eventsCount===0?r._events=new yd:delete r._events[e]}function Lr(){this._events=new yd,this._eventsCount=0}Lr.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)qD.call(t,n)&&e.push(Gr?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Lr.prototype.listeners=function(e){var t=Gr?Gr+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,s=new Array(i);o<i;o++)s[o]=n[o].fn;return s};Lr.prototype.listenerCount=function(e){var t=Gr?Gr+e:e,n=this._events[t];return n?n.fn?1:n.length:0};Lr.prototype.emit=function(e,t,n,o,i,s){var a=Gr?Gr+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,o),!0;case 5:return c.fn.call(c.context,t,n,o,i),!0;case 6:return c.fn.call(c.context,t,n,o,i,s),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var d=c.length,p;for(f=0;f<d;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,o);break;default:if(!u)for(p=1,u=new Array(l-1);p<l;p++)u[p-1]=arguments[p];c[f].fn.apply(c[f].context,u)}}return!0};Lr.prototype.on=function(e,t,n){return Vb(this,e,t,n,!1)};Lr.prototype.once=function(e,t,n){return Vb(this,e,t,n,!0)};Lr.prototype.removeListener=function(e,t,n,o){var i=Gr?Gr+e:e;if(!this._events[i])return this;if(!t)return N1(this,i),this;var s=this._events[i];if(s.fn)s.fn===t&&(!o||s.once)&&(!n||s.context===n)&&N1(this,i);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||o&&!s[a].once||n&&s[a].context!==n)&&c.push(s[a]);c.length?this._events[i]=c.length===1?c[0]:c:N1(this,i)}return this};Lr.prototype.removeAllListeners=function(e){var t;return e?(t=Gr?Gr+e:e,this._events[t]&&N1(this,t)):(this._events=new yd,this._eventsCount=0),this};Lr.prototype.off=Lr.prototype.removeListener;Lr.prototype.addListener=Lr.prototype.on;Lr.prefixed=Gr;Lr.EventEmitter=Lr;typeof A4<"u"&&(A4.exports=Lr)});var cv=Dr((bz,av)=>{av.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function o(i,s){t[i]=s,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var s=t[i];if(s!==void 0)return s;if((s=n[i])!==void 0)return o(i,s),s},set:function(i,s){t[i]!==void 0?t[i]=s:o(i,s)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var k_=Dr(wp=>{(function(){var r,e,t,n,o,i,s,a;a=function(c){var l,u,f,d;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,d=c&255,[l,u,f,d].join(".")},s=function(c){var l,u,f,d,p,m;for(l=[],f=d=0;d<=3&&c.length!==0;f=++d){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),p=m[0],u=m[1],c=c.substring(u),l.push(p)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),o=t("A"),e=function(c){var l,u,f,d,p;for(d=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),p=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)d=d*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")d=d*l+(10+t(c[f])-i)>>>0;else if("A"<=c[f]&&c[f]<="F")d=d*l+(10+t(c[f])-o)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");f++}if(f===p)throw new Error("empty octet");return[d,f]},r=function(){function c(l,u){var f,d,p,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(m=l.split("/",2),l=m[0],u=m[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=s(u)}catch(g){throw f=g,new Error("Invalid mask: "+u)}for(d=p=32;p>=0;d=--p)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(s(l)&this.maskLong)>>>0}catch(g){throw f=g,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(s(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,d;for(d=s(this.first),f=s(this.last),u=0;d<=f;)l(a(d),d,u),u++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),wp.ip2long=s,wp.long2ip=a,wp.Netmask=r}).call(wp)});var G0=Dr((zse,k8)=>{var Wse=function(){typeof k8<"u"&&(k8.exports=g);var r=86400,e=3200,t=146097*e/400,n=r*t,o=1e3*n,i=864e13,s=4294967296,a=1e6,c="000000000",l=Math.trunc||function($){var B=$-$%1;return B==0&&($<0||$===0&&1/$!=1/0)?-0:B},u=g.prototype,f=(g.fromDate=function($){return new g(+$)},g.fromInt64BE=U(0,1,2,3,0,4),g.fromInt64LE=U(3,2,1,0,4,0),g.fromString=function(x){var B,S=new g,x=(x+="").replace(/^\s*[+\-]?\d+/,function(k){var k=+k,F=1970+(k-1970)%400;return S.year=k-F,F}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(P,k,F){return k<0&&(F*=-1),B=6e4*(60*+k+ +F),""}).replace(/\.\d+$/,function(P){return S.nano=+(P+c).substr(1,9),""}).split(/\D+/);if(1<x.length?x[1]--:x[1]=0,S.time=B=Date.UTC.apply(Date,x)-(B||0),isNaN(B))throw new TypeError("Invalid Date");return y(S)},g.fromTimeT=function($){return C($,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function($){return this.nano+=+$||0,this},u.getNano=function(){var $=y(this);return($.time%1e3*a+ +$.nano+1e9)%1e9},u.getTimeT=function(){var B=y(this),$=Math.floor(B.time/1e3),B=B.year;return B&&($+=B*t*r/e),$},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return b(y(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function($){var B=this,S=B.toDate(),x={H:function(){return K(S.getUTCHours())},L:function(){return ee(S.getUTCMilliseconds(),3)},M:function(){return K(S.getUTCMinutes())},N:function(){return ee(B.getNano(),9)},S:function(){return K(S.getUTCSeconds())},Y:function(){var P=B.getYear();return 999999<P?"+"+P:9999<P?"+"+ee(P,6):0<=P?ee(P,4):-999999<=P?"-"+ee(-P,6):P},a:function(){return p[S.getUTCDay()]},b:function(){return d[S.getUTCMonth()]},d:function(){return K(S.getUTCDate())},e:function(){return function(P){return(9<P?"":" ")+(0|P)}(S.getUTCDate())},m:function(){return K(S.getUTCMonth()+1)}};return function P(k){return k.replace(/%./g,function(F){var T=F[1],H=m[T],T=x[T];return H?P(H):T?T():F})}($||f)},u.writeInt64BE=D(0,1,2,3,0,4),u.writeInt64LE=D(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return g;function g($,B,S){var x=this;if(!(x instanceof g))return new g($,B,S);x.time=+$||0,x.nano=+B||0,x.year=+S||0,y(x)}function y($){var B,S,x,P=$.year,k=$.time,F=$.nano,H=((F<0||a<=F)&&(F-=(S=Math.floor(F/a))*a,k+=S,S=1),P%e);return(k<-i||i<k||H)&&((B=l(k/o))&&(P+=B*e,k-=B*o),(x=b(k)).setUTCFullYear(H+x.getUTCFullYear()),x=(k=+x)+(B=l((P-=H)/e))*o,B&&-i<=x&&x<=i&&(P-=B*e,k=x),S=1),S&&($.year=P,$.time=k,$.nano=F),$}function b($){var B=new Date(0);return B.setTime($),B}function C(P,x){P=+P||0;var S=l((x=(x|0)*s)/n)+l(P/n),x=x%n+P%n,P=l(x/n);return P&&(S+=P,x-=P*n),new g(1e3*x,0,S*e)}function D($,B,S,x,P,k){return function(H,T){var j=y(this);H=H||new Array(8),X(H,T|=0);var N=Math.floor(j.time/1e3),j=j.year*(t*r/e),I=l(j/s)+l(N/s),j=j%s+N%s,N=Math.floor(j/s);return N&&(I+=N,j-=N*s),F(H,T+P,I),F(H,T+k,j),H};function F(H,T,I){H[T+$]=I>>24&255,H[T+B]=I>>16&255,H[T+S]=I>>8&255,H[T+x]=255&I}}function U($,B,S,x,P,k){return function(H,T){X(H,T|=0);var I=F(H,T+P);return C(F(H,T+k),I)};function F(H,T){return 16777216*H[T+$]+(H[T+B]<<16|H[T+S]<<8|H[T+x])}}function X($,B){if($=$&&$.length,$==null)throw new TypeError("Invalid Buffer");if($<B+8)throw new RangeError("Out of range")}function K($){return(9<$?"":"0")+(0|$)}function ee($,B){return(c+(0|$)).substr(-B)}}()});var WA=Dr((mpe,HA)=>{function uo(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}HA.exports=uo;uo.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};uo.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};uo.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};uo.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};uo.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};uo.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};uo.prototype.start=uo.prototype.try;uo.prototype.errors=function(){return this._errors};uo.prototype.attempts=function(){return this._attempts};uo.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var o=this._errors[n],i=o.message,s=(r[i]||0)+1;r[i]=s,s>=t&&(e=o,t=s)}return e}});var zA=Dr(qc=>{var jj=WA();qc.operation=function(r){var e=qc.timeouts(r);return new jj(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};qc.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],o=0;o<e.retries;o++)n.push(this.createTimeout(o,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(o,e)),n.sort(function(i,s){return i-s}),n};qc.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};qc.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var o=0;o<t.length;o++){var i=t[o],s=r[i];r[i]=function(c){var l=qc.operation(e),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(d){l.retry(d)||(d&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,s),r[i].options=e}}});var XA=Dr((gpe,GA)=>{GA.exports=zA()});var cT=Dr((z1e,aT)=>{"use strict";function fK(r){return r>=55296&&r<=56319}function dK(r){return r>=56320&&r<=57343}aT.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var o=t.length,i=0,s,a,c=0;c<o;c+=1){if(s=t.charCodeAt(c),a=t[c],fK(s)&&dK(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t}});var uT=Dr((G1e,lT)=>{"use strict";function pK(r){return r>=55296&&r<=56319}function hK(r){return r>=56320&&r<=57343}lT.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,o=null,i=null,s=0;s<t;s++)o=e.charCodeAt(s),hK(o)?i!=null&&pK(i)?n+=1:n+=3:o<=127?n+=1:o>=128&&o<=2047?n+=2:o>=2048&&o<=65535&&(n+=3),i=o;return n}});var dT=Dr((X1e,fT)=>{"use strict";var mK=cT(),yK=uT();fT.exports=mK.bind(null,yK)});var mT=Dr((Y1e,hT)=>{"use strict";var gK=dT(),wK=/[\/\?<>\\:\*\|"]/g,bK=/[\x00-\x1f\x80-\x9f]/g,vK=/^\.+$/,xK=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,EK=/[\. ]+$/;function pT(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(wK,e).replace(bK,e).replace(vK,e).replace(xK,e).replace(EK,e);return gK(t,255)}hT.exports=function(r,e){var t=e&&e.replacement||"",n=pT(r,t);return t===""?n:pT(n,"")}});var vs=Dr(ff=>{"use strict";var _K="[object ArrayBuffer]",bs=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===_K}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),o=r.toUint8Array(t);if(n.length!==o.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==o[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let s of t)n+=s.byteLength;let o=new Uint8Array(n),i=0;for(let s of t){let a=this.toUint8Array(s);o.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(o,e[e.length-1]):o.buffer}},y7="string",AK=/^[0-9a-f\s]+$/i,TK=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,IK=/^[a-zA-Z0-9-_]+$/,oy=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return n.buffer}static toString(e){let t=bs.toUint8Array(e),n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}},fo=class{static toString(e,t=!1){let n=bs.toArrayBuffer(e),o=new DataView(n),i="";for(let s=0;s<n.byteLength;s+=2){let a=o.getUint16(s,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),o=new DataView(n);for(let i=0;i<e.length;i++)o.setUint16(i*2,e.charCodeAt(i),t);return n}},iy=class r{static isHex(e){return typeof e===y7&&AK.test(e)}static isBase64(e){return typeof e===y7&&TK.test(e)}static isBase64Url(e){return typeof e===y7&&IK.test(e)}static ToString(e,t="utf8"){let n=bs.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return fo.toString(n,!0);case"utf16":case"utf16be":return fo.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return fo.fromString(e,!0);case"utf16":case"utf16be":return fo.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=bs.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return oy.fromString(e);case"utf16":case"utf16be":return fo.fromString(e);case"utf16le":case"usc2":return fo.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return oy.toString(e);case"utf16":case"utf16be":return fo.toString(e);case"utf16le":case"usc2":return fo.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n.buffer}static ToBinary(e){let t=bs.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return n}static ToHex(e){let t=bs.toUint8Array(e),n="",o=t.length;for(let i=0;i<o;i++){let s=t[i];s<16&&(n+="0"),n+=s.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let o=0;o<t.length;o=o+2){let i=t.slice(o,o+2);n[o/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return fo.toString(e,t)}static FromUtf16String(e,t=!1){return fo.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};iy.DEFAULT_UTF8_ENCODING="utf8";function CK(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let o=arguments[n];for(let i in o)t[i]=o[i]}return t}function PK(...r){let e=r.map(o=>o.byteLength).reduce((o,i)=>o+i),t=new Uint8Array(e),n=0;return r.map(o=>new Uint8Array(o)).forEach(o=>{for(let i of o)t[n++]=i}),t.buffer}function kK(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}ff.BufferSourceConverter=bs;ff.Convert=iy;ff.assign=CK;ff.combine=PK;ff.isEqual=kK});var HP=Dr(()=>{var qP;(function(r){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),n=o(r);typeof t.Reflect<"u"&&(n=o(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function o(c,l){return function(u,f){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:f}),l&&l(u,f)}}function i(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||s()}})(function(e,t){var n=Object.prototype.hasOwnProperty,o=typeof Symbol=="function",i=o&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=o&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return m4(Object.create(null))}:c?function(){return m4({__proto__:null})}:function(){return m4({})},has:l?function(_,O){return n.call(_,O)}:function(_,O){return O in _},get:l?function(_,O){return n.call(_,O)?_[O]:void 0}:function(_,O){return _[O]}},f=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:rD(),p=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:nD(),m=typeof WeakMap=="function"?WeakMap:oD(),g=o?Symbol.for("@reflect-metadata:registry"):void 0,y=JR(),b=eD(y);function C(_,O,V,Z){if(z(V)){if(!li(_))throw new TypeError;if(!To(O))throw new TypeError;return P(_,O)}else{if(!li(_))throw new TypeError;if(!ke(O))throw new TypeError;if(!ke(Z)&&!z(Z)&&!Pe(Z))throw new TypeError;return Pe(Z)&&(Z=void 0),V=qt(V),k(_,O,V,Z)}}e("decorate",C);function D(_,O){function V(Z,be){if(!ke(Z))throw new TypeError;if(!z(be)&&!Xa(be))throw new TypeError;j(_,O,Z,be)}return V}e("metadata",D);function U(_,O,V,Z){if(!ke(V))throw new TypeError;return z(Z)||(Z=qt(Z)),j(_,O,V,Z)}e("defineMetadata",U);function X(_,O,V){if(!ke(O))throw new TypeError;return z(V)||(V=qt(V)),F(_,O,V)}e("hasMetadata",X);function K(_,O,V){if(!ke(O))throw new TypeError;return z(V)||(V=qt(V)),H(_,O,V)}e("hasOwnMetadata",K);function ee(_,O,V){if(!ke(O))throw new TypeError;return z(V)||(V=qt(V)),T(_,O,V)}e("getMetadata",ee);function $(_,O,V){if(!ke(O))throw new TypeError;return z(V)||(V=qt(V)),I(_,O,V)}e("getOwnMetadata",$);function B(_,O){if(!ke(_))throw new TypeError;return z(O)||(O=qt(O)),N(_,O)}e("getMetadataKeys",B);function S(_,O){if(!ke(_))throw new TypeError;return z(O)||(O=qt(O)),te(_,O)}e("getOwnMetadataKeys",S);function x(_,O,V){if(!ke(O))throw new TypeError;if(z(V)||(V=qt(V)),!ke(O))throw new TypeError;z(V)||(V=qt(V));var Z=hd(O,V,!1);return z(Z)?!1:Z.OrdinaryDeleteMetadata(_,O,V)}e("deleteMetadata",x);function P(_,O){for(var V=_.length-1;V>=0;--V){var Z=_[V],be=Z(O);if(!z(be)&&!Pe(be)){if(!To(be))throw new TypeError;O=be}}return O}function k(_,O,V,Z){for(var be=_.length-1;be>=0;--be){var Ut=_[be],er=Ut(O,V,Z);if(!z(er)&&!Pe(er)){if(!ke(er))throw new TypeError;Z=er}}return Z}function F(_,O,V){var Z=H(_,O,V);if(Z)return!0;var be=h4(O);return Pe(be)?!1:F(_,be,V)}function H(_,O,V){var Z=hd(O,V,!1);return z(Z)?!1:dt(Z.OrdinaryHasOwnMetadata(_,O,V))}function T(_,O,V){var Z=H(_,O,V);if(Z)return I(_,O,V);var be=h4(O);if(!Pe(be))return T(_,be,V)}function I(_,O,V){var Z=hd(O,V,!1);if(!z(Z))return Z.OrdinaryGetOwnMetadata(_,O,V)}function j(_,O,V,Z){var be=hd(V,Z,!0);be.OrdinaryDefineOwnMetadata(_,O,V,Z)}function N(_,O){var V=te(_,O),Z=h4(_);if(Z===null)return V;var be=N(Z,O);if(be.length<=0)return V;if(V.length<=0)return be;for(var Ut=new p,er=[],Fe=0,se=V;Fe<se.length;Fe++){var fe=se[Fe],pe=Ut.has(fe);pe||(Ut.add(fe),er.push(fe))}for(var ye=0,je=be;ye<je.length;ye++){var fe=je[ye],pe=Ut.has(fe);pe||(Ut.add(fe),er.push(fe))}return er}function te(_,O){var V=hd(_,O,!1);return V?V.OrdinaryOwnMetadataKeys(_,O):[]}function oe(_){if(_===null)return 1;switch(typeof _){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return _===null?1:6;default:return 6}}function z(_){return _===void 0}function Pe(_){return _===null}function Le(_){return typeof _=="symbol"}function ke(_){return typeof _=="object"?_!==null:typeof _=="function"}function Ne(_,O){switch(oe(_)){case 0:return _;case 1:return _;case 2:return _;case 3:return _;case 4:return _;case 5:return _}var V=O===3?"string":O===5?"number":"default",Z=Cb(_,i);if(Z!==void 0){var be=Z.call(_,V);if(ke(be))throw new TypeError;return be}return ze(_,V==="default"?"number":V)}function ze(_,O){if(O==="string"){var V=_.toString;if(dr(V)){var Z=V.call(_);if(!ke(Z))return Z}var be=_.valueOf;if(dr(be)){var Z=be.call(_);if(!ke(Z))return Z}}else{var be=_.valueOf;if(dr(be)){var Z=be.call(_);if(!ke(Z))return Z}var Ut=_.toString;if(dr(Ut)){var Z=Ut.call(_);if(!ke(Z))return Z}}throw new TypeError}function dt(_){return!!_}function Vt(_){return""+_}function qt(_){var O=Ne(_,3);return Le(O)?O:Vt(O)}function li(_){return Array.isArray?Array.isArray(_):_ instanceof Object?_ instanceof Array:Object.prototype.toString.call(_)==="[object Array]"}function dr(_){return typeof _=="function"}function To(_){return typeof _=="function"}function Xa(_){switch(oe(_)){case 3:return!0;case 4:return!0;default:return!1}}function Fi(_,O){return _===O||_!==_&&O!==O}function Cb(_,O){var V=_[O];if(V!=null){if(!dr(V))throw new TypeError;return V}}function Pb(_){var O=Cb(_,s);if(!dr(O))throw new TypeError;var V=O.call(_);if(!ke(V))throw new TypeError;return V}function kb(_){return _.value}function Ob(_){var O=_.next();return O.done?!1:O}function Rb(_){var O=_.return;O&&O.call(_)}function h4(_){var O=Object.getPrototypeOf(_);if(typeof _!="function"||_===f||O!==f)return O;var V=_.prototype,Z=V&&Object.getPrototypeOf(V);if(Z==null||Z===Object.prototype)return O;var be=Z.constructor;return typeof be!="function"||be===_?O:be}function ZR(){var _;!z(g)&&typeof t.Reflect<"u"&&!(g in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(_=tD(t.Reflect));var O,V,Z,be=new m,Ut={registerProvider:er,getProvider:se,setProvider:pe};return Ut;function er(ye){if(!Object.isExtensible(Ut))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case _===ye:break;case z(O):O=ye;break;case O===ye:break;case z(V):V=ye;break;case V===ye:break;default:Z===void 0&&(Z=new p),Z.add(ye);break}}function Fe(ye,je){if(!z(O)){if(O.isProviderFor(ye,je))return O;if(!z(V)){if(V.isProviderFor(ye,je))return O;if(!z(Z))for(var gt=Pb(Z);;){var Ft=Ob(gt);if(!Ft)return;var Io=kb(Ft);if(Io.isProviderFor(ye,je))return Rb(gt),Io}}}if(!z(_)&&_.isProviderFor(ye,je))return _}function se(ye,je){var gt=be.get(ye),Ft;return z(gt)||(Ft=gt.get(je)),z(Ft)&&(Ft=Fe(ye,je),z(Ft)||(z(gt)&&(gt=new d,be.set(ye,gt)),gt.set(je,Ft))),Ft}function fe(ye){if(z(ye))throw new TypeError;return O===ye||V===ye||!z(Z)&&Z.has(ye)}function pe(ye,je,gt){if(!fe(gt))throw new Error("Metadata provider not registered.");var Ft=se(ye,je);if(Ft!==gt){if(!z(Ft))return!1;var Io=be.get(ye);z(Io)&&(Io=new d,be.set(ye,Io)),Io.set(je,gt)}return!0}}function JR(){var _;return!z(g)&&ke(t.Reflect)&&Object.isExtensible(t.Reflect)&&(_=t.Reflect[g]),z(_)&&(_=ZR()),!z(g)&&ke(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,g,{enumerable:!1,configurable:!1,writable:!1,value:_}),_}function eD(_){var O=new m,V={isProviderFor:function(fe,pe){var ye=O.get(fe);return z(ye)?!1:ye.has(pe)},OrdinaryDefineOwnMetadata:er,OrdinaryHasOwnMetadata:be,OrdinaryGetOwnMetadata:Ut,OrdinaryOwnMetadataKeys:Fe,OrdinaryDeleteMetadata:se};return y.registerProvider(V),V;function Z(fe,pe,ye){var je=O.get(fe),gt=!1;if(z(je)){if(!ye)return;je=new d,O.set(fe,je),gt=!0}var Ft=je.get(pe);if(z(Ft)){if(!ye)return;if(Ft=new d,je.set(pe,Ft),!_.setProvider(fe,pe,V))throw je.delete(pe),gt&&O.delete(fe),new Error("Wrong provider for target.")}return Ft}function be(fe,pe,ye){var je=Z(pe,ye,!1);return z(je)?!1:dt(je.has(fe))}function Ut(fe,pe,ye){var je=Z(pe,ye,!1);if(!z(je))return je.get(fe)}function er(fe,pe,ye,je){var gt=Z(ye,je,!0);gt.set(fe,pe)}function Fe(fe,pe){var ye=[],je=Z(fe,pe,!1);if(z(je))return ye;for(var gt=je.keys(),Ft=Pb(gt),Io=0;;){var Db=Ob(Ft);if(!Db)return ye.length=Io,ye;var iD=kb(Db);try{ye[Io]=iD}catch(sD){try{Rb(Ft)}finally{throw sD}}Io++}}function se(fe,pe,ye){var je=Z(pe,ye,!1);if(z(je)||!je.delete(fe))return!1;if(je.size===0){var gt=O.get(pe);z(gt)||(gt.delete(ye),gt.size===0&&O.delete(gt))}return!0}}function tD(_){var O=_.defineMetadata,V=_.hasOwnMetadata,Z=_.getOwnMetadata,be=_.getOwnMetadataKeys,Ut=_.deleteMetadata,er=new m,Fe={isProviderFor:function(se,fe){var pe=er.get(se);return!z(pe)&&pe.has(fe)?!0:be(se,fe).length?(z(pe)&&(pe=new p,er.set(se,pe)),pe.add(fe),!0):!1},OrdinaryDefineOwnMetadata:O,OrdinaryHasOwnMetadata:V,OrdinaryGetOwnMetadata:Z,OrdinaryOwnMetadataKeys:be,OrdinaryDeleteMetadata:Ut};return Fe}function hd(_,O,V){var Z=y.getProvider(_,O);if(!z(Z))return Z;if(V){if(y.setProvider(_,O,b))return b;throw new Error("Illegal state.")}}function rD(){var _={},O=[],V=function(){function Fe(se,fe,pe){this._index=0,this._keys=se,this._values=fe,this._selector=pe}return Fe.prototype["@@iterator"]=function(){return this},Fe.prototype[s]=function(){return this},Fe.prototype.next=function(){var se=this._index;if(se>=0&&se<this._keys.length){var fe=this._selector(this._keys[se],this._values[se]);return se+1>=this._keys.length?(this._index=-1,this._keys=O,this._values=O):this._index++,{value:fe,done:!1}}return{value:void 0,done:!0}},Fe.prototype.throw=function(se){throw this._index>=0&&(this._index=-1,this._keys=O,this._values=O),se},Fe.prototype.return=function(se){return this._index>=0&&(this._index=-1,this._keys=O,this._values=O),{value:se,done:!0}},Fe}(),Z=function(){function Fe(){this._keys=[],this._values=[],this._cacheKey=_,this._cacheIndex=-2}return Object.defineProperty(Fe.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Fe.prototype.has=function(se){return this._find(se,!1)>=0},Fe.prototype.get=function(se){var fe=this._find(se,!1);return fe>=0?this._values[fe]:void 0},Fe.prototype.set=function(se,fe){var pe=this._find(se,!0);return this._values[pe]=fe,this},Fe.prototype.delete=function(se){var fe=this._find(se,!1);if(fe>=0){for(var pe=this._keys.length,ye=fe+1;ye<pe;ye++)this._keys[ye-1]=this._keys[ye],this._values[ye-1]=this._values[ye];return this._keys.length--,this._values.length--,Fi(se,this._cacheKey)&&(this._cacheKey=_,this._cacheIndex=-2),!0}return!1},Fe.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=_,this._cacheIndex=-2},Fe.prototype.keys=function(){return new V(this._keys,this._values,be)},Fe.prototype.values=function(){return new V(this._keys,this._values,Ut)},Fe.prototype.entries=function(){return new V(this._keys,this._values,er)},Fe.prototype["@@iterator"]=function(){return this.entries()},Fe.prototype[s]=function(){return this.entries()},Fe.prototype._find=function(se,fe){if(!Fi(this._cacheKey,se)){this._cacheIndex=-1;for(var pe=0;pe<this._keys.length;pe++)if(Fi(this._keys[pe],se)){this._cacheIndex=pe;break}}return this._cacheIndex<0&&fe&&(this._cacheIndex=this._keys.length,this._keys.push(se),this._values.push(void 0)),this._cacheIndex},Fe}();return Z;function be(Fe,se){return Fe}function Ut(Fe,se){return se}function er(Fe,se){return[Fe,se]}}function nD(){var _=function(){function O(){this._map=new d}return Object.defineProperty(O.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),O.prototype.has=function(V){return this._map.has(V)},O.prototype.add=function(V){return this._map.set(V,V),this},O.prototype.delete=function(V){return this._map.delete(V)},O.prototype.clear=function(){this._map.clear()},O.prototype.keys=function(){return this._map.keys()},O.prototype.values=function(){return this._map.keys()},O.prototype.entries=function(){return this._map.entries()},O.prototype["@@iterator"]=function(){return this.keys()},O.prototype[s]=function(){return this.keys()},O}();return _}function oD(){var _=16,O=u.create(),V=Z();return function(){function se(){this._key=Z()}return se.prototype.has=function(fe){var pe=be(fe,!1);return pe!==void 0?u.has(pe,this._key):!1},se.prototype.get=function(fe){var pe=be(fe,!1);return pe!==void 0?u.get(pe,this._key):void 0},se.prototype.set=function(fe,pe){var ye=be(fe,!0);return ye[this._key]=pe,this},se.prototype.delete=function(fe){var pe=be(fe,!1);return pe!==void 0?delete pe[this._key]:!1},se.prototype.clear=function(){this._key=Z()},se}();function Z(){var se;do se="@@WeakMap@@"+Fe();while(u.has(O,se));return O[se]=!0,se}function be(se,fe){if(!n.call(se,V)){if(!fe)return;Object.defineProperty(se,V,{value:u.create()})}return se[V]}function Ut(se,fe){for(var pe=0;pe<fe;++pe)se[pe]=Math.random()*255|0;return se}function er(se){if(typeof Uint8Array=="function"){var fe=new Uint8Array(se);return typeof crypto<"u"?crypto.getRandomValues(fe):typeof msCrypto<"u"?msCrypto.getRandomValues(fe):Ut(fe,se),fe}return Ut(new Array(se),se)}function Fe(){var se=er(_);se[6]=se[6]&79|64,se[8]=se[8]&191|128;for(var fe="",pe=0;pe<_;++pe){var ye=se[pe];(pe===4||pe===6||pe===8)&&(fe+="-"),ye<16&&(fe+="0"),fe+=ye.toString(16).toLowerCase()}return fe}}function m4(_){return _.__=void 0,delete _.__,_}})})(qP||(qP={}))});var eO=Dr((sOe,L3)=>{var Nk,Lk,Bk,Mk,Uk,Fk,jk,Kk,$k,N3,D9,Vk,qk,od,Hk,Wk,zk,Gk,Xk,Yk,Qk,Zk,Jk;(function(r){var e=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(n){r(t(e,t(n)))}):typeof L3=="object"&&typeof L3.exports=="object"?r(t(e,t(L3.exports))):r(t(e));function t(n,o){return n!==e&&(typeof Object.create=="function"?Object.defineProperty(n,"__esModule",{value:!0}):n.__esModule=!0),function(i,s){return n[i]=o?o(i,s):s}}})(function(r){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o])};Nk=function(t,n){e(t,n);function o(){this.constructor=t}t.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},Lk=Object.assign||function(t){for(var n,o=1,i=arguments.length;o<i;o++){n=arguments[o];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},Bk=function(t,n){var o={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&n.indexOf(i)<0&&(o[i]=t[i]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,i=Object.getOwnPropertySymbols(t);s<i.length;s++)n.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(t,i[s])&&(o[i[s]]=t[i[s]]);return o},Mk=function(t,n,o,i){var s=arguments.length,a=s<3?n:i===null?i=Object.getOwnPropertyDescriptor(n,o):i,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(t,n,o,i);else for(var l=t.length-1;l>=0;l--)(c=t[l])&&(a=(s<3?c(a):s>3?c(n,o,a):c(n,o))||a);return s>3&&a&&Object.defineProperty(n,o,a),a},Uk=function(t,n){return function(o,i){n(o,i,t)}},Fk=function(t,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,n)},jk=function(t,n,o,i){function s(a){return a instanceof o?a:new o(function(c){c(a)})}return new(o||(o=Promise))(function(a,c){function l(d){try{f(i.next(d))}catch(p){c(p)}}function u(d){try{f(i.throw(d))}catch(p){c(p)}}function f(d){d.done?a(d.value):s(d.value).then(l,u)}f((i=i.apply(t,n||[])).next())})},Kk=function(t,n){var o={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},i,s,a,c;return c={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(f){return function(d){return u([f,d])}}function u(f){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(a=f[0]&2?s.return:f[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,f[1])).done)return a;switch(s=0,a&&(f=[f[0]&2,a.value]),f[0]){case 0:case 1:a=f;break;case 4:return o.label++,{value:f[1],done:!1};case 5:o.label++,s=f[1],f=[0];continue;case 7:f=o.ops.pop(),o.trys.pop();continue;default:if(a=o.trys,!(a=a.length>0&&a[a.length-1])&&(f[0]===6||f[0]===2)){o=0;continue}if(f[0]===3&&(!a||f[1]>a[0]&&f[1]<a[3])){o.label=f[1];break}if(f[0]===6&&o.label<a[1]){o.label=a[1],a=f;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(f);break}a[2]&&o.ops.pop(),o.trys.pop();continue}f=n.call(t,o)}catch(d){f=[6,d],s=0}finally{i=a=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},Jk=function(t,n,o,i){i===void 0&&(i=o),t[i]=n[o]},$k=function(t,n){for(var o in t)o!=="default"&&!n.hasOwnProperty(o)&&(n[o]=t[o])},N3=function(t){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&t[n],i=0;if(o)return o.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},D9=function(t,n){var o=typeof Symbol=="function"&&t[Symbol.iterator];if(!o)return t;var i=o.call(t),s,a=[],c;try{for(;(n===void 0||n-- >0)&&!(s=i.next()).done;)a.push(s.value)}catch(l){c={error:l}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(c)throw c.error}}return a},Vk=function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(D9(arguments[n]));return t},qk=function(){for(var t=0,n=0,o=arguments.length;n<o;n++)t+=arguments[n].length;for(var i=Array(t),s=0,n=0;n<o;n++)for(var a=arguments[n],c=0,l=a.length;c<l;c++,s++)i[s]=a[c];return i},od=function(t){return this instanceof od?(this.v=t,this):new od(t)},Hk=function(t,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=o.apply(t,n||[]),s,a=[];return s={},c("next"),c("throw"),c("return"),s[Symbol.asyncIterator]=function(){return this},s;function c(m){i[m]&&(s[m]=function(g){return new Promise(function(y,b){a.push([m,g,y,b])>1||l(m,g)})})}function l(m,g){try{u(i[m](g))}catch(y){p(a[0][3],y)}}function u(m){m.value instanceof od?Promise.resolve(m.value.v).then(f,d):p(a[0][2],m)}function f(m){l("next",m)}function d(m){l("throw",m)}function p(m,g){m(g),a.shift(),a.length&&l(a[0][0],a[0][1])}},Wk=function(t){var n,o;return n={},i("next"),i("throw",function(s){throw s}),i("return"),n[Symbol.iterator]=function(){return this},n;function i(s,a){n[s]=t[s]?function(c){return(o=!o)?{value:od(t[s](c)),done:s==="return"}:a?a(c):c}:a}},zk=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t[Symbol.asyncIterator],o;return n?n.call(t):(t=typeof N3=="function"?N3(t):t[Symbol.iterator](),o={},i("next"),i("throw"),i("return"),o[Symbol.asyncIterator]=function(){return this},o);function i(a){o[a]=t[a]&&function(c){return new Promise(function(l,u){c=t[a](c),s(l,u,c.done,c.value)})}}function s(a,c,l,u){Promise.resolve(u).then(function(f){a({value:f,done:l})},c)}},Gk=function(t,n){return Object.defineProperty?Object.defineProperty(t,"raw",{value:n}):t.raw=n,t},Xk=function(t){if(t&&t.__esModule)return t;var n={};if(t!=null)for(var o in t)Object.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n.default=t,n},Yk=function(t){return t&&t.__esModule?t:{default:t}},Qk=function(t,n){if(!n.has(t))throw new TypeError("attempted to get private field on non-instance");return n.get(t)},Zk=function(t,n,o){if(!n.has(t))throw new TypeError("attempted to set private field on non-instance");return n.set(t,o),o},r("__extends",Nk),r("__assign",Lk),r("__rest",Bk),r("__decorate",Mk),r("__param",Uk),r("__metadata",Fk),r("__awaiter",jk),r("__generator",Kk),r("__exportStar",$k),r("__createBinding",Jk),r("__values",N3),r("__read",D9),r("__spread",Vk),r("__spreadArrays",qk),r("__await",od),r("__asyncGenerator",Hk),r("__asyncDelegator",Wk),r("__asyncValues",zk),r("__makeTemplateObject",Gk),r("__importStar",Xk),r("__importDefault",Yk),r("__classPrivateFieldGet",Qk),r("__classPrivateFieldSet",Zk)})});var DR=Dr(d4=>{"use strict";Object.defineProperty(d4,"__esModule",{value:!0});var Sb=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,o)=>{this.pullQueue.push({resolve:n,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},f4=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let o=new Sb;o.highWaterMark=t,o.lowWaterMark=n,o.removeCallback=e({push:i=>o.push(i),stop:()=>o.stop(),fail:i=>o.fail(i),on:(i,s)=>{o.eventHandlers[i]=s}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}};d4.EventIterator=f4;d4.default=f4});var NR=Dr(v1=>{"use strict";Object.defineProperty(v1,"__esModule",{value:!0});var _b=DR();v1.EventIterator=_b.EventIterator;function cH(r,e,t){return new _b.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}v1.subscribe=cH;v1.default=_b.EventIterator});var dH={};kt(dH,{DEFAULT_SESSION_MAX_PROVIDERS:()=>f6,DEFAULT_SESSION_MIN_PROVIDERS:()=>u6,InsufficientProvidersError:()=>Cd,NoRoutersAvailableError:()=>Ys,UnknownCodecError:()=>kd,UnknownHashAlgorithmError:()=>Pd,createHelia:()=>fH,heliaDefaults:()=>Ib,libp2pDefaults:()=>p4});var Lb=Symbol.for("@libp2p/connection");var ui=Symbol.for("@libp2p/content-routing");var Ya=Symbol.for("@libp2p/peer-discovery");var E1=Symbol.for("@libp2p/peer-id");function Yn(r){return!!r?.[E1]}var fi=Symbol.for("@libp2p/peer-routing");var js="keep-alive";var Ks=Symbol.for("@libp2p/transport");var Qa;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Qa||(Qa={}));var rr=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},S1=class extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}},_1=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},M=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},ji=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},md=class extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}};var A1=class extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}},Zl=class extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}},Jl=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},di=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},T1=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},Za=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},qe=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}},eu=class extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}},$s=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},I1=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},Vs=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},Ki=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}},Be=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},C1=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Qn=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},Tn=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var $i=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},Ja=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}},tu=class extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}},P1=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}},qs=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},Co=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var De=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let o=this.#e.get(e);o==null&&(o=[],this.#e.set(e,o)),o.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let o=this.#e.get(e);o!=null&&(o=o.filter(({callback:i})=>i!==t),this.#e.set(e,o))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:o})=>!o),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};function k1(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function pr(...r){let e=[];for(let t of r)k1(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Nr(...r){let e=[];for(let t of r)k1(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var He=Symbol.for("@libp2p/service-capabilities"),In=Symbol.for("@libp2p/service-dependencies");var x4={};kt(x4,{base32:()=>ir,base32hex:()=>ED,base32hexpad:()=>_D,base32hexpadupper:()=>AD,base32hexupper:()=>SD,base32pad:()=>vD,base32padupper:()=>xD,base32upper:()=>bD,base32z:()=>TD});var HH=new Uint8Array(0);function Bb(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Po(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Mb(r){return new TextEncoder().encode(r)}function Ub(r){return new TextDecoder().decode(r)}function pD(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var i=r.charAt(o),s=i.charCodeAt(0);if(t[s]!==255)throw new TypeError(i+" is ambiguous");t[s]=o}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var g=0,y=0,b=0,C=m.length;b!==C&&m[b]===0;)b++,g++;for(var D=(C-b)*u+1>>>0,U=new Uint8Array(D);b!==C;){for(var X=m[b],K=0,ee=D-1;(X!==0||K<y)&&ee!==-1;ee--,K++)X+=256*U[ee]>>>0,U[ee]=X%a>>>0,X=X/a>>>0;if(X!==0)throw new Error("Non-zero carry");y=K,b++}for(var $=D-y;$!==D&&U[$]===0;)$++;for(var B=c.repeat(g);$<D;++$)B+=r.charAt(U[$]);return B}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var g=0;if(m[g]!==" "){for(var y=0,b=0;m[g]===c;)y++,g++;for(var C=(m.length-g)*l+1>>>0,D=new Uint8Array(C);m[g];){var U=t[m.charCodeAt(g)];if(U===255)return;for(var X=0,K=C-1;(U!==0||X<b)&&K!==-1;K--,X++)U+=a*D[K]>>>0,D[K]=U%256>>>0,U=U/256>>>0;if(U!==0)throw new Error("Non-zero carry");b=X,g++}if(m[g]!==" "){for(var ee=C-b;ee!==C&&D[ee]===0;)ee++;for(var $=new Uint8Array(y+(C-ee)),B=y;ee!==C;)$[B++]=D[ee++];return $}}}function p(m){var g=d(m);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:d,decode:p}}var hD=pD,mD=hD,Fb=mD;var g4=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},w4=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let o=t.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return jb(this,e)}},b4=class{decoders;constructor(e){this.decoders=e}or(e){return jb(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function jb(r,e){return new b4({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var v4=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,o){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new g4(e,t,n),this.decoder=new w4(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function ru({name:r,prefix:e,encode:t,decode:n}){return new v4(r,e,t,n)}function Hs({name:r,prefix:e,alphabet:t}){let{encode:n,decode:o}=Fb(t,r);return ru({prefix:e,name:r,encode:n,decode:i=>Po(o(i))})}function yD(r,e,t,n){let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),s=0,a=0,c=0;for(let l=0;l<o;++l){let u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,s+=t,s>=8&&(s-=8,i[c++]=255&a>>s)}if(s>=t||(255&a<<8-s)!==0)throw new SyntaxError("Unexpected end of data");return i}function gD(r,e,t){let n=e[e.length-1]==="=",o=(1<<t)-1,i="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,i+=e[o&a>>s];if(s!==0&&(i+=e[o&a<<t-s]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function wD(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Ot({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let o=wD(n);return ru({prefix:e,name:r,encode(i){return gD(i,n,t)},decode(i){return yD(i,o,t,r)}})}var ir=Ot({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),bD=Ot({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),vD=Ot({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),xD=Ot({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ED=Ot({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),SD=Ot({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),_D=Ot({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),AD=Ot({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),TD=Ot({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var E4={};kt(E4,{base58btc:()=>rt,base58flickr:()=>ID});var rt=Hs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ID=Hs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var S4={};kt(S4,{base64:()=>Ht,base64pad:()=>CD,base64url:()=>ec,base64urlpad:()=>PD});var Ht=Ot({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),CD=Ot({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ec=Ot({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),PD=Ot({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function kD(r,e){try{if(typeof r=="string"&&r.length>0)return OD(r);if(typeof r=="number"&&isFinite(r))return e?.long?DD(r):RD(r);throw new Error("Value is not a string or number.")}catch(t){let n=ND(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function OD(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");let e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;let t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*315576e5;case"weeks":case"week":case"w":return t*6048e5;case"days":case"day":case"d":return t*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return t*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return t*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return t*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}var R1=kD;function RD(r){let e=Math.abs(r);return e>=864e5?`${Math.round(r/864e5)}d`:e>=36e5?`${Math.round(r/36e5)}h`:e>=6e4?`${Math.round(r/6e4)}m`:e>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function DD(r){let e=Math.abs(r);return e>=864e5?O1(r,e,864e5,"day"):e>=36e5?O1(r,e,36e5,"hour"):e>=6e4?O1(r,e,6e4,"minute"):e>=1e3?O1(r,e,1e3,"second"):`${r} ms`}function O1(r,e,t,n){let o=e>=t*1.5;return`${Math.round(r/t)} ${n}${o?"s":""}`}function ND(r){return typeof r=="object"&&r!==null&&"message"in r}function _4(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=o,t.enabled=s,t.humanize=R1,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let d=0;d<u.length;d++)f=(f<<5)-f+u.charCodeAt(d),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,d=null,p,m;function g(...y){if(!g.enabled)return;let b=g,C=Number(new Date),D=C-(f||C);b.diff=D,b.prev=f,b.curr=C,f=C,y[0]=t.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let U=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(K,ee)=>{if(K==="%%")return"%";U++;let $=t.formatters[ee];if(typeof $=="function"){let B=y[U];K=$.call(b,B),y.splice(U,1),U--}return K}),t.formatArgs.call(b,y),(b.log||t.log).apply(b,y)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(p!==t.namespaces&&(p=t.namespaces,m=t.enabled(u)),m),set:y=>{d=y}}),typeof t.init=="function"&&t.init(g),g}function n(u,f){let d=t(this.namespace+(typeof f>"u"?":":f)+u);return d.log=this.log,d}function o(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,d=(typeof u=="string"?u:"").split(/[\s,]+/),p=d.length;for(f=0;f<p;f++)d[f]&&(u=d[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function s(u){if(u[u.length-1]==="*")return!0;let f,d;for(f=0,d=t.skips.length;f<d;f++)if(t.skips[f].test(u))return!1;for(f=0,d=t.names.length;f<d;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var D1=KD(),LD=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function BD(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function MD(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+R1(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(t++,o==="%c"&&(n=t))}),r.splice(n,0,e)}var UD=console.debug??console.log??(()=>{});function FD(r){try{r?D1?.setItem("debug",r):D1?.removeItem("debug")}catch{}}function jD(){let r;try{r=D1?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function KD(){try{return localStorage}catch{}}function $D(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var Kb=_4({formatArgs:MD,save:FD,load:jD,useColors:BD,setupFormatters:$D,colors:LD,storage:D1,log:UD});var sn=Kb;sn.formatters.b=r=>r==null?"undefined":rt.baseEncode(r);sn.formatters.t=r=>r==null?"undefined":ir.baseEncode(r);sn.formatters.m=r=>r==null?"undefined":Ht.baseEncode(r);sn.formatters.p=r=>r==null?"undefined":r.toString();sn.formatters.c=r=>r==null?"undefined":r.toString();sn.formatters.k=r=>r==null?"undefined":r.toString();sn.formatters.a=r=>r==null?"undefined":r.toString();sn.formatters.e=r=>r==null?"undefined":$b(r.stack)??$b(r.message)??r.toString();function VD(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Ws(){return{forComponent(r){return Cn(r)}}}function Cn(r){let e=VD(`${r}:trace`);return sn.enabled(`${r}:trace`)&&sn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=sn(`${r}:trace`)),Object.assign(sn(r),{error:sn(`${r}:error`),trace:e})}function $b(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}var ce=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var T4=tr(qb(),1);var gd=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},I4=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Hb=r=>globalThis.DOMException===void 0?new I4(r):new DOMException(r),Wb=r=>{let e=r.reason===void 0?Hb("This operation was aborted."):r.reason;return e instanceof Error?e:Hb(e)};function Vi(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((u,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:p}=e;p.aborted&&f(Wb(p)),a=()=>{f(Wb(p))},p.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,f);return}let d=new gd;s=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(p){f(p)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?u():o instanceof Error?f(o):(d.message=o??`Promise timed out after ${t} milliseconds`,f(d))},t),(async()=>{try{u(await r)}catch(p){f(p)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}function C4(r,e,t){let n=0,o=r.length;for(;o>0;){let i=Math.trunc(o/2),s=n+i;t(r[s],e)<=0?(n=++s,o-=i+1):o=i}return n}var wd=class{#e=[];enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}let o=C4(this.#e,n,(i,s)=>s.priority-i.priority);this.#e.splice(o,0,n)}setPriority(e,t){let n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[o]=this.#e.splice(n,1);this.enqueue(o.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var tc=class extends T4.default{#e;#t;#r=0;#a;#s;#l=0;#o;#u;#n;#m;#i=0;#f;#c;#y;#b=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:wd,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#a=e.intervalCap,this.#s=e.interval,this.#n=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#y=e.throwOnTimeout===!0,this.#c=e.autoStart===!1}get#v(){return this.#t||this.#r<this.#a}get#x(){return this.#i<this.#f}#E(){this.#i--,this.#d(),this.emit("next")}#S(){this.#w(),this.#g(),this.#u=void 0}get#_(){let e=Date.now();if(this.#o===void 0){let t=this.#l-e;if(t<0)this.#r=this.#e?this.#i:0;else return this.#u===void 0&&(this.#u=setTimeout(()=>{this.#S()},t)),!0}return!1}#d(){if(this.#n.size===0)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#c){let e=!this.#_;if(this.#v&&this.#x){let t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#g(),!0):!1}}return!1}#g(){this.#t||this.#o!==void 0||(this.#o=setInterval(()=>{this.#w()},this.#s),this.#l=Date.now()+this.#s)}#w(){this.#r===0&&this.#i===0&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#r=this.#e?this.#i:0,this.#p()}#p(){for(;this.#d(););}get concurrency(){return this.#f}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#f=e,this.#p()}async#A(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#b++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#y,...t},new Promise((n,o)=>{this.#n.enqueue(async()=>{this.#i++,this.#r++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=Vi(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#A(t.signal)]));let s=await i;n(s),this.emit("completed",s)}catch(i){if(i instanceof gd&&!t.throwOnTimeout){n();return}o(i),this.emit("error",i)}finally{this.#E()}},t),this.emit("add"),this.#d()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#c?(this.#c=!1,this.#p(),this):this}pause(){this.#c=!0}clear(){this.#n=new this.#m}async onEmpty(){this.#n.size!==0&&await this.#h("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#h("next",()=>this.#n.size<e)}async onIdle(){this.#i===0&&this.#n.size===0||await this.#h("idle")}async#h(e,t){return new Promise(n=>{let o=()=>{t&&!t()||(this.off(e,o),n())};this.on(e,o)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#c}};function L1(r){let e=[Pn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var P4={};kt(P4,{base10:()=>WD});var WD=Hs({prefix:"9",name:"base10",alphabet:"0123456789"});var k4={};kt(k4,{base16:()=>zD,base16upper:()=>GD});var zD=Ot({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),GD=Ot({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var O4={};kt(O4,{base2:()=>XD});var XD=Ot({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var R4={};kt(R4,{base256emoji:()=>eN});var zb=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),YD=zb.reduce((r,e,t)=>(r[t]=e,r),[]),QD=zb.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function ZD(r){return r.reduce((e,t)=>(e+=YD[t],e),"")}function JD(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let o=QD[n];if(o==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(o)}return new Uint8Array(e)}var eN=ru({prefix:"\u{1F680}",name:"base256emoji",encode:ZD,decode:JD});var D4={};kt(D4,{base36:()=>pi,base36upper:()=>tN});var pi=Hs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),tN=Hs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var N4={};kt(N4,{base8:()=>rN});var rN=Ot({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var L4={};kt(L4,{identity:()=>nN});var nN=ru({prefix:"\0",name:"identity",encode:r=>Ub(r),decode:r=>Mb(r)});var B1={};kt(B1,{code:()=>B4,decode:()=>cN,encode:()=>aN,name:()=>sN});var oN=new TextEncoder,iN=new TextDecoder,sN="json",B4=512;function aN(r){return oN.encode(JSON.stringify(r))}function cN(r){return JSON.parse(iN.decode(r))}var nu={};kt(nu,{code:()=>rc,decode:()=>fN,encode:()=>uN,name:()=>lN});var lN="raw",rc=85;function uN(r){return Po(r)}function fN(r){return Po(r)}var F4={};kt(F4,{identity:()=>Mr});var Rt={};kt(Rt,{Digest:()=>nc,create:()=>Br,decode:()=>st,equals:()=>U4,hasCode:()=>kN});var dN=Yb,Gb=128,pN=127,hN=~pN,mN=Math.pow(2,31);function Yb(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mN;)e[t++]=r&255|Gb,r/=128;for(;r&hN;)e[t++]=r&255|Gb,r>>>=7;return e[t]=r|0,Yb.bytes=t-n+1,e}var yN=M4,gN=128,Xb=127;function M4(r,n){var t=0,n=n||0,o=0,i=n,s,a=r.length;do{if(i>=a)throw M4.bytes=0,new RangeError("Could not decode varint");s=r[i++],t+=o<28?(s&Xb)<<o:(s&Xb)*Math.pow(2,o),o+=7}while(s>=gN);return M4.bytes=i-n,t}var wN=Math.pow(2,7),bN=Math.pow(2,14),vN=Math.pow(2,21),xN=Math.pow(2,28),EN=Math.pow(2,35),SN=Math.pow(2,42),_N=Math.pow(2,49),AN=Math.pow(2,56),TN=Math.pow(2,63),IN=function(r){return r<wN?1:r<bN?2:r<vN?3:r<xN?4:r<EN?5:r<SN?6:r<_N?7:r<AN?8:r<TN?9:10},CN={encode:dN,decode:yN,encodingLength:IN},PN=CN,bd=PN;function vd(r,e=0){return[bd.decode(r,e),bd.decode.bytes]}function ou(r,e,t=0){return bd.encode(r,e,t),e}function iu(r){return bd.encodingLength(r)}function Br(r,e){let t=e.byteLength,n=iu(r),o=n+iu(t),i=new Uint8Array(o+t);return ou(r,i,0),ou(t,i,n),i.set(e,o),new nc(r,t,e,i)}function st(r){let e=Po(r),[t,n]=vd(e),[o,i]=vd(e.subarray(n)),s=e.subarray(n+i);if(s.byteLength!==o)throw new Error("Incorrect length");return new nc(t,o,s,e)}function U4(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Bb(r.bytes,t.bytes)}}var nc=class{code;size;digest;bytes;constructor(e,t,n,o){this.code=e,this.size=t,this.digest=n,this.bytes=o}};function kN(r,e){return r.code===e}var Qb=0,ON="identity",Zb=Po;function RN(r){return Br(Qb,Zb(r))}var Mr={code:Qb,name:ON,encode:Zb,digest:RN};var $4={};kt($4,{sha256:()=>wt,sha512:()=>U1});function K4({name:r,code:e,encode:t}){return new j4(r,e,t)}var j4=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Br(this.code,t):t.then(n=>Br(this.code,n))}else throw Error("Unknown type, must be binary type")}};function ev(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var wt=K4({name:"sha2-256",code:18,encode:ev("SHA-256")}),U1=K4({name:"sha2-512",code:19,encode:ev("SHA-512")});function tv(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return NN(t,V4(r),e??rt.encoder);default:return LN(t,V4(r),e??ir.encoder)}}var rv=new WeakMap;function V4(r){let e=rv.get(r);if(e==null){let t=new Map;return rv.set(r,t),t}return e}var ue=class r{code;version;multihash;bytes;"/";constructor(e,t,n,o){this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==xd)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==BN)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Br(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&U4(e.multihash,n.multihash)}toString(e){return tv(this,e)}toJSON(){return{"/":tv(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:o,multihash:i,bytes:s}=t;return new r(n,o,i,s??nv(n,o,i.bytes))}else if(t[MN]===!0){let{version:n,multihash:o,code:i}=t,s=st(o);return r.create(n,i,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==xd)throw new Error(`Version 0 CID must use dag-pb (code: ${xd}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let o=nv(e,t,n.bytes);return new r(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,xd,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,o=Po(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=o.subarray(t.multihashSize-t.digestSize),s=new nc(t.multihashCode,t.digestSize,i,o);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,d]=vd(e.subarray(t));return t+=d,f},o=n(),i=xd;if(o===18?(o=0,t=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let s=t,a=n(),c=n(),l=t+c,u=l-s;return{version:o,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,o]=DN(e,t),i=r.decode(o);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return V4(i).set(n,e),i}};function DN(r,e){switch(r[0]){case"Q":{let t=e??rt;return[rt.prefix,t.decode(`${rt.prefix}${r}`)]}case rt.prefix:{let t=e??rt;return[rt.prefix,t.decode(r)]}case ir.prefix:{let t=e??ir;return[ir.prefix,t.decode(r)]}case pi.prefix:{let t=e??pi;return[pi.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function NN(r,e,t){let{prefix:n}=t;if(n!==rt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let o=e.get(n);if(o==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return o}function LN(r,e,t){let{prefix:n}=t,o=e.get(n);if(o==null){let i=t.encode(r);return e.set(n,i),i}else return o}var xd=112,BN=18;function nv(r,e,t){let n=iu(r),o=n+iu(e),i=new Uint8Array(o+t.byteLength);return ou(r,i,0),ou(e,i,n),i.set(t,o),i}var MN=Symbol.for("@ipld/js-cid/CID");var oc={...L4,...O4,...N4,...P4,...k4,...x4,...D4,...E4,...S4,...R4},ez={...$4,...F4};function Ce(r=0){return new Uint8Array(r)}function Tt(r=0){return new Uint8Array(r)}function iv(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var ov=iv("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),q4=iv("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Tt(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),UN={utf8:ov,"utf-8":ov,hex:oc.base16,latin1:q4,ascii:q4,binary:q4,...oc},F1=UN;function W(r,e="utf8"){let t=F1[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var H4=60;function j1(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Pn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Pn[e.type],TTL:e.TTL??e.ttl??H4,data:e.data instanceof Uint8Array?W(e.data):e.data}))}}var FN=4;function W4(r,e={}){let t=new tc({concurrency:e.queryConcurrency??FN});return async(n,o={})=>{let i=new URLSearchParams;i.set("name",n),L1(o.types).forEach(a=>{i.append("type",Pn[a])}),o.onProgress?.(new ce("dns:query",{detail:n}));let s=await t.add(async()=>{let a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:o?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=j1(await a.json());return o.onProgress?.(new ce("dns:response",{detail:c})),c},{signal:o.signal});if(s==null)throw new Error("No DNS response received");return s}}function sv(){return[W4("https://cloudflare-dns.com/dns-query"),W4("https://dns.google/resolve")]}var lv=tr(cv(),1);var z4=class{lru;constructor(e){this.lru=(0,lv.default)(e)}get(e,t){let n=!0,o=[];for(let i of t){let s=this.getAnswers(e,i);if(s.length===0){n=!1;break}o.push(...s)}if(n)return j1({answers:o})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,o=this.lru.get(n);if(o!=null){let i=o.filter(s=>s.expires>Date.now()).map(({expires:s,value:a})=>({...a,TTL:Math.round((s-Date.now())/1e3),type:Pn[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,o=this.lru.get(n)??[];o.push({expires:Date.now()+(t.TTL??H4)*1e3,value:t}),this.lru.set(n,o)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function uv(r){return new z4(r)}var jN=1e3,K1=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=uv(e.cacheSize??jN),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=sv())}async query(e,t={}){let n=L1(t.types),o=t.cached!==!1?this.cache.get(e,n):void 0;if(o!=null)return t.onProgress?.(new ce("dns:cache",{detail:o})),o;let i=`${e.split(".").pop()}.`,s=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of s){if(t.signal?.aborted===!0)break;try{let l=await c(e,{...t,types:n});for(let u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new ce("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var Pn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Pn||(Pn={}));function $1(r={}){return new K1(r)}function KN(r){return r[Symbol.asyncIterator]!=null}function $N(r){if(KN(r))return(async()=>{for await(let e of r);})();for(let e of r);}var an=$N;function ve(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var V1=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},su=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new V1(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new V1(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var G4=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function sr(r={}){return VN(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function VN(r,e){e=e??{};let t=e.onEnd,n=new su,o,i,s,a=ve(),c=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((y,b)=>{i=C=>{i=null,n.push(C);try{y(r(n))}catch(D){b(D)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ve()})}},l=y=>i!=null?i(y):(n.push(y),o),u=y=>(n=new su,i!=null?i({error:y}):(n.push({error:y}),o)),f=y=>{if(s)return o;if(e?.objectMode!==!0&&y?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},d=y=>s?o:(s=!0,y!=null?u(y):l({done:!0})),p=()=>(n=new su,d(),{done:!0}),m=y=>(d(y),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:p,throw:m,push:f,end:d,get readableLength(){return n.size},onEmpty:async y=>{let b=y?.signal;if(b?.throwIfAborted(),n.isEmpty())return;let C,D;b!=null&&(C=new Promise((U,X)=>{D=()=>{X(new G4)},b.addEventListener("abort",D)}));try{await Promise.race([a.promise,C])}finally{D!=null&&b!=null&&b?.removeEventListener("abort",D)}}},t==null)return o;let g=o;return o={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(y){return g.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(y){return g.end(y),t!=null&&(t(y),t=void 0),o},get readableLength(){return g.readableLength},onEmpty:y=>g.onEmpty(y)},o}var kn=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Dt(r,e,t,n){let o=new kn(n?.errorMessage);n?.errorCode!=null&&(o.code=n.errorCode);let i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(o):new Promise((s,a)=>{function c(){Y4(t,"abort",f),Y4(r,e,l),Y4(r,i,u)}let l=d=>{try{if(n?.filter?.(d)===!1)return}catch(p){c(),a(p);return}c(),s(d)},u=d=>{if(c(),d instanceof Error){a(d);return}a(d.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},f=()=>{c(),a(o)};X4(t,"abort",f),X4(r,e,l),X4(r,i,u)})}function X4(r,e,t){r!=null&&(fv(r)?r.addEventListener(e,t):r.addListener(e,t))}function Y4(r,e,t){r!=null&&(fv(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function fv(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}function qi(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var q1=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}},H1=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var W1=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function nt(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new W1(t?.errorMessage,t?.errorCode,t?.errorName));let n,o=new W1(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,s)=>{n=()=>{s(o)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var z1=class{deferred;signal;constructor(e){this.signal=e,this.deferred=ve(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new rr)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function qN(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var G1=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=qN(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new rr),this.cleanup())}async join(e={}){let t=new z1(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await nt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var hr=class extends De{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=qi(this.emitEmpty.bind(this),1),this.emitIdle=qi(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new H1;let n=new G1(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new rr)}),this.clear()}async onEmpty(e){this.size!==0&&await Dt(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Dt(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Dt(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=sr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail)},s=()=>{n()},a=()=>{n(new rr("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("error",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",o),this.removeEventListener("error",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var HN=["string","number","bigint","symbol"],WN=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function dv(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(HN.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(zN(r))return"Buffer";let t=GN(r);return t||"Object"}function zN(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function GN(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(WN.includes(e))return e}var v=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};v.uint=new v(0,"uint",!0);v.negint=new v(1,"negint",!0);v.bytes=new v(2,"bytes",!0);v.string=new v(3,"string",!0);v.array=new v(4,"array",!1);v.map=new v(5,"map",!1);v.tag=new v(6,"tag",!1);v.float=new v(7,"float",!0);v.false=new v(7,"false",!0);v.true=new v(7,"true",!0);v.null=new v(7,"null",!0);v.undefined=new v(7,"undefined",!0);v.break=new v(7,"break",!0);var G=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var au=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",XN=new TextDecoder,YN=new TextEncoder;function X1(r){return au&&globalThis.Buffer.isBuffer(r)}function Ed(r){return r instanceof Uint8Array?X1(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var yv=au?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):hv(r,e,t):(r,e,t)=>t-e>64?XN.decode(r.subarray(e,t)):hv(r,e,t),Y1=au?r=>r.length>64?globalThis.Buffer.from(r):pv(r):r=>r.length>64?YN.encode(r):pv(r),hi=r=>Uint8Array.from(r),cu=au?(r,e,t)=>X1(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),gv=au?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Ed(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let o of r)n+o.length>t.length&&(o=o.subarray(0,t.length-n)),t.set(o,n),n+=o.length;return t},wv=au?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function bv(r,e){if(X1(r)&&X1(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function pv(r){let e=[],t=0;for(let n=0;n<r.length;n++){let o=r.charCodeAt(n);o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(o=65536+((o&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128)}return e}function hv(r,e,t){let n=[];for(;e<t;){let o=r[e],i=null,s=o>239?4:o>223?3:o>191?2:1;if(e+s<=t){let a,c,l,u;switch(s){case 1:o<128&&(i=o);break;case 2:a=r[e+1],(a&192)===128&&(u=(o&31)<<6|a&63,u>127&&(i=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(o&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(o&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,s=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=s}return Q4(n)}var mv=4096;function Q4(r){let e=r.length;if(e<=mv)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=mv));return t}var QN=256,Sd=class{constructor(e=QN){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let o=t.length-(this.maxCursor-this.cursor)-1;t.set(e,o)}else{if(t){let o=t.length-(this.maxCursor-this.cursor)-1;o<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,o),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=wv(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=cu(n,0,this.cursor)}else t=gv(this.chunks,this.cursor);return e&&this.reset(),t}};var he="CBOR decode error:",Hi="CBOR encode error:",_d=[];_d[23]=1;_d[24]=2;_d[25]=3;_d[26]=5;_d[27]=9;function Wi(r,e,t){if(r.length-e<t)throw new Error(`${he} not enough data for type`)}var ar=[24,256,65536,4294967296,BigInt("18446744073709551616")];function On(r,e,t){Wi(r,e,1);let n=r[e];if(t.strict===!0&&n<ar[0])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function Rn(r,e,t){Wi(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<ar[1])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function Dn(r,e,t){Wi(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<ar[2])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function Nn(r,e,t){Wi(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],o=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(o);if(t.strict===!0&&i<ar[3])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${he} integers outside of the safe integer range are not supported`)}function vv(r,e,t,n){return new G(v.uint,On(r,e+1,n),2)}function xv(r,e,t,n){return new G(v.uint,Rn(r,e+1,n),3)}function Ev(r,e,t,n){return new G(v.uint,Dn(r,e+1,n),5)}function Sv(r,e,t,n){return new G(v.uint,Nn(r,e+1,n),9)}function Zn(r,e){return mr(r,0,e.value)}function mr(r,e,t){if(t<ar[0]){let n=Number(t);r.push([e|n])}else if(t<ar[1]){let n=Number(t);r.push([e|24,n])}else if(t<ar[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<ar[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<ar[4]){let o=[e|27,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));o[8]=i&255,i=i>>8,o[7]=i&255,i=i>>8,o[6]=i&255,i=i>>8,o[5]=i&255,o[4]=s&255,s=s>>8,o[3]=s&255,s=s>>8,o[2]=s&255,s=s>>8,o[1]=s&255,r.push(o)}else throw new Error(`${he} encountered BigInt larger than allowable range`)}}Zn.encodedSize=function(e){return mr.encodedSize(e.value)};mr.encodedSize=function(e){return e<ar[0]?1:e<ar[1]?2:e<ar[2]?3:e<ar[3]?5:9};Zn.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function _v(r,e,t,n){return new G(v.negint,-1-On(r,e+1,n),2)}function Av(r,e,t,n){return new G(v.negint,-1-Rn(r,e+1,n),3)}function Tv(r,e,t,n){return new G(v.negint,-1-Dn(r,e+1,n),5)}var Z4=BigInt(-1),Iv=BigInt(1);function Cv(r,e,t,n){let o=Nn(r,e+1,n);if(typeof o!="bigint"){let i=-1-o;if(i>=Number.MIN_SAFE_INTEGER)return new G(v.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${he} integers outside of the safe integer range are not supported`);return new G(v.negint,Z4-BigInt(o),9)}function Q1(r,e){let t=e.value,n=typeof t=="bigint"?t*Z4-Iv:t*-1-1;mr(r,e.type.majorEncoded,n)}Q1.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*Z4-Iv:t*-1-1;return n<ar[0]?1:n<ar[1]?2:n<ar[2]?3:n<ar[3]?5:9};Q1.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Ad(r,e,t,n){Wi(r,e,t+n);let o=cu(r,e+t,e+t+n);return new G(v.bytes,o,t+n)}function Pv(r,e,t,n){return Ad(r,e,1,t)}function kv(r,e,t,n){return Ad(r,e,2,On(r,e+1,n))}function Ov(r,e,t,n){return Ad(r,e,3,Rn(r,e+1,n))}function Rv(r,e,t,n){return Ad(r,e,5,Dn(r,e+1,n))}function Dv(r,e,t,n){let o=Nn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer bytes lengths not supported`);return Ad(r,e,9,o)}function Z1(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===v.string?Y1(r.value):r.value),r.encodedBytes}function lu(r,e){let t=Z1(e);mr(r,e.type.majorEncoded,t.length),r.push(t)}lu.encodedSize=function(e){let t=Z1(e);return mr.encodedSize(t.length)+t.length};lu.compareTokens=function(e,t){return JN(Z1(e),Z1(t))};function JN(r,e){return r.length<e.length?-1:r.length>e.length?1:bv(r,e)}function Td(r,e,t,n,o){let i=t+n;Wi(r,e,i);let s=new G(v.string,yv(r,e+t,e+i),i);return o.retainStringBytes===!0&&(s.byteValue=cu(r,e+t,e+i)),s}function Nv(r,e,t,n){return Td(r,e,1,t,n)}function Lv(r,e,t,n){return Td(r,e,2,On(r,e+1,n),n)}function Bv(r,e,t,n){return Td(r,e,3,Rn(r,e+1,n),n)}function Mv(r,e,t,n){return Td(r,e,5,Dn(r,e+1,n),n)}function Uv(r,e,t,n){let o=Nn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer string lengths not supported`);return Td(r,e,9,o,n)}var Fv=lu;function uu(r,e,t,n){return new G(v.array,n,t)}function jv(r,e,t,n){return uu(r,e,1,t)}function Kv(r,e,t,n){return uu(r,e,2,On(r,e+1,n))}function $v(r,e,t,n){return uu(r,e,3,Rn(r,e+1,n))}function Vv(r,e,t,n){return uu(r,e,5,Dn(r,e+1,n))}function qv(r,e,t,n){let o=Nn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer array lengths not supported`);return uu(r,e,9,o)}function Hv(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return uu(r,e,1,1/0)}function J1(r,e){mr(r,v.array.majorEncoded,e.value)}J1.compareTokens=Zn.compareTokens;J1.encodedSize=function(e){return mr.encodedSize(e.value)};function fu(r,e,t,n){return new G(v.map,n,t)}function Wv(r,e,t,n){return fu(r,e,1,t)}function zv(r,e,t,n){return fu(r,e,2,On(r,e+1,n))}function Gv(r,e,t,n){return fu(r,e,3,Rn(r,e+1,n))}function Xv(r,e,t,n){return fu(r,e,5,Dn(r,e+1,n))}function Yv(r,e,t,n){let o=Nn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer map lengths not supported`);return fu(r,e,9,o)}function Qv(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return fu(r,e,1,1/0)}function em(r,e){mr(r,v.map.majorEncoded,e.value)}em.compareTokens=Zn.compareTokens;em.encodedSize=function(e){return mr.encodedSize(e.value)};function Zv(r,e,t,n){return new G(v.tag,t,1)}function Jv(r,e,t,n){return new G(v.tag,On(r,e+1,n),2)}function ex(r,e,t,n){return new G(v.tag,Rn(r,e+1,n),3)}function tx(r,e,t,n){return new G(v.tag,Dn(r,e+1,n),5)}function rx(r,e,t,n){return new G(v.tag,Nn(r,e+1,n),9)}function tm(r,e){mr(r,v.tag.majorEncoded,e.value)}tm.compareTokens=Zn.compareTokens;tm.encodedSize=function(e){return mr.encodedSize(e.value)};var iL=20,sL=21,aL=22,cL=23;function nx(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${he} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new G(v.null,null,1):new G(v.undefined,void 0,1)}function ox(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return new G(v.break,void 0,1)}function J4(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${he} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${he} Infinity values are not supported`)}return new G(v.float,r,e)}function ix(r,e,t,n){return J4(e6(r,e+1),3,n)}function sx(r,e,t,n){return J4(t6(r,e+1),5,n)}function ax(r,e,t,n){return J4(fx(r,e+1),9,n)}function rm(r,e,t){let n=e.value;if(n===!1)r.push([v.float.majorEncoded|iL]);else if(n===!0)r.push([v.float.majorEncoded|sL]);else if(n===null)r.push([v.float.majorEncoded|aL]);else if(n===void 0)r.push([v.float.majorEncoded|cL]);else{let o,i=!1;(!t||t.float64!==!0)&&(lx(n),o=e6(ko,1),n===o||Number.isNaN(n)?(ko[0]=249,r.push(ko.slice(0,3)),i=!0):(ux(n),o=t6(ko,1),n===o&&(ko[0]=250,r.push(ko.slice(0,5)),i=!0))),i||(lL(n),o=fx(ko,1),ko[0]=251,r.push(ko.slice(0,9)))}}rm.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){lx(n);let o=e6(ko,1);if(n===o||Number.isNaN(n))return 3;if(ux(n),o=t6(ko,1),n===o)return 5}return 9};var cx=new ArrayBuffer(9),Jn=new DataView(cx,1),ko=new Uint8Array(cx,0);function lx(r){if(r===1/0)Jn.setUint16(0,31744,!1);else if(r===-1/0)Jn.setUint16(0,64512,!1);else if(Number.isNaN(r))Jn.setUint16(0,32256,!1);else{Jn.setFloat32(0,r);let e=Jn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Jn.setUint16(0,31744,!1);else if(t===0)Jn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let o=t-127;o<-24?Jn.setUint16(0,0):o<-14?Jn.setUint16(0,(e&2147483648)>>16|1<<24+o,!1):Jn.setUint16(0,(e&2147483648)>>16|o+15<<10|n>>13,!1)}}}function e6(r,e){if(r.length-e<2)throw new Error(`${he} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,o=t&1023,i;return n===0?i=o*2**-24:n!==31?i=(o+1024)*2**(n-25):i=o===0?1/0:NaN,t&32768?-i:i}function ux(r){Jn.setFloat32(0,r,!1)}function t6(r,e){if(r.length-e<4)throw new Error(`${he} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function lL(r){Jn.setFloat64(0,r,!1)}function fx(r,e){if(r.length-e<8)throw new Error(`${he} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}rm.compareTokens=Zn.compareTokens;function Ge(r,e,t){throw new Error(`${he} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function nm(r){return()=>{throw new Error(`${he} ${r}`)}}var ne=[];for(let r=0;r<=23;r++)ne[r]=Ge;ne[24]=vv;ne[25]=xv;ne[26]=Ev;ne[27]=Sv;ne[28]=Ge;ne[29]=Ge;ne[30]=Ge;ne[31]=Ge;for(let r=32;r<=55;r++)ne[r]=Ge;ne[56]=_v;ne[57]=Av;ne[58]=Tv;ne[59]=Cv;ne[60]=Ge;ne[61]=Ge;ne[62]=Ge;ne[63]=Ge;for(let r=64;r<=87;r++)ne[r]=Pv;ne[88]=kv;ne[89]=Ov;ne[90]=Rv;ne[91]=Dv;ne[92]=Ge;ne[93]=Ge;ne[94]=Ge;ne[95]=nm("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ne[r]=Nv;ne[120]=Lv;ne[121]=Bv;ne[122]=Mv;ne[123]=Uv;ne[124]=Ge;ne[125]=Ge;ne[126]=Ge;ne[127]=nm("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ne[r]=jv;ne[152]=Kv;ne[153]=$v;ne[154]=Vv;ne[155]=qv;ne[156]=Ge;ne[157]=Ge;ne[158]=Ge;ne[159]=Hv;for(let r=160;r<=183;r++)ne[r]=Wv;ne[184]=zv;ne[185]=Gv;ne[186]=Xv;ne[187]=Yv;ne[188]=Ge;ne[189]=Ge;ne[190]=Ge;ne[191]=Qv;for(let r=192;r<=215;r++)ne[r]=Zv;ne[216]=Jv;ne[217]=ex;ne[218]=tx;ne[219]=rx;ne[220]=Ge;ne[221]=Ge;ne[222]=Ge;ne[223]=Ge;for(let r=224;r<=243;r++)ne[r]=nm("simple values are not supported");ne[244]=Ge;ne[245]=Ge;ne[246]=Ge;ne[247]=nx;ne[248]=nm("simple values are not supported");ne[249]=ix;ne[250]=sx;ne[251]=ax;ne[252]=Ge;ne[253]=Ge;ne[254]=Ge;ne[255]=ox;var Oo=[];for(let r=0;r<24;r++)Oo[r]=new G(v.uint,r,1);for(let r=-1;r>=-24;r--)Oo[31-r]=new G(v.negint,r,1);Oo[64]=new G(v.bytes,new Uint8Array(0),1);Oo[96]=new G(v.string,"",1);Oo[128]=new G(v.array,0,1);Oo[160]=new G(v.map,0,1);Oo[244]=new G(v.false,!1,1);Oo[245]=new G(v.true,!0,1);Oo[246]=new G(v.null,null,1);function dx(r){switch(r.type){case v.false:return hi([244]);case v.true:return hi([245]);case v.null:return hi([246]);case v.bytes:return r.value.length?void 0:hi([64]);case v.string:return r.value===""?hi([96]):void 0;case v.array:return r.value===0?hi([128]):void 0;case v.map:return r.value===0?hi([160]):void 0;case v.uint:return r.value<24?hi([Number(r.value)]):void 0;case v.negint:if(r.value>=-24)return hi([31-Number(r.value)])}}var fL={float64:!1,mapSorter:hL,quickEncodeToken:dx};function dL(){let r=[];return r[v.uint.major]=Zn,r[v.negint.major]=Q1,r[v.bytes.major]=lu,r[v.string.major]=Fv,r[v.array.major]=J1,r[v.map.major]=em,r[v.tag.major]=tm,r[v.float.major]=rm,r}var px=dL(),r6=new Sd,im=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Hi} object contains circular references`);return new r(t,e)}},zs={null:new G(v.null,null),undefined:new G(v.undefined,void 0),true:new G(v.true,!0),false:new G(v.false,!1),emptyArray:new G(v.array,0),emptyMap:new G(v.map,0)},Gs={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new G(v.float,r):r>=0?new G(v.uint,r):new G(v.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new G(v.uint,r):new G(v.negint,r)},Uint8Array(r,e,t,n){return new G(v.bytes,r)},string(r,e,t,n){return new G(v.string,r)},boolean(r,e,t,n){return r?zs.true:zs.false},null(r,e,t,n){return zs.null},undefined(r,e,t,n){return zs.undefined},ArrayBuffer(r,e,t,n){return new G(v.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new G(v.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[zs.emptyArray,new G(v.break)]:zs.emptyArray;n=im.createCheck(n,r);let o=[],i=0;for(let s of r)o[i++]=om(s,t,n);return t.addBreakTokens?[new G(v.array,r.length),o,new G(v.break)]:[new G(v.array,r.length),o]},Object(r,e,t,n){let o=e!=="Object",i=o?r.keys():Object.keys(r),s=o?r.size:i.length;if(!s)return t.addBreakTokens===!0?[zs.emptyMap,new G(v.break)]:zs.emptyMap;n=im.createCheck(n,r);let a=[],c=0;for(let l of i)a[c++]=[om(l,t,n),om(o?r.get(l):r[l],t,n)];return pL(a,t),t.addBreakTokens?[new G(v.map,s),a,new G(v.break)]:[new G(v.map,s),a]}};Gs.Map=Gs.Object;Gs.Buffer=Gs.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Gs[`${r}Array`]=Gs.DataView;function om(r,e={},t){let n=dv(r),o=e&&e.typeEncoders&&e.typeEncoders[n]||Gs[n];if(typeof o=="function"){let s=o(r,n,e,t);if(s!=null)return s}let i=Gs[n];if(!i)throw new Error(`${Hi} unsupported type: ${n}`);return i(r,n,e,t)}function pL(r,e){e.mapSorter&&r.sort(e.mapSorter)}function hL(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let o=t.type.major,i=px[o].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function hx(r,e,t,n){if(Array.isArray(e))for(let o of e)hx(r,o,t,n);else t[e.type.major](r,e,n)}function n6(r,e,t){let n=om(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let o=t.quickEncodeToken(n);if(o)return o;let i=e[n.type.major];if(i.encodedSize){let s=i.encodedSize(n,t),a=new Sd(s);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Ed(a.chunks[0])}}return r6.reset(),hx(r6,n,e,t),r6.toBytes(!0)}function Xs(r,e){return e=Object.assign({},fL,e),n6(r,px,e)}var mL={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},sm=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=Oo[e];if(t===void 0){let n=ne[e];if(!n)throw new Error(`${he} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let o=e&31;t=n(this.data,this._pos,o,this.options)}return this._pos+=t.encodedLength,t}},Id=Symbol.for("DONE"),am=Symbol.for("BREAK");function yL(r,e,t){let n=[];for(let o=0;o<r.value;o++){let i=du(e,t);if(i===am){if(r.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed array`)}if(i===Id)throw new Error(`${he} found array but not enough entries (got ${o}, expected ${r.value})`);n[o]=i}return n}function gL(r,e,t){let n=t.useMaps===!0,o=n?void 0:{},i=n?new Map:void 0;for(let s=0;s<r.value;s++){let a=du(e,t);if(a===am){if(r.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed map`)}if(a===Id)throw new Error(`${he} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${he} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in o))throw new Error(`${he} found repeat map key "${a}"`);let c=du(e,t);if(c===Id)throw new Error(`${he} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?i.set(a,c):o[a]=c}return n?i:o}function du(r,e){if(r.done())return Id;let t=r.next();if(t.type===v.break)return am;if(t.type.terminal)return t.value;if(t.type===v.array)return yL(t,r,e);if(t.type===v.map)return gL(t,r,e);if(t.type===v.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=du(r,e);return e.tags[t.value](n)}throw new Error(`${he} tag not supported (${t.value})`)}throw new Error("unsupported")}function o6(r,e){if(!(r instanceof Uint8Array))throw new Error(`${he} data to decode must be a Uint8Array`);e=Object.assign({},mL,e);let t=e.tokenizer||new sm(r,e),n=du(t,e);if(n===Id)throw new Error(`${he} did not find any content to decode`);if(n===am)throw new Error(`${he} got unexpected break`);return[n,r.subarray(t.pos())]}function Ln(r,e){let[t,n]=o6(r,e);if(n.length>0)throw new Error(`${he} too many terminals, data makes no sense`);return t}function q(r,e="utf8"){let t=F1[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}var zi="/",mx=new TextEncoder().encode(zi),cm=mx[0],ct=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=q(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==cm)throw new Error("Invalid key")}toString(e="utf8"){return W(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(zi))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=mx),this._buf[0]!==cm){let e=new Uint8Array(this._buf.byteLength+1);e.fill(cm,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===cm;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let o=0;o<t.length;o++){if(n.length<o+1)return!1;let i=t[o],s=n[o];if(i<s)return!0;if(i>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(zi).slice(1)}type(){return wL(this.baseNamespace())}name(){return bL(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(zi)||(e+=zi),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(zi):new r(e.slice(0,-1).join(zi))}child(e){return this.toString()===zi?e:e.toString()===zi?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...vL(e.map(t=>t.namespaces()))])}};function wL(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function bL(r){let e=r.split(":");return e[e.length-1]}function vL(r){return[].concat(...r)}function lm({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*xL(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t],i=ue.asCID(n);i!=null?yield[o.join("/"),i]:typeof n=="object"&&(yield*s6(n,o))}else{let t=ue.asCID(e);t!=null?yield[r.join("/"),t]:yield*s6(e,r)}}function*s6(r,e){if(r==null||r instanceof Uint8Array)return;let t=ue.asCID(r);t!=null&&(yield[e.join("/"),t]);for(let[n,o]of Object.entries(r)){let i=[...e,n];yield*xL(i,o)}}function*EL(r,e){if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t];yield o.join("/"),typeof n=="object"&&ue.asCID(n)==null&&(yield*a6(n,o))}else yield*a6(e,r)}function*a6(r,e){if(!(r==null||typeof r!="object"))for(let[t,n]of Object.entries(r)){let o=[...e,t];yield o.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&ue.asCID(n)==null&&(yield*EL(o,n))}}function SL(r,e){let t=r;for(let[n,o]of e.entries()){if(t=t[o],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(s=>`[${JSON.stringify(s)}]`).join("")}`);let i=ue.asCID(t);if(i!=null)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}var c6=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:lm(),bytes:lm(),value:lm(),asBlock:lm()})}links(){return s6(this.value,[])}tree(){return a6(this.value,[])}get(e="/"){return SL(this.value,e.split("/").filter(Boolean))}};function yx({bytes:r,cid:e,value:t,codec:n}){let o=t!==void 0?t:n?.decode(r);if(o===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new c6({cid:e,bytes:r,value:o})}function me(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var bx="/pin/",gx="/pinned-block/",l6=pi,wx=1;function um(r){return r.version===0&&(r=r.toV1()),new ct(`${bx}${r.toString(l6)}`)}var fm=class{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){let n=um(e);if(await this.datastore.has(n))throw new Error("Already pinned");let o=Math.round(t.depth??1/0);if(o<0)throw new Error("Depth must be greater than or equal to 0");let i=new hr({concurrency:wx});for await(let a of this.#e(e,i,{...t,depth:o}))await this.#t(a,c=>c.pinnedBy.find(l=>me(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let s={depth:o,metadata:t.metadata??{}};await this.datastore.put(n,Xs(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let o=await this.getCodec(e.code),i=await this.blockstore.get(e,n),s=yx({bytes:i,cid:e,codec:o});yield e;for(let[,a]of s.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){let o=new ct(`${gx}${l6.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=Ln(await this.datastore.get(o,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(i)){if(i.pinCount===0&&await this.datastore.has(o)){await this.datastore.delete(o);return}await this.datastore.put(o,Xs(i),n),n.onProgress?.(new ce("helia:pin:add",e))}}async*rm(e,t={}){let n=um(e),o=await this.datastore.get(n,t),i=Ln(o);await this.datastore.delete(n,t);let s=new hr({concurrency:wx});for await(let a of this.#e(e,s,{...t,depth:i.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>me(l,e.bytes)),!0),{...t,depth:i.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:bx+(e.cid!=null?`${e.cid.toString(pi)}`:"")},e)){let o=ue.parse(t.toString().substring(5),pi),i=Ln(n);yield{cid:o,...i}}}async isPinned(e,t={}){let n=new ct(`${gx}${l6.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){let n=um(e),o=await this.datastore.get(n,t);return Ln(o)}async setMetadata(e,t,n){let o=um(e),i=await this.datastore.get(o,n),s=Ln(i);s.metadata=t??{},await this.datastore.put(o,Xs(s),n)}};var u6=1,f6=5;var Cd=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}},Ys=class extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}},Pd=class extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}},kd=class extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}};var yr=class extends hr{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var d6=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=ve(),this.haveNext=ve()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ve(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ve(),await nt(this.readNext.promise,t?.signal,t)}};function dm(){return new d6}function _L(r){return r[Symbol.asyncIterator]!=null}async function AL(r,e,t){try{await Promise.all(r.map(async n=>{for await(let o of n)await e.push(o,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*TL(r){let e=new AbortController,t=dm();AL(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*IL(r){for(let e of r)yield*e}function CL(...r){let e=[];for(let t of r)_L(t)||e.push(t);return e.length===r.length?IL(e):TL(r)}var Xr=CL;var PL=5,pm=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??PL,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await pr(...this.routers)}async stop(){await Nr(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Ys("No content routers available");let n=new yr({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(let o of Xr(n.toGenerator(),...sc(this.routers,"findProviders").map(i=>i.findProviders(e,t))))if(o!=null){if(o.multiaddrs.length===0){if(n.find(o.id)!=null)continue;n.add(async()=>{try{let i=await this.findPeer(o.id,t);return i.multiaddrs.length===0?null:i}catch(i){return this.log.error("could not load multiaddrs for peer %p",o.id,i),null}},{peerId:o.id,signal:t.signal}).catch(i=>{this.log.error("could not load multiaddrs for peer %p",o.id,i)})}yield o}}async provide(e,t={}){if(this.routers.length===0)throw new Ys("No content routers available");await Promise.all(sc(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(sc(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(sc(this.routers,"put").map(async o=>{await o.put(e,t,n)}))}async get(e,t){return Promise.any(sc(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new Ys("No peer routers available");let n=this,o=Xr(...sc(this.routers,"findPeer").map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let i of o)if(i!=null)return i;throw new qe("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Ys("No peer routers available");for await(let n of Xr(...sc(this.routers,"getClosestPeers").map(o=>o.getClosestPeers(e,t))))n!=null&&(yield n)}};function sc(r,e){return r.filter(t=>t[e]!=null)}var hm=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var mm=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new kn)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function kL(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var ym=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=kL(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new kn),this.cleanup())}async join(e={}){let t=new mm(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await nt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function p6(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var Od=class extends De{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=p6(this.emitEmpty.bind(this),1),this.emitIdle=p6(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new hm;let n=new ym(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new kn)}),this.clear()}async onEmpty(e){this.size!==0&&await Dt(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Dt(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Dt(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=sr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new kn("Queue aborted"))};this.addEventListener("success",o),this.addEventListener("failure",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",o),this.removeEventListener("failure",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var gm="lock:worker:request-read",wm="lock:worker:abort-read-request",bm="lock:worker:release-read",vm="lock:master:grant-read",xm="lock:master:error-read",Em="lock:worker:request-write",Sm="lock:worker:abort-write-request",_m="lock:worker:release-write",Am="lock:master:grant-write",Tm="lock:master:error-write",Im="lock:worker:finalize",Cm="mortice",vx={singleProcess:!1};var h6=(r,e,t,n,o,i,s,a,c)=>l=>{if(l.data==null)return;let u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===o&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(f=>{let d=p=>{if(p?.data==null)return;let m={type:p.data.type,name:p.data.name,identifier:p.data.identifier};m.type===a&&m.identifier===u.identifier&&(e.removeEventListener("message",d),f())};e.addEventListener("message",d)})},onError:f=>{e.postMessage({type:s,name:u.name,identifier:u.identifier,error:{message:f.message,name:f.name,stack:f.stack}})}}}),u.type===i&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===Im&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})};var xx=(r=10)=>Math.random().toString().substring(2,r+2);var Pm=class{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(Cm)}readLock(e){return this.sendRequest(gm,wm,vm,xm,bm,e)}writeLock(e){return this.sendRequest(Em,Sm,Am,Tm,_m,e)}finalize(){this.channel.postMessage({type:Im,name:this.name}),this.channel.close()}async sendRequest(e,t,n,o,i,s){s?.signal?.throwIfAborted();let a=xx();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{let u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};s?.signal?.addEventListener("abort",u,{once:!0});let f=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),d.data.type===o)){this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u);let p=new Error;d.data.error!=null&&(p.message=d.data.error.message,p.name=d.data.error.name,p.stack=d.data.error.stack),l(p)}};this.channel.addEventListener("message",f)})}};var Ex=r=>{if(r=Object.assign({},vx,r),!!globalThis.document||r.singleProcess){let t=new BroadcastChannel(Cm),n=new De;return t.addEventListener("message",h6(n,t,"requestReadLock","abortReadLockRequest",gm,wm,xm,bm,vm)),t.addEventListener("message",h6(n,t,"requestWriteLock","abortWriteLockRequest",Em,Sm,Tm,_m,Am)),n}return new Pm(r.name)};var ac=new Map,Rd;function Sx(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function OL(r){if(Rd==null&&(Rd=Ex(r),!Sx(Rd))){let e=Rd;e.addEventListener("requestReadLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=ac.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=ac.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{let n=t.detail.name,o=ac.get(n);o?.finalize()})}return Rd}async function m6(r,e){let t,n,o=new Promise((s,a)=>{t=s,n=a}),i=()=>{n(new kn)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(s=>{t(()=>{e?.signal?.removeEventListener("abort",i),s()})})},{signal:e?.signal}).catch(s=>{n(s)}),o}var _x=(r,e)=>{let t=ac.get(r);if(t!=null)return t;let n=OL(e);if(Sx(n))return t=n,ac.set(r,t),t;let o=new Od({concurrency:1}),i;return t={async readLock(s){if(i!=null)return m6(i,s);i=new Od({concurrency:e.concurrency,autoStart:!1});let a=i,c=m6(i,s);return o.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(s){return i=null,m6(o,s)},finalize:()=>{ac.delete(r)},queue:o},ac.set(r,t),e.autoFinalize===!0&&o.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var RL={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Dd(r){let e=Object.assign({},RL,r);return _x(e.name,e)}var km=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Dd({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await pr(this.child),this.started=!0}async stop(){await Nr(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();let o=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{o()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{let o=this;yield*this.child.deleteMany(async function*(){for await(let i of e){if(await o.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}};var y6=new ct("/version"),Ax=1;async function Tx(r){if(!await r.has(y6)){await r.put(y6,q(`${Ax}`));return}let e=await r.get(y6),t=W(e);if(parseInt(t,10)!==Ax)throw new Error("Unknown datastore version, a datastore migration may be required")}var b6={};kt(b6,{code:()=>w6,decode:()=>KL,decodeOptions:()=>UL,encode:()=>jL,encodeOptions:()=>BL,name:()=>FL,toByteView:()=>Cx});var Ix=42;function Cx(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function DL(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=ue.asCID(r);if(!e)return null;let t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new G(v.tag,Ix),new G(v.bytes,t)]}function NL(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function LL(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var g6={float64:!0,typeEncoders:{Object:DL,undefined:NL,number:LL}},BL={...g6,typeEncoders:{...g6.typeEncoders}};function ML(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return ue.decode(r.subarray(1))}var Om={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Om.tags[Ix]=ML;var UL={...Om,tags:Om.tags.slice()},FL="dag-cbor",w6=113,jL=r=>Xs(r,g6),KL=r=>Ln(Cx(r),Om);var T6={};kt(T6,{code:()=>A6,decode:()=>kx,encode:()=>Px,format:()=>ZL,name:()=>QL,parse:()=>eB,stringify:()=>ZL});var v6=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===v.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===v.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[v.uint.major](e,t){this.prefix(e);let n=String(t.value),o=[];for(let i=0;i<n.length;i++)o[i]=n.charCodeAt(i);e.push(o)}[v.negint.major](e,t){this[v.uint.major](e,t)}[v.bytes.major](e,t){throw new Error(`${Hi} unsupported type: Uint8Array`)}[v.string.major](e,t){this.prefix(e);let n=Y1(JSON.stringify(t.value));e.push(n.length>32?Ed(n):n)}[v.array.major](e,t){this.prefix(e),this.inRecursive.push({type:v.array,elements:0}),e.push([91])}[v.map.major](e,t){this.prefix(e),this.inRecursive.push({type:v.map,elements:0}),e.push([123])}[v.tag.major](e,t){}[v.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===v.array)e.push([93]);else if(s.type===v.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Hi} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),o=[],i=!1;for(let s=0;s<n.length;s++)o[s]=n.charCodeAt(s),!i&&(o[s]===46||o[s]===101||o[s]===69)&&(i=!0);i||(o.push(46),o.push(48)),e.push(o)}};function $L(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Hi} complex map keys are not supported`);let t=r[0],n=e[0];if(t.type!==v.string||n.type!==v.string)throw new Error(`${Hi} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Hi} unexpected duplicate map keys, this is not supported`)}var VL={addBreakTokens:!0,mapSorter:$L};function x6(r,e){return e=Object.assign({},VL,e),n6(r,new v6,e)}var pu=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${he} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${he} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,o=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new G(v.uint,0,this._pos-e);if(o([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${he} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${he} unexpected token at position ${this._pos}`);n=!0,this._pos++,o([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,o([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(i);return n?new G(v.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new G(s>=0?v.uint:v.negint,s,this._pos-e):new G(s>=0?v.uint:v.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${he} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,s=0;i<this.data.length&&s<65536;i++,s++){let a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new G(v.string,c,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${he} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let s=0;s<4;s++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${he} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},o=()=>{let i=this.ch(),s=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${he} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:i<128&&(s=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(i&31)<<6|c&63,f>127&&(s=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(i&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(s=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(i&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(s=f))}s===null?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=a};for(;!this.done();){let i=this.ch(),s;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${he} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${he} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new G(v.string,Q4(t),this._pos-e);default:if(i<32)throw new Error(`${he} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):o()}}throw new Error(`${he} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new G(v.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new G(v.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new G(v.null,null,4);case 102:return this.expect([102,97,108,115,101]),new G(v.false,!1,5);case 116:return this.expect([116,114,117,101]),new G(v.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${he} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new G(v.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new G(v.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new G(v.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new G(v.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${he} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function E6(r,e){return e=Object.assign({tokenizer:new pu(r,e)},e),Ln(r,e)}function HL(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function WL(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=ue.asCID(r);if(!e)return null;let t=e.toString();return[new G(v.map,1/0,1),new G(v.string,"/",1),new G(v.string,t,t.length),new G(v.break,void 0,1)]}function Rm(r){let e=Ht.encode(r).slice(1);return[new G(v.map,1/0,1),new G(v.string,"/",1),new G(v.map,1/0,1),new G(v.string,"bytes",5),new G(v.string,e,e.length),new G(v.break,void 0,1),new G(v.break,void 0,1)]}function Ro(r){return Rm(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function zL(r){return Rm(new Uint8Array(r))}function GL(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function XL(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var YL={typeEncoders:{Object:WL,Buffer:Rm,Uint8Array:Rm,Int8Array:Ro,Uint16Array:Ro,Int16Array:Ro,Uint32Array:Ro,Int32Array:Ro,Float32Array:Ro,Float64Array:Ro,Uint8ClampedArray:Ro,BigInt64Array:Ro,BigUint64Array:Ro,DataView:Ro,ArrayBuffer:zL,undefined:GL,number:XL}},S6=class extends pu{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===v.map){let t=this._next();if(t.type===v.string&&t.value==="/"){let n=this._next();if(n.type===v.string){if(this._next().type!==v.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new G(v.tag,42,0)}if(n.type===v.map){let o=this._next();if(o.type===v.string&&o.value==="bytes"){let i=this._next();if(i.type===v.string){for(let a=0;a<2;a++)if(this._next().type!==v.break)throw new Error("Invalid encoded Bytes form");let s=Ht.decode(`m${i.value}`);return new G(v.bytes,s,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(o)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},_6={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};_6.tags[42]=ue.parse;var QL="dag-json",A6=297,Px=r=>x6(r,YL),kx=r=>{let e=HL(r),t=Object.assign(_6,{tokenizer:new S6(e,_6)});return E6(e,t)},ZL=r=>JL.decode(Px(r));var JL=new TextDecoder,eB=r=>kx(tB.encode(r)),tB=new TextEncoder;var R6={};kt(R6,{code:()=>O6,createLink:()=>jx,createNode:()=>Fx,decode:()=>hB,encode:()=>pB,name:()=>dB,prepare:()=>P6,validate:()=>k6});var rB=new TextDecoder;function I6(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let o=r[e++];if(t+=n<28?(o&127)<<n:(o&127)*2**n,o<128)break}return[t,e]}function Dm(r,e){let t;[t,e]=I6(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function Ox(r,e){let t;return[t,e]=I6(r,e),[t&7,t>>3,e]}function nB(r){let e={},t=r.length,n=0;for(;n<t;){let o,i;if([o,i,n]=Ox(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Dm(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=Dm(r,n),e.Name=rB.decode(s)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(o!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Tsize`);[e.Tsize,n]=I6(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function Rx(r){let e=r.length,t=0,n,o=!1,i;for(;t<e;){let a,c;if([a,c,t]=Ox(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=Dm(r,t),n&&(o=!0)}else if(c===2){if(o)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Dm(r,t),n.push(nB(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return i&&(s.Data=i),s.Links=n||[],s}var Nx=new TextEncoder,Dx=2**32,oB=2**31;function iB(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=Nd(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){let n=Nx.encode(r.Name);t-=n.length,e.set(n,t),t=Nd(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=Nd(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function Lx(r){let e=aB(r),t=new Uint8Array(e),n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=Nd(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let o=r.Links.length-1;o>=0;o--){let i=iB(r.Links[o],t.subarray(0,n));n-=i,n=Nd(t,n,i)-1,t[n]=18}return t}function sB(r){let e=0;if(r.Hash){let t=r.Hash.length;e+=1+t+hu(t)}if(typeof r.Name=="string"){let t=Nx.encode(r.Name).length;e+=1+t+hu(t)}return typeof r.Tsize=="number"&&(e+=1+hu(r.Tsize)),e}function aB(r){let e=0;if(r.Data){let t=r.Data.length;e+=1+t+hu(t)}if(r.Links)for(let t of r.Links){let n=sB(t);e+=1+n+hu(n)}return e}function Nd(r,e,t){e-=hu(t);let n=e;for(;t>=oB;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function hu(r){return r%2===0&&r++,Math.floor((cB(r)+6)/7)}function cB(r){let e=0;return r>=Dx&&(r=Math.floor(r/Dx),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+lB[r]}var lB=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var uB=["Data","Links"],fB=["Hash","Name","Tsize"],C6=new TextEncoder;function Mx(r,e){if(r===e)return 0;let t=r.Name?C6.encode(r.Name):[],n=e.Name?C6.encode(e.Name):[],o=t.length,i=n.length;for(let s=0,a=Math.min(o,i);s<a;++s)if(t[s]!==n[s]){o=t[s],i=n[s];break}return o<i?-1:i<o?1:0}function Bx(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function Ux(r){if(typeof r.asCID=="object"){let t=ue.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Hash){let t=ue.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=ue.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=ue.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function P6(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=C6.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(Ux),e.Links.sort(Mx);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function k6(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!Bx(r,uB))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){let t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!Bx(t,fB))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&Mx(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function Fx(r,e=[]){return P6({Data:r,Links:e})}function jx(r,e,t){return Ux({Hash:t,Name:r,Tsize:e})}function Kx(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}var dB="dag-pb",O6=112;function pB(r){k6(r);let e={};return r.Links&&(e.Links=r.Links.map(t=>{let n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),Lx(e)}function hB(r){let e=Kx(r),t=Rx(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(o=>{let i={};try{i.Hash=ue.decode(o.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return o.Name!==void 0&&(i.Name=o.Name),o.Tsize!==void 0&&(i.Tsize=o.Tsize),i})),n}function mu(r){return r?.then!=null}function $x(r=[],e){let t={[O6]:R6,[rc]:nu,[w6]:b6,[A6]:T6,[B4]:B1};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);mu(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new kd(`Could not load codec for ${n}`)}}function Vx(r=[],e){let t={[wt.code]:wt,[U1.code]:U1,[Mr.code]:Mr};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);mu(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new Pd(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}function Oe(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let o=e.signal;return o.clear=n,o}var eo=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not Found"){super(e)}};var Gi=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:o}of e)await this.put(n,o,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var Nm=0,Lm=class extends Gi{child;constructor(e){super(),this.child=e}put(e,t,n){return e.multihash.code===Nm||this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}get(e,t){if(e.multihash.code===Nm)return t?.signal?.throwIfAborted(),e.multihash.digest;if(this.child==null)throw t?.signal?.throwIfAborted(),new eo;return this.child.get(e,t)}has(e,t){return e.multihash.code===Nm?(t?.signal?.throwIfAborted(),!0):this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===Nm){t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}getAll(e){return this.child!=null?this.child.getAll(e):(e?.signal?.throwIfAborted(),[])}};function mB(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var yu=mB;function yB(r){return r[Symbol.asyncIterator]!=null}function gB(r,e){let t=0;if(yB(r))return async function*(){for await(let c of r)await e(c,t++)&&(yield c)}();let n=yu(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();let s=e(o,t++);if(typeof s.then=="function")return async function*(){await s&&(yield o);for(let c of n)await e(c,t++)&&(yield c)}();let a=e;return function*(){s===!0&&(yield o);for(let c of n)a(c,t++)&&(yield c)}()}var Do=gB;function wB(r){return r[Symbol.asyncIterator]!=null}function qx(r){return r?.then!=null}function bB(r,e){let t=0;if(wB(r))return async function*(){for await(let c of r){let l=e(c,t++);qx(l)&&await l,yield c}}();let n=yu(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();if(typeof e(o,t++)?.then=="function")return async function*(){yield o;for(let c of n){let l=e(c,t++);qx(l)&&await l,yield c}}();let a=e;return function*(){yield o;for(let c of n)a(c,t++),yield c}()}var cc=bB;var Bm=class{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Lm(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new ce("blocks:put:duplicate",e)),e):(n.onProgress?.(new ce("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(e,t,n))),n.onProgress?.(new ce("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=Do(e,async({cid:i})=>{let s=await this.child.has(i,t);return s&&t.onProgress?.(new ce("blocks:put-many:duplicate",i)),!s}),o=cc(n,async({cid:i,block:s})=>{t.onProgress?.(new ce("blocks:put-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(i,s,t)))});t.onProgress?.(new ce("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(o,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){let n=await this.getHasher(e.multihash.code);t.onProgress?.(new ce("blocks:get:providers:get",e));let o=await Hx(e,this.components.blockBrokers,n,{...t,log:this.log});return t.onProgress?.(new ce("blocks:get:blockstore:put",e)),await this.child.put(e,o,t),t.onProgress?.(new ce("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,o,t))),o}return t.onProgress?.(new ce("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new ce("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(cc(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){let o=await this.getHasher(n.multihash.code);t.onProgress?.(new ce("blocks:get-many:providers:get",n));let i=await Hx(n,this.components.blockBrokers,o,{...t,log:this.log});t.onProgress?.(new ce("blocks:get-many:blockstore:put",n)),await this.child.put(n,i,t),t.onProgress?.(new ce("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(n,i,t)))}}))}async delete(e,t={}){t.onProgress?.(new ce("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new ce("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new ce("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},Mm=class extends Bm{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await pr(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Nr(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let n=this.components.blockBrokers.map(o=>o.createSession==null?o:o.createSession(t));return new D6({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}},D6=class extends Bm{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){let o=Oe([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:o})}finally{o.clear()}}async*putMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){let t=Oe([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function vB(r){return typeof r.retrieve=="function"}var xB=(r,e)=>{if(e==null)throw new M(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n,o=e.digest(t);if(mu(o)?n=await o:n=o,!me(n.digest,r.multihash.digest))throw new Vs("Hash of downloaded block did not match multihash from passed CID")}};async function Hx(r,e,t,n){let o=xB(r,t),i=new AbortController,s=Oe([i.signal,n.signal]);i.signal;let a=[];for(let c of e)vB(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1,u=await c.retrieve(r,{...n,signal:s,validateFn:async f=>{await o(f),l=!0}});return l||await o(u),u}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{i.abort(),s.clear()}}var Ld=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},Bd=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},Um=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Wx={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new Um("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var Wt=Wx;function St(r,e){e==null&&(e=r.reduce((o,i)=>o+i.length,0));let t=Tt(e),n=0;for(let o of r)t.set(o,n),n+=o.length;return t}var Gx=Symbol.for("@achingbrain/uint8arraylist");function zx(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let o=t+n.byteLength;if(e<o)return{buf:n,index:e-t};t=o}throw new RangeError("index is out of bounds")}function gu(r){return!!r?.[Gx]}var xe=class r{bufs;length;[Gx]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(gu(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(gu(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=zx(this.bufs,e);return t.buf[t.index]}set(e,t){let n=zx(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(gu(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:o}=this._subList(e,t);return St(n,o)}subarray(e,t){let{bufs:n,length:o}=this._subList(e,t);return n.length===1?n[0]:St(n,o)}sublist(e,t){let{bufs:n,length:o}=this._subList(e,t),i=new r;return i.length=o,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let i=0;i<this.bufs.length;i++){let s=this.bufs[i],a=o,c=a+s.byteLength;if(o=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(s);break}let f=e-a;n.push(s.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(s);continue}n.push(s.subarray(e-a));continue}if(u){if(t===c){n.push(s);break}n.push(s.subarray(0,t-a));break}n.push(s)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!gu(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let i=256,s=new Int32Array(i);for(let f=0;f<i;f++)s[f]=-1;for(let f=0;f<o;f++)s[n[f]]=f;let a=s,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let d=l;d>=0;d--){let p=this.get(f+d);if(n[d]!==p){u=Math.max(1,d-a[p]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Tt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let o=Ce(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,t,n),this.write(o,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let o=Ce(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,t,n),this.write(o,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let o=Ce(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,t,n),this.write(o,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Tt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let o=Ce(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,t,n),this.write(o,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let o=Ce(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,t,n),this.write(o,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let o=Ce(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,t,n),this.write(o,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let o=Ce(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,t,n),this.write(o,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let o=Ce(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,t,n),this.write(o,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!me(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((o,i)=>o+i.byteLength,0)),n.length=t,n}};var SB=parseInt("11111",2),N6=parseInt("10000000",2),_B=parseInt("01111111",2),Xx={0:Md,1:Md,2:AB,3:CB,4:PB,5:IB,6:TB,16:Md,22:Md,48:Md};function to(r,e={offset:0}){let t=r[e.offset]&SB;if(e.offset++,Xx[t]!=null)return Xx[t](r,e);throw new Error("No decoder for tag "+t)}function Ud(r,e){let t=0;if((r[e.offset]&N6)===N6){let n=r[e.offset]&_B,o="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)o+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(o,16)}else t=r[e.offset],e.offset++;return t}function Md(r,e){Ud(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=to(r,e);if(n===null)break;t.push(n)}return t}function AB(r,e){let t=Ud(r,e),n=e.offset,o=e.offset+t,i=[];for(let s=n;s<o;s++)s===n&&r[s]===0||i.push(r[s]);return e.offset+=t,Uint8Array.from(i)}function TB(r,e){let t=Ud(r,e),n=e.offset+t,o=r[e.offset];e.offset++;let i=0,s=0;o<40?(i=0,s=o):o<80?(i=1,s=o-40):(i=2,s=o-80);let a=`${i}.${s}`,c=[];for(;e.offset<n;){let l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let f=0;f<c.length;f++)u+=c[f]<<f*7;a+=`.${u}`,c=[]}}return a}function IB(r,e){return e.offset++,null}function CB(r,e){let t=Ud(r,e),n=r[e.offset];e.offset++;let o=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function PB(r,e){let t=Ud(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function kB(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new xe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Fm(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=kB(r.byteLength);return new xe(Uint8Array.from([e.byteLength|N6]),e)}function Yr(r){let e=new xe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new xe(Uint8Array.from([2]),Fm(e),e)}function Fd(r){let e=Uint8Array.from([0]),t=new xe(e,r);return new xe(Uint8Array.from([3]),Fm(t),t)}function Yx(r){return new xe(Uint8Array.from([4]),Fm(r),r)}function No(r,e=48){let t=new xe;for(let n of r)t.append(n);return new xe(Uint8Array.from([e]),Fm(t),t)}var Qx="1.2.840.10045.3.1.7",Zx="1.3.132.0.34",Jx="1.3.132.0.35";async function eE(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function tE(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();let o=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function rE(r,e,t,n){let o=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,e,t.subarray());return n?.signal?.throwIfAborted(),i}var OB=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),RB=Uint8Array.from([6,5,43,129,4,0,34]),DB=Uint8Array.from([6,5,43,129,4,0,35]),nE={ext:!0,kty:"EC",crv:"P-256"},oE={ext:!0,kty:"EC",crv:"P-384"},iE={ext:!0,kty:"EC",crv:"P-521"},wu=32,bu=48,vu=66;function sE(r){let e=to(r);return L6(e)}function L6(r){let e=r[1],t=W(e,"base64url"),n=r[2][1][0],o=1,i,s;if(e.byteLength===wu)return i=W(n.subarray(o,o+wu),"base64url"),s=W(n.subarray(o+wu),"base64url"),new uc({...nE,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===bu)return i=W(n.subarray(o,o+bu),"base64url"),s=W(n.subarray(o+bu),"base64url"),new uc({...oE,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===vu)return i=W(n.subarray(o,o+vu),"base64url"),s=W(n.subarray(o+vu),"base64url"),new uc({...iE,key_ops:["sign"],d:t,x:i,y:s});throw new M(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function B6(r){let e=to(r);return aE(e)}function aE(r){let e=r[1][1][0],t=1,n,o;if(e.byteLength===wu*2+1)return n=W(e.subarray(t,t+wu),"base64url"),o=W(e.subarray(t+wu),"base64url"),new lc({...nE,key_ops:["verify"],x:n,y:o});if(e.byteLength===bu*2+1)return n=W(e.subarray(t,t+bu),"base64url"),o=W(e.subarray(t+bu),"base64url"),new lc({...oE,key_ops:["verify"],x:n,y:o});if(e.byteLength===vu*2+1)return n=W(e.subarray(t,t+vu),"base64url"),o=W(e.subarray(t+vu),"base64url"),new lc({...iE,key_ops:["verify"],x:n,y:o});throw new M(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function cE(r){return No([Yr(Uint8Array.from([1])),Yx(q(r.d??"","base64url")),No([uE(r.crv)],160),No([Fd(new xe(Uint8Array.from([4]),q(r.x??"","base64url"),q(r.y??"","base64url")))],161)]).subarray()}function lE(r){return No([Yr(Uint8Array.from([1])),No([uE(r.crv)],160),No([Fd(new xe(Uint8Array.from([4]),q(r.x??"","base64url"),q(r.y??"","base64url")))],161)]).subarray()}function uE(r){if(r==="P-256")return OB;if(r==="P-384")return RB;if(r==="P-521")return DB;throw new M(`Invalid curve ${r}`)}async function fE(r="P-256"){let e=await eE(r);return new uc(e.privateKey)}var lc=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=lE(this.jwk)),this._raw}toMultihash(){return Mr.digest(cr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return rt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}async verify(e,t,n){return rE(this.jwk,t,e,n)}},uc=class{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new lc({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=cE(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}async sign(e,t){return tE(this.jwk,e,t)}};var fc=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function dc(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Lo(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function It(r,...e){if(!dc(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Yi(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Lo(r.outputLen),Lo(r.blockLen)}function Eu(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function pE(r,e){It(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ur(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function pc(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Bo(r,e){return r<<32-e|r>>>e}function jm(r,e){return r<<e|r>>>32-e>>>0}var hE=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",NB=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ro(r){if(It(r),hE)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=NB[r[t]];return e}var Xi={_0:48,_9:57,A:65,F:70,a:97,f:102};function dE(r){if(r>=Xi._0&&r<=Xi._9)return r-Xi._0;if(r>=Xi.A&&r<=Xi.F)return r-(Xi.A-10);if(r>=Xi.a&&r<=Xi.f)return r-(Xi.a-10)}function hc(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(hE)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let o=0,i=0;o<t;o++,i+=2){let s=dE(r.charCodeAt(i)),a=dE(r.charCodeAt(i+1));if(s===void 0||a===void 0){let c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[o]=s*16+a}return n}var LB=async()=>{};async function mE(r,e,t){let n=Date.now();for(let o=0;o<r;o++){t(o);let i=Date.now()-n;i>=0&&i<e||(await LB(),n+=i)}}function Km(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Qs(r){return typeof r=="string"&&(r=Km(r)),It(r),r}function M6(r){return typeof r=="string"&&(r=Km(r)),It(r),r}function cn(...r){let e=0;for(let n=0;n<r.length;n++){let o=r[n];It(o),e+=o.length}let t=new Uint8Array(e);for(let n=0,o=0;n<r.length;n++){let i=r[n];t.set(i,o),o+=i.length}return t}function yE(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}var xu=class{};function jd(r){let e=n=>r().update(Qs(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Qi(r=32){if(fc&&typeof fc.getRandomValues=="function")return fc.getRandomValues(new Uint8Array(r));if(fc&&typeof fc.randomBytes=="function")return Uint8Array.from(fc.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function BB(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function $m(r,e,t){return r&e^~r&t}function Vm(r,e,t){return r&e^r&t^e&t}var mc=class extends xu{constructor(e,t,n,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(e),this.view=pc(this.buffer)}update(e){Eu(this),e=Qs(e),It(e);let{view:t,buffer:n,blockLen:o}=this,i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=pc(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Eu(this),pE(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,Ur(this.buffer.subarray(s)),this.padOffset>o-s&&(this.process(n,0),s=0);for(let f=s;f<o;f++)t[f]=0;BB(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=pc(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.destroyed=s,e.finished=i,e.length=o,e.pos=a,o%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Zi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var gr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var qm=BigInt(4294967295),gE=BigInt(32);function MB(r,e=!1){return e?{h:Number(r&qm),l:Number(r>>gE&qm)}:{h:Number(r>>gE&qm)|0,l:Number(r&qm)|0}}function wE(r,e=!1){let t=r.length,n=new Uint32Array(t),o=new Uint32Array(t);for(let i=0;i<t;i++){let{h:s,l:a}=MB(r[i],e);[n[i],o[i]]=[s,a]}return[n,o]}var U6=(r,e,t)=>r>>>t,F6=(r,e,t)=>r<<32-t|e>>>t,yc=(r,e,t)=>r>>>t|e<<32-t,gc=(r,e,t)=>r<<32-t|e>>>t,Kd=(r,e,t)=>r<<64-t|e>>>t-32,$d=(r,e,t)=>r>>>t-32|e<<64-t;function mi(r,e,t,n){let o=(e>>>0)+(n>>>0);return{h:r+t+(o/2**32|0)|0,l:o|0}}var bE=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),vE=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,xE=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),EE=(r,e,t,n,o)=>e+t+n+o+(r/2**32|0)|0,SE=(r,e,t,n,o)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(o>>>0),_E=(r,e,t,n,o,i)=>e+t+n+o+i+(r/2**32|0)|0;var FB=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Zs=new Uint32Array(64),Hm=class extends mc{constructor(e=32){super(64,e,8,!1),this.A=Zi[0]|0,this.B=Zi[1]|0,this.C=Zi[2]|0,this.D=Zi[3]|0,this.E=Zi[4]|0,this.F=Zi[5]|0,this.G=Zi[6]|0,this.H=Zi[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Zs[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let d=Zs[f-15],p=Zs[f-2],m=Bo(d,7)^Bo(d,18)^d>>>3,g=Bo(p,17)^Bo(p,19)^p>>>10;Zs[f]=g+Zs[f-7]+m+Zs[f-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let d=Bo(a,6)^Bo(a,11)^Bo(a,25),p=u+d+$m(a,c,l)+FB[f]+Zs[f]|0,g=(Bo(n,2)^Bo(n,13)^Bo(n,22))+Vm(n,o,i)|0;u=l,l=c,c=a,a=s+p|0,s=i,i=o,o=n,n=p+g|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,o,i,s,a,c,l,u)}roundClean(){Ur(Zs)}destroy(){this.set(0,0,0,0,0,0,0,0),Ur(this.buffer)}};var AE=wE(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),jB=AE[0],KB=AE[1],Js=new Uint32Array(80),ea=new Uint32Array(80),Wm=class extends mc{constructor(e=64){super(128,e,16,!1),this.Ah=gr[0]|0,this.Al=gr[1]|0,this.Bh=gr[2]|0,this.Bl=gr[3]|0,this.Ch=gr[4]|0,this.Cl=gr[5]|0,this.Dh=gr[6]|0,this.Dl=gr[7]|0,this.Eh=gr[8]|0,this.El=gr[9]|0,this.Fh=gr[10]|0,this.Fl=gr[11]|0,this.Gh=gr[12]|0,this.Gl=gr[13]|0,this.Hh=gr[14]|0,this.Hl=gr[15]|0}get(){let{Ah:e,Al:t,Bh:n,Bl:o,Ch:i,Cl:s,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:d,Gh:p,Gl:m,Hh:g,Hl:y}=this;return[e,t,n,o,i,s,a,c,l,u,f,d,p,m,g,y]}set(e,t,n,o,i,s,a,c,l,u,f,d,p,m,g,y){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=o|0,this.Ch=i|0,this.Cl=s|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=d|0,this.Gh=p|0,this.Gl=m|0,this.Hh=g|0,this.Hl=y|0}process(e,t){for(let D=0;D<16;D++,t+=4)Js[D]=e.getUint32(t),ea[D]=e.getUint32(t+=4);for(let D=16;D<80;D++){let U=Js[D-15]|0,X=ea[D-15]|0,K=yc(U,X,1)^yc(U,X,8)^U6(U,X,7),ee=gc(U,X,1)^gc(U,X,8)^F6(U,X,7),$=Js[D-2]|0,B=ea[D-2]|0,S=yc($,B,19)^Kd($,B,61)^U6($,B,6),x=gc($,B,19)^$d($,B,61)^F6($,B,6),P=xE(ee,x,ea[D-7],ea[D-16]),k=EE(P,K,S,Js[D-7],Js[D-16]);Js[D]=k|0,ea[D]=P|0}let{Ah:n,Al:o,Bh:i,Bl:s,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:d,Fh:p,Fl:m,Gh:g,Gl:y,Hh:b,Hl:C}=this;for(let D=0;D<80;D++){let U=yc(f,d,14)^yc(f,d,18)^Kd(f,d,41),X=gc(f,d,14)^gc(f,d,18)^$d(f,d,41),K=f&p^~f&g,ee=d&m^~d&y,$=SE(C,X,ee,KB[D],ea[D]),B=_E($,b,U,K,jB[D],Js[D]),S=$|0,x=yc(n,o,28)^Kd(n,o,34)^Kd(n,o,39),P=gc(n,o,28)^$d(n,o,34)^$d(n,o,39),k=n&i^n&a^i&a,F=o&s^o&c^s&c;b=g|0,C=y|0,g=p|0,y=m|0,p=f|0,m=d|0,{h:f,l:d}=mi(l|0,u|0,B|0,S|0),l=a|0,u=c|0,a=i|0,c=s|0,i=n|0,s=o|0;let H=bE(S,P,F);n=vE(H,B,x,k),o=H|0}({h:n,l:o}=mi(this.Ah|0,this.Al|0,n|0,o|0)),{h:i,l:s}=mi(this.Bh|0,this.Bl|0,i|0,s|0),{h:a,l:c}=mi(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=mi(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:d}=mi(this.Eh|0,this.El|0,f|0,d|0),{h:p,l:m}=mi(this.Fh|0,this.Fl|0,p|0,m|0),{h:g,l:y}=mi(this.Gh|0,this.Gl|0,g|0,y|0),{h:b,l:C}=mi(this.Hh|0,this.Hl|0,b|0,C|0),this.set(n,o,i,s,a,c,l,u,f,d,p,m,g,y,b,C)}roundClean(){Ur(Js,ea)}destroy(){Ur(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var zm=jd(()=>new Hm);var Gm=jd(()=>new Wm);var $6=BigInt(0),K6=BigInt(1);function Ji(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function Vd(r){let e=r.toString(16);return e.length&1?"0"+e:e}function TE(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?$6:BigInt("0x"+r)}function Su(r){return TE(ro(r))}function no(r){return It(r),TE(ro(Uint8Array.from(r).reverse()))}function Xm(r,e){return hc(r.toString(16).padStart(e*2,"0"))}function Mo(r,e){return Xm(r,e).reverse()}function Ze(r,e,t){let n;if(typeof e=="string")try{n=hc(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(dc(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");let o=n.length;if(typeof t=="number"&&o!==t)throw new Error(r+" of length "+t+" expected, got "+o);return n}function IE(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var j6=r=>typeof r=="bigint"&&$6<=r;function CE(r,e,t){return j6(r)&&j6(e)&&j6(t)&&e<=r&&r<t}function Uo(r,e,t,n){if(!CE(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function Ym(r){let e;for(e=0;r>$6;r>>=K6,e+=1);return e}var ta=r=>(K6<<BigInt(r))-K6;function PE(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=p=>new Uint8Array(p),o=p=>Uint8Array.of(p),i=n(r),s=n(r),a=0,c=()=>{i.fill(1),s.fill(0),a=0},l=(...p)=>t(s,i,...p),u=(p=n(0))=>{s=l(o(0),p),i=l(),p.length!==0&&(s=l(o(1),p),i=l())},f=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let p=0,m=[];for(;p<e;){i=l();let g=i.slice();m.push(g),p+=i.length}return cn(...m)};return(p,m)=>{c(),u(p);let g;for(;!(g=m(f()));)u();return c(),g}}function yi(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,s){let a=r[o];if(s&&a===void 0)return;let c=typeof a;if(c!==i||a===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([o,i])=>n(o,i,!1)),Object.entries(t).forEach(([o,i])=>n(o,i,!0))}function _u(r){let e=new WeakMap;return(t,...n)=>{let o=e.get(t);if(o!==void 0)return o;let i=r(t,...n);return e.set(t,i),i}}var Qr=BigInt(0),lr=BigInt(1),wc=BigInt(2),RE=BigInt(3),DE=BigInt(4),NE=BigInt(5),$B=BigInt(7),LE=BigInt(8),VB=BigInt(9),BE=BigInt(16);function bt(r,e){let t=r%e;return t>=Qr?t:e+t}function vt(r,e,t){let n=r;for(;e-- >Qr;)n*=n,n%=t;return n}function kE(r,e){if(r===Qr)throw new Error("invert: expected non-zero number");if(e<=Qr)throw new Error("invert: expected positive modulus, got "+e);let t=bt(r,e),n=e,o=Qr,i=lr,s=lr,a=Qr;for(;t!==Qr;){let l=n/t,u=n%t,f=o-s*l,d=i-a*l;n=t,t=u,o=s,i=a,s=f,a=d}if(n!==lr)throw new Error("invert: does not exist");return bt(o,e)}function V6(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function ME(r,e){let t=(r.ORDER+lr)/DE,n=r.pow(e,t);return V6(r,n,e),n}function qB(r,e){let t=(r.ORDER-NE)/LE,n=r.mul(e,wc),o=r.pow(n,t),i=r.mul(e,o),s=r.mul(r.mul(i,wc),o),a=r.mul(i,r.sub(s,r.ONE));return V6(r,a,e),a}function HB(r){let e=Mn(r),t=UE(r),n=t(e,e.neg(e.ONE)),o=t(e,n),i=t(e,e.neg(n)),s=(r+$B)/BE;return(a,c)=>{let l=a.pow(c,s),u=a.mul(l,n),f=a.mul(l,o),d=a.mul(l,i),p=a.eql(a.sqr(u),c),m=a.eql(a.sqr(f),c);l=a.cmov(l,u,p),u=a.cmov(d,f,m);let g=a.eql(a.sqr(u),c),y=a.cmov(l,u,g);return V6(a,y,c),y}}function UE(r){if(r<RE)throw new Error("sqrt is not defined for small field");let e=r-lr,t=0;for(;e%wc===Qr;)e/=wc,t++;let n=wc,o=Mn(r);for(;OE(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return ME;let i=o.pow(n,e),s=(e+lr)/wc;return function(c,l){if(c.is0(l))return l;if(OE(c,l)!==1)throw new Error("Cannot find square root");let u=t,f=c.mul(c.ONE,i),d=c.pow(l,e),p=c.pow(l,s);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let m=1,g=c.sqr(d);for(;!c.eql(g,c.ONE);)if(m++,g=c.sqr(g),m===u)throw new Error("Cannot find square root");let y=lr<<BigInt(u-m-1),b=c.pow(f,y);u=m,f=c.sqr(b),d=c.mul(d,f),p=c.mul(p,b)}return p}}function WB(r){return r%DE===RE?ME:r%LE===NE?qB:r%BE===VB?HB(r):UE(r)}var es=(r,e)=>(bt(r,e)&lr)===lr,zB=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function q6(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=zB.reduce((n,o)=>(n[o]="function",n),e);return yi(r,t),r}function GB(r,e,t){if(t<Qr)throw new Error("invalid exponent, negatives unsupported");if(t===Qr)return r.ONE;if(t===lr)return e;let n=r.ONE,o=e;for(;t>Qr;)t&lr&&(n=r.mul(n,o)),o=r.sqr(o),t>>=lr;return n}function qd(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),o=e.reduce((s,a,c)=>r.is0(a)?s:(n[c]=s,r.mul(s,a)),r.ONE),i=r.inv(o);return e.reduceRight((s,a,c)=>r.is0(a)?s:(n[c]=r.mul(s,n[c]),r.mul(s,a)),i),n}function OE(r,e){let t=(r.ORDER-lr)/wc,n=r.pow(e,t),o=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),s=r.eql(n,r.neg(r.ONE));if(!o&&!i&&!s)throw new Error("invalid Legendre symbol result");return o?1:i?0:-1}function FE(r,e){e!==void 0&&Lo(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function Mn(r,e,t=!1,n={}){if(r<=Qr)throw new Error("invalid field: expected ORDER > 0, got "+r);let o,i,s=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");let d=e;d.BITS&&(o=d.BITS),d.sqrt&&(i=d.sqrt),typeof d.isLE=="boolean"&&(t=d.isLE),typeof d.modOnDecode=="boolean"&&(s=d.modOnDecode),a=d.allowedLengths}else typeof e=="number"&&(o=e),n.sqrt&&(i=n.sqrt);let{nBitLength:c,nByteLength:l}=FE(r,o);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u,f=Object.freeze({ORDER:r,isLE:t,BITS:c,BYTES:l,MASK:ta(c),ZERO:Qr,ONE:lr,allowedLengths:a,create:d=>bt(d,r),isValid:d=>{if(typeof d!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof d);return Qr<=d&&d<r},is0:d=>d===Qr,isValidNot0:d=>!f.is0(d)&&f.isValid(d),isOdd:d=>(d&lr)===lr,neg:d=>bt(-d,r),eql:(d,p)=>d===p,sqr:d=>bt(d*d,r),add:(d,p)=>bt(d+p,r),sub:(d,p)=>bt(d-p,r),mul:(d,p)=>bt(d*p,r),pow:(d,p)=>GB(f,d,p),div:(d,p)=>bt(d*kE(p,r),r),sqrN:d=>d*d,addN:(d,p)=>d+p,subN:(d,p)=>d-p,mulN:(d,p)=>d*p,inv:d=>kE(d,r),sqrt:i||(d=>(u||(u=WB(r)),u(f,d))),toBytes:d=>t?Mo(d,l):Xm(d,l),fromBytes:(d,p=!0)=>{if(a){if(!a.includes(d.length)||d.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+d.length);let g=new Uint8Array(l);g.set(d,t?0:g.length-d.length),d=g}if(d.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+d.length);let m=t?no(d):Su(d);if(s&&(m=bt(m,r)),!p&&!f.isValid(m))throw new Error("invalid field element: outside of range 0..ORDER");return m},invertBatch:d=>qd(f,d),cmov:(d,p,m)=>m?p:d});return Object.freeze(f)}function jE(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function H6(r){let e=jE(r);return e+Math.ceil(e/2)}function W6(r,e,t=!1){let n=r.length,o=jE(e),i=H6(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);let s=t?no(r):Su(r),a=bt(s,e-lr)+lr;return t?Mo(a,o):Xm(a,o)}var Au=BigInt(0),bc=BigInt(1);function Hd(r,e){let t=e.negate();return r?t:e}function ts(r,e){let t=qd(r.Fp,e.map(n=>n.Z));return e.map((n,o)=>r.fromAffine(n.toAffine(t[o])))}function qE(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function z6(r,e){qE(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),o=2**r,i=ta(r),s=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:o,shiftBy:s}}function KE(r,e,t){let{windowSize:n,mask:o,maxNumber:i,shiftBy:s}=t,a=Number(r&o),c=r>>s;a>n&&(a-=i,c+=bc);let l=e*n,u=l+Math.abs(a)-1,f=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:d,isNegF:p,offsetF:l}}function XB(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function YB(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}var G6=new WeakMap,HE=new WeakMap;function X6(r){return HE.get(r)||1}function $E(r){if(r!==Au)throw new Error("invalid wNAF")}var Tu=class{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let o=e;for(;t>Au;)t&bc&&(n=n.add(o)),o=o.double(),t>>=bc;return n}precomputeWindow(e,t){let{windows:n,windowSize:o}=z6(t,this.bits),i=[],s=e,a=s;for(let c=0;c<n;c++){a=s,i.push(a);for(let l=1;l<o;l++)a=a.add(s),i.push(a);s=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let o=this.ZERO,i=this.BASE,s=z6(e,this.bits);for(let a=0;a<s.windows;a++){let{nextN:c,offset:l,isZero:u,isNeg:f,isNegF:d,offsetF:p}=KE(n,a,s);n=c,u?i=i.add(Hd(d,t[p])):o=o.add(Hd(f,t[l]))}return $E(n),{p:o,f:i}}wNAFUnsafe(e,t,n,o=this.ZERO){let i=z6(e,this.bits);for(let s=0;s<i.windows&&n!==Au;s++){let{nextN:a,offset:c,isZero:l,isNeg:u}=KE(n,s,i);if(n=a,!l){let f=t[c];o=o.add(u?f.negate():f)}}return $E(n),o}getPrecomputes(e,t,n){let o=G6.get(t);return o||(o=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(o=n(o)),G6.set(t,o))),o}cached(e,t,n){let o=X6(e);return this.wNAF(o,this.getPrecomputes(o,e,n),t)}unsafe(e,t,n,o){let i=X6(e);return i===1?this._unsafeLadder(e,t,o):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,o)}createCache(e,t){qE(t,this.bits),HE.set(e,t),G6.delete(e)}hasCache(e){return X6(e)!==1}};function WE(r,e,t,n){let o=e,i=r.ZERO,s=r.ZERO;for(;t>Au||n>Au;)t&bc&&(i=i.add(o)),n&bc&&(s=s.add(o)),o=o.double(),t>>=bc,n>>=bc;return{p1:i,p2:s}}function Iu(r,e,t,n){XB(t,r),YB(n,e);let o=t.length,i=n.length;if(o!==i)throw new Error("arrays of points and scalars must have equal length");let s=r.ZERO,a=Ym(BigInt(o)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let l=ta(c),u=new Array(Number(l)+1).fill(s),f=Math.floor((e.BITS-1)/c)*c,d=s;for(let p=f;p>=0;p-=c){u.fill(s);for(let g=0;g<i;g++){let y=n[g],b=Number(y>>BigInt(p)&l);u[b]=u[b].add(t[g])}let m=s;for(let g=u.length-1,y=s;g>0;g--)y=y.add(u[g]),m=m.add(y);if(d=d.add(m),p!==0)for(let g=0;g<c;g++)d=d.double()}return d}function VE(r,e){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return q6(e),e}else return Mn(r)}function Qm(r,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let a of["p","n","h"]){let c=e[a];if(!(typeof c=="bigint"&&c>Au))throw new Error(`CURVE.${a} must be positive bigint`)}let n=VE(e.p,t.Fp),o=VE(e.n,t.Fn),s=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let a of s)if(!n.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:o}}var gi=BigInt(0),nr=BigInt(1),Y6=BigInt(2),QB=BigInt(8);function ZB(r,e,t,n){let o=r.sqr(t),i=r.sqr(n),s=r.add(r.mul(e.a,o),i),a=r.add(r.ONE,r.mul(e.d,r.mul(o,i)));return r.eql(s,a)}function JB(r,e={}){let{Fp:t,Fn:n}=Qm("edwards",r,e),{h:o,n:i}=r;yi(e,{},{uvRatio:"function"});let s=Y6<<BigInt(n.BYTES*8)-nr,a=g=>t.create(g),c=e.uvRatio||((g,y)=>{try{return{isValid:!0,value:t.sqrt(t.div(g,y))}}catch{return{isValid:!1,value:gi}}});if(!ZB(t,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function l(g,y,b=!1){let C=b?nr:gi;return Uo("coordinate "+g,y,C,s),y}function u(g){if(!(g instanceof p))throw new Error("ExtendedPoint expected")}let f=_u((g,y)=>{let{X:b,Y:C,Z:D}=g,U=g.is0();y==null&&(y=U?QB:t.inv(D));let X=a(b*y),K=a(C*y),ee=t.mul(D,y);if(U)return{x:gi,y:nr};if(ee!==nr)throw new Error("invZ was invalid");return{x:X,y:K}}),d=_u(g=>{let{a:y,d:b}=r;if(g.is0())throw new Error("bad point: ZERO");let{X:C,Y:D,Z:U,T:X}=g,K=a(C*C),ee=a(D*D),$=a(U*U),B=a($*$),S=a(K*y),x=a($*a(S+ee)),P=a(B+a(b*a(K*ee)));if(x!==P)throw new Error("bad point: equation left != right (1)");let k=a(C*D),F=a(U*X);if(k!==F)throw new Error("bad point: equation left != right (2)");return!0});class p{constructor(y,b,C,D){this.X=l("x",y),this.Y=l("y",b),this.Z=l("z",C,!0),this.T=l("t",D),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(y){return ts(p,y)}static msm(y,b){return Iu(p,n,y,b)}_setWindowSize(y){this.precompute(y)}static fromAffine(y){if(y instanceof p)throw new Error("extended point not allowed");let{x:b,y:C}=y||{};return l("x",b),l("y",C),new p(b,C,nr,a(b*C))}precompute(y=8,b=!0){return m.createCache(this,y),b||this.multiply(Y6),this}assertValidity(){d(this)}equals(y){u(y);let{X:b,Y:C,Z:D}=this,{X:U,Y:X,Z:K}=y,ee=a(b*K),$=a(U*D),B=a(C*K),S=a(X*D);return ee===$&&B===S}is0(){return this.equals(p.ZERO)}negate(){return new p(a(-this.X),this.Y,this.Z,a(-this.T))}double(){let{a:y}=r,{X:b,Y:C,Z:D}=this,U=a(b*b),X=a(C*C),K=a(Y6*a(D*D)),ee=a(y*U),$=b+C,B=a(a($*$)-U-X),S=ee+X,x=S-K,P=ee-X,k=a(B*x),F=a(S*P),H=a(B*P),T=a(x*S);return new p(k,F,T,H)}add(y){u(y);let{a:b,d:C}=r,{X:D,Y:U,Z:X,T:K}=this,{X:ee,Y:$,Z:B,T:S}=y,x=a(D*ee),P=a(U*$),k=a(K*C*S),F=a(X*B),H=a((D+U)*(ee+$)-x-P),T=F-k,I=F+k,j=a(P-b*x),N=a(H*T),te=a(I*j),oe=a(H*j),z=a(T*I);return new p(N,te,z,oe)}subtract(y){return this.add(y.negate())}multiply(y){let b=y;Uo("scalar",b,nr,i);let{p:C,f:D}=m.cached(this,b,U=>ts(p,U));return ts(p,[C,D])[0]}multiplyUnsafe(y,b=p.ZERO){let C=y;return Uo("scalar",C,gi,i),C===gi?p.ZERO:this.is0()||C===nr?this:m.unsafe(this,C,D=>ts(p,D),b)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return m.unsafe(this,i).is0()}toAffine(y){return f(this,y)}clearCofactor(){return o===nr?this:this.multiplyUnsafe(o)}static fromBytes(y,b=!1){return It(y),p.fromHex(y,b)}static fromHex(y,b=!1){let{d:C,a:D}=r,U=t.BYTES;y=Ze("pointHex",y,U),Ji("zip215",b);let X=y.slice(),K=y[U-1];X[U-1]=K&-129;let ee=no(X),$=b?s:t.ORDER;Uo("pointHex.y",ee,gi,$);let B=a(ee*ee),S=a(B-nr),x=a(C*B-D),{isValid:P,value:k}=c(S,x);if(!P)throw new Error("Point.fromHex: invalid y coordinate");let F=(k&nr)===nr,H=(K&128)!==0;if(!b&&k===gi&&H)throw new Error("Point.fromHex: x=0 and x_0=1");return H!==F&&(k=a(-k)),p.fromAffine({x:k,y:ee})}toBytes(){let{x:y,y:b}=this.toAffine(),C=Mo(b,t.BYTES);return C[C.length-1]|=y&nr?128:0,C}toRawBytes(){return this.toBytes()}toHex(){return ro(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}p.BASE=new p(r.Gx,r.Gy,nr,a(r.Gx*r.Gy)),p.ZERO=new p(gi,nr,nr,gi),p.Fp=t,p.Fn=n;let m=new Tu(p,n.BYTES*8);return p}var Zm=class{constructor(e){this.ep=e}static fromBytes(e){throw new Error("fromBytes must be implemented by subclass")}static fromHex(e){throw new Error("fromHex must be implemented by subclass")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}clearCofactor(){return this}assertValidity(){this.ep.assertValidity()}toAffine(e){return this.ep.toAffine(e)}toRawBytes(){return this.toBytes()}toHex(){return ro(this.toBytes())}toString(){return this.toHex()}isTorsionFree(){return!0}isSmallOrder(){return!1}add(e){return this.assertSame(e),this.init(this.ep.add(e.ep))}subtract(e){return this.assertSame(e),this.init(this.ep.subtract(e.ep))}multiply(e){return this.init(this.ep.multiply(e))}multiplyUnsafe(e){return this.init(this.ep.multiplyUnsafe(e))}double(){return this.init(this.ep.double())}negate(){return this.init(this.ep.negate())}precompute(e,t){return this.init(this.ep.precompute(e,t))}};function eM(r,e,t){if(typeof e!="function")throw new Error('"hash" function param is required');yi(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:o,Fp:i,Fn:s}=r,a=s.ORDER,c=t.randomBytes||Qi,l=t.adjustScalarBytes||(x=>x),u=t.domain||((x,P,k)=>{if(Ji("phflag",k),P.length||k)throw new Error("Contexts/pre-hash are not supported");return x});function f(x){return s.create(x)}function d(x){return f(no(x))}function p(x){let P=i.BYTES;x=Ze("private key",x,P);let k=Ze("hashed private key",e(x),2*P),F=l(k.slice(0,P)),H=k.slice(P,2*P),T=d(F);return{head:F,prefix:H,scalar:T}}function m(x){let{head:P,prefix:k,scalar:F}=p(x),H=o.multiply(F),T=H.toBytes();return{head:P,prefix:k,scalar:F,point:H,pointBytes:T}}function g(x){return m(x).pointBytes}function y(x=Uint8Array.of(),...P){let k=cn(...P);return d(e(u(k,Ze("context",x),!!n)))}function b(x,P,k={}){x=Ze("message",x),n&&(x=n(x));let{prefix:F,scalar:H,pointBytes:T}=m(P),I=y(k.context,F,x),j=o.multiply(I).toBytes(),N=y(k.context,j,T,x),te=f(I+N*H);Uo("signature.s",te,gi,a);let oe=i.BYTES,z=cn(j,Mo(te,oe));return Ze("result",z,oe*2)}let C={zip215:!0};function D(x,P,k,F=C){let{context:H,zip215:T}=F,I=i.BYTES;x=Ze("signature",x,2*I),P=Ze("message",P),k=Ze("publicKey",k,I),T!==void 0&&Ji("zip215",T),n&&(P=n(P));let j=no(x.slice(I,2*I)),N,te,oe;try{N=r.fromHex(k,T),te=r.fromHex(x.slice(0,I),T),oe=o.multiplyUnsafe(j)}catch{return!1}if(!T&&N.isSmallOrder())return!1;let z=y(H,te.toBytes(),N.toBytes(),P);return te.add(N.multiplyUnsafe(z)).subtract(oe).clearCofactor().is0()}o.precompute(8);let U=i.BYTES,X={secret:U,public:U,signature:2*U,seed:U};function K(x=c(X.seed)){return x}let ee={getExtendedPublicKey:m,randomSecretKey:K,isValidSecretKey:B,isValidPublicKey:S,randomPrivateKey:K,toMontgomery(x){let{y:P}=r.fromBytes(x),k=U===32;if(!k&&U!==57)throw new Error("only defined for 25519 and 448");let F=k?i.div(nr+P,nr-P):i.div(P-nr,P+nr);return i.toBytes(F)},toMontgomeryPriv(x){It(x,U);let P=e(x.subarray(0,U));return l(P).subarray(0,U)},precompute(x=8,P=r.BASE){return P.precompute(x,!1)}};function $(x){let P=ee.randomSecretKey(x);return{secretKey:P,publicKey:g(P)}}function B(x){try{return!!s.fromBytes(x,!1)}catch{return!1}}function S(x,P){try{return!!r.fromBytes(x,P)}catch{return!1}}return Object.freeze({keygen:$,getPublicKey:g,sign:b,verify:D,utils:ee,Point:r,info:{type:"edwards",lengths:X}})}function tM(r){let e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=Mn(e.n,r.nBitLength,!0),o={Fp:t,Fn:n,uvRatio:r.uvRatio},i={randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:o,hash:r.hash,eddsaOpts:i}}function rM(r,e){return Object.assign({},e,{ExtendedPoint:e.Point,CURVE:r})}function zE(r){let{CURVE:e,curveOpts:t,hash:n,eddsaOpts:o}=tM(r),i=JB(e,t),s=eM(i,n,o);return rM(r,s)}var Wd=BigInt(0),Cu=BigInt(1),Jm=BigInt(2);function nM(r){return yi(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function GE(r){let e=nM(r),{P:t,type:n,adjustScalarBytes:o,powPminus2:i,randomBytes:s}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=s||Qi,l=a?255:448,u=a?32:56,f=BigInt(a?9:5),d=BigInt(a?121665:39081),p=a?Jm**BigInt(254):Jm**BigInt(447),m=a?BigInt(8)*Jm**BigInt(251)-Cu:BigInt(4)*Jm**BigInt(445)-Cu,g=p+m+Cu,y=k=>bt(k,t),b=C(f);function C(k){return Mo(y(k),u)}function D(k){let F=Ze("u coordinate",k,u);return a&&(F[31]&=127),y(no(F))}function U(k){return no(o(Ze("scalar",k,u)))}function X(k,F){let H=$(D(F),U(k));if(H===Wd)throw new Error("invalid private or public key received");return C(H)}function K(k){return X(k,b)}function ee(k,F,H){let T=y(k*(F-H));return F=y(F-T),H=y(H+T),{x_2:F,x_3:H}}function $(k,F){Uo("u",k,Wd,t),Uo("scalar",F,p,g);let H=F,T=k,I=Cu,j=Wd,N=k,te=Cu,oe=Wd;for(let Pe=BigInt(l-1);Pe>=Wd;Pe--){let Le=H>>Pe&Cu;oe^=Le,{x_2:I,x_3:N}=ee(oe,I,N),{x_2:j,x_3:te}=ee(oe,j,te),oe=Le;let ke=I+j,Ne=y(ke*ke),ze=I-j,dt=y(ze*ze),Vt=Ne-dt,qt=N+te,li=N-te,dr=y(li*ke),To=y(qt*ze),Xa=dr+To,Fi=dr-To;N=y(Xa*Xa),te=y(T*y(Fi*Fi)),I=y(Ne*dt),j=y(Vt*(Ne+y(d*Vt)))}({x_2:I,x_3:N}=ee(oe,I,N)),{x_2:j,x_3:te}=ee(oe,j,te);let z=i(j);return y(I*z)}let B=(k=c(u))=>k,S={randomSecretKey:B,randomPrivateKey:B};function x(k){let F=S.randomSecretKey(k);return{secretKey:F,publicKey:K(F)}}let P={secret:u,public:u,seed:u};return{keygen:x,getSharedSecret:(k,F)=>X(k,F),getPublicKey:k=>K(k),scalarMult:X,scalarMultBase:K,utils:S,GuBytes:b.slice(),info:{type:"montgomery",lengths:P}}}var oM=BigInt(0),rs=BigInt(1),XE=BigInt(2),iM=BigInt(3),sM=BigInt(5),aM=BigInt(8),Pu={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:aM,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function ZE(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),o=BigInt(80),i=Pu.p,a=r*r%i*r%i,c=vt(a,XE,i)*a%i,l=vt(c,rs,i)*r%i,u=vt(l,sM,i)*l%i,f=vt(u,e,i)*u%i,d=vt(f,t,i)*f%i,p=vt(d,n,i)*d%i,m=vt(p,o,i)*p%i,g=vt(m,o,i)*p%i,y=vt(g,e,i)*u%i;return{pow_p_5_8:vt(y,XE,i)*r%i,b2:a}}function JE(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var Q6=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function e5(r,e){let t=Pu.p,n=bt(e*e*e,t),o=bt(n*n*e,t),i=ZE(r*o).pow_p_5_8,s=bt(r*n*i,t),a=bt(e*s*s,t),c=s,l=bt(s*Q6,t),u=a===r,f=a===bt(-r,t),d=a===bt(-r*Q6,t);return u&&(s=c),(f||d)&&(s=l),es(s,t)&&(s=bt(-s,t)),{isValid:u||f,value:s}}var vc=Mn(Pu.p,{isLE:!0}),cM=Mn(Pu.n,{isLE:!0}),lM={...Pu,Fp:vc,hash:Gm,adjustScalarBytes:JE,uvRatio:e5},Fr=zE(lM);var zd=(()=>{let r=Pu.p;return GE({P:r,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:n}=ZE(e);return bt(vt(t,iM,r)*n,r)},adjustScalarBytes:JE})})();var Z6=Q6,uM=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),fM=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),dM=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),pM=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952"),YE=r=>e5(rs,r),hM=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),J6=r=>Fr.CURVE.Fp.create(no(r)&hM);function QE(r){let{d:e}=Fr.CURVE,t=Fr.CURVE.Fp.ORDER,n=Fr.CURVE.Fp.create,o=n(Z6*r*r),i=n((o+rs)*dM),s=BigInt(-1),a=n((s-e*o)*n(o+e)),{isValid:c,value:l}=e5(i,a),u=n(l*r);es(u,t)||(u=n(-u)),c||(l=u),c||(s=o);let f=n(s*(o-rs)*pM-a),d=l*l,p=n((l+l)*a),m=n(f*uM),g=n(rs-d),y=n(rs+d);return new Fr.Point(n(p*y),n(g*m),n(m*y),n(p*g))}function mM(r){It(r,64);let e=J6(r.subarray(0,32)),t=QE(e),n=J6(r.subarray(32,64)),o=QE(n);return new ns(t.add(o))}var ns=class r extends Zm{constructor(e){super(e)}static fromAffine(e){return new r(Fr.Point.fromAffine(e))}assertSame(e){if(!(e instanceof r))throw new Error("RistrettoPoint expected")}init(e){return new r(e)}static hashToCurve(e){return mM(Ze("ristrettoHash",e,64))}static fromBytes(e){It(e,32);let{a:t,d:n}=Fr.CURVE,o=vc.ORDER,i=vc.create,s=J6(e);if(!IE(Mo(s,32),e)||es(s,o))throw new Error("invalid ristretto255 encoding 1");let a=i(s*s),c=i(rs+t*a),l=i(rs-t*a),u=i(c*c),f=i(l*l),d=i(t*n*u-f),{isValid:p,value:m}=YE(i(d*f)),g=i(m*l),y=i(m*g*d),b=i((s+s)*g);es(b,o)&&(b=i(-b));let C=i(c*y),D=i(b*C);if(!p||es(D,o)||C===oM)throw new Error("invalid ristretto255 encoding 2");return new r(new Fr.Point(b,C,rs,D))}static fromHex(e){return r.fromBytes(Ze("ristrettoHex",e,32))}static msm(e,t){return Iu(r,Fr.Point.Fn,e,t)}toBytes(){let{X:e,Y:t,Z:n,T:o}=this.ep,i=vc.ORDER,s=vc.create,a=s(s(n+t)*s(n-t)),c=s(e*t),l=s(c*c),{value:u}=YE(s(a*l)),f=s(u*a),d=s(u*c),p=s(f*d*o),m;if(es(o*p,i)){let y=s(t*Z6),b=s(e*Z6);e=y,t=b,m=s(f*fM)}else m=d;es(e*p,i)&&(t=s(-t));let g=s((n-t)*m);return es(g,i)&&(g=s(-g)),Mo(g,32)}equals(e){this.assertSame(e);let{X:t,Y:n}=this.ep,{X:o,Y:i}=e.ep,s=vc.create,a=s(t*i)===s(n*o),c=s(n*i)===s(t*o);return a||c}is0(){return this.equals(r.ZERO)}};ns.BASE=new ns(Fr.Point.BASE);ns.ZERO=new ns(Fr.Point.ZERO);ns.Fp=vc;ns.Fn=cM;var xc=32,Un=64,t5=32;var ku,eS=(async()=>{try{return await Wt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function tS(){let r=Fr.utils.randomPrivateKey(),e=Fr.getPublicKey(r);return{privateKey:vM(r,e),publicKey:e}}async function yM(r,e){let t;r.length===Un?t=r.subarray(0,32):t=r;let n={crv:"Ed25519",kty:"OKP",x:W(r.subarray(32),"base64url"),d:W(t,"base64url"),ext:!0,key_ops:["sign"]},o=await Wt.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Wt.get().subtle.sign({name:"Ed25519"},o,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function gM(r,e){let t=r.subarray(0,t5);return Fr.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function rS(r,e){return ku==null&&(ku=await eS),ku?yM(r,e):gM(r,e)}async function wM(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await Wt.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Wt.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function bM(r,e,t){return Fr.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function nS(r,e,t){return ku==null&&(ku=await eS),ku?wM(r,e,t):bM(r,e,t)}function vM(r,e){let t=new Uint8Array(Un);for(let n=0;n<t5;n++)t[n]=r[n],t[t5+n]=e[n];return t}function Ou(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Gd=class{type="Ed25519";raw;constructor(e){this.raw=Du(e,xc)}toMultihash(){return Mr.digest(cr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return rt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let o=nS(this.raw,t,e);return Ou(o)?o.then(i=>(n?.signal?.throwIfAborted(),i)):o}},Ru=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=Du(e,Un),this.publicKey=new Gd(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();let n=rS(this.raw,e);return Ou(n)?n.then(o=>(t?.signal?.throwIfAborted(),o)):(t?.signal?.throwIfAborted(),n)}};function r5(r){if(r.length>Un){r=Du(r,Un+xc);let n=r.subarray(0,Un),o=r.subarray(Un,r.length);return new Ru(n,o)}r=Du(r,Un);let e=r.subarray(0,Un),t=r.subarray(xc);return new Ru(e,t)}function n5(r){return r=Du(r,xc),new Gd(r)}async function iS(){let{privateKey:r,publicKey:e}=tS();return new Ru(r,e)}function Du(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new M(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var xM=Math.pow(2,7),EM=Math.pow(2,14),SM=Math.pow(2,21),o5=Math.pow(2,28),i5=Math.pow(2,35),s5=Math.pow(2,42),a5=Math.pow(2,49),ot=128,jr=127;function Ke(r){if(r<xM)return 1;if(r<EM)return 2;if(r<SM)return 3;if(r<o5)return 4;if(r<i5)return 5;if(r<s5)return 6;if(r<a5)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Nu(r,e,t=0){switch(Ke(r)){case 8:e[t++]=r&255|ot,r/=128;case 7:e[t++]=r&255|ot,r/=128;case 6:e[t++]=r&255|ot,r/=128;case 5:e[t++]=r&255|ot,r/=128;case 4:e[t++]=r&255|ot,r>>>=7;case 3:e[t++]=r&255|ot,r>>>=7;case 2:e[t++]=r&255|ot,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function _M(r,e,t=0){switch(Ke(r)){case 8:e.set(t++,r&255|ot),r/=128;case 7:e.set(t++,r&255|ot),r/=128;case 6:e.set(t++,r&255|ot),r/=128;case 5:e.set(t++,r&255|ot),r/=128;case 4:e.set(t++,r&255|ot),r>>>=7;case 3:e.set(t++,r&255|ot),r>>>=7;case 2:e.set(t++,r&255|ot),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function c5(r,e){let t=r[e],n=0;if(n+=t&jr,t<ot||(t=r[e+1],n+=(t&jr)<<7,t<ot)||(t=r[e+2],n+=(t&jr)<<14,t<ot)||(t=r[e+3],n+=(t&jr)<<21,t<ot)||(t=r[e+4],n+=(t&jr)*o5,t<ot)||(t=r[e+5],n+=(t&jr)*i5,t<ot)||(t=r[e+6],n+=(t&jr)*s5,t<ot)||(t=r[e+7],n+=(t&jr)*a5,t<ot))return n;throw new RangeError("Could not decode varint")}function AM(r,e){let t=r.get(e),n=0;if(n+=t&jr,t<ot||(t=r.get(e+1),n+=(t&jr)<<7,t<ot)||(t=r.get(e+2),n+=(t&jr)<<14,t<ot)||(t=r.get(e+3),n+=(t&jr)<<21,t<ot)||(t=r.get(e+4),n+=(t&jr)*o5,t<ot)||(t=r.get(e+5),n+=(t&jr)*i5,t<ot)||(t=r.get(e+6),n+=(t&jr)*s5,t<ot)||(t=r.get(e+7),n+=(t&jr)*a5,t<ot))return n;throw new RangeError("Could not decode varint")}function ur(r,e,t=0){return e==null&&(e=Tt(Ke(r))),e instanceof Uint8Array?Nu(r,e,t):_M(r,e,t)}function Fo(r,e=0){return r instanceof Uint8Array?c5(r,e):AM(r,e)}var l5=new Float32Array([-0]),ra=new Uint8Array(l5.buffer);function sS(r,e,t){l5[0]=r,e[t]=ra[0],e[t+1]=ra[1],e[t+2]=ra[2],e[t+3]=ra[3]}function aS(r,e){return ra[0]=r[e],ra[1]=r[e+1],ra[2]=r[e+2],ra[3]=r[e+3],l5[0]}var u5=new Float64Array([-0]),Kr=new Uint8Array(u5.buffer);function cS(r,e,t){u5[0]=r,e[t]=Kr[0],e[t+1]=Kr[1],e[t+2]=Kr[2],e[t+3]=Kr[3],e[t+4]=Kr[4],e[t+5]=Kr[5],e[t+6]=Kr[6],e[t+7]=Kr[7]}function lS(r,e){return Kr[0]=r[e],Kr[1]=r[e+1],Kr[2]=r[e+2],Kr[3]=r[e+3],Kr[4]=r[e+4],Kr[5]=r[e+5],Kr[6]=r[e+6],Kr[7]=r[e+7],u5[0]}var TM=BigInt(Number.MAX_SAFE_INTEGER),IM=BigInt(Number.MIN_SAFE_INTEGER),Fn=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Ec;if(e<TM&&e>IM)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,o=e-(n<<32n);return t&&(n=~n|0n,o=~o|0n,++o>uS&&(o=0n,++n>uS&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(e){if(e===0)return Ec;let t=e<0;t&&(e=-e);let n=e>>>0,o=(e-n)/4294967296>>>0;return t&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Ec}},Ec=new Fn(0,0);Ec.toBigInt=function(){return 0n};Ec.zzEncode=Ec.zzDecode=function(){return this};Ec.length=function(){return 1};var uS=4294967296n;function fS(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function dS(r,e,t){if(t-e<1)return"";let o,i=[],s=0,a;for(;e<t;)a=r[e++],a<128?i[s++]=a:a>191&&a<224?i[s++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[s++]=55296+(a>>10),i[s++]=56320+(a&1023)):i[s++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,s>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,i)),s=0);return o!=null?(s>0&&o.push(String.fromCharCode.apply(String,i.slice(0,s))),o.join("")):String.fromCharCode.apply(String,i.slice(0,s))}function f5(r,e,t){let n=t,o,i;for(let s=0;s<r.length;++s)o=r.charCodeAt(s),o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&((i=r.charCodeAt(s+1))&64512)===56320?(o=65536+((o&1023)<<10)+(i&1023),++s,e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128);return t-n}function jo(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function e0(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var d5=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,jo(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw jo(this,4);return e0(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw jo(this,4);return e0(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw jo(this,4);let e=aS(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw jo(this,4);let e=lS(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw jo(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return dS(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw jo(this,e);this.pos+=e}else do if(this.pos>=this.len)throw jo(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Fn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw jo(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw jo(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw jo(this,8);let e=e0(this.buf,this.pos+=4),t=e0(this.buf,this.pos+=4);return new Fn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=c5(this.buf,this.pos);return this.pos+=Ke(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function p5(r){return new d5(r instanceof Uint8Array?r:r.subarray())}function Se(r,e,t){let n=p5(r);return e.decode(n,void 0,t)}function h5(r){let e=r??8192,t=e>>>1,n,o=e;return function(s){if(s<1||s>t)return Tt(s);o+s>e&&(n=Tt(e),o=0);let a=n.subarray(o,o+=s);return(o&7)!==0&&(o=(o|7)+1),a}}var Sc=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function m5(){}var g5=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},CM=h5();function PM(r){return globalThis.Buffer!=null?Tt(r):CM(r)}var Yd=class{len;head;tail;states;constructor(){this.len=0,this.head=new Sc(m5,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Sc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new w5((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(t0,10,Fn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Fn.fromBigInt(e);return this._push(t0,t.length(),t)}uint64Number(e){return this._push(Nu,Ke(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Fn.fromBigInt(e).zzEncode();return this._push(t0,t.length(),t)}sint64Number(e){let t=Fn.fromNumber(e).zzEncode();return this._push(t0,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(y5,1,e?1:0)}fixed32(e){return this._push(Xd,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Fn.fromBigInt(e);return this._push(Xd,4,t.lo)._push(Xd,4,t.hi)}fixed64Number(e){let t=Fn.fromNumber(e);return this._push(Xd,4,t.lo)._push(Xd,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(sS,4,e)}double(e){return this._push(cS,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(y5,1,0):this.uint32(t)._push(OM,t,e)}string(e){let t=fS(e);return t!==0?this.uint32(t)._push(f5,t,e):this._push(y5,1,0)}fork(){return this.states=new g5(this),this.head=this.tail=new Sc(m5,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Sc(m5,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=PM(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function y5(r,e,t){e[t]=r&255}function kM(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var w5=class extends Sc{next;constructor(e,t){super(kM,e,t),this.next=void 0}};function t0(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Xd(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function OM(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Yd.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(RM,e,r),this},Yd.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(DM,e,r),this});function RM(r,e,t){e.set(r,t)}function DM(r,e,t){r.length<40?f5(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(q(r),t)}function b5(){return new Yd}function _e(r,e){let t=b5();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Lu;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Lu||(Lu={}));function r0(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function _t(r){function e(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let t=function(i,s){let a=e(i);s.int32(a)},n=function(i){let s=i.int32();return e(s)};return r0("enum",Lu.VARINT,t,n)}function Ae(r,e){return r0("message",Lu.LENGTH_DELIMITED,r,e)}var lt=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Qd=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var pt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(pt||(pt={}));var v5;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(v5||(v5={}));(function(r){r.codec=()=>_t(v5)})(pt||(pt={}));var wi;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),pt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=pt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(wi||(wi={}));var Zd;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),pt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=pt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Zd||(Zd={}));function Zr(r){if(isNaN(r)||r<=0)throw new M("random bytes length must be a Number bigger than 0");return Qi(r)}var ep={};kt(ep,{MAX_RSA_KEY_SIZE:()=>x5,generateRSAKeyPair:()=>k5,jwkToJWKKeyPair:()=>gS,jwkToPkcs1:()=>MM,jwkToPkix:()=>A5,jwkToRSAPrivateKey:()=>P5,pkcs1MessageToJwk:()=>S5,pkcs1MessageToRSAPrivateKey:()=>n0,pkcs1ToJwk:()=>BM,pkcs1ToRSAPrivateKey:()=>T5,pkixMessageToJwk:()=>_5,pkixMessageToRSAPublicKey:()=>C5,pkixToJwk:()=>UM,pkixToRSAPublicKey:()=>I5});var bi=zm;var Bu=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=ep.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return ue.createV1(114,this._multihash)}toString(){return rt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){return yS(this.jwk,t,e,n)}},Jd=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=ep.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){return mS(this.jwk,e,t)}};var x5=8192,E5=18,NM=1062,LM=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function BM(r){let e=to(r);return S5(e)}function S5(r){return{n:W(r[1],"base64url"),e:W(r[2],"base64url"),d:W(r[3],"base64url"),p:W(r[4],"base64url"),q:W(r[5],"base64url"),dp:W(r[6],"base64url"),dq:W(r[7],"base64url"),qi:W(r[8],"base64url"),kty:"RSA"}}function MM(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new M("JWK was missing components");return No([Yr(Uint8Array.from([0])),Yr(q(r.n,"base64url")),Yr(q(r.e,"base64url")),Yr(q(r.d,"base64url")),Yr(q(r.p,"base64url")),Yr(q(r.q,"base64url")),Yr(q(r.dp,"base64url")),Yr(q(r.dq,"base64url")),Yr(q(r.qi,"base64url"))]).subarray()}function UM(r){let e=to(r,{offset:0});return _5(e)}function _5(r){let e=to(r[1],{offset:0});return{kty:"RSA",n:W(e[0],"base64url"),e:W(e[1],"base64url")}}function A5(r){if(r.n==null||r.e==null)throw new M("JWK was missing components");return No([LM,Fd(No([Yr(q(r.n,"base64url")),Yr(q(r.e,"base64url"))]))]).subarray()}function T5(r){let e=to(r);return n0(e)}function n0(r){let e=S5(r);return P5(e)}function I5(r,e){if(r.byteLength>=NM)throw new ji("Key size is too large");let t=to(r,{offset:0});return C5(t,r,e)}function C5(r,e,t){let n=_5(r);if(t==null){let o=bi(wi.encode({Type:pt.RSA,Data:e}));t=Br(E5,o)}return new Bu(n,t)}function P5(r){if(bS(r)>x5)throw new M("Key size is too large");let e=gS(r),t=bi(wi.encode({Type:pt.RSA,Data:A5(e.publicKey)})),n=Br(E5,t);return new Jd(e.privateKey,new Bu(e.publicKey,n))}async function k5(r){if(r>x5)throw new M("Key size is too large");let e=await wS(r),t=bi(wi.encode({Type:pt.RSA,Data:A5(e.publicKey)})),n=Br(E5,t);return new Jd(e.privateKey,new Bu(e.publicKey,n))}function gS(r){if(r==null)throw new M("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function wS(r,e){let t=await Wt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await FM(t,e);return{privateKey:n[0],publicKey:n[1]}}async function mS(r,e,t){let n=await Wt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let o=await Wt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function yS(r,e,t,n){let o=await Wt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let i=await Wt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function FM(r,e){if(r.privateKey==null||r.publicKey==null)throw new M("Private and public key are required");let t=await Promise.all([Wt.get().subtle.exportKey("jwk",r.privateKey),Wt.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function bS(r){if(r.kty!=="RSA")throw new M("invalid key type");if(r.n==null)throw new M("invalid key modulus");return q(r.n,"base64url").length*8}var o0=class extends xu{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Yi(e);let n=Qs(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let o=this.blockLen,i=new Uint8Array(o);i.set(n.length>o?e.create().update(n).digest():n);for(let s=0;s<i.length;s++)i[s]^=54;this.iHash.update(i),this.oHash=e.create();for(let s=0;s<i.length;s++)i[s]^=106;this.oHash.update(i),Ur(i)}update(e){return Eu(this),this.iHash.update(e),this}digestInto(e){Eu(this),It(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:o,destroyed:i,blockLen:s,outputLen:a}=this;return e=e,e.finished=o,e.destroyed=i,e.blockLen=s,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},na=(r,e,t)=>new o0(r,e).update(t).digest();na.create=(r,e)=>new o0(r,e);var vS=(r,e)=>(r+(r>=0?e:-e)/ES)/e;function jM(r,e,t){let[[n,o],[i,s]]=e,a=vS(s*r,t),c=vS(-o*r,t),l=r-a*n-c*i,u=-a*o-c*s,f=l<ss,d=u<ss;f&&(l=-l),d&&(u=-u);let p=ta(Math.ceil(Ym(t)/2))+Uu;if(l<ss||l>=p||u<ss||u>=p)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:d,k2:u}}function xS(r){r.lowS!==void 0&&Ji("lowS",r.lowS),r.prehash!==void 0&&Ji("prehash",r.prehash)}var O5=class extends Error{constructor(e=""){super(e)}},is={Err:O5,_tlv:{encode:(r,e)=>{let{Err:t}=is;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,o=Vd(n);if(o.length/2&128)throw new t("tlv.encode: long form length too big");let i=n>127?Vd(o.length/2|128):"";return Vd(r)+i+o+e},decode(r,e){let{Err:t}=is,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let o=e[n++],i=!!(o&128),s=0;if(!i)s=o;else{let c=o&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let u of l)s=s<<8|u;if(n+=c,s<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+s);if(a.length!==s)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+s)}}},_int:{encode(r){let{Err:e}=is;if(r<ss)throw new e("integer: negative integers are not allowed");let t=Vd(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=is;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Su(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=is,o=Ze("signature",r),{v:i,l:s}=n.decode(48,o);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,i),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){let{_tlv:e,_int:t}=is,n=e.encode(2,t.encode(r.r)),o=e.encode(2,t.encode(r.s)),i=n+o;return e.encode(48,i)}},ss=BigInt(0),Uu=BigInt(1),ES=BigInt(2),i0=BigInt(3),KM=BigInt(4);function $M(r,e,t){function n(o){let i=r.sqr(o),s=r.mul(i,o);return r.add(r.add(s,r.mul(o,e)),t)}return n}function Mu(r,e){let{BYTES:t}=r,n;if(typeof e=="bigint")n=e;else{let o=Ze("private key",e);try{n=r.fromBytes(o)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!r.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function VM(r,e={}){let{Fp:t,Fn:n}=Qm("weierstrass",r,e),{h:o,n:i}=r;yi(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:s}=e;if(s&&(!t.is0(r.a)||typeof s.beta!="bigint"||!Array.isArray(s.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(B,S,x){let{x:P,y:k}=S.toAffine(),F=t.toBytes(P);if(Ji("isCompressed",x),x){a();let H=!t.isOdd(k);return cn(SS(H),F)}else return cn(Uint8Array.of(4),F,t.toBytes(k))}function l(B){It(B);let S=t.BYTES,x=S+1,P=2*S+1,k=B.length,F=B[0],H=B.subarray(1);if(k===x&&(F===2||F===3)){let T=t.fromBytes(H);if(!t.isValid(T))throw new Error("bad point: is not on curve, wrong x");let I=d(T),j;try{j=t.sqrt(I)}catch(oe){let z=oe instanceof Error?": "+oe.message:"";throw new Error("bad point: is not on curve, sqrt error"+z)}a();let N=t.isOdd(j);return(F&1)===1!==N&&(j=t.neg(j)),{x:T,y:j}}else if(k===P&&F===4){let T=t.fromBytes(H.subarray(S*0,S*1)),I=t.fromBytes(H.subarray(S*1,S*2));if(!p(T,I))throw new Error("bad point: is not on curve");return{x:T,y:I}}else throw new Error(`bad point: got length ${k}, expected compressed=${x} or uncompressed=${P}`)}let u=e.toBytes||c,f=e.fromBytes||l,d=$M(t,r.a,r.b);function p(B,S){let x=t.sqr(S),P=d(B);return t.eql(x,P)}if(!p(r.Gx,r.Gy))throw new Error("bad curve params: generator point");let m=t.mul(t.pow(r.a,i0),KM),g=t.mul(t.sqr(r.b),BigInt(27));if(t.is0(t.add(m,g)))throw new Error("bad curve params: a or b");function y(B,S,x=!1){if(!t.isValid(S)||x&&t.is0(S))throw new Error(`bad point coordinate ${B}`);return S}function b(B){if(!(B instanceof K))throw new Error("ProjectivePoint expected")}function C(B){if(!s||!s.basises)throw new Error("no endo");return jM(B,s.basises,n.ORDER)}let D=_u((B,S)=>{let{X:x,Y:P,Z:k}=B;if(t.eql(k,t.ONE))return{x,y:P};let F=B.is0();S==null&&(S=F?t.ONE:t.inv(k));let H=t.mul(x,S),T=t.mul(P,S),I=t.mul(k,S);if(F)return{x:t.ZERO,y:t.ZERO};if(!t.eql(I,t.ONE))throw new Error("invZ was invalid");return{x:H,y:T}}),U=_u(B=>{if(B.is0()){if(e.allowInfinityPoint&&!t.is0(B.Y))return;throw new Error("bad point: ZERO")}let{x:S,y:x}=B.toAffine();if(!t.isValid(S)||!t.isValid(x))throw new Error("bad point: x or y not field elements");if(!p(S,x))throw new Error("bad point: equation left != right");if(!B.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function X(B,S,x,P,k){return x=new K(t.mul(x.X,B),x.Y,x.Z),S=Hd(P,S),x=Hd(k,x),S.add(x)}class K{constructor(S,x,P){this.X=y("x",S),this.Y=y("y",x,!0),this.Z=y("z",P),Object.freeze(this)}static fromAffine(S){let{x,y:P}=S||{};if(!S||!t.isValid(x)||!t.isValid(P))throw new Error("invalid affine point");if(S instanceof K)throw new Error("projective point not allowed");return t.is0(x)&&t.is0(P)?K.ZERO:new K(x,P,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}static normalizeZ(S){return ts(K,S)}static fromBytes(S){return It(S),K.fromHex(S)}static fromHex(S){let x=K.fromAffine(f(Ze("pointHex",S)));return x.assertValidity(),x}static fromPrivateKey(S){return K.BASE.multiply(Mu(n,S))}static msm(S,x){return Iu(K,n,S,x)}_setWindowSize(S){this.precompute(S)}precompute(S=8,x=!0){return $.createCache(this,S),x||this.multiply(i0),this}assertValidity(){U(this)}hasEvenY(){let{y:S}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(S)}equals(S){b(S);let{X:x,Y:P,Z:k}=this,{X:F,Y:H,Z:T}=S,I=t.eql(t.mul(x,T),t.mul(F,k)),j=t.eql(t.mul(P,T),t.mul(H,k));return I&&j}negate(){return new K(this.X,t.neg(this.Y),this.Z)}double(){let{a:S,b:x}=r,P=t.mul(x,i0),{X:k,Y:F,Z:H}=this,T=t.ZERO,I=t.ZERO,j=t.ZERO,N=t.mul(k,k),te=t.mul(F,F),oe=t.mul(H,H),z=t.mul(k,F);return z=t.add(z,z),j=t.mul(k,H),j=t.add(j,j),T=t.mul(S,j),I=t.mul(P,oe),I=t.add(T,I),T=t.sub(te,I),I=t.add(te,I),I=t.mul(T,I),T=t.mul(z,T),j=t.mul(P,j),oe=t.mul(S,oe),z=t.sub(N,oe),z=t.mul(S,z),z=t.add(z,j),j=t.add(N,N),N=t.add(j,N),N=t.add(N,oe),N=t.mul(N,z),I=t.add(I,N),oe=t.mul(F,H),oe=t.add(oe,oe),N=t.mul(oe,z),T=t.sub(T,N),j=t.mul(oe,te),j=t.add(j,j),j=t.add(j,j),new K(T,I,j)}add(S){b(S);let{X:x,Y:P,Z:k}=this,{X:F,Y:H,Z:T}=S,I=t.ZERO,j=t.ZERO,N=t.ZERO,te=r.a,oe=t.mul(r.b,i0),z=t.mul(x,F),Pe=t.mul(P,H),Le=t.mul(k,T),ke=t.add(x,P),Ne=t.add(F,H);ke=t.mul(ke,Ne),Ne=t.add(z,Pe),ke=t.sub(ke,Ne),Ne=t.add(x,k);let ze=t.add(F,T);return Ne=t.mul(Ne,ze),ze=t.add(z,Le),Ne=t.sub(Ne,ze),ze=t.add(P,k),I=t.add(H,T),ze=t.mul(ze,I),I=t.add(Pe,Le),ze=t.sub(ze,I),N=t.mul(te,Ne),I=t.mul(oe,Le),N=t.add(I,N),I=t.sub(Pe,N),N=t.add(Pe,N),j=t.mul(I,N),Pe=t.add(z,z),Pe=t.add(Pe,z),Le=t.mul(te,Le),Ne=t.mul(oe,Ne),Pe=t.add(Pe,Le),Le=t.sub(z,Le),Le=t.mul(te,Le),Ne=t.add(Ne,Le),z=t.mul(Pe,Ne),j=t.add(j,z),z=t.mul(ze,Ne),I=t.mul(ke,I),I=t.sub(I,z),z=t.mul(ke,Pe),N=t.mul(ze,N),N=t.add(N,z),new K(I,j,N)}subtract(S){return this.add(S.negate())}is0(){return this.equals(K.ZERO)}multiply(S){let{endo:x}=e;if(!n.isValidNot0(S))throw new Error("invalid scalar: out of range");let P,k,F=H=>$.cached(this,H,T=>ts(K,T));if(x){let{k1neg:H,k1:T,k2neg:I,k2:j}=C(S),{p:N,f:te}=F(T),{p:oe,f:z}=F(j);k=te.add(z),P=X(x.beta,N,oe,H,I)}else{let{p:H,f:T}=F(S);P=H,k=T}return ts(K,[P,k])[0]}multiplyUnsafe(S){let{endo:x}=e,P=this;if(!n.isValid(S))throw new Error("invalid scalar: out of range");if(S===ss||P.is0())return K.ZERO;if(S===Uu)return P;if($.hasCache(this))return this.multiply(S);if(x){let{k1neg:k,k1:F,k2neg:H,k2:T}=C(S),{p1:I,p2:j}=WE(K,P,F,T);return X(x.beta,I,j,k,H)}else return $.unsafe(P,S)}multiplyAndAddUnsafe(S,x,P){let k=this.multiplyUnsafe(x).add(S.multiplyUnsafe(P));return k.is0()?void 0:k}toAffine(S){return D(this,S)}isTorsionFree(){let{isTorsionFree:S}=e;return o===Uu?!0:S?S(K,this):$.unsafe(this,i).is0()}clearCofactor(){let{clearCofactor:S}=e;return o===Uu?this:S?S(K,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(S=!0){return Ji("isCompressed",S),this.assertValidity(),u(K,this,S)}toRawBytes(S=!0){return this.toBytes(S)}toHex(S=!0){return ro(this.toBytes(S))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}K.BASE=new K(r.Gx,r.Gy,t.ONE),K.ZERO=new K(t.ZERO,t.ONE,t.ZERO),K.Fp=t,K.Fn=n;let ee=n.BITS,$=new Tu(K,e.endo?Math.ceil(ee/2):ee);return K}function SS(r){return Uint8Array.of(r?2:3)}function qM(r,e,t={}){Yi(e),yi(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let n=t.randomBytes||Qi,o=t.hmac||((T,...I)=>na(e,T,cn(...I))),{Fp:i,Fn:s}=r,{ORDER:a,BITS:c}=s,l=H6(a),u={secret:s.BYTES,public:1+i.BYTES,publicUncompressed:1+2*i.BYTES,signature:2*s.BYTES,seed:l};function f(T){let I=a>>Uu;return T>I}function d(T){return f(T)?s.neg(T):T}function p(T,I){if(!s.isValidNot0(I))throw new Error(`invalid signature ${T}: out of range 1..CURVE.n`)}class m{constructor(I,j,N){p("r",I),p("s",j),this.r=I,this.s=j,N!=null&&(this.recovery=N),Object.freeze(this)}static fromBytes(I,j="compact"){if(j==="compact"){let N=s.BYTES;It(I,N*2);let te=I.subarray(0,N),oe=I.subarray(N,N*2);return new m(s.fromBytes(te),s.fromBytes(oe))}if(j==="der"){It(I);let{r:N,s:te}=is.toSig(I);return new m(N,te)}throw new Error("invalid format")}static fromHex(I,j){return this.fromBytes(hc(I),j)}addRecoveryBit(I){return new m(this.r,this.s,I)}recoverPublicKey(I){let j=i.ORDER,{r:N,s:te,recovery:oe}=this;if(oe==null||![0,1,2,3].includes(oe))throw new Error("recovery id invalid");if(a*ES<j&&oe>1)throw new Error("recovery id is ambiguous for h>1 curve");let Pe=oe===2||oe===3?N+a:N;if(!i.isValid(Pe))throw new Error("recovery id 2 or 3 invalid");let Le=i.toBytes(Pe),ke=r.fromHex(cn(SS((oe&1)===0),Le)),Ne=s.inv(Pe),ze=ee(Ze("msgHash",I)),dt=s.create(-ze*Ne),Vt=s.create(te*Ne),qt=r.BASE.multiplyUnsafe(dt).add(ke.multiplyUnsafe(Vt));if(qt.is0())throw new Error("point at infinify");return qt.assertValidity(),qt}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new m(this.r,s.neg(this.s),this.recovery):this}toBytes(I="compact"){if(I==="compact")return cn(s.toBytes(this.r),s.toBytes(this.s));if(I==="der")return hc(is.hexFromSig(this));throw new Error("invalid format")}toHex(I){return ro(this.toBytes(I))}assertValidity(){}static fromCompact(I){return m.fromBytes(Ze("sig",I),"compact")}static fromDER(I){return m.fromBytes(Ze("sig",I),"der")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return ro(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return ro(this.toBytes("compact"))}}function g(T){try{return!!Mu(s,T)}catch{return!1}}function y(T,I){try{let j=T.length;return I===!0&&j!==u.public||I===!1&&j!==u.publicUncompressed?!1:!!r.fromBytes(T)}catch{return!1}}function b(T=n(l)){return W6(T,a)}let C={isValidSecretKey:g,isValidPublicKey:y,randomSecretKey:b,isValidPrivateKey:g,randomPrivateKey:b,normPrivateKeyToScalar:T=>Mu(s,T),precompute(T=8,I=r.BASE){return I.precompute(T,!1)}};function D(T,I=!0){return r.BASE.multiply(Mu(s,T)).toBytes(I)}function U(T){if(typeof T=="bigint")return!1;if(T instanceof r)return!0;if(s.allowedLengths||u.secret===u.public)return;let I=Ze("key",T).length;return I===u.public||I===u.publicUncompressed}function X(T,I,j=!0){if(U(T)===!0)throw new Error("first arg must be private key");if(U(I)===!1)throw new Error("second arg must be public key");let N=Mu(s,T);return r.fromHex(I).multiply(N).toBytes(j)}let K=t.bits2int||function(T){if(T.length>8192)throw new Error("input is too large");let I=Su(T),j=T.length*8-c;return j>0?I>>BigInt(j):I},ee=t.bits2int_modN||function(T){return s.create(K(T))},$=ta(c);function B(T){return Uo("num < 2^"+c,T,ss,$),s.toBytes(T)}function S(T,I,j=x){if(["recovered","canonical"].some(dt=>dt in j))throw new Error("sign() legacy options not supported");let{lowS:N,prehash:te,extraEntropy:oe}=j;N==null&&(N=!0),T=Ze("msgHash",T),xS(j),te&&(T=Ze("prehashed msgHash",e(T)));let z=ee(T),Pe=Mu(s,I),Le=[B(Pe),B(z)];if(oe!=null&&oe!==!1){let dt=oe===!0?n(u.secret):oe;Le.push(Ze("extraEntropy",dt))}let ke=cn(...Le),Ne=z;function ze(dt){let Vt=K(dt);if(!s.isValidNot0(Vt))return;let qt=s.inv(Vt),li=r.BASE.multiply(Vt).toAffine(),dr=s.create(li.x);if(dr===ss)return;let To=s.create(qt*s.create(Ne+dr*Pe));if(To===ss)return;let Xa=(li.x===dr?0:2)|Number(li.y&Uu),Fi=To;return N&&f(To)&&(Fi=d(To),Xa^=1),new m(dr,Fi,Xa)}return{seed:ke,k2sig:ze}}let x={lowS:t.lowS,prehash:!1},P={lowS:t.lowS,prehash:!1};function k(T,I,j=x){let{seed:N,k2sig:te}=S(T,I,j);return PE(e.outputLen,s.BYTES,o)(N,te)}r.BASE.precompute(8);function F(T,I,j,N=P){let te=T;I=Ze("msgHash",I),j=Ze("publicKey",j),xS(N);let{lowS:oe,prehash:z,format:Pe}=N;if("strict"in N)throw new Error("options.strict was renamed to lowS");let Le,ke;if(Pe===void 0){let Ne=typeof te=="string"||dc(te),ze=!Ne&&te!==null&&typeof te=="object"&&typeof te.r=="bigint"&&typeof te.s=="bigint";if(!Ne&&!ze)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(ze)Le=new m(te.r,te.s);else if(Ne){try{Le=m.fromDER(te)}catch(dt){if(!(dt instanceof is.Err))throw dt}if(!Le)try{Le=m.fromCompact(te)}catch{return!1}}}else if(Pe==="compact"||Pe==="der"){if(typeof te!="string"&&!dc(te))throw new Error('"der" / "compact" format expects Uint8Array signature');Le=m.fromBytes(Ze("sig",te),Pe)}else if(Pe==="js"){if(!(te instanceof m))throw new Error('"js" format expects Signature instance');Le=te}else throw new Error('format must be "compact", "der" or "js"');if(!Le)return!1;try{if(ke=r.fromHex(j),oe&&Le.hasHighS())return!1;z&&(I=e(I));let{r:Ne,s:ze}=Le,dt=ee(I),Vt=s.inv(ze),qt=s.create(dt*Vt),li=s.create(Ne*Vt),dr=r.BASE.multiplyUnsafe(qt).add(ke.multiplyUnsafe(li));return dr.is0()?!1:s.create(dr.x)===Ne}catch{return!1}}function H(T){let I=C.randomSecretKey(T);return{secretKey:I,publicKey:D(I)}}return Object.freeze({keygen:H,getPublicKey:D,sign:k,verify:F,getSharedSecret:X,utils:C,Point:r,Signature:m,info:{type:"weierstrass",lengths:u,publicKeyHasPrefix:!0}})}function HM(r){let e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=r.allowedPrivateKeyLengths?Array.from(new Set(r.allowedPrivateKeyLengths.map(s=>Math.ceil(s/2)))):void 0,o=Mn(e.n,{BITS:r.nBitLength,allowedLengths:n,modOnDecode:r.wrapPrivateKey}),i={Fp:t,Fn:o,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:i}}function WM(r){let{CURVE:e,curveOpts:t}=HM(r),n={hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,hash:r.hash,ecdsaOpts:n}}function zM(r,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:r})}function _S(r){let{CURVE:e,curveOpts:t,hash:n,ecdsaOpts:o}=WM(r),i=VM(e,t),s=qM(i,n,o);return zM(r,s)}function AS(r,e){let t=n=>_S({...r,hash:n});return{...t(e),create:t}}var D5={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},GM={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var TS=BigInt(2);function XM(r){let e=D5.p,t=BigInt(3),n=BigInt(6),o=BigInt(11),i=BigInt(22),s=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=vt(u,t,e)*u%e,d=vt(f,t,e)*u%e,p=vt(d,TS,e)*l%e,m=vt(p,o,e)*p%e,g=vt(m,i,e)*m%e,y=vt(g,a,e)*g%e,b=vt(y,c,e)*y%e,C=vt(b,a,e)*g%e,D=vt(C,t,e)*u%e,U=vt(D,s,e)*m%e,X=vt(U,n,e)*l%e,K=vt(X,TS,e);if(!R5.eql(R5.sqr(K),r))throw new Error("Cannot find square root");return K}var R5=Mn(D5.p,void 0,void 0,{sqrt:XM}),Ko=AS({...D5,Fp:R5,lowS:!0,endo:GM},zm);var IS=32;function CS(r,e,t){let n=wt.digest(e instanceof Uint8Array?e:e.subarray());if(Ou(n))return n.then(({digest:o})=>(t?.signal?.throwIfAborted(),Ko.sign(o,r).toDERRawBytes())).catch(o=>{throw o.name==="AbortError"?o:new Ld(String(o))});try{return Ko.sign(n.digest,r).toDERRawBytes()}catch(o){throw new Ld(String(o))}}function PS(r,e,t,n){let o=wt.digest(t instanceof Uint8Array?t:t.subarray());if(Ou(o))return o.then(({digest:i})=>(n?.signal?.throwIfAborted(),Ko.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new Bd(String(i))});try{return n?.signal?.throwIfAborted(),Ko.verify(e,o.digest,r)}catch(i){throw new Bd(String(i))}}var tp=class{type="secp256k1";raw;_key;constructor(e){this._key=RS(e),this.raw=kS(this._key)}toMultihash(){return Mr.digest(cr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return rt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){return PS(this._key,t,e,n)}},rp=class{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=OS(e),this.publicKey=new tp(t??DS(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){return CS(this.raw,e,t)}};function N5(r){return new rp(r)}function L5(r){return new tp(r)}async function NS(){let r=YM();return new rp(r)}function kS(r){return Ko.ProjectivePoint.fromHex(r).toRawBytes(!0)}function OS(r){try{return Ko.getPublicKey(r,!0),r}catch(e){throw new md(String(e))}}function RS(r){try{return Ko.ProjectivePoint.fromHex(r),r}catch(e){throw new ji(String(e))}}function DS(r){try{return Ko.getPublicKey(r,!0)}catch(e){throw new md(String(e))}}function YM(){return Ko.utils.randomPrivateKey()}async function Fu(r,e){if(r==="Ed25519")return iS();if(r==="secp256k1")return NS();if(r==="RSA")return k5(QM(e));if(r==="ECDSA")return fE(ZM(e));throw new Co}function jt(r,e){let{Type:t,Data:n}=wi.decode(r),o=n??new Uint8Array;switch(t){case pt.RSA:return I5(o,e);case pt.Ed25519:return n5(o);case pt.secp256k1:return L5(o);case pt.ECDSA:return B6(o);default:throw new Co}}function s0(r){let{Type:e,Data:t}=wi.decode(r.digest),n=t??new Uint8Array;switch(e){case pt.Ed25519:return n5(n);case pt.secp256k1:return L5(n);case pt.ECDSA:return B6(n);default:throw new Co}}function cr(r){return wi.encode({Type:pt[r.type],Data:r.raw})}function LS(r){let e=Zd.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case pt.RSA:return T5(t);case pt.Ed25519:return r5(t);case pt.secp256k1:return N5(t);case pt.ECDSA:return sE(t);default:throw new Co}}function BS(r){if(r.byteLength===Un)return r5(r);if(r.byteLength===IS)return N5(r);let e=to(r),t=e[2]?.[0];if(t===Qx||t===Zx||t===Jx)return L6(e);if(e.length>8)return n0(e);throw new M("Could not extract private key from raw bytes")}function _c(r){return Zd.encode({Type:pt[r.type],Data:r.raw})}function QM(r){return r==null?2048:parseInt(r,10)}function ZM(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new M("Unsupported curve, should be P-256, P-384 or P-521")}async function a0(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new M("Only RSA and ECDSA keys are supported")}function MS(r,e,t,n){Yi(r);let o=yE({dkLen:32,asyncTick:10},n),{c:i,dkLen:s,asyncTick:a}=o;if(Lo(i),Lo(s),Lo(a),i<1)throw new Error("iterations (c) should be >= 1");let c=M6(e),l=M6(t),u=new Uint8Array(s),f=na.create(r,c),d=f._cloneInto().update(l);return{c:i,dkLen:s,asyncTick:a,DK:u,PRF:f,PRFSalt:d}}function US(r,e,t,n,o){return r.destroy(),e.destroy(),n&&n.destroy(),Ur(o),t}function FS(r,e,t,n){let{c:o,dkLen:i,DK:s,PRF:a,PRFSalt:c}=MS(r,e,t,n),l,u=new Uint8Array(4),f=pc(u),d=new Uint8Array(a.outputLen);for(let p=1,m=0;m<i;p++,m+=a.outputLen){let g=s.subarray(m,m+a.outputLen);f.setInt32(0,p,!1),(l=c._cloneInto(l)).update(u).digestInto(d),g.set(d.subarray(0,g.length));for(let y=1;y<o;y++){a._cloneInto(l).update(d).digestInto(d);for(let b=0;b<g.length;b++)g[b]^=d[b]}}return US(a,c,s,l,d)}async function c0(r,e,t,n){let{c:o,dkLen:i,asyncTick:s,DK:a,PRF:c,PRFSalt:l}=MS(r,e,t,n),u,f=new Uint8Array(4),d=pc(f),p=new Uint8Array(c.outputLen);for(let m=1,g=0;g<i;m++,g+=c.outputLen){let y=a.subarray(g,g+c.outputLen);d.setInt32(0,m,!1),(u=l._cloneInto(u)).update(f).digestInto(p),y.set(p.subarray(0,y.length)),await mE(o-1,s,()=>{c._cloneInto(u).update(p).digestInto(p);for(let b=0;b<y.length;b++)y[b]^=p[b]})}return US(c,l,a,u,p)}var np=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),oa=new Uint32Array(80),l0=class extends mc{constructor(){super(64,20,8,!1),this.A=np[0]|0,this.B=np[1]|0,this.C=np[2]|0,this.D=np[3]|0,this.E=np[4]|0}get(){let{A:e,B:t,C:n,D:o,E:i}=this;return[e,t,n,o,i]}set(e,t,n,o,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)oa[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)oa[c]=jm(oa[c-3]^oa[c-8]^oa[c-14]^oa[c-16],1);let{A:n,B:o,C:i,D:s,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=$m(o,i,s),u=1518500249):c<40?(l=o^i^s,u=1859775393):c<60?(l=Vm(o,i,s),u=2400959708):(l=o^i^s,u=3395469782);let f=jm(n,5)+l+a+u+oa[c]|0;a=s,s=i,i=jm(o,30),o=n,n=f}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,this.set(n,o,i,s,a)}roundClean(){Ur(oa)}destroy(){this.set(0,0,0,0,0),Ur(this.buffer)}},jS=jd(()=>new l0);var KS=jS;var ju=Gm;var $S={sha1:KS,"sha2-256":bi,"sha2-512":ju};function op(r,e,t,n,o){if(o!=="sha1"&&o!=="sha2-256"&&o!=="sha2-512"){let a=Object.keys($S).join(" / ");throw new M(`Hash '${o}' is unknown or not supported. Must be ${a}`)}let i=$S[o],s=FS(i,r,e,{c:t,dkLen:n});return Ht.encode(s).substring(1)}var B5={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},VS={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},qS=new globalThis.TextEncoder;function JM(r,e){let t=B5[e],n=VS[e];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(e,n*t);return n}function eU(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=B5[e],o=VS[e],i=r;for(;i.length>0;){let s=qS.encodeInto(i,t);i=i.slice(s.read);for(let a=0;a<s.written;a++)o^=BigInt(t[a]),o=BigInt.asUintN(e,o*n)}return o}function M5(r,{size:e=32,utf8Buffer:t}={}){if(!B5[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return eU(r,e,t);r=qS.encode(r)}return JM(r,e)}var ip={hash:r=>Number(M5(r,{size:32})),hashV:(r,e)=>tU(ip.hash(r,e))};function tU(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),q(e,"base16")}var U5=64,$o=class{fp;h;seed;constructor(e,t,n,o=2){if(o>U5)throw new TypeError("Invalid Fingerprint Size");let i=t.hashV(e,n),s=Ce(o);for(let a=0;a<s.length;a++)s[a]=i[a];s.length===0&&(s[0]=7),this.fp=s,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?me(this.fp,e.fp):!1}};function Ac(r,e){return Math.floor(Math.random()*(e-r))+r}var Tc=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof $o))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof $o))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof $o))throw new TypeError("Invalid Fingerprint");let t=Ac(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof $o))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var rU=500,sp=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??ip,this.seed=e.seed??Ac(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=q(e));let t=new $o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Tc(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new Tc(this.bucketSize)),this.buckets[n].add(t)||this.buckets[o].add(t))return this.count++,!0;let i=[n,o],s=i[Ac(0,i.length-1)];this.buckets[s]==null&&(this.buckets[s]=new Tc(this.bucketSize));for(let a=0;a<rU;a++){let c=this.buckets[s].swap(t);if(c!=null&&(s=(s^c.hash())%this.filterSize,this.buckets[s]==null&&(this.buckets[s]=new Tc(this.bucketSize)),this.buckets[s].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=q(e));let t=new $o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.has(t)??!1;if(o)return o;let i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=q(e));let t=new $o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.remove(t)??!1;if(o)return this.count--,o;let i=(n^t.hash())%this.filterSize,s=this.buckets[i]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},nU={1:.5,2:.84,4:.95,8:.98};function oU(r=.001){return r>.002?2:r>1e-5?4:8}function HS(r,e=.001){let t=oU(e),n=nU[t],o=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),U5);return{filterSize:o,bucketSize:t,fingerprintSize:i}}var u0=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??ip,this.seed=e.seed??Ac(0,Math.pow(2,10)),this.filterSeries=[new sp({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=q(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new sp({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=q(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=q(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function $r(r,e=.001,t){return new u0({...HS(r,e),...t??{}})}var Ic=class extends De{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=$r(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){let n=Ht.encode(e.multihash.bytes),o=this.requests.get(n);if(o!=null)return this.log("join existing request for %c",e),o;let i=ve();if(this.requests.set(n,i.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,u&&this.log("found initial session peers for %c",e)}let s=!1,a=new hr({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{s=!0,i.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(s||t.signal?.aborted===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){let f=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(f)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c",e,u),i.reject(u)})});let c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(f=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,f)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)});let l=()=>{i.reject(new rr(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await i.promise}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){let o=ve(),i=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;i<t&&this.initialProviders.length>0;){let s=this.initialProviders.pop();if(s==null)break;let a=await this.convertToProvider(s,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(i<this.maxProviders)for await(let s of this.findNewProviders(e,n)){if(i===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new Cd(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(s=>{this.log.error("error searching routing for potential session peers for %c",e,s.errors??s),o.reject(s)}),o.promise}};var f0=class{libp2p;blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??Ws(),this.log=this.logger.forComponent("helia"),this.getHasher=Vx(e.hashers,e.loadHasher),this.getCodec=$x(e.codecs,e.loadCodec),this.dns=e.dns??$1(),this.metrics=e.metrics,this.libp2p=e.libp2p;let t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new pm(t,{routers:(e.routers??[]).flatMap(o=>{let i=[o];return o[ui]!=null&&i.push(o[ui]),o[fi]!=null&&i.push(o[fi]),i}),providerLookupConcurrency:e.providerLookupConcurrency});let n=new Mm(t);this.pins=new fm(e.datastore,n,this.getCodec),this.blockstore=new km(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(o=>o(t))}async start(){await Tx(this.datastore),await pr(this.blockstore,this.datastore,this.routing,this.libp2p)}async stop(){await Nr(this.blockstore,this.datastore,this.routing,this.libp2p)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,o=this.blockstore.unwrap();this.log("gc start"),await an(o.deleteMany(async function*(){for await(let{cid:i}of o.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new ce("helia:gc:deleted",i))}catch(s){n.log.error("Error during gc",s),e.onProgress?.(new ce("helia:gc:error",s))}}()))}finally{t()}this.log("gc finished")}};var d0=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Ku=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},p0=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},ap=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function h0(r){return r[Symbol.asyncIterator]!=null}function WS(r,e){if(r.byteLength>e)throw new Ku("Message length too long")}var y0=r=>{let e=Ke(r),t=Tt(e);return ur(r,t),y0.bytes=e,t};y0.bytes=0;function as(r,e){e=e??{};let t=e.lengthEncoder??y0,n=e?.maxDataLength??4194304;function*o(i){WS(i,n);let s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return h0(r)?async function*(){for await(let i of r)yield*o(i)}():function*(){for(let i of r)yield*o(i)}()}as.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??y0,n=e?.maxDataLength??4194304;return WS(r,n),new xe(t(r.byteLength),r)};var Cc;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Cc||(Cc={}));var F5=r=>{let e=Fo(r);return F5.bytes=Ke(e),e};F5.bytes=0;function cs(r,e){let t=new xe,n=Cc.LENGTH,o=-1,i=e?.lengthDecoder??F5,s=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===Cc.LENGTH)try{if(o=i(t),o<0)throw new d0("Invalid message length");if(o>a)throw new Ku("Message length too long");let l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(o),n=Cc.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>s)throw new p0("Message length length too long");break}throw l}if(n===Cc.DATA){if(t.byteLength<o)break;let l=t.sublist(0,o);t.consume(o),e?.onData!=null&&e.onData(l),yield l,n=Cc.LENGTH}}}return h0(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new ap("Unexpected end of input")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new ap("Unexpected end of input")}()}cs.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:i,value:s}=await r.next(t);if(i===!0)return;s!=null&&(yield s)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return cs(n,{...e??{},onLength:i=>{t=i}})};function sU(r){return r[Symbol.asyncIterator]!=null}function aU(r,e){let t=0;if(sU(r))return async function*(){for await(let c of r)yield e(c,t++)}();let n=yu(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();let s=e(o,t++);if(typeof s.then=="function")return async function*(){yield await s;for(let c of n)yield e(c,t++)}();let a=e;return function*(){yield s;for(let c of n)yield a(c,t++)}()}var oo=aU;function ln(r,...e){if(r==null)throw new Error("Empty pipeline");if(j5(r)){let n=r;r=()=>n.source}else if(XS(r)||GS(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&j5(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)j5(t[n])&&(t[n]=lU(t[n]));return cU(...t)}var cU=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},GS=r=>r?.[Symbol.asyncIterator]!=null,XS=r=>r?.[Symbol.iterator]!=null,j5=r=>r==null?!1:r.sink!=null&&r.source!=null,lU=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=sr({objectMode:!0});t.then(()=>{n.end()},s=>{n.end(s)});let o,i=r.source;if(GS(i))o=async function*(){yield*i,n.end()};else if(XS(i))o=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Xr(n,o())}return r.source};function uU(r){return r[Symbol.asyncIterator]!=null}function fU(r,e){return uU(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var ia=fU;var cp="/ipfs/bitswap/1.2.0";var Kt;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(Kt||(Kt={}));var K5;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(K5||(K5={}));(function(r){r.codec=()=>_t(K5)})(Kt||(Kt={}));var $u;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),Kt.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:Ce(0),priority:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=Kt.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})($u||($u={}));var g0;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(let i of t.entries)n.uint32(10),$u.codec().encode(i,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={entries:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.entries!=null&&i.entries.length===o.limits.entries)throw new lt('Decode error - map field "entries" had too many elements');i.entries.push($u.codec().decode(t,t.uint32(),{limits:o.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(g0||(g0={}));var Vu;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={prefix:Ce(0),data:Ce(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Vu||(Vu={}));var io;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(io||(io={}));var w0;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(w0||(w0={}));(function(r){r.codec=()=>_t(w0)})(io||(io={}));var qu;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&w0[t.type]!==0&&(n.uint32(16),io.codec().encode(t.type,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:Ce(0),type:io.HaveBlock},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=io.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(qu||(qu={}));var Pc;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),g0.codec().encode(t.wantlist,n)),t.blocks!=null)for(let i of t.blocks)n.uint32(26),Vu.codec().encode(i,n);if(t.blockPresences!=null)for(let i of t.blockPresences)n.uint32(34),qu.codec().encode(i,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={blocks:[],blockPresences:[],pendingBytes:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.wantlist=g0.codec().decode(t,t.uint32(),{limits:o.limits?.wantlist});break}case 3:{if(o.limits?.blocks!=null&&i.blocks.length===o.limits.blocks)throw new lt('Decode error - map field "blocks" had too many elements');i.blocks.push(Vu.codec().decode(t,t.uint32(),{limits:o.limits?.blocks$}));break}case 4:{if(o.limits?.blockPresences!=null&&i.blockPresences.length===o.limits.blockPresences)throw new lt('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(qu.codec().decode(t,t.uint32(),{limits:o.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Pc||(Pc={}));function YS(r,e){for(let[t,n]of e.wantlist.entries()){let o=r.wantlist.get(t);o!=null&&(o.priority>n.priority&&(n.priority=o.priority),n.cancel=n.cancel??o.cancel,n.wantType=n.wantType??o.wantType,n.sendDontHave=n.sendDontHave??o.sendDontHave),r.wantlist.set(t,n)}for(let[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(let[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}var b0=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var dU=4193648,pU=dU+16;function*QS(r,e){let t=[...r.wantlist.values()],n=[...r.blockPresences.values()],o=[...r.blocks.values()],i=0,s=0,a=0,c=!1;for(;;){let l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},u=Pc.encode(l).byteLength,{added:f,hasMore:d,newSize:p}=$5(o,l.blocks,a,e,u,hU);a+=f,u=p;let m=d;({added:f,hasMore:d,newSize:p}=$5(n,l.blockPresences,s,e,u,mU)),s+=f,u=p;let g=d;if({added:f,hasMore:d,newSize:p}=$5(t,l.wantlist.entries,i,e,u,yU),i+=f,u=p,c=!m&&!g&&!d,c||(l.wantlist.full=!1),yield Pc.encode(l),c)break}}function $5(r,e,t,n,o,i){let s=0,a=!1;for(let c=t;c<r.length;c++){let l=r[c],u=i(l);if(u>pU)throw new b0("Cannot send block as after encoding it is over the max message size");let f=o+u;if(f>n){a=!0;break}e.push(l),s++,o=f}return{hasMore:a,added:s,newSize:o}}function hU(r){return V5(3,Vu.encode(r))}function mU(r){return V5(4,qu.encode(r))}function yU(r){return V5(1,$u.encode(r))}function V5(r,e){let t=Ke(r),n=Ke(e.byteLength);return t+n+e.byteLength}var v0=class extends De{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[cp],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new yr({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",n=>{this.log.error("error sending wantlist to peer",n.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;let{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);let o=()=>{t.status==="open"?t.abort(new Qn(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)},i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",o),await t.closeWrite(),await ln(t,s=>cs(s,{maxDataLength:this.maxIncomingMessageSize}),async s=>{for await(let a of s)try{let c=Pc.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:c}}),i.removeEventListener("abort",o),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",o)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,c),t.abort(c);break}})}).catch(o=>{this.log.error("error handling incoming stream from %p",n.remotePeer,o),t.abort(o)})}async*findProviders(e,t){t?.onProgress?.(new ce("bitswap:network:find-providers",e));for await(let n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield n)}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(o=>{this.log.error("could not connect to supplied provider - %e",o)}))),await an(oo(ia(this.findProviders(e,t),t?.maxProviders??3),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");let o=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(o!=null){o.options.message=YS(o.options.message,t),await o.join({signal:n?.signal});return}await this.sendQueue.add(async i=>{let s=i?.message;if(s==null)throw new M("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new ce("bitswap:network:send-wantlist",e));let a=await this.libp2p.dialProtocol(e,cp,i);await a.closeRead();try{await ln(QS(s,this.maxOutgoingMessageSize),c=>as(c),a),await a.close(i)}catch(c){i?.onProgress?.(new ce("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(s.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Tn("Network isn't running");t?.onProgress?.(new ce("bitswap:network:dial",e));let[n]=await Promise.all([this.libp2p.dial(e,t),Dt(this.libp2p,"peer:identify",t?.signal,{filter:o=>{if(!o.detail.peerId.equals(e))return!1;if(o.detail.protocols.includes(cp))return!0;throw new Ki(`${e} did not support ${cp}`)}})]);return n}_updateSentStats(e){let t=0;for(let n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};var ZS=Symbol.for("nodejs.util.inspect.custom"),AU=114,lp=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[E1]=!0;toString(){return this.string==null&&(this.string=rt.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(AU,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return me(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return me(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[ZS](){return`PeerId(${this.toString()})`}},up=class extends lp{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},fp=class extends lp{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},dp=class extends lp{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},TU=2336,pp=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Mr.digest(q(this.url))}[ZS](){return`PeerId(${this.url})`}[E1]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(TU,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};var IU=114,JS=2336;function Ct(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=st(rt.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Vo(ue.parse(r));if(e==null)throw new M('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=st(e.decode(r))}return zt(t)}function vi(r){if(r.type==="Ed25519")return new fp({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new dp({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new up({multihash:r.toCID().multihash,publicKey:r});throw new Co}function e_(r){return vi(r.publicKey)}function zt(r){if(PU(r))return new up({multihash:r});if(CU(r))try{let e=s0(r);if(e.type==="Ed25519")return new fp({multihash:r,publicKey:e});if(e.type==="secp256k1")return new dp({multihash:r,publicKey:e})}catch{let t=W(r.digest);return new pp(new URL(t))}throw new Vs("Supplied PeerID Multihash is invalid")}function Vo(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==IU&&r.code!==JS)throw new I1("Supplied PeerID CID is invalid");if(r.code===JS){let e=W(r.multihash.digest);return new pp(new URL(e))}return zt(r.multihash)}function CU(r){return r.code===Mr.code}function PU(r){return r.code===wt.code}function kc(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:e(o)}}};return t}function x0(r){let e=st(rt.decode(`z${r}`));return zt(e)}var Vr=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return kc(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return kc(this.map.values(),e=>e.key)}values(){return kc(this.map.values(),e=>e.value)}get size(){return this.map.size}};var jn=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return kc(this.set.entries(),e=>{let t=x0(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=x0(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return kc(this.set.values(),e=>x0(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function q5(){return new jn}var E0=class{filter;constructor(e,t){this.filter=$r(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function H5(r,e=.001){return new E0(r,e)}var W5=class extends Vr{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function ls(r){let{name:e,metrics:t}=r,n;return t!=null?n=new W5({name:e,metrics:t}):n=new Vr,n}var us=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let n=Ht.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){let n=Ht.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){let n=Ht.encode(e.multihash.bytes);this.blocks.set(n,t)}};function kU(r){let e=new Uint8Array(r.reduce((n,o)=>n+Ke(o),0)),t=0;for(let n of r)e=ur(n,e,t),t+=Ke(n);return e}var t_=kU;function z5(r){return t_([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}var S0=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new us,n=new Set;for(let[o,i]of this.wants.entries())try{let s=await this.blockstore.get(i.cid,e);i.wantType===Kt.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:z5(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:io.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:z5(i.cid)}))}catch(s){if(s.name!=="NotFoundError")throw s;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDoNotHave===!0)continue;i.sentDoNotHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:io.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((o,i)=>o+i.data.byteLength,0));for(let o of n)this.wants.delete(o)}}};var _0=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=ls({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new S0({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((o,i)=>o+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(let o of t.wantlist.entries){let i=ue.decode(o.cid),s=W(i.multihash.bytes,"base64");o.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),n.wants.delete(s)):(o.wantType===Kt.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),n.wants.set(s,{cid:i,priority:o.priority,wantType:o.wantType??Kt.WantBlock,sendDontHave:o.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){let n=W(e.multihash.bytes,"base64"),o=[];for(let i of this.ledgerMap.values())i.wants.has(n)&&o.push(i);await Promise.all(o.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};var G5=class extends Ic{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);let o=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,o.has?"has":"does not have",e),o.has&&o.block!=null)return o.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return Yn(e)?e:(await this.libp2p.dial(e,t)).remotePeer}};function r_(r,e){return new G5(r,e)}var A0=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}};var X5=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Gt(r){let{name:e,metrics:t}=r,n;return t!=null?n=new X5({name:e,metrics:t}):n=new Map,n}function OU(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=Fo(r);e.push(t),r=r.slice(Ke(t))}return e}var n_=OU;var T0=class extends De{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=ls({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Gt({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,o)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(o=>{this.log.error("error processing newly connected bitswap peer %p",n.detail,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){let n=W(e.multihash.bytes,"base64"),o=this.wants.get(n);o==null&&(o={cid:e,priority:t.priority??1,wantType:t.wantType??Kt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,o)),o.wantType===Kt.WantHave&&t.wantType===Kt.WantBlock&&(o.wantType=Kt.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===Kt.WantBlock?(await Dt(this,"block",t?.signal,{filter:a=>me(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Dt(this,"presence",t?.signal,{filter:s=>me(e.multihash.digest,s.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),o.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=ve(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let n=new Set,o=new us;for(let[i,s]of this.wants.entries())t.has(i)||s.cancel||(n.add(i),o.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(o.wantlist.size!==0)try{await this.network.sendMessage(e,o);for(let i of n)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer",i)}})).catch(e=>{this.log.error("error sending messages",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){let t=W(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){let o=new us;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Kt.WantHave,priority:1}),await this.network.sendMessage(t,o),(await Dt(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&me(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:Kt.WantBlock})}async wantSessionBlock(e,t,n={}){let o=new us;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Kt.WantBlock,priority:1}),await this.network.sendMessage(t,o),(await Dt(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&me(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let n=W(e.multihash.bytes,"base64"),o=this.wants.get(n);o!=null&&(o.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(let o of t.blocks){if(o.prefix==null||o.data==null)continue;let i=n_(o.prefix),s=i[0],a=i[1],c=i[2],l=c===wt.code?wt:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(o.data);u.then!=null&&(u=await u);let f=ue.create(s===0?0:1,a,u);this.log("received block from %p for %c",e,f),this.safeDispatchEvent("block",{detail:{sender:e,cid:f,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:f,has:!0,block:o.data}});let d=W(f.multihash.bytes,"base64"),p=this.wants.get(d);p!=null&&(p.cancel=!0,n=!0)}for(let{cid:o,type:i}of t.blockPresences){let s=ue.decode(o);this.log("received %s from %p for %c",i,e,s),this.safeDispatchEvent("presence",{detail:{sender:e,cid:s,has:i===io.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,n=new us(!0);for(let[o,i]of this.wants.entries())i.cancel||(t.add(o),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:Kt.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(o){this.log.error("error sending full wantlist to new peer %p",e,o)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var I0=class{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new A0(e),this.network=new v0(e,t),this.peerWantLists=new _0({...e,network:this.network},t),this.wantList=new T0({...e,network:this.network},t)}createSession(e={}){return r_({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){let n=new AbortController,o=Oe([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:o}).catch(i=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,i)});try{return(await this.wantList.wantBlock(e,{...t,signal:o})).block}finally{n.abort(),o.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var o_=(r,e={})=>new I0(r,e);var Y5=class{bitswap;started;constructor(e,t={}){let{getHasher:n}=e;this.bitswap=o_(e,{hashLoader:{getHasher:async o=>n(o)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(n,o,i)=>{await this.bitswap.notify(n,o,i)},retrieve:async(n,o)=>t.retrieve(n,o)}}};function Q5(r={}){return e=>new Y5(e,r)}var wr=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},fs=class extends Error{static name="ValidationError";name="ValidationError"},hp=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},C0=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};var P0=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,o){return this.readAtomically(()=>{let i=0,s=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*o)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let d=Number.parseInt(f,e);if(!Number.isNaN(d))return d});if(u===void 0)break;if(i*=e,i+=u,i>l||(s+=1,t!==void 0&&s>t))return}if(s!==0)return!n&&c&&s>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let o=n*2;if(n<t.length-3){let s=this.readSeparator(":",n,()=>this.readIPv4Addr());if(s!==void 0)return t[o]=s[0],t[o+1]=s[1],t[o+2]=s[2],t[o+3]=s[3],[o+4,!0]}let i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[o,!1];t[o]=i>>8,t[o+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,o]=e(t);if(n===16)return t;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let i=new Uint8Array(14),s=16-(n+2),[a]=e(i.subarray(0,s));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var i_=45,RU=15,Hu=new P0;function k0(r){if(!(r.length>RU))return Hu.new(r).parseWith(()=>Hu.readIPv4Addr())}function O0(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>i_))return Hu.new(r).parseWith(()=>Hu.readIPv6Addr())}function Wu(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>i_)return;let t=Hu.new(r).parseWith(()=>Hu.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function qo(r){return!!k0(r)}function R0(r){return!!O0(r)}function J5(r){return e=>W(e,r)}function e8(r){return e=>q(e,r)}function zu(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Oc(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function s_(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=q(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Oc(n);return St([t,o],t.length+o.length)}function a_(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=ir.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Oc(n);return St([t,o],t.length+o.length)}function t8(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=W(e,"base32"),o=zu(t);return`${n}:${o}`}var r8=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let o=parseInt(t,10);if(isNaN(o)||o<0||o>255)throw new wr("Invalid byte value in IP address");e[n]=o}),e},c_=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let i=qo(t[n]),s;i&&(s=r8(t[n]),t[n]=W(s.subarray(0,2),"base16")),s!=null&&++n<8&&t.splice(n,0,W(s.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}let o=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new wr("Invalid byte value in IP address");o[e++]=i>>8&255,o[e++]=i&255}return o},l_=function(r){if(r.byteLength!==4)throw new wr("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},u_=function(r){if(r.byteLength!==16)throw new wr("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let o=r[n],i=r[n+1],s=`${o.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(s)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new wr(`Invalid IPv6 address "${t}"`)}};function f_(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new wr(`Invalid IPv6 address "${r}"`)}}var Z5=Object.values(oc).map(r=>r.decoder),DU=function(){let r=Z5[0].or(Z5[1]);return Z5.slice(2).forEach(e=>r=r.or(e)),r}();function d_(r){return DU.decode(r)}function p_(r){return e=>r.encoder.encode(e)}function NU(r){if(parseInt(r).toString()!==r)throw new fs("Value must be an integer")}function LU(r){if(r<0)throw new fs("Value must be a positive integer, or zero")}function BU(r){return e=>{if(e>r)throw new fs(`Value must be smaller than or equal to ${r}`)}}function MU(...r){return e=>{for(let t of r)t(e)}}var mp=MU(NU,LU,BU(65535));var fr=-1,n8=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new C0(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},un=new n8,ZU=[{code:4,name:"ip4",size:32,valueToBytes:r8,bytesToValue:l_,validate:r=>{if(!qo(r))throw new fs(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Oc,bytesToValue:zu,validate:mp},{code:273,name:"udp",size:16,valueToBytes:Oc,bytesToValue:zu,validate:mp},{code:33,name:"dccp",size:16,valueToBytes:Oc,bytesToValue:zu,validate:mp},{code:41,name:"ip6",size:128,valueToBytes:c_,bytesToValue:u_,stringToValue:f_,validate:r=>{if(!R0(r))throw new fs(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:fr},{code:43,name:"ipcidr",size:8,bytesToValue:J5("base10"),valueToBytes:e8("base10")},{code:53,name:"dns",size:fr,resolvable:!0},{code:54,name:"dns4",size:fr,resolvable:!0},{code:55,name:"dns6",size:fr,resolvable:!0},{code:56,name:"dnsaddr",size:fr,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:Oc,bytesToValue:zu,validate:mp},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:fr,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:fr,bytesToValue:J5("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?e8("base58btc")(r):ue.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:t8,valueToBytes:s_},{code:445,name:"onion3",size:296,bytesToValue:t8,valueToBytes:a_},{code:446,name:"garlic64",size:fr},{code:447,name:"garlic32",size:fr},{code:448,name:"tls"},{code:449,name:"sni",size:fr},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:fr,bytesToValue:p_(ec),valueToBytes:d_},{code:480,name:"http"},{code:481,name:"http-path",size:fr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:fr}];ZU.forEach(r=>{un.addProtocol(r)});function h_(r){let e=[],t=0;for(;t<r.length;){let n=Fo(r,t),o=un.getProtocol(n),i=Ke(n),s=JU(o,r,t+i),a=0;s>0&&o.size===fr&&(a=Ke(s));let c=i+a+s,l={code:n,name:o.name,bytes:r.subarray(t,t+c)};if(s>0){let u=t+i+a,f=r.subarray(u,u+s);l.value=o.bytesToValue?.(f)??W(f)}e.push(l),t+=c}return e}function m_(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let o=un.getProtocol(n.code),i=Ke(n.code),s,a=0,c=0;n.value!=null&&(s=o.valueToBytes?.(n.value)??q(n.value),a=s.byteLength,o.size===fr&&(c=Ke(a)));let l=new Uint8Array(i+c+a),u=0;Nu(n.code,l,u),u+=i,s!=null&&(o.size===fr&&(Nu(a,l,u),u+=c),l.set(s,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return St(t,e)}function y_(r){if(r.charAt(0)!=="/")throw new wr('String multiaddr must start with "/"');let e=[],t="protocol",n="",o="";for(let i=1;i<r.length;i++){let s=r.charAt(i);s!=="/"&&(t==="protocol"?o+=r.charAt(i):n+=r.charAt(i));let a=i===r.length-1;if(s==="/"||a){let c=un.getProtocol(o);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",o="",t="protocol";continue}else if(a)throw new wr(`Component ${o} was missing value`);t="value"}else if(t==="value"){let l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new wr(`Component ${o} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",o="",t="protocol"}}}if(o!==""&&n!=="")throw new wr("Incomplete multiaddr");return e}function g_(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=un.getProtocol(e.code);if(t==null)throw new wr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function JU(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Fo(e,t)}var eF=Symbol.for("nodejs.util.inspect.custom"),p8=Symbol.for("@multiformats/multiaddr"),tF=[53,54,55,56],d8=class extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}};function rF(r){if(r==null&&(r="/"),aa(r))return r.getComponents();if(r instanceof Uint8Array)return h_(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),y_(r);if(Array.isArray(r))return r;throw new wr("Must be a string, Uint8Array, Component[], or another Multiaddr")}var B0=class r{[p8]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=rF(e),t.validate!==!1&&nF(this)}get bytes(){return this.#r==null&&(this.#r=m_(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=g_(this.#e)),this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,o,i="";for(let{code:a,name:c,value:l}of this.#e)a===42&&(i=`%${l??""}`),tF.includes(a)&&(t="tcp",o=443,n=`${l??""}${i}`,e=a===55?6:4),(a===6||a===273)&&(t=c==="tcp"?"tcp":"udp",o=parseInt(l??"")),(a===4||a===41)&&(t="tcp",n=`${l??""}${i}`,e=a===41?6:4);if(e==null||t==null||n==null||o==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:o}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{let n=un.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];let n=un.getProtocol(e),o=[e];return t!=null&&o.push(n.valueToBytes?.(t)??q(t)),o})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),o=n.lastIndexOf(t);if(o<0)throw new hp(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,o),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:o})=>{n===421&&e.push([n,o]),n===290&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?W(rt.decode(`z${n}`),"base58btc"):W(ue.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(let e of this.#e)if(un.getProtocol(e.code).path)return e.value??null;return null}equals(e){return me(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(i=>i.resolvable);if(t==null)return[this];let n=w_.get(t.name);if(n==null)throw new d8(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>ie(i))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==4&&this.#e[0].code!==41||this.#e[1].code!==6&&this.#e[1].code!==273)}[eF](){return`Multiaddr(${this.toString()})`}};function nF(r){r.getComponents().forEach(e=>{let t=un.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function b_(r,e,t){let n=0;for(let o of r)if(!(n<e)){if(n>t)break;if(o!==255)return!1;n++}return!0}function v_(r,e,t,n){let o=0;for(let i of r)if(!(o<t)){if(o>n)break;if(i!==e[o])return!1;o++}return!0}function h8(r){switch(r.length){case Dc:return r.join(".");case Nc:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function x_(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let o=t+1;o<r.length;o++)if(r[o]!=0)return-1;break}return e}function E_(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var Dc=4,Nc=16,Sie=parseInt("0xFFFF",16),oF=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function gp(r,e){e.length===Nc&&r.length===Dc&&b_(e,0,11)&&(e=e.slice(12)),e.length===Dc&&r.length===Nc&&v_(r,oF,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r[o]&e[o];return n}function S_(r,e){if(typeof e=="string"&&(e=Wu(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function m8(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Dc,o=k0(e);if(o==null&&(n=Nc,o=O0(e),o==null))throw new Error("Failed to parse given CIDR: "+r);let i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);let s=y8(i,8*n);return{network:gp(o,s),mask:s}}function y8(r,e){if(e!==8*Dc&&e!==8*Nc)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let o=0;o<t;o++){if(r>=8){n[o]=255,r-=8;continue}n[o]=255-(255>>r),r=0}return n}var Lc=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=m8(e));else{let n=Wu(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n.length*8){let i=Wu(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=y8(o,8*n.length);this.network=gp(n,this.mask)}}contains(e){return S_({network:this.network,mask:this.mask},e)}toString(){let e=x_(this.mask),t=e!==-1?String(e):E_(this.mask);return h8(this.network)+"/"+t}};function __(r,e){return new Lc(r).contains(e)}function g8(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new Lc(t,e)}var w_=new Map;function aa(r){return!!r?.[p8]}function ie(r){return new B0(r)}function co(r){let e=un.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}var iF=[6,53,56,54,55];function A_(r){return C_("sni",r)?.value}function T_(r){let e=C_("tcp",r)?.value;return e==null?"":`:${e}`}function C_(r,e){return e.find(t=>t.name===r)}function I_(r){return r.some(({code:e})=>e===448)}function Wo(r,e){let t=P_[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);let n=t(r,e);return r.code===41?`[${n}]`:n}var P_={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Wo(t,e)}:${r.value}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Wo(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Wo(t,e)}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Wo(t,e)}`},http:(r,e)=>{let t=I_(e),n=A_(e),o=T_(e);if(t&&n!=null)return`https://${n}${o}`;let i=t?"https://":"http://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=Wo(s,e);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Wo(t,e),o=decodeURIComponent(r.value??"");return`${n}${o}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Wo(t,e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Wo(t,e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Wo(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=I_(e),n=A_(e),o=T_(e);if(t&&n!=null)return`wss://${n}${o}`;let i=t?"wss://":"ws://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=Wo(s,e);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Wo(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function Yu(r,e){let n=ie(r).getComponents(),o=n.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let i=P_[o.name];if(i==null)throw new Error(`No interpreter found for ${o.name}`);let s=i(o,n)??"";return e?.assumeHttp!==!1&&iF.includes(o.code)&&(s=s.replace(/^.*:\/\//,""),o.value==="443"?s=`https://${s}`:s=`http://${s}`),(s.startsWith("http://")||s.startsWith("https://")||s.startsWith("ws://")||s.startsWith("wss://"))&&(s=new URL(s).toString(),s.endsWith("/")&&(s=s.substring(0,s.length-1))),s}var O_=tr(k_(),1),sF=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],aF=sF.map(r=>new O_.Netmask(r));function w8(r){for(let e of aF)if(e.contains(r))return!0;return!1}function cF(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function lF(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),o=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return w8(o)}function uF(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function fF(r){let e=r.split(":"),t=e[e.length-1];return w8(t)}function dF(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Jr(r){if(qo(r))return w8(r);if(cF(r))return lF(r);if(uF(r))return fF(r);if(R0(r))return dF(r)}var at=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),Ie=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),We=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),qr=(...r)=>({match:e=>{let t;for(let n of r){let o=n.match(e);o!==!1&&(t==null||o.length<t.length)&&(t=o)}return t??!1}}),Xe=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function it(...r){function e(o){if(o==null)return!1;let i=o.getComponents();for(let s of r){let a=s.match(i);if(a===!1)return!1;i=a}return i}function t(o){return e(o)!==!1}function n(o){let i=e(o);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}var pF=Ie(421),R_=it(pF),U0=Ie(54),F0=Ie(55),j0=Ie(56),v8=Ie(53),fse=it(U0,We(Ie(421))),dse=it(F0,We(Ie(421))),pse=it(j0,We(Ie(421))),bp=it(qr(v8,j0,U0,F0),We(Ie(421))),D_=Xe(Ie(4),We(Ie(43))),N_=Xe(We(Ie(42)),Ie(41),We(Ie(43))),x8=qr(D_,N_),Bc=qr(x8,v8,U0,F0,j0),L_=it(qr(x8,Xe(qr(v8,j0,U0,F0),We(Ie(421))))),E8=it(D_),S8=it(N_),B_=it(x8),_8=Xe(Bc,Ie(6)),vp=Xe(Bc,Ie(273)),Mc=it(Xe(_8,We(Ie(421)))),hse=it(vp),A8=Xe(vp,at(460),We(Ie(421))),K0=Xe(vp,at(461),We(Ie(421))),hF=qr(A8,K0),mse=it(A8),M_=it(K0),b8=qr(Bc,_8,vp,A8,K0),U_=qr(Xe(b8,at(477),We(Ie(421)))),ms=it(U_),F_=qr(Xe(b8,at(478),We(Ie(421))),Xe(b8,at(448),We(Ie(449)),at(477),We(Ie(421)))),Uc=it(F_),j_=Xe(vp,at(280),We(Ie(466)),We(Ie(466)),We(Ie(421))),xp=it(j_),K_=Xe(K0,at(465),We(Ie(466)),We(Ie(466)),We(Ie(421))),T8=it(K_),M0=qr(U_,F_,Xe(_8,We(Ie(421))),Xe(hF,We(Ie(421))),Xe(Bc,We(Ie(421))),j_,K_,Ie(421)),$0=it(M0),mF=Xe(M0,at(290),Ie(421)),fn=it(mF),yF=qr(Xe(M0,at(290),at(281),We(Ie(421))),Xe(M0,at(281),We(Ie(421))),Xe(at(281),We(Ie(421)))),Ep=it(yF),gF=qr(Xe(Bc,Ie(6),at(480),We(Ie(421))),Xe(Bc,at(480),We(Ie(421)))),$_=it(gF),wF=Xe(Bc,qr(Xe(Ie(6,"443"),at(480)),Xe(Ie(6),at(443)),Xe(Ie(6),at(448),at(480)),Xe(at(448),at(480)),at(448),at(443)),We(Ie(421))),V_=it(wF),bF=qr(Xe(Ie(777),We(Ie(421)))),yse=it(bF),vF=qr(Xe(Ie(400),We(Ie(421)))),gse=it(vF);function I8(r,e,t){return r.filter(n=>{if(V_.matches(n)||e&&$_.matches(n))return t||bp.matches(n)?!0:Jr(n.toOptions().host)===!1;if(!e&&t){let{host:o}=n.toOptions();if(o==="127.0.0.1"||o==="localhost"||o.endsWith(".localhost"))return!0}return!1})}async function*V0(r,e,t,n,o,i={}){for await(let s of e.findProviders(r,i)){let a=I8(s.multiaddrs,n,o);if(a.length===0)continue;let c=Yu(a[0]);yield new Qu(c,{logger:t,transformRequestInit:i.transformRequestInit})}}async function q_(r,e,t){let{signal:n,log:o}=t??{},i=r.headers.get("content-length");if(i!=null){let c=parseInt(i,10);if(c>e)throw o?.error("content-length header (%d) is greater than the limit (%d)",c,e),r.body!=null&&await r.body.cancel().catch(l=>{o?.error("error cancelling response body after content-length check - %e",l)}),new Error(`Content-Length header (${c}) is greater than the limit (${e}).`)}let s=r.body?.getReader();if(s==null)throw new Error("Response body is not readable");let a=new xe;try{for(;;){if(n?.aborted===!0)throw new Error("Response body read was aborted.");let{done:c,value:l}=await s.read();if(c)break;if(a.append(l),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{s.cancel().catch(c=>{o?.error("error cancelling reader - %e",c)}).finally(()=>{s.releaseLock()})}return a.subarray()}var Qu=class{url;#e=0;#t=0;#r=0;#a=0;#s=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#l(e){let t=e.multihash.bytes;return Ht.encode(t)}async getRawBlock(e,{signal:t,maxSize:n=H_}={}){let o=new URL(this.url.toString());if(o.pathname=`/ipfs/${e.toString()}`,o.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let i=this.#l(e),s=new AbortController,a=()=>{s.abort()};t?.addEventListener("abort",a);try{let c=this.#s.get(i);if(c==null){this.#e++;let l={signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},u=this.transformRequestInit!=null?await this.transformRequestInit(l):l;c=fetch(o.toString(),u).then(async f=>{if(this.log("GET %s %d",o,f.status),!f.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);let d=await q_(f,n,{signal:s.signal,log:this.log});return this.#a++,d}),this.#s.set(i,c)}return await c}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",a),this.#s.delete(i)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#a/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#a,pendingResponses:this.#s.size}}};var C8=class extends Ic{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??q0,this.allowLocal=t.allowLocal??H0,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);let o=await t.getRawBlock(e,n);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(o),o}async*findNewProviders(e,t={}){yield*V0(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(Yn(e))return;let n=I8(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;let o=Yu(n[0]);return new Qu(o,{logger:this.logger,transformRequestInit:this.transformRequestInit})}};function W_(r,e){return new C8(r,e)}var W0=class{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??q0,this.allowLocal=t.allowLocal??H0,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){let n=[];for await(let o of V0(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{let i=await o.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,o.url);try{await t.validateFn?.(i)}catch(s){this.log.error("failed to validate block for %c from %s",e,o.url,s);continue}return i}catch(i){if(this.log.error("failed to get block for %c from %s",e,o.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return W_({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}};var q0=!1,H0=!1,H_=2097152;function P8(r={}){return e=>new W0(e,r)}async function*z0(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var TF=tr(G0(),1);var zo=class extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}},X0=class extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}},Zu=class extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}},Y0=class extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}},Q0=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},Z0=class extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}},Sp=class extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}};var dn;(function(r){let e;(function(o){o.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(o){o[o.EOL=0]="EOL"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.value!=null&&(i.uint32(10),i.bytes(o.value)),o.signatureV1!=null&&(i.uint32(18),i.bytes(o.signatureV1)),o.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(o.validityType,i)),o.validity!=null&&(i.uint32(34),i.bytes(o.validity)),o.sequence!=null&&(i.uint32(40),i.uint64(o.sequence)),o.ttl!=null&&(i.uint32(48),i.uint64(o.ttl)),o.pubKey!=null&&(i.uint32(58),i.bytes(o.pubKey)),o.signatureV2!=null&&(i.uint32(66),i.bytes(o.signatureV2)),o.data!=null&&(i.uint32(74),i.bytes(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.value=o.bytes();break}case 2:{a.signatureV1=o.bytes();break}case 3:{a.validityType=r.ValidityType.codec().decode(o);break}case 4:{a.validity=o.bytes();break}case 5:{a.sequence=o.uint64();break}case 6:{a.ttl=o.uint64();break}case 7:{a.pubKey=o.bytes();break}case 8:{a.signatureV2=o.bytes();break}case 9:{a.data=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(dn||(dn={}));var xF=Cn("ipns:utils"),z_=q("/ipns/");var EF=0,SF=18;function G_(r){let e;if(r.pubKey!=null)try{e=jt(r.pubKey)}catch(t){throw xF.error(t),t}if(e!=null)return e}function X_(r){let e=q("ipns-signature:");return St([e,r])}function _p(r){return"signatureV1"in r?dn.encode({value:q(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:q(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):dn.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function Ei(r){let e=dn.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new zo("Missing data or signatureV2");let t=Y_(e.data),n=_F(t.Value),o=W(t.Validity);if(e.value!=null&&e.signatureV1!=null)return AF(e),{value:n,validityType:dn.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:dn.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function Ap(r){return St([z_,r.bytes])}function Ju(r){let e=st(r.slice(z_.length));if(!J0(e,EF)&&!J0(e,SF))throw new Vs("Multihash in IPNS key was not identity or sha2-256");return e}function Y_(r){let e=Ln(r);if(e.ValidityType===0)e.ValidityType=dn.ValidityType.EOL;else throw new Zu("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function _F(r){let e=W(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${ue.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${ue.parse(e).toV1().toString()}`}catch{}throw new Q0("Value must be a valid content path starting with /")}function AF(r){if(r.data==null)throw new Z0("Record data is missing");let e=Y_(r.data);if(!me(e.Value,r.value??new Uint8Array(0)))throw new zo('Field "value" did not match between protobuf and CBOR');if(!me(e.Validity,r.validity??new Uint8Array(0)))throw new zo('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new zo('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new zo('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new zo('Field "ttl" did not match between protobuf and CBOR')}function J0(r,e){return r.code===e}var fae=Cn("ipns"),dae=300*1e9,IF="/ipns/",pae=IF.length;var Q_=tr(G0(),1);var e2=Cn("ipns:validator"),CF=1024*10;async function PF(r,e){let t=Ei(e),n;try{let o=X_(t.data);n=await r.verify(o,t.signatureV2)}catch{n=!1}if(!n)throw e2.error("record signature verification failed"),new zo("Record signature verification failed");if(t.validityType===dn.ValidityType.EOL){if(Q_.default.fromString(t.validity).toDate().getTime()<Date.now())throw e2.error("record has expired"),new X0("record has expired")}else if(t.validityType!=null)throw e2.error("the validity type is unsupported"),new Zu("The validity type is unsupported");e2("ipns record for %s is valid",t.value)}async function t2(r,e){if(e.byteLength>CF)throw new Y0("The record is too large");let t=Ju(r),n;J0(t,0)&&(n=s0(t));let o=Ei(e),i=G_(o)??n;if(i==null)throw new Sp("Could not extract public key from IPNS record or routing key");let s=Ap(i.toMultihash());if(!me(s,r))throw new Sp("Embedded public key did not match routing key");await PF(i,e)}var r2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*Tp(r,e={}){let t=/\r?\n/,n=new TextDecoder("utf8"),o="";for await(let i of r){if(typeof i=="string"&&(i=new TextEncoder().encode(i)),gu(i)&&(i=i.subarray()),o+=n.decode(i,{stream:!0}),o.length>(e?.maxMessageLength??o.length))throw new r2("Incoming message too long");let s=o.split(t);o=s.pop()??"";for(let a=0;a<s.length;a++)yield JSON.parse(s[a])}o+=n.decode(),o!==""&&(yield JSON.parse(o))}var ef=class extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}},Go=class extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}};function kF(r){return r[Symbol.asyncIterator]!=null}function OF(r){if(kF(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var Z_=OF;var J_=q("/ipns/");function eA(r){return me(r.subarray(0,J_.byteLength),J_)}var n2=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*oo(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!eA(e))return;let o=Ju(e),i=ue.createV1(114,o),s=Ei(t);await this.client.putIPNS(i,s,n)}async get(e,t){if(!eA(e))throw new qe("Not found");let n=Ju(e),o=ue.createV1(114,n);try{let i=await this.client.getIPNS(o,t);return _p(i)}catch(i){throw i.name==="BadResponseError"?new qe("Not found"):i}}},o2=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await Z_(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new qe("Not found")}async*getClosestPeers(e,t={}){}};var br=Cn("delegated-routing-v1-http-api-client"),i2={concurrentRequests:4,timeout:3e4,cacheTTL:300*1e3,cacheName:"delegated-routing-v1-cache"},s2=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new tc({concurrency:t.concurrentRequests??i2.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??i2.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new n2(this),this.peerRouting=new o2(this),this.cacheName=t.cacheName??i2.cacheName,this.cacheTTL=t.cacheTTL??i2.cacheTTL}get[ui](){return this.contentRouting}get[fi](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&br("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){br("getProviders starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=Oe([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:o},l=await this.#r(a.toString(),c);if(l==null)throw new Go("No response received");if(!l.ok)throw l.status===404?new qe("No matching records found"):l.status===422?new ef("Request does not conform to schema or semantic constraints"):new Go(`Unexpected status code: ${l.status}`);if(l.body==null)throw new Go("Routing response had no body");let u=l.headers.get("Content-Type");if(u==null)throw new Go("No Content-Type header received");if(u?.startsWith("application/json")){let f=await l.json();for(let d of f.Providers){let p=this.#e(d);p!=null&&(yield p)}}else if(u.includes("application/x-ndjson"))for await(let f of Tp(z0(l.body))){let d=this.#e(f);d!=null&&(yield d)}else throw new Go(`Unsupported Content-Type: ${u}`)}finally{o.clear(),s.resolve(),br("getProviders finished: %c",e)}}async*getPeers(e,t={}){br("getPeers starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=Oe([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:o},l=await this.#r(a.toString(),c);if(l.status===404)throw new qe("No matching records found");if(l.status===422)throw new ef("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Go("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){let f=await l.json();for(let d of f.Peers){let p=this.#e(d);p!=null&&(yield p)}}else for await(let f of Tp(z0(l.body))){let d=this.#e(f);d!=null&&(yield d)}}catch(a){br.error("getPeers errored:",a)}finally{o.clear(),s.resolve(),br("getPeers finished: %c",e)}}async getIPNS(e,t={}){br("getIPNS starts: %s",e);let n=AbortSignal.timeout(this.timeout),o=Oe([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));let a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await i.promise;let c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:o},l=await this.#r(a,c);if(br("getIPNS GET %s %d",a,l.status),l.status===404)throw new qe("No matching records found");if(l.status===422)throw new ef("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Go("GET ipns response had no body");let u=await l.arrayBuffer(),f=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await t2(Ap(e.multihash),f),Ei(f)}catch(c){throw br.error("getIPNS GET %s error:",a,c),c}finally{o.clear(),s.resolve(),br("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){br("putIPNS starts: %c",e);let o=AbortSignal.timeout(this.timeout),i=Oe([this.shutDownController.signal,o,n.signal]);let s=ve(),a=ve();this.httpQueue.add(async()=>(s.resolve(),a.promise));let c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;let l=_p(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i},f=await this.#r(c,u);if(br("putIPNS PUT %s %d",c,f.status),f.status!==200)throw new Go("PUT ipns response had status other than 200")}catch(l){throw br.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),br("putIPNS finished: %c",e)}}#e(e){try{let t=[],n=e.Addrs?.map(ie)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Ct(e.ID),Addrs:n,Protocols:t}}catch(t){br.error("could not conform record to peer schema",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){let o=t?.join(",")??this.filterAddrs?.join(",")??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(n!=null||this.filterProtocols!=null){let o=n?.join(",")??this.filterProtocols?.join(",")??"";o!==""&&e.searchParams.set("filter-protocols",o)}}async#r(e,t){let n=t.method??"GET",o=`${n}-${e}`;if(n==="GET"){let c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return br("returning cached response for %s",o),c;await this.cache?.delete(e)}}let i=this.inFlightRequests.get(o);if(i!=null){let c=await i;return br("deduplicating outgoing request for %s",o),c.clone()}let s=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){let l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());let f=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,f)}return c}).finally(()=>{this.inFlightRequests.delete(o)});return this.inFlightRequests.set(o,s),await s}};function tA(r,e={}){return new s2(new URL(r),e)}function O8(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}var rA="[a-fA-F\\d:]",ca=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${rA})|(?<=${rA})(?=\\s|$))`:"",Xo="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Yt="[a-fA-F\\d]{1,4}",a2=`
(?:
(?:${Yt}:){7}(?:${Yt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Yt}:){6}(?:${Xo}|:${Yt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Yt}:){5}(?::${Xo}|(?::${Yt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Yt}:){4}(?:(?::${Yt}){0,1}:${Xo}|(?::${Yt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Yt}:){3}(?:(?::${Yt}){0,2}:${Xo}|(?::${Yt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Yt}:){2}(?:(?::${Yt}){0,3}:${Xo}|(?::${Yt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Yt}:){1}(?:(?::${Yt}){0,4}:${Xo}|(?::${Yt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Yt}){0,5}:${Xo}|(?::${Yt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),RF=new RegExp(`(?:^${Xo}$)|(?:^${a2}$)`),DF=new RegExp(`^${Xo}$`),NF=new RegExp(`^${a2}$`),R8=r=>r&&r.exact?RF:new RegExp(`(?:${ca(r)}${Xo}${ca(r)})|(?:${ca(r)}${a2}${ca(r)})`,"g");R8.v4=r=>r&&r.exact?DF:new RegExp(`${ca(r)}${Xo}${ca(r)}`,"g");R8.v6=r=>r&&r.exact?NF:new RegExp(`${ca(r)}${a2}${ca(r)}`,"g");var D8=R8;function N8(r){let e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}function nA(){return!1}var{toString:LF}=Object.prototype;function L8(r){return LF.call(r)==="[object RegExp]"}var oA={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function B8(r,e={}){if(!L8(r))throw new TypeError("Expected a RegExp instance");let t=Object.keys(oA).map(o=>(typeof e[o]=="boolean"?e[o]:r[o])?oA[o]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function M8(r,e,{timeout:t}={}){try{return N8(()=>B8(r).test(e),{timeout:t})()}catch(n){if(nA(n))return!1;throw n}}var BF=15,MF=45,iA={timeout:400};function U8(r){return r.length>MF?!1:M8(D8.v6({exact:!0}),r,iA)}function sA(r){return r.length>BF?!1:M8(D8.v4({exact:!0}),r,iA)}var aA={http:"80",https:"443",ws:"80",wss:"443"},UF=["http","https","ws","wss"];function cA(r,e){e=e??{};let t=e.defaultDnsType??"dns",{scheme:n,hostname:o,port:i,path:s}=FF(r),a=[jF(o,t),KF(i,n),$F(n)];s!=null&&a.push(VF(s));let c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return ie(c)}function FF(r){let[e]=r.split(":");UF.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:o,pathname:i,search:s}=new URL(r);if(o==null||o===""){let c=qF(e);c!=null&&(o=c),c==null&&t==="http:"&&(o="80")}let a;return i!=null&&i!==""&&i!=="/"&&(i.startsWith("/")&&(i=i.substring(1)),a=i),s!=null&&s!==""&&(a=a??"",a+=s),{scheme:e,hostname:n,port:o,path:a}}function jF(r,e){if(!(r==null||r==="")){if(sA(r))return["ip4",r];if(U8(r))return["ip6",r];if(r[0]==="["){let t=r.substring(1,r.length-1);if(U8(t))return["ip6",t]}return[e,r]}}function KF(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function $F(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function VF(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function qF(r){if(!(r==null||r===""||aA[r]==null))return aA[r]}var HF=["https://trustless-gateway.link","https://4everland.io"],WF=2336;function zF(r){return r=r.toString(),{id:Vo(ue.createV1(WF,Mr.digest(q(r)))),multiaddrs:[cA(r)]}}var F8=class{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??HF).map(t=>zF(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}};function j8(r={}){return new F8(r)}var K8=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}};function $8(r){return new K8(r)}var Ip=class extends Gi{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(ir.encode(e.multihash.bytes),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(ir.encode(e.multihash.bytes));if(n==null)throw new eo;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(ir.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(ir.encode(e.multihash.bytes))}async*getAll(e){e?.signal?.throwIfAborted();for(let[t,n]of this.data.entries())yield{cid:ue.createV1(rc,st(ir.decode(t))),block:n},e?.signal?.throwIfAborted()}};var Xce=Cn("blockstore:core:tiered");var lA="SHARDING";function XF(r){return r[Symbol.asyncIterator]!=null}function YF(r){if(XF(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var Fc=YF;function QF(r){return r[Symbol.asyncIterator]!=null}function ZF(r,e){return QF(r)?async function*(){yield*(await Fc(r)).sort(e)}():function*(){yield*Fc(r).sort(e)}()}var c2=ZF;var ys=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:o}of e)await this.put(n,o,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,o){e.push({key:n,value:o})},delete(n){t.push(n)},commit:async n=>{await an(this.putMany(e,n)),e=[],await an(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let o=e.prefix;n=Do(n,i=>i.key.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>Do(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>c2(o,i),n)),e.offset!=null){let o=0,i=e.offset;n=Do(n,()=>o++>=i)}return e.limit!=null&&(n=ia(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let o=e.prefix;n=Do(n,i=>i.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>Do(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>c2(o,i),n)),e.offset!=null){let o=e.offset,i=0;n=Do(n,()=>i++>=o)}return e.limit!=null&&(n=ia(n,e.limit)),n}};var jc=class extends ys{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(e.toString());if(n==null)throw new eo;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(let[n,o]of this.data.entries())yield{key:new ct(n),value:o},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(let n of this.data.keys())yield new ct(n),t?.signal?.throwIfAborted()}};var Cle=new ct(lA);var $le=Cn("datastore:core:tiered");function tf(r){if(typeof r!="object"||r===null)return!1;let e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}var{hasOwnProperty:dA}=Object.prototype,{propertyIsEnumerable:JF}=Object,rf=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},ej=void 0,fA={concatArrays:!1,ignoreUndefined:!1},l2=r=>{let e=[];for(let t in r)dA.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)JF.call(r,n)&&e.push(n)}return e};function nf(r){return Array.isArray(r)?tj(r):tf(r)?rj(r):r}function tj(r){let e=r.slice(0,0);return l2(r).forEach(t=>{rf(e,t,nf(r[t]))}),e}function rj(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return l2(r).forEach(t=>{rf(e,t,nf(r[t]))}),e}var pA=(r,e,t,n)=>(t.forEach(o=>{typeof e[o]>"u"&&n.ignoreUndefined||(o in r&&r[o]!==Object.getPrototypeOf(r)?rf(r,o,V8(r[o],e[o],n)):rf(r,o,nf(e[o])))}),r),nj=(r,e,t)=>{let n=r.slice(0,0),o=0;return[r,e].forEach(i=>{let s=[];for(let a=0;a<i.length;a++)dA.call(i,a)&&(s.push(String(a)),i===r?rf(n,o++,i[a]):rf(n,o++,nf(i[a])));n=pA(n,i,l2(i).filter(a=>!s.includes(a)),t)}),n};function V8(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?nj(r,e,t):!tf(e)||!tf(r)?nf(e):pA(r,e,l2(e),t)}function of(...r){let e=V8(nf(fA),this!==ej&&this||{},fA),t={_:{}};for(let n of r)if(n!==void 0){if(!tf(n))throw new TypeError("`"+n+"` is not an Option Object");t=V8(t,{_:n},e)}return t._}var q8=class{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){let n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];let i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Pn.TXT]}),s=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(let c of i.Answer){let l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(s!=null&&!l.includes(s)||a.push(ie(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=$1()),this.dns)}},Kc=new q8;var oj={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Kc}},transportManager:{faultTolerance:Qa.FATAL_ALL}};async function hA(r){let e=of(oj,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new M("Private network is enforced, but no protector was provided");return e}var Cp;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:Ce(0),payloadType:Ce(0),payload:Ce(0),signature:Ce(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Cp||(Cp={}));var u2=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var $n=class r{static createFromProtobuf=e=>{let t=Cp.decode(e),n=jt(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let o=e.domain,i=e.codec,s=e.marshal(),a=mA(o,i,s),c=await t.sign(a.subarray(),n);return new r({publicKey:t.publicKey,payloadType:i,payload:s,signature:c})};static openAndCertify=async(e,t,n)=>{let o=r.createFromProtobuf(e);if(!await o.validate(t,n))throw new u2("Envelope signature is not valid for the given domain");return o};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:o,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=o,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Cp.encode({publicKey:cr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:me(this.marshal(),e.marshal())}async validate(e,t){let n=mA(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}},mA=(r,e,t)=>{let n=q(r),o=ur(n.byteLength),i=ur(e.length),s=ur(t.length);return new xe(o,n,i,e,s,t)};function yA(r,e){let t=(n,o)=>n.toString().localeCompare(o.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,o)=>e[o].equals(n)))}var gA="libp2p-peer-record",wA=Uint8Array.from([3,1]);var Pp;(function(r){let e;(function(n){let o;n.codec=()=>(o==null&&(o=Ae((i,s,a={})=>{a.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),a.lengthDelimited!==!1&&s.ldelim()},(i,s,a={})=>{let c={multiaddr:Ce(0)},l=s==null?i.len:i.pos+s;for(;i.pos<l;){let u=i.uint32();switch(u>>>3){case 1:{c.multiaddr=i.bytes();break}default:{i.skipType(u&7);break}}}return c})),o),n.encode=i=>_e(i,n.codec()),n.decode=(i,s)=>Se(i,n.codec(),s)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=Ae((n,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(o.uint32(10),o.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(o.uint32(16),o.uint64(n.seq)),n.addresses!=null)for(let s of n.addresses)o.uint32(26),r.AddressInfo.codec().encode(s,o);i.lengthDelimited!==!1&&o.ldelim()},(n,o,i={})=>{let s={peerId:Ce(0),seq:0n,addresses:[]},a=o==null?n.len:n.pos+o;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{s.peerId=n.bytes();break}case 2:{s.seq=n.uint64();break}case 3:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new lt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:i.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return s})),t),r.encode=n=>_e(n,r.codec()),r.decode=(n,o)=>Se(n,r.codec(),o)})(Pp||(Pp={}));var en=class r{static createFromProtobuf=e=>{let t=Pp.decode(e),n=zt(st(t.peerId)),o=(t.addresses??[]).map(s=>ie(s.multiaddr)),i=t.seq;return new r({peerId:n,multiaddrs:o,seqNumber:i})};static DOMAIN=gA;static CODEC=wA;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:o}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=o??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Pp.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!yA(this.multiaddrs,e.multiaddrs))}};var gs;(function(r){let e;(function(o){let i;o.codec=()=>(i==null&&(i=Ae((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&s.value.byteLength>0&&(a.uint32(18),a.bytes(s.value)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:"",value:Ce(0)},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(f&7);break}}}return l})),i),o.encode=s=>_e(s,o.codec()),o.decode=(s,a)=>Se(s,o.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(o){let i;o.codec=()=>(i==null&&(i=Ae((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&(a.uint32(18),d2.codec().encode(s.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:""},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=d2.codec().decode(s,s.uint32(),{limits:c.limits?.value});break}default:{s.skipType(f&7);break}}}return l})),i),o.encode=s=>_e(s,o.codec()),o.decode=(s,a)=>Se(s,o.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.addresses!=null)for(let a of o.addresses)i.uint32(10),f2.codec().encode(a,i);if(o.protocols!=null)for(let a of o.protocols)i.uint32(18),i.string(a);if(o.publicKey!=null&&(i.uint32(34),i.bytes(o.publicKey)),o.peerRecordEnvelope!=null&&(i.uint32(42),i.bytes(o.peerRecordEnvelope)),o.metadata!=null&&o.metadata.size!==0)for(let[a,c]of o.metadata.entries())i.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},i);if(o.tags!=null&&o.tags.size!==0)for(let[a,c]of o.tags.entries())i.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},i);o.updated!=null&&(i.uint32(64),i.uint64Number(o.updated)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&a.addresses.length===s.limits.addresses)throw new lt('Decode error - map field "addresses" had too many elements');a.addresses.push(f2.codec().decode(o,o.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&a.protocols.length===s.limits.protocols)throw new lt('Decode error - map field "protocols" had too many elements');a.protocols.push(o.string());break}case 4:{a.publicKey=o.bytes();break}case 5:{a.peerRecordEnvelope=o.bytes();break}case 6:{if(s.limits?.metadata!=null&&a.metadata.size===s.limits.metadata)throw new Qd('Decode error - map field "metadata" had too many elements');let u=r.Peer$metadataEntry.codec().decode(o,o.uint32());a.metadata.set(u.key,u.value);break}case 7:{if(s.limits?.tags!=null&&a.tags.size===s.limits.tags)throw new Qd('Decode error - map field "tags" had too many elements');let u=r.Peer$tagsEntry.codec().decode(o,o.uint32(),{limits:{value:s.limits?.tags$value}});a.tags.set(u.key,u.value);break}case 8:{a.updated=o.uint64Number();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(gs||(gs={}));var f2;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={multiaddr:Ce(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(f2||(f2={}));var d2;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(d2||(d2={}));function ij(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());let n=jt(e.publicKey,t);return vi(n)}function bA(r,e,t){let n=gs.decode(e);return sf(r,n,t)}function sf(r,e,t){let n=new Map,o=BigInt(Date.now());for(let[i,s]of e.tags.entries())s.expiry!=null&&s.expiry<o||n.set(i,s);return{...e,id:ij(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:s})=>({multiaddr:ie(i),isCertified:s??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function vA(r,e){return sj(r.addresses,e.addresses)&&aj(r.protocols,e.protocols)&&cj(r.publicKey,e.publicKey)&&lj(r.peerRecordEnvelope,e.peerRecordEnvelope)&&uj(r.metadata,e.metadata)&&fj(r.tags,e.tags)}function sj(r,e){return EA(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!me(t.multiaddr,n.multiaddr)))}function aj(r,e){return EA(r,e,(t,n)=>t===n)}function cj(r,e){return xA(r,e)}function lj(r,e){return xA(r,e)}function uj(r,e){return SA(r,e,(t,n)=>me(t,n))}function fj(r,e){return SA(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function xA(r,e){return r==null&&e==null?!0:r!=null&&e!=null?me(r,e):!1}function EA(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function SA(r,e,t){if(r.size!==e.size)return!1;for(let[n,o]of r.entries()){let i=e.get(n);if(i==null||!t(o,i))return!1}return!0}var H8="/peers/";function kp(r){if(!Yn(r)||r.type==null)throw new M("Invalid PeerId");let e=r.toCID().toString();return new ct(`${H8}${e}`)}async function _A(r,e,t,n,o){let i=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=ie(s.multiaddr)),!aa(s.multiaddr))throw new M("Multiaddr was invalid");if(!await e(r,s.multiaddr,o))continue;let a=s.isCertified??!1,c=s.multiaddr.toString(),l=i.get(c);l!=null?s.isCertified=l.isCertified||a:i.set(c,{multiaddr:s.multiaddr,isCertified:a})}return[...i.values()].sort((s,a)=>s.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:s,multiaddr:a})=>{let c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(ie(`/p2p/${r}`))),{isCertified:s,multiaddr:a.bytes}})}async function h2(r,e,t,n){if(e==null)throw new M("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new M("publicKey bytes do not match peer id publicKey bytes");let o=n.existingPeer?.peer;if(o!=null&&!r.equals(o.id))throw new M("peer id did not match existing peer id");let i=o?.addresses??[],s=new Set(o?.protocols??[]),a=o?.metadata??new Map,c=o?.tags??new Map,l=o?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(s=new Set(e.protocols)),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=p2(d,{validate:AA})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=p2(d,{validate:TA,map:IA})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(s=new Set([...s,...e.protocols])),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[p,m]of d)m==null?a.delete(p):a.set(p,m);a=p2([...a.entries()],{validate:AA})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),p=new Map(c);for(let[m,g]of d)g==null?p.delete(m):p.set(m,g);c=p2([...p.entries()],{validate:TA,map:IA})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;o?.id.publicKey!=null?u=cr(o.id.publicKey):e.publicKey!=null?u=cr(e.publicKey):r.publicKey!=null&&(u=cr(r.publicKey));let f={addresses:await _A(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...s.values()].sort((d,p)=>d.localeCompare(p)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return f.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(p=>me(p.multiaddr,p.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function p2(r,e){let t=new Map;for(let[n,o]of r)o!=null&&e.validate(n,o);for(let[n,o]of r.sort(([i],[s])=>i.localeCompare(s)))o!=null&&t.set(n,e.map?.(n,o)??o);return t}function AA(r,e){if(typeof r!="string")throw new M("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new M("Metadata value must be a Uint8Array")}function TA(r,e){if(typeof r!="string")throw new M("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new M("Tag value must be an integer");if(e.value<0||e.value>100)throw new M("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new M("Tag ttl must be an integer");if(e.ttl<0)throw new M("Tag ttl must be between greater than 0")}}function IA(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));let n={value:e.value??0};return t!=null&&(n.expiry=t),n}function CA(r){let e=r.toString().split("/")[2],t=ue.parse(e,ir);return Vo(t)}function W8(r,e,t){let n=CA(r);return bA(n,e,t)}function dj(r,e){return{prefix:H8,filters:(r.filters??[]).map(t=>({key:n,value:o})=>t(W8(n,o,e))),orders:(r.orders??[]).map(t=>(n,o)=>t(W8(n.key,n.value,e),W8(o.key,o.value,e)))}}var m2=class{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=ls({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:Dd({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){let n=this.getLock(e);try{let o=await n.lock.readLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async getWriteLock(e,t){let n=this.getLock(e);try{let o=await n.lock.writeLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(kp(e),t)}async load(e,t){let n=kp(e),o=await this.datastore.get(n,t),i=gs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new qe;return sf(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){let o=await this.#e(e,n),i=await h2(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,o)}async patch(e,t,n){let o=await this.#e(e,n),i=await h2(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async merge(e,t,n){let o=await this.#e(e,n),i=await h2(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(dj(e??{},this.maxAddressAge),e)){let o=CA(t);if(o.equals(this.peerId))continue;let i=gs.decode(n);if(this.#r(o,i)){await this.datastore.delete(t,e);continue}yield sf(o,i,this.peerId.equals(o)?1/0:this.maxAddressAge)}}async#e(e,t){try{let n=kp(e),o=await this.datastore.get(n,t),i=gs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new qe;return{peerPB:i,peer:sf(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,o){t.updated=Date.now();let i=gs.encode(t);return await this.datastore.put(kp(e),i,o),{peer:sf(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!vA(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,o=Date.now()-this.maxAddressAge,i=t.addresses.filter(s=>s.observed!=null&&s.observed>o);return n&&i.length===0}};var z8=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new m2(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(let n of this.store.all(t))e(n)}async all(e){return Fc(this.store.all(e))}async delete(e,t){let n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){let n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:o})=>o)}}async save(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async patch(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async merge(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async consumePeerRecord(e,t,n){let o=Yn(t)?t:Yn(t?.expectedPeer)?t.expectedPeer:void 0,i=Yn(t)||t===void 0?n:t,s=await $n.openAndCertify(e,en.DOMAIN,i),a=Vo(s.publicKey.toCID());if(o?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",o,a),!1;let c=en.createFromProtobuf(s.payload),l;try{l=await this.get(a,i)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){let u=$n.createFromProtobuf(l.peerRecordEnvelope),f=en.createFromProtobuf(u.payload);if(f.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function PA(r,e={}){return new z8(r,e)}var kA=864e13;var pj=448,G8=449,hj=53,mj=54,yj=55,gj=56,y2=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=Gt({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){let t=this.findHost(e);for(let n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let o=Jr(n)===!0;this.mappings.set(n,{domain:e,verified:o,expires:o?kA-Date.now():0,lastVerified:o?kA-Date.now():void 0})})}remove(e){let t=this.findHost(e),n=!1;for(let[o,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",o,i.domain,new Error("where")),this.mappings.delete(o),n=n||i.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let i=e[n].multiaddr.stringTuples(),s=i[0][1];if(s!=null)for(let[a,c]of this.mappings.entries()){if(s!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:ie(`/${i.map(u=>[co(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===pj&&e[n+1]?.[0]!==G8)return e.splice(n+1,0,[G8,t]),!0;return!1}confirm(e,t){let n=this.findHost(e),o=!1;for(let[i,s]of this.mappings.entries())s.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,s.domain),o=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return o}unconfirm(e,t){let n=this.findHost(e),o=!1;for(let[i,s]of this.mappings.entries())s.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,s.domain),o=o||s.verified,s.verified=!1,s.expires=Date.now()+t);return o}findHost(e){for(let t of e.stringTuples())if(t[0]===G8||t[0]===hj||t[0]===mj||t[0]===yj||t[0]===gj)return t[1]}};var X8=4,Y8=41,Q8=6,wj=273,g2=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=Gt({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){let t=e.stringTuples();for(let n of this.mappings.values())for(let o of n)if(o.externalIp===t[0][1])return!0;return!1}add(e,t,n,o=t,i="tcp"){let s=`${e}-${t}-${i}`,a=this.mappings.get(s)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:o,externalFamily:qo(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(s,a)}remove(e){let t=e.stringTuples(),n=t[0][1]??"",o=t[1][0]===Q8?"tcp":"udp",i=parseInt(t[1][1]??"0"),s=!1;for(let[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===n&&u.externalPort===i&&u.protocol===o&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,i,o),s=s||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return s}getAll(e){let t=[];for(let{multiaddr:n}of e){let o=n.stringTuples(),i;if((o[0][0]===X8||o[0][0]===Y8)&&o[1][0]===Q8?i=`${o[0][1]}-${o[1][1]}-tcp`:(o[0][0]===X8||o[0][0]===Y8)&&o[1][0]===wj&&(i=`${o[0][1]}-${o[1][1]}-udp`),i==null)continue;let s=this.mappings.get(i);if(s!=null)for(let a of s)o[0][0]=a.externalFamily===4?X8:Y8,o[0][1]=a.externalIp,o[1][1]=`${a.externalPort}`,t.push({multiaddr:ie(`/${o.map(c=>[co(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){let o=e.stringTuples()[0][1],i=!1;for(let s of this.mappings.values())for(let a of s)a.externalIp===o&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){let n=e.stringTuples(),o=n[0][1]??"",i=n[1][0]===Q8?"tcp":"udp",s=parseInt(n[1][1]??"0"),a=!1;for(let c of this.mappings.values())for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===o&&u.externalPort===s&&u.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,o,s,i),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}};function OA(r){try{for(let{code:e,value:t}of r.getComponents())if(e!==42&&t!=null){if(e===4)return t.startsWith("169.254.");if(e===41)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function w2(r){try{for(let{code:e}of r.getComponents())if(e!==42)return e===4||e===41}catch{}return!1}function lo(r){try{if(!w2(r))return!1;let[[,e]]=r.stringTuples();return e==null?!1:Jr(e)??!1}catch{}return!0}var bj={maxObservedAddresses:10},b2=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Gt({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??bj.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(lo(e)||OA(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:ie(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),o=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,o),i}};var vj=[4,41,53,54,55,56];function Z8(r){try{for(let{code:e}of r.getComponents())if(e!==42)return vj.includes(e)}catch{}return!1}var xj={maxObservedAddresses:10},v2=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Gt({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??xj.maxObservedAddresses}get(e,t){if(lo(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),o=this.addresses.get(n);return o==null&&(o={verified:!Z8(e),expires:0},this.addresses.set(n,o)),{multiaddr:e,verified:o.verified,type:"transport",expires:o.expires,lastVerified:o.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.addresses.set(n,o),i}unconfirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0},i=o.verified;return o.verified=!1,o.expires=Date.now()+t,this.addresses.set(n,o),i}toKey(e){if(Z8(e)){let t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}};var RA=6e4,DA={maxObservedAddresses:10,addressVerificationTTL:RA*10,addressVerificationRetry:RA*5},Ej=r=>r;function J8(r,e){let t=r.getPeerId();return t!=null&&Ct(t).equals(e)&&(r=r.decapsulate(ie(`/p2p/${e.toString()}`))),r}var x2=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){let{listen:n=[],announce:o=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(s=>s.toString()),this.announce=new Set(o.map(s=>s.toString())),this.appendAnnounce=new Set(i.map(s=>s.toString())),this.observed=new b2(e,t),this.dnsMappings=new y2(e,t),this.ipMappings=new g2(e,t),this.transportAddresses=new v2(e,t),this.announceFilter=t.announceFilter??Ej,this.observedAddressFilter=$r(1024),this.addressVerificationTTL=t.addressVerificationTTL??DA.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??DA.addressVerificationRetry,this._updatePeerStoreAddresses=qi(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>ie(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>ie(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>ie(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=J8(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=J8(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=J8(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let o=n.multiaddr.toString();return e.has(o)?!1:(e.add(o),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let o=ie(n);return o.getComponents().pop()?.value===this.components.peerId.toString()?o:o.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(e)}),e.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(o=>this.transportAddresses.get(o,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(n)}),t=t.concat(n.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(ie(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.add(e,t,n,o,i),this.observed.removePrefixed(`/ip${qo(n)?4:6}/${n}/${i}/${o}`)}removePublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.remove(ie(`/ip${qo(n)?4:6}/${n}/${i}/${o}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;let t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||Jr(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),o=[i=>ms.exactMatch(i)||Uc.exactMatch(i),i=>Mc.exactMatch(i),i=>M_.exactMatch(i)];for(let i of o){if(!i(e))continue;let s=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&i(u)).length>0);if(s.length!==1)continue;let a=s[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;let c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}};var NA;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(NA||(NA={}));var E2=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},S2=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},af=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},Op=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},_2=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},A2=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},T2=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},Rp=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},I2=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},C2=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},P2=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},k2=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},O2=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},$c=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},Vc=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},R2=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}},D2=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}};var e7=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Ws())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>k1(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},_j=["metrics","connectionProtector","dns"],Aj=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function LA(r={}){let e=new e7(r);return new Proxy(e,{get(n,o,i){if(typeof o=="string"&&!Aj.includes(o)){let s=e.components[o];if(s==null&&!_j.includes(o))throw new E2(`${o} not set`);return s}return Reflect.get(n,o,i)},set(n,o,i){return typeof o=="string"?e.components[o]=i:Reflect.set(n,o,i),!0}})}function BA(r){let e={};for(let t of Object.values(r.components))for(let n of Tj(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of Ij(t))if(e[n]!==!0)throw new S2(`Service "${Cj(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function Tj(r){return Array.isArray(r?.[He])?r[He]:[]}function Ij(r){return Array.isArray(r?.[In])?r[In]:[]}function Cj(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}var Pj=4,kj=41;function MA(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(ms.matches(e))return!1;let t=e.stringTuples();return t[0][0]===Pj||t[0][0]===kj?!!Jr(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var UA=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},Oj=new WeakMap;function Rj({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:o}={})=>{if(o?.aborted)return Promise.reject(UA());let i,s,a,c=r??clearTimeout,l=()=>{c(i),a(UA())},u=()=>{o&&o.removeEventListener("abort",l)},f=new Promise((d,p)=>{s=()=>{u(),d(n)},a=p,i=(e??setTimeout)(s,t)});return o&&o.addEventListener("abort",l,{once:!0}),Oj.set(f,()=>{c(i),i=null,s()}),f}}var Dj=Rj(),N2=Dj;var cf=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new t7}async consume(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(o,s.consumedPoints,this.blockDuration)),new q1("Rate limit exceeded",s);if(this.execEvenly&&s.msBeforeNext>0&&!s.isFirstInDuration){let a=Math.ceil(s.msBeforeNext/(s.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=s.consumedPoints*this.execEvenlyMinDelayMs),await N2(a)}return s}penalty(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,-t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let n=t*1e3,o=this.points+1;return this.memoryStorage.set(this.getKey(e),o,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:o,isFirstInDuration:!1}}set(e,t,n=0){let o=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},t7=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let o=this.storage.get(e);if(o!=null){let i=o.expiresAt!=null?o.expiresAt.getTime()-new Date().getTime():-1;return o.expiresAt==null||i>0?(o.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:o.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let o=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);let s={value:t,expiresAt:o>0?new Date(Date.now()+o):void 0};return this.storage.set(e,s),o>0&&(s.timeoutId=setTimeout(()=>{this.storage.delete(e)},o),s.timeoutId.unref!=null&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function L2(r){if(Yn(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getPeerId();t=n==null?void 0:Ct(n),e.forEach(o=>{if(!aa(o))throw new $s("Invalid multiaddr");let i=o.getPeerId();if(i==null){if(t!=null)throw new M("Multiaddrs must all have the same peer id or have no peer id")}else{let s=Ct(i);if(t?.equals(s)!==!0)throw new M("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!R_.exactMatch(n)),{peerId:t,multiaddrs:e}}var Nj=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function FA(r,e){let t=r?.streams?.map(o=>o.protocol)??[],n=e?.closableProtocols??Nj;if(!(t.filter(o=>o!=null&&!n.includes(o)).length>0))try{await r?.close(e)}catch(o){r?.abort(o)}}function Dp(r){try{let e;typeof r=="string"?e=ie(r):e=r;let t=new Set([...e.getComponents().map(n=>n.name)]);if(!t.has("ipcidr")){let o=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(o)}return g8(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}var B2=class{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Dp(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;let o=new Vr;for(let c of e){let l=c.remotePeer;if(!o.has(l)){o.set(l,0);try{let u=await this.peerStore.get(l);o.set(l,[...u.tags.values()].reduce((f,d)=>f+d.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}let i=this.sortConnections(e,o),s=Math.max(t-n,0),a=[];for(let c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>u.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===s)break;await Promise.all(a.map(async c=>{await FA(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,o)=>{let i=n.timeline.open,s=o.timeline.open;return i<s?1:i>s?-1:0}).sort((n,o)=>n.direction==="outbound"&&o.direction==="inbound"?1:n.direction==="inbound"&&o.direction==="outbound"?-1:0).sort((n,o)=>n.streams.length>o.streams.length?1:n.streams.length<o.streams.length?-1:0).sort((n,o)=>{let i=t.get(n.remotePeer)??0,s=t.get(o.remotePeer)??0;return i>s?1:i<s?-1:0})}};var jA="last-dial-failure",KA="last-dial-success";var $A=100,M2=50;var U2=class extends hr{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};function VA(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function r7(r){if(!w2(r))return!1;let{address:e}=r.nodeAddress();return VA(e)}function Lj(r,e){let t=Mc.exactMatch(r.multiaddr),n=Mc.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let o=Uc.exactMatch(r.multiaddr),i=Uc.exactMatch(e.multiaddr);if(o&&!i)return-1;if(!o&&i)return 1;let s=ms.exactMatch(r.multiaddr),a=ms.exactMatch(e.multiaddr);if(s&&!a)return-1;if(!s&&a)return 1;let c=Ep.exactMatch(r.multiaddr),l=Ep.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let u=xp.exactMatch(r.multiaddr),f=xp.exactMatch(e.multiaddr);if(u&&!f)return-1;if(!u&&f)return 1;let d=T8.exactMatch(r.multiaddr),p=T8.exactMatch(e.multiaddr);return d&&!p?-1:!d&&p?1:0}function Bj(r,e){let t=r7(r.multiaddr),n=r7(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function Mj(r,e){let t=lo(r.multiaddr),n=lo(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function Uj(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function Fj(r,e){let t=fn.exactMatch(r.multiaddr),n=fn.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function qA(r){return r.sort(Lj).sort(Uj).sort(Fj).sort(Mj).sort(Bj)}async function n7(r,e,t){let n=t.depth??0;if(n>(t.maxRecursiveDepth??32))throw new D2("Max recursive depth reached");let o=!1,i=[];for(let s of Object.values(e))if(s.canResolve(r)){o=!0;let a=await s.resolve(r,t);for(let c of a)i.push(...await n7(c,e,{...t,depth:n+1}))}return o===!1&&i.push(r),i}var Np={maxParallelDials:M2,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:Kc}},F2=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Np.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Np.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Np.dialTimeout,this.connections=t.connections??new Vr,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Np.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new U2({concurrency:t.maxParallelDials??Np.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==rr.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:o}=L2(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0||a.limits!=null?!1:a.remotePeer.equals(n)?!0:o.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new ce("dial-queue:already-connected")),i;let s=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let l of o)if(c.has(l.toString()))return!0;return!1});if(s!=null){this.log("joining existing dial target for %p",n);for(let a of o)s.options.multiaddrs.add(a.toString());return t.onProgress?.(new ce("dial-queue:already-in-dial-queue")),s.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new $i("Dial queue is full");return this.log("creating dial target for %p",n,o.map(a=>a.toString())),t.onProgress?.(new ce("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new ce("dial-queue:start-dial"));let c=Oe([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??a7,multiaddrs:new Set(o.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,o=e.multiaddrs,i=new Set,s=e.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);s||o.size>0;){c++,s=!1;let u=[],f=new Set(e.multiaddrs);o.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let d=await this.calculateMultiaddrs(n,f,{...e,signal:t});for(let p of d){if(i.has(p.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",p.multiaddr,n);continue}u.push(p)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(p=>p.multiaddr.toString())),e?.onProgress?.(new ce("dial-queue:calculated-addresses",u));for(let p of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new $i("Peer had more than maxPeerAddrsToDial");a++;try{let m=await this.components.transportManager.dial(p.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",p.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[KA]:q(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}return m}catch(m){if(this.log.error("dial failed to %a",p.multiaddr,m),i.add(p.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[jA]:q(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}if(t.aborted)throw new Qn(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let o=[...t].map(f=>({multiaddr:ie(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new $i("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Rp("The dial request is blocked by gater.allowDialPeer");if(o.length===0){this.log("loading multiaddrs for %p",e);try{let f=await this.components.peerStore.get(e);o.push(...f.addresses),this.log("loaded multiaddrs for %p",e,o.map(({multiaddr:d})=>d.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(o.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let f=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,o.map(({multiaddr:d})=>d.toString())),o.push(...f.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,f)}}}let i=(await Promise.all(o.map(async f=>{let d=await n7(f.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(f.multiaddr)?f:d.map(p=>({multiaddr:p,isCertified:!1}))}))).flat();if(e!=null){let f=`/p2p/${e.toString()}`;i=i.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(f),isCertified:d.isCertified}:d)}let s=i.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let d=f.multiaddr.getPeerId();return e!=null&&d!=null?e.equals(d):!0}),a=new Map;for(let f of s){let d=f.multiaddr.toString(),p=a.get(d);if(p!=null){p.isCertified=p.isCertified||f.isCertified||!1;continue}a.set(d,f)}let c=[...a.values()];if(c.length===0)throw new P2("The dial request has no valid addresses");let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=this.addressSorter==null?qA(l):l.sort(this.addressSorter);if(u.length===0)throw new Rp("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(o=>o.toString())),t);return t.runOnLimitedConnection===!1?n.find(o=>!fn.matches(o.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}};var QA=tr(XA(),1);var Kj=Object.prototype.toString,$j=r=>Kj.call(r)==="[object Error]",Vj=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function c7(r){return r&&$j(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:Vj.has(r.message):!1}var l7=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},YA=(r,e,t)=>{let n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function u7(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;let o=QA.default.operation(e),i=()=>{o.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});let s=()=>{e.signal?.removeEventListener("abort",i),o.stop()};o.attempt(async a=>{try{let c=await r(a);s(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof l7)throw c.originalError;if(c instanceof TypeError&&!c7(c))throw c;if(YA(c,a,e),await e.shouldRetry(c)||(o.stop(),n(c)),await e.onFailedAttempt(c),!o.retry(c))throw o.mainError()}catch(l){YA(l,a,e),s(),n(l)}}})})}var j2=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new yr({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(o=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,o)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);ZA(t)&&(this.queue.has(e)||this.queue.add(async n=>{await u7(async o=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,o,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let o={};[...t.tags.keys()].forEach(i=>{i.startsWith(js)&&(o[i]=void 0)}),await this.peerStore.merge(e,{tags:o}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>ZA(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}};function ZA(r){for(let e of r.tags.keys())if(e.startsWith(js))return!0;return!1}var a7=50,f7={maxConnections:$A,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},K2=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??f7.maxConnections,this.maxConnections<1)throw new M("Connection Manager maxConnections must be greater than 0");this.connections=new Vr,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Dp(n)),this.deny=(t.deny??[]).map(n=>Dp(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??f7.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new cf({points:t.inboundConnectionThreshold??f7.inboundConnectionThreshold,duration:1}),this.connectionPruner=new B2({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>ie(n))}),this.dialQueue=new F2(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??M2,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:Kc},connections:this.connections}),this.reconnectQueue=new j2({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let o of n.streams){let i=`${o.direction} ${o.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let o of n){let i={};for(let s of o.streams){let a=`${s.direction} ${s.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(let[s,a]of Object.entries(i))e[s]=e[s]??[],e[s].push(a)}let t={};for(let[n,o]of Object.entries(e)){o=o.sort((s,a)=>s-a);let i=Math.floor(o.length*.9);t[n]=o[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await pr(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Nr(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(o){this.log.error(o)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new M("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,o=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(s=>s.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Tn("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n}=L2(e);if(this.peerId.equals(n))throw new eu("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new ce("dial-queue:already-connected")),a}let o=await this.dialQueue.dial(e,{...t,priority:t.priority??a7});if(o.status!=="open")throw new Zl("Remote closed connection during opening");let i=this.connections.get(o.remotePeer);i==null&&(i=[],this.connections.set(o.remotePeer,i));let s=!1;for(let a of i)if(a.id===o.id&&(s=!0),t.force!==!0&&a.id!==o.id&&a.remoteAddr.equals(o.remoteAddr))return o.abort(new $s("Duplicate multiaddr connection")),a;return s||i.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async o=>{try{await o.close(t)}catch(i){o.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(o=>o.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(o=>o.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let o=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(o,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,o),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>ie(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var lf=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),o=e-this.movingAverage,i=n*o;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+o*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*o}else this.movingAverage=e;this.previousTime=t}};var Wj=1.2,zj=2,Gj=5e3,Xj=6e4,Yj=5e3,Yo=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){let t=e.interval??Yj;this.success=new lf(t),this.failure=new lf(t),this.next=new lf(t),this.failureMultiplier=e.failureMultiplier??zj,this.timeoutMultiplier=e.timeoutMultiplier??Wj,this.minTimeout=e.minTimeout??Gj,this.maxTimeout=e.maxTimeout??Xj,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);let n=AbortSignal.timeout(t),o=Oe([e.signal,n]);return o.start=Date.now(),o.timeout=t,o}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var $2=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Hc(r,e){let t=dm();r.sink(t).catch(async s=>{await t.end(s)}),r.sink=async s=>{for await(let a of s)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let o=new xe;return{read:async s=>{if(s?.signal?.throwIfAborted(),s?.bytes==null){let{done:c,value:l}=await nt(n.next(),s?.signal);return c===!0?null:l}for(;o.byteLength<s.bytes;){let{value:c,done:l}=await nt(n.next(),s?.signal);if(l===!0)throw new $2("unexpected end of input");o.append(c)}let a=o.sublist(0,s.bytes);return o.consume(s.bytes),a},write:async(s,a)=>{a?.signal?.throwIfAborted(),s instanceof Uint8Array?await t.push(s,a):await t.push(s.subarray(),a)},unwrap:()=>{if(o.byteLength>0){let s=r.source;r.source=async function*(){e?.yieldBytes===!1?yield o:yield*o,yield*s}()}return r}}}var Qj=1e4,Zj="1.0.0",Jj="ping",eK="ipfs",JA=32,tK=!0,V2=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??eK}/${Jj}/${Zj}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??Qj,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??tK,this.timeout=new Yo({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[He]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),o=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=Hc(o);t=Date.now(),await Promise.all([i.write(Zr(JA),{signal:n}),i.read({bytes:JA,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var q2=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()}),getAttributesFromYieldedValue:(n,o)=>({...o,providers:[...Array.isArray(o.providers)?o.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new af("No content routers available");let n=this,o=new jn;for await(let i of Xr(...n.routers.filter(s=>s.findProviders instanceof Function).map(s=>s.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id)&&(o.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new af("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new af("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Tn;await Promise.all(this.routers.filter(o=>o.put instanceof Function).map(async o=>{await o.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Tn;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}};var H2=globalThis.CustomEvent??Event;async function*ws(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,o=new EventTarget,i=[],s=ve(),a=ve(),c=!1,l,u=!1;o.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let m of r){if(i.length===t&&(s=ve(),await s.promise),u)break;let g={done:!1};i.push(g),m().then(y=>{g.done=!0,g.ok=!0,g.value=y,o.dispatchEvent(new H2("task-complete"))},y=>{g.done=!0,g.err=y,o.dispatchEvent(new H2("task-complete"))})}c=!0,o.dispatchEvent(new H2("task-complete"))}catch(m){l=m,o.dispatchEvent(new H2("task-complete"))}});function f(){return n?i[0]?.done:!!i.find(m=>m.done)}function*d(){for(;i.length>0&&i[0].done;){let m=i[0];if(i.shift(),m.ok)yield m.value;else throw u=!0,s.resolve(),m.err;s.resolve()}}function*p(){for(;f();)for(let m=0;m<i.length;m++)if(i[m].done){let g=i[m];if(i.splice(m,1),m--,g.ok)yield g.value;else throw u=!0,s.resolve(),g.err;s.resolve()}}for(;;){if(f()||(a=ve(),await a.promise),l!=null||(n?yield*d():yield*p(),l!=null))throw l;if(c&&i.length===0)break}}var W2=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,key:W(n,"base36")}),getAttributesFromYieldedValue:(n,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Op("No peer routers available");if(e.toString()===this.peerId.toString())throw new _2("Should not try to find self");let n=this,o=Xr(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let i of o)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new qe}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Op("No peer routers available");let n=this,o=$r(1024);for await(let i of ws(async function*(){let s=Xr(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of s)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id.toMultihash().bytes)&&(o.add(i.id.toMultihash().bytes),yield i))}};var z2=class extends De{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=Oe([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=ve(),yield(await Dt(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=Oe([this.walkController.signal,this.shutdownController.signal]);let t=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=Zr(32),i=Date.now();for await(let s of this.peerRouting.getClosestPeers(o,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await nt(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,n)}catch(o){this.log.error("random walk errored",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}};var d7=32,p7=64,G2=class{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let t={};for(let[n,o]of this.topologies)t[n]=o.size;return t}}),this.handlers=Gt({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new A2(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new T2(`Handler already registered for protocol ${e}`);let o=of.bind({ignoreUndefined:!0})({maxInboundStreams:d7,maxOutboundStreams:p7},n);this.handlers.set(e,{handler:t,options:o}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(o=>{this.handlers.delete(o)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new M("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,o=this.topologies.get(e);return o==null&&(o=new Map,this.topologies.set(e,o)),o.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(o=>{for(let i of o.protocols){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(o=>{o.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,o)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,o=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(let i of o){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,o=e.detail.peerId;for(let i of t){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(o)!==!0&&(a.filter?.add(o),a.onConnect?.(o,n))}}};var X2=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=Gt({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=Gt({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Qa.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(t==null)throw new M("Transport must have a valid tag");if(this.transports.has(t))throw new M(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let o=n.pop();o!=null&&e.push(o.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new R2(`No transport available for address ${String(e)}`);return t?.onProgress?.(new ce("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Tn("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new I2)});let n=[];for(let[i,s]of this.transports.entries()){let a=s.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",i,c);let l=s.createListener({upgrader:this.components.upgrader}),u=this.listeners.get(i)??[];u==null&&(u=[],this.listeners.set(i,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let f=u.findIndex(d=>d===l);u.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),E8.matches(c)?t.ipv4.attempts++:S8.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),E8.matches(c)&&t.ipv4.success++,S8.matches(c)&&t.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,f),t.errors.set(c.toString(),f),f}))}}let o=await Promise.allSettled(n);if(!(o.length>0&&o.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Qa.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new C2(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,s])=>`
  ${i}: ${`${s.stack??s}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let o=t.pop();o!=null&&n.push(o.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var vr="/multistream/1.0.0";var Y2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Q2=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Z2=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Si(r,e={}){let t=Hc(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ke(e.maxDataLength));let n=e?.lengthDecoder??Fo,o=e?.lengthEncoder??ur;return{read:async s=>{let a=-1,c=new xe;for(;;){c.append(await t.read({...s,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new Y2("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new Z2("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new Q2("message length too long");return t.read({...s,bytes:a})},write:async(s,a)=>{await t.write(new xe(o(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new xe(...s.flatMap(l=>[o(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}var rK=q(`
`);async function Wc(r,e,t){await r.write(e,t)}async function eT(r,e,t){await r.writeV(e,t)}async function nK(r,e){let t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==rK[0])throw e.log.error("Invalid mss message - missing newline",t),new Be("Missing newline");return t.sublist(0,-1)}async function la(r,e){let t=await nK(r,e);return W(t.subarray())}async function Lp(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return oK(r,e[0],t);let n=Si(r,{...t,maxDataLength:1024}),o=e.shift();if(o==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',vr,o);let i=q(`${vr}
`),s=q(`${o}
`);await eT(n,[i,s],t),t.log.trace("select: reading multistream-select header");let a=await la(n,t);if(t.log.trace('select: read "%s"',a),a===vr&&(t.log.trace("select: reading protocol response"),a=await la(n,t),t.log.trace('select: read "%s"',a)),a===o)return{stream:n.unwrap(),protocol:o};for(let c of e){t.log.trace('select: write "%s"',c),await Wc(n,q(`${c}
`),t),t.log.trace("select: reading protocol response");let l=await la(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new Ki("protocol selection failed")}function oK(r,e,t){let n=r.sink.bind(r),o=r.source,i=!1,s=!1,a=ve(),c=!1,l=!1,u=ve(),f=!1,d=!1,p=ve(),m=Si({sink:n,source:o},{...t,maxDataLength:1024});r.sink=async C=>{let{sink:D}=m.unwrap();await D(async function*(){let U=!1;for await(let X of C){if(l&&await u.promise,c)yield X;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',vr,e,X.byteLength);let K=`${e}
`;yield new xe(Uint8Array.from([19]),q(`${vr}
`),ur(K.length),q(K),X).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',vr,e,X.byteLength),c=!0,l=!1,u.resolve(),g().catch(ee=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,ee)})}U=!0}U||await g()}())};async function g(){if(s){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}s=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await y()),f||(t.log.trace("optimistic: doing read protocol for %s stream",e),await b())}finally{s=!1,i=!0,a.resolve()}}async function y(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',vr,e),await m.writeV([q(`${vr}
`),q(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',vr,e)}finally{c=!0,l=!1,u.resolve()}}async function b(){if(d){await p.promise;return}d=!0;try{t.log.trace("optimistic: reading multistream select header");let C=await la(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',C),C===vr&&(C=await la(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',C,e),C!==e)throw new Ki("protocol selection failed")}finally{f=!0,d=!1,p.resolve()}}if(r.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source}(),r.closeRead!=null){let C=r.closeRead.bind(r);r.closeRead=async D=>{i||await g().catch(U=>{t.log.error("could not negotiate protocol before close read",U)}),await C(D)}}if(r.closeWrite!=null){let C=r.closeWrite.bind(r);r.closeWrite=async D=>{i||await g().catch(U=>{t.log.error("could not negotiate protocol before close write",U)}),await C(D)}}if(r.close!=null){let C=r.close.bind(r);r.close=async D=>{let U=[];l&&U.push(u.promise),d&&U.push(p.promise),U.length>0?await nt(Promise.all(U),D?.signal):(i=!0,s=!1,a.resolve()),await C(D)}}return{stream:r,protocol:e}}async function Bp(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);let n=Si(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");let o=await la(n,t);if(t.log.trace('handle: read "%s"',o),o===vr){t.log.trace('handle: respond with "%s" for "%s"',vr,o),await Wc(n,q(`${vr}
`),t),t.log.trace('handle: responded with "%s" for "%s"',vr,o);continue}if(e.includes(o))return t.log.trace('handle: respond with "%s" for "%s"',o,o),await Wc(n,q(`${o}
`),t),t.log.trace('handle: responded with "%s" for "%s"',o,o),{stream:n.unwrap(),protocol:o};if(o==="ls"){let i=new xe(...e.map(s=>as.single(q(`${s}
`))),q(`
`));t.log.trace('handle: respond with "%s" for %s',e,o),await Wc(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,o);continue}t.log.trace('handle: respond with "na" for "%s"',o),await Wc(n,q(`na
`),t),t.log('handle: responded with "na" for "%s"',o)}}var sK=500,m7=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:o,close:i,abort:s,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=o,this._close=i,this._abort=s,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[Lb]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new A1("the connection is being closed");if(this.status==="closed")throw new Zl("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new tu("Cannot open protocol stream on limited connection");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){let t=AbortSignal.timeout(sK);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}};function rT(r){return new m7(r)}function cK(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return d7}function lK(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??p7}function nT(r,e,t){let n=0;return t.streams.forEach(o=>{o.direction===e&&o.protocol===r&&n++}),n}var J2=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=Gt({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=Gt({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new k2(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=Oe([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,o=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await nt(this.components.connectionManager.acceptIncomingConnection(e),o),!n)throw new O2("Connection denied");await nt(this.shouldBlockConnection("denyInboundConnection",e),o),await this._performUpgrade(e,"inbound",{...t,signal:o})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{o.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getPeerId(),o;n!=null&&(o=Ct(n),await nt(this.shouldBlockConnection("denyOutboundConnection",o,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let o,i,s,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if(n?.skipProtection!==!0){let u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),l=await u.protect(e,n))}try{if(o=l,n?.skipEncryption!==!0){n?.onProgress?.(new ce(`upgrader:encrypt-${t}-connection`)),{conn:o,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));let u={...l,...o};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,u)}else{let u=e.remoteAddr.getPeerId();if(u==null)throw new $s(`${t} connection that skipped encryption must have a peer id`);let f=Ct(u);c="native",i=f}if(i.equals(this.components.peerId)){let u=new eu("Can not dial self");throw e.abort(u),u}if(s=o,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new ce(`upgrader:multiplex-${t}-connection`));let u=await(t==="inbound"?this._multiplexInbound({...l,...o},this.streamMuxers,n):this._multiplexOutbound({...l,...o},this.streamMuxers,n));a=u.muxerFactory,s=u.stream}}catch(u){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,u),u}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:s,muxerFactory:a,remotePeer:i,limits:n?.limits})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:o,upgradedConn:i,remotePeer:s,muxerFactory:a,limits:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:m=>{if(f==null)return;let g=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{let y=this.components.registrar.getProtocols(),{stream:b,protocol:C}=await Bp(m,y,{signal:g,log:m.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",C);let D=cK(C,this.components.registrar);if(nT(C,"inbound",f)===D){let X=new P1(`Too many inbound protocol streams for protocol "${C}" - limit ${D}`);throw m.abort(X),X}m.source=b.source,m.sink=b.sink,m.protocol=C,b.closeWrite!=null&&(m.closeWrite=b.closeWrite),b.closeRead!=null&&(m.closeRead=b.closeRead),b.close!=null&&(m.close=b.close),await this.components.peerStore.merge(s,{protocols:[C]},{signal:g}),this.components.metrics?.trackProtocolStream(m,f),this._onStream({connection:f,stream:m,protocol:C})}).catch(async y=>{f.log.error("error handling incoming stream id %s - %e",m.id,y),m.timeline.close==null&&await m.close({signal:g}).catch(b=>m.abort(b))})}}),u=async(m,g={})=>{if(l==null)throw new $c("Connection is not multiplexed");f.log.trace("starting new stream for protocols %s",m);let y=await l.newStream();f.log.trace("started new stream %s for protocols %s",y.id,m);try{if(g.signal==null){y.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",m);let X=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:X}}y.log.trace("selecting protocol from protocols %s",m);let{stream:b,protocol:C}=await Lp(y,m,{...g,log:y.log,yieldBytes:!0});y.log.trace("selected protocol %s",C);let D=lK(C,this.components.registrar,g),U=nT(C,"outbound",f);if(U>=D){let X=new qs(`Too many outbound protocol streams for protocol "${C}" - ${U}/${D}`);throw y.abort(X),X}return await this.components.peerStore.merge(s,{protocols:[C]}),y.source=b.source,y.sink=b.sink,y.protocol=C,b.closeWrite!=null&&(y.closeWrite=b.closeWrite),b.closeRead!=null&&(y.closeRead=b.closeRead),b.close!=null&&(y.close=b.close),this.components.metrics?.trackProtocolStream(y,f),y}catch(b){throw f.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,m,b),y.timeline.close==null&&y.abort(b),b}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(m=>{f.log.error("error piping data through muxer - %e",m)}));let d=o.timeline;o.timeline=new Proxy(d,{set:(...m)=>(m[1]==="close"&&m[2]!=null&&d.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(g){f.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(g=>{f.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...m))}),o.timeline.upgraded=Date.now();let p=()=>{throw new $c("Connection is not multiplexed")};return f=rT({remoteAddr:o.remoteAddr,remotePeer:s,status:"open",direction:n,timeline:o.timeline,multiplexer:l?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??p,getStreams:()=>l?.streams??[],close:async m=>{await l?.close(m),await o.close(m)},abort:m=>{o.abort(m),l?.abort(m)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f.__maConnTimeline=d,f}_onStream(e){let{connection:t,stream:n,protocol:o}=e,{handler:i,options:s}=this.components.registrar.getHandler(o);if(t.limits!=null&&s.runOnLimitedConnection!==!0)throw new tu("Cannot open protocol stream on limited connection");i({connection:t,stream:n})}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let{stream:o,protocol:i}=await Bp(e,n,{...t,log:e.log}),s=this.connectionEncrypters.get(i);if(s==null)throw new Vc(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await s.secureInbound(o,t),protocol:i}}catch(o){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,o),new Vc(o.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let{stream:o,protocol:i}=await Lp(e,n,{...t,log:e.log,yieldBytes:!0}),s=this.connectionEncrypters.get(i);if(s==null)throw new Vc(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await s.secureOutbound(o,t),protocol:i}}catch(o){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,o),new Vc(o.message)}}async _multiplexOutbound(e,t,n){let o=Array.from(t.keys());e.log("outbound selecting muxer %s",o);try{e.log.trace("selecting stream muxer from %s",o);let{stream:i,protocol:s}=await Lp(e,o,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",s);let a=t.get(s);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new $c(String(i))}}async _multiplexInbound(e,t,n){let o=Array.from(t.keys());e.log("inbound handling muxers %s",o);try{let{stream:i,protocol:s}=await Bp(e,o,{...n,log:e.log}),a=t.get(s);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new $c(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};var ey="2.9.0",ty="js-libp2p";function ry(r,e){return`${r??ty}/${e??ey} browser/${globalThis.navigator.userAgent}`}var Mp=class extends De{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new De,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{let u=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||f},this.peerId=e.peerId,this.logger=e.logger??Ws(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=e.nodeInfo?.name??ty,i=e.nodeInfo?.version??ey,s=this.components=LA({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:o,version:i,userAgent:e.nodeInfo?.userAgent??ry(o,i)},logger:this.logger,events:t,datastore:e.datastore??new jc,connectionGater:MA(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",PA(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),s.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new J2(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new X2(this.components,e.transportManager)),this.configureComponent("connectionManager",new K2(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new V2(this.components,e.connectionMonitor)),this.configureComponent("registrar",new G2(this.components)),this.configureComponent("addressManager",new x2(this.components,e.addresses));let a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new W2(this.components,{routers:a}));let c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new q2(this.components,{routers:c})),this.configureComponent("randomWalk",new z2(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",d=>{this.#e(d)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(let l of Object.keys(e.services)){let u=e.services[l],f=u(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[ui]!=null&&(this.log("registering service %s for content routing",l),c.push(f[ui])),f[fi]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[fi])),f[Ya]!=null&&(this.log("registering service %s for peer discovery",l),f[Ya].addEventListener?.("peer",d=>{this.#e(d)}))}BA(s)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new jn;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new M("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new M("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){aa(e)&&(e=Ct(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let s=await this.peerStore.get(e,t);if(s.id.publicKey!=null)return s.id.publicKey}catch(s){if(s.name!=="NotFoundError")throw s}let n=St([q("/pk/"),e.toMultihash().bytes]),o=await this.contentRouting.get(n,t),i=jt(o);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async o=>{await this.components.registrar.handle(o,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}};async function iT(r={}){r.privateKey??=await Fu("Ed25519");let e=new Mp({...await hA(r),peerId:e_(r.privateKey)});return r.start!==!1&&await e.start(),e}var uK=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function sT(r){return r==null?!1:r instanceof Mp?!0:uK.every(e=>typeof r[e]=="function")}var oI=tr(mT(),1);var uf={};kt(uf,{create:()=>SK,derivedEmptyPasswordKey:()=>ny});var ny={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function SK(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,o=r?.digest??"SHA-256",i=r?.saltLength??16,s=r?.iterations??32767,a=Wt.get();t*=8;async function c(f,d){let p=a.getRandomValues(new Uint8Array(i)),m=a.getRandomValues(new Uint8Array(n)),g={name:e,iv:m};typeof d=="string"&&(d=q(d));let y;if(d.length===0){y=await a.subtle.importKey("jwk",ny,{name:"AES-GCM"},!0,["encrypt"]);try{let C={name:"PBKDF2",salt:p,iterations:s,hash:{name:o}},D=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(C,D,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",ny,{name:"AES-GCM"},!0,["encrypt"])}}else{let C={name:"PBKDF2",salt:p,iterations:s,hash:{name:o}},D=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(C,D,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(g,y,f);return St([p,g.iv,new Uint8Array(b)])}async function l(f,d){let p=f.subarray(0,i),m=f.subarray(i,i+n),g=f.subarray(i+n),y={name:e,iv:m};typeof d=="string"&&(d=q(d));let b;if(d.length===0)try{let D={name:"PBKDF2",salt:p,iterations:s,hash:{name:o}},U=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(D,U,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",ny,{name:"AES-GCM"},!0,["decrypt"])}else{let D={name:"PBKDF2",salt:p,iterations:s,hash:{name:o}},U=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(D,U,{name:e,length:t},!0,["decrypt"])}let C=await a.subtle.decrypt(y,b,g);return new Uint8Array(C)}return{encrypt:c,decrypt:l}}var ho={};kt(ho,{Any:()=>Ai,BaseBlock:()=>Qt,BaseStringBlock:()=>Kp,BitString:()=>Qo,BmpString:()=>Yc,Boolean:()=>Gc,CharacterString:()=>il,Choice:()=>pf,Constructed:()=>Zt,DATE:()=>zp,DateTime:()=>Xp,Duration:()=>Yp,EndOfContent:()=>$p,Enumerated:()=>Xc,GeneralString:()=>ol,GeneralizedTime:()=>sl,GraphicString:()=>nl,HexBlock:()=>Ti,IA5String:()=>rl,Integer:()=>Vn,Null:()=>mn,NumericString:()=>Zc,ObjectIdentifier:()=>qn,OctetString:()=>Hr,Primitive:()=>Ss,PrintableString:()=>Jc,RawData:()=>b7,RelativeObjectIdentifier:()=>Wp,Repeated:()=>al,Sequence:()=>ht,Set:()=>tn,TIME:()=>Qp,TeletexString:()=>el,TimeOfDay:()=>Gp,UTCTime:()=>da,UniversalString:()=>Qc,Utf8String:()=>po,ValueBlock:()=>xr,VideotexString:()=>tl,ViewWriter:()=>df,VisibleString:()=>fa,compareSchema:()=>xs,fromBER:()=>Hn,verifySchema:()=>qK});var Me=tr(vs());function zc(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function ua(r,e,t=-1){let n=t,o=r,i=0,s=Math.pow(2,e);for(let a=1;a<8;a++){if(r<s){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}let l=new Uint8Array(c);for(let u=a-1;u>=0;u--){let f=Math.pow(2,u*e);l[i-u-1]=Math.floor(o/f),o-=l[i-u-1]*f}return c}s*=Math.pow(2,e)}return new ArrayBuffer(0)}function sy(...r){let e=0,t=0;for(let i of r)e+=i.length;let n=new ArrayBuffer(e),o=new Uint8Array(n);for(let i of r)o.set(i,t),t+=i.length;return o}function g7(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=zc(t,8),o=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(o);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,zc(i,8)-n}function yT(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let s=t-e,a=ua(s,8,n),c=new Uint8Array(a);return c[0]|=128,a}let o=ua(e,8,n),i=new Uint8Array(o);if(i[0]&128){let s=o.slice(0),a=new Uint8Array(s);o=new ArrayBuffer(o.byteLength+1),i=new Uint8Array(o);for(let c=0;c<s.byteLength;c++)i[c+1]=a[c];i[0]=0}return o}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function gT(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<t.length;o++)if(t[o]!==n[o])return!1;return!0}function pn(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,o=new Array(n);for(let s=0;s<n;s++)o[s]="0";return o.join("").concat(t)}var rme=Math.log(2);function ay(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function v7(r){let e=0,t=0;for(let o=0;o<r.length;o++){let i=r[o];e+=i.byteLength}let n=new Uint8Array(e);for(let o=0;o<r.length;o++){let i=r[o];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function _s(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var df=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return v7(this.items)}},Up=[new Uint8Array([1])],wT="0123456789",w7="name",bT="valueHexView",RK="isHexOnly",DK="idBlock",NK="tagClass",LK="tagNumber",BK="isConstructed",MK="fromBER",UK="toBER",FK="local",hn="",Zo=new ArrayBuffer(0),Ey=new Uint8Array(0),jp="EndOfContent",xT="OCTET STRING",ET="BIT STRING";function Ti(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var o;super(...n);let i=n[0]||{};this.isHexOnly=(o=i.isHexOnly)!==null&&o!==void 0?o:!1,this.valueHexView=i.valueHex?Me.BufferSourceConverter.toUint8Array(i.valueHex):Ey}fromBER(n,o,i){let s=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!_s(this,s,o,i))return-1;let a=o+i;return this.valueHexView=s.subarray(o,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),o)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Zo)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Me.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var Es=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=hn,warnings:n=[],valueBeforeDecode:o=Ey}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Me.BufferSourceConverter.toUint8Array(o)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Me.Convert.ToHex(this.valueBeforeDecodeView)}}};Es.NAME="baseBlock";var xr=class extends Es{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};xr.NAME="valueBlock";var cy=class extends Ti(Es){constructor({idBlock:e={}}={}){var t,n,o,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Me.BufferSourceConverter.toUint8Array(e.valueHex):Ey,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(o=e.tagNumber)!==null&&o!==void 0?o:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Zo}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let o=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,o[0]=t}return o.buffer}if(!this.isHexOnly){let o=ua(this.tagNumber,7),i=new Uint8Array(o),s=o.byteLength,a=new Uint8Array(s+1);if(a[0]=t|31,!e){for(let c=0;c<s-1;c++)a[c+1]=i[c]|128;a[s]=i[s-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let o=this.valueHexView;for(let i=0;i<o.length-1;i++)n[i+1]=o[i]|128;n[this.valueHexView.byteLength]=o[o.length-1]}return n.buffer}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;let a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;let d=new Uint8Array(u);for(let p=0;p<l.length;p++)d[p]=l[p];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;let f=new Uint8Array(c);for(let d=0;d<c;d++)f[d]=l[d];l=this.valueHexView=new Uint8Array(c),l.set(f),this.blockLength<=9?this.tagNumber=zc(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};cy.NAME="identificationBlock";var ly=class extends Es{constructor({lenBlock:e={}}={}){var t,n,o;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(o=e.length)!==null&&o!==void 0?o:0}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;let s=i[0]&127;if(s>8)return this.error="Too big integer",-1;if(s+1>i.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=o.subarray(a,a+s);return c[s-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=zc(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let o=ua(this.length,8);if(o.byteLength>127)return this.error="Too big length",Zo;if(t=new ArrayBuffer(o.byteLength+1),e)return t;let i=new Uint8Array(o);n=new Uint8Array(t),n[0]=o.byteLength|128;for(let s=0;s<o.byteLength;s++)n[s+1]=i[s];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};ly.NAME="lengthBlock";var le={},Qt=class extends Es{constructor({name:e=hn,optional:t=!1,primitiveSchema:n,...o}={},i){super(o),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new cy(o),this.lenBlock=new ly(o),this.valueBlock=i?new i(o):new xr(o)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}toBER(e,t){let n=t||new df;t||ST(this);let o=this.idBlock.toBER(e);if(n.write(o),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;let s=this.lenBlock.toBER(e);n.write(s),n.write(i)}return t?Zo:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Me.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=Me.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return gT(t,n)}};Qt.NAME="BaseBlock";function ST(r){var e;if(r instanceof le.Constructed)for(let t of r.valueBlock.value)ST(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var Kp=class extends Qt{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=hn,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};Kp.NAME="BaseStringBlock";var uy=class extends Ti(xr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};uy.NAME="PrimitiveValueBlock";var _T,Ss=class extends Qt{constructor(e={}){super(e,uy),this.idBlock.isConstructed=!1}};_T=Ss;le.Primitive=_T;Ss.NAME="PRIMITIVE";function jK(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function hf(r,e=0,t=r.length){let n=e,o=new Qt({},xr),i=new Es;if(!_s(i,r,e,t))return o.error=i.error,{offset:-1,result:o};if(!r.subarray(e,e+t).length)return o.error="Zero buffer length",{offset:-1,result:o};let a=o.idBlock.fromBER(r,e,t);if(o.idBlock.warnings.length&&o.warnings.concat(o.idBlock.warnings),a===-1)return o.error=o.idBlock.error,{offset:-1,result:o};if(e=a,t-=o.idBlock.blockLength,a=o.lenBlock.fromBER(r,e,t),o.lenBlock.warnings.length&&o.warnings.concat(o.lenBlock.warnings),a===-1)return o.error=o.lenBlock.error,{offset:-1,result:o};if(e=a,t-=o.lenBlock.blockLength,!o.idBlock.isConstructed&&o.lenBlock.isIndefiniteForm)return o.error="Indefinite length form used for primitive encoding form",{offset:-1,result:o};let c=Qt;switch(o.idBlock.tagClass){case 1:if(o.idBlock.tagNumber>=37&&o.idBlock.isHexOnly===!1)return o.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:o};switch(o.idBlock.tagNumber){case 0:if(o.idBlock.isConstructed&&o.lenBlock.length>0)return o.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:o};c=le.EndOfContent;break;case 1:c=le.Boolean;break;case 2:c=le.Integer;break;case 3:c=le.BitString;break;case 4:c=le.OctetString;break;case 5:c=le.Null;break;case 6:c=le.ObjectIdentifier;break;case 10:c=le.Enumerated;break;case 12:c=le.Utf8String;break;case 13:c=le.RelativeObjectIdentifier;break;case 14:c=le.TIME;break;case 15:return o.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:o};case 16:c=le.Sequence;break;case 17:c=le.Set;break;case 18:c=le.NumericString;break;case 19:c=le.PrintableString;break;case 20:c=le.TeletexString;break;case 21:c=le.VideotexString;break;case 22:c=le.IA5String;break;case 23:c=le.UTCTime;break;case 24:c=le.GeneralizedTime;break;case 25:c=le.GraphicString;break;case 26:c=le.VisibleString;break;case 27:c=le.GeneralString;break;case 28:c=le.UniversalString;break;case 29:c=le.CharacterString;break;case 30:c=le.BmpString;break;case 31:c=le.DATE;break;case 32:c=le.TimeOfDay;break;case 33:c=le.DateTime;break;case 34:c=le.Duration;break;default:{let l=o.idBlock.isConstructed?new le.Constructed:new le.Primitive;l.idBlock=o.idBlock,l.lenBlock=o.lenBlock,l.warnings=o.warnings,o=l}}break;case 2:case 3:case 4:default:c=o.idBlock.isConstructed?le.Constructed:le.Primitive}return o=jK(o,c),a=o.fromBER(r,e,o.lenBlock.isIndefiniteForm?t:o.lenBlock.length),o.valueBeforeDecodeView=r.subarray(n,n+o.blockLength),{offset:a,result:o}}function Hn(r){if(!r.byteLength){let e=new Qt({},xr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return hf(Me.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function KK(r,e){return r?1:e}var _i=class extends xr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,o,t,n))return-1;if(this.valueBeforeDecodeView=o.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;KK(this.isIndefiniteForm,n)>0;){let s=hf(o,i,n);if(s.offset===-1)return this.error=s.result.error,this.warnings.concat(s.result.warnings),-1;if(i=s.offset,this.blockLength+=s.result.blockLength,n-=s.result.blockLength,this.value.push(s.result),this.isIndefiniteForm&&s.result.constructor.NAME===jp)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===jp?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){let n=t||new df;for(let o=0;o<this.value.length;o++)this.value[o].toBER(e,n);return t?Zo:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};_i.NAME="ConstructedValueBlock";var AT,Zt=class extends Qt{constructor(e={}){super(e,_i),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(o=>`  ${o}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};AT=Zt;le.Constructed=AT;Zt.NAME="CONSTRUCTED";var fy=class extends xr{fromBER(e,t,n){return t}toBER(e){return Zo}};fy.override="EndOfContentValueBlock";var TT,$p=class extends Qt{constructor(e={}){super(e,fy),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};TT=$p;le.EndOfContent=TT;$p.NAME=jp;var IT,mn=class extends Qt{constructor(e={}){super(e,xr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let o=new Uint8Array(n);o[0]=5,o[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};IT=mn;le.Null=IT;mn.NAME="NULL";var dy=class extends Ti(xr){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Me.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);return _s(this,o,t,n)?(this.valueHexView=o.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,g7.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};dy.NAME="BooleanValueBlock";var CT,Gc=class extends Qt{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,dy),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};CT=Gc;le.Boolean=CT;Gc.NAME="BOOLEAN";var py=class extends Ti(_i){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let o=0;if(this.isConstructed){if(this.isHexOnly=!1,o=_i.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let i=0;i<this.value.length;i++){let s=this.value[i].constructor.NAME;if(s===jp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(s!==xT)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,o=super.fromBER(e,t,n),this.blockLength=n;return o}toBER(e,t){return this.isConstructed?_i.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};py.NAME="OctetStringValueBlock";var x7,Hr=class extends Qt{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},py),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){let s=hf(i,0,i.byteLength);s.offset!==-1&&s.offset===n&&(this.valueBlock.value=[s.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Zt.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=Me.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof x7&&e.push(t.valueBlock.valueHexView);return Me.BufferSourceConverter.concat(e)}};x7=Hr;le.OctetString=x7;Hr.NAME=xT;var hy=class extends Ti(_i){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let o=-1;if(this.isConstructed){if(o=_i.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let a of this.value){let c=a.constructor.NAME;if(c===jp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==ET)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return o}let i=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,i,t,n))return-1;let s=i.subarray(t,t+n);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=s.subarray(1);try{if(a.byteLength){let c=hf(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+n}toBER(e,t){if(this.isConstructed)return _i.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Zo;let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};hy.NAME="BitStringValueBlock";var PT,Qo=class extends Qt{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},hy),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Zt.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join(""),o=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${o} : ${i}`}}};PT=Qo;le.BitString=PT;Qo.NAME=ET;var kT;function $K(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l=0,u=c<s?s:c,f=0;for(let d=u;d>=0;d--,f++){switch(!0){case f<a.length:l=i[s-f]+a[c-f]+t[0];break;default:l=i[s-f]+t[0]}switch(t[0]=l/10,!0){case f>=i.length:i=sy(new Uint8Array([l%10]),i);break;default:i[s-f]=l%10}}return t[0]>0&&(i=sy(t,i)),i}function vT(r){if(r>=Up.length)for(let e=Up.length;e<=r;e++){let t=new Uint8Array([0]),n=Up[e-1].slice(0);for(let o=n.length-1;o>=0;o--){let i=new Uint8Array([(n[o]<<1)+t[0]]);t[0]=i[0]/10,n[o]=i[0]%10}t[0]>0&&(n=sy(t,n)),Up.push(n)}return Up[r]}function VK(r,e){let t=0,n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l,u=0;for(let f=c;f>=0;f--,u++)switch(l=i[s-u]-a[c-u]-t,!0){case l<0:t=1,i[s-u]=l+10;break;default:t=0,i[s-u]=l}if(t>0)for(let f=s-c+1;f>=0;f--,u++)if(l=i[s-u]-t,l<0)t=1,i[s-u]=l+10;else{t=0,i[s-u]=l;break}return i.slice()}var Vp=class extends Ti(xr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=g7.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(yT(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,o=0){let i=this.fromBER(e,t,n);if(i===-1)return i;let s=this.valueHexView;return s[0]===0&&(s[1]&128)!==0?this.valueHexView=s.subarray(1):o!==0&&s.length<o&&(o-s.length>1&&(o=s.length+1),this.valueHexView=s.subarray(o-s.length)),i}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let o=super.fromBER(e,t,n);return o===-1||this.setValueHex(),o}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,o,i=this.valueHexView,s="",a=!1;for(let c=i.byteLength-1;c>=0;c--){o=i[c];for(let l=0;l<8;l++){if((o&1)===1)switch(n){case e:t=VK(vT(n),t),s="-";break;default:t=$K(t,vT(n))}n++,o>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(s+=wT.charAt(t[c]));return a===!1&&(s+=wT.charAt(0)),s}};kT=Vp;Vp.NAME="IntegerValueBlock";Object.defineProperty(kT.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Fp,Vn=class extends Qt{constructor(e={}){super(e,Vp),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return ay(),BigInt(this.valueBlock.toString())}static fromBigInt(e){ay();let t=BigInt(e),n=new df,o=t.toString(16).replace(/^-/,""),i=new Uint8Array(Me.Convert.FromHex(o));if(t<0){let a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${Me.Convert.ToHex(a)}`)+t,u=Me.BufferSourceConverter.toUint8Array(Me.Convert.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new Fp({valueHex:n.final()})}convertToDER(){let e=new Fp({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Fp({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};Fp=Vn;le.Integer=Fp;Vn.NAME="INTEGER";var OT,Xc=class extends Vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};OT=Xc;le.Enumerated=OT;Xc.NAME="ENUMERATED";var qp=class extends Ti(xr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let o=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){ay();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let o=0;o<n.length;o++)n[o]=parseInt(t.slice(o*7,o*7+7),2)+(o+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=ua(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Zo;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n}toString(){let e="";if(this.isHexOnly)e=Me.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};qp.NAME="sidBlock";var my=class extends xr{constructor({value:e=hn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new qp;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let o=this.value[n].toBER(e);if(o.byteLength===0)return this.error=this.value[n].error,Zo;t.push(o)}return v7(t)}fromString(e){this.value=[];let t=0,n=0,o="",i=!1;do if(n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1,i){let s=this.value[0],a=0;switch(s.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(o,10);if(isNaN(c))return;s.valueDec=c+a,i=!1}else{let s=new qp;if(o>Number.MAX_SAFE_INTEGER){ay();let a=BigInt(o);s.valueBigInt=a}else if(s.valueDec=parseInt(o,10),isNaN(s.valueDec))return;this.value.length||(s.isFirstSid=!0,i=!0),this.value.push(s)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t?(o=`{${o}}`,this.value[n].isFirstSid?e=`2.{${o} - 80}`:e+=o):e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};my.NAME="ObjectIdentifierValueBlock";var RT,qn=class extends Qt{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,my),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};RT=qn;le.ObjectIdentifier=RT;qn.NAME="OBJECT IDENTIFIER";var Hp=class extends Ti(Es){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let o=Me.BufferSourceConverter.toUint8Array(e);if(!_s(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=ua(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Zo;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Me.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};Hp.NAME="relativeSidBlock";var yy=class extends xr{constructor({value:e=hn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new Hp;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e,t){let n=[];for(let o=0;o<this.value.length;o++){let i=this.value[o].toBER(e);if(i.byteLength===0)return this.error=this.value[o].error,Zo;n.push(i)}return v7(n)}fromString(e){this.value=[];let t=0,n=0,o="";do{n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1;let i=new Hp;if(i.valueDec=parseInt(o,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(o=`{${o}}`),e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};yy.NAME="RelativeObjectIdentifierValueBlock";var DT,Wp=class extends Qt{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,yy),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};DT=Wp;le.RelativeObjectIdentifier=DT;Wp.NAME="RelativeObjectIdentifier";var NT,ht=class extends Zt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};NT=ht;le.Sequence=NT;ht.NAME="SEQUENCE";var LT,tn=class extends Zt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};LT=tn;le.Set=LT;tn.NAME="SET";var gy=class extends Ti(xr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=hn}toJSON(){return{...super.toJSON(),value:this.value}}};gy.NAME="StringValueBlock";var wy=class extends gy{};wy.NAME="SimpleStringValueBlock";var rn=class extends Kp{constructor({...e}={}){super(e,wy)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Me.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);this.valueBlock.value=e}};rn.NAME="SIMPLE STRING";var by=class extends rn{fromBuffer(e){this.valueBlock.valueHexView=Me.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=Me.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Me.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Me.Convert.FromUtf8String(e)),this.valueBlock.value=e}};by.NAME="Utf8StringValueBlock";var BT,po=class extends by{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};BT=po;le.Utf8String=BT;po.NAME="UTF8String";var vy=class extends rn{fromBuffer(e){this.valueBlock.value=Me.Convert.ToUtf16String(e),this.valueBlock.valueHexView=Me.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Me.Convert.FromUtf16String(e))}};vy.NAME="BmpStringValueBlock";var MT,Yc=class extends vy{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};MT=Yc;le.BmpString=MT;Yc.NAME="BMPString";var xy=class extends rn{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let o=0;o<n.length;o+=4)n[o]=n[o+3],n[o+1]=n[o+2],n[o+2]=0,n[o+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let o=0;o<t;o++){let i=ua(e.charCodeAt(o),8),s=new Uint8Array(i);if(s.length>4)continue;let a=4-s.length;for(let c=s.length-1;c>=0;c--)n[o*4+c+a]=s[c]}this.valueBlock.value=e}};xy.NAME="UniversalStringValueBlock";var UT,Qc=class extends xy{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};UT=Qc;le.UniversalString=UT;Qc.NAME="UniversalString";var FT,Zc=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};FT=Zc;le.NumericString=FT;Zc.NAME="NumericString";var jT,Jc=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};jT=Jc;le.PrintableString=jT;Jc.NAME="PrintableString";var KT,el=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};KT=el;le.TeletexString=KT;el.NAME="TeletexString";var $T,tl=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};$T=tl;le.VideotexString=$T;tl.NAME="VideotexString";var VT,rl=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};VT=rl;le.IA5String=VT;rl.NAME="IA5String";var qT,nl=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};qT=nl;le.GraphicString=qT;nl.NAME="GraphicString";var HT,fa=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};HT=fa;le.VisibleString=HT;fa.NAME="VisibleString";var WT,ol=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};WT=ol;le.GeneralString=WT;ol.NAME="GeneralString";var zT,il=class extends rn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};zT=il;le.CharacterString=zT;il.NAME="CharacterString";var GT,da=class extends fa{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let o=0;o<e.length;o++)this.valueBlock.valueHexView[o]=e.charCodeAt(o)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Me.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let o=0;o<e.length;o++)n[o]=e.charCodeAt(o);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let o=parseInt(n[1],10);o>=50?this.year=1900+o:this.year=2e3+o,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=pn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=pn(this.month,2),t[2]=pn(this.day,2),t[3]=pn(this.hour,2),t[4]=pn(this.minute,2),t[5]=pn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};GT=da;le.UTCTime=GT;da.NAME="UTCTime";var XT,sl=class extends da{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",o="",i=0,s,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let f=new Number(e[e.length-1]);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let f=1,d=n.indexOf("+"),p="";if(d===-1&&(d=n.indexOf("-"),f=-1),d!==-1){if(p=n.substring(d+1),n=n.substring(0,d),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(p.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=f*m,p.length===4){if(m=parseInt(p.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=f*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let f=new Number(`0${n.substring(l)}`);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");i=f.valueOf(),o=n.substring(0,l)}else o=n;switch(!0){case o.length===8:if(s=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case o.length===10:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*i;this.minute=Math.floor(f),f=60*(f-this.minute),this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case o.length===12:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*i;this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case o.length===14:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=1e3*i;this.millisecond=Math.floor(f)}break;default:throw new Error("Wrong input string for conversion")}let u=s.exec(o);if(u===null)throw new Error("Wrong input string for conversion");for(let f=1;f<u.length;f++)switch(f){case 1:this.year=parseInt(u[f],10);break;case 2:this.month=parseInt(u[f],10);break;case 3:this.day=parseInt(u[f],10);break;case 4:this.hour=parseInt(u[f],10)+a;break;case 5:this.minute=parseInt(u[f],10)+c;break;case 6:this.second=parseInt(u[f],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let f=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=f.getUTCFullYear(),this.month=f.getUTCMonth(),this.day=f.getUTCDay(),this.hour=f.getUTCHours(),this.minute=f.getUTCMinutes(),this.second=f.getUTCSeconds(),this.millisecond=f.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(pn(this.year,4)),t.push(pn(this.month,2)),t.push(pn(this.day,2)),t.push(pn(this.hour,2)),t.push(pn(this.minute,2)),t.push(pn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(pn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};XT=sl;le.GeneralizedTime=XT;sl.NAME="GeneralizedTime";var YT,zp=class extends po{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};YT=zp;le.DATE=YT;zp.NAME="DATE";var QT,Gp=class extends po{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};QT=Gp;le.TimeOfDay=QT;Gp.NAME="TimeOfDay";var ZT,Xp=class extends po{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};ZT=Xp;le.DateTime=ZT;Xp.NAME="DateTime";var JT,Yp=class extends po{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};JT=Yp;le.Duration=JT;Yp.NAME="Duration";var eI,Qp=class extends po{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};eI=Qp;le.TIME=eI;Qp.NAME="TIME";var Ai=class{constructor({name:e=hn,optional:t=!1}={}){this.name=e,this.optional=t}},pf=class extends Ai{constructor({value:e=[],...t}={}){super(t),this.value=e}},al=class extends Ai{constructor({value:e=new Ai,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}},b7=class{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=Me.BufferSourceConverter.toUint8Array(e)}constructor({data:e=Ey}={}){this.dataView=Me.BufferSourceConverter.toUint8Array(e)}fromBER(e,t,n){let o=t+n;return this.dataView=Me.BufferSourceConverter.toUint8Array(e).subarray(t,o),o}toBER(e){return this.dataView.slice().buffer}};function xs(r,e,t){if(t instanceof pf){for(let i of t.value)if(xs(r,e,i).verified)return{verified:!0,result:r};{let i={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(w7)&&(i.name=t.name),i}}if(t instanceof Ai)return t.hasOwnProperty(w7)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(DK in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(MK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(UK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(NK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(LK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(BK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(RK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(bT in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let i=t.idBlock.valueHexView,s=e.idBlock.valueHexView;if(i.length!==s.length)return{verified:!1,result:r};for(let a=0;a<i.length;a++)if(i[a]!==s[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&(r[t.name]=e)),t instanceof le.Constructed){let i=0,s={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof al&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-i>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){let l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof al){if(s=xs(r,e.valueBlock.value[c],t.valueBlock.value[0].value),s.verified===!1)if(t.valueBlock.value[0].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&delete r[t.name]),s;if(w7 in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};FK in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(s=xs(r,e.valueBlock.value[c-i],t.valueBlock.value[c]),s.verified===!1)if(t.valueBlock.value[c].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&delete r[t.name]),s;if(s.verified===!1){let c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&bT in e.valueBlock){let i=hf(e.valueBlock.valueHexView);if(i.offset===-1){let s={verified:!1,result:i.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hn),t.name&&(delete r[t.name],s.name=t.name)),s}return xs(r,i.result,t.primitiveSchema)}return{verified:!0,result:r}}function qK(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};let t=hf(Me.BufferSourceConverter.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:xs(t.result,t.result,e)}async function Sy(r,e){let n=await uf.create().encrypt(r,e);return Ht.encode(n)}async function E7(r,e,t){if(r.type==="RSA")return GK(r,e,t);if(r.type==="Ed25519")return HK(r,e,t);if(r.type==="secp256k1")return WK(r,e,t);if(r.type==="ECDSA")return zK(r,e,t);throw new Co}async function HK(r,e,t="libp2p-key"){if(t==="libp2p-key")return Sy(_c(r),e);throw new M(`export format '${t}' is not supported`)}async function WK(r,e,t="libp2p-key"){if(t==="libp2p-key")return Sy(_c(r),e);throw new M("Export format is not supported")}async function zK(r,e,t="libp2p-key"){if(t==="libp2p-key")return Sy(_c(r),e);throw new M(`export format '${t}' is not supported`)}async function GK(r,e,t="pkcs-8"){if(t==="pkcs-8")return XK(r,e);if(t==="libp2p-key")return Sy(_c(r),e);throw new M("Export format is not supported")}async function XK(r,e){let t=Wt.get(),o=new ht({value:[new Vn({value:0}),new ht({value:[new qn({value:"1.2.840.113549.1.1.1"}),new mn]}),new Hr({valueHex:r.raw})]}).toBER(),i=new Uint8Array(o,0,o.byteLength),s=Zr(16),a=await c0(ju,e,s,{c:1e4,dkLen:32}),c=Zr(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),f=new ht({value:[new Hr({valueHex:s}),new Vn({value:1e4}),new Vn({value:32}),new ht({value:[new qn({value:"1.2.840.113549.2.11"}),new mn]})]}),d=new ht({value:[new qn({value:"1.2.840.113549.1.5.13"}),new ht({value:[new ht({value:[new qn({value:"1.2.840.113549.1.5.12"}),f]}),new ht({value:[new qn({value:"2.16.840.1.101.3.4.1.42"}),new Hr({valueHex:c})]})]})]}),m=new ht({value:[d,new Hr({valueHex:u})]}).toBER(),g=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...W(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function S7(r,e){try{let t=await YK(r,e);return LS(t)}catch{}if(!r.includes("BEGIN"))throw new M("Encrypted key was not a libp2p-key or a PEM file");return QK(r,e)}async function YK(r,e){let t=Ht.decode(r);return uf.create().decrypt(t,e)}async function QK(r,e){let t=Wt.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let i=q(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=Hn(i),{iv:a,salt:c,iterations:l,keySize:u,cipherText:f}=ZK(s),d=await c0(ju,e,c,{c:l,dkLen:u}),p=await t.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),m=Zp(await t.subtle.decrypt({name:"AES-CBC",iv:a},p,f)),{result:g}=Hn(m);n=nI(g)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let i=q(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=Hn(i);n=nI(s)}else throw new M("Could not parse private key from PEM data");let o=BS(n);if(o.type!=="RSA")throw new M("Could not parse RSA private key from PEM data");return o}function ZK(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new M("Only pkcs5PBES2 encrypted private keys are supported");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new M("Only pkcs5PBKDF2 key derivation functions are supported");let i=n.valueBlock.value[1],s=Zp(i.valueBlock.value[0].getValue()),a=1e4,c=32;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new M("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new M("Only AES-CBC encryption schemes are supported")}}}}let f=Zp(l.valueBlock.value[1].getValue());return{cipherText:Zp(r.valueBlock.value[1].getValue()),salt:s,iterations:a,keySize:c,iv:f}}function nI(r){return Zp(r.valueBlock.value[2].getValue())}function Zp(r){return new Uint8Array(r,0,r.byteLength)}var JK="/pkcs8/",A7="/info/",Jp=new WeakMap,cl={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},_7={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function mf(r){return r==null||typeof r!="string"?!1:r===(0,oI.default)(r.trim())&&r.length>0}async function Er(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function ll(r){return new ct(JK+r)}function yf(r){return new ct(A7+r)}async function e$(r){let e=_c(r),t=await wt.digest(e);return rt.encode(t.bytes).substring(1)}var _y=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=of(_7,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<cl.minKeyLength)throw new Error(`dek.keyLength must be least ${cl.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<cl.minSaltLength)throw new Error(`dek.saltLength must be least ${cl.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<cl.minIterationCount)throw new Error(`dek.iterationCount must be least ${cl.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?op(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Jp.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[He]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},_7),t=Math.ceil(cl.minSaltLength/3)*3;return e.dek.salt=W(Zr(t),"base64"),e}static get options(){return _7}async findKeyByName(e){if(!mf(e))throw await Er(),new M(`Invalid key name '${e}'`);let t=yf(e);try{let n=await this.components.datastore.get(t);return JSON.parse(W(n))}catch(n){throw await Er(),this.log.error(n),new qe(`Key '${e}' does not exist.`)}}async findKeyById(e){try{let t={prefix:A7};for await(let n of this.components.datastore.query(t)){let o=JSON.parse(W(n.value));if(o.id===e)return o}throw new M(`Key with id '${e}' does not exist.`)}catch(t){throw await Er(),t}}async importKey(e,t){if(!mf(e))throw await Er(),new M(`Invalid key name '${e}'`);if(t==null)throw await Er(),new M("Key is required");let n=ll(e);if(await this.components.datastore.has(n))throw await Er(),new M(`Key '${e}' already exists`);let i,s;try{i=await e$(t);let l=Jp.get(this);if(l==null)throw new M("dek missing");let u=l.dek;s=await E7(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Er(),l}let a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,q(s)),c.put(yf(e),q(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!mf(e))throw await Er(),new M(`Invalid key name '${e}'`);let t=ll(e);try{let n=await this.components.datastore.get(t),o=W(n),i=Jp.get(this);if(i==null)throw new M("dek missing");let s=i.dek;return await S7(o,s)}catch(n){throw await Er(),n}}async removeKey(e){if(!mf(e)||e===this.self)throw await Er(),new M(`Invalid key name '${e}'`);let t=ll(e),n=await this.findKeyByName(e),o=this.components.datastore.batch();return o.delete(t),o.delete(yf(e)),await o.commit(),n}async listKeys(){let e={prefix:A7},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(W(n.value)));return t}async renameKey(e,t){if(!mf(e)||e===this.self)throw await Er(),new M(`Invalid old key name '${e}'`);if(!mf(t)||t===this.self)throw await Er(),new M(`Invalid new key name '${t}'`);let n=ll(e),o=ll(t),i=yf(e),s=yf(t);if(await this.components.datastore.has(o))throw await Er(),new M(`Key '${t}' already exists`);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),u=JSON.parse(W(l));u.name=t;let f=this.components.datastore.batch();return f.put(o,c),f.put(s,q(JSON.stringify(u))),f.delete(n),f.delete(i),await f.commit(),u}catch(c){throw await Er(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Er(),new M(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Er(),new M(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Er(),new M(`Invalid pass length ${t.length}`);this.log("recreating keychain");let n=Jp.get(this);if(n==null)throw new M("dek missing");let o=n.dek;this.init.pass=t;let i=t!=null&&this.init.dek?.salt!=null?op(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Jp.set(this,{dek:i});let s=await this.listKeys();for(let a of s){let c=await this.components.datastore.get(ll(a.name)),l=W(c),u=await S7(l,o),f=i.toString(),d=await E7(u,f,u.type==="RSA"?"pkcs-8":"libp2p-key"),p=this.components.datastore.batch(),m={name:a.name,id:a.id};p.put(ll(a.name),q(d)),p.put(yf(a.name),q(JSON.stringify(m))),await p.commit()}this.log("keychain reconstructed")}};function Ay(r={}){return e=>new _y(e,r)}async function T7(r,e={}){let t=e.selfKey??"self",n=Ay(e)({datastore:r,logger:Ws()}),o;return await r.has(new ct(`/pkcs8/${t}`))?o=await n.exportKey(t):(o=await Fu(e.keyType??"Ed25519"),await n.importKey(t,o)),o}function I7(){let r=ve(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function iI(){let r=I7(),e=I7();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var gf=!!globalThis.process?.env?.DUMP_SESSION_KEYS;function aI(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Ty(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function Iy(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Wr(r,...e){if(!aI(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function C7(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function cI(r,e){Wr(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function As(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function Ts(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function t$(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}var r$=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function n$(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Cy(r){if(typeof r=="string")r=n$(r);else if(aI(r))r=Py(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function lI(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function uI(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var P7=(r,e)=>{function t(n,...o){if(Wr(n),!r$)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){let u=o[0];if(!u)throw new Error("nonce / iv required");r.varSizeNonce?Wr(u):Wr(u,r.nonceLength)}let i=r.tagLength;i&&o[1]!==void 0&&Wr(o[1]);let s=e(n,...o),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");Wr(f)}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Wr(u),a(s.encrypt.length,f),s.encrypt(u,f)},decrypt(u,f){if(Wr(u),i&&u.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(s.decrypt.length,f),s.decrypt(u,f)}}}return Object.assign(t,r),t};function k7(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!o$(e))throw new Error("invalid output, must be aligned");return e}function sI(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function fI(r,e,t){Ty(t);let n=new Uint8Array(16),o=t$(n);return sI(o,0,BigInt(e),t),sI(o,8,BigInt(r),t),n}function o$(r){return r.byteOffset%4===0}function Py(r){return Uint8Array.from(r)}var pI=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),i$=pI("expand 16-byte k"),s$=pI("expand 32-byte k"),a$=As(i$),c$=As(s$);function de(r,e){return r<<e|r>>>32-e}function O7(r){return r.byteOffset%4===0}var ky=64,l$=16,hI=2**32-1,dI=new Uint32Array;function u$(r,e,t,n,o,i,s,a){let c=o.length,l=new Uint8Array(ky),u=As(l),f=O7(o)&&O7(i),d=f?As(o):dI,p=f?As(i):dI;for(let m=0;m<c;s++){if(r(e,t,n,u,s,a),s>=hI)throw new Error("arx: counter overflow");let g=Math.min(ky,c-m);if(f&&g===ky){let y=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let b=0,C;b<l$;b++)C=y+b,p[C]=d[C]^u[b];m+=ky;continue}for(let y=0,b;y<g;y++)b=m+y,i[b]=o[b]^l[y];m+=g}}function R7(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:o,counterRight:i,rounds:s}=lI({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Iy(o),Iy(s),Ty(i),Ty(t),(a,c,l,u,f=0)=>{Wr(a),Wr(c),Wr(l);let d=l.length;if(u===void 0&&(u=new Uint8Array(d)),Wr(u),Iy(f),f<0||f>=hI)throw new Error("arx: counter overflow");if(u.length<d)throw new Error(`arx: output (${u.length}) is shorter than data (${d})`);let p=[],m=a.length,g,y;if(m===32)p.push(g=Py(a)),y=c$;else if(m===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),y=a$,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);O7(c)||p.push(c=Py(c));let b=As(g);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(y,b,As(c.subarray(0,16)),b),c=c.subarray(16)}let C=16-o;if(C!==c.length)throw new Error(`arx: nonce must be ${C} or 16 bytes`);if(C!==12){let U=new Uint8Array(12);U.set(c,i?0:12-c.length),c=U,p.push(c)}let D=As(c);return u$(r,y,b,D,l,u,f,s),Ts(...p),u}}var Sr=(r,e)=>r[e++]&255|(r[e++]&255)<<8,D7=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Cy(e),Wr(e,32);let t=Sr(e,0),n=Sr(e,2),o=Sr(e,4),i=Sr(e,6),s=Sr(e,8),a=Sr(e,10),c=Sr(e,12),l=Sr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|o<<6)&7939,this.r[3]=(o>>>7|i<<9)&8191,this.r[4]=(i>>>4|s<<12)&255,this.r[5]=s>>>1&8190,this.r[6]=(s>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Sr(e,16+2*u)}process(e,t,n=!1){let o=n?0:2048,{h:i,r:s}=this,a=s[0],c=s[1],l=s[2],u=s[3],f=s[4],d=s[5],p=s[6],m=s[7],g=s[8],y=s[9],b=Sr(e,t+0),C=Sr(e,t+2),D=Sr(e,t+4),U=Sr(e,t+6),X=Sr(e,t+8),K=Sr(e,t+10),ee=Sr(e,t+12),$=Sr(e,t+14),B=i[0]+(b&8191),S=i[1]+((b>>>13|C<<3)&8191),x=i[2]+((C>>>10|D<<6)&8191),P=i[3]+((D>>>7|U<<9)&8191),k=i[4]+((U>>>4|X<<12)&8191),F=i[5]+(X>>>1&8191),H=i[6]+((X>>>14|K<<2)&8191),T=i[7]+((K>>>11|ee<<5)&8191),I=i[8]+((ee>>>8|$<<8)&8191),j=i[9]+($>>>5|o),N=0,te=N+B*a+S*(5*y)+x*(5*g)+P*(5*m)+k*(5*p);N=te>>>13,te&=8191,te+=F*(5*d)+H*(5*f)+T*(5*u)+I*(5*l)+j*(5*c),N+=te>>>13,te&=8191;let oe=N+B*c+S*a+x*(5*y)+P*(5*g)+k*(5*m);N=oe>>>13,oe&=8191,oe+=F*(5*p)+H*(5*d)+T*(5*f)+I*(5*u)+j*(5*l),N+=oe>>>13,oe&=8191;let z=N+B*l+S*c+x*a+P*(5*y)+k*(5*g);N=z>>>13,z&=8191,z+=F*(5*m)+H*(5*p)+T*(5*d)+I*(5*f)+j*(5*u),N+=z>>>13,z&=8191;let Pe=N+B*u+S*l+x*c+P*a+k*(5*y);N=Pe>>>13,Pe&=8191,Pe+=F*(5*g)+H*(5*m)+T*(5*p)+I*(5*d)+j*(5*f),N+=Pe>>>13,Pe&=8191;let Le=N+B*f+S*u+x*l+P*c+k*a;N=Le>>>13,Le&=8191,Le+=F*(5*y)+H*(5*g)+T*(5*m)+I*(5*p)+j*(5*d),N+=Le>>>13,Le&=8191;let ke=N+B*d+S*f+x*u+P*l+k*c;N=ke>>>13,ke&=8191,ke+=F*a+H*(5*y)+T*(5*g)+I*(5*m)+j*(5*p),N+=ke>>>13,ke&=8191;let Ne=N+B*p+S*d+x*f+P*u+k*l;N=Ne>>>13,Ne&=8191,Ne+=F*c+H*a+T*(5*y)+I*(5*g)+j*(5*m),N+=Ne>>>13,Ne&=8191;let ze=N+B*m+S*p+x*d+P*f+k*u;N=ze>>>13,ze&=8191,ze+=F*l+H*c+T*a+I*(5*y)+j*(5*g),N+=ze>>>13,ze&=8191;let dt=N+B*g+S*m+x*p+P*d+k*f;N=dt>>>13,dt&=8191,dt+=F*u+H*l+T*c+I*a+j*(5*y),N+=dt>>>13,dt&=8191;let Vt=N+B*y+S*g+x*m+P*p+k*d;N=Vt>>>13,Vt&=8191,Vt+=F*f+H*u+T*l+I*c+j*a,N+=Vt>>>13,Vt&=8191,N=(N<<2)+N|0,N=N+te|0,te=N&8191,N=N>>>13,oe+=N,i[0]=te,i[1]=oe,i[2]=z,i[3]=Pe,i[4]=Le,i[5]=ke,i[6]=Ne,i[7]=ze,i[8]=dt,i[9]=Vt}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),o=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=o,o=e[a]>>>13,e[a]&=8191;e[0]+=o*5,o=e[0]>>>13,e[0]&=8191,e[1]+=o,o=e[1]>>>13,e[1]&=8191,e[2]+=o,n[0]=e[0]+5,o=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+o,o=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(o^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let s=e[0]+t[0];e[0]=s&65535;for(let a=1;a<8;a++)s=(e[a]+t[a]|0)+(s>>>16)|0,e[a]=s&65535;Ts(n)}update(e){C7(this),e=Cy(e),Wr(e);let{buffer:t,blockLen:n}=this,o=e.length;for(let i=0;i<o;){let s=Math.min(n-this.pos,o-i);if(s===n){for(;n<=o-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Ts(this.h,this.r,this.buffer,this.pad)}digestInto(e){C7(this),cI(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:o}=this;if(o){for(t[o++]=1;o<16;o++)t[o]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let s=0;s<8;s++)e[i++]=n[s]>>>0,e[i++]=n[s]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function f$(r){let e=(n,o)=>r(o).update(Cy(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var mI=f$(r=>new D7(r));function wI(r,e,t,n,o,i=20){let s=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],d=e[2],p=e[3],m=e[4],g=e[5],y=e[6],b=e[7],C=o,D=t[0],U=t[1],X=t[2],K=s,ee=a,$=c,B=l,S=u,x=f,P=d,k=p,F=m,H=g,T=y,I=b,j=C,N=D,te=U,oe=X;for(let Pe=0;Pe<i;Pe+=2)K=K+S|0,j=de(j^K,16),F=F+j|0,S=de(S^F,12),K=K+S|0,j=de(j^K,8),F=F+j|0,S=de(S^F,7),ee=ee+x|0,N=de(N^ee,16),H=H+N|0,x=de(x^H,12),ee=ee+x|0,N=de(N^ee,8),H=H+N|0,x=de(x^H,7),$=$+P|0,te=de(te^$,16),T=T+te|0,P=de(P^T,12),$=$+P|0,te=de(te^$,8),T=T+te|0,P=de(P^T,7),B=B+k|0,oe=de(oe^B,16),I=I+oe|0,k=de(k^I,12),B=B+k|0,oe=de(oe^B,8),I=I+oe|0,k=de(k^I,7),K=K+x|0,oe=de(oe^K,16),T=T+oe|0,x=de(x^T,12),K=K+x|0,oe=de(oe^K,8),T=T+oe|0,x=de(x^T,7),ee=ee+P|0,j=de(j^ee,16),I=I+j|0,P=de(P^I,12),ee=ee+P|0,j=de(j^ee,8),I=I+j|0,P=de(P^I,7),$=$+k|0,N=de(N^$,16),F=F+N|0,k=de(k^F,12),$=$+k|0,N=de(N^$,8),F=F+N|0,k=de(k^F,7),B=B+S|0,te=de(te^B,16),H=H+te|0,S=de(S^H,12),B=B+S|0,te=de(te^B,8),H=H+te|0,S=de(S^H,7);let z=0;n[z++]=s+K|0,n[z++]=a+ee|0,n[z++]=c+$|0,n[z++]=l+B|0,n[z++]=u+S|0,n[z++]=f+x|0,n[z++]=d+P|0,n[z++]=p+k|0,n[z++]=m+F|0,n[z++]=g+H|0,n[z++]=y+T|0,n[z++]=b+I|0,n[z++]=C+j|0,n[z++]=D+N|0,n[z++]=U+te|0,n[z++]=X+oe|0}function d$(r,e,t,n){let o=r[0],i=r[1],s=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],d=e[4],p=e[5],m=e[6],g=e[7],y=t[0],b=t[1],C=t[2],D=t[3];for(let X=0;X<20;X+=2)o=o+c|0,y=de(y^o,16),d=d+y|0,c=de(c^d,12),o=o+c|0,y=de(y^o,8),d=d+y|0,c=de(c^d,7),i=i+l|0,b=de(b^i,16),p=p+b|0,l=de(l^p,12),i=i+l|0,b=de(b^i,8),p=p+b|0,l=de(l^p,7),s=s+u|0,C=de(C^s,16),m=m+C|0,u=de(u^m,12),s=s+u|0,C=de(C^s,8),m=m+C|0,u=de(u^m,7),a=a+f|0,D=de(D^a,16),g=g+D|0,f=de(f^g,12),a=a+f|0,D=de(D^a,8),g=g+D|0,f=de(f^g,7),o=o+l|0,D=de(D^o,16),m=m+D|0,l=de(l^m,12),o=o+l|0,D=de(D^o,8),m=m+D|0,l=de(l^m,7),i=i+u|0,y=de(y^i,16),g=g+y|0,u=de(u^g,12),i=i+u|0,y=de(y^i,8),g=g+y|0,u=de(u^g,7),s=s+f|0,b=de(b^s,16),d=d+b|0,f=de(f^d,12),s=s+f|0,b=de(b^s,8),d=d+b|0,f=de(f^d,7),a=a+c|0,C=de(C^a,16),p=p+C|0,c=de(c^p,12),a=a+c|0,C=de(C^a,8),p=p+C|0,c=de(c^p,7);let U=0;n[U++]=o,n[U++]=i,n[U++]=s,n[U++]=a,n[U++]=y,n[U++]=b,n[U++]=C,n[U++]=D}var p$=R7(wI,{counterRight:!1,counterLength:4,allowShortKeys:!1}),h$=R7(wI,{counterRight:!1,counterLength:8,extendNonceFn:d$,allowShortKeys:!1});var m$=new Uint8Array(16),yI=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(m$.subarray(t))},y$=new Uint8Array(32);function gI(r,e,t,n,o){let i=r(e,t,y$),s=mI.create(i);o&&yI(s,o),yI(s,n);let a=fI(n.length,o?o.length:0,!0);s.update(a);let c=s.digest();return Ts(i,a),c}var bI=r=>(e,t,n)=>({encrypt(i,s){let a=i.length;s=k7(a+16,s,!1),s.set(i);let c=s.subarray(0,-16);r(e,t,c,c,1);let l=gI(r,e,t,c,n);return s.set(l,a),Ts(l),s},decrypt(i,s){s=k7(i.length-16,s,!1);let a=i.subarray(0,-16),c=i.subarray(-16),l=gI(r,e,t,a,n);if(!uI(c,l))throw new Error("invalid tag");return s.set(i.subarray(0,-16)),r(e,t,s,s,1),Ts(l),s}}),N7=P7({blockSize:64,nonceLength:12,tagLength:16},bI(p$)),i0e=P7({blockSize:64,nonceLength:24,tagLength:16},bI(h$));function xI(r,e,t){return Yi(r),t===void 0&&(t=new Uint8Array(r.outputLen)),na(r,Qs(t),Qs(e))}var L7=Uint8Array.from([0]),vI=Uint8Array.of();function EI(r,e,t,n=32){Yi(r),Lo(n);let o=r.outputLen;if(n>255*o)throw new Error("Length should be <= 255*HashLen");let i=Math.ceil(n/o);t===void 0&&(t=vI);let s=new Uint8Array(i*o),a=na.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<i;u++)L7[0]=u+1,c.update(u===0?vI:l).update(t).update(L7).digestInto(l),s.set(l,o*u),a._cloneInto(c);return a.destroy(),c.destroy(),Ur(l,L7),s.slice(0,n)}var B7={hashSHA256(r){return bi(r.subarray())},getHKDF(r,e){let t=xI(bi,e,r),o=EI(bi,t,void 0,96),i=o.subarray(0,32),s=o.subarray(32,64),a=o.subarray(64,96);return[i,s,a]},generateX25519KeyPair(){let r=zd.utils.randomPrivateKey();return{publicKey:zd.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:zd.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return zd.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return N7(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,o){return N7(n,e,t).decrypt(r.subarray(),o)}};var SI=B7;function _I(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var wf=r=>{let e=Tt(2);return e[0]=r>>8,e[1]=r,e};wf.bytes=2;var eh=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};eh.bytes=2;function AI(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function M7(r,e){!e.enabled||!gf||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${W(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${W(r.privateKey,"hex")}`)):e("Missing local static keys."))}function U7(r,e){!e.enabled||!gf||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${W(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${W(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function TI(r,e){!e.enabled||!gf||e(r?`REMOTE_STATIC_PUBLIC_KEY ${W(r.subarray(),"hex")}`:"Missing remote static public key.")}function F7(r,e){!e.enabled||!gf||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${W(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function j7(r,e,t){!t.enabled||!gf||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&W(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&W(e.k,"hex")}`))}function Jo(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=Tt(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}var bf=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var g$=0,w$=4294967295,b$="Cipherstate has reached maximum n, a new handshake must be performed",Oy=class{n;bytes;view;constructor(e=g$){this.n=e,this.bytes=Ce(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>w$)throw new Error(b$)}};var ul=Ce(0),vf=class{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new Oy(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let o=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),o}},K7=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let n=q(t,"utf-8");this.h=v$(e,n),this.ck=this.h,this.cs=new vf(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new vf(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new xe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,ul);return[new vf(this.crypto,e),new vf(this.crypto,t)]}},$7=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:n,prologue:o,initiator:i,s,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new K7(t,n),this.ss.mixHash(o),this.initiator=i,this.s=s,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let o=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(o),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},th=class extends $7{writeMessageA(e){return new xe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new xe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new xe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new bf(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new bf(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new bf(`handshake stage 2 validation fail: ${t.message}`)}}};function v$(r,e){if(e.length<=32){let t=Ce(32);return t.set(e),t}else return r.hash(e)}var Ry;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(let i of t.streamMuxers)n.uint32(18),n.string(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={webtransportCerthashes:[],streamMuxers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===o.limits.webtransportCerthashes)throw new lt('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(o.limits?.streamMuxers!=null&&i.streamMuxers.length===o.limits.streamMuxers)throw new lt('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Ry||(Ry={}));var rh;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),Ry.codec().encode(t.extensions,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={identityKey:Ce(0),identitySig:Ce(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=Ry.codec().decode(t,t.uint32(),{limits:o.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(rh||(rh={}));async function V7(r,e,t){let n=await r.sign(II(e));return rh.encode({identityKey:cr(r.publicKey),identitySig:n,extensions:t})}async function q7(r,e,t){try{let n=rh.decode(r),o=jt(n.identityKey);if(t?.equals(o)===!1)throw new Error(`Payload identity key ${o} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");let i=II(e);if(!await o.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new S1(n.message)}}function II(r){let e=q("noise-libp2p-static-key:");return r instanceof Uint8Array?St([e,r],e.length+r.length):(r.prepend(e),r)}async function CI(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await V7(i,a.publicKey,l),f=new th({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});M7(f.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(f.writeMessageA(ul),e),t.trace("Stage 0 - Initiator finished sending first message."),U7(f.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let d=f.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),F7(f.re,t),TI(f.rs,t),t.trace("Initiator going to check remote's signature...");let p=await q7(d,f.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(f.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[m,g]=f.ss.split();return j7(m,g,t),{payload:p,encrypt:y=>m.encryptWithAd(ul,y),decrypt:(y,b)=>g.decryptWithAd(ul,y,b)}}async function PI(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await V7(i,a.publicKey,l),f=new th({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});M7(f.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),f.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),F7(f.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(f.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),U7(f.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let d=f.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let p=await q7(d,f.rs,c),[m,g]=f.ss.split();return j7(m,g,t),{payload:p,encrypt:y=>g.encryptWithAd(ul,y),decrypt:(y,b)=>m.decryptWithAd(ul,y,b)}}var OI=16;function RI(r,e){return async function*(t){for await(let n of t)for(let o=0;o<n.length;o+=65519){let i=o+65519;i>n.length&&(i=n.length);let s;n instanceof Uint8Array?s=r.encrypt(n.subarray(o,i)):s=r.encrypt(n.sublist(o,i)),e?.encryptedPackets.increment(),yield new xe(wf(s.byteLength),s)}}}function DI(r,e){return async function*(t){for await(let n of t)for(let o=0;o<n.length;o+=65535){let i=o+65535;if(i>n.length&&(i=n.length),i-OI<o)throw new Error("Invalid chunk");let s=n.sublist(o,i),a=n.subarray(o,i-OI);try{let c=r.decrypt(s,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}var Dy=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){let{staticNoiseKey:n,extensions:o,crypto:i,prologueBytes:s}=t,{metrics:a}=e;this.components=e;let c=i??SI;this.crypto=_I(c),this.extensions={webtransportCerthashes:[],...o},this.metrics=a?AI(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=s??Ce(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[He]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){let n=Si(e,{lengthEncoder:wf,lengthDecoder:eh,maxDataLength:65535}),o=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,o);e.source=i.source,e.sink=i.sink;let s=jt(o.payload.identityKey);return{conn:e,remoteExtensions:o.payload.extensions,remotePeer:vi(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;let t=this.components.upgrader.getStreamMuxers();if(t!=null)for(let n of e){let o=t.get(n);if(o!=null)return o}if(e.length)throw new _1("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){let n=Si(e,{lengthEncoder:wf,lengthDecoder:eh,maxDataLength:65535}),o=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,o);e.source=i.source,e.sink=i.sink;let s=jt(o.payload.identityKey);return{conn:e,remoteExtensions:o.payload.extensions,remotePeer:vi(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,o){let i,s=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await CI({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,o){let i,s=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await PI({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){let[n,o]=iI(),i=e.unwrap();return await ln(n,RI(t,this.metrics),i,s=>cs(s,{lengthDecoder:eh}),DI(t,this.metrics),n),o}};function Ny(r={}){return e=>new Dy(e,r)}function Ly(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}var ei=class extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}},xf=class extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}},Ef=class extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}},By=class extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}},My=class extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}},Uy=class extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}},Fy=class extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}},Sf=class extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}};var NI=new Set([ei.name,xf.name,Ef.name,My.name,Uy.name,Fy.name,Sf.name]),oh=256*1024,LI=16*1024*1024;var BI={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:oh,maxStreamWindowSize:LI,maxMessageSize:64*1024};function MI(r){if(r.keepAliveInterval<=0)throw new M("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new M("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new M("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<oh)throw new M("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new M("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new M("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new M("MaxMessageSize must be greater than a kilobyte")}var Nt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Nt||(Nt={}));var At;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(At||(At={}));var N2e=Object.values(At).filter(r=>typeof r!="string"),UI=0,mo;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(mo||(mo={}));var pa=12;var FI=2**24;function x$(r){if(r[0]!==UI)throw new ei("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*FI+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*FI+(r[9]<<16)+(r[10]<<8)+r[11]}}var jy=class{source;buffer;frameInProgress;constructor(e){this.source=E$(e),this.buffer=new xe,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:o}=t;n===Nt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,o)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new By("decoding frame already in progress");if(this.buffer.length<pa)return;let e=x$(this.buffer.subarray(0,pa));return this.buffer.consume(pa),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function E$(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function H7(r){let e=new Uint8Array(pa);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function jI(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function Ky(r,e){let t=Ly(r).return?.();jI(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var S$=5e3;function W7(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var ha=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=ve(),this.closed=ve(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??S$,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=sr({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Za(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let o=this.sendNewStream(t);W7(o)&&await o}let n=()=>{Ky(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let o of e){o=o instanceof Uint8Array?new xe(o):o;let i=this.sendData(o,t);W7(i)&&(this.sendingData=ve(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await nt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await nt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await nt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await nt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();W7(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new T1("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var yo;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(yo||(yo={}));var $y=class extends ha{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=yo.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=oh,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=cc(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-pa,e.length),o=this.getSendFlags();this.sendFrame({type:Nt.Data,flag:o,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Nt.WindowUpdate,flag:At.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|At.FIN;this.sendFrame({type:Nt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,o=()=>{this.status==="open"||this.status==="closing"?n(new rr("Stream aborted")):t()};e.signal?.addEventListener("abort",o);try{await new Promise((i,s)=>{this.sendWindowCapacityUpdate=()=>{i()},n=s,t=i})}finally{e.signal?.removeEventListener("abort",o)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Sf("Receive window exceeded");let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&At.ACK)===At.ACK&&this.state===yo.SYNSent&&(this.state=yo.Established),(e&At.FIN)===At.FIN&&this.remoteCloseWrite(),(e&At.RST)===At.RST&&this.reset()}getSendFlags(){switch(this.state){case yo.Init:return this.state=yo.SYNSent,At.SYN;case yo.SYNReceived:return this.state=yo.Established,At.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let o=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Nt.WindowUpdate,flag:e,streamID:this._id,length:o})}};var KI="/yamux/1.0.0",_$=500,Vy=class{protocol=KI;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[He]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new z7(this._components,{...this._init,...e})}},z7=class{protocol=KI;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...BI,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),MI(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=sr({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{let o=()=>{let a=Ly(n);if(a.return!=null){let c=a.return();A$(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}},i,s;try{let a=new jy(n);try{this.closeController.signal.addEventListener("abort",o);for await(let c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",o)}i=mo.NormalTermination}catch(a){NI.has(a.name)?(this.log?.error("protocol error in sink",a),i=mo.ProtocolError):(this.log?.error("internal error in sink",a),i=mo.InternalError),s=a}this.log?.trace("muxer sink ended"),s!=null?this.abort(s,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new di("Muxer closed remotely");if(this.localGoAway!==void 0)throw new di("Muxer closed locally");let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new qs("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,yo.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new di("Muxer closed remotely");if(this.localGoAway!==void 0)throw new di("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((o,i)=>{let s=()=>{i(new di("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",s,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",s),o()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??mo.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){let n=AbortSignal.timeout(_$);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??mo.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,o){if(this._streams.get(e)!=null)throw new M("Stream already exists with that id");let i=new $y({id:e.toString(),name:t,state:n,direction:o,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${o}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await nt(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){let{streamID:n,type:o,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(o){case Nt.Ping:{this.handlePing(e);return}case Nt.GoAway:{this.handleGoAway(i);return}default:throw new ei("Invalid frame type")}else switch(e.type){case Nt.Data:case Nt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new ei("Invalid frame type")}}handlePing(e){if(e.flag===At.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,At.ACK);else if(e.flag===At.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new ei("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new xf("ping not requested");if(this.activePing.id!==e)throw new Ef("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",mo[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:o,type:i}=e;(o&At.SYN)===At.SYN&&this.incomingStream(n);let s=this._streams.get(n);if(s===void 0){if(i===Nt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case Nt.WindowUpdate:{s.handleWindowUpdate(e);return}case Nt.Data:{if(t===void 0)throw new Error("unreachable");await s.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new M("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Nt.WindowUpdate,flag:At.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Nt.WindowUpdate,flag:At.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,yo.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Nt.Data){if(t===void 0)throw new ei("Invalid frame");this.source.push(new xe(H7(e),t))}else this.source.push(H7(e))}sendPing(e,t=At.SYN){t===At.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Nt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=mo.NormalTermination){this.log?.("sending GoAway reason=%s",mo[e]),this.localGoAway=e,this.sendFrame({type:Nt.GoAway,flag:0,streamID:0,length:e})}};function A$(r){return r!=null&&typeof r.then=="function"}function $I(r={}){return e=>new Vy(e,r)}function qy(r){try{for(let{code:e,value:t}of r.getComponents())if(t!=null&&e===41)return __("2000::/3",t)}catch{}return!1}function VI(r,e,t){let n,o,i=!1;function s(){let l={signal:o.signal};if(t?.timeout!=null){let u=Oe([o.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}i=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{i=!1,!o.signal.aborted&&(n=setTimeout(s,e))})}let a=qi(s,t?.debounce??100),c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(s,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{i||(clearTimeout(n),a())},start:()=>{c||(c=!0,o=new AbortController,o.signal,t?.runImmediately===!0?queueMicrotask(()=>{s()}):n=setTimeout(s,e))},stop:()=>{clearTimeout(n),o?.abort(),c=!1}}}function mt(r,e){let t=Si(r,e),n={read:async(o,i)=>{let s=await t.read(i);return o.decode(s)},write:async(o,i,s)=>{await t.write(i.encode(o),s)},writeV:async(o,i,s)=>{await t.writeV(o.map(a=>i.encode(a)),s)},pb:o=>({read:async i=>n.read(o,i),write:async(i,s)=>n.write(i,o,s),writeV:async(i,s)=>n.writeV(i,o,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var qI="libp2p",HI="autonat",WI="1.0.0";var xt;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>_t(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(o||(o={})),function(l){l.codec=()=>_t(o)}(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){let u;l.codec=()=>(u==null&&(u=Ae((f,d,p={})=>{if(p.lengthDelimited!==!1&&d.fork(),f.id!=null&&(d.uint32(10),d.bytes(f.id)),f.addrs!=null)for(let m of f.addrs)d.uint32(18),d.bytes(m);p.lengthDelimited!==!1&&d.ldelim()},(f,d,p={})=>{let m={addrs:[]},g=d==null?f.len:f.pos+d;for(;f.pos<g;){let y=f.uint32();switch(y>>>3){case 1:{m.id=f.bytes();break}case 2:{if(p.limits?.addrs!=null&&m.addrs.length===p.limits.addrs)throw new lt('Decode error - map field "addrs" had too many elements');m.addrs.push(f.bytes());break}default:{f.skipType(y&7);break}}}return m})),u),l.encode=f=>_e(f,l.codec()),l.decode=(f,d)=>Se(f,l.codec(),d)})(i=r.PeerInfo||(r.PeerInfo={}));let s;(function(l){let u;l.codec=()=>(u==null&&(u=Ae((f,d,p={})=>{p.lengthDelimited!==!1&&d.fork(),f.peer!=null&&(d.uint32(10),r.PeerInfo.codec().encode(f.peer,d)),p.lengthDelimited!==!1&&d.ldelim()},(f,d,p={})=>{let m={},g=d==null?f.len:f.pos+d;for(;f.pos<g;){let y=f.uint32();switch(y>>>3){case 1:{m.peer=r.PeerInfo.codec().decode(f,f.uint32(),{limits:p.limits?.peer});break}default:{f.skipType(y&7);break}}}return m})),u),l.encode=f=>_e(f,l.codec()),l.decode=(f,d)=>Se(f,l.codec(),d)})(s=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=Ae((f,d,p={})=>{p.lengthDelimited!==!1&&d.fork(),f.status!=null&&(d.uint32(8),r.ResponseStatus.codec().encode(f.status,d)),f.statusText!=null&&(d.uint32(18),d.string(f.statusText)),f.addr!=null&&(d.uint32(26),d.bytes(f.addr)),p.lengthDelimited!==!1&&d.ldelim()},(f,d,p={})=>{let m={},g=d==null?f.len:f.pos+d;for(;f.pos<g;){let y=f.uint32();switch(y>>>3){case 1:{m.status=r.ResponseStatus.codec().decode(f);break}case 2:{m.statusText=f.string();break}case 3:{m.addr=f.bytes();break}default:{f.skipType(y&7);break}}}return m})),u),l.encode=f=>_e(f,l.codec()),l.decode=(f,d)=>Se(f,l.codec(),d)})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=Ae((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u,f={})=>{let d={},p=u==null?l.len:l.pos+u;for(;l.pos<p;){let m=l.uint32();switch(m>>>3){case 1:{d.type=r.MessageType.codec().decode(l);break}case 2:{d.dial=r.Dial.codec().decode(l,l.uint32(),{limits:f.limits?.dial});break}case 3:{d.dialResponse=r.DialResponse.codec().decode(l,l.uint32(),{limits:f.limits?.dialResponse});break}default:{l.skipType(m&7);break}}}return d})),c),r.encode=l=>_e(l,r.codec()),r.decode=(l,u)=>Se(l,r.codec(),u)})(xt||(xt={}));var O$=4,R$=8,Hy=class{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??qI}/${HI}/${WI}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??20,this.connectionThreshold=t.connectionThreshold??80,this.maxMessageSize=t.maxMessageSize??8192,this.dialResults=Gt({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=VI(this.findRandomPeers.bind(this),6e4),this.addressFilter=$r(1024)}[Symbol.toStringTag]="@libp2p/autonat";[He]=["@libp2p/autonat"];get[In](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;let t=Oe([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(let n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(o=>o.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout);let n=mt(e.stream,{maxDataLength:this.maxMessageSize}).pb(xt);try{let o=await n.read({signal:t}),i=await this.handleAutonatMessage(o,e.connection,{signal:t});await n.write(i,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(o){this.log.error("error handling incoming autonat stream - %e",o),e.stream.abort(o)}}async handleAutonatMessage(e,t,n){let o=this.components.addressManager.getAddresses().map(f=>f.toOptions().host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,a=i.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{let f=st(a.id);s=zt(f)}catch(f){return this.log.error("invalid PeerId - %e",f),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let c=a.addrs.map(f=>ie(f)).filter(f=>{let d=f.toOptions();return lo(f)?!1:d.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",f,t.remoteAddr),!1):o.includes(d.host)?!1:this.components.transportManager.dialTransportForMultiaddr(f)==null?(this.log.trace("not dialing %a - transport unsupported",f),!1):!0}).map(f=>(f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${s.toString()}`)),f));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",s),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(f=>f.toString()).join(", "),s);let l="",u=c[0];for(let f of c){let d;u=f;try{if(d=await this.components.connectionManager.openConnection(f,n),!d.remoteAddr.equals(f))throw this.log.error("tried to dial %a but dialed %a",f,d.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",s,f),{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.OK,addr:d.remoteAddr.decapsulateCode(co("p2p").code).bytes}}}catch(p){this.log.error("could not dial %p - %e",s,p),l=p.message}finally{d!=null&&await d.close()}}return{type:xt.MessageType.DIAL_RESPONSE,dialResponse:{status:xt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){let n=this.components.addressManager.getAddressesWithMetadata().sort((o,i)=>o.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||o.multiaddr.toOptions().family===6&&(!t||!qy(o.multiaddr))||lo(o.multiaddr)));for(let o of n){let i=o.multiaddr.toString(),s=this.dialResults.get(i);if(s!=null){if(s.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",s.multiaddr,e);continue}if(s.queue.size>10){this.log.trace("%a already has enough peers queued",s.multiaddr);continue}}if(s==null){let a=o.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),s={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:q5(),queue:new yr({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(i,s)}return s}}removeOutdatedMultiaddrResults(){let e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(let t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();let n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:s})=>s.toOptions().family===6),o=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(o,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async s=>{await this.askPeerToVerify(e,o,s)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(s=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,s)})}async askPeerToVerify(e,t,n){let o=this.dialResults.get(n.multiaddr.toString());if(o==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}let i=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);let s=await e.newStream(this.protocol,{signal:i});try{let a=mt(s).pb(xt),[,c]=await Promise.all([a.write({type:xt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==xt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}let l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==xt.ResponseStatus.OK&&l!==xt.ResponseStatus.E_DIAL_ERROR)return;if(o=this.dialResults.get(n.multiaddr.toString()),o==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(o.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(o.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(o.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(o.verifyingPeers.add(e.remotePeer),o.networkSegments.push(t),l===xt.ResponseStatus.OK){if(o.success++,o.type!=="observed"){this.confirmAddress(o);return}}else l===xt.ResponseStatus.E_DIAL_ERROR&&o.failure++;this.log("%a success %d failure %d",o.multiaddr,o.success,o.failure),o.success===O$&&this.confirmAddress(o),o.failure===R$&&this.unconfirmAddress(o)}finally{try{await s.close({signal:i})}catch(a){s.abort(a)}}}hasConnectionCapacity(){let t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){let t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}};function zI(r={}){return e=>new Hy(e,r)}var D$=ae("dns4"),N$=ae("dns6"),L$=ae("dnsaddr"),dl=$t(ae("dns"),L$,D$,N$),Gy=$t(ae("ip4"),ae("ip6")),_f=$t(Te(Gy,ae("tcp")),Te(dl,ae("tcp"))),Xy=Te(Gy,ae("udp")),B$=Te(Xy,ae("utp")),M$=Te(Xy,ae("quic")),U$=Te(Xy,ae("quic-v1")),G7=$t(Te(_f,ae("ws")),Te(dl,ae("ws"))),Wy=$t(Te(G7,ae("p2p")),G7),X7=$t(Te(_f,ae("wss")),Te(dl,ae("wss")),Te(_f,ae("tls"),ae("ws")),Te(dl,ae("tls"),ae("ws"))),zy=$t(Te(X7,ae("p2p")),X7),Y7=$t(Te(_f,ae("http")),Te(Gy,ae("http")),Te(dl,ae("http"))),Q7=$t(Te(_f,ae("https")),Te(Gy,ae("https")),Te(dl,ae("https"))),GI=Te(Xy,ae("webrtc-direct"),ae("certhash")),QI=$t(Te(GI,ae("p2p")),GI),XI=Te(U$,ae("webtransport"),ae("certhash"),ae("certhash")),ZI=$t(Te(XI,ae("p2p")),XI),JI=$t(Te(Wy,ae("p2p-webrtc-star"),ae("p2p")),Te(zy,ae("p2p-webrtc-star"),ae("p2p")),Te(Wy,ae("p2p-webrtc-star")),Te(zy,ae("p2p-webrtc-star"))),Qye=$t(Te(Wy,ae("p2p-websocket-star"),ae("p2p")),Te(zy,ae("p2p-websocket-star"),ae("p2p")),Te(Wy,ae("p2p-websocket-star")),Te(zy,ae("p2p-websocket-star"))),eC=$t(Te(Y7,ae("p2p-webrtc-direct"),ae("p2p")),Te(Q7,ae("p2p-webrtc-direct"),ae("p2p")),Te(Y7,ae("p2p-webrtc-direct")),Te(Q7,ae("p2p-webrtc-direct"))),pl=$t(G7,X7,Y7,Q7,JI,eC,_f,B$,M$,dl,QI,ZI),Zye=$t(Te(pl,ae("p2p-stardust"),ae("p2p")),Te(pl,ae("p2p-stardust"))),ma=$t(Te(pl,ae("p2p")),JI,eC,QI,ZI,ae("p2p")),YI=$t(Te(ma,ae("p2p-circuit"),ma),Te(ma,ae("p2p-circuit")),Te(ae("p2p-circuit"),ma),Te(pl,ae("p2p-circuit")),Te(ae("p2p-circuit"),pl),ae("p2p-circuit")),tC=()=>$t(Te(YI,tC),YI),fl=tC(),rC=$t(Te(fl,ma,fl),Te(ma,fl),Te(fl,ma),fl,ma);var Jye=$t(Te(fl,ae("webrtc"),ae("p2p")),Te(fl,ae("webrtc")),Te(pl,ae("webrtc"),ae("p2p")),Te(pl,ae("webrtc")),ae("webrtc"));function nC(r){function e(t){let n;try{n=ie(t)}catch{return!1}let o=r(n.protoNames());return o===null?!1:o===!0||o===!1?o:o.length===0}return e}function Te(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(o=>(n=typeof o=="function"?o().partialMatch(t):o.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nC(e),partialMatch:e}}function $t(...r){function e(n){let o=null;return r.some(i=>{let s=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return s!=null?(o=s,!0):!1}),o}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:nC(e),partialMatch:e}}function ae(r){let e=r;function t(o){let i;try{i=ie(o)}catch{return!1}let s=i.protoNames();return s.length===1&&s[0]===e}function n(o){return o.length===0?null:o[0]===e?o.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var F$="bootstrap",j$=50,K$=1e3,Z7=class extends De{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??K$,this.list=[];for(let n of t.list){if(!rC.matches(n)){this.log.error("Invalid multiaddr");continue}let o=ie(n),i=o.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let s={id:Ct(i),multiaddrs:[o]};this.list.push(s)}this._init=t}[Ya]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[He]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??F$]:{value:this._init.tagValue??j$,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function oC(r){return e=>new Z7(e,r)}var J7=1e3,iC=60*J7,sC=290;var cge=120*iC,aC=1,Yy=2e3,cC=100;var ih=`${js}-circuit-relay`,lge=`${js}-circuit-relay-source`,uge=2*iC,fge=BigInt(1<<17),hl="/libp2p/circuit/relay/0.2.0/hop",ew="/libp2p/circuit/relay/0.2.0/stop",dge=30*J7,pge=30*J7,tw=300,lC=4096,uC=.001;var ya;(function(r){let e;(function(o){o.RESERVE="RESERVE",o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.RESERVE=0]="RESERVE",o[o.CONNECT=1]="CONNECT",o[o.STATUS=2]="STATUS"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),Af.codec().encode(o.peer,i)),o.reservation!=null&&(i.uint32(26),Qy.codec().encode(o.reservation,i)),o.limit!=null&&(i.uint32(34),Tf.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(40),_r.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=Af.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.reservation=Qy.codec().decode(o,o.uint32(),{limits:s.limits?.reservation});break}case 4:{a.limit=Tf.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 5:{a.status=_r.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(ya||(ya={}));var Ii;(function(r){let e;(function(o){o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.CONNECT=0]="CONNECT",o[o.STATUS=1]="STATUS"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),Af.codec().encode(o.peer,i)),o.limit!=null&&(i.uint32(26),Tf.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(32),_r.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=Af.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.limit=Tf.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 4:{a.status=_r.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(Ii||(Ii={}));var Af;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:Ce(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new lt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Af||(Af={}));var Qy;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),Jy.codec().encode(t.voucher,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new lt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=Jy.codec().decode(t,t.uint32(),{limits:o.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Qy||(Qy={}));var Tf;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Tf||(Tf={}));var _r;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(_r||(_r={}));var rw;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(rw||(rw={}));(function(r){r.codec=()=>_t(rw)})(_r||(_r={}));var Zy;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={relay:Ce(0),peer:Ce(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Zy||(Zy={}));var Jy;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),Zy.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:Ce(0),payloadType:Ce(0),signature:Ce(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=Zy.codec().decode(t,t.uint32(),{limits:o.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Jy||(Jy={}));var sh=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},eg=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},tg=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function nw(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var ah=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},rg=it(Xe($0.matchers[0],at(290))),ng=it(at(290));function ow(r){let{stream:e,remoteAddr:t,logger:n,onDataRead:o,onDataWrite:i}=r,s=n.forComponent("libp2p:stream:converter"),a=!1,c=!1,l=e.close.bind(e);e.close=async m=>{await l(m),p(!0)};let u=e.abort.bind(e);e.abort=m=>{u(m),p(!0)};let f=e.sink.bind(e);e.sink=async m=>{try{await f(ln(m,g=>cc(g,y=>i?.(y))))}catch(g){g.type!=="aborted"&&s.error("%s error in sink",t,g)}finally{c=!0,p()}};let d={log:s,sink:e.sink,source:async function*(){try{for await(let m of e.source)o?.(m),yield m}finally{a=!0,p()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function p(m){m===!0&&(a=!0,c=!0),a&&c&&d.timeline.close==null&&(d.timeline.close=Date.now())}return d}var og=class extends De{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(hl,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(hl)],orders:[()=>Math.random()<.5?1:-1,(n,o)=>{let i=fC(n),s=fC(o);return i>s?-1:s>i?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new yr({concurrency:5});this.log("start random walk");for await(let n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(o=>o.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",n.id,o)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;let t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,o)})}async dialPeer({peerId:e,signal:t}){let n=Oe([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}};function fC(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date(W(e)).getTime()}var iw=class extends De{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Yy,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(ng.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(rg.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),o=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(o.remotePeer)){this.log("making reservation on peer %p",o.remotePeer);let i=await this.reservationStore.addRelay(o.remotePeer,"configured");this.addedRelay(i)}}else throw new Ja(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>ie(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function dC(r){return new iw(r)}var pC="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var hC=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=pC[t[r]&63];return e};var $$=60*1e3*10,V$=60*1e3*5,q$=30*1e3,ig=class extends De{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Vr,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??cC,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Yy,this.started=!1,this.relayFilter=$r(100),this.reserveQueue=new yr({concurrency:t?.reservationConcurrency??aC,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(ih)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[ih]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=hC();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Ja("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new tg("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Ja("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let o=Date.now();try{let i=this.reservations.get(e);if(i!=null){let m=this.connectionManager.getConnections(e),g=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(y=>y.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),g=!0),g&&nw(i.reservation.expire)>$$)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new sh("Not making reservation on discovered relay because we do not need any more relays");let s=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:s});if(fn.matches(a.remoteAddr))throw new eg("not creating reservation over relayed connection");let c=await this.#e(a,{signal:s}),l=nw(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());let u=Math.min(Math.max(l-V$,q$),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u),d;if(t==="discovered"){let m=this.pendingReservations.pop();if(m==null)throw new sh("Made reservation on relay but did not need any more discovered relays");d={timeout:f,reservation:c,type:t,connection:a.id,id:m}}else d={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,d),await this.peerStore.merge(e,{tags:{[ih]:{value:1,ttl:l}}}),this.#r();let p={relay:e,details:d};return this.safeDispatchEvent("relay:created-reservation",{detail:p}),p}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-o,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(s=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,s)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(hl,t),i=mt(n).pb(ya);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:ya.Type.RESERVE},t);let s;try{this.log.trace("reading response from %p",e.remotePeer),s=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",s),s.status===_r.OK&&s.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let l of s.reservation.addrs){let u=ie(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=ie(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return s.reservation.addrs=[...c].map(l=>ie(l).bytes),s.reservation}let a=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[ih]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=$r(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var H$=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(ie)}catch{return!1}return!0},mC={maxInboundStopStreams:tw,maxOutboundStopStreams:tw,stopTimeout:3e4},sg=class{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??mC.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??mC.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new og(e,{filter:t.discoveryFilter??H5(lC,uC)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(o=>{o.name!=="HadEnoughRelaysError"&&o.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,o)})}),this.reservationStore=new ig(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[He]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[In](){return this.discovery!=null?["@libp2p/identify"]:[]}[Ks]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(ew,e=>{let t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await pr(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Nr(this.discovery,this.reservationStore),await this.registrar.unhandle(ew),this.started=!1}async dial(e,t){if(e.protoCodes().filter(p=>p===sC).length!==1){let p="Invalid circuit relay address";throw this.log.error(p,e),new $i(p)}let n=e.toString().split("/p2p-circuit"),o=ie(n[0]),i=ie(n[n.length-1]),s=o.getPeerId(),a=i.getPeerId();if(s==null||a==null){let p=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${p}`),new $i(`C${p}`)}let c=Ct(s),l=Ct(a),f=this.connectionManager.getConnections(c)[0];f==null?(await this.peerStore.merge(c,{multiaddrs:[o]}),t.onProgress?.(new ce("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new ce("circuit-relay:reuse-connection"));let d;try{t.onProgress?.(new ce("circuit-relay:open-hop-stream")),d=await f.newStream(hl,t);let p=mt(d),m=p.pb(ya);t.onProgress?.(new ce("circuit-relay:write-connect-message")),await m.write({type:ya.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[ie(i).bytes]}},t),t.onProgress?.(new ce("circuit-relay:read-connect-response"));let g=await m.read(t);if(g.status!==_r.OK)throw new Be(`failed to connect via relay with status ${g?.status?.toString()??"undefined"}`);let y=new ah(g.limit),b=ow({stream:p.unwrap(),remoteAddr:e,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:y.onData,onDataWrite:y.onData});return this.log("new outbound relayed connection %a",b.remoteAddr),await this.upgrader.upgradeOutbound(b,{...t,limits:y.getLimits()})}catch(p){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,p),d?.abort(p),p}}createListener(e){return dC({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>rg.exactMatch(t)||ng.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>fn.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}let o=mt(t).pb(Ii),i=await o.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await o.write({type:Ii.Type.STATUS,status:_r.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==Ii.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await o.write({type:Ii.Type.STATUS,status:_r.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!H$(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await o.write({type:Ii.Type.STATUS,status:_r.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}let s=zt(st(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,s)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await o.write({type:Ii.Type.STATUS,status:_r.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await o.write({type:Ii.Type.STATUS,status:_r.OK},{signal:n});let a=new ah(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),l=this.addressManager.getAddresses()[0],u=ow({stream:o.unwrap().unwrap(),remoteAddr:c,localAddr:l,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}};function sw(r={}){return e=>new sg(e,r)}var ti;(function(r){let e;(function(o){o.UNUSED="UNUSED",o.CONNECT="CONNECT",o.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.UNUSED=0]="UNUSED",o[o.CONNECT=100]="CONNECT",o[o.SYNC=300]="SYNC"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.observedAddresses!=null)for(let a of o.observedAddresses)i.uint32(18),i.bytes(a);s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={observedAddresses:[]},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{if(s.limits?.observedAddresses!=null&&a.observedAddresses.length===s.limits.observedAddresses)throw new lt('Decode error - map field "observedAddresses" had too many elements');a.observedAddresses.push(o.bytes());break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(ti||(ti={}));function aw(r,e){return fn.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:bp.matches(r)?!0:B_.matches(r)?Jr(r.toOptions().host)===!1:!1}var yC=1024*4,gC=100,ag={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},cg=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??ag.timeout,this.retries=t.retries??ag.retries,this.maxInboundStreams=t.maxInboundStreams??ag.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??ag.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[In]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(ch,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{fn.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(ch,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(ch),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let o={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([ch],{signal:o.signal,runOnLimitedConnection:!0});let i=mt(t,{maxDataLength:yC}).pb(ti);this.log("B sending connect to %p",e.remotePeer);let s=Date.now();await i.write({type:ti.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},o),this.log("B receiving connect from %p",e.remotePeer);let a=await i.read(o);if(a.type!==ti.Type.CONNECT)throw this.log("A sent wrong message type"),new Be("DCUtR message type was incorrect");let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let l=Date.now()-s;this.log("A sending sync, rtt %dms",l),await i.write({type:ti.Type.SYNC,observedAddresses:[]},o),this.log("A waiting for half RTT"),await N2(l/2),this.log("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:o.signal,priority:gC,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(o);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(o)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(o=>{let i=o.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(o=>aw(o,this.transportManager));if(n.length>0){let o=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let i=await this.connectionManager.openConnection(n,{signal:o,force:!0});if(fn.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:o}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let o=mt(e,{maxDataLength:yC}).pb(ti);this.log("A receiving connect");let i=await o.read(n);if(i.type!==ti.Type.CONNECT)throw this.log("B sent wrong message type"),new Be("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let s=this.getDialableMultiaddrs(i.observedAddresses);if(s.length===0)throw this.log("B had no dialable multiaddrs"),new Be("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await o.write({type:ti.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await o.read(n)).type!==ti.Type.SYNC)throw new Be("DCUtR message type was incorrect");this.log("A dialing",s);let c=await this.connectionManager.openConnection(s,{signal:n.signal,priority:gC,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(o){this.log.error("incoming DCUtR from %p failed",t.remotePeer,o),e.abort(o)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let o=ie(n);if(!aw(o,this.transportManager))continue;t.push(o)}catch{}return t}};var ch="/libp2p/dcutr";function wC(r={}){return e=>new cg(e,r)}var bC="0.1.0";var vC="id/push",xC="1.0.0",EC="1.0.0";var ga;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(o.limits?.listenAddrs!=null&&i.listenAddrs.length===o.limits.listenAddrs)throw new lt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(o.limits?.protocols!=null&&i.protocols.length===o.limits.protocols)throw new lt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(ga||(ga={}));var yn={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:32};function SC(r){if(r!=null&&r.length>0)try{return ie(r)}catch{}}function G$(r,e){return e??r.userAgent}async function lg(r,e,t,n,o){if(t("received identify from %p",n.remotePeer),o==null)throw new Be("message was null or undefined");let i={};if(o.listenAddrs.length>0&&(i.addresses=o.listenAddrs.map(c=>({isCertified:!1,multiaddr:ie(c)}))),o.protocols.length>0&&(i.protocols=o.protocols),o.publicKey!=null){let c=jt(o.publicKey);if(!vi(c).equals(n.remotePeer))throw new Be("public key did not match remote PeerId");i.publicKey=c}let s;if(o.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=o.signedPeerRecord,l=await $n.openAndCertify(c,en.DOMAIN),u=en.createFromProtobuf(l.payload),f=Vo(l.publicKey.toCID());if(!u.peerId.equals(f))throw new Be("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new Be("signing key does not match remote PeerId");let d;try{d=await r.get(u.peerId)}catch(p){if(p.name!=="NotFoundError")throw p}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){let p=$n.createFromProtobuf(d.peerRecordEnvelope),m=en.createFromProtobuf(p.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(p=>({isCertified:!0,multiaddr:p})),s={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),o.agentVersion!=null||o.protocolVersion!=null){let c={};o.agentVersion!=null&&(c.AgentVersion=q(o.agentVersion)),o.protocolVersion!=null&&(c.ProtocolVersion=q(o.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:o.protocolVersion,agentVersion:o.agentVersion,publicKey:o.publicKey,listenAddrs:o.listenAddrs.map(c=>ie(c)),observedAddr:o.observedAddr==null?void 0:ie(o.observedAddr),protocols:o.protocols,signedPeerRecord:s,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var If=class{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??yn.timeout,this.maxInboundStreams=t.maxInboundStreams??yn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??yn.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??yn.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??yn.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??yn.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??yn.protocolPrefix}/${bC}`,agentVersion:G$(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:q(this.host.agentVersion),ProtocolVersion:q(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}};var ug=class extends If{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??yn.protocolPrefix}/${vC}/${EC}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??yn.concurrency,this._push=qi(this.sendPushMessage.bind(this),t.debounce??1e3),(t.runOnSelfUpdate??yn.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(o=>{this.log.error("error pushing updates to peers - %e",o)})})}[He]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{let e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(co("p2p").code)),t=new en({peerId:this.peerId,multiaddrs:e}),n=await $n.seal(t,this.privateKey),o=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),s=W(i.metadata.get("AgentVersion")??q(this.host.agentVersion)),a=W(i.metadata.get("ProtocolVersion")??q(this.host.protocolVersion)),c=this;async function*l(){for(let u of c.connectionManager.getConnections())(await c.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let d,p=AbortSignal.timeout(c.timeout);try{d=await u.newStream(c.protocol,{signal:p,runOnLimitedConnection:c.runOnLimitedConnection}),await mt(d,{maxDataLength:c.maxMessageSize}).pb(ga).write({listenAddrs:e.map(g=>g.bytes),signedPeerRecord:n.marshal(),protocols:o,agentVersion:s,protocolVersion:a},{signal:p}),await d.close({signal:p})}catch(m){c.log.error("could not push identify update to peer",m),d?.abort(m)}})}await an(ws(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let o={signal:AbortSignal.timeout(this.timeout)},s=await mt(n,{maxDataLength:this.maxMessageSize}).pb(ga).read(o);await n.close(o),await lg(this.peerStore,this.events,this.log,t,s)}catch(o){this.log.error("received invalid message",o),n.abort(o);return}this.log.trace("handled push from %p",t.remotePeer)}};var fg=class extends If{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??yn.protocolPrefix}/${"id"}/${xC}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??yn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let o=n.detail;this.identify(o).catch(i=>{i.name!==Ki.name&&this.log.error("error during identify trigged by connection:open",i)})})}[He]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){let o=AbortSignal.timeout(this.timeout);t={...t,signal:o}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let i=await mt(n,{maxDataLength:this.maxMessageSize}).pb(ga).read(t);return await n.close(t),i}catch(o){throw n?.abort(o),o}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:o,protocols:i,observedAddr:s}=n;if(o==null)throw new Be("public key was missing from identify message");let a=jt(o),c=Vo(a.toCID());if(!e.remotePeer.equals(c))throw new Be("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new Be("identified peer is our own peer id?");return this.maybeAddObservedAddress(s),this.log("identify completed for peer %p and protocols %o",c,i),lg(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){let t=SC(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),lo(t)){this.log.trace("our observed address was private");return}let n=t.getComponents();if((n[0].code===41||n[0].code===42&&n[1].code===41)&&!qy(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Mc.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){let{connection:t,stream:n}=e,o=AbortSignal.timeout(this.timeout);try{let i=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map(u=>u.decapsulateCode(co("p2p").code)),a=i.peerRecordEnvelope;if(s.length>0&&a==null){let u=new en({peerId:this.peerId,multiaddrs:s});a=(await $n.seal(u,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;L_.matches(t.remoteAddr)||(c=void 0),await mt(n).pb(ga).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:cr(this.privateKey.publicKey),listenAddrs:s.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:o}),await n.close({signal:o})}catch(i){this.log.error("could not respond to identify request",i),n.abort(i)}}};function _C(r={}){return e=>new fg(e,r)}function AC(r={}){return e=>new ug(e,r)}var ml=1e3,cw=60*ml,lh=60*cw,TC=36*lh,IC="/ipfs/kad/1.0.0",CC=48*lh;var PC=24*lh,kC=10,OC=16384,RC=lh,lw=lh,T4e=10*ml,DC=10*ml;var dg=20,wa=10,NC=5*cw,LC=ml,BC=5*ml,MC=5*cw,UC=30*ml,FC=180*ml,uw=`${js}-kad-dht`;var uh;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={key:Ce(0),value:Ce(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(uh||(uh={}));function jC(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),o=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),s=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${o}:${i}:${s}.${c}Z`}function KC(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),o=parseInt(t[2],10)-1,i=parseInt(t[3],10),s=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,o,i,s,a,c,l))}var Ar=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return uh.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:jC(this.timeReceived)}}static deserialize(e){let t=uh.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=KC(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var ba=class extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}},pg=class extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}},hg=class extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}};var $C;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})($C||($C={}));var et;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(et||(et={}));var mg;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(mg||(mg={}));(function(r){r.codec=()=>_t(mg)})(et||(et={}));var Pf;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Pf||(Pf={}));var fw;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(fw||(fw={}));(function(r){r.codec=()=>_t(fw)})(Pf||(Pf={}));var Cf;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),Pf.codec().encode(t.connection,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:Ce(0),multiaddrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.multiaddrs!=null&&i.multiaddrs.length===o.limits.multiaddrs)throw new lt('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=Pf.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(Cf||(Cf={}));var va;(function(r){let e;r.codec=()=>(e==null&&(e=Ae((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.type!=null&&mg[t.type]!==0&&(n.uint32(8),et.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let i of t.closer)n.uint32(66),Cf.codec().encode(i,n);if(t.providers!=null)for(let i of t.providers)n.uint32(74),Cf.codec().encode(i,n);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={type:et.PUT_VALUE,closer:[],providers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.type=et.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(o.limits?.closer!=null&&i.closer.length===o.limits.closer)throw new lt('Decode error - map field "closer" had too many elements');i.closer.push(Cf.codec().decode(t,t.uint32(),{limits:o.limits?.closer$}));break}case 9:{if(o.limits?.providers!=null&&i.providers.length===o.limits.providers)throw new lt('Decode error - map field "providers" had too many elements');i.providers.push(Cf.codec().decode(t,t.uint32(),{limits:o.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>_e(t,r.codec()),r.decode=(t,n)=>Se(t,r.codec(),n)})(va||(va={}));function dw(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function fh(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function yg(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function ri(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function pw(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function dh(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function hw(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function VC(r,e={}){let t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function qC(r,e,t){if(t.length===0)throw new M("No records given");let o=W(e).split("/");if(o.length<3)throw new M("Record key does not have a selector function");let i=r[o[1].toString()];if(i==null)throw new hg(`No selector function configured for key type "${o[1]}"`);return t.length===1?0:i(e,t)}function Z$(r,e){return 0}var HC={pk:Z$};async function kf(r,e,t){let n=e.key,i=W(n).split("/");if(i.length<3)return;let s=r[i[1].toString()];if(s==null)throw new M(`No validator available for key type "${i[1]}"`);await s(n,e.value,t)}var J$=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new M('"key" must be a Uint8Array');if(r.byteLength<5)throw new M("Invalid public key record");if(W(r.subarray(0,4))!=="/pk/")throw new M("key was not prefixed with /pk/");let o=jt(e),i=r.slice(4);if(!me(i,o.toMultihash().bytes))throw new M("public key does not match passed in key")},WC={pk:J$};var eV=q("/pk/");function zC(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let o=Jr(n);return o==null?!0:!o})}}async function xa(r,e){let t=await wt.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function gn(r,e){return xa(r.toMultihash().bytes,e)}function Ea(r,e){return new ct(`${r}/${W(e,"base32")}`,!1)}function GC(r){return St([eV,r.toMultihash().bytes])}function XC(r){return W(r.subarray(0,4))==="/pk/"}function YC(r){let e=st(r.subarray(4));return zt(e)}function mw(r,e){let t=new Date;return new Ar(r,e,t).serialize()}var tV=290,rV=54,nV=55,oV=56,iV=4,sV=41;function QC(r){let e=r.stringTuples();for(let t of e)if(t[0]===tV)return!1;if(e[0][0]===rV||e[0][0]===nV||e[0][0]===oV)return!0;if(e[0][0]===iV||e[0][0]===sV){let t=Jr(`${e[0][1]}`);return t==null||!t}return!1}function gg(r){let e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:ue.createV1(rc,st(q(n,"base32"))),peerId:Ct(t)}}function wg(r,e,t){let n=typeof e=="string"?e:W(e.multihash.bytes,"base32"),o=[r,n];return t!=null&&o.push(t.toString()),new ct(o.join("/"))}function bg(r){return new Date(Fo(r))}function yl(r,e,t){return async function*(...n){let o=e.queryTime?.timer(t),i=e.errorTime?.timer(t),s=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}function vg(r,e,t){return async function(...n){let o=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t),s=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}var xg=class{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){let{validators:n,selectors:o,peerRouting:i,queryManager:s,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=o,this.peerRouting=i,this.queryManager=s,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);let n=Ea(this.datastorePrefix,e);this.log("fetching record for key %k",n);let o=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);let i=Ar.deserialize(o);return await kf(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,o){this.log("sendCorrection for %b",e);let i=mw(e,n);for(let{value:s,from:a}of t){if(me(s,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Ea(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray(),o)}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l={type:et.PUT_VALUE,key:e,record:i};for await(let u of this.network.sendRequest(a,l,o))u.name==="PEER_RESPONSE"&&u.record!=null&&me(u.record.value,Ar.deserialize(i).value)&&(c=!0),yield u;if(!c)throw new ba("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);let o=mw(e,t),i=Ea(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,o.subarray(),n),yield*ln(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),s=>oo(s,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:et.PUT_VALUE,key:e,record:o};this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&me(u.record.value,Ar.deserialize(o).value)||c.push(ri({from:a.peer.id,error:new ba("Value not put correctly"),path:u.path},n)));return c}),s=>ws(s,{ordered:!1,concurrency:wa}),async function*(s){for await(let a of s)yield*a})}async*get(e,t){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;let o=n.map(a=>a.value),i=0;try{i=qC(this.selectors,e,o)}catch(a){if(a.name!=="InvalidParametersError")throw a}let s=o[i];if(this.log("GetValue %b %b",e,s),s==null)throw new qe("Best value was not found");yield*this.sendCorrectionRecord(e,n,s,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let i=await this.getLocal(e,t);yield dh({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}let n=this,o=async function*({peer:i,signal:s,path:a}){for await(let c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:s,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield dh({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,o,t)}};function ZC(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function ph(r){if(r.id==null)throw new Error("Invalid peer in message");let e=st(r.id);return{id:zt(e),multiaddrs:(r.multiaddrs??[]).map(t=>ie(t))}}var Eg=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:o,queryManager:i,routingTable:s,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=o,this.queryManager=i,this.routingTable=s,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(f=>f.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);let o=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);let i={type:et.ADD_PROVIDER,key:o,providers:[ZC({id:this.components.peerId,multiaddrs:t})]},s=0,a=this;async function*c(f){try{a.log("sending provider record for %s to %p",e,f.peer.id);for await(let d of a.network.sendMessage(f.peer.id,i,{...n,path:f.path}))d.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,f.peer.id),s++),yield d}catch(d){a.log.error("error sending provide record to peer %p",f.peer.id,d),yield ri({from:f.peer.id,error:d,path:f.path},n)}}let l=sr({objectMode:!0}),u=new hr({concurrency:wa});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("error",f=>{this.log.error("error publishing provider record to peer - %e",f)}),u.add(async()=>{let f=[];for await(let d of this.peerRouting.getClosestPeers(o,n))l.push(d),d.name==="FINAL_PEER"&&f.push(d);f.forEach(d=>{u.add(async()=>{for await(let p of c(d))l.push(p)}).catch(p=>{this.log.error("error publishing provider record to peer - %e",p)})})}).catch(f=>{l.end(f)}),yield*l,this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,o=0,i=e.multihash.bytes,s=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e,t);if(a.length>0){let u=[];for(let f of a.slice(0,n))try{let d=await this.components.peerStore.get(f,t);u.push({id:f,multiaddrs:d.addresses.map(({multiaddr:p})=>p)})}catch(d){if(d.name!=="NotFoundError")throw d;this.log("no peer store entry for %p",f)}if(yield fh({from:this.components.peerId,messageType:et.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield pw({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),o+=u.length,o>=n)return}let c=async function*({peer:u,signal:f,path:d}){let p={type:et.GET_PROVIDERS,key:i};yield*s.network.sendRequest(u.id,p,{...t,signal:f,path:d})},l=new jn(a);for await(let u of this.queryManager.run(i,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);let f=[];for(let d of u.providers)l.has(d.id)||(l.add(d.id),f.push(d));if(f.length>0&&(yield pw({from:u.from,providers:f,path:u.path},t),o+=f.length,o>=n))return}}};var Sg=class extends De{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new Yo({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new M("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield hw({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield dw({to:e,type:o,path:n.path},n);let c=await this._writeReadMessage(i,t,n);i.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),i?.abort(l)}),yield fh({from:e,messageType:c.type,closer:c.closer.map(ph),providers:c.providers.map(ph),record:c.record==null?void 0:Ar.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield ri({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new M("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield hw({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield dw({to:e,type:o,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield fh({from:e,messageType:o,path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),yield ri({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,n){await mt(e).write(t,va,n)}async _writeReadMessage(e,t,n){let o=mt(e);await o.write(t,va,n);let i=await o.read(va,n);return i.closer.forEach(s=>{this.safeDispatchEvent("peer",{detail:ph(s)})}),i.providers.forEach(s=>{this.safeDispatchEvent("peer",{detail:ph(s)})}),i}};function gl(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}var Sa=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){let o=await gn(e.id,n);this.addWithKadId(e,o,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;let o={peer:e,distance:Jo(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){let s=this.peerDistances[this.peerDistances.length-1];if(s!=null&&gl(o.distance,s.distance)!==-1)return}let i=!1;for(let s=0;s<this.peerDistances.length;s++){let a=gl(this.peerDistances[s].distance,o.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(s,0,o);break}}i||this.peerDistances.push(o),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;let n=await gn(e,t),o=Jo(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return gl(o,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}};var _g=class{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n,o=await this.routingTable.find(e,t);if(o!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(o,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){let o={type:et.GET_VALUE,key:t};yield*this.network.sendRequest(e,o,n)}async*getPublicKeyFromNode(e,t={}){let n=GC(e),o={index:-1,queued:0,running:0,total:0};for await(let i of this._getValueSingle(e,n,{...t,path:o}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){let s=jt(i.record.value),a=vi(s);if(!a.equals(e))throw new ji("public key does not match id");if(a.publicKey==null)throw new ji("public key missing");yield dh({from:e,value:i.record.value,path:o},t)}throw new ba(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let o=await this.findPeerLocal(e,t);if(o!=null){this.log("found local"),yield yg({from:this.components.peerId,peer:o,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){let o=this,i=async function*({peer:s,signal:a,path:c}){let l={type:et.FIND_NODE,key:e.toMultihash().bytes};for await(let u of o.network.sendRequest(s.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(d=>d.id.equals(e));f!=null&&(yield yg({from:u.from,peer:f,path:u.path},t))}};for await(let s of this.queryManager.run(e.toMultihash().bytes,i,t))s.name==="FINAL_PEER"&&(n=!0),yield s}if(!n)throw new qe("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await xa(e,t),o=new Sa(n,this.routingTable.kBucketSize),i=this,s=async function*({peer:a,path:c,peerKadId:l,signal:u}){i.log("getClosestPeers asking %p",a.id);let f={type:et.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,f,{...t,signal:u,path:c}),o.addWithKadId(a,l,c)};yield*this.queryManager.run(e,s,t),this.log("found %d peers close to %b",o.length,e);for(let{peer:a,path:c}of o.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield yg({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(let o of this._getValueSingle(e,t,n)){if(o.name==="PEER_RESPONSE"&&o.record!=null)try{await this._verifyRecordOnline(o.record,n)}catch{let s="invalid record received, discarded";this.log(s),yield ri({from:o.from,error:new ba(s),path:n.path},n);continue}yield o}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new pg("invalid record received");await kf(this.validators,new Ar(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){let n=[];try{let s=st(e),a=zt(s),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}let o=await xa(e,t),i=this.routingTable.closestPeers(o,t);for(let s of i)try{n.push(await this.components.peerStore.getInfo(s,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}};var Ag=class{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){let o=wg(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(o,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);let n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){let o=wg(this.datastorePrefix,e,t),i=ur(n?.time?.getTime()??Date.now());await this.datastore.put(o,i,n)}async loadProviders(e,t){let n=new Vr,o=wg(this.datastorePrefix,e);for await(let i of this.datastore.query({prefix:o.toString()},t)){let{peerId:s}=gg(i.key);n.set(s,bg(i.value))}return n}};var cV=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function lV(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=cV(r),f=(...p)=>{let m=t.multiArgs?p:p[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(n(),i(c)))},d=p=>{n(),s(p)};n=()=>{for(let p of a)u(p,f);for(let p of t.rejectionEvents)u(p,d)};for(let p of a)l(p,f);for(let p of t.rejectionEvents)l(p,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Vi(o,{milliseconds:t.timeout});return i.cancel=n,i}return o}function JC(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=lV(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}async function*eP(r){let{key:e,startingPeers:t,ourPeerId:n,query:o,alpha:i,path:s,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:f}=r,d=sr({objectMode:!0}),p=new hr({concurrency:i,sort:(g,y)=>gl(g.options.distance,y.options.distance)});p.addEventListener("idle",()=>{d.push(VC({path:{index:s,queued:p.queued,running:p.running,total:p.size}},r)),d.end()}),p.addEventListener("error",g=>{c.error("error during query - %e",g.detail)});let m=()=>{p.abort(),d.end(new rr)};f.addEventListener("abort",m);try{let y=function(b,C){if(b==null)return;l.add(b.id.toMultihash().bytes);let D=Jo(C,g);p.add(async()=>{try{for await(let U of o({...r,key:e,peer:b,path:{index:s,queued:p.queued,running:p.running,total:p.size},numPaths:a,peerKadId:C,signal:f})){if(U.name==="PEER_RESPONSE")for(let X of U.closer){if(l.has(X.id.toMultihash().bytes)){c("already seen %p in query",X.id);continue}if(n.equals(X.id)){c("not querying ourselves");continue}if(!await u.isDialable(X.multiaddrs)){c("not querying undialable peer");continue}let K=await gn(X.id,{signal:f}),ee=Jo(K,g);if(gl(ee,D)!==-1){c("skipping %p as they are not closer to %b than %p",X.id,e,b);continue}c("querying closer peer %p",X.id),y(X,K)}d.push({...U,path:{index:s,queued:p.queued,running:p.running,total:p.size}})}}catch(U){d.push(ri({from:b.id,error:U,path:{index:s,queued:p.queued,running:p.running-1,total:p.size-1}},r))}},{distance:D}).catch(U=>{c.error("error during query - %e",U)})},g=await xa(e,{signal:f});await Promise.all(t.map(async b=>{y({id:b,multiaddrs:[]},await gn(b,{signal:f}))})),yield*d}finally{f.removeEventListener("abort",m)}}var Tg=class{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??dg,this.alpha=t.alpha??wa,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){let c=AbortSignal.timeout(FC);n={...n,signal:c}}let o=new AbortController,i=Oe([this.shutDownController.signal,o.signal,n.signal]);o.signal;let s=this.logger.forComponent(`${this.logPrefix}:query:`+W(e,"base58btc")),a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(s("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await JC(this.routingTable,"peer:add",{signal:i,filter:p=>!this.peerId.equals(p.detail)}),s("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(s("waiting for initial self query before continuing"),await nt(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),s("query:start");let c=await xa(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((p,m,g)=>(p[g%this.disjointPaths].push(m),p),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(p=>p.length>0);if(l.length===0){s.error("running query with no peers");return}let f=$r(1024),d=u.map((p,m)=>eP({...n,key:e,startingPeers:p,ourPeerId:this.peerId,signal:i,query:t,path:m,numPaths:u.length,alpha:this.alpha,log:s,peersSeen:f,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let p of Xr(...d)){if(p.name==="QUERY_ERROR"&&s.error("query error",p.error),p.name==="PEER_RESPONSE")for(let m of[...p.closer,...p.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:i})&&await this.routingTable.add(m.id,{signal:i});i.throwIfAborted(),yield p}a=!0}catch(c){if(this.running)throw c}finally{a||(s("query exited early"),o.abort()),i.clear(),s("query finished")}}};function uV(r){return r[Symbol.asyncIterator]!=null}function fV(r){if(uV(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var Ig=fV;var Cg=class{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??dg,this.interval=t.interval??NC,this.initialInterval=t.initialInterval??LC,this.queryTimeout=t.queryTimeout??BC,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=vg(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ve(),this.running){this.controller=new AbortController;let e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){let n=AbortSignal.timeout(this.queryTimeout);e.push(n)}let t=Oe(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),o=await ln(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>ia(s,this.count),async s=>Ig(s));t?.throwIfAborted();let i=Date.now()-n;this.log("self-query found %d peers in %dms",o,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:o,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};var Pg=class extends De{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new hr({concurrency:t.concurrency??kC,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Yo({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??PC,this.maxQueueSize=t.maxQueueSize??OC,this.validity=t.validity??CC,this.interval=t.interval??RC,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=vg(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(lw)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(let t of this.datastore.query({prefix:this.datastorePrefix},e))try{let{cid:n,peerId:o}=gg(t.key),i=bg(t.value).getTime(),s=i+this.validity,a=Date.now(),c=a>s;this.log.trace("comparing: %d < %d = %s %s",i,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key,e),this.peerId.equals(o)&&a-s<this.reprovideThreshold&&this.queueReprovide(n).catch(l=>{this.log.error("could not reprovide %c - %e",n,l)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(lw)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);let n=this.reprovideQueue.queue.find(o=>o.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async o=>{if(o.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);let i=this.reprovideTimeout.getTimeoutSignal(o);try{await this.reprovide(o.cid,o)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(o=>{this.log.error("could not re-provide key %c - %e",e,o)})}async reprovide(e,t){await an(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}};var dV=20,pV=5e3,hV="kad-close",mV=50,kg=class{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??pV,this.peerSetSize=t.peerSetSize??dV,this.closeTagName=t.closeTagName??hV,this.closeTagValue=t.closeTagValue??mV,this.closestPeers=new jn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;let e=await gn(this.components.peerId);this.newPeers=new Sa(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){let e=new jn(this.newPeers?.peers.map(({peer:o})=>o.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:{value:this.closeTagValue},[uw]:{value:1}}})}),...[...n].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:void 0,[uw]:void 0}})})])}};function hh(r){return Array.isArray(r?.peers)}var Og=class{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??tP,this.kBucketSize=t.kBucketSize??mh,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??rP,this.lastPingThreshold=t.lastPingThreshold??nP,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=ls({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await gn(e,t),lastPing:Date.now()}}async add(e,t){let n={peerId:e,kadId:await gn(e,t),lastPing:0},o=this.addingPeerMap.get(e);if(o!=null)return o;try{let i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){let n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!gV(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}let o=n.peers.filter(s=>!(s.peerId.equals(this.localPeer?.peerId)||s.lastPing>Date.now()-this.lastPingThreshold)).sort((s,a)=>s.lastPing<a.lastPing?-1:s.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing),i=!1;for await(let s of this.ping(o,t))i=!0,await this.remove(s.kadId,t);i&&await this._add(e,t)}*closest(e,t){let n=new Sa(e,t?.count??this.kBucketSize);for(let o of this.toIterable())t?.exclude?.some(i=>i.equals(o.peerId))!==!0&&n.addWithKadId({id:o.peerId,multiaddrs:[]},o.kadId);yield*oo(n.peers,({peer:o})=>o.id)}count(){function e(t){if(hh(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){let t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){let n=this._determineBucket(e),o=this._indexOf(n,e);if(o>-1){let i=n.peers.splice(o,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(hh(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+W(Jo(e,t),"base16"))}_determineBucket(e){let t=W(e,"base2");function n(o,i=0){return hh(o)?o:t[i]==="0"?n(o.left,i+1):n(o.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>me(n.kadId,t))}async _split(e,t){let n={prefix:"0",depth:e.depth+1,peers:[]},o={prefix:"1",depth:e.depth+1,peers:[]};for(let i of e.peers)W(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(o.peers.push(i),await this.onMove?.(i,e,o,t));yV(e,n,o)}};function yV(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function gV(r,e){return r.lastPing<Date.now()-e}var mh=20,tP=6;var wV=20,bV=100,rP=3;var vV=20,xV=100,oP="kad-peer",EV=1,nP=6e5,SV=!0,_V=1e3,Rg=class extends De{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??mh,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??oP,this.peerTagValue=t.peerTagValue??EV,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??SV,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??_V,this.shutdownController=new AbortController,this.pingOldContactQueue=new yr({concurrency:t.pingOldContactConcurrency??vV,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??xV}),this.pingOldContactTimeout=new Yo({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new yr({concurrency:t.pingNewContactConcurrency??wV,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??bV}),this.pingNewContactTimeout=new Yo({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new Og(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new kg(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await pr(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=Oe([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(let n of await this.components.peerStore.all({filters:[o=>o.protocols.includes(this.protocol)&&o.tags.has(oP)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await Nr(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;let n=[];for(let o of e){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{let i=this.pingOldContactQueue.find(o.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await i.join(t)?void 0:o;if(!await this.pingOldContactQueue.add(async a=>{let c=this.pingOldContactTimeout.getTimeoutSignal(),l=Oe([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(o,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:o.peerId,signal:t?.signal}))return o})}for await(let o of ws(n))o!=null&&(yield o)}async verifyNewContact(e,t){let n=this.pingNewContactTimeout.getTimeoutSignal(),o=Oe([n,this.shutdownController.signal,t?.signal]);try{let i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:o})):await this.pingNewContactQueue.add(async s=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,s)),{peerId:e.peerId,signal:o})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),o.clear()}}async pingContact(e,t){let n;try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(o){return this.log("error pinging old contact %p - %e",e.peerId,o),n?.abort(o),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){let n=await gn(e,t);return this.kb.get(n)?.peerId}closestPeer(e){let t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await gn(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,o=20,i=0;function s(a){if(hh(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<o&&(o=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}s(a.left),s(a.right)}s(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(o),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}};var iP=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var Dg=15,Ng=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:o,refreshInterval:i,refreshQueryTimeout:s,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=o,this.refreshInterval=i??MC,this.refreshQueryTimeout=s??UC,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");let n=this._maxCommonPrefix(),o=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${o.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(o.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e,t),this._numPeersForCpl(n)===0){let a=Math.min(2*(s+1),o.length-1);for(let c=s+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,o){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);let s=Oe([o?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{let a=await Ig(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:s}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Dg&&(e=Dg);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");let t=Zr(2),n=(t[1]<<8)+t[0],o=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=st(o);return zt(i)}_makePeerId(e,t,n){if(n>Dg)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Dg}`);let s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=s&a|t&~a,l=iP[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,wt.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=Jo(this.routingTable.kb.localPeer.kadId,e),n=0;for(let o of t)if(o===0)n++;else break;yield n}}};var Lg=class{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Be("Missing key");let n;try{n=ue.decode(t.key)}catch{throw new Be("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async o=>{let i=st(o.id),s=zt(i),a=o.multiaddrs.map(c=>ie(c));if(!e.equals(s)){this.log("invalid provider peer %p from %p",o.id,e);return}if(o.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,s),await this.peerStore.merge(s,{multiaddrs:a})}))}};var Bg=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Be("Invalid FIND_NODE message received - key was missing");let n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});me(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(co("p2p").code))});let o={type:et.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(s=>s.bytes)})),providers:[]};return o.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",o.closer.length,t.key,e),o}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}};var Mg=class{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:o,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=o,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Be("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=ue.decode(t.key)}catch{throw new Be("Invalid CID")}this.log("%p asking for providers for %s",e,n);let[o,i]=await Promise.all([Fc(oo(await this.providers.getProviders(n),async a=>{let c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),s={type:et.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:o.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",s.providers.length,s.closer.length),s}async _getAddresses(e){return[]}};var Ug=class{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Be("Invalid key");let o={type:et.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(XC(n)){this.log("is public key");let a=YC(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new qe("No public key found in key book");c=cr(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),o.record=new Ar(n,c,new Date).serialize(),o}let[i,s]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),o.record=i.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),o.closer=s.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),o}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=Ea(this.datastorePrefix,e),n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}let o=Ar.deserialize(n);if(o.timeReceived==null||Date.now()-o.timeReceived.getTime()>TC){await this.datastore.delete(t);return}return o}};var Fg=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var jg=class{components;validators;log;datastorePrefix;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){let o=`Empty record from: ${e.toString()}`;throw this.log.error(o),new Be(o)}try{let o=Ar.deserialize(t.record);await kf(this.validators,o),o.timeReceived=new Date;let i=Ea(this.datastorePrefix,o.key);await this.components.datastore.put(i,o.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(o){this.log("did not put record for key %b into datastore %o",n,o)}return t}};var Kg=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[et.GET_VALUE.toString()]:new Ug(e,t),[et.PUT_VALUE.toString()]:new jg(e,t),[et.FIND_NODE.toString()]:new Bg(e,t),[et.ADD_PROVIDER.toString()]:new Lg(e,t),[et.GET_PROVIDERS.toString()]:new Mg(e,t),[et.PING.toString()]:new Fg(e,t)}}async handleMessage(e,t){let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{let{stream:n,connection:o}=e,i=()=>{n.abort(new Qn)},s=AbortSignal.timeout(this.incomingMessageTimeout);s.addEventListener("abort",i);let a=mt(n).pb(va);try{for(;;){let c=await a.read({signal:s}),l=this.metrics?.rpcTime?.timer(c.type.toString()),u=this.metrics?.rpcTime?.timer(c.type.toString()),f=!1;try{this.log("incoming %s from %p",c.type,o.remotePeer);let d=await this.handleMessage(o.remotePeer,c);d!=null&&await a.write(d,{signal:s})}catch(d){throw f=!0,u?.(),d}finally{f||l?.()}s.removeEventListener("abort",i),s=AbortSignal.timeout(this.incomingMessageTimeout),s.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};var $g=class extends De{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:o}=t;this.components=e,this.log=e.logger.forComponent(`${o}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var yw=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await an(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await an(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new qe("Could not find value for key")}},gw=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new qe("Peer not found")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},AV=32,TV=64,Vg=class extends De{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();let n=t.logPrefix??"libp2p:kad-dht",o=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",s={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??mh,this.a=t.alpha??wa,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??IC,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??AV,this.maxOutboundStreams=t.maxOutboundStreams??TV,this.peerInfoMapper=t.peerInfoMapper??zC,this.onPeerConnectTimeout=t.onPeerConnectTimeout??DC,this.providers=new Ag(e,{...t.providers,logPrefix:n,datastorePrefix:o}),this.validators={...WC,...t.validators},this.selectors={...HC,...t.selectors},this.network=new Sg(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new Rg(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});let a=ve();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new Tg(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new _g(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new xg(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:o}),this.contentRouting=new Eg(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new Ng(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new Kg(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:o,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new $g(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new Cg(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:s}),this.reprovider=new Pg(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:o,contentRouting:this.contentRouting,operationMetrics:s}),this.network.addEventListener("peer",c=>{let l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{let l=c.detail;Promise.resolve().then(async()=>{let u=await this.components.peerStore.get(l),f={id:l,multiaddrs:u.addresses.map(({multiaddr:d})=>d),protocols:u.protocols};await this.onPeerConnect(f)}).catch(u=>{this.log.error("could not add %p to routing table - %e - %e",l,u)})}),this.dhtPeerRouting=new gw(this),this.dhtContentRouting=new yw(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let l=c.detail.peer.addresses.some(({multiaddr:f})=>QC(f)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=yl(this.get.bind(this),s,"GET_VALUE"),this.findProviders=yl(this.findProviders.bind(this),s,"FIND_PROVIDERS"),this.findPeer=yl(this.findPeer.bind(this),s,"FIND_PEER"),this.getClosestPeers=yl(this.getClosestPeers.bind(this),s,"GET_CLOSEST_PEERS"),this.provide=yl(this.provide.bind(this),s,"PROVIDE"),this.put=yl(this.put.bind(this),s,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[He]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[In]=["@libp2p/identify","@libp2p/ping"];get[ui](){return this.dhtContentRouting}get[fi](){return this.dhtPeerRouting}get[Ya](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}let t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await pr(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await pr(this.querySelf))}async stop(){this.running=!1,await Nr(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}};var sP;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(sP||(sP={}));function aP(r={}){return e=>new Vg(e,r)}var $e;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})($e||($e={}));var yh=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),ww=Object.freeze({NEW_STREAM:$e.NEW_STREAM,MESSAGE:$e.MESSAGE_INITIATOR,CLOSE:$e.CLOSE_INITIATOR,RESET:$e.RESET_INITIATOR}),cP=Object.freeze({MESSAGE:$e.MESSAGE_RECEIVER,CLOSE:$e.CLOSE_RECEIVER,RESET:$e.RESET_RECEIVER});var bw=1<<20,IV=4<<20,qg=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=bw,t=IV){this._buffer=new xe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Be("Unprocessed message queue size too large!");let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}let{id:n,type:o,length:i,offset:s}=this._headerInfo;if(this._buffer.length-s<i)break;let c={id:n,type:o};(o===$e.NEW_STREAM||o===$e.MESSAGE_INITIATOR||o===$e.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(s,s+i)),t.push(c),this._buffer.consume(s+i),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=uP(e),{value:o,offset:i}=uP(e,n),s=t&7;if(yh[s]==null)throw new Error(`Invalid type received: ${s}`);if(o>this._maxMessageSize)throw new Be("Message size too large");return{id:t>>3,type:s,offset:n+i,length:o}}},CV=128,lP=127;function uP(r,e=0){let t=0,n=0,o=e,i,s=r.length;do{if(o>=s||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(o++),t+=n<28?(i&lP)<<n:(i&lP)*Math.pow(2,n),n+=7}while(i>=CV);return e=o-e,{value:t,offset:e}}var vw=10*1024,xw=class{_pool;_poolOffset;constructor(){this._pool=Tt(vw),this._poolOffset=0}write(e,t){let n=this._pool,o=this._poolOffset;ur(e.id<<3|e.type,n,o),o+=Ke(e.id<<3|e.type),(e.type===$e.NEW_STREAM||e.type===$e.MESSAGE_INITIATOR||e.type===$e.MESSAGE_RECEIVER)&&e.data!=null?(ur(e.data.length,n,o),o+=Ke(e.data.length)):(ur(0,n,o),o+=Ke(0));let i=n.subarray(this._poolOffset,o);vw-o<100?(this._pool=Tt(vw),this._poolOffset=0):this._poolOffset=o,t.append(i),(e.type===$e.NEW_STREAM||e.type===$e.MESSAGE_INITIATOR||e.type===$e.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},PV=new xw;async function*fP(r){for await(let e of r){let t=new xe;PV.write(e,t),yield t}}var Hg=class extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}};var Ew=class extends ha{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?ww:cP,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:ww.NEW_STREAM,data:new xe(q(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function dP(r){let{id:e,name:t,send:n,onEnd:o,type:i="initiator",maxMsgSize:s=bw}=r;return new Ew({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:s,onEnd:o,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${i}:${e}`)})}var kV=1024,OV=1024,RV=1024*1024*4,DV=5,NV=500;function pP(r){let e={...r,type:`${yh[r.type]} (${r.type})`};return r.type===$e.NEW_STREAM&&(e.data=W(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===$e.MESSAGE_INITIATOR||r.type===$e.MESSAGE_RECEIVER)&&(e.data=W(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var Wg=class{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??NV,this.sink=this._createSink(),this._source=sr({objectMode:!0,onEnd:()=>{for(let n of this._streams.initiators.values())n.destroy();for(let n of this._streams.receivers.values())n.destroy()}}),this.source=ln(this._source,n=>fP(n)),this.closeController=new AbortController,this.rateLimiter=new cf({points:t.disconnectThreshold??DV,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new di("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,o=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:o})}_newStream(e){let{id:t,name:n,type:o,registry:i}=e;if(this.log("new %s stream %s",o,t),o==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??OV))throw new qs("Too many outbound streams open");if(i.has(t))throw new Error(`${o} stream ${t} already exists!`);let c=dP({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",o,t,pP(l)),this._source.push(l)},type:o,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",o,t,c.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,c),c}_createSink(){return async t=>{let n=()=>{Ky(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{let o=new qg(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let i of t)for(let s of o.write(i))await this._handleIncoming(s);this._source.end()}catch(o){this.log("error in sink",o),this._source.end(o)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",pP(e)),e.type===$e.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??kV)){this.log("too many inbound streams open"),this._source.push({id:t,type:$e.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:W(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){this.log("missing stream %s for message type %s",t,yh[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let s=this._init.maxStreamBufferSize??RV;try{switch(n){case $e.MESSAGE_INITIATOR:case $e.MESSAGE_RECEIVER:if(i.sourceReadableLength()>s)throw this._source.push({id:e.id,type:n===$e.MESSAGE_INITIATOR?$e.RESET_RECEIVER:$e.RESET_INITIATOR}),new Hg("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");i.sourcePush(e.data);break;case $e.CLOSE_INITIATOR:case $e.CLOSE_RECEIVER:i.remoteCloseWrite();break;case $e.RESET_INITIATOR:case $e.RESET_RECEIVER:i.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),i.abort(a)}}};var Sw=class{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[He]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new Wg(this.components,{...e,...this._init})}};function hP(r={}){return e=>new Sw(e,r)}var mP="1.0.0",yP="ping",gP="ipfs";var zg=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??gP}/${yP}/${mP}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[He]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now(),o=Hc(t),i=!1;Promise.resolve().then(async()=>{for(;;){let s=AbortSignal.timeout(this.timeout);s.addEventListener("abort",()=>{t?.abort(new Qn("ping timeout"))});let a=await o.read({bytes:32,signal:s});await o.write(a,{signal:s}),i=!0}}).catch(s=>{i&&s.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,s),t?.abort(s))}).finally(()=>{let s=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,s);let a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);let n=Date.now(),o=Zr(32),i=await this.components.connectionManager.openConnection(e,t),s;if(t.signal==null){let a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{s=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let a=Hc(s),[,c]=await Promise.all([a.write(o,t),a.read({...t,bytes:32})]),l=Date.now()-n;if(!me(o,c.subarray()))throw new C1(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",i.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),s?.abort(a),a}finally{s!=null&&await s.close(t)}}};function wP(r={}){return e=>new zg(e,r)}var zr;(function(r){let e;(function(o){o.FIN="FIN",o.STOP_SENDING="STOP_SENDING",o.RESET="RESET",o.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(o){o[o.FIN=0]="FIN",o[o.STOP_SENDING=1]="STOP_SENDING",o[o.RESET=2]="RESET",o[o.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.flag!=null&&(i.uint32(8),r.Flag.codec().encode(o.flag,i)),o.message!=null&&(i.uint32(18),i.bytes(o.message)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.flag=r.Flag.codec().decode(o);break}case 2:{a.message=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(zr||(zr={}));var bP=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],Aw=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),vP="libp2p+webrtc+v1/";var xP=466,EP=2*1024*1024,SP=30*1e3,Of=16*1024;function UV(r=Of){let e=Ke(r-Ke(r)),t=1+Ke(Object.keys(zr.Flag).length-1),n=1,o=r-e-t-n,i=Ke(o);return e+t+n+i}var _P=UV(),AP=5e3,TP=5e3,IP=3e4,Tw="/webrtc",gh="/webrtc-signaling/0.0.1",CP="/libp2p/webrtc-direct/certificate",PP="webrtc-direct-certificate-private-key";var kP=12096e5,Iw=864e5;var OP=function(r,e,t){if(t||arguments.length===2)for(var n=0,o=e.length,i;n<o;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},FV=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var jV=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}();var KV=function(){function r(e,t,n,o){this.name=e,this.version=t,this.os=n,this.bot=o,this.type="bot-device"}return r}();var $V=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var VV=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var qV=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,HV=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,RP=3,WV=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",qV]],DP=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function LP(r){return r?NP(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new VV:typeof navigator<"u"?NP(navigator.userAgent):XV()}function zV(r){return r!==""&&WV.reduce(function(e,t){var n=t[0],o=t[1];if(e)return e;var i=o.exec(r);return!!i&&[n,i]},!1)}function NP(r){var e=zV(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new $V;var o=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);o?o.length<RP&&(o=OP(OP([],o,!0),YV(RP-o.length),!0)):o=[];var i=o.join("."),s=GV(r),a=HV.exec(r);return a&&a[1]?new KV(t,i,s,a[1]):new FV(t,i,s)}function GV(r){for(var e=0,t=DP.length;e<t;e++){var n=DP[e],o=n[0],i=n[1],s=i.exec(r);if(s)return o}return null}function XV(){var r=typeof process<"u"&&process.version;return r?new jV(process.version.slice(1)):null}function YV(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var BP=LP(),wh=BP!=null&&BP.name==="firefox",Gg=async function*(){},Xg=async r=>{};function MP(r,e,t=IP,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let o=ve(),i=!1;r.bufferedAmountLowThreshold=0;let s=()=>{i||(n.log("%s drain channel closed before drain",e),o.resolve())};r.addEventListener("close",s,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",s),o.resolve()}),await Vi(o.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(o=>{n.log.error("error closing outbound stream",o)})}async function Cw(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??bP.map(e=>({urls:[e]})),r}var UP=(r=32)=>vP+[...Array(r)].map(()=>Aw.at(Math.floor(Math.random()*Aw.length))).join("");var wl=class{log;peerConnection;remoteAddr;timeline;metrics;source=Gg();sink=Xg;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let n=this.peerConnection,o=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",o),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var Pw=class extends ha{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){let t=e.onEnd;switch(e.onEnd=o=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Vi(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(o)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=sr(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??SP,this.maxBufferedAmount=e.maxBufferedAmount??EP,this.maxMessageSize=(e.maxMessageSize??Of)-_P,this.receiveFinAck=ve(),this.finAckTimeout=e.closeTimeout??AP,this.openTimeout=e.openTimeout??TP,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Za("Unknown datachannel state")}this.channel.onopen=o=>{this.timeline.open=new Date().getTime()},this.channel.onclose=o=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=o=>{this.log.trace("received onerror event"),this.closeController.abort();let i=o.error;this.abort(i)},this.channel.onmessage=async o=>{let{data:i}=o;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};let n=this;Promise.resolve().then(async()=>{for await(let o of cs(this.incomingData)){let i=n.processIncomingProtobuf(o);i!=null&&n.sourcePush(new xe(i))}}).catch(o=>{this.log.error("error processing incoming data channel messages",o)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Za(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){let n=AbortSignal.timeout(this.openTimeout),o=Oe([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Dt(this.channel,"open",o)}finally{o.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){let n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),o=Oe([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Dt(this.channel,"bufferedamountlow",o)}catch(i){throw n.aborted?new Qn(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{o.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){let t=e.byteLength;for(e=e.sublist();e.byteLength>0;){let n=Math.min(e.byteLength,this.maxMessageSize),o=e.subarray(0,n),i=zr.encode({message:o}),s=as.single(i);this.log.trace("sending %d/%d bytes on channel",o.byteLength,t),await this._sendMessage(s),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(zr.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(zr.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await nt(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(zr.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=zr.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===zr.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(zr.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===zr.Flag.RESET&&this.reset(),t.flag===zr.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===zr.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());let t=zr.encode({flag:e}),n=as.single(t);try{return await this._sendMessage(n,!1),!0}catch(o){this.log.error("could not send flag %s - %e",e.toString(),o)}return!1}};function Rf(r){let{channel:e,direction:t,handshake:n}=r;return new Pw({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}var _a=class{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??Tw,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}let o={},i=Rf({channel:n,direction:"inbound",onEnd:s=>{o.onEnd(s)},logger:e.logger,...this.dataChannelOptions});o.stream=i,o.channel=n,o.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(s=>s.stream.id!==i.id)},this.bufferedStreams.push(o)}}createStreamMuxer(e){return new kw(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},kw=class{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Tw,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}let o=n.id,i=Rf({channel:n,direction:"inbound",onEnd:()=>{this.#e(i,n),this.log("incoming channel %s ended",o)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),MP(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}source=Gg();sink=Xg;newStream(){let e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);let n=Rf({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}};var Yg=globalThis.RTCPeerConnection,Qg=globalThis.RTCSessionDescription,FP=globalThis.RTCIceCandidate;var Aa=class extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}},go=class extends Aa{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}};var Zg=class extends Aa{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}};var Jg=class extends Aa{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}},e3=class extends Aa{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}};var wn;(function(r){let e;(function(o){o.SDP_OFFER="SDP_OFFER",o.SDP_ANSWER="SDP_ANSWER",o.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.SDP_OFFER=0]="SDP_OFFER",o[o.SDP_ANSWER=1]="SDP_ANSWER",o[o.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(o){o.codec=()=>_t(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ae((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.data!=null&&(i.uint32(18),i.string(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.data=o.string();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>_e(o,r.codec()),r.decode=(o,i)=>Se(o,r.codec(),i)})(wn||(wn={}));var t3=async(r,e,t)=>{try{let n=ve();for(QV(r,n);;){let o=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(o==null){t.signal?.throwIfAborted();break}if(o.type!==wn.Type.ICE_CANDIDATE)throw new Be("ICE candidate message expected");let i=JSON.parse(o.data??"null");if(i===""||i===null){t.onProgress?.(new ce("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let s=new FP(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new ce("webrtc:add-ice-candidate",s.candidate)),await r.addIceCandidate(s)}catch(a){t.log.error("%s bad candidate received",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&r3(r)!=="connected")throw n}};function r3(r){return wh?r.iceConnectionState:r.connectionState}function QV(r,e){r[wh?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(r3(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Jl("RTCPeerConnection was closed"));break;default:break}}}async function jP({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:o,connectionManager:i,transportManager:s,log:a,logger:c,onProgress:l}){let{circuitAddress:u,targetPeer:f}=KP(o);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);let d=i.getConnections(f),p;d.length===0?(l?.(new ce("webrtc:dial-relay")),p=await s.dial(u,{signal:t,onProgress:l})):(l?.(new ce("webrtc:reuse-relay-connection")),p=d[0]),l?.(new ce("webrtc:open-signaling-stream"));let m=await p.newStream(gh,{signal:t,runOnLimitedConnection:!0}),g=mt(m).pb(wn),y=new Yg(r),b=new _a({logger:c},{peerConnection:y,dataChannelOptions:e});try{let C=y.createDataChannel("init");y.onicecandidate=({candidate:K})=>{let ee=JSON.stringify(K?.toJSON()??null);a.trace("initiator sending ICE candidate %o",K),g.write({type:wn.Type.ICE_CANDIDATE,data:ee},{signal:t}).catch($=>{a.error("error sending ICE candidate",$)})},y.onicecandidateerror=K=>{a.error("initiator ICE candidate error",K)};let D=await y.createOffer().catch(K=>{throw a.error("could not execute createOffer",K),new go("Failed to set createOffer")});a.trace("initiator send SDP offer %s",D.sdp),l?.(new ce("webrtc:send-sdp-offer")),await g.write({type:wn.Type.SDP_OFFER,data:D.sdp},{signal:t}),await y.setLocalDescription(D).catch(K=>{throw a.error("could not execute setLocalDescription",K),new go("Failed to set localDescription")}),l?.(new ce("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");let U=await g.read({signal:t});if(U.type!==wn.Type.SDP_ANSWER)throw new go("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",U.data);let X=new Qg({type:"answer",sdp:U.data});return await y.setRemoteDescription(X).catch(K=>{throw a.error("could not execute setRemoteDescription",K),new go("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new ce("webrtc:read-ice-candidates")),await t3(y,g,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),C.close(),l?.(new ce("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",o),{remoteAddress:o,peerConnection:y,muxerFactory:b}}catch(C){throw a.error("outgoing signaling error",C),y.close(),m.abort(C),C}finally{y.onicecandidate=null,y.onicecandidateerror=null}}var $P=it($0.matchers[0],at(290)),n3=class r extends De{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>$P.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r)).map(e=>e.getAddrs().filter(t=>$P.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}};async function VP({peerConnection:r,stream:e,signal:t,connection:n,log:o}){o.trace("new inbound signaling stream");let i=mt(e).pb(wn);try{r.onicecandidate=({candidate:u})=>{let f=JSON.stringify(u?.toJSON()??null);o.trace("recipient sending ICE candidate %s",f),i.write({type:wn.Type.ICE_CANDIDATE,data:f},{signal:t}).catch(d=>{o.error("error sending ICE candidate",d)})},o.trace("recipient read SDP offer");let a=await i.read({signal:t});if(a.type!==wn.Type.SDP_OFFER)throw new go(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);o.trace("recipient received SDP offer %s",a.data);let c=new Qg({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw o.error("could not execute setRemoteDescription",u),new go("Failed to set remoteDescription")});let l=await r.createAnswer().catch(u=>{throw o.error("could not execute createAnswer",u),new go("Failed to create answer")});o.trace("recipient send SDP answer %s",l.sdp),await i.write({type:wn.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw o.error("could not execute setLocalDescription",u),new go("Failed to set localDescription")}),o.trace("recipient read candidates until connected"),await t3(r,i,{direction:"recipient",signal:t,log:o})}catch(a){if(r3(r)!=="connected")throw o.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;o("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}let s=ie(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return o.trace("recipient connected to remote address %s",s),{remoteAddress:s}}var o3=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[Ks]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[He]=["@libp2p/transport"];[In]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(gh,e=>{let t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(gh),this._started=!1}createListener(e){return new n3(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Ep.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:o,muxerFactory:i}=await jP({rtcConfiguration:await Cw(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=new wl(this.components,{peerConnection:o,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(o,s),a}async _onProtocol({connection:e,stream:t},n){let o=new Yg(await Cw(this.init.rtcConfiguration)),i=new _a(this.components,{peerConnection:o,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s}=await VP({peerConnection:o,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});let a=new wl(this.components,{peerConnection:o,timeline:{open:new Date().getTime()},remoteAddr:s,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:n}),this._closeOnShutdown(o,a)}catch(s){throw this.log.error("incoming signaling error",s),o.close(),t.abort(s),s}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(o=>{this.log.error("could not close WebRTCMultiaddrConnection",o)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function KP(r){let e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new M("Destination peer id was missing");return{circuitAddress:ie(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:Ct(e)}}var OBe=tr(HP());var A;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(A||(A={}));var w;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(w||(w={}));var Ow=tr(vs()),Ci=class{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(Ow.BufferSourceConverter.isBufferSource(e))this.unusedBits=t,this.value=Ow.BufferSourceConverter.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Qo))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Qo({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Qo({name:e})}toNumber(){let e="",t=new Uint8Array(this.value);for(let n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2),n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;let o=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let i=0;for(;i<n;)o[i]=parseInt(t.slice(i<<3,(i<<3)+8),2),i++;this.value=o.buffer}};var Rw=tr(vs()),we=class{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):Rw.BufferSourceConverter.isBufferSource(e)?this.buffer=Rw.BufferSourceConverter.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof Hr))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new Hr({valueHex:this.buffer})}toSchema(e){return new Hr({name:e})}};var ZV={fromASN:r=>r instanceof mn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new mn;let e=Hn(r);if(e.result.error)throw new Error(e.result.error);return e.result}},JV={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new Vn({value:+r})},eq={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new Xc({value:r})},Ue={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Vn({valueHex:r})};var tq={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Qo({valueHex:r})},rq={fromASN:r=>r.valueBlock.toString(),toASN:r=>new qn({value:r})},nq={fromASN:r=>r.valueBlock.value,toASN:r=>new Gc({value:r})},Df={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Hr({valueHex:r})},WP={fromASN:r=>new we(r.getValue()),toASN:r=>r.toASN()};function wo(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}var Dw=wo(po),oq=wo(Yc),iq=wo(Qc),sq=wo(Zc),aq=wo(Jc),cq=wo(el),lq=wo(tl),uq=wo(rl),fq=wo(nl),dq=wo(fa),pq=wo(ol),hq=wo(il),mq={fromASN:r=>r.toDate(),toASN:r=>new da({valueDate:r})},yq={fromASN:r=>r.toDate(),toASN:r=>new sl({valueDate:r})},gq={fromASN:()=>null,toASN:()=>new mn};function Ta(r){switch(r){case w.Any:return ZV;case w.BitString:return tq;case w.BmpString:return oq;case w.Boolean:return nq;case w.CharacterString:return hq;case w.Enumerated:return eq;case w.GeneralString:return pq;case w.GeneralizedTime:return yq;case w.GraphicString:return fq;case w.IA5String:return uq;case w.Integer:return JV;case w.Null:return gq;case w.NumericString:return sq;case w.ObjectIdentifier:return rq;case w.OctetString:return Df;case w.PrintableString:return aq;case w.TeletexString:return cq;case w.UTCTime:return mq;case w.UniversalString:return iq;case w.Utf8String:return Dw;case w.VideotexString:return lq;case w.VisibleString:return dq;default:return null}}function bo(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:bo(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function Lw(r){var e;if(r){let t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Lw(t)}return!1}function zP(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}var i3=class{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){let n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){let t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){let t={type:A.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){let n=this.items.get(e)||this.createDefault(e),o=[];for(let i in n.items){let s=n.items[i],a=t?i:"",c;if(typeof s.type=="number"){let u=w[s.type],f=ho[u];if(!f)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new f({name:a})}else bo(s.type)?c=new s.type().toSchema(a):s.optional?this.get(s.type).type===A.Choice?c=new Ai({name:a}):(c=this.create(s.type,!1),c.name=a):c=new Ai({name:a});let l=!!s.optional||s.defaultValue!==void 0;if(s.repeated){c.name="";let u=s.repeated==="set"?tn:ht;c=new u({name:"",value:[new al({name:a,value:c})]})}if(s.context!==null&&s.context!==void 0)if(s.implicit)if(typeof s.type=="number"||bo(s.type)){let u=s.repeated?Zt:Ss;o.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:s.context}}))}else{this.cache(s.type);let u=!!s.repeated,f=u?c:this.get(s.type,!0).schema;f="valueBlock"in f?f.valueBlock.value:f.value,o.push(new Zt({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:f}))}else o.push(new Zt({optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}));else c.optional=l,o.push(c)}switch(n.type){case A.Sequence:return new ht({value:o,name:""});case A.Set:return new tn({value:o,name:""});case A.Choice:return new pf({value:o,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){let t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}};var Lt=new i3;var R=r=>e=>{let t;Lt.has(e)?t=Lt.get(e):(t=Lt.createDefault(e),Lt.set(e,t)),Object.assign(t,r)};var h=r=>(e,t)=>{let n;Lt.has(e.constructor)?n=Lt.get(e.constructor):(n=Lt.createDefault(e.constructor),Lt.set(e.constructor,n));let o=Object.assign({},r);if(typeof o.type=="number"&&!o.converter){let i=Ta(r.type);if(!i)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);o.converter=i}n.items[t]=o};var Ia=class extends Error{constructor(){super(...arguments),this.schemas=[]}};var bh=class{static parse(e,t){let n=Hn(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if(bo(t))return new t().fromASN(e);let n=Lt.get(t);Lt.cache(t);let o=n.schema,i=this.handleChoiceTypes(e,n,t,o);if(i?.result)return i.result;i?.targetSchema&&(o=i.targetSchema);let s=this.handleSequenceTypes(e,n,t,o);if(s&&"isManualMapping"in s)return s.result;let a=s,c=new t;return Lw(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,a,c),c)}catch(n){throw n instanceof Ia&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,o){if(e.constructor===Zt&&t.type===A.Choice&&e.idBlock.tagClass===3)for(let i in t.items){let s=t.items[i];if(s.context===e.idBlock.tagNumber&&s.implicit&&typeof s.type=="function"&&Lt.has(s.type)){let a=Lt.get(s.type);if(a&&a.type===A.Sequence){let c=new ht;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;let l=this.fromASN(c,s.type),u=new n;return u[i]=l,{result:u}}}}}else if(e.constructor===Zt&&t.type!==A.Choice){let i=new Zt({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(let s in t.items)delete e[s];return{targetSchema:i}}return null}static handleSequenceTypes(e,t,n,o){if(t.type===A.Sequence){if(Object.keys(t.items).filter(a=>{let c=t.items[a];return c.optional&&typeof c.type=="function"&&Lt.has(c.type)&&Lt.get(c.type).type===A.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&n.name==="CertReqMsg")return this.handleManualMapping(e,t,n);let s=xs({},e,o);if(!s.verified)throw new Ia(`Data does not match to ${n.name} ASN1 schema. ${s.result.error}`);return s}else{let i=xs({},e,o);if(!i.verified)throw new Ia(`Data does not match to ${n.name} ASN1 schema. ${i.result.error}`);return i}}static handleManualMapping(e,t,n){let o=new n,i=e.valueBlock.value,s=Object.keys(t.items),a=0;for(let c=0;c<s.length;c++){let l=s[c],u=t.items[l];if(a>=i.length)break;if(u.repeated){o[l]=this.processRepeatedField(i,a,u);break}else if(typeof u.type=="number")o[l]=this.processPrimitiveField(i[a],u),a++;else if(this.isOptionalChoiceField(u)){let f=this.processOptionalChoiceField(i[a],u);f.processed&&(o[l]=f.value,a++)}else o[l]=this.fromASN(i[a],u.type),a++}return{result:o,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,n){let o=e.slice(t);if(o.length===1&&o[0].constructor.name==="Sequence"){let i=o[0];i.valueBlock&&i.valueBlock.value&&Array.isArray(i.valueBlock.value)&&(o=i.valueBlock.value)}if(typeof n.type=="number"){let i=Ta(n.type);if(!i)throw new Error(`No converter for ASN.1 type ${n.type}`);return o.filter(s=>s&&s.valueBlock).map(s=>{try{return i.fromASN(s)}catch{return}}).filter(s=>s!==void 0)}else return o.filter(i=>i&&i.valueBlock).map(i=>{try{return this.fromASN(i,n.type)}catch{return}}).filter(i=>i!==void 0)}static processPrimitiveField(e,t){let n=Ta(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&Lt.has(e.type)&&Lt.get(e.type).type===A.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof Ia&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let o=t.itemType;if(typeof o=="number"){let i=Ta(o);if(!i)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,s=>i.fromASN(s))}else return n.from(e.valueBlock.value,i=>this.fromASN(i,o))}static processSchemaItems(e,t,n){for(let o in e.items){let i=t.result[o];if(!i)continue;let s=e.items[o],a=s.type;typeof a=="number"||bo(a)?n[o]=this.processPrimitiveSchemaItem(i,s,a):n[o]=this.processComplexSchemaItem(i,s,a)}}static processPrimitiveSchemaItem(e,t,n){var o;let i=(o=t.converter)!==null&&o!==void 0?o:bo(n)?new n:null;if(!i)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,i):this.processSinglePrimitiveItem(e,t,n,i)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){let o=t.repeated==="sequence"?ht:tn,i=new o;i.valueBlock=e.valueBlock;let s=Hn(i.toBER(!1));if(s.offset===-1)throw new Error(`Cannot parse the child item. ${s.result.error}`);if(!("value"in s.result.valueBlock&&Array.isArray(s.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let a=s.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,o=>n.fromASN(o))}static processSinglePrimitiveItem(e,t,n,o){let i=e;if(t.implicit){let s;if(bo(n))s=new n().toSchema("");else{let a=w[n],c=ho[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);s=new c}s.valueBlock=i.valueBlock,i=Hn(s.toBER(!1)).result}return o.fromASN(i)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,o=>this.fromASN(o,n))}else{let o=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(o,n)}catch(i){if(i instanceof Ia&&/Wrong values for Choice type/.test(i.message))return;throw i}else return this.fromASN(o,n)}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){let o=Lt.get(n);if(o.type===A.Sequence){let i=new ht;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}else if(o.type===A.Set){let i=new tn;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}}return e}};var vh=class r{static serialize(e){return e instanceof Qt?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&bo(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");let t=e.constructor,n=Lt.get(t);Lt.cache(t);let o=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){let s=Ta(n.itemType);if(!s)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);o=e.map(a=>s.toASN(a))}else o=e.map(s=>this.toAsnItem({type:n.itemType},"[]",t,s))}else for(let s in n.items){let a=n.items[s],c=e[s];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&zP(this.serialize(a.defaultValue),this.serialize(c)))continue;let l=r.toAsnItem(a,s,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||bo(a.type))){let u={};u.valueHex=l instanceof mn?l.valueBeforeDecodeView:l.valueBlock.toBER(),o.push(new Ss({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else o.push(new Zt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else o.push(new Zt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?o=o.concat(l):o.push(l)}let i;switch(n.type){case A.Sequence:i=new ht({value:o});break;case A.Set:i=new tn({value:o});break;case A.Choice:if(!o[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);i=o[0];break}return i}static toAsnItem(e,t,n,o){let i;if(typeof e.type=="number"){let s=e.converter;if(!s)throw new Error(`Property '${t}' doesn't have converter for type ${w[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let a=Array.from(o,l=>s.toASN(l)),c=e.repeated==="sequence"?ht:tn;i=new c({value:a})}else i=s.toASN(o)}else if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let s=Array.from(o,c=>this.toASN(c)),a=e.repeated==="sequence"?ht:tn;i=new a({value:s})}else i=this.toASN(o);return i}};var ge=class extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(let t of e)this.push(t)}}};var Bw=tr(vs());var J=class r{static serialize(e){return vh.serialize(e)}static parse(e,t){return bh.parse(e,t)}static toString(e){let t=Bw.BufferSourceConverter.isBufferSource(e)?Bw.BufferSourceConverter.toArrayBuffer(e):r.serialize(e),n=Hn(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}};function E(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var GP=tr(vs()),xh=class{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){let t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{let o=parseInt(n,10);if(isNaN(o)||o<0||o>255)throw new Error("Invalid IPv4 address part");return o})}static parseIPv6(e){let n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((o,i)=>{let s=parseInt(i,16);if(isNaN(s)||s<0||s>65535)throw new Error("Invalid IPv6 address part");return o.push(s>>8&255),o.push(s&255),o},[])}static expandIPv6(e){if(!e.includes("::"))return e;let t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");let n=t[0]?t[0].split(":"):[],o=t[1]?t[1].split(":"):[],i=8-(n.length+o.length);if(i<0)throw new Error("Invalid IPv6 address");return[...n,...Array(i).fill("0"),...o].join(":")}static formatIPv6(e){let t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){let t=e.split(":"),n=-1,o=0,i=-1,s=0;for(let a=0;a<t.length;a++)t[a]==="0"?(i===-1&&(i=a),s++):(s>o&&(n=i,o=s),i=-1,s=0);if(s>o&&(n=i,o=s),o>1){let a=t.slice(0,n).join(":"),c=t.slice(n+o).join(":");return`${a}::${c}`}return e}static parseCIDR(e){let[t,n]=e.split("/"),o=parseInt(n,10);if(this.isIPv4(t)){if(o<0||o>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),o]}else{if(o<0||o>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),o]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;let t=parseInt(e.slice(8),16).toString(2).split("").reduce((o,i)=>o+ +i,0),n=e.slice(0,8).replace(/(.{2})/g,o=>`${parseInt(o,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){let t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){let n=t.length/2,o=t.slice(0,n),i=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";let a=i.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(o).join(".")}/${a}`:`${this.formatIPv6(o)}/${a}`}return this.decodeIP(GP.Convert.ToHex(e))}static fromString(e){if(e.includes("/")){let[n,o]=this.parseCIDR(e),i=new Uint8Array(n.length),s=o;for(let c=0;c<i.length;c++)s>=8?(i[c]=255,s-=8):s>0&&(i[c]=255<<8-s,s=0);let a=new Uint8Array(n.length*2);return a.set(n,0),a.set(i,n.length),a.buffer}let t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}};var XP=tr(vs()),Mw,Uw,Fw,Jt=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};E([h({type:w.TeletexString})],Jt.prototype,"teletexString",void 0);E([h({type:w.PrintableString})],Jt.prototype,"printableString",void 0);E([h({type:w.UniversalString})],Jt.prototype,"universalString",void 0);E([h({type:w.Utf8String})],Jt.prototype,"utf8String",void 0);E([h({type:w.BmpString})],Jt.prototype,"bmpString",void 0);Jt=E([R({type:A.Choice})],Jt);var Nf=class extends Jt{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?XP.Convert.ToHex(this.anyValue):super.toString())}};E([h({type:w.IA5String})],Nf.prototype,"ia5String",void 0);E([h({type:w.Any})],Nf.prototype,"anyValue",void 0);Nf=E([R({type:A.Choice})],Nf);var bl=class{constructor(e={}){this.type="",this.value=new Nf,Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],bl.prototype,"type",void 0);E([h({type:Nf})],bl.prototype,"value",void 0);var Ca=Mw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Mw.prototype)}};Ca=Mw=E([R({type:A.Set,itemType:bl})],Ca);var jw=Uw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Uw.prototype)}};jw=Uw=E([R({type:A.Sequence,itemType:Ca})],jw);var ut=Fw=class extends jw{constructor(e){super(e),Object.setPrototypeOf(this,Fw.prototype)}};ut=Fw=E([R({type:A.Sequence})],ut);var wq={fromASN:r=>xh.toString(Df.fromASN(r)),toASN:r=>Df.toASN(xh.fromString(r))},Pa=class{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],Pa.prototype,"typeId",void 0);E([h({type:w.Any,context:0})],Pa.prototype,"value",void 0);var Eh=class{constructor(e={}){this.partyName=new Jt,Object.assign(this,e)}};E([h({type:Jt,optional:!0,context:0,implicit:!0})],Eh.prototype,"nameAssigner",void 0);E([h({type:Jt,context:1,implicit:!0})],Eh.prototype,"partyName",void 0);var Ee=class{constructor(e={}){Object.assign(this,e)}};E([h({type:Pa,context:0,implicit:!0})],Ee.prototype,"otherName",void 0);E([h({type:w.IA5String,context:1,implicit:!0})],Ee.prototype,"rfc822Name",void 0);E([h({type:w.IA5String,context:2,implicit:!0})],Ee.prototype,"dNSName",void 0);E([h({type:w.Any,context:3,implicit:!0})],Ee.prototype,"x400Address",void 0);E([h({type:ut,context:4,implicit:!1})],Ee.prototype,"directoryName",void 0);E([h({type:Eh,context:5})],Ee.prototype,"ediPartyName",void 0);E([h({type:w.IA5String,context:6,implicit:!0})],Ee.prototype,"uniformResourceIdentifier",void 0);E([h({type:w.OctetString,context:7,implicit:!0,converter:wq})],Ee.prototype,"iPAddress",void 0);E([h({type:w.ObjectIdentifier,context:8,implicit:!0})],Ee.prototype,"registeredID",void 0);Ee=E([R({type:A.Choice})],Ee);var ka="1.3.6.1.5.5.7",Oa=`${ka}.1`,YP=`${ka}.2`,vl=`${ka}.3`,s3=`${ka}.48`,qbe=`${YP}.1`,Hbe=`${YP}.2`,Kw=`${s3}.1`,$w=`${s3}.2`,Vw=`${s3}.3`,qw=`${s3}.5`,Re="2.5.29";var Hw,a3=`${Oa}.1`,Is=class{constructor(e={}){this.accessMethod="",this.accessLocation=new Ee,Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],Is.prototype,"accessMethod",void 0);E([h({type:Ee})],Is.prototype,"accessLocation",void 0);var xl=Hw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Hw.prototype)}};xl=Hw=E([R({type:A.Sequence,itemType:Is})],xl);var c3=`${Re}.35`,El=class extends we{},Pi=class{constructor(e={}){e&&Object.assign(this,e)}};E([h({type:El,context:0,optional:!0,implicit:!0})],Pi.prototype,"keyIdentifier",void 0);E([h({type:Ee,context:1,optional:!0,implicit:!0,repeated:"sequence"})],Pi.prototype,"authorityCertIssuer",void 0);E([h({type:w.Integer,context:2,optional:!0,implicit:!0,converter:Ue})],Pi.prototype,"authorityCertSerialNumber",void 0);var l3=`${Re}.19`,Sl=class{constructor(e={}){this.cA=!1,Object.assign(this,e)}};E([h({type:w.Boolean,defaultValue:!1})],Sl.prototype,"cA",void 0);E([h({type:w.Integer,optional:!0})],Sl.prototype,"pathLenConstraint",void 0);var Ww,Et=Ww=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Ww.prototype)}};Et=Ww=E([R({type:A.Sequence,itemType:Ee})],Et);var zw,bq=`${Re}.29`,QP=zw=class extends Et{constructor(e){super(e),Object.setPrototypeOf(this,zw.prototype)}};QP=zw=E([R({type:A.Sequence})],QP);var Gw,f3=`${Re}.32`,Sve=`${f3}.0`,Cs=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};E([h({type:w.IA5String})],Cs.prototype,"ia5String",void 0);E([h({type:w.VisibleString})],Cs.prototype,"visibleString",void 0);E([h({type:w.BmpString})],Cs.prototype,"bmpString",void 0);E([h({type:w.Utf8String})],Cs.prototype,"utf8String",void 0);Cs=E([R({type:A.Choice})],Cs);var Sh=class{constructor(e={}){this.organization=new Cs,this.noticeNumbers=[],Object.assign(this,e)}};E([h({type:Cs})],Sh.prototype,"organization",void 0);E([h({type:w.Integer,repeated:"sequence"})],Sh.prototype,"noticeNumbers",void 0);var _h=class{constructor(e={}){Object.assign(this,e)}};E([h({type:Sh,optional:!0})],_h.prototype,"noticeRef",void 0);E([h({type:Cs,optional:!0})],_h.prototype,"explicitText",void 0);var u3=class{constructor(e={}){Object.assign(this,e)}};E([h({type:w.IA5String})],u3.prototype,"cPSuri",void 0);E([h({type:_h})],u3.prototype,"userNotice",void 0);u3=E([R({type:A.Choice})],u3);var Ah=class{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],Ah.prototype,"policyQualifierId",void 0);E([h({type:w.Any})],Ah.prototype,"qualifier",void 0);var _l=class{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],_l.prototype,"policyIdentifier",void 0);E([h({type:Ah,repeated:"sequence",optional:!0})],_l.prototype,"policyQualifiers",void 0);var Th=Gw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Gw.prototype)}};Th=Gw=E([R({type:A.Sequence,itemType:_l})],Th);var Ove=`${Re}.20`,Ih=class{constructor(e=0){this.value=e}};E([h({type:w.Integer})],Ih.prototype,"value",void 0);Ih=E([R({type:A.Choice})],Ih);var Uve=`${Re}.27`,ZP=class extends Ih{};ZP=E([R({type:A.Choice})],ZP);var Xw,d3=`${Re}.31`,ni;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(ni||(ni={}));var Ch=class extends Ci{toJSON(){let e=[],t=this.toNumber();return t&ni.aACompromise&&e.push("aACompromise"),t&ni.affiliationChanged&&e.push("affiliationChanged"),t&ni.cACompromise&&e.push("cACompromise"),t&ni.certificateHold&&e.push("certificateHold"),t&ni.cessationOfOperation&&e.push("cessationOfOperation"),t&ni.keyCompromise&&e.push("keyCompromise"),t&ni.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&ni.superseded&&e.push("superseded"),t&ni.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}},Ps=class{constructor(e={}){Object.assign(this,e)}};E([h({type:Ee,context:0,repeated:"sequence",implicit:!0})],Ps.prototype,"fullName",void 0);E([h({type:Ca,context:1,implicit:!0})],Ps.prototype,"nameRelativeToCRLIssuer",void 0);Ps=E([R({type:A.Choice})],Ps);var ki=class{constructor(e={}){Object.assign(this,e)}};E([h({type:Ps,context:0,optional:!0})],ki.prototype,"distributionPoint",void 0);E([h({type:Ch,context:1,optional:!0,implicit:!0})],ki.prototype,"reasons",void 0);E([h({type:Ee,context:2,optional:!0,repeated:"sequence",implicit:!0})],ki.prototype,"cRLIssuer",void 0);var Ra=Xw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Xw.prototype)}};Ra=Xw=E([R({type:A.Sequence,itemType:ki})],Ra);var Yw,Jve=`${Re}.46`,JP=Yw=class extends Ra{constructor(e){super(e),Object.setPrototypeOf(this,Yw.prototype)}};JP=Yw=E([R({type:A.Sequence,itemType:ki})],JP);var axe=`${Re}.28`,Wn=class r{constructor(e={}){this.onlyContainsUserCerts=r.ONLY,this.onlyContainsCACerts=r.ONLY,this.indirectCRL=r.ONLY,this.onlyContainsAttributeCerts=r.ONLY,Object.assign(this,e)}};Wn.ONLY=!1;E([h({type:Ps,context:0,optional:!0})],Wn.prototype,"distributionPoint",void 0);E([h({type:w.Boolean,context:1,defaultValue:Wn.ONLY,implicit:!0})],Wn.prototype,"onlyContainsUserCerts",void 0);E([h({type:w.Boolean,context:2,defaultValue:Wn.ONLY,implicit:!0})],Wn.prototype,"onlyContainsCACerts",void 0);E([h({type:Ch,context:3,optional:!0,implicit:!0})],Wn.prototype,"onlySomeReasons",void 0);E([h({type:w.Boolean,context:4,defaultValue:Wn.ONLY,implicit:!0})],Wn.prototype,"indirectCRL",void 0);E([h({type:w.Boolean,context:5,defaultValue:Wn.ONLY,implicit:!0})],Wn.prototype,"onlyContainsAttributeCerts",void 0);var ek=`${Re}.21`,Ph;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(Ph||(Ph={}));var kh=class{constructor(e=Ph.unspecified){this.reason=Ph.unspecified,this.reason=e}toJSON(){return Ph[this.reason]}toString(){return this.toJSON()}};E([h({type:w.Enumerated})],kh.prototype,"reason",void 0);kh=E([R({type:A.Choice})],kh);var Qw,p3=`${Re}.37`,Oh=Qw=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,Qw.prototype)}};Oh=Qw=E([R({type:A.Sequence,itemType:w.ObjectIdentifier})],Oh);var wxe=`${p3}.0`,tk=`${vl}.1`,rk=`${vl}.2`,nk=`${vl}.3`,ok=`${vl}.4`,ik=`${vl}.8`,sk=`${vl}.9`;var Sxe=`${Re}.54`,Zw=class{constructor(e=new ArrayBuffer(0)){this.value=e}};E([h({type:w.Integer,converter:Ue})],Zw.prototype,"value",void 0);Zw=E([R({type:A.Choice})],Zw);var ak=`${Re}.24`,Rh=class{constructor(e){this.value=new Date,e&&(this.value=e)}};E([h({type:w.GeneralizedTime})],Rh.prototype,"value",void 0);Rh=E([R({type:A.Choice})],Rh);var Jw,e9=`${Re}.18`,ck=Jw=class extends Et{constructor(e){super(e),Object.setPrototypeOf(this,Jw.prototype)}};ck=Jw=E([R({type:A.Sequence})],ck);var h3=`${Re}.15`,oi;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(oi||(oi={}));var Lf=class extends Ci{toJSON(){let e=this.toNumber(),t=[];return e&oi.cRLSign&&t.push("crlSign"),e&oi.dataEncipherment&&t.push("dataEncipherment"),e&oi.decipherOnly&&t.push("decipherOnly"),e&oi.digitalSignature&&t.push("digitalSignature"),e&oi.encipherOnly&&t.push("encipherOnly"),e&oi.keyAgreement&&t.push("keyAgreement"),e&oi.keyCertSign&&t.push("keyCertSign"),e&oi.keyEncipherment&&t.push("keyEncipherment"),e&oi.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}};var t9,qxe=`${Re}.30`,Bf=class{constructor(e={}){this.base=new Ee,this.minimum=0,Object.assign(this,e)}};E([h({type:Ee})],Bf.prototype,"base",void 0);E([h({type:w.Integer,context:0,defaultValue:0,implicit:!0})],Bf.prototype,"minimum",void 0);E([h({type:w.Integer,context:1,optional:!0,implicit:!0})],Bf.prototype,"maximum",void 0);var m3=t9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,t9.prototype)}};m3=t9=E([R({type:A.Sequence,itemType:Bf})],m3);var y3=class{constructor(e={}){Object.assign(this,e)}};E([h({type:m3,context:0,optional:!0,implicit:!0})],y3.prototype,"permittedSubtrees",void 0);E([h({type:m3,context:1,optional:!0,implicit:!0})],y3.prototype,"excludedSubtrees",void 0);var Yxe=`${Re}.36`,g3=class{constructor(e={}){Object.assign(this,e)}};E([h({type:w.Integer,context:0,implicit:!0,optional:!0,converter:Ue})],g3.prototype,"requireExplicitPolicy",void 0);E([h({type:w.Integer,context:1,implicit:!0,optional:!0,converter:Ue})],g3.prototype,"inhibitPolicyMapping",void 0);var r9,tEe=`${Re}.33`,Dh=class{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],Dh.prototype,"issuerDomainPolicy",void 0);E([h({type:w.ObjectIdentifier})],Dh.prototype,"subjectDomainPolicy",void 0);var lk=r9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,r9.prototype)}};lk=r9=E([R({type:A.Sequence,itemType:Dh})],lk);var n9,o9=`${Re}.17`,w3=n9=class extends Et{constructor(e){super(e),Object.setPrototypeOf(this,n9.prototype)}};w3=n9=E([R({type:A.Sequence})],w3);var Tr=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};E([h({type:w.ObjectIdentifier})],Tr.prototype,"type",void 0);E([h({type:w.Any,repeated:"set"})],Tr.prototype,"values",void 0);var i9,gEe=`${Re}.9`,uk=i9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,i9.prototype)}};uk=i9=E([R({type:A.Sequence,itemType:Tr})],uk);var s9=`${Re}.14`,bn=class extends El{};var TEe=`${Re}.16`,b3=class{constructor(e={}){Object.assign(this,e)}};E([h({type:w.GeneralizedTime,context:0,implicit:!0,optional:!0})],b3.prototype,"notBefore",void 0);E([h({type:w.GeneralizedTime,context:1,implicit:!0,optional:!0})],b3.prototype,"notAfter",void 0);var Nh;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(Nh||(Nh={}));var v3=class extends Ci{toJSON(){let e=[],t=this.toNumber();return t&Nh.pKIXCertificate&&e.push("pKIXCertificate"),t&Nh.newExtensions&&e.push("newExtensions"),t&Nh.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}},x3=class{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new v3,Object.assign(this,e)}};E([h({type:w.GeneralString})],x3.prototype,"entrustVers",void 0);E([h({type:v3})],x3.prototype,"entrustInfoFlags",void 0);var a9,LEe=`${Oa}.11`,fk=a9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,a9.prototype)}};fk=a9=E([R({type:A.Sequence,itemType:Is})],fk);var dk=tr(vs()),Y=class r{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof r&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&dk.isEqual(e.parameters,this.parameters)||e.parameters===this.parameters)}};E([h({type:w.ObjectIdentifier})],Y.prototype,"algorithm",void 0);E([h({type:w.Any,optional:!0})],Y.prototype,"parameters",void 0);var Ir=class{constructor(e={}){this.algorithm=new Y,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}};E([h({type:Y})],Ir.prototype,"algorithm",void 0);E([h({type:w.BitString})],Ir.prototype,"subjectPublicKey",void 0);var Bt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){let t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){let e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};E([h({type:w.UTCTime})],Bt.prototype,"utcTime",void 0);E([h({type:w.GeneralizedTime})],Bt.prototype,"generalTime",void 0);Bt=E([R({type:A.Choice})],Bt);var ks=class{constructor(e){this.notBefore=new Bt(new Date),this.notAfter=new Bt(new Date),e&&(this.notBefore=new Bt(e.notBefore),this.notAfter=new Bt(e.notAfter))}};E([h({type:Bt})],ks.prototype,"notBefore",void 0);E([h({type:Bt})],ks.prototype,"notAfter",void 0);var c9,Cr=class r{constructor(e={}){this.extnID="",this.critical=r.CRITICAL,this.extnValue=new we,Object.assign(this,e)}};Cr.CRITICAL=!1;E([h({type:w.ObjectIdentifier})],Cr.prototype,"extnID",void 0);E([h({type:w.Boolean,defaultValue:Cr.CRITICAL})],Cr.prototype,"critical",void 0);E([h({type:we})],Cr.prototype,"extnValue",void 0);var zn=c9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,c9.prototype)}};zn=c9=E([R({type:A.Sequence,itemType:Cr})],zn);var Oi;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(Oi||(Oi={}));var Pr=class{constructor(e={}){this.version=Oi.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new Y,this.issuer=new ut,this.validity=new ks,this.subject=new ut,this.subjectPublicKeyInfo=new Ir,Object.assign(this,e)}};E([h({type:w.Integer,context:0,defaultValue:Oi.v1})],Pr.prototype,"version",void 0);E([h({type:w.Integer,converter:Ue})],Pr.prototype,"serialNumber",void 0);E([h({type:Y})],Pr.prototype,"signature",void 0);E([h({type:ut})],Pr.prototype,"issuer",void 0);E([h({type:ks})],Pr.prototype,"validity",void 0);E([h({type:ut})],Pr.prototype,"subject",void 0);E([h({type:Ir})],Pr.prototype,"subjectPublicKeyInfo",void 0);E([h({type:w.BitString,context:1,implicit:!0,optional:!0})],Pr.prototype,"issuerUniqueID",void 0);E([h({type:w.BitString,context:2,implicit:!0,optional:!0})],Pr.prototype,"subjectUniqueID",void 0);E([h({type:zn,context:3,optional:!0})],Pr.prototype,"extensions",void 0);var vo=class{constructor(e={}){this.tbsCertificate=new Pr,this.signatureAlgorithm=new Y,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};E([h({type:Pr})],vo.prototype,"tbsCertificate",void 0);E([h({type:Y})],vo.prototype,"signatureAlgorithm",void 0);E([h({type:w.BitString})],vo.prototype,"signatureValue",void 0);var Al=class{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Bt,Object.assign(this,e)}};E([h({type:w.Integer,converter:Ue})],Al.prototype,"userCertificate",void 0);E([h({type:Bt})],Al.prototype,"revocationDate",void 0);E([h({type:Cr,optional:!0,repeated:"sequence"})],Al.prototype,"crlEntryExtensions",void 0);var Gn=class{constructor(e={}){this.signature=new Y,this.issuer=new ut,this.thisUpdate=new Bt,Object.assign(this,e)}};E([h({type:w.Integer,optional:!0})],Gn.prototype,"version",void 0);E([h({type:Y})],Gn.prototype,"signature",void 0);E([h({type:ut})],Gn.prototype,"issuer",void 0);E([h({type:Bt})],Gn.prototype,"thisUpdate",void 0);E([h({type:Bt,optional:!0})],Gn.prototype,"nextUpdate",void 0);E([h({type:Al,repeated:"sequence",optional:!0})],Gn.prototype,"revokedCertificates",void 0);E([h({type:Cr,optional:!0,context:0,repeated:"sequence"})],Gn.prototype,"crlExtensions",void 0);var Tl=class{constructor(e={}){this.tbsCertList=new Gn,this.signatureAlgorithm=new Y,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};E([h({type:Gn})],Tl.prototype,"tbsCertList",void 0);E([h({type:Y})],Tl.prototype,"signatureAlgorithm",void 0);E([h({type:w.BitString})],Tl.prototype,"signature",void 0);var Q=tr(vs());function L(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var ii=class{constructor(e={}){this.issuer=new ut,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:ut})],ii.prototype,"issuer",void 0);L([h({type:w.Integer,converter:Ue})],ii.prototype,"serialNumber",void 0);var Il=class{constructor(e={}){Object.assign(this,e)}};L([h({type:bn,context:0,implicit:!0})],Il.prototype,"subjectKeyIdentifier",void 0);L([h({type:ii})],Il.prototype,"issuerAndSerialNumber",void 0);Il=L([R({type:A.Choice})],Il);var kr;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(kr||(kr={}));var Cl=class extends Y{};Cl=L([R({type:A.Sequence})],Cl);var Lh=class extends Y{};Lh=L([R({type:A.Sequence})],Lh);var vn=class extends Y{};vn=L([R({type:A.Sequence})],vn);var Bh=class extends Y{};Bh=L([R({type:A.Sequence})],Bh);var hk=class extends Y{};hk=L([R({type:A.Sequence})],hk);var E3=class extends Y{};E3=L([R({type:A.Sequence})],E3);var si=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],si.prototype,"attrType",void 0);L([h({type:w.Any,repeated:"set"})],si.prototype,"attrValues",void 0);var l9,xn=class{constructor(e={}){this.version=kr.v0,this.sid=new Il,this.digestAlgorithm=new Cl,this.signatureAlgorithm=new Lh,this.signature=new we,Object.assign(this,e)}};L([h({type:w.Integer})],xn.prototype,"version",void 0);L([h({type:Il})],xn.prototype,"sid",void 0);L([h({type:Cl})],xn.prototype,"digestAlgorithm",void 0);L([h({type:si,repeated:"set",context:0,implicit:!0,optional:!0})],xn.prototype,"signedAttrs",void 0);L([h({type:Lh})],xn.prototype,"signatureAlgorithm",void 0);L([h({type:we})],xn.prototype,"signature",void 0);L([h({type:si,repeated:"set",context:1,implicit:!0,optional:!0})],xn.prototype,"unsignedAttrs",void 0);var Mh=l9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,l9.prototype)}};Mh=l9=L([R({type:A.Set,itemType:xn})],Mh);var mk=class extends Bt{};mk=L([R({type:A.Choice})],mk);var yk=class extends xn{};yk=L([R({type:A.Sequence})],yk);function re(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var Uh=class{constructor(e={}){this.acIssuer=new Ee,this.acSerial=0,this.attrs=[],Object.assign(this,e)}};re([h({type:Ee})],Uh.prototype,"acIssuer",void 0);re([h({type:w.Integer})],Uh.prototype,"acSerial",void 0);re([h({type:Tr,repeated:"sequence"})],Uh.prototype,"attrs",void 0);var u9,Fh=u9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,u9.prototype)}};Fh=u9=re([R({type:A.Sequence,itemType:w.ObjectIdentifier})],Fh);var Mf=class{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}};re([h({type:w.Integer,optional:!0})],Mf.prototype,"pathLenConstraint",void 0);re([h({type:Fh,implicit:!0,context:0,optional:!0})],Mf.prototype,"permittedAttrs",void 0);re([h({type:Fh,implicit:!0,context:1,optional:!0})],Mf.prototype,"excludedAttrs",void 0);re([h({type:w.Boolean,defaultValue:!0})],Mf.prototype,"permitUnSpecified",void 0);var xo=class{constructor(e={}){this.issuer=new Et,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}};re([h({type:Et})],xo.prototype,"issuer",void 0);re([h({type:w.Integer,converter:Ue})],xo.prototype,"serial",void 0);re([h({type:w.BitString,optional:!0})],xo.prototype,"issuerUID",void 0);var f9;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(f9||(f9={}));var Eo=class{constructor(e={}){this.digestedObjectType=f9.publicKey,this.digestAlgorithm=new Y,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}};re([h({type:w.Enumerated})],Eo.prototype,"digestedObjectType",void 0);re([h({type:w.ObjectIdentifier,optional:!0})],Eo.prototype,"otherObjectTypeID",void 0);re([h({type:Y})],Eo.prototype,"digestAlgorithm",void 0);re([h({type:w.BitString})],Eo.prototype,"objectDigest",void 0);var Pl=class{constructor(e={}){Object.assign(this,e)}};re([h({type:Et,optional:!0})],Pl.prototype,"issuerName",void 0);re([h({type:xo,context:0,implicit:!0,optional:!0})],Pl.prototype,"baseCertificateID",void 0);re([h({type:Eo,context:1,implicit:!0,optional:!0})],Pl.prototype,"objectDigestInfo",void 0);var kl=class{constructor(e={}){Object.assign(this,e)}};re([h({type:Ee,repeated:"sequence"})],kl.prototype,"v1Form",void 0);re([h({type:Pl,context:0,implicit:!0})],kl.prototype,"v2Form",void 0);kl=re([R({type:A.Choice})],kl);var Ol=class{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}};re([h({type:w.GeneralizedTime})],Ol.prototype,"notBeforeTime",void 0);re([h({type:w.GeneralizedTime})],Ol.prototype,"notAfterTime",void 0);var Da=class{constructor(e={}){Object.assign(this,e)}};re([h({type:xo,implicit:!0,context:0,optional:!0})],Da.prototype,"baseCertificateID",void 0);re([h({type:Et,implicit:!0,context:1,optional:!0})],Da.prototype,"entityName",void 0);re([h({type:Eo,implicit:!0,context:2,optional:!0})],Da.prototype,"objectDigestInfo",void 0);var d9;(function(r){r[r.v2=1]="v2"})(d9||(d9={}));var En=class{constructor(e={}){this.version=d9.v2,this.holder=new Da,this.issuer=new kl,this.signature=new Y,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new Ol,this.attributes=[],Object.assign(this,e)}};re([h({type:w.Integer})],En.prototype,"version",void 0);re([h({type:Da})],En.prototype,"holder",void 0);re([h({type:kl})],En.prototype,"issuer",void 0);re([h({type:Y})],En.prototype,"signature",void 0);re([h({type:w.Integer,converter:Ue})],En.prototype,"serialNumber",void 0);re([h({type:Ol})],En.prototype,"attrCertValidityPeriod",void 0);re([h({type:Tr,repeated:"sequence"})],En.prototype,"attributes",void 0);re([h({type:w.BitString,optional:!0})],En.prototype,"issuerUniqueID",void 0);re([h({type:zn,optional:!0})],En.prototype,"extensions",void 0);var Rl=class{constructor(e={}){this.acinfo=new En,this.signatureAlgorithm=new Y,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};re([h({type:En})],Rl.prototype,"acinfo",void 0);re([h({type:Y})],Rl.prototype,"signatureAlgorithm",void 0);re([h({type:w.BitString})],Rl.prototype,"signatureValue",void 0);var jh;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(jh||(jh={}));var Uf=class extends Ci{};var Ff=class{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};re([h({type:w.ObjectIdentifier,implicit:!0,context:0})],Ff.prototype,"type",void 0);re([h({type:w.Any,implicit:!0,context:1})],Ff.prototype,"value",void 0);var Kh=class{constructor(e={}){this.policyId="",this.classList=new Uf(jh.unclassified),Object.assign(this,e)}};re([h({type:w.ObjectIdentifier})],Kh.prototype,"policyId",void 0);re([h({type:Uf,defaultValue:new Uf(jh.unclassified)})],Kh.prototype,"classList",void 0);re([h({type:Ff,repeated:"set"})],Kh.prototype,"securityCategories",void 0);var jf=class{constructor(e={}){Object.assign(this,e)}};re([h({type:we})],jf.prototype,"cotets",void 0);re([h({type:w.ObjectIdentifier})],jf.prototype,"oid",void 0);re([h({type:w.Utf8String})],jf.prototype,"string",void 0);var S3=class{constructor(e={}){this.values=[],Object.assign(this,e)}};re([h({type:Et,implicit:!0,context:0,optional:!0})],S3.prototype,"policyAuthority",void 0);re([h({type:jf,repeated:"sequence"})],S3.prototype,"values",void 0);var gTe=`${Oa}.4`,wTe=`${Oa}.6`,bTe=`${Oa}.10`,vTe=`${Re}.55`,$h=`${ka}.10`,xTe=`${$h}.1`,ETe=`${$h}.2`,STe=`${$h}.3`,_Te=`${$h}.4`,ATe=`${$h}.6`,p9="2.5.4",TTe=`${p9}.72`;var h9,Kf=class{constructor(e={}){this.targetCertificate=new xo,Object.assign(this,e)}};re([h({type:xo})],Kf.prototype,"targetCertificate",void 0);re([h({type:Ee,optional:!0})],Kf.prototype,"targetName",void 0);re([h({type:Eo,optional:!0})],Kf.prototype,"certDigestInfo",void 0);var $f=class{constructor(e={}){Object.assign(this,e)}};re([h({type:Ee,context:0,implicit:!0})],$f.prototype,"targetName",void 0);re([h({type:Ee,context:1,implicit:!0})],$f.prototype,"targetGroup",void 0);re([h({type:Kf,context:2,implicit:!0})],$f.prototype,"targetCert",void 0);$f=re([R({type:A.Choice})],$f);var _3=h9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,h9.prototype)}};_3=h9=re([R({type:A.Sequence,itemType:$f})],_3);var m9,gk=m9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,m9.prototype)}};gk=m9=re([R({type:A.Sequence,itemType:_3})],gk);var A3=class{constructor(e={}){Object.assign(this,e)}};re([h({type:Et,implicit:!0,context:0,optional:!0})],A3.prototype,"roleAuthority",void 0);re([h({type:Ee,implicit:!0,context:1})],A3.prototype,"roleName",void 0);var Vh=class{constructor(e={}){this.service=new Ee,this.ident=new Ee,Object.assign(this,e)}};re([h({type:Ee})],Vh.prototype,"service",void 0);re([h({type:Ee})],Vh.prototype,"ident",void 0);re([h({type:we,optional:!0})],Vh.prototype,"authInfo",void 0);var y9,qh=class{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],qh.prototype,"otherCertFormat",void 0);L([h({type:w.Any})],qh.prototype,"otherCert",void 0);var Dl=class{constructor(e={}){Object.assign(this,e)}};L([h({type:vo})],Dl.prototype,"certificate",void 0);L([h({type:Rl,context:2,implicit:!0})],Dl.prototype,"v2AttrCert",void 0);L([h({type:qh,context:3,implicit:!0})],Dl.prototype,"other",void 0);Dl=L([R({type:A.Choice})],Dl);var Nl=y9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,y9.prototype)}};Nl=y9=L([R({type:A.Set,itemType:Dl})],Nl);var So=class{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],So.prototype,"contentType",void 0);L([h({type:w.Any,context:0})],So.prototype,"content",void 0);var Vf=class{constructor(e={}){Object.assign(this,e)}};L([h({type:we})],Vf.prototype,"single",void 0);L([h({type:w.Any})],Vf.prototype,"any",void 0);Vf=L([R({type:A.Choice})],Vf);var Ll=class{constructor(e={}){this.eContentType="",Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],Ll.prototype,"eContentType",void 0);L([h({type:Vf,context:0,optional:!0})],Ll.prototype,"eContent",void 0);var Hh=class{constructor(e={}){Object.assign(this,e)}};L([h({type:we,context:0,implicit:!0,optional:!0})],Hh.prototype,"value",void 0);L([h({type:we,converter:WP,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Hh.prototype,"constructedValue",void 0);Hh=L([R({type:A.Choice})],Hh);var Na=class{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new Bh,Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],Na.prototype,"contentType",void 0);L([h({type:Bh})],Na.prototype,"contentEncryptionAlgorithm",void 0);L([h({type:Hh,optional:!0})],Na.prototype,"encryptedContent",void 0);var La=class{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],La.prototype,"keyAttrId",void 0);L([h({type:w.Any,optional:!0})],La.prototype,"keyAttr",void 0);var g9,qf=class{constructor(e={}){this.subjectKeyIdentifier=new bn,Object.assign(this,e)}};L([h({type:bn})],qf.prototype,"subjectKeyIdentifier",void 0);L([h({type:w.GeneralizedTime,optional:!0})],qf.prototype,"date",void 0);L([h({type:La,optional:!0})],qf.prototype,"other",void 0);var Hf=class{constructor(e={}){Object.assign(this,e)}};L([h({type:qf,context:0,implicit:!0,optional:!0})],Hf.prototype,"rKeyId",void 0);L([h({type:ii,optional:!0})],Hf.prototype,"issuerAndSerialNumber",void 0);Hf=L([R({type:A.Choice})],Hf);var Wh=class{constructor(e={}){this.rid=new Hf,this.encryptedKey=new we,Object.assign(this,e)}};L([h({type:Hf})],Wh.prototype,"rid",void 0);L([h({type:we})],Wh.prototype,"encryptedKey",void 0);var T3=g9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,g9.prototype)}};T3=g9=L([R({type:A.Sequence,itemType:Wh})],T3);var zh=class{constructor(e={}){this.algorithm=new Y,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:Y})],zh.prototype,"algorithm",void 0);L([h({type:w.BitString})],zh.prototype,"publicKey",void 0);var Bl=class{constructor(e={}){Object.assign(this,e)}};L([h({type:bn,context:0,implicit:!0,optional:!0})],Bl.prototype,"subjectKeyIdentifier",void 0);L([h({type:zh,context:1,implicit:!0,optional:!0})],Bl.prototype,"originatorKey",void 0);L([h({type:ii,optional:!0})],Bl.prototype,"issuerAndSerialNumber",void 0);Bl=L([R({type:A.Choice})],Bl);var Os=class{constructor(e={}){this.version=kr.v3,this.originator=new Bl,this.keyEncryptionAlgorithm=new vn,this.recipientEncryptedKeys=new T3,Object.assign(this,e)}};L([h({type:w.Integer})],Os.prototype,"version",void 0);L([h({type:Bl,context:0})],Os.prototype,"originator",void 0);L([h({type:we,context:1,optional:!0})],Os.prototype,"ukm",void 0);L([h({type:vn})],Os.prototype,"keyEncryptionAlgorithm",void 0);L([h({type:T3})],Os.prototype,"recipientEncryptedKeys",void 0);var Wf=class{constructor(e={}){Object.assign(this,e)}};L([h({type:bn,context:0,implicit:!0})],Wf.prototype,"subjectKeyIdentifier",void 0);L([h({type:ii})],Wf.prototype,"issuerAndSerialNumber",void 0);Wf=L([R({type:A.Choice})],Wf);var Ba=class{constructor(e={}){this.version=kr.v0,this.rid=new Wf,this.keyEncryptionAlgorithm=new vn,this.encryptedKey=new we,Object.assign(this,e)}};L([h({type:w.Integer})],Ba.prototype,"version",void 0);L([h({type:Wf})],Ba.prototype,"rid",void 0);L([h({type:vn})],Ba.prototype,"keyEncryptionAlgorithm",void 0);L([h({type:we})],Ba.prototype,"encryptedKey",void 0);var Ml=class{constructor(e={}){this.keyIdentifier=new we,Object.assign(this,e)}};L([h({type:we})],Ml.prototype,"keyIdentifier",void 0);L([h({type:w.GeneralizedTime,optional:!0})],Ml.prototype,"date",void 0);L([h({type:La,optional:!0})],Ml.prototype,"other",void 0);var Ma=class{constructor(e={}){this.version=kr.v4,this.kekid=new Ml,this.keyEncryptionAlgorithm=new vn,this.encryptedKey=new we,Object.assign(this,e)}};L([h({type:w.Integer})],Ma.prototype,"version",void 0);L([h({type:Ml})],Ma.prototype,"kekid",void 0);L([h({type:vn})],Ma.prototype,"keyEncryptionAlgorithm",void 0);L([h({type:we})],Ma.prototype,"encryptedKey",void 0);var Ua=class{constructor(e={}){this.version=kr.v0,this.keyEncryptionAlgorithm=new vn,this.encryptedKey=new we,Object.assign(this,e)}};L([h({type:w.Integer})],Ua.prototype,"version",void 0);L([h({type:E3,context:0,optional:!0})],Ua.prototype,"keyDerivationAlgorithm",void 0);L([h({type:vn})],Ua.prototype,"keyEncryptionAlgorithm",void 0);L([h({type:we})],Ua.prototype,"encryptedKey",void 0);var Gh=class{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],Gh.prototype,"oriType",void 0);L([h({type:w.Any})],Gh.prototype,"oriValue",void 0);var Rs=class{constructor(e={}){Object.assign(this,e)}};L([h({type:Ba,optional:!0})],Rs.prototype,"ktri",void 0);L([h({type:Os,context:1,implicit:!0,optional:!0})],Rs.prototype,"kari",void 0);L([h({type:Ma,context:2,implicit:!0,optional:!0})],Rs.prototype,"kekri",void 0);L([h({type:Ua,context:3,implicit:!0,optional:!0})],Rs.prototype,"pwri",void 0);L([h({type:Gh,context:4,implicit:!0,optional:!0})],Rs.prototype,"ori",void 0);Rs=L([R({type:A.Choice})],Rs);var w9,Xh=w9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,w9.prototype)}};Xh=w9=L([R({type:A.Set,itemType:Rs})],Xh);var b9,wk=`${ka}.16`,ACe=`${wk}.2`,TCe=`${wk}.4`,zf=class{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}};L([h({type:w.ObjectIdentifier})],zf.prototype,"otherRevInfoFormat",void 0);L([h({type:w.Any})],zf.prototype,"otherRevInfo",void 0);var I3=class{constructor(e={}){this.other=new zf,Object.assign(this,e)}};L([h({type:zf,context:1,implicit:!0})],I3.prototype,"other",void 0);I3=L([R({type:A.Choice})],I3);var Gf=b9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,b9.prototype)}};Gf=b9=L([R({type:A.Set,itemType:I3})],Gf);var Xf=class{constructor(e={}){Object.assign(this,e)}};L([h({type:Nl,context:0,implicit:!0,optional:!0})],Xf.prototype,"certs",void 0);L([h({type:Gf,context:1,implicit:!0,optional:!0})],Xf.prototype,"crls",void 0);var v9,x9=v9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,v9.prototype)}};x9=v9=L([R({type:A.Set,itemType:si})],x9);var Ul=class{constructor(e={}){this.version=kr.v0,this.recipientInfos=new Xh,this.encryptedContentInfo=new Na,Object.assign(this,e)}};L([h({type:w.Integer})],Ul.prototype,"version",void 0);L([h({type:Xf,context:0,implicit:!0,optional:!0})],Ul.prototype,"originatorInfo",void 0);L([h({type:Xh})],Ul.prototype,"recipientInfos",void 0);L([h({type:Na})],Ul.prototype,"encryptedContentInfo",void 0);L([h({type:x9,context:1,implicit:!0,optional:!0})],Ul.prototype,"unprotectedAttrs",void 0);var bk="1.2.840.113549.1.7.2";var E9,C3=E9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,E9.prototype)}};C3=E9=L([R({type:A.Set,itemType:Cl})],C3);var Ds=class{constructor(e={}){this.version=kr.v0,this.digestAlgorithms=new C3,this.encapContentInfo=new Ll,this.signerInfos=new Mh,Object.assign(this,e)}};L([h({type:w.Integer})],Ds.prototype,"version",void 0);L([h({type:C3})],Ds.prototype,"digestAlgorithms",void 0);L([h({type:Ll})],Ds.prototype,"encapContentInfo",void 0);L([h({type:Nl,context:0,implicit:!0,optional:!0})],Ds.prototype,"certificates",void 0);L([h({type:Gf,context:1,implicit:!0,optional:!0})],Ds.prototype,"crls",void 0);L([h({type:Mh})],Ds.prototype,"signerInfos",void 0);var Fl="1.2.840.10045.2.1";var Yh="1.2.840.10045.4.1",P3="1.2.840.10045.4.3.1",Qh="1.2.840.10045.4.3.2",Zh="1.2.840.10045.4.3.3",Jh="1.2.840.10045.4.3.4";var S9="1.2.840.10045.3.1.7";var _9="1.3.132.0.34";var A9="1.3.132.0.35";function e1(r){return new Y({algorithm:r})}var xk=e1(Yh),EPe=e1(P3),Ek=e1(Qh),Sk=e1(Zh),_k=e1(Jh);function ft(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var t1=class{constructor(e={}){Object.assign(this,e)}};ft([h({type:w.ObjectIdentifier})],t1.prototype,"fieldType",void 0);ft([h({type:w.Any})],t1.prototype,"parameters",void 0);t1=ft([R({type:A.Sequence})],t1);var T9=class extends we{};var Yf=class{constructor(e={}){Object.assign(this,e)}};ft([h({type:w.OctetString})],Yf.prototype,"a",void 0);ft([h({type:w.OctetString})],Yf.prototype,"b",void 0);ft([h({type:w.BitString,optional:!0})],Yf.prototype,"seed",void 0);Yf=ft([R({type:A.Sequence})],Yf);var I9;(function(r){r[r.ecpVer1=1]="ecpVer1"})(I9||(I9={}));var Ri=class{constructor(e={}){this.version=I9.ecpVer1,Object.assign(this,e)}};ft([h({type:w.Integer})],Ri.prototype,"version",void 0);ft([h({type:t1})],Ri.prototype,"fieldID",void 0);ft([h({type:Yf})],Ri.prototype,"curve",void 0);ft([h({type:T9})],Ri.prototype,"base",void 0);ft([h({type:w.Integer,converter:Ue})],Ri.prototype,"order",void 0);ft([h({type:w.Integer,optional:!0})],Ri.prototype,"cofactor",void 0);Ri=ft([R({type:A.Sequence})],Ri);var Di=class{constructor(e={}){Object.assign(this,e)}};ft([h({type:w.ObjectIdentifier})],Di.prototype,"namedCurve",void 0);ft([h({type:w.Null})],Di.prototype,"implicitCurve",void 0);ft([h({type:Ri})],Di.prototype,"specifiedCurve",void 0);Di=ft([R({type:A.Choice})],Di);var Qf=class{constructor(e={}){this.version=1,this.privateKey=new we,Object.assign(this,e)}};ft([h({type:w.Integer})],Qf.prototype,"version",void 0);ft([h({type:we})],Qf.prototype,"privateKey",void 0);ft([h({type:Di,context:0,optional:!0})],Qf.prototype,"parameters",void 0);ft([h({type:w.BitString,context:1,optional:!0})],Qf.prototype,"publicKey",void 0);var jl=class{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}};ft([h({type:w.Integer,converter:Ue})],jl.prototype,"r",void 0);ft([h({type:w.Integer,converter:Ue})],jl.prototype,"s",void 0);function tt(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var Sn="1.2.840.113549.1.1",Ni=`${Sn}.1`,Ak=`${Sn}.7`,Tk=`${Sn}.9`,Fa=`${Sn}.10`,Ik=`${Sn}.2`,Ck=`${Sn}.4`,Zf=`${Sn}.5`,Pk=`${Sn}.14`;var k3=`${Sn}.11`,Jf=`${Sn}.12`,ed=`${Sn}.13`,C9=`${Sn}.15`,P9=`${Sn}.16`,Kl="1.3.14.3.2.26",O3="2.16.840.1.101.3.4.2.4",$l="2.16.840.1.101.3.4.2.1",Vl="2.16.840.1.101.3.4.2.2",ql="2.16.840.1.101.3.4.2.3",kk="2.16.840.1.101.3.4.2.5",Ok="2.16.840.1.101.3.4.2.6",Rk="1.2.840.113549.2.2",Dk="1.2.840.113549.2.5",ja=`${Sn}.8`;function or(r){return new Y({algorithm:r,parameters:null})}var ZPe=or(Rk),JPe=or(Dk),Ns=or(Kl),eke=or(O3),tke=or($l),rke=or(Vl),nke=or(ql),oke=or(kk),ike=or(Ok),R3=new Y({algorithm:ja,parameters:J.serialize(Ns)}),k9=new Y({algorithm:Tk,parameters:J.serialize(Df.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))}),ske=or(Ni),ake=or(Ik),cke=or(Ck),lke=or(Zf),uke=or(C9),fke=or(P9),dke=or(Jf),pke=or(ed),hke=or(C9),mke=or(P9);var td=class{constructor(e={}){this.hashAlgorithm=new Y(Ns),this.maskGenAlgorithm=new Y({algorithm:ja,parameters:J.serialize(Ns)}),this.pSourceAlgorithm=new Y(k9),Object.assign(this,e)}};tt([h({type:Y,context:0,defaultValue:Ns})],td.prototype,"hashAlgorithm",void 0);tt([h({type:Y,context:1,defaultValue:R3})],td.prototype,"maskGenAlgorithm",void 0);tt([h({type:Y,context:2,defaultValue:k9})],td.prototype,"pSourceAlgorithm",void 0);var Eke=new Y({algorithm:Ak,parameters:J.serialize(new td)});var Li=class{constructor(e={}){this.hashAlgorithm=new Y(Ns),this.maskGenAlgorithm=new Y({algorithm:ja,parameters:J.serialize(Ns)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}};tt([h({type:Y,context:0,defaultValue:Ns})],Li.prototype,"hashAlgorithm",void 0);tt([h({type:Y,context:1,defaultValue:R3})],Li.prototype,"maskGenAlgorithm",void 0);tt([h({type:w.Integer,context:2,defaultValue:20})],Li.prototype,"saltLength",void 0);tt([h({type:w.Integer,context:3,defaultValue:1})],Li.prototype,"trailerField",void 0);var Pke=new Y({algorithm:Fa,parameters:J.serialize(new Li)});var Hl=class{constructor(e={}){this.digestAlgorithm=new Y,this.digest=new we,Object.assign(this,e)}};tt([h({type:Y})],Hl.prototype,"digestAlgorithm",void 0);tt([h({type:we})],Hl.prototype,"digest",void 0);var O9,rd=class{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};tt([h({type:w.Integer,converter:Ue})],rd.prototype,"prime",void 0);tt([h({type:w.Integer,converter:Ue})],rd.prototype,"exponent",void 0);tt([h({type:w.Integer,converter:Ue})],rd.prototype,"coefficient",void 0);var D3=O9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,O9.prototype)}};D3=O9=tt([R({type:A.Sequence,itemType:rd})],D3);var _o=class{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};tt([h({type:w.Integer})],_o.prototype,"version",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"modulus",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"publicExponent",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"privateExponent",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"prime1",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"prime2",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"exponent1",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"exponent2",void 0);tt([h({type:w.Integer,converter:Ue})],_o.prototype,"coefficient",void 0);tt([h({type:D3,optional:!0})],_o.prototype,"otherPrimeInfos",void 0);var nd=class{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}};tt([h({type:w.Integer,converter:Ue})],nd.prototype,"modulus",void 0);tt([h({type:w.Integer,converter:Ue})],nd.prototype,"publicExponent",void 0);function r1(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var R9;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(R9||(R9={}));var Or=R9;var tO=tr(eO(),1),{__extends:id,__assign:aOe,__rest:Aq,__decorate:cOe,__param:lOe,__metadata:uOe,__awaiter:rO,__generator:nO,__exportStar:fOe,__createBinding:dOe,__values:n1,__read:o1,__spread:ai,__spreadArrays:pOe,__await:hOe,__asyncGenerator:mOe,__asyncDelegator:yOe,__asyncValues:gOe,__makeTemplateObject:wOe,__importStar:bOe,__importDefault:vOe,__classPrivateFieldGet:xOe,__classPrivateFieldSet:EOe}=tO.default;var Tq="injectionTokens";function N9(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(Tq,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function i1(r){return!!r.useClass}function sd(r){return!!r.useFactory}var B3=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},o=!1,i,s=function(){return o||(i=e(t.wrap()),o=!0),i};return new Proxy(n,this.createHandler(s))},r.prototype.createHandler=function(e){var t={},n=function(o){t[o]=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];i[0]=e();var a=Reflect[o];return a.apply(void 0,ai(i))}};return this.reflectMethods.forEach(n),t},r}();function Ka(r){return typeof r=="string"||typeof r=="symbol"}function L9(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function M3(r){return typeof r=="object"&&"token"in r&&"transform"in r}function oO(r){return typeof r=="function"||r instanceof B3}function Wl(r){return!!r.useToken}function zl(r){return r.useValue!=null}function iO(r){return i1(r)||zl(r)||Wl(r)||sd(r)}var Iq=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),s1=Iq;var Cq=function(r){id(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(s1),sO=Cq;var Pq=function(){function r(){this.scopedResolutions=new Map}return r}(),a1=Pq;function kq(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function Oq(r,e,t){return t===void 0&&(t="    "),ai([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function B9(r,e,t){var n=o1(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),o=n[1],i=o===void 0?null:o,s=kq(i,e);return Oq("Cannot inject the dependency "+s+' of "'+r.name+'" constructor. Reason:',t)}function aO(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var Rq=function(r){id(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(s1);var Dq=function(r){id(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(s1);var Nq=function(){function r(){this.preResolution=new Rq,this.postResolution=new Dq}return r}(),cO=Nq;var M9=new Map,Lq=function(){function r(e){this.parent=e,this._registry=new sO,this.interceptors=new cO,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:Or.Transient}),this.ensureNotDisposed();var o;if(iO(t)?o=t:o={useClass:t},Wl(o))for(var i=[e],s=o;s!=null;){var a=s.useToken;if(i.includes(a))throw new Error("Token registration cycle detected! "+ai(i,[a]).join(" -> "));i.push(a);var c=this._registry.get(a);c&&Wl(c.provider)?s=c.provider:s=null}if((n.lifecycle===Or.Singleton||n.lifecycle==Or.ContainerScoped||n.lifecycle==Or.ResolutionScoped)&&(zl(o)||sd(o)))throw new Error('Cannot use lifecycle "'+Or[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:o,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),Ka(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),Ka(e)){if(Ka(t))return this.register(e,{useToken:t},{lifecycle:Or.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:Or.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!Ka(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:Or.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new a1),n===void 0&&(n=!1),this.ensureNotDisposed();var o=this.getRegistration(e);if(!o&&Ka(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),o){var i=this.resolveRegistration(o,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}if(oO(e)){var i=this.construct(e,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,o;if(this.interceptors.preResolution.has(e)){var i=[];try{for(var s=n1(this.interceptors.preResolution.getAll(e)),a=s.next();!a.done;a=s.next()){var c=a.value;c.options.frequency!="Once"&&i.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,i)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var o,i;if(this.interceptors.postResolution.has(e)){var s=[];try{for(var a=n1(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&s.push(l),l.callback(e,t,n)}}catch(u){o={error:u}}finally{try{c&&!c.done&&(i=a.return)&&i.call(a)}finally{if(o)throw o.error}}this.interceptors.postResolution.setAll(e,s)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===Or.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===Or.Singleton,o=e.options.lifecycle===Or.ContainerScoped,i=n||o,s;return zl(e.provider)?s=e.provider.useValue:Wl(e.provider)?s=i?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):i1(e.provider)?s=i?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):sd(e.provider)?s=e.provider.useFactory(this):s=this.construct(e.provider,t),e.options.lifecycle===Or.ResolutionScoped&&t.scopedResolutions.set(e,s),s},r.prototype.resolveAll=function(e,t,n){var o=this;t===void 0&&(t=new a1),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getAllRegistrations(e);if(!i&&Ka(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),i){var s=i.map(function(c){return o.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,s,"All"),s}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=n1(this._registry.entries()),o=n.next();!o.done;o=n.next()){var i=o1(o.value,2),s=i[0],a=i[1];this._registry.setAll(s,a.filter(function(c){return!zl(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var o=n1(this._registry.entries()),i=o.next();!i.done;i=o.next()){var s=o1(i.value,2),a=s[0],c=s[1];c.some(function(l){var u=l.options;return u.lifecycle===Or.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===Or.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return rO(this,void 0,void 0,function(){var e;return nO(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var o=n.dispose();o&&e.push(o)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof B3)return e.createProxy(function(i){return n.resolve(i,t)});var o=function(){var i=M9.get(e);if(!i||i.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var s=i.map(n.resolveParams(t,e));return new(e.bind.apply(e,ai([void 0],s)))}();return aO(o)&&this.disposables.add(o),o},r.prototype.resolveParams=function(e,t){var n=this;return function(o,i){var s,a,c;try{return L9(o)?M3(o)?o.multiple?(s=n.resolve(o.transform)).transform.apply(s,ai([n.resolveAll(o.token,new a1,o.isOptional)],o.transformArgs)):(a=n.resolve(o.transform)).transform.apply(a,ai([n.resolve(o.token,e,o.isOptional)],o.transformArgs)):o.multiple?n.resolveAll(o.token,new a1,o.isOptional):n.resolve(o.token,e,o.isOptional):M3(o)?(c=n.resolve(o.transform,e)).transform.apply(c,ai([n.resolve(o.token,e)],o.transformArgs)):n.resolve(o,e)}catch(l){throw new Error(B9(t,i,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),yt=new Lq;function Bq(r){return function(e){M9.set(e,N9(e)),r&&r.token&&(Array.isArray(r.token)?r.token.forEach(function(t){yt.register(t,e)}):yt.register(r.token,e))}}var $a=Bq;if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);function Ye(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}function Qe(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var F9,Gl=class{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}};Qe([h({type:w.ObjectIdentifier})],Gl.prototype,"attrId",void 0);Qe([h({type:w.Any,repeated:"set"})],Gl.prototype,"attrValues",void 0);var lO=F9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,F9.prototype)}};lO=F9=Qe([R({type:A.Sequence,itemType:Gl})],lO);var j9,uO=j9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,j9.prototype)}};uO=j9=Qe([R({type:A.Sequence,itemType:So})],uO);var Mq="1.2.840.113549",Uq=`${Mq}.1`,fO=`${Uq}.12`,ad=`${fO}.1`,LDe=`${ad}.1`,BDe=`${ad}.2`,MDe=`${ad}.3`,UDe=`${ad}.4`,FDe=`${ad}.5`,jDe=`${ad}.6`,Xl=`${fO}.10.1`;var VDe=`${Xl}.1`,qDe=`${Xl}.2`,HDe=`${Xl}.3`,WDe=`${Xl}.4`,zDe=`${Xl}.5`,GDe=`${Xl}.6`,U3="1.2.840.113549.1.9";var F3=class{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}};Qe([h({type:w.ObjectIdentifier})],F3.prototype,"certId",void 0);Qe([h({type:w.Any,context:0})],F3.prototype,"certValue",void 0);var dO=`${U3}.22`,JDe=`${dO}.1`,eNe=`${dO}.2`;var j3=class{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}};Qe([h({type:w.ObjectIdentifier})],j3.prototype,"crlId",void 0);Qe([h({type:w.Any,context:0})],j3.prototype,"crltValue",void 0);var Fq=`${U3}.23`,iNe=`${Fq}.1`;function Ls(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var K3=class extends we{},Va=class{constructor(e={}){this.encryptionAlgorithm=new Y,this.encryptedData=new K3,Object.assign(this,e)}};Ls([h({type:Y})],Va.prototype,"encryptionAlgorithm",void 0);Ls([h({type:K3})],Va.prototype,"encryptedData",void 0);var K9,$9;(function(r){r[r.v1=0]="v1"})($9||($9={}));var $3=class extends we{},V9=K9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,K9.prototype)}};V9=K9=Ls([R({type:A.Sequence,itemType:Tr})],V9);var qa=class{constructor(e={}){this.version=$9.v1,this.privateKeyAlgorithm=new Y,this.privateKey=new $3,Object.assign(this,e)}};Ls([h({type:w.Integer})],qa.prototype,"version",void 0);Ls([h({type:Y})],qa.prototype,"privateKeyAlgorithm",void 0);Ls([h({type:$3})],qa.prototype,"privateKey",void 0);Ls([h({type:V9,implicit:!0,context:0,optional:!0})],qa.prototype,"attributes",void 0);var pO=class extends qa{};pO=Qe([R({type:A.Sequence})],pO);var hO=class extends Va{};hO=Qe([R({type:A.Sequence})],hO);var V3=class{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}};Qe([h({type:w.ObjectIdentifier})],V3.prototype,"secretTypeId",void 0);Qe([h({type:w.Any,context:0})],V3.prototype,"secretValue",void 0);var Ha=class{constructor(e={}){this.mac=new Hl,this.macSalt=new we,this.iterations=1,Object.assign(this,e)}};Qe([h({type:Hl})],Ha.prototype,"mac",void 0);Qe([h({type:we})],Ha.prototype,"macSalt",void 0);Qe([h({type:w.Integer,defaultValue:1})],Ha.prototype,"iterations",void 0);var Yl=class{constructor(e={}){this.version=3,this.authSafe=new So,this.macData=new Ha,Object.assign(this,e)}};Qe([h({type:w.Integer})],Yl.prototype,"version",void 0);Qe([h({type:So})],Yl.prototype,"authSafe",void 0);Qe([h({type:Ha,optional:!0})],Yl.prototype,"macData",void 0);var q9,cd=class{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}};Qe([h({type:w.ObjectIdentifier})],cd.prototype,"bagId",void 0);Qe([h({type:w.Any,context:0})],cd.prototype,"bagValue",void 0);Qe([h({type:Gl,repeated:"set",optional:!0})],cd.prototype,"bagAttributes",void 0);var mO=q9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,q9.prototype)}};mO=q9=Qe([R({type:A.Sequence,itemType:cd})],mO);var H9,W9,z9,Mt="1.2.840.113549.1.9",cLe=`${Mt}.0`,PO=`${Mt}.24`,l1=`${Mt}.25`,kO=`${Mt}.26`,OO=`${Mt}.27`,lLe=`${PO}.1`,uLe=`${PO}.2`,fLe=`${Mt}.1`,dLe=`${Mt}.2`,pLe=`${Mt}.3`,hLe=`${Mt}.4`,mLe=`${Mt}.5`,yLe=`${Mt}.6`,tb=`${Mt}.7`,gLe=`${Mt}.8`,wLe=`${Mt}.9`,bLe=`${Mt}.13`,u1=`${Mt}.14`,vLe=`${Mt}.15`,xLe=`${Mt}.20`,ELe=`${Mt}.21`;var SLe=`${l1}.1`,_Le=`${l1}.2`,ALe=`${l1}.3`,TLe=`${l1}.4`,ILe=`${l1}.5`,f1="1.3.6.1.5.5.7.9",CLe=`${f1}.1`,PLe=`${f1}.2`,kLe=`${f1}.3`,OLe=`${f1}.4`,RLe=`${f1}.5`,DLe=`${kO}.1`,NLe=`${kO}.2`,LLe=`${OO}.1`,BLe=`${OO}.2`,MLe=`${Mt}.16`,ULe=`${Mt}.22`,FLe=`${Mt}.23`,jLe=`${p9}.65`,q3=class extends Jt{constructor(e={}){super(e)}toString(){return{}.toString(),this.ia5String||super.toString()}};Ye([h({type:w.IA5String})],q3.prototype,"ia5String",void 0);q3=Ye([R({type:A.Choice})],q3);var yO=class extends So{};yO=Ye([R({type:A.Sequence})],yO);var gO=class extends Yl{};gO=Ye([R({type:A.Sequence})],gO);var wO=class extends Va{};wO=Ye([R({type:A.Sequence})],wO);var G9=class{constructor(e=""){this.value=e}toString(){return this.value}};Ye([h({type:w.IA5String})],G9.prototype,"value",void 0);G9=Ye([R({type:A.Choice})],G9);var bO=class extends q3{};bO=Ye([R({type:A.Choice})],bO);var vO=class extends Jt{};vO=Ye([R({type:A.Choice})],vO);var X9=class{constructor(e=new Date){this.value=e}};Ye([h({type:w.GeneralizedTime})],X9.prototype,"value",void 0);X9=Ye([R({type:A.Choice})],X9);var xO=class extends Jt{};xO=Ye([R({type:A.Choice})],xO);var Y9=class{constructor(e="M"){this.value=e}toString(){return this.value}};Ye([h({type:w.PrintableString})],Y9.prototype,"value",void 0);Y9=Ye([R({type:A.Choice})],Y9);var H3=class{constructor(e=""){this.value=e}toString(){return this.value}};Ye([h({type:w.PrintableString})],H3.prototype,"value",void 0);H3=Ye([R({type:A.Choice})],H3);var EO=class extends H3{};EO=Ye([R({type:A.Choice})],EO);var SO=class extends Jt{};SO=Ye([R({type:A.Choice})],SO);var Q9=class{constructor(e=""){this.value=e}toString(){return this.value}};Ye([h({type:w.ObjectIdentifier})],Q9.prototype,"value",void 0);Q9=Ye([R({type:A.Choice})],Q9);var _O=class extends Bt{};_O=Ye([R({type:A.Choice})],_O);var Z9=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};Ye([h({type:w.Integer})],Z9.prototype,"value",void 0);Z9=Ye([R({type:A.Choice})],Z9);var AO=class extends xn{};AO=Ye([R({type:A.Sequence})],AO);var c1=class extends Jt{};c1=Ye([R({type:A.Choice})],c1);var TO=H9=class extends zn{constructor(e){super(e),Object.setPrototypeOf(this,H9.prototype)}};TO=H9=Ye([R({type:A.Sequence})],TO);var IO=W9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,W9.prototype)}};IO=W9=Ye([R({type:A.Set,itemType:si})],IO);var J9=class{constructor(e=""){this.value=e}toString(){return this.value}};Ye([h({type:w.BmpString})],J9.prototype,"value",void 0);J9=Ye([R({type:A.Choice})],J9);var eb=class extends Y{};eb=Ye([R({type:A.Sequence})],eb);var CO=z9=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,z9.prototype)}};CO=z9=Ye([R({type:A.Sequence,itemType:eb})],CO);function ci(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var rb,d1=rb=class extends ge{constructor(e){super(e),Object.setPrototypeOf(this,rb.prototype)}};d1=rb=ci([R({type:A.Sequence,itemType:Tr})],d1);var Bi=class{constructor(e={}){this.version=0,this.subject=new ut,this.subjectPKInfo=new Ir,this.attributes=new d1,Object.assign(this,e)}};ci([h({type:w.Integer})],Bi.prototype,"version",void 0);ci([h({type:ut})],Bi.prototype,"subject",void 0);ci([h({type:Ir})],Bi.prototype,"subjectPKInfo",void 0);ci([h({type:d1,implicit:!0,context:0})],Bi.prototype,"attributes",void 0);var Wa=class{constructor(e={}){this.certificationRequestInfo=new Bi,this.signatureAlgorithm=new Y,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};ci([h({type:Bi})],Wa.prototype,"certificationRequestInfo",void 0);ci([h({type:Y})],Wa.prototype,"signatureAlgorithm",void 0);ci([h({type:w.BitString})],Wa.prototype,"signature",void 0);var w1="crypto.algorithm",db=class{getAlgorithms(){return yt.resolveAll(w1)}toAsnAlgorithm(e){({...e});for(let t of this.getAlgorithms()){let n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){let t=new Y({algorithm:e.name});if("parameters"in e){let n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(let n of this.getAlgorithms()){let o=n.toWebAlgorithm(e);if(o)return o}return{name:e.algorithm,parameters:e.parameters}}},Ql="crypto.algorithmProvider";yt.registerSingleton(Ql,db);var X3,An="1.3.36.3.3.2.8.1.1",RO=`${An}.1`,DO=`${An}.2`,NO=`${An}.3`,LO=`${An}.4`,BO=`${An}.5`,MO=`${An}.6`,UO=`${An}.7`,FO=`${An}.8`,jO=`${An}.9`,KO=`${An}.10`,$O=`${An}.11`,VO=`${An}.12`,qO=`${An}.13`,HO=`${An}.14`,WO="brainpoolP160r1",zO="brainpoolP160t1",GO="brainpoolP192r1",XO="brainpoolP192t1",YO="brainpoolP224r1",QO="brainpoolP224t1",ZO="brainpoolP256r1",JO="brainpoolP256t1",eR="brainpoolP320r1",tR="brainpoolP320t1",rR="brainpoolP384r1",nR="brainpoolP384t1",oR="brainpoolP512r1",iR="brainpoolP512t1",Pt="ECDSA",h1=X3=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Pt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return xk;case"sha-256":return Ek;case"sha-384":return Sk;case"sha-512":return _k}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=S9;break;case"K-256":t=X3.SECP256K1;break;case"P-384":t=_9;break;case"P-521":t=A9;break;case WO:t=RO;break;case zO:t=DO;break;case GO:t=NO;break;case XO:t=LO;break;case YO:t=BO;break;case QO:t=MO;break;case ZO:t=UO;break;case JO:t=FO;break;case eR:t=jO;break;case tR:t=KO;break;case rR:t=$O;break;case nR:t=VO;break;case oR:t=qO;break;case iR:t=HO;break}if(t)return new Y({algorithm:Fl,parameters:J.serialize(new Di({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case Yh:return{name:Pt,hash:{name:"SHA-1"}};case Qh:return{name:Pt,hash:{name:"SHA-256"}};case Zh:return{name:Pt,hash:{name:"SHA-384"}};case Jh:return{name:Pt,hash:{name:"SHA-512"}};case Fl:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(J.parse(e.parameters,Di).namedCurve){case S9:return{name:Pt,namedCurve:"P-256"};case X3.SECP256K1:return{name:Pt,namedCurve:"K-256"};case _9:return{name:Pt,namedCurve:"P-384"};case A9:return{name:Pt,namedCurve:"P-521"};case RO:return{name:Pt,namedCurve:WO};case DO:return{name:Pt,namedCurve:zO};case NO:return{name:Pt,namedCurve:GO};case LO:return{name:Pt,namedCurve:XO};case BO:return{name:Pt,namedCurve:YO};case MO:return{name:Pt,namedCurve:QO};case UO:return{name:Pt,namedCurve:ZO};case FO:return{name:Pt,namedCurve:JO};case jO:return{name:Pt,namedCurve:eR};case KO:return{name:Pt,namedCurve:tR};case $O:return{name:Pt,namedCurve:rR};case VO:return{name:Pt,namedCurve:nR};case qO:return{name:Pt,namedCurve:oR};case HO:return{name:Pt,namedCurve:iR}}}}return null}};h1.SECP256K1="1.3.132.0.10";h1=X3=r1([$a()],h1);yt.registerSingleton(w1,h1);var yR=Symbol("name"),gR=Symbol("value"),Ve=class{constructor(e,t={},n=""){this[yR]=e,this[gR]=n;for(let o in t)this[o]=t[o]}};Ve.NAME=yR;Ve.VALUE=gR;var pb=class{static toTextObject(e){let t=new Ve("Algorithm Identifier",{},Ui.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Fl:{let n=new h1().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}},Ui=class{static toString(e){let t=this.items[e];return t||e}};Ui.items={[Kl]:"sha1",[O3]:"sha224",[$l]:"sha256",[Vl]:"sha384",[ql]:"sha512",[Ni]:"rsaEncryption",[Zf]:"sha1WithRSAEncryption",[Pk]:"sha224WithRSAEncryption",[k3]:"sha256WithRSAEncryption",[Jf]:"sha384WithRSAEncryption",[ed]:"sha512WithRSAEncryption",[Fl]:"ecPublicKey",[Yh]:"ecdsaWithSHA1",[P3]:"ecdsaWithSHA224",[Qh]:"ecdsaWithSHA256",[Zh]:"ecdsaWithSHA384",[Jh]:"ecdsaWithSHA512",[tk]:"TLS WWW server authentication",[rk]:"TLS WWW client authentication",[nk]:"Code Signing",[ok]:"E-mail Protection",[ik]:"Time Stamping",[sk]:"OCSP Signing",[bk]:"Signed Data"};var Ms=class{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){let n=[],o=this.pad(t++),i="",s=e[Ve.VALUE];s&&(i=` ${s}`),n.push(`${o}${e[Ve.NAME]}:${i}`),o=this.pad(t);for(let a in e){if(typeof a=="symbol")continue;let c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${o}${l}${c}`);else if(c instanceof Date)n.push(`${o}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(let u of c)u[Ve.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof Ve)c[Ve.NAME]=a,n.push(...this.serializeObj(c,t));else if(Q.BufferSourceConverter.isBufferSource(c))a?(n.push(`${o}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){let u=c.toTextObject();u[Ve.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){let n=this.pad(t),o=Q.BufferSourceConverter.toUint8Array(e),i=[];for(let s=0;s<o.length;){let a=[];for(let c=0;c<16&&s<o.length;c++){c===8&&a.push("");let l=o[s++].toString(16).padStart(2,"0");a.push(l)}i.push(`${n}${a.join(" ")}`)}return i}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}};Ms.oidSerializer=Ui;Ms.algorithmSerializer=pb;var za=class r{constructor(...e){if(e.length===1){let t=e[0];this.rawData=J.serialize(t),this.onInit(t)}else{let t=J.parse(e[0],e[1]);this.rawData=Q.BufferSourceConverter.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof r?(0,Q.isEqual)(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return J.toString(this.rawData);case"text":return Ms.serialize(this.toTextObject());case"hex":return Q.Convert.ToHex(this.rawData);case"base64":return Q.Convert.ToBase64(this.rawData);case"base64url":return Q.Convert.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){let e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Ve(this.getTextName(),{},e)}};za.NAME="ASN";var Xn=class r extends za{constructor(...e){let t;Q.BufferSourceConverter.isBufferSource(e[0])?t=Q.BufferSourceConverter.toArrayBuffer(e[0]):t=J.serialize(new Cr({extnID:e[0],critical:e[1],extnValue:new we(Q.BufferSourceConverter.toArrayBuffer(e[2]))})),super(t,Cr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Ve.NAME]===r.NAME&&(e[Ve.NAME]=Ui.toString(this.type)),e}},wR,m1=class r{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[wR]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(r.DEFAULT,crypto):typeof globalThis<"u"&&globalThis.crypto&&globalThis.crypto.subtle&&this.set(r.DEFAULT,globalThis.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=r.DEFAULT){let t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(r.DEFAULT,e);return this}};wR=Symbol.toStringTag;m1.DEFAULT="default";var Rr=new m1,Vq=/^[0-2](?:\.[1-9][0-9]*)+$/;function qq(r){return new RegExp(Vq).test(r)}var Q3=class{constructor(e={}){this.items={};for(let t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return qq(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}},_n=new Q3;_n.register("CN","2.5.4.3");_n.register("L","2.5.4.7");_n.register("ST","2.5.4.8");_n.register("O","2.5.4.10");_n.register("OU","2.5.4.11");_n.register("C","2.5.4.6");_n.register("DC","0.9.2342.19200300.100.1.25");_n.register("E","1.2.840.113549.1.9.1");_n.register("G","2.5.4.42");_n.register("I","2.5.4.43");_n.register("SN","2.5.4.4");_n.register("T","2.5.4.12");function Hq(r,e){return`\\${Q.Convert.ToHex(Q.Convert.FromUtf8String(e)).toUpperCase()}`}function Wq(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,Hq)}var Ao=class r{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new Q3,this.asn=new ut;for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let o=t[n];this.extraNames.register(n,o)}typeof e=="string"?this.asn=this.fromString(e):e instanceof ut?this.asn=e:Q.BufferSourceConverter.isBufferSource(e)?this.asn=J.parse(e,ut):this.asn=this.fromJSON(e)}getField(e){let t=this.extraNames.findId(e)||_n.findId(e),n=[];for(let o of this.asn)for(let i of o)i.type===t&&n.push(i.value.toString());return n}getName(e){return this.extraNames.get(e)||_n.get(e)}toString(){return this.asn.map(e=>e.map(t=>{let n=this.getName(t.type)||t.type,o=t.value.anyValue?`#${Q.Convert.ToHex(t.value.anyValue)}`:Wq(t.value.toString());return`${n}=${o}`}).join("+")).join(", ")}toJSON(){var e;let t=[];for(let n of this.asn){let o={};for(let i of n){let s=this.getName(i.type)||i.type;(e=o[s])!==null&&e!==void 0||(o[s]=[]),o[s].push(i.value.anyValue?`#${Q.Convert.ToHex(i.value.anyValue)}`:i.value.toString())}t.push(o)}return t}fromString(e){let t=new ut,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g,o=null,i=",";for(;o=n.exec(`${e},`);){let[,s,a]=o,c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),o[3]=c);let l=o[3];s=this.getTypeOid(s);let u=this.createAttribute(s,a);i==="+"?t[t.length-1].push(u):t.push(new Ca([u])),i=l}return t}fromJSON(e){let t=new ut;for(let n of e){let o=new Ca;for(let i in n){let s=this.getTypeOid(i),a=n[i];for(let c of a){let l=this.createAttribute(s,c);o.push(l)}}t.push(o)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){let n=new bl({type:e});if(typeof t=="object")for(let o in t)switch(o){case"ia5String":n.value.ia5String=t[o];break;case"utf8String":n.value.utf8String=t[o];break;case"universalString":n.value.universalString=t[o];break;case"bmpString":n.value.bmpString=t[o];break;case"printableString":n.value.printableString=t[o];break}else if(t[0]==="#")n.value.anyValue=Q.Convert.FromHex(t.slice(1));else{let o=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=o:r.isPrintableString(o)?n.value.printableString=o:n.value.utf8String=o}return n}processStringValue(e){let t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return J.serialize(this.asn)}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||Rr.get()):n=e[0]||Rr.get(),await n.subtle.digest(o,this.toArrayBuffer())}},bR="Cannot initialize GeneralName from ASN.1 data.",sR=`${bR} Unsupported string format in use.`,zq=`${bR} Value doesn't match to GUID regular expression.`,aR=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,cR="1.3.6.1.4.1.311.25.1",lR="1.3.6.1.4.1.311.20.2.3",nb="dns",ob="dn",ib="email",sb="ip",ab="url",cb="guid",lb="upn",W3="id",Mi=class extends za{constructor(...e){let t;if(e.length===2)switch(e[0]){case ob:{let n=new Ao(e[1]).toArrayBuffer(),o=J.parse(n,ut);t=new Ee({directoryName:o});break}case nb:t=new Ee({dNSName:e[1]});break;case ib:t=new Ee({rfc822Name:e[1]});break;case cb:{let n=new RegExp(aR,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");let o=n.slice(1).map((i,s)=>s<3?Q.Convert.ToHex(new Uint8Array(Q.Convert.FromHex(i)).reverse()):i).join("");t=new Ee({otherName:new Pa({typeId:cR,value:J.serialize(new we(Q.Convert.FromHex(o)))})});break}case sb:t=new Ee({iPAddress:e[1]});break;case W3:t=new Ee({registeredID:e[1]});break;case lb:{t=new Ee({otherName:new Pa({typeId:lR,value:J.serialize(Dw.toASN(e[1]))})});break}case ab:t=new Ee({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else Q.BufferSourceConverter.isBufferSource(e[0])?t=J.parse(e[0],Ee):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=nb,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=ib,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=sb,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=ab,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=W3,this.value=e.registeredID;else if(e.directoryName!=null)this.type=ob,this.value=new Ao(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===cR){this.type=cb;let t=J.parse(e.otherName.value,we),n=new RegExp(aR,"i").exec(Q.Convert.ToHex(t));if(!n)throw new Error(zq);this.value=n.slice(1).map((o,i)=>i<3?Q.Convert.ToHex(new Uint8Array(Q.Convert.FromHex(o)).reverse()):o).join("-")}else if(e.otherName.typeId===lR)this.type=lb,this.value=J.parse(e.otherName.value,Jt).toString();else throw new Error(sR);else throw new Error(sR)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case ob:case nb:case cb:case sb:case W3:case lb:case ab:e=this.type.toUpperCase();break;case ib:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===W3&&(t=Ui.toString(t)),new Ve(e,void 0,t)}},Us=class extends za{constructor(e){let t;if(e instanceof Et)t=e;else if(Array.isArray(e)){let n=[];for(let o of e)if(o instanceof Ee)n.push(o);else{let i=J.parse(new Mi(o.type,o.value).rawData,Ee);n.push(i)}t=new Et(n)}else if(Q.BufferSourceConverter.isBufferSource(e))t=J.parse(e,Et);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){let t=[];for(let n of e){let o=null;try{o=new Mi(n)}catch{continue}t.push(o)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){let e=super.toTextObjectEmpty();for(let t of this.items){let n=t.toTextObject(),o=e[n[Ve.NAME]];Array.isArray(o)||(o=[],e[n[Ve.NAME]]=o),o.push(n)}return e}};Us.NAME="GeneralNames";var p1="-{5}",y1="\\n",Gq=`[^${y1}]+`,Xq=`${p1}BEGIN (${Gq}(?=${p1}))${p1}`,Yq=`${p1}END \\1${p1}`,ld="\\n",Qq=`[^:${y1}]+`,Zq=`(?:[^${y1}]+${ld}(?: +[^${y1}]+${ld})*)`,Jq="[a-zA-Z0-9=+/]+",eH=`(?:${Jq}${ld})+`,uR=`${Xq}${ld}(?:((?:${Qq}: ${Zq})+))?${ld}?(${eH})${Yq}`,nn=class{static isPem(e){return typeof e=="string"&&new RegExp(uR,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");let t=new RegExp(uR,"g"),n=[],o=null;for(;o=t.exec(e);){let i=o[3].replace(new RegExp(`[${y1}]+`,"g"),""),s={type:o[1],headers:[],rawData:Q.Convert.FromBase64(i)},a=o[2];if(a){let c=a.split(new RegExp(ld,"g")),l=null;for(let u of c){let[f,d]=u.split(/:(.*)/);if(d===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=f.trim()}else l&&s.headers.push(l),l={key:f,value:d.trim()}}l&&s.headers.push(l)}n.push(s)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){let t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){let n=new Array;return t?e.forEach(o=>{if(!Q.BufferSourceConverter.isBufferSource(o))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:Q.BufferSourceConverter.toArrayBuffer(o)}))}):e.forEach(o=>{if(!("type"in o))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(o))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:Q.BufferSourceConverter.toArrayBuffer(e)})}}static encodeStruct(e){var t;let n=e.type.toLocaleUpperCase(),o=[];if(o.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(let l of e.headers)o.push(`${l.key}: ${l.value}`);o.push("")}let i=Q.Convert.ToBase64(e.rawData),s,a=0,c=Array();for(;a<i.length&&(i.length-a<64?s=i.substring(a):(s=i.substring(a,a+64),a+=64),s.length!==0);)if(c.push(s),s.length<64)break;return o.push(...c),o.push(`-----END ${n}-----`),o.join(`
`)}};nn.CertificateTag="CERTIFICATE";nn.CrlTag="CRL";nn.CertificateRequestTag="CERTIFICATE REQUEST";nn.PublicKeyTag="PUBLIC KEY";nn.PrivateKeyTag="PRIVATE KEY";var Ga=class r extends za{static isAsnEncoded(e){return Q.BufferSourceConverter.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(nn.isPem(e))return nn.decode(e)[0];if(Q.Convert.isHex(e))return Q.Convert.FromHex(e);if(Q.Convert.isBase64(e))return Q.Convert.FromBase64(e);if(Q.Convert.isBase64Url(e))return Q.Convert.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{let t=Q.Convert.ToBinary(e);return nn.isPem(t)?nn.decode(t)[0]:Q.Convert.isHex(t)?Q.Convert.FromHex(t):Q.Convert.isBase64(t)?Q.Convert.FromBase64(t):Q.Convert.isBase64Url(t)?Q.Convert.FromBase64Url(t):Q.BufferSourceConverter.toArrayBuffer(e)}}constructor(...e){r.isAsnEncoded(e[0])?super(r.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return nn.encode(this.rawData,this.tag);default:return super.toString(e)}}},Bs=class r extends Ga{static async create(e,t=Rr.get()){if(e instanceof r)return e;if(m1.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");let n=await t.subtle.exportKey("spki",e);return new r(n)}else{if(e.publicKey)return e.publicKey;if(Q.BufferSourceConverter.isBufferSource(e))return new r(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Ga.isAsnEncoded(e)?super(e,Ir):super(e),this.tag=nn.PublicKeyTag}async export(...e){let t,n=["verify"],o={hash:"SHA-256",...this.algorithm};e.length>1?(o=e[0]||o,n=e[1]||n,t=e[2]||Rr.get()):t=e[0]||Rr.get();let i=this.rawData,s=J.parse(this.rawData,Ir);return s.algorithm.algorithm===Fa&&(i=tH(s,i)),t.subtle.importKey("spki",i,o,!0,n)}onInit(e){let t=yt.resolve(Ql),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case Ni:{let o=J.parse(e.subjectPublicKey,nd),i=Q.BufferSourceConverter.toUint8Array(o.modulus);n.publicExponent=Q.BufferSourceConverter.toUint8Array(o.publicExponent),n.modulusLength=(i[0]?i:i.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||Rr.get()):n=e[0]||Rr.get(),await n.subtle.digest(o,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=Rr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=Rr.get();let o=J.parse(this.rawData,Ir);return await t.subtle.digest(n,o.subjectPublicKey)}toTextObject(){let e=this.toTextObjectEmpty(),t=J.parse(this.rawData,Ir);switch(e.Algorithm=Ms.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Fl:e["EC Point"]=t.subjectPublicKey;break;case Ni:default:e["Raw Data"]=t.subjectPublicKey}return e}};function tH(r,e){return r.algorithm=new Y({algorithm:Ni,parameters:null}),e=J.serialize(r),e}var Z3=class r extends Xn{static async create(e,t=!1,n=Rr.get()){if("name"in e&&"serialNumber"in e)return new r(e,t);let i=await(await Bs.create(e,n)).getKeyIdentifier(n);return new r(Q.Convert.ToHex(i),t)}constructor(...e){if(Q.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){let t=new Pi({keyIdentifier:new El(Q.Convert.FromHex(e[0]))});super(c3,e[1],J.serialize(t))}else{let t=e[0],n=t.name instanceof Us?J.parse(t.name.rawData,Et):t.name,o=new Pi({authorityCertIssuer:n,authorityCertSerialNumber:Q.Convert.FromHex(t.serialNumber)});super(c3,e[1],J.serialize(o))}}onInit(e){super.onInit(e);let t=J.parse(e.extnValue,Pi);t.keyIdentifier&&(this.keyId=Q.Convert.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?Q.Convert.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){let e=this.toTextObjectWithoutValue(),t=J.parse(this.value,Pi);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Us(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}};Z3.NAME="Authority Key Identifier";var ud=class extends Xn{constructor(...e){if(Q.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=J.parse(this.value,Sl);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{let t=new Sl({cA:e[0],pathLenConstraint:e[1]});super(l3,e[2],J.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}};ud.NAME="Basic Constraints";var fR;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(fR||(fR={}));var J3=class extends Xn{constructor(...e){if(Q.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=J.parse(this.value,Oh);this.usages=t.map(n=>n)}else{let t=new Oh(e[0]);super(p3,e[1],J.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Ui.toString(t)).join(", "),e}};J3.NAME="Extended Key Usages";var dR;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(dR||(dR={}));var e4=class extends Xn{constructor(...e){if(Q.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=J.parse(this.value,Lf);this.usages=t.toNumber()}else{let t=new Lf(e[0]);super(h3,e[1],J.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=J.parse(this.value,Lf);return e[""]=t.toJSON().join(", "),e}};e4.NAME="Key Usages";var t4=class r extends Xn{static async create(e,t=!1,n=Rr.get()){let i=await(await Bs.create(e,n)).getKeyIdentifier(n);return new r(Q.Convert.ToHex(i),t)}constructor(...e){if(Q.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=J.parse(this.value,bn);this.keyId=Q.Convert.ToHex(t)}else{let t=typeof e[0]=="string"?Q.Convert.FromHex(e[0]):e[0],n=new bn(t);super(s9,e[1],J.serialize(n)),this.keyId=Q.Convert.ToHex(t)}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=J.parse(this.value,bn);return e[""]=t,e}};t4.NAME="Subject Key Identifier";var r4=class extends Xn{constructor(...e){Q.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(o9,e[1],new Us(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=J.parse(e.extnValue,w3);this.names=new Us(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};r4.NAME="Subject Alternative Name";var on=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new Xn(e),n=this.items.get(t.type);return n?new n(e):t}};on.items=new Map;var n4=class extends Xn{constructor(...e){var t;if(Q.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let n=J.parse(this.value,Th);this.policies=n.map(o=>o.policyIdentifier)}else{let n=e[0],o=(t=e[1])!==null&&t!==void 0?t:!1,i=new Th(n.map(s=>new _l({policyIdentifier:s})));super(f3,o,J.serialize(i)),this.policies=n}}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Ve("",{},Ui.toString(t))),e}};n4.NAME="Certificate Policies";on.register(f3,n4);var o4=class extends Xn{constructor(...e){var t;if(Q.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){let o=e[0].map(s=>new ki({distributionPoint:new Ps({fullName:[new Ee({uniformResourceIdentifier:s})]})})),i=new Ra(o);super(d3,e[1],J.serialize(i))}else{let n=new Ra(e[0]);super(d3,e[1],J.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);let t=J.parse(e.extnValue,Ra);this.distributionPoints=t}toTextObject(){let e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;let o={};return t.distributionPoint&&(o[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(i=>new Mi(i).toString()).join(", ")),t.reasons&&(o.Reasons=t.reasons.toString()),t.cRLIssuer&&(o["CRL Issuer"]=t.cRLIssuer.map(i=>i.toString()).join(", ")),o}),e}};o4.NAME="CRL Distribution Points";var i4=class extends Xn{constructor(...e){var t,n,o,i;if(Q.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof xl){let s=new xl(e[0]);super(a3,e[1],J.serialize(s))}else{let s=e[0],a=new xl;G3(a,s,Kw,"ocsp"),G3(a,s,$w,"caIssuers"),G3(a,s,Vw,"timeStamping"),G3(a,s,qw,"caRepository"),super(a3,e[1],J.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(o=this.timeStamping)!==null&&o!==void 0||(this.timeStamping=[]),(i=this.caRepository)!==null&&i!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],J.parse(e.extnValue,xl).forEach(n=>{switch(n.accessMethod){case Kw:this.ocsp.push(new Mi(n.accessLocation));break;case $w:this.caIssuers.push(new Mi(n.accessLocation));break;case Vw:this.timeStamping.push(new Mi(n.accessLocation));break;case qw:this.caRepository.push(new Mi(n.accessLocation));break}})}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ocsp.length&&z3(e,"OCSP",this.ocsp),this.caIssuers.length&&z3(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&z3(e,"Time Stamping",this.timeStamping),this.caRepository.length&&z3(e,"CA Repository",this.caRepository),e}};i4.NAME="Authority Info Access";function z3(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{let n=new Ve("");t.forEach((o,i)=>{let s=o.toTextObject(),a=`${s[Ve.NAME]} ${i+1}`,c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(s)}),r[e]=n}}function G3(r,e,t,n){let o=e[n];o&&(Array.isArray(o)?o:[o]).forEach(s=>{typeof s=="string"&&(s=new Mi("url",s)),r.push(new Is({accessMethod:t,accessLocation:J.parse(s.rawData,Ee)}))})}var s4=class extends Xn{constructor(...e){Q.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(e9,e[1],new Us(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=J.parse(e.extnValue,Et);this.names=new Us(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};s4.NAME="Issuer Alternative Name";var fd=class r extends za{constructor(...e){let t;if(Q.BufferSourceConverter.isBufferSource(e[0]))t=Q.BufferSourceConverter.toArrayBuffer(e[0]);else{let n=e[0],o=Array.isArray(e[1])?e[1].map(i=>Q.BufferSourceConverter.toArrayBuffer(i)):[];t=J.serialize(new Tr({type:n,values:o}))}super(t,Tr)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Ve("",{"":t})),e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty();return e[Ve.NAME]===r.NAME&&(e[Ve.NAME]=Ui.toString(this.type)),e}};fd.NAME="Attribute";var a4=class extends fd{constructor(...e){var t;if(Q.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=new c1({printableString:e[0]});super(tb,[J.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){let t=J.parse(this.values[0],c1);this.password=t.toString()}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[Ve.VALUE]=this.password,e}};a4.NAME="Challenge Password";var g1=class extends fd{constructor(...e){var t;if(Q.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=e[0],o=new zn;for(let i of n)o.push(J.parse(i.rawData,Cr));super(u1,[J.serialize(o)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){let t=J.parse(this.values[0],zn);this.items=t.map(n=>on.create(J.serialize(n)))}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(let n of t)e[n[Ve.NAME]]=n;return e}};g1.NAME="Extensions";var dd=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new fd(e),n=this.items.get(t.type);return n?new n(e):t}};dd.items=new Map;var b1="crypto.signatureFormatter",hb=class{toAsnSignature(e,t){return Q.BufferSourceConverter.toArrayBuffer(t)}toWebSignature(e,t){return Q.BufferSourceConverter.toArrayBuffer(t)}},Y3,mb=Y3=class{static createPssParams(e,t){let n=Y3.getHashAlgorithm(e);return n?new Li({hashAlgorithm:n,maskGenAlgorithm:new Y({algorithm:ja,parameters:J.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){let t=yt.resolve(Ql);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new Y({algorithm:Zf,parameters:null});case"sha-256":return new Y({algorithm:k3,parameters:null});case"sha-384":return new Y({algorithm:Jf,parameters:null});case"sha-512":return new Y({algorithm:ed,parameters:null})}}else return new Y({algorithm:Ni,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");let t=Y3.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new Y({algorithm:Fa,parameters:J.serialize(t)})}else return new Y({algorithm:Fa,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case Ni:return{name:"RSASSA-PKCS1-v1_5"};case Zf:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case k3:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Jf:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case ed:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case Fa:if(e.parameters){let t=J.parse(e.parameters,Li);return{name:"RSA-PSS",hash:yt.resolve(Ql).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};mb=Y3=r1([$a()],mb);yt.registerSingleton(w1,mb);var yb=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new Y({algorithm:Kl});case"sha-256":return new Y({algorithm:$l});case"sha-384":return new Y({algorithm:Vl});case"sha-512":return new Y({algorithm:ql})}return null}toWebAlgorithm(e){switch(e.algorithm){case Kl:return{name:"SHA-1"};case $l:return{name:"SHA-256"};case Vl:return{name:"SHA-384"};case ql:return{name:"SHA-512"}}return null}};yb=r1([$a()],yb);yt.registerSingleton(w1,yb);var Fs=class r{addPadding(e,t){let n=Q.BufferSourceConverter.toUint8Array(t),o=new Uint8Array(e);return o.set(n,e-n.length),o}removePadding(e,t=!1){let n=Q.BufferSourceConverter.toUint8Array(e);for(let o=0;o<n.length;o++)if(n[o]){n=n.slice(o);break}if(t&&n[0]>127){let o=new Uint8Array(n.length+1);return o.set(n,1),o.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){let n=e.namedCurve,o=r.namedCurveSize.get(n)||r.defaultNamedCurveSize,i=new jl,s=Q.BufferSourceConverter.toUint8Array(t);return i.r=this.removePadding(s.slice(0,o),!0),i.s=this.removePadding(s.slice(o,o+o),!0),J.serialize(i)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){let n=J.parse(t,jl),o=e.namedCurve,i=r.namedCurveSize.get(o)||r.defaultNamedCurveSize,s=this.addPadding(i,this.removePadding(n.r)),a=this.addPadding(i,this.removePadding(n.s));return(0,Q.combine)(s,a)}return null}};Fs.namedCurveSize=new Map;Fs.defaultNamedCurveSize=32;var ub="1.3.101.110",pR="1.3.101.111",fb="1.3.101.112",hR="1.3.101.113",gb=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=fb;break;case"x25519":t=ub;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=fb;break;case"ed448":t=hR;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=ub;break;case"x448":t=pR;break}}return t?new Y({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case fb:return{name:"Ed25519"};case hR:return{name:"EdDSA",namedCurve:"Ed448"};case ub:return{name:"X25519"};case pR:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};gb=r1([$a()],gb);yt.registerSingleton(w1,gb);var wb=class extends Ga{constructor(e){Ga.isAsnEncoded(e)?super(e,Wa):super(e),this.tag=nn.CertificateRequestTag}onInit(e){this.tbs=J.serialize(e.certificationRequestInfo),this.publicKey=new Bs(e.certificationRequestInfo.subjectPKInfo);let t=yt.resolve(Ql);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(o=>dd.create(J.serialize(o)));let n=this.getAttribute(u1);this.extensions=[],n instanceof g1&&(this.extensions=n.items),this.subjectName=new Ao(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(let t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(let t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=Rr.get()){let t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),o=yt.resolveAll(b1).reverse(),i=null;for(let a of o)if(i=a.toWebSignature(t,this.signature),i)break;if(!i)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,i,this.tbs)}toTextObject(){let e=this.toTextObjectEmpty(),t=J.parse(this.rawData,Wa),n=t.certificationRequestInfo,o=new Ve("",{Version:`${Oi[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){let i=new Ve("");for(let s of this.attributes){let a=s.toTextObject();i[a[Ve.NAME]]=a}o.Attributes=i}return e.Data=o,e.Signature=new Ve("",{Algorithm:Ms.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}};wb.NAME="PKCS#10 Certificate Request";var pd=class extends Ga{constructor(e){Ga.isAsnEncoded(e)?super(e,vo):super(e),this.tag=nn.CertificateTag}onInit(e){let t=e.tbsCertificate;this.tbs=J.serialize(t);let n=new Uint8Array(t.serialNumber);n.length>1&&n[0]===0&&n[1]>127&&(n=n.slice(1)),this.serialNumber=Q.Convert.ToHex(n),this.subjectName=new Ao(t.subject),this.subject=new Ao(t.subject).toString(),this.issuerName=new Ao(t.issuer),this.issuer=this.issuerName.toString();let o=yt.resolve(Ql);this.signatureAlgorithm=o.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;let i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;let s=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!s)throw new Error("Cannot get 'notAfter' value");this.notAfter=s,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(a=>on.create(J.serialize(a)))),this.publicKey=new Bs(t.subjectPublicKeyInfo)}getExtension(e){for(let t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=Rr.get()){let n,o,i=e.publicKey;try{if(!i)n={...this.publicKey.algorithm,...this.signatureAlgorithm},o=await this.publicKey.export(n,["verify"],t);else if("publicKey"in i)n={...i.publicKey.algorithm,...this.signatureAlgorithm},o=await i.publicKey.export(n,["verify"],t);else if(i instanceof Bs)n={...i.algorithm,...this.signatureAlgorithm},o=await i.export(n,["verify"],t);else if(Q.BufferSourceConverter.isBufferSource(i)){let l=new Bs(i);n={...l.algorithm,...this.signatureAlgorithm},o=await l.export(n,["verify"],t)}else n={...i.algorithm,...this.signatureAlgorithm},o=i}catch{return!1}let s=yt.resolveAll(b1).reverse(),a=null;for(let l of s)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");let c=await t.subtle.verify(this.signatureAlgorithm,o,a,this.tbs);if(e.signatureOnly)return c;{let u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=Rr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=Rr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){let e=this.toTextObjectEmpty(),t=J.parse(this.rawData,vo),n=t.tbsCertificate,o=new Ve("",{Version:`${Oi[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":Ms.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new Ve("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(o["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(o["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){let i=new Ve("");for(let s of this.extensions){let a=s.toTextObject();i[a[Ve.NAME]]=a}o.Extensions=i}return e.Data=o,e.Signature=new Ve("",{Algorithm:Ms.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}};pd.NAME="Certificate";var c4=class{static async createSelfSigned(e,t=Rr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=Rr.get()){var n;let o;e.publicKey instanceof Bs?o=e.publicKey.rawData:"publicKey"in e.publicKey?o=e.publicKey.publicKey.rawData:Q.BufferSourceConverter.isBufferSource(e.publicKey)?o=e.publicKey:o=await t.subtle.exportKey("spki",e.publicKey);let i=e.serialNumber?Q.BufferSourceConverter.toUint8Array(Q.Convert.FromHex(e.serialNumber)):void 0;i=this.generateSerialNumber(i,t);let s=e.notBefore||new Date,a=e.notAfter||new Date(s.getTime()+31536e6),c=new vo({tbsCertificate:new Pr({version:Oi.v3,serialNumber:i,validity:new ks({notBefore:s,notAfter:a}),extensions:new zn(((n=e.extensions)===null||n===void 0?void 0:n.map(y=>J.parse(y.rawData,Cr)))||[]),subjectPublicKeyInfo:J.parse(o,Ir)})});if(e.subject){let y=e.subject instanceof Ao?e.subject:new Ao(e.subject);c.tbsCertificate.subject=J.parse(y.toArrayBuffer(),ut)}if(e.issuer){let y=e.issuer instanceof Ao?e.issuer:new Ao(e.issuer);c.tbsCertificate.issuer=J.parse(y.toArrayBuffer(),ut)}let l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},f=yt.resolve(Ql);c.tbsCertificate.signature=c.signatureAlgorithm=f.toAsnAlgorithm(u);let d=J.serialize(c.tbsCertificate),p="signingKey"in e?await t.subtle.sign(u,e.signingKey,d):e.signature,m=yt.resolveAll(b1).reverse(),g=null;for(let y of m)if(g=y.toAsnSignature(u,p),g)break;if(!g)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=g,new pd(J.serialize(c))}static generateSerialNumber(e,t){let n=e&&e.length&&e.some(i=>i>0)?new Uint8Array(e):void 0;n||(n=t.getRandomValues(new Uint8Array(16)));let o=0;for(;o<n.length-1&&n[o]===0;)o++;if(n=n.slice(o),n[0]>127){let i=new Uint8Array(n.length+1);i[0]=0,i.set(n,1),n=i}return n}},mR;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(mR||(mR={}));on.register(l3,ud);on.register(p3,J3);on.register(h3,e4);on.register(s9,t4);on.register(c3,Z3);on.register(o9,r4);on.register(d3,o4);on.register(a3,i4);on.register(e9,s4);dd.register(tb,a4);dd.register(u1,g1);yt.registerSingleton(b1,hb);yt.registerSingleton(b1,Fs);Fs.namedCurveSize.set("P-256",32);Fs.namedCurveSize.set("K-256",32);Fs.namedCurveSize.set("P-384",48);Fs.namedCurveSize.set("P-521",66);var l4=class extends De{async listen(){throw new Jg("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}};var bb=Object.values(oc).map(r=>r.decoder).reduce((r,e)=>r.or(e)),rH=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function vR(r){return r?.match(rH)?.groups?.fingerprint}function vb(r){let t=r.stringTuples().filter(n=>n[0]===xP).map(n=>n[1])[0];if(t===void 0||t==="")throw new M(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function nH(r){return Rt.decode(bb.decode(r))}function oH(r){let e=nH(vb(r)),t=iH(e.code),n=e.digest.reduce((i,s)=>i+s.toString(16).padStart(2,"0"),""),o=n.match(/.{1,2}/g);if(o==null)throw new Zg(n,r.toString());return`${t} ${o.join(":").toUpperCase()}`}function xR(r){let e=r.split(":").map(o=>parseInt(o,16)),t=Uint8Array.from(e),n=Br(wt.code,t);return ie(`/certhash/${ec.encode(n.bytes)}`)}function iH(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new e3(r)}}function ER(r,e){let{host:t,port:n,family:o}=r.toOptions(),i=oH(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${o} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${o} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${Of}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function SR(r,e){let{host:t,port:n,family:o}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${o} ${t}
s=-
c=IN IP${o} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${Of}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function xb(r,e){if(r.sdp===void 0)throw new M("Can't munge a missing SDP");let t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}var Eb=q("libp2p-webrtc-noise:");function AR(r,e,t){let n=r.trim().toLowerCase().replaceAll(":",""),o=q(n,"hex"),i=Br(wt.code,o),s=bb.decode(vb(e)),a=Eb.byteLength+i.bytes.byteLength+s.byteLength;return t==="server"?St([Eb,s,i.bytes],a):St([Eb,i.bytes,s],a)}var sH=wh?"iceconnectionstatechange":"connectionstatechange";async function TR(r,e,t){let n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");let f=await r.createOffer();t.log.trace("client created local offer %s",f.sdp);let d=xb(f,e);t.log.trace("client setting local offer %s",d.sdp),await r.setLocalDescription(d);let p=ER(t.remoteAddr,e);t.log.trace("client setting server description %s",p.sdp),await r.setRemoteDescription(p)}else{let f=SR(t.remoteAddr,e);t.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),t.log.trace("server creating local answer");let d=await r.createAnswer();t.log.trace("server created local answer");let p=xb(d,e);t.log.trace("server setting local description %s",d.sdp),await r.setLocalDescription(p)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await Dt(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){let f=r.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(xR(f))}let o=vR(r.localDescription?.sdp);if(o==null)throw new Aa("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);let i=AR(o,t.remoteAddr,t.role),s=Ny({prologueBytes:i})(t),a=Rf({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),c=new wl(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(sH,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(f=>{t.log.error("error closing connection",f),c.abort(f)});break;default:break}}),t.events?.increment({peer_connection:!0});let l=new _a(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await s.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);let u=await s.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(o){throw n.close(),o}}async function IR(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));let o=typeof t=="function"?await t():t;return new RTCPeerConnection({...o??{},certificates:[n]})}async function CR(r){let e=await a0(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...W(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var u4=class{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new De,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new M("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[Ks]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[He]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n,o=e.getPeerId();o!=null&&(n=Ct(o));let i=UP(),s=await IR("client",i,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await TR(s,i,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(a){throw s.close(),a}}createListener(e){if(this.certificate==null)throw new Tn;return new l4(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(xp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(aH(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;let t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:o}=await this.loadOrCreateCertificate(t,e);return{privateKey:await CR(t),pem:n,certhash:o}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;let e=this.init.certificateKeychainName??PP,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new qe;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await Fu("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n,o=new ct(this.init.certificateDatastoreKey??CP),i=await a0(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new qe;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(o,i)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(o,i)}let s=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??Iw)-Date.now();return s<0&&(s=100),this.log("will renew TLS certificate after %d ms",s),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},s),{pem:n.toString("pem"),certhash:ec.encode((await wt.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){let n=await this.components.datastore.get(e),o=new pd(n),i=o.notAfter.getTime()-(this.init.certificateRenewalThreshold??Iw);if(Date.now()>i)throw this.log("stored TLS certificate has expired"),new qe;this.log("loaded certificate, expires in %d ms",i);let s=await o.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",s),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!me(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new qe;return this.log("loaded certificate, expiry time is %o",i),o}async createCertificate(e,t){let n=new Date,o=new Date(Date.now()+(this.init.certificateLifespan??kP));n.setMilliseconds(0),o.setMilliseconds(0);let i=await c4.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:o,keys:t,extensions:[new ud(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,q(i.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),i}getKeychain(){try{return this.components.keychain}catch{}}};function aH(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function PR(r){return e=>new u4(e,r)}function kR(r){return e=>new o3(e,r)}var OR=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",o),r.removeEventListener("error",i)}function o(){n(),e()}function i(s){n(),t(s.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",o),r.addEventListener("error",i)})};var RR=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let o of n){try{await OR(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(o)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((o,i)=>{r.addEventListener("close",s=>{if(s.wasClean||s.code===1006)o();else{let a=Object.assign(new Error("ws error"),{event:s});i(a)}}),setTimeout(()=>{r.close()})})});var BR=tr(NR(),1);function LR(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var MR=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((i,s)=>{if(n){i();return}if(o!=null){s(o);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{s(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let i=new BR.EventIterator(({push:s,stop:a,fail:c})=>{let l=f=>{let d=null;typeof f.data=="string"&&(d=q(f.data)),LR(f.data)&&(d=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(d=f.data),d!=null&&s(d)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let s of i)yield LR(s)?new Uint8Array(s):s}(),n=r.readyState===1,o;return r.addEventListener("open",()=>{n=!0,o=null}),r.addEventListener("close",()=>{n=!1,o=null}),r.addEventListener("error",i=>{n||(o=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var UR=(r,e)=>{e=e??{};let t=MR(r),n=e.remoteAddress,o=e.remotePort;if(r.url!=null)try{let s=new URL(r.url);n=s.hostname,o=parseInt(s.port,10)}catch{}if(n==null||o==null)throw new Error("Remote connection did not have address and/or port");return{sink:RR(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(s=>{r.addEventListener("close",()=>{s()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:o,socket:r}};var FR=WebSocket;var lH={"http:":"ws:","https:":"wss:"},jR="ws:",KR=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??jR}${r}`),r.startsWith("/")&&e!=null){let n=e.protocol??jR,o=e.host,i=e.port!=null&&o?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${o}${i}${r}`}let t=new URL(r);for(let[n,o]of Object.entries(lH))t.protocol===n&&(t.protocol=o);return t};function $R(r,e){let t=typeof window>"u"?void 0:window.location;e=e??{};let n=KR(r,t),o=new FR(n.toString(),e.websocket);return UR(o,e)}function VR(r){return r.filter(e=>Uc.exactMatch(e)||ms.exactMatch(e))}function qR(){throw new Error("WebSocket Servers can not be created in the browser!")}function HR(r,e,t){let n=t.logger.forComponent("libp2p:websockets:maconn"),o=t.metrics,i=t.metricPrefix??"",s={log:n,async sink(a){try{await r.sink(async function*(){for await(let c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){let c=Date.now();if(a.signal==null){let u=AbortSignal.timeout(500);a={...a,signal:u}}let l=()=>{let{host:u,port:f}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",u,f,Date.now()-c),this.abort(new rr("Socket close timeout"))};a.signal?.addEventListener("abort",l);try{await r.close()}catch(u){n.error("error closing WebSocket gracefully",u),this.abort(u)}finally{a.signal?.removeEventListener("abort",l),s.timeline.close=Date.now()}},abort(a){let{host:c,port:l}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),s.timeline.close=Date.now(),o?.increment({[`${i}error`]:!0})}};return r.socket.addEventListener("close",()=>{o?.increment({[`${i}close`]:!0}),s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}var Ab=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Ks]=!0;[Symbol.toStringTag]="@libp2p/websockets";[He]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let n=await this._connect(e,t),o=HR(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",o.remoteAddr);let i=await t.upgrader.upgradeOutbound(o,t);return this.log("outbound connection %s upgraded",o.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();let n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);let o=ve(),i=$R(Yu(e),this.init);i.socket.addEventListener("error",()=>{let s=new Jl(`Could not connect to ${e.toString()}`);this.log.error("connection error:",s),this.metrics?.dialerEvents.increment({error:!0}),o.reject(s)});try{t.onProgress?.(new ce("websockets:open-connection")),await nt(Promise.race([i.connected(),o.promise]),t.signal)}catch(s){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),s}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return qR({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):VR(e)}dialFilter(e){return this.listenFilter(e)}};function WR(r={}){return e=>new Ab(e,r)}var Tb=tr(G0(),1);function zR(r,e){let t=e.map((n,o)=>({record:Ei(n),index:o}));return t.sort((n,o)=>{let i=n.record.sequence,s=o.record.sequence;if(i>s)return-1;if(i<s)return 1;if(n.record.validityType===dn.ValidityType.EOL&&o.record.validityType===dn.ValidityType.EOL){let a=Tb.default.fromString(n.record.validity).toDate(),c=Tb.default.fromString(o.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}var GR="5.5.0",XR="helia";var YR={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function p4(r={}){let e=`${XR}/${GR} ${ry()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[sw(),kR(),PR(),WR()],connectionEncrypters:[Ny()],streamMuxers:[$I(),hP()],peerDiscovery:[oC(YR)],services:{autoNAT:zI(),dcutr:wC(),delegatedRouting:()=>tA("https://delegated-ipfs.dev",O8()),dht:aP({clientMode:!0,validators:{ipns:t2},selectors:{ipns:zR}}),identify:_C(),identifyPush:AC(),keychain:Ay(r.keychain),ping:wP()}}}async function QR(r){let e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await T7(r.datastore,r.keychain));let t=p4(e);return t.datastore=t.datastore??r.datastore,await iT({...t,...e,start:!1})}async function Ib(r={}){let e=r.datastore??new jc,t=r.blockstore??new Ip,n;return sT(r.libp2p)?n=r.libp2p:n=await QR({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[P8(),Q5()],routers:r.routers??[$8(n),j8()],metrics:n.metrics}}async function fH(r={}){let e=await Ib(r),t=new f0(e);return e.start!==!1&&await t.start(),t}return dD(dH);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

tslib/tslib.js:
  (*! *****************************************************************************
  Copyright (c) Microsoft Corporation.
  
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.
  
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** *)

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/utils.js:
@noble/curves/esm/abstract/modular.js:
@noble/curves/esm/abstract/curve.js:
@noble/curves/esm/abstract/edwards.js:
@noble/curves/esm/abstract/montgomery.js:
@noble/curves/esm/ed25519.js:
@noble/curves/esm/abstract/weierstrass.js:
@noble/curves/esm/_shortw_utils.js:
@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@peculiar/x509/build/x509.es.js:
  (*!
   * MIT License
   * 
   * Copyright (c) Peculiar Ventures. All rights reserved.
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)
*/
return Helia}));
//# sourceMappingURL=index.min.js.map
