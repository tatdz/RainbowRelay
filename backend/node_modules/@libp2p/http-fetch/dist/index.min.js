(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2PHttpFetch = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2PHttpFetch=(()=>{var Ct=Object.defineProperty;var gr=Object.getOwnPropertyDescriptor;var br=Object.getOwnPropertyNames;var yr=Object.prototype.hasOwnProperty;var A=(r,t)=>{for(var e in t)Ct(r,e,{get:t[e],enumerable:!0})},xr=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of br(t))!yr.call(r,o)&&o!==e&&Ct(r,o,{get:()=>t[o],enumerable:!(n=gr(t,o))||n.enumerable});return r};var Er=r=>xr(Ct({},"__esModule",{value:!0}),r);var xo={};A(xo,{WELL_KNOWN_PROTOCOLS:()=>st,http:()=>bo,httpCustomServer:()=>yo});var vr=Symbol.for("@libp2p/peer-id");function St(r){return!!r?.[vr]}function B(r=0){return new Uint8Array(r)}function H(r=0){return new Uint8Array(r)}var Tr=Math.pow(2,7),Pr=Math.pow(2,14),Cr=Math.pow(2,21),At=Math.pow(2,28),Ut=Math.pow(2,35),It=Math.pow(2,42),Lt=Math.pow(2,49),m=128,T=127;function D(r){if(r<Tr)return 1;if(r<Pr)return 2;if(r<Cr)return 3;if(r<At)return 4;if(r<Ut)return 5;if(r<It)return 6;if(r<Lt)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Sr(r,t,e=0){switch(D(r)){case 8:t[e++]=r&255|m,r/=128;case 7:t[e++]=r&255|m,r/=128;case 6:t[e++]=r&255|m,r/=128;case 5:t[e++]=r&255|m,r/=128;case 4:t[e++]=r&255|m,r>>>=7;case 3:t[e++]=r&255|m,r>>>=7;case 2:t[e++]=r&255|m,r>>>=7;case 1:{t[e++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return t}function Ar(r,t,e=0){switch(D(r)){case 8:t.set(e++,r&255|m),r/=128;case 7:t.set(e++,r&255|m),r/=128;case 6:t.set(e++,r&255|m),r/=128;case 5:t.set(e++,r&255|m),r/=128;case 4:t.set(e++,r&255|m),r>>>=7;case 3:t.set(e++,r&255|m),r>>>=7;case 2:t.set(e++,r&255|m),r>>>=7;case 1:{t.set(e++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return t}function Ur(r,t){let e=r[t],n=0;if(n+=e&T,e<m||(e=r[t+1],n+=(e&T)<<7,e<m)||(e=r[t+2],n+=(e&T)<<14,e<m)||(e=r[t+3],n+=(e&T)<<21,e<m)||(e=r[t+4],n+=(e&T)*At,e<m)||(e=r[t+5],n+=(e&T)*Ut,e<m)||(e=r[t+6],n+=(e&T)*It,e<m)||(e=r[t+7],n+=(e&T)*Lt,e<m))return n;throw new RangeError("Could not decode varint")}function Ir(r,t){let e=r.get(t),n=0;if(n+=e&T,e<m||(e=r.get(t+1),n+=(e&T)<<7,e<m)||(e=r.get(t+2),n+=(e&T)<<14,e<m)||(e=r.get(t+3),n+=(e&T)<<21,e<m)||(e=r.get(t+4),n+=(e&T)*At,e<m)||(e=r.get(t+5),n+=(e&T)*Ut,e<m)||(e=r.get(t+6),n+=(e&T)*It,e<m)||(e=r.get(t+7),n+=(e&T)*Lt,e<m))return n;throw new RangeError("Could not decode varint")}function W(r,t,e=0){return t==null&&(t=H(D(r))),t instanceof Uint8Array?Sr(r,t,e):Ar(r,t,e)}function K(r,t=0){return r instanceof Uint8Array?Ur(r,t):Ir(r,t)}function I(r,t){t==null&&(t=r.reduce((o,s)=>o+s.length,0));let e=H(t),n=0;for(let o of r)e.set(o,n),n+=o.length;return e}var kt={};A(kt,{base10:()=>kr});var Lo=new Uint8Array(0);function Ee(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}function M(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function ve(r){return new TextEncoder().encode(r)}function Te(r){return new TextDecoder().decode(r)}function Lr(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),n=0;n<e.length;n++)e[n]=255;for(var o=0;o<r.length;o++){var s=r.charAt(o),i=s.charCodeAt(0);if(e[i]!==255)throw new TypeError(s+" is ambiguous");e[i]=o}var a=r.length,c=r.charAt(0),d=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,k=0,P=0,x=p.length;P!==x&&p[P]===0;)P++,y++;for(var E=(x-P)*h+1>>>0,U=new Uint8Array(E);P!==x;){for(var R=p[P],V=0,L=E-1;(R!==0||V<k)&&L!==-1;L--,V++)R+=256*U[L]>>>0,U[L]=R%a>>>0,R=R/a>>>0;if(R!==0)throw new Error("Non-zero carry");k=V,P++}for(var $=E-k;$!==E&&U[$]===0;)$++;for(var at=c.repeat(y);$<E;++$)at+=r.charAt(U[$]);return at}function w(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var k=0,P=0;p[y]===c;)k++,y++;for(var x=(p.length-y)*d+1>>>0,E=new Uint8Array(x);p[y];){var U=e[p.charCodeAt(y)];if(U===255)return;for(var R=0,V=x-1;(U!==0||R<P)&&V!==-1;V--,R++)U+=a*E[V]>>>0,E[V]=U%256>>>0,U=U/256>>>0;if(U!==0)throw new Error("Non-zero carry");P=R,y++}if(p[y]!==" "){for(var L=x-P;L!==x&&E[L]===0;)L++;for(var $=new Uint8Array(k+(x-L)),at=k;L!==x;)$[at++]=E[L++];return $}}}function g(p){var y=w(p);if(y)return y;throw new Error(`Non-${t} character`)}return{encode:f,decodeUnsafe:w,decode:g}}var Nr=Lr,Or=Nr,Ce=Or;var Nt=class{name;prefix;baseEncode;constructor(t,e,n){this.name=t,this.prefix=e,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},Ot=class{name;prefix;baseDecode;prefixCodePoint;constructor(t,e,n){this.name=t,this.prefix=e;let o=e.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return Se(this,t)}},Rt=class{decoders;constructor(t){this.decoders=t}or(t){return Se(this,t)}decode(t){let e=t[0],n=this.decoders[e];if(n!=null)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Se(r,t){return new Rt({...r.decoders??{[r.prefix]:r},...t.decoders??{[t.prefix]:t}})}var Dt=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(t,e,n,o){this.name=t,this.prefix=e,this.baseEncode=n,this.baseDecode=o,this.encoder=new Nt(t,e,n),this.decoder=new Ot(t,e,o)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}};function q({name:r,prefix:t,encode:e,decode:n}){return new Dt(r,t,e,n)}function z({name:r,prefix:t,alphabet:e}){let{encode:n,decode:o}=Ce(e,r);return q({prefix:t,name:r,encode:n,decode:s=>M(o(s))})}function Rr(r,t,e,n){let o={};for(let h=0;h<t.length;++h)o[t[h]]=h;let s=r.length;for(;r[s-1]==="=";)--s;let i=new Uint8Array(s*e/8|0),a=0,c=0,d=0;for(let h=0;h<s;++h){let f=o[r[h]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<e|f,a+=e,a>=8&&(a-=8,i[d++]=255&c>>a)}if(a>=e||(255&c<<8-a)!==0)throw new SyntaxError("Unexpected end of data");return i}function Dr(r,t,e){let n=t[t.length-1]==="=",o=(1<<e)-1,s="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>e;)i-=e,s+=t[o&a>>i];if(i!==0&&(s+=t[o&a<<e-i]),n)for(;(s.length*e&7)!==0;)s+="=";return s}function b({name:r,prefix:t,bitsPerChar:e,alphabet:n}){return q({prefix:t,name:r,encode(o){return Dr(o,n,e)},decode(o){return Rr(o,n,e,r)}})}var kr=z({prefix:"9",name:"base10",alphabet:"0123456789"});var $t={};A($t,{base16:()=>$r,base16upper:()=>Br});var $r=b({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Br=b({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Bt={};A(Bt,{base2:()=>Hr});var Hr=b({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ht={};A(Ht,{base256emoji:()=>_r});var Ae=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Mr=Ae.reduce((r,t,e)=>(r[e]=t,r),[]),Fr=Ae.reduce((r,t,e)=>{let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);return r[n]=e,r},[]);function Vr(r){return r.reduce((t,e)=>(t+=Mr[e],t),"")}function zr(r){let t=[];for(let e of r){let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);let o=Fr[n];if(o==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(o)}return new Uint8Array(t)}var _r=q({prefix:"\u{1F680}",name:"base256emoji",encode:Vr,decode:zr});var Mt={};A(Mt,{base32:()=>F,base32hex:()=>qr,base32hexpad:()=>Gr,base32hexpadupper:()=>Qr,base32hexupper:()=>Yr,base32pad:()=>jr,base32padupper:()=>Wr,base32upper:()=>Kr,base32z:()=>Jr});var F=b({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Kr=b({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),jr=b({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Wr=b({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),qr=b({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Yr=b({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Gr=b({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Qr=b({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Jr=b({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Ft={};A(Ft,{base36:()=>tt,base36upper:()=>Xr});var tt=z({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Xr=z({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Vt={};A(Vt,{base58btc:()=>C,base58flickr:()=>Zr});var C=z({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Zr=z({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var zt={};A(zt,{base64:()=>tn,base64pad:()=>en,base64url:()=>rn,base64urlpad:()=>nn});var tn=b({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),en=b({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),rn=b({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),nn=b({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var _t={};A(_t,{base8:()=>on});var on=b({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Kt={};A(Kt,{identity:()=>sn});var sn=q({prefix:"\0",name:"identity",encode:r=>Te(r),decode:r=>ve(r)});var Wo=new TextEncoder,qo=new TextDecoder;var Wt={};A(Wt,{identity:()=>In});var un=Le,Ue=128,fn=127,hn=~fn,ln=Math.pow(2,31);function Le(r,t,e){t=t||[],e=e||0;for(var n=e;r>=ln;)t[e++]=r&255|Ue,r/=128;for(;r&hn;)t[e++]=r&255|Ue,r>>>=7;return t[e]=r|0,Le.bytes=e-n+1,t}var dn=jt,pn=128,Ie=127;function jt(r,n){var e=0,n=n||0,o=0,s=n,i,a=r.length;do{if(s>=a)throw jt.bytes=0,new RangeError("Could not decode varint");i=r[s++],e+=o<28?(i&Ie)<<o:(i&Ie)*Math.pow(2,o),o+=7}while(i>=pn);return jt.bytes=s-n,e}var mn=Math.pow(2,7),wn=Math.pow(2,14),gn=Math.pow(2,21),bn=Math.pow(2,28),yn=Math.pow(2,35),xn=Math.pow(2,42),En=Math.pow(2,49),vn=Math.pow(2,56),Tn=Math.pow(2,63),Pn=function(r){return r<mn?1:r<wn?2:r<gn?3:r<bn?4:r<yn?5:r<xn?6:r<En?7:r<vn?8:r<Tn?9:10},Cn={encode:un,decode:dn,encodingLength:Pn},Sn=Cn,et=Sn;function rt(r,t=0){return[et.decode(r,t),et.decode.bytes]}function Y(r,t,e=0){return et.encode(r,t,e),t}function G(r){return et.encodingLength(r)}function j(r,t){let e=t.byteLength,n=G(r),o=n+G(e),s=new Uint8Array(o+e);return Y(r,s,0),Y(e,s,n),s.set(t,o),new Q(r,e,t,s)}function ut(r){let t=M(r),[e,n]=rt(t),[o,s]=rt(t.subarray(n)),i=t.subarray(n+s);if(i.byteLength!==o)throw new Error("Incorrect length");return new Q(e,o,i,t)}function Ne(r,t){if(r===t)return!0;{let e=t;return r.code===e.code&&r.size===e.size&&e.bytes instanceof Uint8Array&&Ee(r.bytes,e.bytes)}}var Q=class{code;size;digest;bytes;constructor(t,e,n,o){this.code=t,this.size=e,this.digest=n,this.bytes=o}};var Oe=0,An="identity",Re=M;function Un(r){return j(Oe,Re(r))}var In={code:Oe,name:An,encode:Re,digest:Un};var Gt={};A(Gt,{sha256:()=>Ln,sha512:()=>Nn});function Yt({name:r,code:t,encode:e}){return new qt(r,t,e)}var qt=class{name;code;encode;constructor(t,e,n){this.name=t,this.code=e,this.encode=n}digest(t){if(t instanceof Uint8Array){let e=this.encode(t);return e instanceof Uint8Array?j(this.code,e):e.then(n=>j(this.code,n))}else throw Error("Unknown type, must be binary type")}};function ke(r){return async t=>new Uint8Array(await crypto.subtle.digest(r,t))}var Ln=Yt({name:"sha2-256",code:18,encode:ke("SHA-256")}),Nn=Yt({name:"sha2-512",code:19,encode:ke("SHA-512")});function $e(r,t){let{bytes:e,version:n}=r;switch(n){case 0:return Rn(e,Qt(r),t??C.encoder);default:return Dn(e,Qt(r),t??F.encoder)}}var Be=new WeakMap;function Qt(r){let t=Be.get(r);if(t==null){let e=new Map;return Be.set(r,e),e}return t}var _=class r{code;version;multihash;bytes;"/";constructor(t,e,n,o){this.code=e,this.version=t,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:e}=this;if(t!==nt)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==kn)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:e}=this.multihash,n=j(t,e);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return r.equals(this,t)}static equals(t,e){let n=e;return n!=null&&t.code===n.code&&t.version===n.version&&Ne(t.multihash,n.multihash)}toString(t){return $e(this,t)}toJSON(){return{"/":$e(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let e=t;if(e instanceof r)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){let{version:n,code:o,multihash:s,bytes:i}=e;return new r(n,o,s,i??He(n,o,s.bytes))}else if(e[$n]===!0){let{version:n,multihash:o,code:s}=e,i=ut(o);return r.create(n,s,i)}else return null}static create(t,e,n){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==nt)throw new Error(`Version 0 CID must use dag-pb (code: ${nt}) block encoding`);return new r(t,e,n,n.bytes)}case 1:{let o=He(t,e,n.bytes);return new r(t,e,n,o)}default:throw new Error("Invalid version")}}static createV0(t){return r.create(0,nt,t)}static createV1(t,e){return r.create(1,t,e)}static decode(t){let[e,n]=r.decodeFirst(t);if(n.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){let e=r.inspectBytes(t),n=e.size-e.multihashSize,o=M(t.subarray(n,n+e.multihashSize));if(o.byteLength!==e.multihashSize)throw new Error("Incorrect length");let s=o.subarray(e.multihashSize-e.digestSize),i=new Q(e.multihashCode,e.digestSize,s,o);return[e.version===0?r.createV0(i):r.createV1(e.codec,i),t.subarray(e.size)]}static inspectBytes(t){let e=0,n=()=>{let[f,w]=rt(t.subarray(e));return e+=w,f},o=n(),s=nt;if(o===18?(o=0,e=0):s=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let i=e,a=n(),c=n(),d=e+c,h=d-i;return{version:o,codec:s,multihashCode:a,digestSize:c,multihashSize:h,size:d}}static parse(t,e){let[n,o]=On(t,e),s=r.decode(o);if(s.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Qt(s).set(n,t),s}};function On(r,t){switch(r[0]){case"Q":{let e=t??C;return[C.prefix,e.decode(`${C.prefix}${r}`)]}case C.prefix:{let e=t??C;return[C.prefix,e.decode(r)]}case F.prefix:{let e=t??F;return[F.prefix,e.decode(r)]}case tt.prefix:{let e=t??tt;return[tt.prefix,e.decode(r)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],t.decode(r)]}}}function Rn(r,t,e){let{prefix:n}=e;if(n!==C.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);let o=t.get(n);if(o==null){let s=e.encode(r).slice(1);return t.set(n,s),s}else return o}function Dn(r,t,e){let{prefix:n}=e,o=t.get(n);if(o==null){let s=e.encode(r);return t.set(n,s),s}else return o}var nt=112,kn=18;function He(r,t,e){let n=G(r),o=n+G(t),s=new Uint8Array(o+e.byteLength);return Y(r,s,0),Y(t,s,n),s.set(e,o),s}var $n=Symbol.for("@ipld/js-cid/CID");var ot={...Kt,...Bt,..._t,...kt,...$t,...Mt,...Ft,...Vt,...zt,...Ht},ms={...Gt,...Wt};function Fe(r,t,e,n){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:n}}}var Me=Fe("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Jt=Fe("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);let t=H(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),Bn={utf8:Me,"utf-8":Me,hex:ot.base16,latin1:Jt,ascii:Jt,binary:Jt,...ot},ft=Bn;function v(r,t="utf8"){let e=ft[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(r).substring(1)}var ht=class{index=0;input="";new(t){return this.index=0,this.input=t,this}readAtomically(t){let e=this.index,n=t();return n===void 0&&(this.index=e),n}parseWith(t){let e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{let e=this.readChar();if(e===t)return e})}readSeparator(t,e,n){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return n()})}readNumber(t,e,n,o){return this.readAtomically(()=>{let s=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",d=2**(8*o)-1;for(;;){let h=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let w=Number.parseInt(f,t);if(!Number.isNaN(w))return w});if(h===void 0)break;if(s*=t,s+=h,s>d||(i+=1,e!==void 0&&i>e))return}if(i!==0)return!n&&c&&i>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{let t=new Uint8Array(4);for(let e=0;e<t.length;e++){let n=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;t[e]=n}return t})}readIPv6Addr(){let t=e=>{for(let n=0;n<e.length/2;n++){let o=n*2;if(n<e.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return e[o]=i[0],e[o+1]=i[1],e[o+2]=i[2],e[o+3]=i[3],[o+4,!0]}let s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[o,!1];e[o]=s>>8,e[o+1]=s&255}return[e.length,!1]};return this.readAtomically(()=>{let e=new Uint8Array(16),[n,o]=t(e);if(n===16)return e;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let s=new Uint8Array(14),i=16-(n+2),[a]=t(s.subarray(0,i));return e.set(s.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var Ve=45,Hn=15,X=new ht;function Xt(r){if(!(r.length>Hn))return X.new(r).parseWith(()=>X.readIPv4Addr())}function Zt(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Ve))return X.new(r).parseWith(()=>X.readIPv6Addr())}function lt(r,t=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Ve)return;let e=X.new(r).parseWith(()=>X.readIPAddr());if(e)return t&&e.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,e[0],e[1],e[2],e[3]]):e}var Ns=parseInt("0xFFFF",16),Os=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function dt(r,t="utf8"){let e=ft[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${r}`)}function Ke(r){return!!Xt(r)}function je(r){return!!Zt(r)}function pt(r){return!!lt(r)}var We=Ke,_n=je,te=function(r){let t=0;if(r=r.toString().trim(),We(r)){let e=new Uint8Array(t+4);return r.split(/\./g).forEach(n=>{e[t++]=parseInt(n,10)&255}),e}if(_n(r)){let e=r.split(":",8),n;for(n=0;n<e.length;n++){let s=We(e[n]),i;s&&(i=te(e[n]),e[n]=v(i.slice(0,2),"base16")),i!=null&&++n<8&&e.splice(n,0,v(i.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(n=0;n<e.length&&e[n]!=="";n++);let s=[n,1];for(n=9-e.length;n>0;n--)s.push("0");e.splice.apply(e,s)}let o=new Uint8Array(t+16);for(n=0;n<e.length;n++){let s=parseInt(e[n],16);o[t++]=s>>8&255,o[t++]=s&255}return o}throw new Error("invalid ip address")},qe=function(r,t=0,e){t=~~t,e=e??r.length-t;let n=new DataView(r.buffer);if(e===4){let o=[];for(let s=0;s<e;s++)o.push(r[t+s]);return o.join(".")}if(e===16){let o=[];for(let s=0;s<e;s+=2)o.push(n.getUint16(t+s).toString(16));return o.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var Z={},ee={},jn=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,-1,"http-path"],[777,-1,"memory"]];jn.forEach(r=>{let t=Wn(...r);ee[t.code]=t,Z[t.name]=t});function Wn(r,t,e,n,o){return{code:r,size:t,name:e,resolvable:!!n,path:!!o}}function l(r){if(typeof r=="number"){if(ee[r]!=null)return ee[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Z[r]!=null)return Z[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var gi=l("ip4"),bi=l("ip6"),yi=l("ipcidr");function se(r,t){switch(l(r).code){case 4:case 41:return Yn(t);case 42:return oe(t);case 43:return v(t,"base10");case 6:case 273:case 33:case 132:return Qe(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return oe(t);case 421:return Xn(t);case 444:return Ge(t);case 445:return Ge(t);case 466:return Jn(t);case 481:return globalThis.encodeURIComponent(oe(t));default:return v(t,"base16")}}function ie(r,t){switch(l(r).code){case 4:return Ye(t);case 41:return Ye(t);case 42:return ne(t);case 43:return dt(t,"base10");case 6:case 273:case 33:case 132:return ae(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ne(t);case 421:return Gn(t);case 444:return Zn(t);case 445:return to(t);case 466:return Qn(t);case 481:return ne(globalThis.decodeURIComponent(t));default:return dt(t,"base16")}}var re=Object.values(ot).map(r=>r.decoder),qn=function(){let r=re[0].or(re[1]);return re.slice(2).forEach(t=>r=r.or(t)),r}();function Ye(r){if(!pt(r))throw new Error("invalid ip address");return te(r)}function Yn(r){let t=qe(r,0,r.length);if(t==null)throw new Error("ipBuff is required");if(!pt(t))throw new Error("invalid ip address");return t}function ae(r){let t=new ArrayBuffer(2);return new DataView(t).setUint16(0,r),new Uint8Array(t)}function Qe(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function ne(r){let t=dt(r),e=Uint8Array.from(W(t.length));return I([e,t],e.length+t.length)}function oe(r){let t=K(r);if(r=r.slice(D(t)),r.length!==t)throw new Error("inconsistent lengths");return v(r)}function Gn(r){let t;r[0]==="Q"||r[0]==="1"?t=ut(C.decode(`z${r}`)).bytes:t=_.parse(r).multihash.bytes;let e=Uint8Array.from(W(t.length));return I([e,t],e.length+t.length)}function Qn(r){let t=qn.decode(r),e=Uint8Array.from(W(t.length));return I([e,t],e.length+t.length)}function Jn(r){let t=K(r),e=r.slice(D(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+v(e,"base64url")}function Xn(r){let t=K(r),e=r.slice(D(t));if(e.length!==t)throw new Error("inconsistent lengths");return v(e,"base58btc")}function Zn(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);let e=F.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=ae(n);return I([e,o],e.length+o.length)}function to(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);let e=F.decode(`b${t[0]}`),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=ae(n);return I([e,o],e.length+o.length)}function Ge(r){let t=r.slice(0,r.length-2),e=r.slice(r.length-2),n=v(t,"base32"),o=Qe(e);return`${n}:${o}`}function Je(r){r=ce(r);let t=[],e=[],n=null,o=r.split("/").slice(1);if(o.length===1&&o[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<o.length;s++){let i=o[s],a=l(i);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(s++,s>=o.length)throw new mt("invalid address: "+r);if(a.path===!0){n=ce(o.slice(s).join("/")),t.push([a.code,ie(a.code,n)]),e.push([a.code,n]);break}let c=ie(a.code,o[s]);t.push([a.code,c]),e.push([a.code,se(a.code,c)])}return{string:Xe(e),bytes:wt(t),tuples:t,stringTuples:e,path:n}}function ue(r){let t=[],e=[],n=null,o=0;for(;o<r.length;){let s=K(r,o),i=D(s),a=l(s),c=eo(a,r.slice(o+i));if(c===0){t.push([s]),e.push([s]),o+=i;continue}let d=r.slice(o+i,o+i+c);if(o+=c+i,o>r.length)throw new mt("Invalid address Uint8Array: "+v(r,"base16"));t.push([s,d]);let h=se(s,d);if(e.push([s,h]),a.path===!0){n=h;break}}return{bytes:Uint8Array.from(r),string:Xe(e),tuples:t,stringTuples:e,path:n}}function Xe(r){let t=[];return r.map(e=>{let n=l(e[0]);return t.push(n.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),ce(t.join("/"))}function wt(r){return I(r.map(t=>{let e=l(t[0]),n=Uint8Array.from(W(e.code));return t.length>1&&t[1]!=null&&(n=I([n,t[1]])),n}))}function eo(r,t){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let e=K(t instanceof Uint8Array?t:Uint8Array.from(t));return e+D(e)}}function ce(r){return"/"+r.trim().split("/").filter(t=>t).join("/")}var mt=class extends Error{static name="ParseError";name="ParseError";constructor(t){super(`Error parsing address: ${t}`)}};function gt(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}var ro=Symbol.for("nodejs.util.inspect.custom"),he=Symbol.for("@multiformats/js-multiaddr/multiaddr"),no=[l("dns").code,l("dns4").code,l("dns6").code,l("dnsaddr").code],fe=class extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}},bt=class r{bytes;#e;#t;#r;#n;[he]=!0;constructor(t){t==null&&(t="");let e;if(t instanceof Uint8Array)e=ue(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=Je(t)}else if(tr(t))e=ue(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,this.#e=e.string,this.#t=e.tuples,this.#r=e.stringTuples,this.#n=e.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let t,e,n,o,s="",i=l("tcp"),a=l("udp"),c=l("ip4"),d=l("ip6"),h=l("dns6"),f=l("ip6zone");for(let[g,p]of this.stringTuples())g===f.code&&(s=`%${p??""}`),no.includes(g)&&(e=i.name==="tcp"?"tcp":"udp",o=443,n=`${p??""}${s}`,t=g===h.code?6:4),(g===i.code||g===a.code)&&(e=l(g).name==="tcp"?"tcp":"udp",o=parseInt(p??"")),(g===c.code||g===d.code)&&(e=l(g).name==="tcp"?"tcp":"udp",n=`${p??""}${s}`,t=g===d.code?6:4);if(t==null||e==null||n==null||o==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:o}}protos(){return this.#t.map(([t])=>Object.assign({},l(t)))}protoCodes(){return this.#t.map(([t])=>t)}protoNames(){return this.#t.map(([t])=>l(t).name)}tuples(){return this.#t.map(([t,e])=>e==null?[t]:[t,e])}stringTuples(){return this.#r.map(([t,e])=>e==null?[t]:[t,e])}encapsulate(t){return t=new r(t),new r(this.toString()+t.toString())}decapsulate(t){let e=t.toString(),n=this.toString(),o=n.lastIndexOf(e);if(o<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new r(n.slice(0,o))}decapsulateCode(t){let e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new r(wt(e.slice(0,n)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([n,o])=>{n===Z.p2p.code&&t.push([n,o]),n===Z["p2p-circuit"].code&&(t=[])});let e=t.pop();if(e?.[1]!=null){let n=e[1];return n[0]==="Q"||n[0]==="1"?v(C.decode(`z${n}`),"base58btc"):v(_.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#n}equals(t){return gt(this.bytes,t.bytes)}async resolve(t){let e=this.protos().find(s=>s.resolvable);if(e==null)return[this];let n=Ze.get(e.name);if(n==null)throw new fe(`no available resolver for ${e.name}`);return(await n(this,t)).map(s=>N(s))}nodeAddress(){let t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){let e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[ro](){return`Multiaddr(${this.#e})`}};var Ze=new Map;function tr(r){return!!r?.[he]}function N(r){return new bt(r)}var oo=[l("tcp").code,l("dns").code,l("dnsaddr").code,l("dns4").code,l("dns6").code];function er(r){return or("sni",r)?.[1]}function rr(r){let t=or("tcp",r)?.[1];return t==null?"":`:${t}`}function or(r,t){let e;try{e=l(r).code}catch{return}for(let[n,o]of t)if(n===e&&o!=null)return[n,o]}function nr(r){return r.some(([t,e])=>t===l("tls").code)}function O(r,t,e){let n=sr[l(r).name];if(n==null)throw new Error(`Can't interpret protocol ${l(r).name}`);let o=n(t,e);return r===l("ip6").code?`[${o}]`:o}var sr={ip4:(r,t)=>r,ip6:(r,t)=>t.length===0?r:`[${r}]`,tcp:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`tcp://${O(e[0],e[1]??"",t)}:${r}`},udp:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`udp://${O(e[0],e[1]??"",t)}:${r}`},dnsaddr:(r,t)=>r,dns4:(r,t)=>r,dns6:(r,t)=>r,dns:(r,t)=>r,ipfs:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${O(e[0],e[1]??"",t)}`},p2p:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return`${O(e[0],e[1]??"",t)}`},http:(r,t)=>{let e=nr(t),n=er(t),o=rr(t);if(e&&n!=null)return`https://${n}${o}`;let s=e?"https://":"http://",i=t.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let a=O(i[0],i[1]??"",t);return a=a.replace("tcp://",""),`${s}${a}`},"http-path":(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let n=O(e[0],e[1]??"",t),o=decodeURIComponent(r);return`${n}/${o}`},tls:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return O(e[0],e[1]??"",t)},sni:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");return O(e[0],e[1]??"",t)},https:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let n=O(e[0],e[1]??"",t);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,t)=>{let e=nr(t),n=er(t),o=rr(t);if(e&&n!=null)return`wss://${n}${o}`;let s=e?"wss://":"ws://",i=t.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let a=O(i[0],i[1]??"",t);return a=a.replace("tcp://",""),`${s}${a}`},wss:(r,t)=>{let e=t.pop();if(e==null)throw new Error("Unexpected end of multiaddr");let n=O(e[0],e[1]??"",t);return n=n.replace("tcp://",""),`wss://${n}`}};function yt(r,t){let n=N(r).stringTuples(),o=n.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let s=l(o[0]),i=sr[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let a=i(o[1]??"",n);return t?.assumeHttp!==!1&&oo.includes(o[0])&&(a=a.replace(/^.*:\/\//,""),o[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var le="/http/1.1",st="/.well-known/libp2p/protocols";function u(r){if(r!==void 0&&r!==u.REQUEST&&r!==u.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");r===void 0||this.initialize(r),this.maxHeaderSize=u.maxHeaderSize}u.prototype.initialize=function(r,t){if(r!==u.REQUEST&&r!==u.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");this.type=r,this.state=r+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1};u.encoding="ascii";u.maxHeaderSize=80*1024;u.REQUEST="REQUEST";u.RESPONSE="RESPONSE";var ir=u.kOnHeaders=1,de=u.kOnHeadersComplete=2,xt=u.kOnBody=3,pe=u.kOnMessageComplete=4;u.prototype[ir]=u.prototype[de]=u.prototype[xt]=u.prototype[pe]=function(){};var ar=!0;Object.defineProperty(u,"kOnExecute",{get:function(){return ar=!1,99}});var cr=u.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"],ur=cr.indexOf("CONNECT");u.prototype.reinitialize=u;u.prototype.close=u.prototype.pause=u.prototype.resume=u.prototype.remove=u.prototype.free=function(){};u.prototype._compatMode0_11=!1;u.prototype.getAsyncId=function(){return 0};var so={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};u.prototype.execute=function(r,t,e){if(!(this instanceof u))throw new TypeError("not a HTTPParser");t=t||0,e=typeof e=="number"?e:r.length,this.chunk=r,this.offset=t;var n=this.end=t+e;try{for(;this.offset<n&&!this[this.state](););}catch(o){if(this.isUserCall)throw o;return this.hadError=!0,o}return this.chunk=null,e=this.offset-t,so[this.state]&&(this.headerSize+=e,this.headerSize>(this.maxHeaderSize||u.maxHeaderSize))?new Error("max header size exceeded"):e};var io={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};u.prototype.finish=function(){if(!this.hadError){if(!io[this.state])return new Error("invalid state for EOF");this.state==="BODY_RAW"&&this.userCall()(this[pe]())}};u.prototype.consume=u.prototype.unconsume=u.prototype.getCurrentBuffer=function(){};u.prototype.userCall=function(){this.isUserCall=!0;var r=this;return function(t){return r.isUserCall=!1,t}};u.prototype.nextRequest=function(){this.userCall()(this[pe]()),this.reinitialize(this.type)};u.prototype.consumeLine=function(){for(var r=this.end,t=this.chunk,e=this.offset;e<r;e++)if(t[e]===10){var n=this.line+v(t.subarray(this.offset,e),u.encoding);return n.charAt(n.length-1)==="\r"&&(n=n.substr(0,n.length-1)),this.line="",this.offset=e+1,n}this.line+=v(t.subarray(this.offset,this.end),u.encoding),this.offset=this.end};var ao=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,co=/^[ \t]+(.*[^ \t])/;u.prototype.parseHeader=function(r,t){if(r.indexOf("\r")!==-1)throw Et("HPE_LF_EXPECTED");var e=ao.exec(r),n=e&&e[1];if(n)t.push(n),t.push(e[2]);else{var o=co.exec(r);o&&t.length&&(t[t.length-1]&&(t[t.length-1]+=" "),t[t.length-1]+=o[1])}};var uo=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;u.prototype.REQUEST_LINE=function(){var r=this.consumeLine();if(r){var t=uo.exec(r);if(t===null)throw Et("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?t[1]:cr.indexOf(t[1]),this.info.method===-1)throw new Error("invalid request method");this.info.url=t[2],this.info.versionMajor=+t[3],this.info.versionMinor=+t[4],this.body_bytes=0,this.state="HEADER"}};var fo=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;u.prototype.RESPONSE_LINE=function(){var r=this.consumeLine();if(r){var t=fo.exec(r);if(t===null)throw Et("HPE_INVALID_CONSTANT");this.info.versionMajor=+t[1],this.info.versionMinor=+t[2];var e=this.info.statusCode=+t[3];this.info.statusMessage=t[4],((e/100|0)===1||e===204||e===304)&&(this.body_bytes=0),this.state="HEADER"}};u.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(this.connection.indexOf("close")!==-1)return!1}else if(this.connection.indexOf("keep-alive")===-1)return!1;return!!(this.body_bytes!==null||this.isChunked)};u.prototype.HEADER=function(){var r=this.consumeLine();if(r!==void 0){var t=this.info;if(r)this.parseHeader(r,t.headers);else{for(var e=t.headers,n=!1,o,s=!1,i=0;i<e.length;i+=2)switch(e[i].toLowerCase()){case"transfer-encoding":this.isChunked=e[i+1].toLowerCase()==="chunked";break;case"content-length":if(o=+e[i+1],n){if(o!==this.body_bytes)throw Et("HPE_UNEXPECTED_CONTENT_LENGTH")}else n=!0,this.body_bytes=o;break;case"connection":this.connection+=e[i+1].toLowerCase();break;case"upgrade":s=!0;break}this.isChunked&&n&&(n=!1,this.body_bytes=null),s&&this.connection.indexOf("upgrade")!=-1?t.upgrade=this.type===u.REQUEST||t.statusCode===101:t.upgrade=t.method===ur,this.isChunked&&t.upgrade&&(this.isChunked=!1),t.shouldKeepAlive=this.shouldKeepAlive();var a;if(ar?a=this.userCall()(this[de](t)):a=this.userCall()(this[de](t.versionMajor,t.versionMinor,t.headers,t.method,t.url,t.statusCode,t.statusMessage,t.upgrade,t.shouldKeepAlive)),a===2)return this.nextRequest(),!0;if(this.isChunked&&!a)this.state="BODY_CHUNKHEAD";else{if(a||this.body_bytes===0)return this.nextRequest(),t.upgrade;this.body_bytes===null?this.state="BODY_RAW":this.state="BODY_SIZED"}}}};u.prototype.BODY_CHUNKHEAD=function(){var r=this.consumeLine();r!==void 0&&(this.body_bytes=parseInt(r,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")};u.prototype.BODY_CHUNK=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[xt](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")};u.prototype.BODY_CHUNKEMPTYLINE=function(){var r=this.consumeLine();if(r!==void 0){if(r!=="")throw new Error("Expected empty line");this.state="BODY_CHUNKHEAD"}};u.prototype.BODY_CHUNKTRAILERS=function(){var r=this.consumeLine();r!==void 0&&(r?this.parseHeader(r,this.trailers):(this.trailers.length&&this.userCall()(this[ir](this.trailers,"")),this.nextRequest()))};u.prototype.BODY_RAW=function(){this.userCall()(this[xt](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end};u.prototype.BODY_SIZED=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[xt](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||this.nextRequest()};["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(r){var t=u["kOn"+r];Object.defineProperty(u.prototype,"on"+r,{get:function(){return this[t]},set:function(e){return this._compatMode0_11=!0,ur="CONNECT",this[t]=e}})});function Et(r){var t=new Error("Parse Error");return t.code=r,t}function me(){let r={};return r.promise=new Promise((t,e)=>{r.resolve=t,r.reject=e}),r}var lr=Symbol.for("@achingbrain/uint8arraylist");function fr(r,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(let n of r){let o=e+n.byteLength;if(t<o)return{buf:n,index:t-e};e=o}throw new RangeError("index is out of bounds")}function vt(r){return!!r?.[lr]}var hr=class r{bufs;length;[lr]=!0;constructor(...t){this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(let n of t)if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.push(n);else if(vt(n))e+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(let n of t.reverse())if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.unshift(n);else if(vt(n))e+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){let e=fr(this.bufs,t);return e.buf[e.index]}set(t,e){let n=fr(this.bufs,t);n.buf[n.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let n=0;n<t.length;n++)this.set(e+n,t[n]);else if(vt(t))for(let n=0;n<t.length;n++)this.set(e+n,t.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){let{bufs:n,length:o}=this._subList(t,e);return I(n,o)}subarray(t,e){let{bufs:n,length:o}=this._subList(t,e);return n.length===1?n[0]:I(n,o)}sublist(t,e){let{bufs:n,length:o}=this._subList(t,e),s=new r;return s.length=o,s.bufs=[...n],s}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let s=0;s<this.bufs.length;s++){let i=this.bufs[s],a=o,c=a+i.byteLength;if(o=c,t>=c)continue;let d=t>=a&&t<c,h=e>a&&e<=c;if(d&&h){if(t===a&&e===c){n.push(i);break}let f=t-a;n.push(i.subarray(f,f+(e-t)));break}if(d){if(t===0){n.push(i);continue}n.push(i.subarray(t-a));continue}if(h){if(e===c){n.push(i);break}n.push(i.subarray(0,e-a));break}n.push(i)}return{bufs:n,length:e-t}}indexOf(t,e=0){if(!vt(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let s=256,i=new Int32Array(s);for(let f=0;f<s;f++)i[f]=-1;for(let f=0;f<o;f++)i[n[f]]=f;let a=i,c=this.byteLength-n.byteLength,d=n.byteLength-1,h;for(let f=e;f<=c;f+=h){h=0;for(let w=d;w>=0;w--){let g=this.get(f+w);if(n[w]!==g){h=Math.max(1,w-a[g]);break}}if(h===0)return f}return-1}getInt8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){let n=H(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,e),this.write(n,t)}getInt16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,e)}setInt16(t,e,n){let o=B(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,e,n),this.write(o,t)}getInt32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,e)}setInt32(t,e,n){let o=B(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,e,n),this.write(o,t)}getBigInt64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,e)}setBigInt64(t,e,n){let o=B(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,e,n),this.write(o,t)}getUint8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){let n=H(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,e),this.write(n,t)}getUint16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,e)}setUint16(t,e,n){let o=B(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,e,n),this.write(o,t)}getUint32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,e)}setUint32(t,e,n){let o=B(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,e,n),this.write(o,t)}getBigUint64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,e)}setBigUint64(t,e,n){let o=B(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,e,n),this.write(o,t)}getFloat32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,e)}setFloat32(t,e,n){let o=B(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,e,n),this.write(o,t)}getFloat64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,e)}setFloat64(t,e,n){let o=B(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,e,n),this.write(o,t)}equals(t){if(t==null||!(t instanceof r)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!gt(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){let n=new r;return n.bufs=t,e==null&&(e=t.reduce((o,s)=>o+s.byteLength,0)),n.length=e,n}};var ho=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK"];function Tt(r){return ho[r]??"UNKNOWN"}var dr=!1,we=!1;async function lo(){if(dr)return we;dr=!0;let r=new ReadableStream({start(n){n.enqueue(new Uint8Array([0])),n.close()}});return we=(await new Request("https://example.com",{method:"POST",body:r,duplex:"half"}).arrayBuffer()).byteLength!==1,we}function mr(r){return async t=>{await wo(r,t);let[e]=wr(!1,r),n=await e;if(!(n instanceof Response))throw new Error("Expected a response");return n}}async function ge(r,t){let[e]=wr(!0,r),n=await e;if(!(n instanceof Request))throw new Error("Expected a request");let o=await t(n);await go(r,o)}function wr(r,t){let e=me();return[e.promise,(async()=>{let n=new TransformStream,o=n.writable.getWriter(),s=!1,i=!1,a=new u(r?"REQUEST":"RESPONSE");a[u.kOnHeadersComplete]=c=>{i=!0;let d=new Headers;for(let f=0;f<c.headers.length;f+=2)d.set(c.headers[f],c.headers[f+1]);let h=n.readable;try{if(r){Tt(c.method)==="GET"&&(h=null);let f=`https://${d.get("Host")??"unknown_host._libp2p"}${c.url}`;lo().then(async w=>{let g;if(!w)g=new Request(f,{method:Tt(c.method),body:h,headers:d,duplex:"half"});else if(h===null)g=new Request(f,{method:Tt(c.method),headers:d});else{let p=h.getReader(),y=[];for(;;){let{done:x,value:E}=await p.read();if(x)break;E!==void 0&&y.push(E)}let k=y.reduce((x,E)=>x+E.byteLength,0),P=new Uint8Array(k);for(let x=0,E=0;x<y.length;x++)P.set(y[x],E),E+=y[x].byteLength;g=new Request(f,{method:Tt(c.method),body:P,headers:d})}e.resolve(g),i=!0}).catch(w=>{e.reject(w)})}else{let f=n.readable;c.statusCode===204&&(f=null);let w=new Response(f,{headers:d,status:c.statusCode,statusText:c.statusMessage});e.resolve(w),i=!0}}catch(f){e.reject(f)}},a[u.kOnBody]=c=>{o.write(c).catch(d=>{e.reject(d)})},a[u.kOnMessageComplete]=()=>{s=!0,o.close().catch(c=>{e.reject(c)})};for await(let c of t.source){let d=c.subarray();a.execute(d)}a.finish(),s||(await o.abort(new Error("Incomplete HTTP message")),i||e.reject(new Error("Incomplete HTTP message")))})()]}var pr="multiaddr:",S=`\r
`,po=new TextEncoder().encode(S),mo=new TextEncoder().encode(`0${S}${S}`);async function wo(r,t){let e=t.method,n=t.url,o="",s="";if(n.startsWith(pr)){n=n.substring(pr.length);let h=N(n),[,f]=h.stringTuples().find(([w,g])=>w===l("http-path").code)??["",""];o=decodeURIComponent(f??"");try{let w=h.decapsulateCode(l("http-path").code);s=new URL(yt(w)).host}catch{}}else{let h=new URL(n);s=h.host,o=(h.pathname??"")+(h.search??"")}let i=t.headers;o.startsWith("/")||(o=`/${o}`);let a=`${e} ${o} HTTP/1.1${S}`;!i.has("Host")&&s!==""&&(a+=`Host: ${s}${S}`),i.has("Connection")||(a+=`Connection: close${S}`),i.forEach((h,f)=>{a+=`${f}: ${h}${S}`});let c=t.body;if(t.body===void 0&&typeof t.arrayBuffer=="function"){let h=await t.arrayBuffer();h.byteLength>0?c=new ReadableStream({start(f){f.enqueue(new Uint8Array(h)),f.close()}}):c=null}let d=c!==null&&!i.has("Content-Length")&&(e==="POST"||e==="PUT"||e==="PATCH");d&&(a+=`Transfer-Encoding: chunked${S}`),a+=S,r.sink(async function*(){if(yield new TextEncoder().encode(a),c==null)return;let f=c.getReader();try{for(;;){let{done:w,value:g}=await f.read();if(w){d&&(yield mo);break}if(d){let p=g.byteLength.toString(16);yield new TextEncoder().encode(`${p}${S}`)}yield g,d&&(yield po)}}finally{f.releaseLock()}}())}async function go(r,t){await r.sink(async function*(){let e=new TextEncoder,n=t.status,o=t.statusText,s=t.headers,i=`HTTP/1.1 ${n} ${o}${S}`;if(s.has("Connection")||(i+=`Connection: close${S}`),s.forEach((a,c)=>{i+=`${c}: ${a}${S}`}),i+=S,yield e.encode(i),t.body!==null&&t.body!==void 0){let a=t.body.getReader();for(;;){let{done:c,value:d}=await a.read();if(c)break;yield d}}}())}var Pt=class{myWellKnownProtos={};async handleRequest(t){return new Response(JSON.stringify(this.myWellKnownProtos),{headers:{"Content-Type":"application/json"}})}registerProtocol(t,e){if(e===""&&(e="/"),e.startsWith("/")||(e=`/${e}`),this.myWellKnownProtos[t]!=null)throw new Error(`Protocol ${t} already registered`);this.myWellKnownProtos[t]={path:e}}};var be="multiaddr:",it=class{log;protocol=le;components;started;_fetch;customHTTPHandler;wellKnownProtosCache=new ye(100);wellKnownHandler=new Pt;myProtosSortedByLength=[];protoHandlers={};_hasCustomHandler(t){return t.customHTTPHandler!==void 0}constructor(t,e){if(this.components=t,this.log=t.logger.forComponent("libp2p:http-fetch"),this.started=!1,e.fetch!=null)this._fetch=e.fetch;else if(typeof globalThis.fetch=="function")this._fetch=globalThis.fetch;else throw new Error("No fetch implementation provided and global fetch is not available");this._hasCustomHandler(e)&&(this.customHTTPHandler=e.customHTTPHandler)}async start(){await this.components.registrar.handle(this.protocol,t=>{this.handleMessage(t).catch(e=>{this.log.error("error handling perf protocol message",e)})},{}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async handleMessage(t){let{stream:e}=t;try{if(this.customHTTPHandler!=null){await ge(e,this.customHTTPHandler);return}await ge(e,this.defaultMuxer.bind(this))}catch(n){this.log.error("Error handling message",n)}}async defaultMuxer(t){try{let e=new URL(t.url);if(e.pathname===st)return await this.serveWellKnownProtocols(t);for(let n of this.myProtosSortedByLength)if(e.pathname.startsWith(n.path)){let o=this.protoHandlers[n.proto];if(o!=null)return await o(t)}return new Response(null,{status:404})}catch(e){return this.log.error("Error in defaultMuxer",e),new Response(null,{status:500})}}async serveWellKnownProtocols(t){return this.wellKnownHandler.handleRequest(t)}async fetch(t,e){return typeof t=="string"?this.innerFetch(new Request(t,e??{})):this.innerFetch(t)}async innerFetch(t){let{url:e}=t;if(e.startsWith(be)){let n=N(e.substring(be.length)),o=n.decapsulateCode(l("http-path").code);if(this.isHTTPTransportMultiaddr(o)){if(o.getPeerId()!==null)throw new Error("HTTP Transport does not yet support peer IDs. Use a stream based transport instead.");let[,s]=n.stringTuples().find(([c])=>c===l("http-path").code)??["",""],i=decodeURIComponent(s??"");i.startsWith("/")||(i=`/${i}`);let a=`${yt(o)}${i}`;return this._fetch(new Request(a,{body:t.body,duplex:t.duplex??"half",headers:t.headers,cache:t.cache,credentials:t.credentials,integrity:t.integrity,keepalive:t.keepalive,method:t.method,mode:t.mode,redirect:t.redirect,referrer:t.referrer,referrerPolicy:t.referrerPolicy,signal:t.signal}))}else{let i=await(await this.components.connectionManager.openConnection(o)).newStream(le);return mr(i)(t)}}return this._fetch(t)}isHTTPTransportMultiaddr(t){let e=t.protos();if(e.length===0)throw new Error("peer multiaddr must have at least one part");for(let n=e.length-1;n>=0;n--)if(e[n].name==="http"||e[n].name==="https")return!0;return!1}registerProtocol(t,e){e===""&&(e="/"),e.startsWith("/")||(e=`/${e}`),this.wellKnownHandler.registerProtocol(t,e),this.myProtosSortedByLength.push({proto:t,path:e}),this.myProtosSortedByLength.sort(({path:n},{path:o})=>o.length-n.length)}handleHTTPProtocol(t,e,n){this.registerProtocol(t,e),this.protoHandlers[t]=n}async getPeerMeta(t){let e=St(t)?N(`/p2p/${t.toString()}`):t,n=e;if(!St(t)){let c=e.getPeerId();c!==null&&(n=N(`/p2p/${c}`))}let o=this.wellKnownProtosCache.get(n);if(o!==void 0)return o;let s=be+e.encapsulate(`/http-path/${encodeURIComponent(st)}`).toString(),i=await this.fetch(new Request(s,{method:"GET",headers:{Accept:"application/json"}}));if(i.status!==200)throw new Error(`Unexpected status code: ${i.status}`);let a=await i.json();return this.wellKnownProtosCache.set(n,a),a}async prefixForProtocol(t,e){let n=await this.getPeerMeta(t);if(n[e]==null)throw new Error(`Peer does not serve protocol: ${e}`);return n[e].path}},ye=class{size;cache;constructor(t){this.size=t,this.cache=new Map}get(t){let e=this.cache.get(t);return e!=null&&(this.cache.delete(t),this.cache.set(t,e)),e}set(t,e){this.cache.has(t)?this.cache.delete(t):this.cache.size>=this.size&&this.cache.delete(this.cache.keys().next().value),this.cache.set(t,e)}};function bo(r={}){return t=>new it(t,r)}function yo(r){return t=>new it(t,r)}return Er(xo);})();
return Libp2PHttpFetch}));
